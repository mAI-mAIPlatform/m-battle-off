<!DOCTYPE html><html lang="fr"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>mBattle v1.2.1 - Saison 2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- CORE --- */
        body { margin: 0; overflow: hidden; background-color: #020617; font-family: 'Rajdhani', sans-serif; color: white; touch-action: none; user-select: none; -webkit-user-select: none; -webkit-tap-highlight-color: transparent; }
        canvas { display: block; }
        /* --- UI & GLASS --- */
        .glass-panel { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px rgba(0,0,0,0.6); border-radius: 24px; }
        .glass-nav { background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(30px); border-top: 1px solid rgba(255,255,255,0.1); }
        .glass-btn { position: relative; overflow: hidden; background: linear-gradient(180deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%); border: 1px solid rgba(255,255,255,0.15); transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1); }
        .glass-btn:active { transform: scale(0.96); filter: brightness(1.2); }
        .glass-btn.selected { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; box-shadow: 0 0 25px rgba(59, 130, 246, 0.25) inset; }
        /* SAISON 2 THEME: CYAN/PURPLE */
        .season-gold { border-color: #22d3ee !important; background: linear-gradient(145deg, rgba(34, 211, 238, 0.1), rgba(0,0,0,0.6)) !important; box-shadow: 0 0 15px rgba(34, 211, 238, 0.2) !important; animation: pulse-cyan-border 3s infinite; }
        .season-gold .icon-box { background: rgba(34, 211, 238, 0.2) !important; border: 1px solid rgba(34, 211, 238, 0.4); }
        
        .locked { opacity: 0.8; filter: grayscale(0.8); cursor: pointer; position: relative; } 
        .locked::after { content: 'ğŸ”’'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; opacity: 0.5; }
        
        .font-tech { font-family: 'Orbitron', sans-serif; letter-spacing: 1px; }
        .currency-badge { background: rgba(0,0,0,0.8); padding: 6px 14px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.15); font-family: 'Orbitron'; font-weight: 700; display: flex; align-items: center; gap: 8px; font-size: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        /* ANIMATION GAIN MONNAIE */
        @keyframes gainFlash { 0% { transform: scale(1.0); opacity: 1; filter: brightness(1); } 50% { transform: scale(1.15); opacity: 1; filter: brightness(1.5); text-shadow: 0 0 10px white; } 100% { transform: scale(1.0); opacity: 1; filter: brightness(1); } }
        .currency-badge.flash-coins { animation: gainFlash 0.3s ease-out; }
        .currency-badge.flash-gems { animation: gainFlash 0.3s ease-out; }

        /* --- NAV ICONS --- */
        .nav-item { color: #64748b; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .nav-item.active { color: #22d3ee; transform: translateY(-4px) scale(1.05); text-shadow: 0 0 15px rgba(34, 211, 238, 0.6); }
        .nav-item.active .icon { transform: scale(1.1); }
        /* --- VFX --- */
        #vignette { position: absolute; inset: 0; pointer-events: none; background: radial-gradient(circle, transparent 50%, #000 120%); z-index: 5; }
        #gas-overlay { position: absolute; inset: 0; pointer-events: none; opacity: 0; background: radial-gradient(circle, transparent 30%, rgba(34, 197, 94, 0.4) 80%); z-index: 4; transition: opacity 0.5s; }
        #flash-layer { position: absolute; inset: 0; pointer-events: none; background: #ef4444; opacity: 0; transition: opacity 0.1s; z-index: 6; mix-blend-mode: overlay; }
        /* --- CONTROLS --- */
        .joystick-zone { position: absolute; width: 140px; height: 140px; pointer-events: auto; z-index: 50; opacity: 0; transition: opacity 0.2s; }
        .joystick-zone.active { opacity: 1; }
        .stick-base { width: 130px; height: 130px; border-radius: 50%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(0,0,0,0.3) 70%); border: 2px solid rgba(255,255,255,0.1); position: absolute; bottom: 50px; pointer-events: auto; display: block !important; transition: border-color 0.2s; }
        .stick-base.active { border-color: rgba(34, 211, 238, 0.5); background: radial-gradient(circle, rgba(34, 211, 238, 0.15) 0%, rgba(0,0,0,0.4) 70%); }
        #stick-left-base { left: 40px; }
        #stick-right-base { right: 40px; }
        .stick-knob { width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.9); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 20px rgba(255,255,255,0.3); transition: transform 0.05s linear; }
        .action-btn { position: absolute; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 60; pointer-events: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.5); transition: transform 0.1s; }
        .action-btn:active { transform: scale(0.9); }
        /* --- ANIM --- */
        .kill-msg { font-size: 12px; font-weight: 800; text-shadow: 0 2px 4px black; animation: slideIn 0.3s ease-out; margin-bottom: 6px; background: linear-gradient(90deg, rgba(0,0,0,0.9) 0%, transparent 100%); padding: 6px 12px; border-left: 4px solid #3b82f6; border-radius: 0 4px 4px 0; }
        .kill-msg.red { border-color: #ef4444; }
        @keyframes slideIn { from { opacity:0; transform:translateX(-30px); } to { opacity:1; transform:translateX(0); } }
        .menu-anim { background: radial-gradient(circle at center, #0f172a 0%, #020617 100%); }
        .safe-pb { padding-bottom: max(90px, env(safe-area-inset-bottom) + 90px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        /* --- PASS --- */
        .pass-track-container { overflow-x: auto; padding: 40px 20px; scroll-behavior: smooth; position: relative; white-space: nowrap; -webkit-overflow-scrolling: touch; width: 100%; mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent); -webkit-mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent); }
        .pass-wrapper { display: inline-flex; flex-direction: column; min-width: 100%; position: relative; gap: 30px; padding: 0 40px; }
        .pass-track-main-line { position: absolute; left: 0; right: 0; top: 50%; height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; z-index: 0; transform: translateY(-50%); }
        .pass-row { display: flex; gap: 40px; align-items: center; position: relative; z-index: 10; padding: 10px 0; }
        .pass-step { width: 100px; height: 120px; background: #0f172a; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 6px rgba(0,0,0,0.3); overflow: visible; }
        .pass-step.pro { background: linear-gradient(180deg, #1e1b4b 0%, #0f172a 100%); border-color: rgba(99, 102, 241, 0.3); }
        .pass-step.locked { opacity: 0.5; filter: grayscale(1); transform: scale(0.95); }
        .pass-step.active { transform: scale(1.1) translateY(-5px); border-color: white; box-shadow: 0 0 20px rgba(255,255,255,0.2); z-index: 20; }
        .pass-step.active.pro { border-color: #a855f7; box-shadow: 0 0 25px rgba(168, 85, 247, 0.4); }
        .pass-step.claimed { opacity: 0.8; border-color: #22c55e; background: rgba(34, 197, 94, 0.1); }
        .check-mark { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 30px; color: #22c55e; background: rgba(0,0,0,0.6); border-radius: 16px; backdrop-filter: blur(2px); animation: popIn 0.3s; z-index: 25; }
        .tier-badge { position: absolute; top: -10px; background: #334155; border: 1px solid rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 12px; font-size: 9px; font-weight: 800; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); z-index: 30; white-space: nowrap; }
        .pass-step.active .tier-badge { background: #22d3ee; color: black; border-color: transparent; }
        .pass-step.pro .tier-badge { background: #4c1d95; }
        .pass-step.active.pro .tier-badge { background: #a855f7; color: white; }

        /* EMOTES */
        .emote-wheel { position: absolute; bottom: 120px; right: 20px; display: flex; flex-wrap: wrap; width: 160px; gap: 10px; z-index: 70; pointer-events: auto; }
        .emote-btn { width: 60px; height: 60px; background: rgba(0,0,0,0.8); border-radius: 50%; border: 2px solid white; font-size: 24px; display: flex; align-items: center; justify-content: center; transition: transform 0.1s; cursor: pointer; }
        .emote-grid-item { aspect-ratio: 1; background: rgba(255,255,255,0.05); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 32px; border: 2px solid transparent; cursor: pointer; transition: all 0.2s; position: relative; }
        .emote-grid-item.selected { border-color: #22d3ee; background: rgba(34, 211, 238, 0.1); }
        .emote-remove-btn { position: absolute; top: -5px; right: -5px; background: #ef4444; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; border: 2px solid #0f172a; }
        
        /* MODIFIERS & DIFF BTNS */
        .diff-btn.active { background: linear-gradient(45deg, var(--tw-gradient-stops)) !important; border-color: rgba(255,255,255,0.5) !important; box-shadow: 0 0 15px var(--tw-shadow-color) !important; }
        .mod-btn.active { background: #22d3ee !important; border-color: white !important; color: white !important; box-shadow: 0 0 15px #22d3ee !important; }
        
        .rarity-badge { position: absolute; top: 4px; right: 4px; padding: 2px 6px; border-radius: 6px; font-size: 8px; font-weight: 900; text-transform: uppercase; z-index: 10; border: 1px solid rgba(255,255,255,0.2); }
        
        /* Profile Avatar Image */
        .avatar-img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head><body>
    <canvas id="gameCanvas"></canvas>
    <div id="gas-overlay"></div>
    <div id="vignette"></div>
    <div id="flash-layer"></div>
    <div id="season-particles" class="absolute inset-0 pointer-events-none overflow-hidden z-0"></div>
    <div id="ui-layer" class="absolute inset-0 pointer-events-none overflow-hidden z-10">
        <div id="hud" class="hidden w-full h-full relative">
            <div class="absolute top-4 left-4 flex flex-col gap-4 pointer-events-auto">
                <div class="glass-panel p-2 flex items-center gap-3 pr-4 scale-90 origin-top-left md:scale-100">
                    <div class="relative">
                        <div class="w-14 h-14 rounded-xl bg-gray-900 border border-white/20 flex items-center justify-center text-2xl shadow-lg overflow-hidden">
                            <span id="hud-icon" class="z-10 relative">ğŸ¤–</span>
                            <div class="absolute inset-0 bg-gradient-to-br from-blue-600/40 to-transparent"></div>
                        </div>
                        <div class="absolute -bottom-2 -right-1 bg-black border border-gray-600 text-[9px] px-1.5 py-0.5 rounded text-yellow-400 font-bold" id="hud-lvl">LVL 1</div>
                    </div>
                    <!-- FIX 1: RÃ©activitÃ© de la barre de santÃ© (duration-200 -> duration-75) -->
                    <div class="flex flex-col w-28 gap-1">
                        <!-- ENLEVÃ‰ transition-all duration-75 -->
                        <div class="h-2.5 bg-gray-800 rounded-full overflow-hidden border border-gray-600 relative"><div id="hud-hp-bar" class="h-full bg-green-500" style="width: 100%;"></div></div>
                        <div class="flex gap-1 h-1 mt-0.5">
                            <div id="ammo-1" class="flex-1 bg-orange-500 rounded-full opacity-50 transition"></div>
                            <div id="ammo-2" class="flex-1 bg-orange-500 rounded-full opacity-50 transition"></div>
                            <div id="ammo-3" class="flex-1 bg-orange-500 rounded-full opacity-50 transition"></div>
                        </div>
                    </div>
                </div>
                <div class="glass-panel p-1 border-white/20 bg-black/50"><canvas id="minimap" width="100" height="100" class="rounded-lg bg-black/80 opacity-90"></canvas></div>
            </div>
            <div class="absolute top-6 left-1/2 -translate-x-1/2 text-center pointer-events-auto">
                <div id="hud-score" class="font-tech text-5xl font-bold text-white leading-none drop-shadow-[0_0_15px_rgba(255,255,255,0.4)]">0</div>
                <div class="text-[10px] font-bold text-blue-400 bg-black/50 px-2 rounded mt-1" id="hud-sub">VAGUE 1</div>
                <div id="hud-timer" class="text-xl font-black text-yellow-400 drop-shadow-lg mt-1 hidden">03:00</div>
                <div id="hud-objective" class="text-xs font-bold text-yellow-300 mt-1 hidden">Objectif</div>
            </div>
            <div class="absolute top-4 right-4 flex flex-col gap-4 pointer-events-auto items-end">
                <button onclick="window.game.togglePause()" class="glass-panel w-10 h-10 flex items-center justify-center hover:bg-white/10 text-lg transition active:scale-90">â¸</button>
            </div>
            <div id="boss-ui" class="hidden absolute top-24 left-1/2 -translate-x-1/2 w-3/4 max-w-lg pointer-events-auto transition-all duration-500">
                <div class="flex justify-between text-[10px] text-red-400 font-bold mb-1 uppercase tracking-widest"><span id="boss-name">BOSS</span><span id="boss-pct">100%</span></div>
                <div class="h-4 bg-red-950/80 border border-red-500/50 rounded-full overflow-hidden shadow-[0_0_20px_rgba(220,38,38,0.4)]"><div id="boss-bar" class="h-full bg-gradient-to-r from-red-600 to-red-500 w-full transition-all duration-200"></div></div>
            </div>
            <div id="kill-feed" class="absolute top-32 left-4 flex flex-col gap-2 w-48 pointer-events-none"></div>
            <div id="notif-area" class="absolute top-48 left-1/2 -translate-x-1/2 pointer-events-none flex flex-col items-center gap-2 w-full z-30"></div>
            <button id="btn-emote" class="absolute top-32 right-4 w-10 h-10 rounded-full glass-panel flex items-center justify-center text-xl pointer-events-auto active:scale-90 transition z-50" onmousedown="window.ui.toggleEmoteWheel()" ontouchstart="event.stopPropagation(); window.ui.toggleEmoteWheel()">ğŸ˜€</button>
            <div id="emote-wheel" class="emote-wheel hidden"></div>
            <div id="mobile-controls" class="hidden absolute inset-0 z-40">
                <div id="stick-left-base" class="stick-base" style="left: 40px; bottom: 40px;"><div class="stick-knob"></div></div>
                <div id="stick-right-base" class="stick-base" style="right: 40px; bottom: 40px;"><div class="stick-knob"></div></div>
                <button id="btn-gadget" class="action-btn bottom-36 right-12 w-16 h-16 bg-green-900/90 border-2 border-green-500 active:scale-90 flex items-center justify-center pointer-events-auto transition shadow-lg" ontouchstart="event.stopPropagation(); window.game.player?.useGadget()" onmousedown="window.game.player?.useGadget()"><span class="font-tech font-bold text-[10px] z-10">GADGET</span><div class="absolute -top-1 -right-1 bg-black border border-white text-[9px] w-5 h-5 rounded-full flex items-center justify-center" id="gadget-count">3</div></button>
                <button id="btn-dash" class="action-btn bottom-12 right-36 w-20 h-20 rounded-full glass-panel border border-white/40 active:scale-90 flex items-center justify-center pointer-events-auto transition shadow-lg bg-blue-900/30" ontouchstart="event.stopPropagation(); window.game.player?.dash()" onmousedown="window.game.player?.dash()"><span class="text-3xl">âš¡</span><div id="dash-cd" class="absolute inset-0 bg-black/70 origin-bottom h-0 transition-all duration-75 rounded-full"></div></button>
            </div>
        </div>
        
        <div id="menu-screen" class="absolute inset-0 menu-anim pointer-events-auto z-50 flex flex-col">
            <div class="w-full h-16 flex items-center justify-between px-5 pt-safe z-30 bg-gradient-to-b from-black/80 to-transparent">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-cyan-500/20 border border-cyan-400/30 flex items-center justify-center text-xl text-cyan-400">ğŸŒ€</div>
                    <div><div class="font-tech font-bold leading-none text-lg">mBATTLE</div><div class="text-[10px] text-cyan-400 font-bold tracking-widest">v1.2.1</div></div>
                </div>
                <div class="flex gap-3">
                    <div class="currency-badge"><span class="text-yellow-400">ğŸª™</span> <span id="top-coins">0</span></div>
                    <div class="currency-badge"><span class="text-purple-400">ğŸ’</span> <span id="top-gems">0</span></div>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto safe-pb p-5 hide-scrollbar relative">
                <div id="tab-play" class="tab-content flex flex-col items-center justify-center min-h-[65vh] gap-6 animate-fadeIn">
                    <div class="w-full max-w-md glass-panel p-5 border-l-4 border-cyan-500 bg-cyan-900/10 relative overflow-hidden">
                        <div class="flex items-center justify-between mb-2 relative z-10">
                            <div><div class="text-[10px] text-gray-400 uppercase font-bold">Rang Actuel</div><div class="text-2xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-cyan-200 to-cyan-500 font-tech" id="menu-rank">BRONZE I</div></div>
                            <div class="text-center"><div class="text-2xl">ğŸ†</div><div class="font-bold text-white text-xl" id="menu-trophies">0</div></div>
                        </div>
                        <div class="flex justify-between text-[10px] font-bold text-gray-300 mt-1 relative z-10">
                            <span id="rank-progress-text">Encore 100 ğŸ† avant BRONZE II</span><span id="rank-progress-pct">0%</span>
                        </div>
                        <div class="rank-progress-bg relative z-10"><div id="rank-progress-fill" class="rank-progress-fill bg-cyan-500"></div></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 w-full max-w-md">
                        <div onclick="window.ui.showTab('starters')" class="glass-panel p-4 flex flex-col items-center justify-center aspect-square active:scale-95 transition bg-blue-900/10 border-blue-500/30">
                            <div class="text-[10px] text-blue-300 font-bold mb-2 uppercase">HÃ©ros</div><div class="text-5xl mb-2 drop-shadow-xl" id="play-icon">ğŸ¯</div><div class="font-black text-lg leading-none" id="play-starter">Soldier</div>
                        </div>
                        <div onclick="window.ui.showTab('modes')" class="glass-panel p-4 flex flex-col items-center justify-center aspect-square active:scale-95 transition bg-purple-900/10 border-purple-500/30">
                            <div class="text-[10px] text-purple-300 font-bold mb-2 uppercase">Mission</div><div class="text-5xl mb-2 drop-shadow-xl" id="play-mode-icon">ğŸ”¥</div><div class="font-black text-lg leading-none" id="play-mode">Survie</div>
                        </div>
                    </div>
                    <div class="w-full max-w-md glass-panel p-4 flex flex-col items-center mt-4">
                        <div class="text-[10px] text-yellow-300 font-bold mb-3 uppercase tracking-widest">DIFFICULTÃ‰</div>
                        <div class="flex gap-3 w-full">
                            <button id="diff-easy" onclick="window.game.setDifficulty('easy')" style="--tw-shadow-color:#22c55e;" class="diff-btn flex-1 glass-btn py-3 rounded-xl font-bold text-sm bg-gradient-to-r from-green-600/30 to-green-900/30 border-green-600/50 text-green-400 active:scale-95 transition">Facile</button>
                            <button id="diff-normal" onclick="window.game.setDifficulty('normal')" style="--tw-shadow-color:#3b82f6;" class="diff-btn flex-1 glass-btn py-3 rounded-xl font-bold text-sm bg-gradient-to-r from-blue-600/30 to-blue-900/30 border-blue-600/50 text-blue-400 active:scale-95 transition">Normal</button>
                            <button id="diff-hard" onclick="window.game.setDifficulty('hard')" style="--tw-shadow-color:#ef4444;" class="diff-btn flex-1 glass-btn py-3 rounded-xl font-bold text-sm bg-gradient-to-r from-red-600/30 to-red-900/30 border-red-600/50 text-red-400 active:scale-95 transition">Difficile</button>
                            <button id="diff-expert" onclick="window.game.setDifficulty('expert')" style="--tw-shadow-color:#a855f7;" class="diff-btn flex-1 glass-btn py-3 rounded-xl font-bold text-sm bg-gradient-to-r from-purple-600/30 to-purple-900/30 border-purple-600/50 text-purple-400 active:scale-95 transition">Expert</button>
                        </div>
                        <div class="text-[10px] text-purple-300 font-bold mb-2 uppercase tracking-widest mt-4">MODIFICATEURS</div>
                        <div class="grid grid-cols-3 gap-2 w-full">
                            <button onclick="window.game.setModifier('normal')" id="mod-normal" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-gray-300">Classique</button>
                            <button onclick="window.game.setModifier('oneshot')" id="mod-oneshot" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-red-400">â˜ ï¸ One Shot</button>
                            <button onclick="window.game.setModifier('poison')" id="mod-poison" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-green-400">ğŸ§ª Poison</button>
                            <button onclick="window.game.setModifier('speed')" id="mod-speed" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-yellow-400">âš¡ Speed</button>
                            <button onclick="window.game.setModifier('vampire')" id="mod-vampire" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-pink-500">ğŸ§› Vampire</button>
                            <button onclick="window.game.setModifier('infinite')" id="mod-infinite" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-blue-400">â™¾ï¸ Infini</button>
                            <button onclick="window.game.setModifier('explosive')" id="mod-explosive" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-orange-500">ğŸ’¥ Explosif</button>
                            <button onclick="window.game.setModifier('recoil')" id="mod-recoil" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-white">ğŸ”™ Recul</button>
                            <button onclick="window.game.setModifier('giant')" id="mod-giant" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-purple-600">ğŸ˜ GÃ©ant</button>
                        </div>
                    </div>
                    <button onclick="window.game.start()" class="w-full max-w-md bg-gradient-to-r from-blue-600 to-indigo-600 h-20 rounded-2xl shadow-[0_0_40px_rgba(37,99,235,0.4)] flex items-center justify-center gap-4 active:scale-95 transition transform hover:-translate-y-1 mt-4 border border-white/20">
                        <span class="text-3xl font-black italic tracking-tighter">JOUER</span><span class="text-2xl animate-pulse">ğŸš€</span>
                    </button>
                </div>
                <div id="tab-pass" class="tab-content hidden animate-fadeIn w-full max-w-5xl mx-auto pb-20">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-3xl font-black flex items-center gap-2 font-tech"><span class="text-cyan-400">///</span> mPASS</h2>
                        <!-- TITRE S2 ANIMÃ‰ -->
                        <div class="text-right text-xl md:text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400 animate-pulse font-tech tracking-widest drop-shadow-[0_0_10px_rgba(34,211,238,0.5)]">SAISON 2: TEMPÃŠTE CYBER</div>
                    </div>
                    <div class="glass-panel p-6 mb-6 bg-gradient-to-r from-cyan-900/20 to-transparent border-cyan-500/30">
                        <div class="flex justify-between items-center mb-4">
                             <div><div class="text-2xl font-black text-white">Palier <span id="pass-lvl">1</span></div><div class="text-xs text-gray-400" id="pass-xp-txt">0/100 XP</div></div>
                             <!-- Mise Ã  jour du prix du Pass Pro -->
                             <div id="pass-pro-status"></div>
                        </div>
                        <div class="h-4 bg-black/50 rounded-full overflow-hidden"><div id="pass-bar" class="h-full bg-gradient-to-r from-cyan-500 to-purple-500 w-0 transition-all duration-300"></div></div>
                    </div>
                    <!-- Le conteneur pass-track-container est dÃ©filable -->
                    <div class="pass-track-container hide-scrollbar" id="pass-scroll-container">
                        <div class="pass-wrapper">
                             <div class="pass-track-main-line"></div>
                             <div class="pass-row" id="pass-track-free"></div>
                             <div class="pass-row pro" id="pass-track-pro"></div>
                        </div>
                    </div>
                </div>
                <div id="tab-starters" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto"><h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-blue-500">///</span> ARMURERIE</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-10" id="list-starters"></div></div>
                <div id="tab-modes" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto"><h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-purple-500">///</span> MISSIONS</h2><div class="grid grid-cols-1 gap-3 mb-8" id="list-modes"></div><h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-gray-400">TERRAINS</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-3" id="list-arenas"></div></div>
                <div id="tab-emotes" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto pb-20"><h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-pink-500">///</span> COLLECTION</h2><div class="glass-panel p-6 mb-4"><div class="text-xs text-gray-400 mb-4 uppercase font-bold">Emotes Ã‰quipÃ©es (Max 8)</div><div class="flex justify-center gap-4 mb-2 flex-wrap" id="equipped-emotes"></div></div><div class="grid grid-cols-4 md:grid-cols-6 gap-3" id="list-emotes"></div></div>
                <div id="tab-shop" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto pb-20">
                    <h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-yellow-500">///</span> MEGA MALL</h2>
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-xs text-gray-400">Nouveaux items: <span id="shop-timer" class="text-yellow-400 font-mono">--:--</span></div>
                        <button onclick="window.ui.refreshShop(true)" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-1 px-3 rounded-lg text-xs shadow-lg flex items-center gap-1 active:scale-95 transition">ğŸ”„ 10ğŸ’</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="shop-offers"></div>
                </div>
                <div id="tab-infos" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto pb-20">
                    <h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-gray-500">///</span> INFOS</h2>
                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">â˜ ï¸</div><div class="text-[10px] text-gray-500 uppercase font-bold">Kills</div><div class="text-2xl font-bold" id="stat-kills">0</div></div>
                        <div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">ğŸŒŠ</div><div class="text-[10px] text-gray-500 uppercase font-bold">Max Vague</div><div class="text-2xl font-bold" id="stat-wave">0</div></div>
                        <div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">ğŸ®</div><div class="text-[10px] text-gray-500 uppercase font-bold">Parties</div><div class="text-2xl font-bold" id="stat-games">0</div></div>
                        <div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">âš”ï¸</div><div class="text-[10px] text-gray-500 uppercase font-bold">Victoires</div><div class="text-2xl font-bold" id="stat-wins">0</div></div>
                        <div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">ğŸ’€</div><div class="text-[10px] text-gray-500 uppercase font-bold">DÃ©faites</div><div class="text-2xl font-bold" id="stat-losses">0</div></div>
                        <div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">ğŸ¦¸</div><div class="text-[10px] text-gray-500 uppercase font-bold">HÃ©ros DÃ©bloquÃ©s</div><div class="text-2xl font-bold" id="stat-unlocked">0/20</div></div>
                        <div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">ğŸ’¥</div><div class="text-[10px] text-gray-500 uppercase font-bold">DÃ©gÃ¢ts Totaux</div><div class="text-2xl font-bold" id="stat-dmg">0</div></div>
                        <div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">ğŸ«</div><div class="text-[10px] text-gray-500 uppercase font-bold">Palier Pass Max</div><div class="text-2xl font-bold" id="stat-pass-tier">1</div></div>
                    </div>
                    
                    <h3 class="text-xl font-bold mb-4 text-blue-400">COMPARATIF mPASS</h3>
                    <div class="glass-panel p-4 mb-8 overflow-hidden">
                        <table class="w-full text-sm text-left text-gray-300">
                            <tr class="border-b border-gray-700 text-xs text-gray-500 uppercase">
                                <th class="py-2 pl-2">RÃ©compense</th>
                                <th class="py-2 text-center text-gray-400">Gratuit</th>
                                <th class="py-2 text-center text-yellow-400">PRO (Total)</th>
                            </tr>
                            <tr class="border-b border-gray-700/50">
                                <td class="py-3 pl-2 font-bold">Skins Rares</td>
                                <td class="text-center">0</td>
                                <td class="text-center text-green-400">0</td>
                            </tr>
                            <tr class="border-b border-gray-700/50">
                                <td class="py-3 pl-2 font-bold">Emotes Exclusives</td>
                                <td class="text-center">1</td>
                                <td class="text-center text-green-400">3</td>
                            </tr>
                            <tr class="border-b border-gray-700/50">
                                <td class="py-3 pl-2 font-bold">Gemmes ğŸ’</td>
                                <td class="text-center">42</td>
                                <td class="text-center text-green-400">302</td>
                            </tr>
                            <tr class="border-b border-gray-700/50">
                                <td class="py-3 pl-2 font-bold">PiÃ¨ces ğŸª™</td>
                                <td class="text-center">1190</td>
                                <td class="text-center text-green-400">4490</td>
                            </tr>
                            <tr>
                                <td class="py-3 pl-2 font-bold">Mega Caisses ğŸ“¦</td>
                                <td class="text-center">4</td>
                                <td class="text-center text-green-400">8</td>
                            </tr>
                        </table>
                    </div>

                    <h3 class="text-xl font-bold mb-4 text-blue-400">GUIDE DU JEU</h3>
                    
                    <div class="mb-6">
                        <h4 class="text-sm font-bold text-purple-400 mb-2 uppercase tracking-widest border-b border-purple-500/30 pb-1">MISSIONS</h4>
                        <div class="grid gap-2 text-xs text-gray-300">
                            <div class="flex gap-2"><span class="text-xl">ğŸ§Ÿ</span> <div><b class="text-white">Survie :</b> RÃ©siste aux vagues infinies d'ennemis. Combien de temps tiendras-tu ?</div></div>
                            <div class="flex gap-2"><span class="text-xl">ğŸ†</span> <div><b class="text-white">ClassÃ© :</b> Mode compÃ©titif intense. Gagne des points de classement (RP) pour monter en grade.</div></div>
                            <div class="flex gap-2"><span class="text-xl">âš”ï¸</span> <div><b class="text-white">Duel 1v1 :</b> Affronte un IA d'Ã©lite dans une arÃ¨ne fermÃ©e. Que le meilleur gagne.</div></div>
                            <div class="flex gap-2"><span class="text-xl">ğŸ’</span> <div><b class="text-white">Braquage :</b> Infiltre la base et dÃ©truis le coffre-fort avant la fin du chrono !</div></div>
                            <div class="flex gap-2"><span class="text-xl">ğŸ‘¹</span> <div><b class="text-white">Boss Rush :</b> EnchaÃ®ne 3 Boss majeurs sans rÃ©pit. Pour les experts.</div></div>
                            <div class="flex gap-2"><span class="text-xl">ğŸŒ‹</span> <div><b class="text-white">Raid Titan :</b> Survivre contre 5 Boss simultanÃ©s. Chaos total garanti.</div></div>
                            <div class="flex gap-2"><span class="text-xl">ğŸ›¡ï¸</span> <div><b class="text-white">DÃ©fense :</b> EmpÃªche les hordes de dÃ©truire le Cristal d'Ã‰nergie au centre.</div></div>
                            <div class="flex gap-2"><span class="text-xl">ğŸš‚</span> <div><b class="text-white">Train Express :</b> Escorte le train de marchandises. Ne le laisse pas se faire dÃ©truire !</div></div>
                            <div class="flex gap-2"><span class="text-xl">ğŸ’°</span> <div><b class="text-white">Voleur :</b> RÃ©cupÃ¨re 10 sacs d'or Ã©parpillÃ©s sur la carte sans te faire tuer.</div></div>
                            <div class="flex gap-2"><span class="text-xl">ğŸŒ€</span> <div><b class="text-white">Cyber Hack :</b> Reste dans la zone du terminal pour le pirater Ã  100%.</div></div>
                            <div class="flex gap-2"><span class="text-xl">ğŸ˜¡</span> <div><b class="text-white">Carnage :</b> Mode bourrin. Ã‰limine 50 ennemis le plus vite possible !</div></div>
                            <div class="flex gap-2"><span class="text-xl">â­•</span> <div><b class="text-white">Zone :</b> Capture et maintiens la position centrale pour gagner.</div></div>
                            <div class="flex gap-2"><span class="text-xl">ğŸ‘‘</span> <div><b class="text-white">Chasse :</b> Trouve et ouvre tous les coffres cachÃ©s sur la carte.</div></div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h4 class="text-sm font-bold text-green-400 mb-2 uppercase tracking-widest border-b border-green-500/30 pb-1">TERRAINS</h4>
                        <div class="grid grid-cols-2 gap-2 text-xs text-gray-300">
                            <div><b class="text-white">Neon Tokyo :</b> MÃ©galopole cyberpunk sous une pluie Ã©ternelle et des nÃ©ons aveuglants.</div>
                            <div><b class="text-white">Sandstorm :</b> DÃ©sert aride balayÃ© par des tempÃªtes de sable violentes. VisibilitÃ© rÃ©duite.</div>
                            <div><b class="text-white">Ice Age :</b> Toundra glaciale. Le sol est glissant et le froid est mordant.</div>
                            <div><b class="text-white">Jungle :</b> ForÃªt dense et sauvage. Parfait pour les embuscades.</div>
                            <div><b class="text-white">Magma :</b> Terre brÃ»lÃ©e par la lave en fusion. Attention aux Ã©ruptions.</div>
                            <div><b class="text-white">Ruines :</b> Vestiges d'une ancienne civilisation, dÃ©lavÃ©s par la pluie acide.</div>
                            <div><b class="text-white">Cyber City :</b> Architecture futuriste propre et froide. Flux de donnÃ©es visibles.</div>
                            <div><b class="text-white">NÃ©buleuse :</b> Plateforme spatiale dÃ©rivant dans le vide cosmique.</div>
                            <div><b class="text-white">Mainframe :</b> Au cÅ“ur du systÃ¨me informatique. Murs de code binaire.</div>
                            <div><b class="text-white">Moon Base :</b> Station lunaire Ã  faible gravitÃ© et ciel Ã©toilÃ©.</div>
                            <div><b class="text-white">Cristal :</b> Caverne souterraine illuminÃ©e par des cristaux gÃ©ants magiques.</div>
                            <div><b class="text-white">Solaris :</b> Surface d'une Ã©toile mourante, chaleur extrÃªme et vents solaires.</div>
                            <div><b class="text-white">Marais :</b> Zone humide et toxique, brouillard verdÃ¢tre et vÃ©gÃ©tation pourrie.</div>
                            <div><b class="text-white">Usine :</b> Zone industrielle polluÃ©e, machines rouillÃ©es et fumÃ©e noire.</div>
                            <div><b class="text-white">NÃ©ant :</b> Dimension parallÃ¨le vide et sombre. Seule la lumiÃ¨re des combattants existe.</div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h4 class="text-sm font-bold text-yellow-400 mb-2 uppercase tracking-widest border-b border-yellow-500/30 pb-1">MODIFICATEURS</h4>
                        <div class="grid gap-2 text-xs text-gray-300">
                            <div><b class="text-white">â˜ ï¸ One Shot :</b> Tout le monde a 1 PV. Une balle = mort.</div>
                            <div><b class="text-white">ğŸ§ª Poison :</b> DÃ©gÃ¢ts sur la durÃ©e pour tous les tirs.</div>
                            <div><b class="text-white">âš¡ Speed :</b> Tout le monde (toi + ennemis) est ultra rapide.</div>
                            <div><b class="text-white">ğŸ§› Vampire :</b> Tu voles de la vie en tirant.</div>
                            <div><b class="text-white">â™¾ï¸ Infini :</b> Munitions illimitÃ©es.</div>
                            <div><b class="text-white">ğŸ’¥ Explosif :</b> Les ennemis explosent Ã  leur mort.</div>
                            <div><b class="text-white">ğŸ”™ Recul :</b> Tirer te propulse en arriÃ¨re.</div>
                            <div><b class="text-white">ğŸ˜ GÃ©ant :</b> Tout le monde est gÃ©ant (x2 taille).</div>
                        </div>
                    </div>

                    <div class="glass-panel p-6 mb-6 hidden md:block"><h3 class="text-xl font-bold text-blue-400 mb-4">COMMANDES PC</h3><table class="w-full text-sm text-left text-gray-300"><tr class="border-b border-gray-700"><th class="py-2">Action</th><th class="py-2">Touche</th></tr><tr><td class="py-2">DÃ©placement</td><td class="font-mono text-yellow-400">Z Q S D</td></tr><tr><td class="py-2">Viser</td><td class="font-mono text-yellow-400">Souris</td></tr><tr><td class="py-2">Tirer</td><td class="font-mono text-yellow-400">Clic Gauche</td></tr><tr><td class="py-2">Dash</td><td class="font-mono text-yellow-400">Espace</td></tr><tr><td class="py-2">Gadget</td><td class="font-mono text-yellow-400">E</td></tr><tr><td class="py-2">Emote</td><td class="font-mono text-yellow-400">V</td></tr></table></div>
                    
                    <h3 class="text-xl font-bold mb-4 text-blue-400">PATCH NOTES</h3>
                    <div class="glass-panel p-6 text-sm text-gray-300"><div class="patch-note"><h3>v1.2.1 (Fixes)</h3><ul><li>ğŸ› <b>HUD :</b> Correction de l'affichage du niveau du hÃ©ros en jeu.</li><li>ğŸ› ï¸ <b>StabilitÃ© :</b> Corrections de bugs divers et optimisations.</li></ul></div><div class="patch-note"><h3>v1.2.0 (THE HEROIC UPDATE)</h3><ul><li>â­ï¸ <b>10 Nouveaux HÃ©ros :</b> Vulcan, Zephyr, Necro, Gladiator, Bouncer, Fungus, Wasp, Mirage, Juggernaut, Eclipse ! (Total 60 HÃ©ros)</li><li>ğŸ­ <b>100 Emotes :</b> Collection massive de nouvelles emotes !</li><li>ğŸ« <b>mPass MAX :</b> Le Pass de Combat s'Ã©tend maintenant jusqu'au palier 100 avec une rÃ©compense ultime !</li><li>ğŸ¨ <b>Skins :</b> 5 Skins pour TOUS les nouveaux hÃ©ros.</li><li>ğŸ› <b>Optimisation :</b> FluiditÃ© accrue.</li></ul></div><div class="patch-note"><h3>v1.1.5 (Content Explosion)</h3><ul><li>ğŸ”¥ <b>Missions & Terrains :</b> Total 20 Modes et 15 ArÃ¨nes !</li><li>ğŸ¨ <b>Skins :</b> 5 Skins minimum pour CHAQUE hÃ©ros !</li><li>âš™ï¸ <b>Modificateurs :</b> Total 15 modificateurs (Nouveau: Fragile).</li><li>ğŸ˜€ <b>Emotes :</b> 25 Nouvelles Emotes (Total 75+).</li><li>ğŸ› <b>Correctifs :</b> StabilitÃ© et bugs mineurs corrigÃ©s.</li></ul></div><div class="patch-note"><h3>v1.1.4 (Packs Corrections)</h3><ul><li>ğŸ› ï¸ Corrections de bugs sur les quÃªtes et rÃ©compenses.</li><li>âš¡ Optimisation des performances.</li><li>ğŸ› Fix: Orthographe Modificateurs.</li></ul></div><div class="patch-note"><h3>v1.1.3 (Update Heroes)</h3><ul><li>ğŸ¦¸ 5 Nouveaux HÃ©ros : Cyclops, Banshee, Druid, Spartan, Hydra !</li><li>ğŸ“ Descriptions : AmÃ©lioration des textes d'Infos (Missions & Terrains).</li><li>ğŸ› Bugs : Corrections mineures et optimisation.</li></ul></div><div class="patch-note"><h3>v1.1.2 (Big Content Update)</h3><ul><li>ğŸ”¥ 5 Nouveaux HÃ©ros : Vulcan, Zephyr, Necro, Gladiator, Bouncer !</li><li>ğŸ‘• SKINS : Tous les hÃ©ros ont maintenant 5 skins minimum !</li><li>âš™ï¸ 5 Nouveaux Modificateurs : Low Gravity, Double DÃ©gÃ¢ts, Tiny, Pluie de Balles, No Regen.</li><li>ğŸ° 3 Nouveaux Terrains : Marais, Usine, NÃ©ant.</li><li>â˜ ï¸ Nouvelle Mission : Chasse au TrÃ©sor.</li><li>ğŸ˜€ Emotes : Collection Ã©tendue Ã  50 emotes !</li></ul></div><div class="patch-note"><h3>v1.1.1 (Patch mPass)</h3><ul><li>ğŸ¨ mPASS 2.0 : Refonte complÃ¨te du design du Pass de Combat !</li><li>ğŸŒ‹ Nouveau Terrain : Solaris (Ambiance volcanique et cendres).</li><li>ğŸ› ï¸ Bugs CorrigÃ©s : Fiabilisation de la boutique et du changement d'onglets.</li></ul></div><div class="patch-note"><h3>v1.1.0</h3><ul><li>ğŸ¦¸ 5 Nouveaux HÃ©ros (FINAL) : Spike, Tesla, Siren, Paladin, Zenith !</li><li>ğŸ“œ SystÃ¨me de QuÃªtes : QuÃªtes Quotidiennes (Reset 24h) et de Saison.</li><li>ğŸ¯ Nouvelles Missions de quÃªtes : DÃ©gÃ¢ts, Collecte, Survie...</li><li>ğŸ’¸ Drops : Les ennemis lÃ¢chent parfois des PiÃ¨ces et Gemmes !</li><li>ğŸ”¥ Level 45+ HÃ©ros total !</li></ul></div><div class="patch-note"><h3>v1.0.6</h3><ul><li>ğŸš€ 2 Nouvelles Missions : Carnage (Tuer 50 ennemis) & Zone (ContrÃ´le de zone).</li><li>ğŸ’ Nouveau Terrain : Grotte de Cristal.</li><li>âœ¨ AmÃ©lioration visuelle : Plus d'effets sur tous les terrains !</li><li>ğŸ› ï¸ Correction de bugs : Gestion de la camÃ©ra et spawns.</li></ul></div><div class="patch-note"><h3>v1.0.5</h3><ul><li>ğŸ› ï¸ CRITIQUE : RÃ©paration de l'IA (Vision des bots).</li><li>âš¡ Optimisation du code.</li></ul></div><div class="patch-note"><h3>v1.0.4</h3><ul><li>ğŸ¦¸ 5 Nouveaux HÃ©ros : Spectre, Solar, Orbit, Raptor, Grunt !</li><li>ğŸš€ Nouvelle Mission : Cyber Escape. Rejoins la zone d'extraction !</li><li>ğŸ› ï¸ Bugs corrigÃ©s : Soin impossible en One Shot, IA amÃ©liorÃ©e vs InvisibilitÃ©.</li></ul></div><div class="patch-note"><h3>v1.0.3</h3><ul><li>ğŸ¦¸ 5 Nouveaux HÃ©ros : Rock, Frost, Blaze, Storm, Glitch !</li><li>ğŸ› ï¸ Corrections de bugs (RÃ©gÃ©nÃ©ration Bots).</li><li>âš¡ AmÃ©liorations diverses.</li></ul></div><div class="patch-note"><h3>v1.0.2</h3><ul><li>ğŸ› ï¸ Corrections de bugs : Refresh Shop et Affichage des rÃ©compenses.</li><li>ğŸ’ Optimisation de l'interface.</li></ul></div><div class="patch-note"><h3>v1.0.1</h3><ul><li>ğŸ¦¸ 5 Nouveaux HÃ©ros : Archer, Brawler, Grenadier, Vortex, Nova !</li><li>ğŸ”« Nouveau Mode : Jeu d'Armes (Gun Game).</li><li>ğŸŒ‘ Nouvelle ArÃ¨ne : Moon Base.</li><li>ğŸ‘• Nouveaux Skins : Ajout de 5 nouveaux skins pour Chrono, Viper, Bomber, Samurai et Cyber.</li><li>ğŸ Offres Gratuites : Nouvelles rÃ©compenses temporaires gratuites dans la boutique !</li><li>âš¡ Optimisations diverses et corrections mineures.</li></ul></div><div class="patch-note"><h3>v1.0.0 (Saison 2)</h3><ul><li>2ï¸âƒ£ Ajout du contenu de saison 2</li><li>ğŸš« Correction de bugs majeurs principalement.</li><li>ğŸ‘• Nouveaux Skins : Ajout de skins pour Drone, Harpy, Shaman et Reaper.</li><li> ğŸ‘• Nouveaux hÃ©ros : ajout pour 30 au total</li><li>â³ AmÃ©liorations divers (profil, shop...)</li><li>ğŸ¦¾ PV Bots : Augmentation des PV de base des bots (+20 PV) et amÃ©lioration de l'intelligence des bots.</li></ul></div></div>
                </div>
                <div id="tab-profile" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto pb-20">
                    <h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-white">///</span> COMPTE</h2>
                    <div class="glass-panel p-6 mb-6 flex items-center gap-6 bg-blue-900/10 border-blue-500/30">
                        <div class="relative group cursor-pointer" onclick="window.ui.openAvatarSelector()">
                            <div class="w-20 h-20 rounded-full bg-gray-800 border-2 border-white/20 flex items-center justify-center text-4xl shadow-lg overflow-hidden hover:border-blue-500 transition" id="profile-avatar">ğŸ‘¤</div>
                            <div class="absolute bottom-0 right-0 bg-blue-600 border border-white text-[10px] p-1 rounded-full text-white shadow-sm">âœï¸</div>
                        </div>
                        <div class="flex-1">
                            <div class="text-xs text-gray-400 font-bold uppercase mb-1">Pseudonyme</div>
                            <input type="text" id="profile-name" class="bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-white font-bold w-full mb-2 focus:outline-none focus:border-blue-500 transition" onchange="USER.name = this.value; Storage.save();" value="Player">
                            <div class="flex justify-between items-center">
                                <div class="text-xs text-blue-400 font-tech tracking-widest" id="profile-tag">#TAG</div>
                                <div class="bg-black border border-gray-600 text-[9px] px-2 rounded text-yellow-400 font-bold" id="profile-lvl">LVL 1</div>
                            </div>
                        </div>
                    </div>
                <div class="glass-panel p-6 mb-6 bg-blue-900/10 border-blue-500/30">
                        <h3 class="text-xl font-bold mb-4 flex items-center gap-2 text-yellow-400">
                            ğŸ“œ QUÃŠTES DU JOUR 
                            <span class="text-[10px] text-gray-500 bg-black px-2 py-0.5 rounded" id="quest-timer">Reset 24h</span>
                            <button onclick="window.QuestSystem.refreshDaily()" class="ml-auto bg-purple-600 hover:bg-purple-500 text-white font-bold py-1 px-3 rounded-lg text-xs shadow-lg flex items-center gap-1 active:scale-95 transition">ğŸ”„ 10ğŸ’</button>
                        </h3>
                        <div id="daily-quests-list" class="flex flex-col gap-2"></div>
                    </div>

                    <div class="glass-panel p-6 mb-6 bg-purple-900/10 border-purple-500/30">
                        <h3 class="text-xl font-bold mb-4 flex items-center gap-2 text-purple-400">ğŸŒŸ QUÃŠTES DE SAISON</h3>
                        <div id="season-quests-list" class="flex flex-col gap-2"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="glass-panel p-6">
                            <div class="font-bold text-lg mb-2 flex items-center gap-2">ğŸ’¾ Sauvegarde</div>
                            <div class="text-xs text-gray-400 mb-4">Copie ce code pour transfÃ©rer ton compte.</div>
                            <button onclick="window.ui.exportSave()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition text-sm">COPIER MA SAUVEGARDE ğŸ“‹</button>
                        </div>
                        <div class="glass-panel p-6">
                            <div class="font-bold text-lg mb-2 flex items-center gap-2">ğŸ“¥ Importer</div>
                            <div class="text-xs text-gray-400 mb-4">Colle un code de sauvegarde ici.</div>
                            <button onclick="window.ui.importSave()" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-xl transition text-sm">IMPORTER SAUVEGARDE ğŸ”„</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="w-full glass-nav h-[90px] pb-safe flex justify-around items-center px-2 z-40 relative overflow-x-auto hide-scrollbar">
                <button onclick="window.ui.showTab('play')" id="nav-play" class="nav-item flex flex-col items-center p-2 min-w-[60px] active selected"><span class="text-2xl icon mb-1">âš”ï¸</span><span class="text-[9px] font-bold">JOUER</span></button>
                <button onclick="window.ui.showTab('starters')" id="nav-starters" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">ğŸ¦¸</span><span class="text-[9px] font-bold">HÃ‰ROS</span></button>
                <button onclick="window.ui.showTab('pass')" id="nav-pass" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">ğŸ«</span><span class="text-[9px] font-bold">PASS</span></button>
                <button onclick="window.ui.showTab('emotes')" id="nav-emotes" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">ğŸ˜€</span><span class="text-[9px] font-bold">EMOTES</span></button>
                <button onclick="window.ui.showTab('shop')" id="nav-shop" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">ğŸ›’</span><span class="text-[9px] font-bold">SHOP</span></button>
                <button onclick="window.ui.showTab('infos')" id="nav-infos" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">â„¹ï¸</span><span class="text-[9px] font-bold">INFOS</span></button>
                <button onclick="window.ui.showTab('profile')" id="nav-profile" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">ğŸ‘¤</span><span class="text-[9px] font-bold">PROFIL</span></button>
            </div>
        </div>

        <!-- SETTINGS MODAL -->
        <div id="settings-modal" class="hidden absolute inset-0 bg-black/95 backdrop-blur-xl flex items-center justify-center z-[60] pointer-events-auto animate-fadeIn" onclick="window.ui.closeSettings()">
             <div class="glass-panel p-6 max-w-sm w-full mx-4 flex flex-col gap-4 max-h-[80vh] overflow-y-auto hide-scrollbar" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center border-b border-white/10 pb-4"><h3 class="text-xl font-black">PARAMÃˆTRES âš™ï¸</h3><button onclick="window.ui.closeSettings()" class="text-2xl text-gray-400 hover:text-white">Ã—</button></div>
                <div class="settings-grp"><label class="settings-label">Pseudonyme</label><input type="text" id="setting-name" class="profile-input" onchange="USER.name = this.value; Storage.save(); window.ui.renderProfile()"></div>
                <div class="settings-grp"><label class="settings-label">Avatar</label><button onclick="window.ui.openAvatarSelector()" class="w-full bg-white/10 hover:bg-white/20 border border-white/20 py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2">CHANGER D'AVATAR ğŸ‘¤</button></div>
                <div class="settings-grp"><label class="settings-label">Email</label><input type="email" id="setting-email" placeholder="email@exemple.com" class="profile-input" onchange="USER.email = this.value; Storage.save();"></div>
                <div class="settings-grp"><label class="settings-label">TÃ©lÃ©phone</label><input type="tel" id="setting-phone" placeholder="+33 6..." class="profile-input" onchange="USER.phone = this.value; Storage.save();"></div>
                <div class="settings-grp"><label class="settings-label">Date de Naissance</label><input type="date" id="setting-dob" class="profile-input" onchange="USER.dob = this.value; Storage.save();"></div>
                <div class="settings-grp"><label class="settings-label">Bio</label><textarea id="setting-bio" placeholder="Ta description..." class="profile-input resize-none h-20" onchange="USER.bio = this.value; Storage.save(); window.ui.renderProfile()"></textarea></div>
                <div class="settings-grp pt-2 border-t border-white/10 mt-2"><div class="flex justify-between items-center mb-2"><label class="settings-label text-yellow-400">ThÃ¨me du Profil <span class="bg-yellow-500 text-black px-1 rounded text-[8px]">PRO</span></label><div id="theme-lock-icon" class="text-[10px] text-gray-500"></div></div><div class="flex gap-2 overflow-x-auto hide-scrollbar p-1" id="profile-theme-selector"></div></div>
                <button onclick="window.ui.closeSettings()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl mt-2">ENREGISTRER</button>
                <div class="mt-4 pt-4 border-t border-white/10 text-center"><p class="text-[10px] text-gray-500 leading-relaxed">mBattle est un jeu vidÃ©o gratuit conÃ§u par Mathias Tusseau. Les bots sont pilotÃ©s par mAI.<br>Si vous rencontrez un problÃ¨me, rendez vous sur : <a href="https://forms.gle/1PVVdcSi3mYyq3XeA" target="_blank" class="text-blue-400 hover:underline">Support</a></p><div class="text-[8px] text-gray-600 mt-1">v1.2.1</div></div>
             </div>
        </div>

        <!-- HERO DETAILS MODAL -->
        <div id="hero-details-modal" class="hidden absolute inset-0 bg-black/95 backdrop-blur-xl flex items-center justify-center z-[60] pointer-events-auto animate-fadeIn" onclick="this.classList.add('hidden')">
            <div class="glass-panel p-6 max-w-md w-full mx-4 relative border-2 border-blue-500/30" onclick="event.stopPropagation()" id="hero-card-inner">
                <button onclick="document.getElementById('hero-details-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl z-10">Ã—</button>
                <div class="flex flex-col items-center mb-6"><div class="w-24 h-24 rounded-2xl bg-black/50 border-2 border-white/20 flex items-center justify-center text-6xl shadow-[0_0_30px_rgba(59,130,246,0.3)] mb-3" id="hd-icon"></div><h2 class="text-3xl font-black uppercase font-tech tracking-wider" id="hd-name"></h2><div id="hd-rarity" class="mb-1 text-xs font-bold uppercase tracking-widest px-3 py-1 rounded bg-gray-800">COMMUN</div><div class="text-blue-400 font-bold text-sm" id="hd-lvl"></div></div>
                <!-- REMPLACÃ‰ PAR hero-stats-container pour les dÃ©tails par niveau -->
                <div id="hero-stats-container" class="space-y-4 mb-6"></div>
                <!-- FIN REMPLACÃ‰ -->
                <div class="mb-4" id="hd-skins-container"><div class="text-[10px] text-gray-400 uppercase font-bold mb-2">SKINS</div><div class="flex gap-2 overflow-x-auto hide-scrollbar" id="hd-skins-list"></div></div>
                <div class="bg-white/5 p-4 rounded-xl border border-white/10 mb-4"><div class="flex justify-between"><div><div class="text-[10px] text-gray-400 uppercase font-bold mb-1">GADGET</div><div class="text-sm font-bold text-white flex items-center gap-2"><span id="hd-gadget-icon">âš¡</span> <span id="hd-gadget-name"></span></div></div><div><div class="text-[10px] text-gray-400 uppercase font-bold mb-1 text-right">PASSIF</div><div class="text-sm font-bold text-yellow-400 text-right" id="hd-passive"></div></div></div></div>
                <p class="text-xs text-gray-400 italic text-center mb-6 leading-relaxed whitespace-pre-line" id="hd-desc"></p>
                <div id="hd-actions" class="grid gap-2"></div>
            </div>
        </div>
        <!-- AVATAR SELECTOR WITH UPLOAD -->
        <div id="avatar-selector" class="hidden absolute inset-0 bg-black/90 backdrop-blur-xl flex items-center justify-center z-[60] pointer-events-auto animate-fadeIn" onclick="this.classList.add('hidden')">
            <div class="glass-panel p-6 max-w-sm w-full mx-4 flex flex-col gap-4" onclick="event.stopPropagation()">
                <h3 class="text-xl font-black text-center">CHOISIS TON AVATAR</h3>
                <div class="grid grid-cols-5 gap-2 mb-2 overflow-y-auto max-h-64 hide-scrollbar" id="avatar-grid"></div>
                <div class="border-t border-white/10 pt-4">
                    <input type="file" id="upload-avatar" hidden accept="image/*" onchange="window.ui.uploadAvatar(this)">
                    <button onclick="document.getElementById('upload-avatar').click()" class="w-full bg-blue-600/50 hover:bg-blue-500 border border-blue-500/50 py-3 rounded-xl font-bold text-sm mb-2">IMPORTER IMAGE ğŸ“¸</button>
                    <button onclick="document.getElementById('avatar-selector').classList.add('hidden')" class="w-full bg-gray-700 py-3 rounded-xl font-bold text-sm">ANNULER</button>
                </div>
            </div>
        </div>
        <div id="levelup-screen" class="hidden absolute inset-0 bg-black/90 backdrop-blur-xl flex items-center justify-center z-[60] pointer-events-auto animate-fadeIn">
            <div class="w-full max-w-sm p-6 text-center"><h2 class="text-5xl font-tech text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 font-black mb-4 animate-bounce">LEVEL UP!</h2><div id="perk-container" class="grid gap-3"></div></div>
        </div>
        <div id="gameover-screen" class="hidden absolute inset-0 bg-red-950/95 backdrop-blur-2xl flex items-center justify-center z-[70] pointer-events-auto animate-fadeIn">
            <div class="text-center max-w-sm w-full p-6">
                <h1 id="go-title" class="text-8xl font-black text-white mb-2 drop-shadow-2xl tracking-tighter">KO</h1>
                <p class="text-red-400 font-bold text-xl mb-8 uppercase tracking-widest" id="go-reason">Ã‰liminÃ©</p>
                <div class="glass-panel p-6 mb-6 grid grid-cols-2 gap-4 text-left bg-black/40">
                    <div><div class="text-[10px] text-gray-500 uppercase font-bold mb-1">Score</div><div id="go-score" class="text-2xl font-black text-white font-tech">0</div></div>
                    <div><div class="text-[10px] text-gray-500 uppercase font-bold mb-1">Gains</div><div class="text-xl font-bold text-yellow-400" id="go-rewards"></div></div>
                </div>
                <button onclick="game.toMenu()" class="w-full bg-white text-black font-black py-4 rounded-xl active:scale-95 transition shadow-xl text-lg">RETOUR MENU ğŸ </button>
            </div>
        </div>
    </div>
    <script>
        /* mBATTLE v1.1.5 - SAISON 2 */
        window.game = {}; 

        const CFG = { w: 0, h: 0, world: 2500 };
        
        // --- FACTEURS DE TUNING V1.0.0 ---
        const SPEED_FACTOR = 0.64; 
        const RATE_FACTOR = 1.38; 
        const RELOAD_FACTOR = 1.02;
        const PROJ_SPEED_FACTOR = 0.93;
        const ENEMY_HP_BUFF = 20; // +20 PV pour les bots/ennemis

        const RARITY = { common: { name: 'Commun', color: '#94a3b8', bg: 'bg-gray-500' }, rare: { name: 'Rare', color: '#3b82f6', bg: 'bg-blue-500' }, epic: { name: 'Ã‰pique', color: '#a855f7', bg: 'bg-purple-500' }, legendary: { name: 'LÃ©gendaire', color: '#eab308', bg: 'bg-yellow-500' }, mythic: { name: 'Mythique', color: '#ef4444', bg: 'bg-red-600' } };
        
        // PRIX STANDARDISÃ‰S
        const PRICE_COMMON = 0;
        const PRICE_RARE = 1000;
        const PRICE_EPIC = 1800;
        const PRICE_LEGENDARY = 3200;
        const PRICE_MYTHIC = 5000;

        // DÃ‰FINITION DES PROPRIÃ‰TÃ‰S DES PROJECTILES UNIQUES PAR HÃ‰ROS
        const STARTERS = { 
            soldier: { name: "Soldier", rarity: 'common', icon: "ğŸ”«", hp: 130, dmg: 22, spd: 5.5 * SPEED_FACTOR, rate: Math.ceil(14 * RATE_FACTOR), ammo:3, reload:Math.ceil(40 * RELOAD_FACTOR), price: PRICE_COMMON, scale:{hp:10, dmg:2}, color: '#3b82f6', desc: "Polyvalent.", gadget: "heal", lore: "VÃ©tÃ©ran des guerres galactiques.", passive: "Regen Rapide", 
                       proj: { r: 5, speed: Math.ceil(20 * PROJ_SPEED_FACTOR), life: 60, shape: 'circle', color: '#3b82f6', trailColor: '#1e3a8a' },
                       skins: [ {id:'default', name:'Soldat', c:'#3b82f6'}, {id:'gold', name:'Soldat Or', c:'#fbbf24', price: 2000}, {id:'commando', name:'Commando', c:'#166534', price: 1500}, {id:'pixel', name:'Pixel', c:'#60a5fa', price: 1000}, {id:'veteran', name:'VÃ©tÃ©ran', c:'#4b5563', price: 2500} ] }, 
            drone: { name: "Drone", rarity: 'common', icon: "ğŸ›¸", hp: 80, dmg: 15, spd: 7.0 * SPEED_FACTOR, rate: Math.ceil(8 * RATE_FACTOR), ammo:10, reload:Math.ceil(30 * RELOAD_FACTOR), price: PRICE_COMMON, scale:{hp:5, dmg:2}, color: '#94a3b8', type: 'laser', desc: "Rapide et fragile.", gadget: "speed", lore: "Un drone de surveillance devenu fou.", passive: "Esquive", 
                     proj: { r: 4, speed: Math.ceil(30 * PROJ_SPEED_FACTOR), life: 70, shape: 'laser', color: '#94a3b8', trailColor: '#cbd5e1' },
                     skins: [{id:'default', name:'Drone', c:'#94a3b8'}, {id:'stealth', name:'Furtif', c:'#0f172a', price: 1000}, {id:'glow', name:'NÃ©on Bleu', c:'#0ea5e9', price: 1500}, {id:'gold', name:'Or', c:'#fbbf24', price: 2000}, {id:'red', name:'Alerte', c:'#ef4444', price: 1000}] },
            // NOUVEAU HÃ‰ROS : COMMUN (Scout)
            scout: { name: "Scout", rarity: 'common', icon: "ğŸƒ", hp: 110, dmg: 18, spd: 7.5 * SPEED_FACTOR, rate: Math.ceil(12 * RATE_FACTOR), ammo:5, reload:Math.ceil(30 * RELOAD_FACTOR), price: PRICE_COMMON, scale:{hp:8, dmg:2}, color: '#94a3b8', type: 'normal', desc: "Ã‰claireur ultra-rapide.", gadget: "speed", lore: "SpÃ©cialiste de la reconnaissance.", passive: "Course",
                     proj: { r: 4, speed: Math.ceil(28 * PROJ_SPEED_FACTOR), life: 60, shape: 'circle', color: '#f59e0b', trailColor: '#fbbf24' },
                     skins: [{id:'default', name:'Scout', c:'#94a3b8'}, {id:'desert', name:'DÃ©sert', c:'#d97706', price: 1500}, {id:'solaire', name:'Solaire', c:'#fef08a', price: 2000}, {id:'forest', name:'ForÃªt', c:'#166534', price: 1500}, {id:'night', name:'Nuit', c:'#1e1b4b', price: 2500}] },

            tank: { name: "Heavy", rarity: 'rare', icon: "ğŸ›¡ï¸", hp: 320, dmg: 14, spd: 3.5 * SPEED_FACTOR, rate: Math.ceil(35 * RATE_FACTOR), ammo:3, reload:Math.ceil(55 * RELOAD_FACTOR), price: PRICE_RARE, scale:{hp:30, dmg:1}, color: '#22c55e', type: 'shotgun', desc: "Sac Ã  PV.", gadget: "shield", lore: "Une forteresse mobile.", passive: "Armure +20%", 
                    proj: { r: 8, speed: Math.ceil(15 * PROJ_SPEED_FACTOR), life: 50, shape: 'circle', color: '#22c55e', trailColor: '#166534' },
                    skins: [ {id:'default', name:'Heavy', c:'#22c55e'}, {id:'toxic', name:'Toxic', c:'#a3e635', price: 1500}, {id:'mecha', name:'Mecha', c:'#f3f4f6', price: 2500}, {id:'rusty', name:'RouillÃ©', c:'#78350f', price: 1000}, {id:'titan', name:'Titan', c:'#eab308', price: 3000} ] }, 
            bomber: { name: "Bomber", rarity: 'rare', icon: "ğŸ’£", hp: 150, dmg: 45, spd: 4.5 * SPEED_FACTOR, rate: Math.ceil(40 * RATE_FACTOR), ammo:2, reload:Math.ceil(60 * RELOAD_FACTOR), price: PRICE_RARE, scale:{hp:15, dmg:5}, color: '#f59e0b', type: 'shotgun', desc: "Explosifs.", gadget: "knockback", lore: "Adore les feux d'artifice.", passive: "DÃ©gÃ¢ts Zone", 
                      proj: { r: 10, speed: Math.ceil(12 * PROJ_SPEED_FACTOR), life: 40, shape: 'circle', color: '#f59e0b', trailColor: '#fed7aa' },
                      skins: [{id:'default', name:'Bomber', c:'#f59e0b'}, {id:'nuke', name:'NuclÃ©aire', c:'#84cc16', price: 1800}, {id:'frost', name:'Givre', c:'#0ea5e9', price: 1500}, {id:'shadow', name:'Ombre', c:'#171717', price: 2200}, {id:'fire', name:'Feu', c:'#b91c1c', price: 2500}] },
            sniper: { name: "Sniper", rarity: 'rare', icon: "ğŸ¦…", hp: 80, dmg: 120, spd: 5 * SPEED_FACTOR, rate: Math.ceil(65 * RATE_FACTOR), ammo:3, reload:Math.ceil(80 * RELOAD_FACTOR), price: PRICE_RARE, scale:{hp:5, dmg:15}, color: '#a855f7', type: 'sniper', desc: "Tireur d'Ã©lite.", gadget: "knockback", lore: "Ne rate jamais sa cible.", passive: "Critique +10%", 
                      proj: { r: 6, speed: Math.ceil(25 * PROJ_SPEED_FACTOR), life: 100, shape: 'sniper', color: '#a855f7', trailColor: '#7c3aed' },
                      skins: [{id:'default', name:'Sniper', c:'#a855f7'}, {id:'elite', name:'Elite', c:'#1e1b4b', price: 3000}, {id:'camo', name:'Camo', c:'#3f6212', price: 1500}, {id:'ghillie', name:'Ghillie', c:'#14532d', price: 2000}, {id:'desert', name:'DÃ©sert', c:'#d97706', price: 2500}] }, 
            harpy: { name: "Harpy", rarity: 'rare', icon: "ğŸ•Šï¸", hp: 100, dmg: 18, spd: 6.8 * SPEED_FACTOR, rate: Math.ceil(7 * RATE_FACTOR), ammo:8, reload:Math.ceil(35 * RELOAD_FACTOR), price: PRICE_RARE, scale:{hp:7, dmg:3}, color: '#84cc16', type: 'normal', desc: "Rapide et agile.", gadget: "speed", lore: "Chasseur aÃ©rien.", passive: "Tir Rapide",
                     proj: { r: 4, speed: Math.ceil(25 * PROJ_SPEED_FACTOR), life: 50, shape: 'circle', color: '#84cc16', trailColor: '#a7f3d0' },
                     skins: [{id:'default', name:'Harpy', c:'#84cc16'}, {id:'frost', name:'Givre', c:'#bae6fd', price: 1000}, {id:'fire', name:'Ardente', c:'#dc2626', price: 1500}, {id:'storm', name:'TempÃªte', c:'#6366f1', price: 2000}, {id:'dark', name:'Sombre', c:'#1f2937', price: 2500}] }, 
            // NOUVEAU HÃ‰ROS : RARE
            engineer: { name: "Engineer", rarity: 'rare', icon: "âš™ï¸", hp: 180, dmg: 15, spd: 4.8 * SPEED_FACTOR, rate: Math.ceil(18 * RATE_FACTOR), ammo:8, reload:Math.ceil(40 * RELOAD_FACTOR), price: PRICE_RARE, scale:{hp:15, dmg:2}, color: '#fbbf24', type: 'normal', desc: "Construit des tourelles de dÃ©fense.", gadget: "turret", lore: "Le gÃ©nie du champ de bataille.", passive: "Tourelle",
                     proj: { r: 6, speed: Math.ceil(20 * PROJ_SPEED_FACTOR), life: 60, shape: 'circle', color: '#fbbf24', trailColor: '#eab308' },
                     skins: [{id:'default', name:'Engineer', c:'#fbbf24'}, {id:'robot', name:'Robotique', c:'#94a3b8', price: 1000}, {id:'stealth', name:'Furtif', c:'#1e293b', price: 1500}, {id:'cyber', name:'Cyber', c:'#06b6d4', price: 2000}, {id:'builder', name:'Constructeur', c:'#ea580c', price: 2500}] },

            assassin:{ name: "Assassin", rarity: 'epic', icon: "ğŸ—¡ï¸", hp: 90, dmg: 18, spd: 7.5 * SPEED_FACTOR, rate: Math.ceil(8 * RATE_FACTOR), ammo:4, reload:Math.ceil(30 * RELOAD_FACTOR), price: PRICE_EPIC, scale:{hp:8, dmg:4}, color: '#ef4444', desc: "Ultra rapide.", gadget: "speed", lore: "Une ombre dans la nuit.", passive: "Vitesse Kill", 
                       proj: { r: 5, speed: Math.ceil(22 * PROJ_SPEED_FACTOR), life: 55, shape: 'circle', color: '#ef4444', trailColor: '#991b1b' },
                       skins: [{id:'default', name:'Assassin', c:'#ef4444'}, {id:'ninja', name:'Ninja', c:'#171717', price: 2500}, {id:'void', name:'NÃ©ant', c:'#4c1d95', price: 3500}, {id:'crimson', name:'Pourpre', c:'#be185d', price: 3000}, {id:'white', name:'Blanc', c:'#e5e5e5', price: 4000}] }, 
            pyro: { name: "Pyro", rarity: 'epic', icon: "ğŸ”¥", hp: 160, dmg: 7, spd: 5 * SPEED_FACTOR, rate: Math.ceil(4 * RATE_FACTOR), ammo:50, reload:Math.ceil(10 * RELOAD_FACTOR), price: PRICE_EPIC, scale:{hp:15, dmg:1}, color: '#f97316', type: 'flame', desc: "Zone de feu.", gadget: "dash", lore: "Adore l'odeur du napalm.", passive: "BrÃ»lure", 
                    proj: { r: 15, speed: Math.ceil(10 * PROJ_SPEED_FACTOR), life: 30, shape: 'flame', color: '#f97316', trailColor: '#fef3c7' },
                    skins: [{id:'default', name:'Pyro', c:'#f97316'}, {id:'blueflame', name:'Flamme Bleue', c:'#3b82f6', price: 2000}, {id:'toxic', name:'Toxique', c:'#16a34a', price: 1500}, {id:'inferno', name:'Inferno', c:'#7f1d1d', price: 2500}, {id:'charcoal', name:'Charbon', c:'#262626', price: 3000}] }, 
            viper: { name: "Viper", rarity: 'epic', icon: "ğŸ", hp: 110, dmg: 10, spd: 6.2 * SPEED_FACTOR, rate: Math.ceil(5 * RATE_FACTOR), ammo: 25, reload: Math.ceil(40 * RELOAD_FACTOR), price: PRICE_EPIC, scale:{hp:8, dmg:1}, color: '#4d7c0f', type: 'flame', desc: "Tire du poison.", gadget: "speed", lore: "Mortel et silencieux.", passive: "Poison", 
                     proj: { r: 6, speed: Math.ceil(28 * PROJ_SPEED_FACTOR), life: 70, shape: 'snake', color: '#4d7c0f', trailColor: '#10b981' },
                     skins: [{id:'default', name:'Viper', c:'#4d7c0f'}, {id:'cobra', name:'Cobra', c:'#eab308', price: 2000}, {id:'venom', name:'Venin', c:'#10b981', price: 2500}, {id:'ice', name:'Glace', c:'#0ea5e9', price: 2200}, {id:'purple', name:'Violet', c:'#9333ea', price: 2800}] }, 
            shaman: { name: "Shaman", rarity: 'epic', icon: "ğŸŒ¿", hp: 140, dmg: 15, spd: 5.2 * SPEED_FACTOR, rate: Math.ceil(18 * RATE_FACTOR), ammo:4, reload:Math.ceil(30 * RELOAD_FACTOR), price: PRICE_EPIC, scale:{hp:12, dmg:2}, color: '#10b981', type: 'normal', desc: "Aura toxique.", gadget: "heal", lore: "Force de la nature.", passive: "Poison Aura",
                      proj: { r: 7, speed: Math.ceil(18 * PROJ_SPEED_FACTOR), life: 65, shape: 'circle', color: '#10b981', trailColor: '#6ee7b7' },
                      skins: [{id:'default', name:'Shaman', c:'#10b981'}, {id:'spirit', name:'Esprit', c:'#e5e7eb', price: 2000}, {id:'void', name:'NÃ©ant', c:'#374151', price: 3000}, {id:'fire', name:'Feu', c:'#ef4444', price: 3000}, {id:'ice', name:'Glace', c:'#3b82f6', price: 3500}] }, 
            reaper: { name: "Reaper", rarity: 'epic', icon: "ğŸ’€", hp: 200, dmg: 55, spd: 6.0 * SPEED_FACTOR, rate: Math.ceil(20 * RATE_FACTOR), ammo:1, reload:Math.ceil(35 * RELOAD_FACTOR), price: PRICE_EPIC, scale:{hp:15, dmg:7}, color: '#171717', type: 'melee', desc: "Faux de l'ombre.", gadget: "dash", lore: "SÃ¨me la mort.", passive: "Vol de Vie",
                      proj: { r: 50, speed: 0, life: 1, shape: 'melee', color: '#171717', trailColor: '#a8a29e' },
                      skins: [{id:'default', name:'Reaper', c:'#171717'}, {id:'blood', name:'Sanglant', c:'#b91c1c', price: 2500}, {id:'toxic', name:'Toxique', c:'#10b981', price: 3500}, {id:'bone', name:'Os', c:'#e5e5e5', price: 4000}, {id:'phantom', name:'FantÃ´me', c:'#8b5cf6', price: 4500}] }, 
            volt: { name: "Volt", rarity: 'epic', icon: "âš¡", hp: 110, dmg: 18, spd: 6.0 * SPEED_FACTOR, rate: Math.ceil(10 * RATE_FACTOR), ammo: 4, reload: Math.ceil(30 * RELOAD_FACTOR), price: PRICE_EPIC, scale:{hp:8, dmg:3}, color: '#facc15', desc: "Tir Ã©lectrique.", gadget: "speed", lore: "Ã‰nergie statique.", passive: "Etourdissement", 
                    proj: { r: 6, speed: Math.ceil(28 * PROJ_SPEED_FACTOR), life: 60, shape: 'laser', color: '#facc15', trailColor: '#fef08a' },
                    skins: [{id:'default', name:'Volt', c:'#facc15'}, {id:'plasma', name:'Plasma', c:'#8b5cf6', price: 2500}, {id:'dark', name:'Sombre', c:'#1e293b', price: 2000}, {id:'neon', name:'NÃ©on', c:'#22d3ee', price: 2800}, {id:'overload', name:'Surcharge', c:'#f87171', price: 3000}] }, 
            // NOUVEAU HÃ‰ROS : Ã‰PIQUE
            hex: { name: "Hex", rarity: 'epic', icon: "ğŸ”®", hp: 130, dmg: 10, spd: 5.5 * SPEED_FACTOR, rate: Math.ceil(25 * RATE_FACTOR), ammo:2, reload:Math.ceil(60 * RELOAD_FACTOR), price: PRICE_EPIC, scale:{hp:10, dmg:1}, color: '#a855f7', type: 'normal', desc: "MalÃ©diction.", gadget: "knockback", lore: "Jette des sorts de ralentissement.", passive: "DÃ©gÃ¢ts DOT",
                   proj: { r: 8, speed: Math.ceil(15 * PROJ_SPEED_FACTOR), life: 90, shape: 'hex', color: '#a855f7', trailColor: '#d8b4fe' },
                   skins: [{id:'default', name:'Hex', c:'#a855f7'}, {id:'crimson', name:'Pourpre', c:'#be185d', price: 2000}, {id:'ombre', name:'Ombre', c:'#0f172a', price: 2500}, {id:'swamp', name:'Marais', c:'#4d7c0f', price: 2800}, {id:'blood', name:'Sang', c:'#991b1b', price: 3200}] },

            ronin: { name: "Ronin", rarity: 'legendary', icon: "ğŸ‘¹", hp: 180, dmg: 60, spd: 6.5 * SPEED_FACTOR, rate: Math.ceil(25 * RATE_FACTOR), ammo:3, reload:Math.ceil(40 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale:{hp:12, dmg:8}, color: '#be185d', type: 'melee', desc: "Katana.", gadget: "heal", lore: "Cherche la rÃ©demption.", passive: "Vol de Vie", 
                     proj: { r: 50, speed: 0, life: 1, shape: 'melee', color: '#be185d', trailColor: '#f0f' },
                     skins: [{id:'default', name:'Ronin', c:'#be185d'}, {id:'ghost', name:'FantÃ´me', c:'#e5e7eb', price: 3500}, {id:'cyber', name:'Cyber', c:'#06b6d4', price: 3000}, {id:'demon', name:'DÃ©mon', c:'#7f1d1d', price: 4000}, {id:'master', name:'MaÃ®tre', c:'#a3e635', price: 4500}] }, 
            samurai: { name: "Samurai", rarity: 'legendary', icon: "âš”ï¸", hp: 250, dmg: 70, spd: 5.5 * SPEED_FACTOR, rate: Math.ceil(30 * RATE_FACTOR), ammo:2, reload:Math.ceil(50 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale:{hp:20, dmg:10}, color: '#1e3a8a', type: 'melee', desc: "Lame lourde.", gadget: "shield", lore: "Le protecteur de l'empereur.", passive: "Parade", 
                       proj: { r: 60, speed: 0, life: 1, shape: 'melee', color: '#1e3a8a', trailColor: '#3b82f6' },
                       skins: [{id:'default', name:'Samurai', c:'#1e3a8a'}, {id:'gold', name:'Samurai Or', c:'#eab308', price: 3500}, {id:'shogun', name:'Shogun', c:'#7f1d1d', price: 4000}, {id:'shadow', name:'Ombre', c:'#0f172a', price: 3800}, {id:'jade', name:'Jade', c:'#10b981', price: 4500}] },
            cyber: { name: "Cyber", rarity: 'legendary', icon: "ğŸ’»", hp: 140, dmg: 35, spd: 5 * SPEED_FACTOR, rate: Math.ceil(20 * RATE_FACTOR), ammo:3, reload:Math.ceil(45 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale:{hp:10, dmg:5}, color: '#06b6d4', type: 'laser', desc: "Laser.", gadget: "teleport", lore: "Fusion homme-machine.", passive: "PrÃ©cision", 
                     proj: { r: 4, speed: 40, life: 80, shape: 'laser', color: '#06b6d4', trailColor: '#67e8f9' },
                     skins: [{id:'default', name:'Cyber', c:'#06b6d4'}, {id:'neon', name:'NÃ©on', c:'#d946ef', price: 4000}, {id:'proto', name:'Proto', c:'#64748b', price: 2000}, {id:'matrix', name:'Matrix', c:'#10b981', price: 3500}, {id:'gold', name:'Or', c:'#fbbf24', price: 4500}] }, 
            pulse: { name: "Pulse", rarity: 'legendary', icon: "ğŸ’ ", hp: 100, dmg: 25, spd: 5.8 * SPEED_FACTOR, rate: Math.ceil(12 * RATE_FACTOR), ammo: 4, reload: Math.ceil(25 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale:{hp:8, dmg:3}, color: '#22d3ee', type: 'laser', desc: "Ondes d'Ã©nergie.", gadget: "stun", lore: "Technicien sonique.", passive: "Aura Dmg", 
                     proj: { r: 8, speed: 35, life: 60, shape: 'laser', color: '#22d3ee', trailColor: '#67e8f9' },
                     skins: [{id:'default', name:'Pulse', c:'#22d3ee'}, {id:'neon', name:'NÃ©on', c:'#f0abfc', price: 2500}, {id:'darkmatter', name:'MatiÃ¨re Noire', c:'#312e81', price: 3500}, {id:'quantum', name:'Quantique', c:'#a855f7', price: 4000}, {id:'sonic', name:'Sonique', c:'#3b82f6', price: 4000}] }, 
            // NOUVEAU HÃ‰ROS : LÃ‰GENDAIRE
            centurion: { name: "Centurion", rarity: 'legendary', icon: "ğŸ›¡ï¸", hp: 400, dmg: 25, spd: 3.2 * SPEED_FACTOR, rate: Math.ceil(30 * RATE_FACTOR), ammo:5, reload:Math.ceil(50 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale:{hp:35, dmg:4}, color: '#78350f', type: 'shotgun', desc: "Lenteur. Bouclier frontal.", gadget: "shield", lore: "Le dernier rempart de l'ancienne garde.", passive: "Blocage",
                       proj: { r: 7, speed: Math.ceil(15 * PROJ_SPEED_FACTOR), life: 60, shape: 'circle', color: '#f59e0b', trailColor: '#78350f' },
                       skins: [{id:'default', name:'Centurion', c:'#78350f'}, {id:'silver', name:'Argent', c:'#e5e7eb', price: 4000}, {id:'gold', name:'Or', c:'#eab308', price: 4500}, {id:'bronze', name:'Bronze', c:'#78350f', price: 3500}, {id:'ghost', name:'Spectre', c:'#9ca3af', price: 5000}] },

            titan: { name: "Titan", rarity: 'mythic', icon: "ğŸ¦¾", hp: 600, dmg: 40, spd: 3.0 * SPEED_FACTOR, rate: Math.ceil(50 * RATE_FACTOR), ammo:2, reload:Math.ceil(70 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale:{hp:50, dmg:5}, color: '#eab308', type: 'melee', desc: "SAISON 1.", gadget: "shield", lore: "Gardien lÃ©gendaire.", passive: "RÃ©sistance", 
                     proj: { r: 60, speed: 0, life: 1, shape: 'melee', color: '#eab308', trailColor: '#fde047' },
                     skins: [{id:'default', name:'Titan', c:'#eab308'}, {id:'prime', name:'Titan Prime', c:'#713f12', price: 9999}, {id:'frozen', name:'GivrÃ©', c:'#0ea5e9', price: 5000}, {id:'dark', name:'Sombre', c:'#0f172a', price: 6000}, {id:'glitch', name:'Bug', c:'#10b981', price: 7000}] }, 
            goliath: { name: "Goliath", rarity: 'mythic', icon: "ğŸ—¿", hp: 450, dmg: 12, spd: 3.0 * SPEED_FACTOR, rate: Math.ceil(40 * RATE_FACTOR), ammo: 2, reload: Math.ceil(60 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale:{hp:40, dmg:2}, color: '#78716c', type: 'shotgun', desc: "Lance des rochers.", gadget: "shield", lore: "GÃ©ant de pierre.", passive: "Ã‰crasement", 
                       proj: { r: 18, speed: 10, life: 120, shape: 'rock', color: '#78716c', trailColor: '#a8a29e' },
                       skins: [{id:'default', name:'Goliath', c:'#78716c'}, {id:'moss', name:'Mousse', c:'#166534', price: 1500}, {id:'obsidian', name:'Obsidienne', c:'#0f172a', price: 3500}, {id:'crystal', name:'Cristal', c:'#67e8f9', price: 4500}, {id:'sand', name:'Sable', c:'#d6d3d1', price: 2500}] }, 
            magma: { name: "Magma", rarity: 'mythic', icon: "ğŸŒ‹", hp: 380, dmg: 60, spd: 3.2 * SPEED_FACTOR, rate: Math.ceil(45 * RATE_FACTOR), ammo: 2, reload: Math.ceil(55 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale:{hp:25, dmg:4}, color: '#7f1d1d', type: 'flame', desc: "SAISON 1.", gadget: "dash", lore: "NÃ© dans un volcan.", passive: "Lave", 
                     proj: { r: 12, speed: 14, life: 40, shape: 'flame', color: '#7f1d1d', trailColor: '#f97316' },
                     skins: [{id:'default', name:'Magma', c:'#7f1d1d'}, {id:'blue', name:'Flamme Bleue', c:'#2563eb', price: 3000}, {id:'obsidian', name:'Obsidienne', c:'#171717', price: 4000}, {id:'core', name:'Noyau', c:'#fcd34d', price: 5000}, {id:'ash', name:'Cendres', c:'#52525b', price: 3500}] }, 
            chrono: { name: "Chrono", rarity: 'mythic', icon: "â³", hp: 100, dmg: 12, spd: 6.5 * SPEED_FACTOR, rate: Math.ceil(4 * RATE_FACTOR), ammo: 30, reload: 15, price: PRICE_MYTHIC, scale:{hp:8, dmg:1}, color: '#0ea5e9', type: 'laser', desc: "MaÃ®tre du temps.", gadget: "teleport", lore: "Vient du futur pour gagner.", passive: "Recharge Rapide", 
                      proj: { r: 5, speed: 32, life: 90, shape: 'laser', color: '#0ea5e9', trailColor: '#7dd3fc' },
                      skins: [{id:'default', name:'Chrono', c:'#0ea5e9'}, {id:'future', name:'Future', c:'#f472b6', price: 5000}, {id:'past', name:'PassÃ©', c:'#78350f', price: 4500}, {id:'void', name:'Vide', c:'#4c1d95', price: 5200}, {id:'matrix', name:'Matrice', c:'#10b981', price: 6000}] },
            // NOUVEAU HÃ‰ROS : MYTHIQUE
            overlord: { name: "Overlord", rarity: 'mythic', icon: "ğŸ‘‘", hp: 550, dmg: 35, spd: 2.8 * SPEED_FACTOR, rate: Math.ceil(45 * RATE_FACTOR), ammo:5, reload:Math.ceil(80 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale:{hp:45, dmg:4}, color: '#ef4444', type: 'shotgun', desc: "Tir en cÃ´ne, trÃ¨s lent.", gadget: "knockback", lore: "Le chef suprÃªme de l'invasion.", passive: "Omni-vision",
                        proj: { r: 15, speed: 15, life: 50, shape: 'circle', color: '#be185d', trailColor: '#fecaca' },
                        skins: [{id:'default', name:'Overlord', c:'#ef4444'}, {id:'dark', name:'Seigneur Noir', c:'#000000', price: 6000}, {id:'gold', name:'Empereur', c:'#facc15', price: 7000}, {id:'ice', name:'Roi Liche', c:'#3b82f6', price: 6500}, {id:'cyber', name:'Cyber Lord', c:'#a855f7', price: 5500}] },

            // --- NOUVEAUX HÃ‰ROS AJOUTÃ‰S (v1.0.1) ---
            archer: { name: "Archer", rarity: 'common', icon: "ğŸ¹", hp: 100, dmg: 25, spd: 6.0 * SPEED_FACTOR, rate: Math.ceil(15 * RATE_FACTOR), ammo:1, reload:Math.ceil(20 * RELOAD_FACTOR), price: PRICE_COMMON, scale:{hp:5, dmg:3}, color: '#166534', type: 'normal', desc: "Tire des flÃ¨ches prÃ©cises.", gadget: "speed", lore: "Chasseur de la forÃªt cybernÃ©tique.", passive: "PrÃ©cision",
                      proj: { r: 3, speed: Math.ceil(35 * PROJ_SPEED_FACTOR), life: 80, shape: 'arrow', color: '#166534', trailColor: '#86efac' },
                      skins: [{id:'default', name:'Archer', c:'#166534'}, {id:'elf', name:'Elfe', c:'#4ade80', price: 1000}, {id:'dark', name:'Sombre', c:'#1e293b', price: 1500}, {id:'fire', name:'Feu', c:'#ef4444', price: 2000}, {id:'ice', name:'Glace', c:'#bae6fd', price: 1800}] },

            brawler: { name: "Brawler", rarity: 'common', icon: "ğŸ¥Š", hp: 160, dmg: 12, spd: 6.5 * SPEED_FACTOR, rate: Math.ceil(6 * RATE_FACTOR), ammo:20, reload:Math.ceil(25 * RELOAD_FACTOR), price: PRICE_COMMON, scale:{hp:12, dmg:1}, color: '#b91c1c', type: 'melee', desc: "Combat au corps Ã  corps.", gadget: "dash", lore: "Champion de boxe clandestin.", passive: "Rage",
                       proj: { r: 15, speed: 0, life: 1, shape: 'melee', color: '#b91c1c', trailColor: '#fca5a5' },
                       skins: [{id:'default', name:'Brawler', c:'#b91c1c'}, {id:'gold', name:'Champion', c:'#eab308', price: 2000}, {id:'street', name:'Rue', c:'#475569', price: 1000}, {id:'lucha', name:'Luchador', c:'#16a34a', price: 1500}, {id:'robot', name:'Cyborg', c:'#64748b', price: 2500}] },

            grenadier: { name: "Grenadier", rarity: 'rare', icon: "ğŸ§¨", hp: 140, dmg: 35, spd: 5.0 * SPEED_FACTOR, rate: Math.ceil(25 * RATE_FACTOR), ammo:3, reload:Math.ceil(45 * RELOAD_FACTOR), price: PRICE_RARE, scale:{hp:10, dmg:4}, color: '#ea580c', type: 'shotgun', desc: "Lance-grenades.", gadget: "knockback", lore: "Expert en dÃ©molition.", passive: "Explosion+",
                         proj: { r: 8, speed: Math.ceil(18 * PROJ_SPEED_FACTOR), life: 50, shape: 'circle', color: '#ea580c', trailColor: '#fdba74' },
                         skins: [{id:'default', name:'Grenadier', c:'#ea580c'}, {id:'military', name:'Militaire', c:'#3f6212', price: 1500}, {id:'party', name:'FÃªte', c:'#db2777', price: 2000}, {id:'toxic', name:'Toxique', c:'#84cc16', price: 1800}, {id:'ice', name:'Givre', c:'#bae6fd', price: 2200}] },
            vortex: { name: "Vortex", rarity: 'epic', icon: "ğŸŒ€", hp: 120, dmg: 15, spd: 5.8 * SPEED_FACTOR, rate: Math.ceil(10 * RATE_FACTOR), ammo:8, reload:Math.ceil(35 * RELOAD_FACTOR), price: PRICE_EPIC, scale:{hp:8, dmg:2}, color: '#7c3aed', type: 'normal', desc: "Tirs gravitationnels.", gadget: "teleport", lore: "Manipule l'espace-temps.", passive: "Ralentissement",
                      proj: { r: 6, speed: Math.ceil(22 * PROJ_SPEED_FACTOR), life: 60, shape: 'circle', color: '#7c3aed', trailColor: '#c4b5fd' },
                      skins: [{id:'default', name:'Vortex', c:'#7c3aed'}, {id:'galaxy', name:'Galaxie', c:'#1e1b4b', price: 3000}, {id:'blackhole', name:'Trou Noir', c:'#000000', price: 3500}, {id:'sun', name:'Solaire', c:'#facc15', price: 2500}, {id:'nebula', name:'NÃ©buleuse', c:'#ec4899', price: 3200}] },

            nova: { name: "Nova", rarity: 'legendary', icon: "ğŸŒŸ", hp: 130, dmg: 28, spd: 6.2 * SPEED_FACTOR, rate: Math.ceil(15 * RATE_FACTOR), ammo:5, reload:Math.ceil(30 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale:{hp:10, dmg:3}, color: '#fef08a', type: 'laser', desc: "Ã‰nergie stellaire.", gadget: "stun", lore: "Une Ã©toile vivante.", passive: "Ã‰blouissement",
                    proj: { r: 5, speed: Math.ceil(30 * PROJ_SPEED_FACTOR), life: 70, shape: 'star', color: '#fef08a', trailColor: '#facc15' },
                    skins: [{id:'default', name:'Nova', c:'#fef08a'}, {id:'supernova', name:'Supernova', c:'#f97316', price: 4000}, {id:'dwarf', name:'Naine Blanche', c:'#e2e8f0', price: 3500}, {id:'neutron', name:'Neutron', c:'#8b5cf6', price: 4500}, {id:'pulsar', name:'Pulsar', c:'#3b82f6', price: 4200}] },

            // NOUVEAUX HÃ‰ROS v1.0.3
            rock: { name: "Rock", rarity: 'common', icon: "ğŸª¨", hp: 150, dmg: 20, spd: 5.0 * SPEED_FACTOR, rate: Math.ceil(20 * RATE_FACTOR), ammo: 3, reload: Math.ceil(40 * RELOAD_FACTOR), price: PRICE_COMMON, scale: {hp: 12, dmg: 2}, color: '#78716c', type: 'shotgun', desc: "Lance des pierres.", gadget: "shield", lore: "Un golem de pierre.", passive: "RÃ©sistance", proj: { r: 6, speed: Math.ceil(15 * PROJ_SPEED_FACTOR), life: 50, shape: 'rock', color: '#78716c', trailColor: '#a8a29e' }, skins: [{id:'default', name:'Rock', c:'#78716c'}, {id:'moss', name:'Mousse', c:'#65a30d', price: 1000}, {id:'magma', name:'Magma', c:'#ef4444', price: 1500}, {id:'gold', name:'PÃ©pite', c:'#fbbf24', price: 2000}, {id:'ice', name:'Givre', c:'#bae6fd', price: 1800}] },
            frost: { name: "Frost", rarity: 'rare', icon: "â„ï¸", hp: 120, dmg: 15, spd: 5.5 * SPEED_FACTOR, rate: Math.ceil(15 * RATE_FACTOR), ammo: 5, reload: Math.ceil(35 * RELOAD_FACTOR), price: PRICE_RARE, scale: {hp: 8, dmg: 2}, color: '#0ea5e9', type: 'normal', desc: "GÃ¨le les ennemis.", gadget: "stun", lore: "Venu du grand nord.", passive: "Ralentissement", proj: { r: 5, speed: Math.ceil(22 * PROJ_SPEED_FACTOR), life: 60, shape: 'circle', color: '#0ea5e9', trailColor: '#7dd3fc' }, skins: [{id:'default', name:'Frost', c:'#0ea5e9'}, {id:'dark', name:'Sombre', c:'#1e3a8a', price: 1500}, {id:'polar', name:'Polaire', c:'#f0f9ff', price: 2000}, {id:'yeti', name:'YÃ©ti', c:'#e2e8f0', price: 2500}, {id:'fire', name:'Fondu', c:'#fdba74', price: 2000}] },
            blaze: { name: "Blaze", rarity: 'epic', icon: "ğŸ”¥", hp: 110, dmg: 8, spd: 6.0 * SPEED_FACTOR, rate: Math.ceil(5 * RATE_FACTOR), ammo: 30, reload: Math.ceil(20 * RELOAD_FACTOR), price: PRICE_EPIC, scale: {hp: 8, dmg: 1}, color: '#f97316', type: 'flame', desc: "Lance-flammes.", gadget: "dash", lore: "Pyromane expert.", passive: "BrÃ»lure", proj: { r: 8, speed: Math.ceil(12 * PROJ_SPEED_FACTOR), life: 40, shape: 'flame', color: '#f97316', trailColor: '#fdba74' }, skins: [{id:'default', name:'Blaze', c:'#f97316'}, {id:'blueflame', name:'Flamme Bleue', c:'#3b82f6', price: 2500}, {id:'shadow', name:'Ombre', c:'#171717', price: 3000}, {id:'toxic', name:'Toxique', c:'#16a34a', price: 2800}, {id:'white', name:'Pur', c:'#ffffff', price: 3500}] },
            storm: { name: "Storm", rarity: 'legendary', icon: "â›ˆï¸", hp: 100, dmg: 25, spd: 6.5 * SPEED_FACTOR, rate: Math.ceil(12 * RATE_FACTOR), ammo: 4, reload: Math.ceil(30 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale: {hp: 6, dmg: 3}, color: '#6366f1', type: 'laser', desc: "Foudre en chaÃ®ne.", gadget: "teleport", lore: "MaÃ®tre des orages.", passive: "Choc", proj: { r: 4, speed: Math.ceil(35 * PROJ_SPEED_FACTOR), life: 80, shape: 'laser', color: '#6366f1', trailColor: '#818cf8' }, skins: [{id:'default', name:'Storm', c:'#6366f1'}, {id:'red', name:'Rouge', c:'#ef4444', price: 3500}, {id:'zeus', name:'Divin', c:'#facc15', price: 4500}, {id:'dark', name:'Sombre', c:'#312e81', price: 4000}, {id:'neon', name:'NÃ©on', c:'#d946ef', price: 5000}] },
            glitch: { name: "Glitch", rarity: 'mythic', icon: "ğŸ‘¾", hp: 90, dmg: 40, spd: 7.0 * SPEED_FACTOR, rate: Math.ceil(10 * RATE_FACTOR), ammo: 3, reload: Math.ceil(25 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale: {hp: 5, dmg: 5}, color: '#10b981', type: 'normal', desc: "Bug du systÃ¨me.", gadget: "teleport", lore: "Une anomalie dans le code.", passive: "Esquive", proj: { r: 6, speed: Math.ceil(30 * PROJ_SPEED_FACTOR), life: 70, shape: 'square', color: '#10b981', trailColor: '#34d399' }, skins: [{id:'default', name:'Glitch', c:'#10b981'}, {id:'error', name:'Erreur', c:'#dc2626', price: 5000}, {id:'matrix', name:'Matrice', c:'#22c55e', price: 6000}, {id:'void', name:'Vide', c:'#000000', price: 5500}, {id:'rgb', name:'RGB', c:'#facc15', price: 6500}] },
            
            // NOUVEAUX HÃ‰ROS v1.0.4
            grunt: { name: "Grunt", rarity: 'common', icon: "ğŸª–", hp: 160, dmg: 18, spd: 5.5 * SPEED_FACTOR, rate: Math.ceil(10 * RATE_FACTOR), ammo: 10, reload: Math.ceil(30 * RELOAD_FACTOR), price: PRICE_COMMON, scale: {hp: 10, dmg: 2}, color: '#57534e', type: 'normal', desc: "Soldat lourd.", gadget: "knockback", lore: "L'infanterie de base.", passive: "Gilet Pare-balles", proj: { r: 5, speed: Math.ceil(25 * PROJ_SPEED_FACTOR), life: 60, shape: 'circle', color: '#57534e', trailColor: '#a8a29e' }, skins: [{id:'default', name:'Grunt', c:'#57534e'}, {id:'sand', name:'Sable', c:'#d6d3d1', price: 1000}, {id:'jungle', name:'Jungle', c:'#166534', price: 1500}, {id:'urban', name:'Urbain', c:'#94a3b8', price: 2000}, {id:'elite', name:'Elite', c:'#1e293b', price: 2500}] },
            raptor: { name: "Raptor", rarity: 'rare', icon: "ğŸ¦–", hp: 140, dmg: 25, spd: 7.0 * SPEED_FACTOR, rate: Math.ceil(8 * RATE_FACTOR), ammo: 5, reload: Math.ceil(25 * RELOAD_FACTOR), price: PRICE_RARE, scale: {hp: 8, dmg: 2}, color: '#65a30d', type: 'melee', desc: "PrÃ©dateur rapide.", gadget: "dash", lore: "Une expÃ©rience gÃ©nÃ©tique Ã©chappÃ©e.", passive: "Saignement", proj: { r: 15, speed: 0, life: 1, shape: 'melee', color: '#65a30d', trailColor: '#bef264' }, skins: [{id:'default', name:'Raptor', c:'#65a30d'}, {id:'blue', name:'Alpha', c:'#2563eb', price: 2000}, {id:'red', name:'FÃ©roce', c:'#dc2626', price: 1500}, {id:'albino', name:'Albinos', c:'#f1f5f9', price: 2500}, {id:'gold', name:'DorÃ©', c:'#fbbf24', price: 3000}] },
            orbit: { name: "Orbit", rarity: 'epic', icon: "ğŸª", hp: 150, dmg: 12, spd: 5.2 * SPEED_FACTOR, rate: Math.ceil(15 * RATE_FACTOR), ammo: 6, reload: Math.ceil(30 * RELOAD_FACTOR), price: PRICE_EPIC, scale: {hp: 12, dmg: 2}, color: '#ec4899', type: 'normal', desc: "Tirs orbitaux.", gadget: "shield", lore: "ContrÃ´le des satellites tueurs.", passive: "Satellite", proj: { r: 6, speed: Math.ceil(20 * PROJ_SPEED_FACTOR), life: 70, shape: 'circle', color: '#ec4899', trailColor: '#fbcfe8' }, skins: [{id:'default', name:'Orbit', c:'#ec4899'}, {id:'space', name:'Espace', c:'#1e3a8a', price: 2500}, {id:'sun', name:'Solaire', c:'#ea580c', price: 3000}, {id:'moon', name:'Lunaire', c:'#94a3b8', price: 2800}, {id:'cyber', name:'Cyber', c:'#06b6d4', price: 3500}] },
            solar: { name: "Solar", rarity: 'legendary', icon: "â˜€ï¸", hp: 160, dmg: 40, spd: 5.5 * SPEED_FACTOR, rate: Math.ceil(25 * RATE_FACTOR), ammo: 3, reload: Math.ceil(40 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale: {hp: 15, dmg: 4}, color: '#f59e0b', type: 'shotgun', desc: "Ã‰ruptions solaires.", gadget: "stun", lore: "Puissance d'une Ã©toile.", passive: "Radiance", proj: { r: 10, speed: Math.ceil(18 * PROJ_SPEED_FACTOR), life: 60, shape: 'star', color: '#f59e0b', trailColor: '#fde047' }, skins: [{id:'default', name:'Solar', c:'#f59e0b'}, {id:'eclipse', name:'Ã‰clipse', c:'#1f2937', price: 4000}, {id:'blue', name:'GÃ©ante Bleue', c:'#3b82f6', price: 4500}, {id:'red', name:'GÃ©ante Rouge', c:'#ef4444', price: 5000}, {id:'white', name:'Naine Blanche', c:'#f8fafc', price: 5500}] },
            spectre: { name: "Spectre", rarity: 'mythic', icon: "ğŸ‘»", hp: 100, dmg: 55, spd: 6.8 * SPEED_FACTOR, rate: Math.ceil(15 * RATE_FACTOR), ammo: 2, reload: Math.ceil(35 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale: {hp: 5, dmg: 6}, color: '#64748b', type: 'normal', desc: "Tueur fantÃ´me.", gadget: "invis", lore: "On ne le voit que trop tard.", passive: "Esquive", proj: { r: 6, speed: Math.ceil(35 * PROJ_SPEED_FACTOR), life: 60, shape: 'circle', color: '#64748b', trailColor: '#f1f5f9' }, skins: [{id:'default', name:'Spectre', c:'#64748b'}, {id:'demon', name:'DÃ©mon', c:'#b91c1c', price: 5500}, {id:'void', name:'NÃ©ant', c:'#000000', price: 6000}, {id:'angel', name:'Ange', c:'#fef08a', price: 7000}, {id:'pixel', name:'Pixel', c:'#22c55e', price: 6500}] },
            
            // NOUVEUX HÃ‰ROS v1.1.0 (FINAL)
            spike: { name: "Spike", rarity: 'common', icon: "ğŸŒµ", hp: 170, dmg: 25, spd: 5.5 * SPEED_FACTOR, rate: Math.ceil(18 * RATE_FACTOR), ammo: 3, reload: Math.ceil(35 * RELOAD_FACTOR), price: PRICE_COMMON, scale: {hp: 12, dmg: 3}, color: '#166534', type: 'shotgun', desc: "Explosion d'Ã©pines.", gadget: "knockback", lore: "La nature se dÃ©fend.", passive: "DÃ©gÃ¢ts Zone", proj: { r: 5, speed: Math.ceil(20 * PROJ_SPEED_FACTOR), life: 50, shape: 'star', color: '#166534', trailColor: '#86efac' }, skins: [{id:'default', name:'Spike', c:'#166534'}, {id:'sakura', name:'Sakura', c:'#f9a8d4', price: 1500}, {id:'dark', name:'Sombre', c:'#0f172a', price: 1000}, {id:'desert', name:'DÃ©sert', c:'#d97706', price: 2000}, {id:'mushroom', name:'Champignon', c:'#b91c1c', price: 2500}] },
            tesla: { name: "Tesla", rarity: 'rare', icon: "ğŸ”‹", hp: 130, dmg: 14, spd: 6.0 * SPEED_FACTOR, rate: Math.ceil(8 * RATE_FACTOR), ammo: 15, reload: Math.ceil(30 * RELOAD_FACTOR), price: PRICE_RARE, scale: {hp: 8, dmg: 2}, color: '#0ea5e9', type: 'laser', desc: "Tir Ã©lectrique continu.", gadget: "stun", lore: "Inventeur fou.", passive: "Recharge Rapide", proj: { r: 4, speed: Math.ceil(30 * PROJ_SPEED_FACTOR), life: 60, shape: 'laser', color: '#0ea5e9', trailColor: '#bae6fd' }, skins: [{id:'default', name:'Tesla', c:'#0ea5e9'}, {id:'gold', name:'Or', c:'#eab308', price: 2000}, {id:'coil', name:'Bobine', c:'#b91c1c', price: 1500}, {id:'plasma', name:'Plasma', c:'#a855f7', price: 2500}, {id:'steampunk', name:'Vapeur', c:'#78350f', price: 3000}] },
            siren: { name: "Siren", rarity: 'epic', icon: "ğŸ¤", hp: 120, dmg: 20, spd: 6.0 * SPEED_FACTOR, rate: Math.ceil(12 * RATE_FACTOR), ammo: 5, reload: Math.ceil(25 * RELOAD_FACTOR), price: PRICE_EPIC, scale: {hp: 8, dmg: 3}, color: '#ec4899', type: 'normal', desc: "Ondes sonores.", gadget: "knockback", lore: "Sa voix est une arme.", passive: "PrÃ©cision", proj: { r: 10, speed: Math.ceil(20 * PROJ_SPEED_FACTOR), life: 70, shape: 'circle', color: '#ec4899', trailColor: '#fbcfe8' }, skins: [{id:'default', name:'Siren', c:'#ec4899'}, {id:'pop', name:'Popstar', c:'#f472b6', price: 2500}, {id:'rock', name:'Rockstar', c:'#111827', price: 3000}, {id:'opera', name:'OpÃ©ra', c:'#fbbf24', price: 3500}, {id:'techno', name:'Techno', c:'#0ea5e9', price: 4000}] },
            paladin: { name: "Paladin", rarity: 'legendary', icon: "ğŸ”¨", hp: 300, dmg: 45, spd: 4.5 * SPEED_FACTOR, rate: Math.ceil(35 * RATE_FACTOR), ammo: 3, reload: Math.ceil(50 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale: {hp: 30, dmg: 5}, color: '#facc15', type: 'melee', desc: "Marteau sacrÃ©.", gadget: "heal", lore: "DÃ©fenseur de la lumiÃ¨re.", passive: "Regen Rapide", proj: { r: 40, speed: 0, life: 1, shape: 'melee', color: '#facc15', trailColor: '#fef9c3' }, skins: [{id:'default', name:'Paladin', c:'#facc15'}, {id:'fallen', name:'DÃ©chu', c:'#7f1d1d', price: 4500}, {id:'ice', name:'Givre', c:'#e0f2fe', price: 4000}, {id:'jade', name:'Jade', c:'#10b981', price: 5000}, {id:'royal', name:'Royal', c:'#4c1d95', price: 5500}] },
            zenith: { name: "Zenith", rarity: 'mythic', icon: "ğŸŒŒ", hp: 200, dmg: 80, spd: 7.5 * SPEED_FACTOR, rate: Math.ceil(20 * RATE_FACTOR), ammo: 2, reload: Math.ceil(40 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale: {hp: 15, dmg: 10}, color: '#4c1d95', type: 'sniper', desc: "Rayon cosmique.", gadget: "teleport", lore: "Au-delÃ  de l'univers.", passive: "PrÃ©cision", proj: { r: 8, speed: Math.ceil(40 * PROJ_SPEED_FACTOR), life: 100, shape: 'star', color: '#4c1d95', trailColor: '#a78bfa' }, skins: [{id:'default', name:'Zenith', c:'#4c1d95'}, {id:'infinity', name:'Infini', c:'#000000', price: 6000}, {id:'light', name:'LumiÃ¨re', c:'#ffffff', price: 5500}, {id:'nebula', name:'NÃ©buleuse', c:'#d946ef', price: 6500}, {id:'antimatter', name:'AntimatiÃ¨re', c:'#ef4444', price: 7000}] },
            
            // NOUVEAUX HÃ‰ROS v1.1.3
            cyclops: { name: "Cyclops", rarity: 'common', icon: "ğŸ‘ï¸", hp: 180, dmg: 40, spd: 4.5 * SPEED_FACTOR, rate: Math.ceil(30 * RATE_FACTOR), ammo: 2, reload: Math.ceil(45 * RELOAD_FACTOR), price: PRICE_COMMON, scale: {hp: 15, dmg: 4}, color: '#991b1b', type: 'laser', desc: "Tir laser unique puissant.", gadget: "shield", lore: "Un regard qui tue.", passive: "Vision", proj: { r: 6, speed: Math.ceil(35 * PROJ_SPEED_FACTOR), life: 60, shape: 'laser', color: '#991b1b', trailColor: '#ef4444' }, skins: [{id:'default', name:'Cyclops', c:'#991b1b'}, {id:'robot', name:'Cyborg', c:'#94a3b8', price: 1000}, {id:'alien', name:'Alien', c:'#22c55e', price: 1500}, {id:'mutant', name:'Mutant', c:'#a3e635', price: 2000}, {id:'demon', name:'DÃ©mon', c:'#7f1d1d', price: 2500}] },
            banshee: { name: "Banshee", rarity: 'rare', icon: "ğŸ§œâ€â™€ï¸", hp: 110, dmg: 18, spd: 6.5 * SPEED_FACTOR, rate: Math.ceil(15 * RATE_FACTOR), ammo: 8, reload: Math.ceil(30 * RELOAD_FACTOR), price: PRICE_RARE, scale: {hp: 8, dmg: 2}, color: '#8b5cf6', type: 'normal', desc: "Onde de choc sonique.", gadget: "stun", lore: "Son cri glace le sang.", passive: "Peur", proj: { r: 12, speed: Math.ceil(20 * PROJ_SPEED_FACTOR), life: 50, shape: 'circle', color: '#8b5cf6', trailColor: '#ddd6fe' }, skins: [{id:'default', name:'Banshee', c:'#8b5cf6'}, {id:'ghost', name:'Spectre', c:'#f3f4f6', price: 1500}, {id:'dark', name:'TÃ©nÃ¨bres', c:'#111827', price: 2000}, {id:'sea', name:'Marine', c:'#0ea5e9', price: 2500}, {id:'forest', name:'ForÃªt', c:'#166534', price: 1800}] },
            druid: { name: "Druid", rarity: 'epic', icon: "ğŸ¦Œ", hp: 150, dmg: 22, spd: 5.5 * SPEED_FACTOR, rate: Math.ceil(20 * RATE_FACTOR), ammo: 5, reload: Math.ceil(35 * RELOAD_FACTOR), price: PRICE_EPIC, scale: {hp: 12, dmg: 3}, color: '#15803d', type: 'normal', desc: "Magie de la nature.", gadget: "heal", lore: "Gardien de la forÃªt ancienne.", passive: "Racines", proj: { r: 8, speed: Math.ceil(22 * PROJ_SPEED_FACTOR), life: 70, shape: 'star', color: '#15803d', trailColor: '#86efac' }, skins: [{id:'default', name:'Druid', c:'#15803d'}, {id:'autumn', name:'Automne', c:'#d97706', price: 2500}, {id:'winter', name:'Hiver', c:'#e0f2fe', price: 3000}, {id:'spring', name:'Printemps', c:'#86efac', price: 2000}, {id:'corrupted', name:'Corrompu', c:'#4c1d95', price: 3500}] },
            spartan: { name: "Spartan", rarity: 'legendary', icon: "ğŸ›¡ï¸", hp: 350, dmg: 30, spd: 4.0 * SPEED_FACTOR, rate: Math.ceil(25 * RATE_FACTOR), ammo: 4, reload: Math.ceil(40 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale: {hp: 30, dmg: 4}, color: '#b91c1c', type: 'melee', desc: "Coup de bouclier.", gadget: "knockback", lore: "CECI EST SPARTE !", passive: "Blocage", proj: { r: 35, speed: 0, life: 1, shape: 'melee', color: '#b91c1c', trailColor: '#fca5a5' }, skins: [{id:'default', name:'Spartan', c:'#b91c1c'}, {id:'gold', name:'Divin', c:'#facc15', price: 4500}, {id:'shadow', name:'Ombre', c:'#1f2937', price: 4000}, {id:'leonidas', name:'Leonidas', c:'#7f1d1d', price: 5000}, {id:'stone', name:'Pierre', c:'#78716c', price: 3500}] },
            hydra: { name: "Hydra", rarity: 'mythic', icon: "ğŸ‰", hp: 300, dmg: 25, spd: 5.0 * SPEED_FACTOR, rate: Math.ceil(30 * RATE_FACTOR), ammo: 3, reload: Math.ceil(50 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale: {hp: 25, dmg: 5}, color: '#047857', type: 'shotgun', desc: "Tir triple tÃªtes.", gadget: "speed", lore: "Coupez une tÃªte, deux repoussent.", passive: "Regen", proj: { r: 8, speed: Math.ceil(25 * PROJ_SPEED_FACTOR), life: 60, shape: 'snake', color: '#047857', trailColor: '#34d399' }, skins: [{id:'default', name:'Hydra', c:'#047857'}, {id:'fire', name:'Feu', c:'#ef4444', price: 5500}, {id:'void', name:'Abysses', c:'#312e81', price: 6000}, {id:'ice', name:'Glace', c:'#bae6fd', price: 5000}, {id:'gold', name:'Hydre d\'Or', c:'#eab308', price: 7000}] },

            // NOUVEAUX HÃ‰ROS v1.2.0 (Part 1)
            vulcan: { name: "Vulcan", rarity: 'common', icon: "âš’ï¸", hp: 200, dmg: 15, spd: 4.5 * SPEED_FACTOR, rate: Math.ceil(5 * RATE_FACTOR), ammo: 40, reload: Math.ceil(20 * RELOAD_FACTOR), price: PRICE_COMMON, scale: {hp: 15, dmg: 1}, color: '#c2410c', type: 'flame', desc: "Forge vivante.", gadget: "shield", lore: "Il forge ses armes au combat.", passive: "BrÃ»lure", proj: { r: 6, speed: Math.ceil(15 * PROJ_SPEED_FACTOR), life: 40, shape: 'flame', color: '#c2410c', trailColor: '#fb923c' }, skins: [{id:'default', name:'Vulcan', c:'#c2410c'}, {id:'steel', name:'Acier', c:'#94a3b8', price: 1000}, {id:'gold', name:'Or', c:'#facc15', price: 1500}, {id:'lava', name:'Lave', c:'#ef4444', price: 2000}, {id:'coal', name:'Charbon', c:'#171717', price: 2500}] },
            zephyr: { name: "Zephyr", rarity: 'rare', icon: "ğŸƒ", hp: 100, dmg: 18, spd: 7.2 * SPEED_FACTOR, rate: Math.ceil(12 * RATE_FACTOR), ammo: 6, reload: Math.ceil(25 * RELOAD_FACTOR), price: PRICE_RARE, scale: {hp: 6, dmg: 2}, color: '#6ee7b7', type: 'normal', desc: "MaÃ®tre des vents.", gadget: "speed", lore: "Insaisissable comme la brise.", passive: "Esquive", proj: { r: 5, speed: Math.ceil(30 * PROJ_SPEED_FACTOR), life: 70, shape: 'circle', color: '#6ee7b7', trailColor: '#d1fae5' }, skins: [{id:'default', name:'Zephyr', c:'#6ee7b7'}, {id:'cloud', name:'Nuage', c:'#e0f2fe', price: 1500}, {id:'storm', name:'TempÃªte', c:'#6366f1', price: 2000}, {id:'autumn', name:'Automne', c:'#fb923c', price: 1800}, {id:'night', name:'Brise Nocturne', c:'#1e1b4b', price: 2500}] },
            necro: { name: "Necro", rarity: 'epic', icon: "ğŸ’€", hp: 130, dmg: 25, spd: 5.5 * SPEED_FACTOR, rate: Math.ceil(20 * RATE_FACTOR), ammo: 4, reload: Math.ceil(35 * RELOAD_FACTOR), price: PRICE_EPIC, scale: {hp: 10, dmg: 3}, color: '#4c1d95', type: 'normal', desc: "Magie noire.", gadget: "invis", lore: "Commande aux esprits.", passive: "Vol de Vie", proj: { r: 8, speed: Math.ceil(18 * PROJ_SPEED_FACTOR), life: 60, shape: 'skull', color: '#4c1d95', trailColor: '#a78bfa' }, skins: [{id:'default', name:'Necro', c:'#4c1d95'}, {id:'green', name:'Peste', c:'#166534', price: 2500}, {id:'red', name:'Sang', c:'#991b1b', price: 3000}, {id:'white', name:'FantÃ´me', c:'#f8fafc', price: 3500}, {id:'gold', name:'Liche', c:'#facc15', price: 4000}] },
            gladiator: { name: "Gladiator", rarity: 'legendary', icon: "âš”ï¸", hp: 280, dmg: 50, spd: 5.0 * SPEED_FACTOR, rate: Math.ceil(25 * RATE_FACTOR), ammo: 3, reload: Math.ceil(40 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale: {hp: 25, dmg: 5}, color: '#b45309', type: 'melee', desc: "Champion de l'arÃ¨ne.", gadget: "shield", lore: "N'a jamais connu la dÃ©faite.", passive: "Rage", proj: { r: 30, speed: 0, life: 1, shape: 'melee', color: '#b45309', trailColor: '#fcba03' }, skins: [{id:'default', name:'Gladiator', c:'#b45309'}, {id:'iron', name:'Fer', c:'#64748b', price: 4000}, {id:'gold', name:'Champion Or', c:'#facc15', price: 5000}, {id:'tiger', name:'Tigre', c:'#f97316', price: 4500}, {id:'shadow', name:'Murmillo', c:'#171717', price: 5500}] },
            bouncer: { name: "Bouncer", rarity: 'mythic', icon: "ğŸ", hp: 220, dmg: 30, spd: 5.5 * SPEED_FACTOR, rate: Math.ceil(20 * RATE_FACTOR), ammo: 4, reload: Math.ceil(35 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale: {hp: 15, dmg: 4}, color: '#ec4899', type: 'shotgun', desc: "Projectiles rebondissants.", gadget: "knockback", lore: "Tout rebondit sur lui.", passive: "Rebond", proj: { r: 10, speed: Math.ceil(20 * PROJ_SPEED_FACTOR), life: 80, shape: 'circle', color: '#ec4899', trailColor: '#fbcfe8' }, skins: [{id:'default', name:'Bouncer', c:'#ec4899'}, {id:'slime', name:'Slime', c:'#84cc16', price: 5500}, {id:'rubber', name:'Gomme', c:'#f472b6', price: 6000}, {id:'space', name:'Anti-GravitÃ©', c:'#6366f1', price: 6500}, {id:'bubble', name:'Bulle', c:'#0ea5e9', price: 7000}] },

            // NOUVEAUX HÃ‰ROS v1.2.0 (Part 2)
            fungus: { name: "Fungus", rarity: 'common', icon: "ğŸ„", hp: 160, dmg: 12, spd: 5.0 * SPEED_FACTOR, rate: Math.ceil(15 * RATE_FACTOR), ammo: 10, reload: Math.ceil(30 * RELOAD_FACTOR), price: PRICE_COMMON, scale: {hp: 12, dmg: 2}, color: '#a21caf', type: 'normal', desc: "Spores toxiques.", gadget: "heal", lore: "Un champignon mutant.", passive: "Poison", proj: { r: 6, speed: Math.ceil(18 * PROJ_SPEED_FACTOR), life: 50, shape: 'circle', color: '#a21caf', trailColor: '#f0abfc' }, skins: [{id:'default', name:'Fungus', c:'#a21caf'}, {id:'amanita', name:'Amanite', c:'#dc2626', price: 1000}, {id:'blue', name:'Bleu', c:'#3b82f6', price: 1500}, {id:'glow', name:'Radioactif', c:'#bef264', price: 2000}, {id:'dark', name:'Moisissure', c:'#3f3f46', price: 1800}] },
            wasp: { name: "Wasp", rarity: 'rare', icon: "ğŸ", hp: 80, dmg: 20, spd: 7.5 * SPEED_FACTOR, rate: Math.ceil(8 * RATE_FACTOR), ammo: 12, reload: Math.ceil(25 * RELOAD_FACTOR), price: PRICE_RARE, scale: {hp: 5, dmg: 3}, color: '#facc15', type: 'normal', desc: "Rapide et piquant.", gadget: "speed", lore: "Attaque en essaim.", passive: "Saignement", proj: { r: 3, speed: Math.ceil(32 * PROJ_SPEED_FACTOR), life: 60, shape: 'arrow', color: '#facc15', trailColor: '#fef08a' }, skins: [{id:'default', name:'Wasp', c:'#facc15'}, {id:'hornet', name:'Frelon', c:'#b45309', price: 1500}, {id:'mech', name:'MÃ©ca', c:'#94a3b8', price: 2000}, {id:'killer', name:'Tueur', c:'#171717', price: 2500}, {id:'queen', name:'Reine', c:'#ef4444', price: 3000}] },
            mirage: { name: "Mirage", rarity: 'epic', icon: "ğŸ­", hp: 110, dmg: 22, spd: 6.0 * SPEED_FACTOR, rate: Math.ceil(15 * RATE_FACTOR), ammo: 5, reload: Math.ceil(30 * RELOAD_FACTOR), price: PRICE_EPIC, scale: {hp: 8, dmg: 3}, color: '#14b8a6', type: 'normal', desc: "Trompe l'ennemi.", gadget: "invis", lore: "Maintenant tu me vois...", passive: "Esquive", proj: { r: 6, speed: Math.ceil(25 * PROJ_SPEED_FACTOR), life: 70, shape: 'star', color: '#14b8a6', trailColor: '#99f6e4' }, skins: [{id:'default', name:'Mirage', c:'#14b8a6'}, {id:'sand', name:'Illusion', c:'#d6d3d1', price: 2500}, {id:'neon', name:'Hologramme', c:'#dd88e1', price: 3000}, {id:'crimson', name:'Masque Rouge', c:'#be185d', price: 3500}, {id:'shadow', name:'Ombre', c:'#1e293b', price: 4000}] },
            juggernaut: { name: "Juggernaut", rarity: 'legendary', icon: "ğŸš†", hp: 500, dmg: 20, spd: 2.5 * SPEED_FACTOR, rate: Math.ceil(10 * RATE_FACTOR), ammo: 20, reload: Math.ceil(60 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale: {hp: 40, dmg: 2}, color: '#1e293b', type: 'shotgun', desc: "Un tank inarrÃªtable.", gadget: "shield", lore: "Rien ne l'arrÃªte.", passive: "Blocage", proj: { r: 8, speed: Math.ceil(18 * PROJ_SPEED_FACTOR), life: 50, shape: 'square', color: '#1e293b', trailColor: '#64748b' }, skins: [{id:'default', name:'Juggernaut', c:'#1e293b'}, {id:'rust', name:'Rouille', c:'#78350f', price: 4000}, {id:'camo', name:'Militaire', c:'#3f6212', price: 4500}, {id:'police', name:'Anti-Ã‰meute', c:'#1d4ed8', price: 5000}, {id:'cyber', name:'Cyber Tank', c:'#ef4444', price: 5500}] },
            eclipse: { name: "Eclipse", rarity: 'mythic', icon: "ğŸŒ‘", hp: 200, dmg: 45, spd: 5.5 * SPEED_FACTOR, rate: Math.ceil(25 * RATE_FACTOR), ammo: 3, reload: Math.ceil(45 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale: {hp: 15, dmg: 6}, color: '#171717', type: 'normal', desc: "TÃ©nÃ¨bres pures.", gadget: "teleport", lore: "Il a Ã©teint le soleil.", passive: "Aveuglement", proj: { r: 10, speed: Math.ceil(28 * PROJ_SPEED_FACTOR), life: 80, shape: 'circle', color: '#000000', trailColor: '#1e1b4b' }, skins: [{id:'default', name:'Eclipse', c:'#171717'}, {id:'blood', name:'Lune de Sang', c:'#991b1b', price: 6000}, {id:'solar', name:'Ã‰clipse Totale', c:'#f59e0b', price: 7000}, {id:'void', name:'NÃ©ant', c:'#4c1d95', price: 6500}, {id:'white', name:'Inversion', c:'#ffffff', price: 8000}] },
        };
        
        // Fonction pour trier les hÃ©ros par raretÃ©
        const sortStartersByRarity = () => {
            const order = ['common', 'rare', 'epic', 'legendary', 'mythic'];
            const sortedKeys = Object.keys(STARTERS).sort((a, b) => {
                const rarityA = STARTERS[a].rarity;
                const rarityB = STARTERS[b].rarity;
                return order.indexOf(rarityA) - order.indexOf(rarityB);
            });
            const sortedStarters = {};
            sortedKeys.forEach(key => {
                sortedStarters[key] = STARTERS[key];
            });
            return sortedStarters;
        };

        const MODES = { 
            survival: { name: "Survie", icon: "ğŸ§Ÿ", desc: "Vagues infinies.", ranked: false }, 
            ranked: { name: "ClassÃ©", icon: "ğŸ†", desc: "CompÃ©tition.", ranked: true }, 
            duel: { name: "1v1 Duel", icon: "âš”ï¸", desc: "Duel Bot IA.", ranked: false, boss: true }, 
            heist: { name: "Braquage", icon: "ğŸ’", desc: "DÃ©truis le coffre!", ranked: false, boss: true }, 
            boss_rush: { name: "Boss Rush", icon: "ğŸ‘¹", desc: "Combat de Boss.", ranked: false, boss: true }, 
            defense: { name: "DÃ©fense", icon: "ğŸ›¡ï¸", desc: "ProtÃ¨ge le cristal.", ranked: false, boss: true }, 
            infection: { name: "Infection", icon: "â˜£ï¸", desc: "Survivre Ã  la horde.", ranked: false }, 
            train_defense: { name: "Train Express", icon: "ğŸš‚", desc: "ProtÃ¨ge le train !", ranked: false }, 
            thief: { name: "Voleur", icon: "ğŸ’°", desc: "Vole 10 sacs !", ranked: false },
            cyber_hack: { name: "Cyber Hack", icon: "ğŸ’»", desc: "Pirate les zones !", ranked: false, special: true },
            gungame: { name: "Jeu d'Armes", icon: "ğŸ”«", desc: "Change d'arme Ã  chaque kill !", ranked: false, special: false },
            escape: { name: "Cyber Escape", icon: "ğŸ›¸", desc: "Rejoins l'extraction !", ranked: false, special: false },
            rampage: { name: "Carnage", icon: "ğŸ˜¡", desc: "Tuer 50 ennemis !", ranked: false, special: false },
            zone_control: { name: "Zone", icon: "â­•", desc: "ContrÃ´le la zone !", ranked: false, special: false },
            treasure: { name: "Chasse", icon: "ğŸ‘‘", desc: "Trouve les trÃ©sors !", ranked: false, special: false },
            sniper_duel: { name: "Duel Sniper", icon: "ğŸ”­", desc: "Tir de prÃ©cision.", ranked: false },
            giant_hunt: { name: "Chasse GÃ©ant", icon: "ğŸ‘¹", desc: "Abattez le colosse.", ranked: false },
            golden_chase: { name: "RuÃ©e vers l'Or", icon: "ğŸ’°", desc: "Collecte max !", ranked: false },
            infection_hard: { name: "Infection +", icon: "ğŸ§Ÿâ€â™‚ï¸", desc: "Survivre Ã  l'enfer.", ranked: false },
            speed_run: { name: "Speed Run", icon: "âš¡", desc: "Extraction Rapide.", ranked: false }
        };
        const ARENAS = { 
            tokyo: { name: "Neon Tokyo", color: '#050b14', grid: 'rgba(59,130,246,0.15)', wall: '#1e293b' }, 
            sand: { name: "Sandstorm", color: '#271a0c', grid: 'rgba(245,158,11,0.15)', wall: '#451a03' }, 
            ice: { name: "Ice Age", color: '#082f49', grid: 'rgba(255,255,255,0.1)', wall: '#164e63' }, 
            jungle: { name: "Jungle", color: '#064e3b', grid: 'rgba(34,197,94,0.2)', wall: '#052e16' }, 
            magma: { name: "Magma", color: '#450a0a', grid: 'rgba(239,68,68,0.2)', wall: '#280505' }, 
            ruins: { name: "Ruines", color: '#292524', grid: 'rgba(168,162,158,0.1)', wall: '#44403c' }, 
            cyber_city: { name: "Cyber City", color: '#0f172a', grid: 'rgba(6,182,212,0.2)', wall: '#164e63' }, 
            nebula: { name: "NÃ©buleuse", color: '#1e1b4b', grid: 'rgba(232, 121, 249, 0.2)', wall: '#312e81' },
            mainframe: { name: "Mainframe", color: '#022c22', grid: 'rgba(34, 211, 238, 0.3)', wall: '#134e4a', special: true },
            moon: { name: "Moon Base", color: '#1e293b', grid: 'rgba(148, 163, 184, 0.1)', wall: '#334155' },
            crystal: { name: "Cristal", color: '#2e1065', grid: 'rgba(167, 139, 250, 0.2)', wall: '#4c1d95', special: false },
            solaris: { name: "Solaris", color: '#451a03', grid: 'rgba(251, 146, 60, 0.2)', wall: '#7c2d12', special: false },
            swamp: { name: "Marais", color: '#222d1d', grid: 'rgba(132, 204, 22, 0.2)', wall: '#1a1f16' },
            factory: { name: "Usine", color: '#332e2b', grid: 'rgba(249, 115, 22, 0.2)', wall: '#292524' },
            void: { name: "NÃ©ant", color: '#000000', grid: 'rgba(255, 255, 255, 0.05)', wall: '#171717', special: false }
        };
        const PERKS = [{ name: 'Gros Calibre', icon: 'ğŸ’ª', desc: '+25% DÃ©gÃ¢ts', fn: p => p.stats.dmg *= 1.25 }, { name: 'Armure Nano', icon: 'ğŸ¦º', desc: '+30% PV Max', fn: p => { p.maxHp *= 1.3; p.hp += 50; } }, { name: 'Turbo', icon: 'ğŸ‘Ÿ', desc: '+15% Vitesse', fn: p => p.stats.spd *= 1.15 }];
        const RANKS = [{n:"BRONZE I", t:0, c:"#cd7f32"}, {n:"BRONZE II", t:100, c:"#cd7f32"}, {n:"BRONZE III", t:200, c:"#cd7f32"}, {n:"SILVER I", t:300, c:"#c0c0c0"}, {n:"SILVER II", t:500, c:"#c0c0c0"}, {n:"SILVER III", t:700, c:"#c0c0c0"}, {n:"GOLD I", t:1000, c:"#ffd700"}, {n:"GOLD II", t:1300, c:"#ffd700"}, {n:"GOLD III", t:1600, c:"#ffd700"}, {n:"PLATINUM I", t:2000, c:"#22d3ee"}, {n:"PLATINUM II", t:2500, c:"#22d3ee"}, {n:"DIAMOND", t:3500, c:"#a855f7"}, {n:"mMASTER", t:5000, c:"#ef4444"}];
        
        // NOUVELLE GRANDE LISTE D'ICÃ”NES POUR PLUS DE CHOIX (160+)
        const ICONS = ["ğŸ‘¤","ğŸ¤–","ğŸ‘½","ğŸ¦","ğŸ¦„","ğŸ’€","âš”ï¸","ğŸ’","ğŸ‘‘","ğŸ®","ğŸš€","ğŸ”¥","â„ï¸","âš¡","ğŸŒŸ","ğŸ±","ğŸ¶","ğŸ¦Š","ğŸ¸","ğŸµ","ğŸ¼","ğŸ¨","ğŸ¯","ğŸ™","ğŸ¦–","ğŸ‘»","ğŸ’©","ğŸ¤¡","ğŸ‘¹","ğŸ‘º","ğŸƒ","ğŸ¦¾","ğŸ§ ","ğŸ‘€","ğŸ’¥","ğŸ’¯","ğŸ¥¶","ğŸ¥µ","ğŸ¤ ","ğŸ¥¸","ğŸ¤‘", "ğŸ¥·", "ğŸ§™", "ğŸ§ª", "ğŸ¦ ", "ğŸ§¬", "ğŸ’¾", "âš™ï¸", "ğŸ’¡", "ğŸ“¡", "ğŸ›¸", "ğŸ‘¾", "ğŸ‰", "ğŸº", "ğŸ¦‰", "ğŸ¦‹", "ğŸ„", "ğŸŒ·", "ğŸŒ²", "ğŸŒŠ", "ğŸŒ‹", "ğŸ–ï¸", "ğŸŒƒ", "ğŸ™ï¸", "ğŸ›ï¸", "ğŸ§±", "ğŸ®", "â›©ï¸", "ğŸ¯", "ğŸ—¼", "ğŸ—½", "ğŸ””", "ğŸ¶", "ğŸ¤", "ğŸ¸", "ğŸ§", "ğŸ•¹ï¸", "ğŸ¯", "ğŸ²", "ğŸ±", "ğŸ€", "âš½", "ğŸˆ", "âš¾", "ğŸ¾", "ğŸ¥Š", "ğŸ¥‹", "ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰", "ğŸ‰", "ğŸˆ", "ğŸ", "ğŸ§§", "ğŸ€", "ğŸ“¦", "âœ‰ï¸", "ğŸ”‘", "ğŸ—ï¸", "ğŸ”¨", "ğŸ› ï¸", "ğŸª“", "ğŸ”«", "ğŸ¹", "ğŸ›¡ï¸", "âš°ï¸", "âš±ï¸", "ğŸ‘‘", "ğŸ”®", "ğŸª„", "ğŸ”‘", "ğŸ›¡ï¸", "ğŸ”¥", "ğŸ’§", "ğŸŒ", "âœ¨", "ğŸ’«", "ğŸŒ‘", "â˜€ï¸", "ğŸŒ™", "â­", "ğŸŒˆ", "â˜„ï¸", "ğŸ’¥", "âš¡", "ğŸŒ©ï¸", "â˜”", "ğŸŒªï¸", "ğŸ’¨", "ğŸ‚", "ğŸ", "ğŸ", "ğŸ", "ğŸ", "ğŸŠ", "ğŸ‹", "ğŸŒ", "ğŸ‰", "ğŸ‡", "ğŸ“", "ğŸˆ", "ğŸ’", "ğŸ‘", "ğŸ", "ğŸ¥¥", "ğŸ¥", "ğŸ¥­", "ğŸ…", "ğŸ†", "ğŸŒ¶ï¸", "ğŸŒ½", "ğŸ¥•", "ğŸ¥”", "ğŸ ", "ğŸ¥", "ğŸ", "ğŸ¥–", "ğŸ¥¨", "ğŸ¥", "ğŸ§‡", "ğŸ§€", "ğŸ¥š", "ğŸ³", "ğŸ¥“", "ğŸ¥©", "ğŸ—", "ğŸ–", "ğŸ”", "ğŸŸ", "ğŸ•", "ğŸŒ­", "ğŸ¥ª", "ğŸŒ®", "ğŸŒ¯", "ğŸ¥™", "ğŸ§†", "ğŸ¥—", "ğŸ¥˜", "ğŸ²", "ğŸ", "ğŸœ", "ğŸ£", "ğŸ¤", "ğŸ¥", "ğŸ¡", "ğŸ¥ ", "ğŸ¥¡", "ğŸš", "ğŸ›", "ğŸ—", "ğŸ£", "ğŸ¤", "ğŸ¥", "ğŸ¡", "ğŸ¥ ", "ğŸ¥¡", "ğŸš", "ğŸ›"];
        
        const EMOTE_LIST = [
            {id:'happy', i:'ğŸ˜€', price: 0}, {id:'angry', i:'ğŸ˜¡', price: 0}, {id:'gg', i:'ğŸ‘', price: 0}, {id:'rip', i:'ğŸ’€', price: 0},
            {id:'love', i:'ğŸ˜', price: 15}, {id:'clown', i:'ğŸ¤¡', price: 15}, {id:'fire', i:'ğŸ”¥', price: 25}, {id:'crown', i:'ğŸ‘‘', price: 45},
            {id:'ghost', i:'ğŸ‘»', price: 25}, {id:'robot', i:'ğŸ¤–', price: 25}, {id:'flex', i:'ğŸ’ª', price: 15}, {id:'cry', i:'ğŸ˜­', price: 15},
            {id:'cool', i:'ğŸ˜', price: 15}, {id:'party', i:'ğŸ¥³', price: 15}, {id:'sleeping', i:'ğŸ˜´', price: 5}, {id:'devil', i:'ğŸ˜ˆ', price: 25},
            {id:'money', i:'ğŸ¤‘', price: 35}, {id:'sick', i:'ğŸ¤¢', price: 5}, {id:'shhh', i:'ğŸ¤«', price: 10}, {id:'think', i:'ğŸ¤”', price: 10},
            {id:'dab', i:'ğŸ™…', price: 95}, {id:'rich', i:'ğŸ’¸', price: 195}, {id:'hacker', i:'ğŸ’»', price: 145}, {id:'cat', i:'ğŸ™€', price: 115},
            {id:'alien', i:'ğŸ‘½', price: 20}, {id:'nerd', i:'ğŸ¤“', price: 10}, {id:'rage', i:'ğŸ¤¬', price: 30}, {id:'mindblown', i:'ğŸ¤¯', price: 25},
            {id:'scream', i:'ğŸ˜±', price: 15}, {id:'star', i:'ğŸ¤©', price: 20}, {id:'cowboy', i:'ğŸ¤ ', price: 25}, {id:'mask', i:'ğŸ˜·', price: 5},
            {id:'ice', i:'ğŸ¥¶', price: 25}, {id:'boxe', i:'ğŸ¥Š', price: 30}, {id:'zen', i:'ğŸ§˜', price: 10}, {id:'dice', i:'ğŸ²', price: 15},
            // NEW 1.1.2
            {id:'zipper', i:'ğŸ¤', price: 10}, {id:'melting', i:'ğŸ« ', price: 20}, {id:'salute', i:'ğŸ«¡', price: 25}, {id:'peeking', i:'ğŸ«£', price: 20},
            {id:'diagonal', i:'ğŸ˜µâ€ğŸ’«', price: 25}, {id:'ninja', i:'ğŸ¥·', price: 80}, {id:'king', i:'ğŸ¤´', price: 50}, {id:'zombie', i:'ğŸ§Ÿ', price: 30},
            {id:'brain', i:'ğŸ§ ', price: 40}, {id:'rockon', i:'ğŸ¤˜', price: 20}, {id:'poop', i:'ğŸ’©', price: 5}, {id:'chicken', i:'ğŸ”', price: 35},
            {id:'dragon', i:'ğŸ²', price: 100}, {id:'unicorn', i:'ğŸ¦„', price: 90}, {id:'ufo', i:'ğŸ›¸', price: 60},
            // NEW 1.1.5
            {id:'hamburger', i:'ğŸ”', price: 20}, {id:'pizza', i:'ğŸ•', price: 20}, {id:'fries', i:'ğŸŸ', price: 15}, {id:'hotdog', i:'ğŸŒ­', price: 15},
            {id:'popcorn', i:'ğŸ¿', price: 10}, {id:'donut', i:'ğŸ©', price: 15}, {id:'cookie', i:'ğŸª', price: 10}, {id:'beer', i:'ğŸº', price: 30},
            {id:'cheers', i:'ğŸ»', price: 40}, {id:'wine', i:'ğŸ·', price: 35}, {id:'cocktail', i:'ğŸ¹', price: 35}, {id:'tropical', i:'ğŸï¸', price: 50},
            {id:'sun', i:'â˜€ï¸', price: 10}, {id:'cloud', i:'â˜ï¸', price: 5}, {id:'rain', i:'ğŸŒ§ï¸', price: 15}, {id:'snow', i:'â„ï¸', price: 20},
            {id:'umbrella', i:'â˜‚ï¸', price: 15}, {id:'rainbow', i:'ğŸŒˆ', price: 40}, {id:'soccer', i:'âš½', price: 25}, {id:'basketball', i:'ğŸ€', price: 25},
            {id:'tennis', i:'ğŸ¾', price: 25}, {id:'baseball', i:'âš¾', price: 25}, {id:'trophy', i:'ğŸ†', price: 100}, {id:'medal', i:'ğŸ¥‡', price: 50},
            {id:'gamer', i:'ğŸ®', price: 30}, {id:'music', i:'ğŸµ', price: 15},
            // NEW 1.2.0 - 100 EMOTES UPDATE
            {id:'mouse', i:'ğŸ­', price: 10}, {id:'hamster', i:'ğŸ¹', price: 10}, {id:'rabbit', i:'ğŸ°', price: 15}, {id:'fox', i:'ğŸ¦Š', price: 20},
            {id:'bear', i:'ğŸ»', price: 20}, {id:'panda', i:'ğŸ¼', price: 25}, {id:'koala', i:'ğŸ¨', price: 25}, {id:'tiger', i:'ğŸ¯', price: 30},
            {id:'lion', i:'ğŸ¦', price: 30}, {id:'cow', i:'ğŸ®', price: 15}, {id:'pig', i:'ğŸ·', price: 15}, {id:'frog', i:'ğŸ¸', price: 10},
            {id:'monkey', i:'ğŸµ', price: 20}, {id:'penguin', i:'ğŸ§', price: 30}, {id:'bird', i:'ğŸ¦', price: 10}, {id:'chick', i:'ğŸ¥', price: 10},
            {id:'duck', i:'ğŸ¦†', price: 15}, {id:'eagle', i:'ğŸ¦…', price: 40}, {id:'owl', i:'ğŸ¦‰', price: 30}, {id:'bat', i:'ğŸ¦‡', price: 20},
            {id:'wolf', i:'ğŸº', price: 35}, {id:'boar', i:'ğŸ—', price: 25}, {id:'horse', i:'ğŸ´', price: 20}, {id:'bomb', i:'ğŸ’£', price: 25},
            {id:'dagger', i:'ğŸ—¡ï¸', price: 35}, {id:'shield', i:'ğŸ›¡ï¸', price: 20}, {id:'potion', i:'ğŸ§ª', price: 15}, {id:'map', i:'ğŸ—ºï¸', price: 10},
            {id:'compass', i:'ğŸ§­', price: 15}, {id:'anchor', i:'âš“', price: 20}, {id:'rocket', i:'ğŸš€', price: 50}, {id:'ship', i:'ğŸš¢', price: 40},
            {id:'car', i:'ğŸš—', price: 20}, {id:'bus', i:'ğŸšŒ', price: 20}, {id:'police', i:'ğŸš“', price: 25}, {id:'taxi', i:'ğŸš•', price: 20},
            {id:'bicycle', i:'ğŸš²', price: 10}, {id:'broken', i:'ğŸ’”', price: 5}, {id:'heartfire', i:'â¤ï¸â€ğŸ”¥', price: 30}, {id:'sparkle', i:'âœ¨', price: 25},
            {id:'cyclone', i:'ğŸŒ€', price: 35}, {id:'fog', i:'ğŸŒ«ï¸', price: 10}, {id:'zap', i:'âš¡', price: 20}, {id:'extinguisher', i:'ğŸ§¯', price: 15},
            {id:'moai', i:'ğŸ—¿', price: 50}, {id:'peach', i:'ğŸ‘', price: 10}, {id:'eggplant', i:'ğŸ†', price: 10}, {id:'cherries', i:'ğŸ’', price: 10}
        ];
        // Sort emotes by price
        EMOTE_LIST.sort((a, b) => a.price - b.price);

        const DIFFICULTY = {
            easy: { name: 'Facile', mult: 0.8, color: 'text-green-400' }, // Feature 2: Score Multiplier adjusted
            normal: { name: 'Normal', mult: 1.0, color: 'text-blue-400' },
            hard: { name: 'Difficile', mult: 1.5, color: 'text-red-400' },
            expert: { name: 'Expert', mult: 2.0, color: 'text-purple-600' }
        };

        // NEW MODIFIERS
        const MODIFIERS = {
            normal: { name: 'Classique', color: 'text-gray-300' },
            oneshot: { name: 'One Shot', color: 'text-red-500' },
            poison: { name: 'Poison', color: 'text-green-500' },
            speed: { name: 'Speed', color: 'text-yellow-500' },
            vampire: { name: 'Vampire', color: 'text-pink-500' },
            infinite: { name: 'Infini', color: 'text-blue-400' },
            explosive: { name: 'Explosif', color: 'text-orange-500' },
            recoil: { name: 'Recul', color: 'text-white' },
            giant: { name: 'GÃ©ant', color: 'text-purple-600' },
            low_grav: { name: 'Gravity', color: 'text-indigo-400' },
            double_dmg: { name: 'Double DÃ©gÃ¢ts', color: 'text-red-600' },
            tiny: { name: 'Tiny', color: 'text-xs text-blue-300' },
            pluie: { name: 'Pluie Balles', color: 'text-cyan-400' },
            no_regen: { name: 'No Regen', color: 'text-gray-500' },
            fragile: { name: 'Fragile', color: 'text-red-300' }
        };

        const CURRENT_VERSION_KEY = 'mBattle_Data_v1_2_1';
        const PREVIOUS_KEYS = ['mBattle_Data_v1_1_5', 'mBattle_Data_v1_1_4', 'mBattle_Data_v1_1_3', 'mBattle_Data_v1_1_2', 'mBattle_Data_v1_1_0', 'mBattle_Data_v1_0_6', 'mBattle_Data_v1_0', 'mBattle_Data_v1_0_5', 'mBattle_Data_v20', 'mBattle_Data_v19', 'mBattle_Data_v18', 'mBattle_Data_v17', 'mBattle_Data_v16'];
        let USER = {
            name: "Joueur", avatar: "ğŸ‘¤", tag: "#" + Math.random().toString(36).substr(2, 6).toUpperCase(),
            coins: 500, gems: 10, trophies: 0, unlocked: ['soldier', 'drone'], levels: { soldier: 1, drone: 1 }, selected: 'soldier',
            stats: { kills: 0, maxWave: 0, games: 0, wins: 0, dmg: 0, losses: 0, maxPassTier: 1 }, // Ajout des nouvelles stats
            lastDaily: 0,
            pass: { tier: 1, xp: 0, claimed: [], claimedPro: [] },
            shop: { lastRefresh: 0, items: [] },
            emotes: ['happy', 'angry', 'gg', 'rip'], equippedEmotes: ['happy', 'angry', 'gg', 'rip'],
            mPassPro: false,
            skins: {}, 
            ownedSkins: [],
            quests: { daily: [], season: [], lastGenerated: 0 }
        };

        const PERKS = [
            { name: "Puissance", icon: "ğŸ’ª", desc: "DÃ©gÃ¢ts +10%", fn: (p) => { p.stats.dmg *= 1.1; window.ui.notif("DÃ‰GÃ‚TS UP!", "#ef4444"); } },
            { name: "VitalitÃ©", icon: "â¤ï¸", desc: "SantÃ© +20%", fn: (p) => { const add = p.maxHp * 0.2; p.maxHp += add; p.hp += add; window.ui.notif("SANTÃ‰ UP!", "#22c55e"); } },
            { name: "AgilitÃ©", icon: "âš¡", desc: "Vitesse +10%", fn: (p) => { p.stats.spd *= 1.1; window.ui.notif("VITESSE UP!", "#facc15"); } },
            { name: "Recharge", icon: "ğŸ”„", desc: "Recharge -10%", fn: (p) => { p.stats.reload *= 0.9; window.ui.notif("RECHARGE UP!", "#3b82f6"); } },
            { name: "Furie", icon: "ğŸ”«", desc: "Cadence +10%", fn: (p) => { p.stats.rate *= 0.9; window.ui.notif("CADENCE UP!", "#f97316"); } },
            { name: "Chargeur", icon: "ğŸ“¦", desc: "Munitions +1", fn: (p) => { p.ammoMax += 1; p.ammo += 1; window.ui.notif("MUNITIONS UP!", "#a855f7"); } }
        ];

        const QuestSystem = {
            generateDaily() {
                const now = Date.now();
                if (now - USER.quests.lastGenerated > 86400000) { // 24h
                    USER.quests.daily = [];
                    USER.quests.lastGenerated = now;
                    // Generate 5 to 7 random quests
                    const count = 5 + Math.floor(Math.random() * 3);
                    const modeKeys = Object.keys(MODES).filter(k => !MODES[k].boss && !MODES[k].special);
                    const heroKeys = Object.keys(STARTERS);

                    for(let i=0; i<count; i++) {
                        const type = Math.random();
                        let q = { id: Math.random().toString(36).substr(2, 9), progress: 0, completed: false, claimed: false };
                        
                        if (type < 0.15) { 
                            const m = modeKeys[Math.floor(Math.random() * modeKeys.length)];
                            q.type = 'play'; q.mode = m; q.target = 3; q.desc = `Jouer 3 parties en ${MODES[m].name}`; q.reward = { type: 'xp', val: 150 };
                        } else if (type < 0.30) {
                            const arenaKeys = Object.keys(ARENAS);
                            const a = arenaKeys[Math.floor(Math.random() * arenaKeys.length)];
                            q.type = 'play'; q.arena = a; q.target = 3; q.desc = `Jouer 3 parties sur ${ARENAS[a].name}`; q.reward = { type: 'xp', val: 150 };
                        } else if (type < 0.45) { 
                            q.type = 'kill'; q.target = 50 + Math.floor(Math.random()*50); q.desc = `Ã‰liminer ${q.target} ennemis`; q.reward = { type: 'coins', val: 200 };
                        } else if (type < 0.55) { 
                            q.type = 'xp'; q.target = 500 + Math.floor(Math.random()*500); q.desc = `Gagner ${q.target} XP`; q.reward = { type: 'xp', val: 150 };
                        } else if (type < 0.70) {
                            const h = heroKeys[Math.floor(Math.random() * heroKeys.length)];
                            q.type = 'play'; q.hero = h; q.target = 2; q.desc = `Jouer 2 parties avec ${STARTERS[h].name}`; q.reward = { type: 'gems', val: 5 };
                        } else if (type < 0.85) {
                            const amount = 5000 + Math.floor(Math.random() * 10000);
                            q.type = 'dmg'; q.target = amount; q.desc = `Infliger ${amount} dÃ©gÃ¢ts`; q.reward = { type: 'coins', val: 250 };
                        } else if (type < 0.93) {
                            q.type = 'collect'; q.target = 10; q.itemType = 'coins'; q.desc = "Ramasser 10 tas de piÃ¨ces"; q.reward = { type: 'coins', val: 300 };
                        } else {
                            q.type = 'win'; q.target = 1; q.desc = "Gagner 1 partie"; q.reward = { type: 'box', val: 1 };
                        }
                        USER.quests.daily.push(q);
                    }
                    Storage.save();
                }
            },
            generateSeason() {
                if (!USER.quests.season || USER.quests.season.length < 10) { // Force update if not enough quests
                   // Existing quests preservation could be done here, but simpler to reset/init for this "Saison 2" update
                   USER.quests.season = [
                       { id: 's2_q1', type: 'play', arena: 'crystal', target: 5, progress: 0, completed: false, claimed: false, desc: "Jouer 5 parties Grotte de Cristal", reward: { type: 'xp', val: 500 } },
                       { id: 's2_q2', type: 'play', mode: 'cyber_hack', target: 5, progress: 0, completed: false, claimed: false, desc: "Jouer 5 parties Cyber Hack", reward: { type: 'gems', val: 20 } },
                       { id: 's2_q3', type: 'kill', target: 500, progress: 0, completed: false, claimed: false, desc: "Ã‰liminer 500 ennemis (Total)", reward: { type: 'coins', val: 2000 } },
                       { id: 's2_q4', type: 'dmg', target: 100000, progress: 0, completed: false, claimed: false, desc: "Infliger 100k DÃ©gÃ¢ts", reward: { type: 'mega_caisse_loot', val: 1 } },
                       { id: 's2_q5', type: 'win', target: 10, progress: 0, completed: false, claimed: false, desc: "Gagner 10 parties", reward: { type: 'gems', val: 50 } },
                       { id: 's2_q6', type: 'play', hero: 'drone', target: 3, progress: 0, completed: false, claimed: false, desc: "Jouer 3 fois avec Drone", reward: { type: 'xp', val: 300 } },
                       { id: 's2_q7', type: 'play', hero: 'soldier', target: 3, progress: 0, completed: false, claimed: false, desc: "Jouer 3 fois avec Soldier", reward: { type: 'xp', val: 300 } },
                       { id: 's2_q8', type: 'collect', itemType: 'gems', target: 50, progress: 0, completed: false, claimed: false, desc: "RÃ©cupÃ©rer 50 Gemmes au sol", reward: { type: 'skin', val: 1, name: 'Skin AlÃ©atoire' } },
                       { id: 's2_q9', type: 'survive', target: 10, progress: 0, completed: false, claimed: false, desc: "Survivre Vague 10 (Survie)", reward: { type: 'box', val: 2 } },
                       { id: 's2_q10', type: 'play', mode: 'heist', target: 5, progress: 0, completed: false, claimed: false, desc: "Jouer 5 parties Braquage", reward: { type: 'xp', val: 400 } },
                       { id: 's2_q11', type: 'kill', target: 1000, progress: 0, completed: false, claimed: false, desc: "Tueur en sÃ©rie (1000 Kills)", reward: { type: 'gems', val: 100 } },
                       { id: 's2_q12', type: 'xp', target: 5000, progress: 0, completed: false, claimed: false, desc: "Gagner 5000 XP", reward: { type: 'coins', val: 5000 } },
                       { id: 's2_q13', type: 'play', mode: 'ranked', target: 10, progress: 0, completed: false, claimed: false, desc: "Jouer 10 parties ClassÃ©es", reward: { type: 'mega_caisse_loot', val: 2 } },
                       { id: 's2_q14', type: 'play', mode: 'boss_rush', target: 3, progress: 0, completed: false, claimed: false, desc: "Survivre 3 Boss Rush", reward: { type: 'gems', val: 30 } },
                       { id: 's2_q15', type: 'play', hero: 'tank', target: 5, progress: 0, completed: false, claimed: false, desc: "Jouer 5 fois avec Heavy", reward: { type: 'xp', val: 500 } },
                       { id: 's2_q16', type: 'dmg', target: 500000, progress: 0, completed: false, claimed: false, desc: "DÃ©gÃ¢ts Massifs (500k)", reward: { type: 'gems', val: 150 } },
                       { id: 's2_q17', type: 'collect', itemType: 'coins', target: 100, progress: 0, completed: false, claimed: false, desc: "Riche: 100 tas de piÃ¨ces", reward: { type: 'xp', val: 800 } },
                       { id: 's2_q18', type: 'play', arena: 'moon', target: 5, progress: 0, completed: false, claimed: false, desc: "Mission Lunaire (5 parties)", reward: { type: 'box', val: 3 } },
                       { id: 's2_q19', type: 'play', mode: 'infection', target: 5, progress: 0, completed: false, claimed: false, desc: "Survivre Ã  l'infection (5 fois)", reward: { type: 'coin', val: 1000 } },
                       { id: 's2_q20', type: 'win', target: 50, progress: 0, completed: false, claimed: false, desc: "Gagner 50 parties", reward: { type: 'skin', val: 1, name: 'Skin Ã‰pique' } },
                       { id: 's2_q21', type: 'kill', target: 100, progress: 0, completed: false, claimed: false, desc: "Chasseur : 100 Kills", reward: { type: 'xp', val: 200 } },
                       { id: 's2_q22', type: 'play', mode: 'rampage', target: 3, progress: 0, completed: false, claimed: false, desc: "Faire 3 Carnages", reward: { type: 'coins', val: 500 } },
                       { id: 's2_q23', type: 'play', mode: 'zone_control', target: 3, progress: 0, completed: false, claimed: false, desc: "ContrÃ´ler la zone 3 fois", reward: { type: 'gems', val: 15 } },
                       // Add more static quests here as requested by "beaucoup plus de quÃªtes"
                   ];
                   
                   // Ensure loaded quests for existing users are merged if we really wanted, 
                   // but hard reset for season update is cleaner to ensure they see the new ones.
                   Storage.save();
                }
            },
            check(type, data) {
                let changed = false;
                const checkList = (list) => {
                    list.forEach(q => {
                        if (q.completed) return;
                        let match = false;
                        if (q.type === type) {
                            if (q.type === 'play') {
                                if (q.mode && q.mode !== data.mode) return;
                                if (q.arena && q.arena !== data.arena) return;
                                if (q.hero && q.hero !== data.hero) return;
                                match = true;
                            } else if (q.type === 'kill') {
                                match = true;
                            } else if (q.type === 'xp') {
                                match = true;
                            } else if (q.type === 'dmg') {
                                match = true;
                            } else if (q.type === 'collect') {
                                if (q.itemType && q.itemType !== data.itemType) return;
                                match = true;
                            } else if (q.type === 'win') {
                                if (q.mode && q.mode !== data.mode) return;
                                if (q.arena && q.arena !== data.arena) return;
                                match = true;
                            } else if (q.type === 'survive') {
                                if (data.wave >= q.target) { q.progress = q.target; match = true; } // Direct completion for survive wave X
                            }
                        }
                        if (match) {
                            if (type === 'xp' || type === 'dmg' || type === 'collect') q.progress += data.amount || 1; 
                            else if(type !== 'survive') q.progress++;
                            
                            if (q.progress >= q.target) { q.progress = q.target; q.completed = true; window.ui.notif("QUÃŠTE TERMINÃ‰E !", "#22c55e"); }
                            changed = true;
                        }
                    });
                };
                if (USER.quests) { checkList(USER.quests.daily); checkList(USER.quests.season); }
                if (changed) Storage.save();
            },
            claim(listType, id) {
                const list = USER.quests[listType];
                const q = list.find(x => x.id === id);
                if (q && q.completed && !q.claimed) {
                    q.claimed = true;
                    if (q.reward.type === 'xp') {
                        USER.pass.xp += q.reward.val; window.ui.notif(`+${q.reward.val} XP`, "#22c55e");
                        while(USER.pass.xp >= 100) { if(USER.pass.tier < 50) { USER.pass.tier++; USER.pass.xp -= 100; window.ui.notif("PASS LEVEL UP!", "#facc15"); } else { USER.pass.xp = 100; break; } }
                    } else if (q.reward.type === 'coins') { USER.coins += q.reward.val; window.ui.notif(`+${q.reward.val} ğŸª™`, "#eab308"); } 
                    else if (q.reward.type === 'gems') { USER.gems += q.reward.val; window.ui.notif(`+${q.reward.val} ğŸ’`, "#a855f7"); }
                    else if (q.reward.type === 'box') { window.ui.buy('box', 0, 'free'); }
                    else if (q.reward.type === 'mega_caisse_loot') { openLootCrate(); }
                    else if (q.reward.type === 'skin') {
                        // RÃ©compense Skin AlÃ©atoire
                        const keys = Object.keys(STARTERS);
                        const candidates = [];
                        keys.forEach(k => {
                            if(STARTERS[k].skins) STARTERS[k].skins.forEach(s => {
                                if(!USER.ownedSkins.includes(`${k}_${s.id}`)) candidates.push({h: k, s: s});
                            });
                        });
                        
                        if(candidates.length > 0) {
                            const win = candidates[Math.floor(Math.random() * candidates.length)];
                            USER.ownedSkins.push(`${win.h}_${win.s.id}`);
                            window.ui.notif(`SKIN DÃ‰BLOQUÃ‰: ${win.s.name} (${STARTERS[win.h].name})`, "#facc15");
                        } else {
                            USER.gems += 50; window.ui.notif("TOUS SKINS POSSÃ‰DÃ‰S -> +50 ğŸ’", "#a855f7");
                        }
                    }
                    Storage.save(); window.ui.renderProfile(); window.ui.updateMenu();
                }
            },
            refreshDaily() {
                if (USER.gems >= 10) {
                    USER.gems -= 10;
                    USER.quests.lastGenerated = 0; // Force regen
                    this.generateDaily();
                    Storage.save();
                    window.ui.renderProfile();
                    window.ui.updateMenu();
                    window.ui.notif("-10 ğŸ’ QUÃŠTES ACTUALISÃ‰ES", "#a855f7");
                } else {
                    window.ui.notif("PAS ASSEZ DE GEMMES (10 ğŸ’)", "#ef4444");
                }
            },
            hasQuest(type, filter) {
                if(!USER.quests) return false;
                const all = [...USER.quests.daily, ...USER.quests.season];
                return all.some(q => {
                   if(q.completed || q.claimed) return false;
                   if(q.type !== type) return false;
                   if(filter) {
                       for(let k in filter) {
                           if(q[k] !== filter[k]) return false;
                       }
                   }
                   return true;
                });
            }
        };
        window.QuestSystem = QuestSystem;

        // MISE Ã€ JOUR : Remplacement des skins mPass par des caisses
        const PASS_REWARDS = {
            1: { free: 'coins:100', pro: 'mega_caisse_loot:1' },
            5: { free: 'emote:hacker', pro: 'gems:50' },
            10: { free: 'box:1', pro: 'mega_caisse_loot:1' },
            15: { free: 'coins:200', pro: 'emote:alien' },
            20: { free: 'box:1', pro: 'gems:100' },
            30: { free: 'box:1', pro: 'emote:mindblown' },
            40: { free: 'coins:500', pro: 'mega_caisse_loot:1' },
            50: { free: 'box:1', pro: 'gems:300' },
            60: { free: 'coins:1000', pro: 'mega_caisse_loot:2' },
            70: { free: 'box:2', pro: 'gems:150' },
            80: { free: 'coins:2000', pro: 'mega_caisse_loot:3' },
            90: { free: 'box:3', pro: 'emote:moai' },
            100: { free: 'mega_caisse_loot:1', pro: 'gems:500' } // mPass Max Final Reward
        };

        const getPassReward = (tier, isPro) => {
            if (PASS_REWARDS[tier]) {
                const rewardString = isPro ? PASS_REWARDS[tier].pro : PASS_REWARDS[tier].free;
                if (rewardString && rewardString.includes(':')) return rewardString;
            }
            if (isPro) {
                // Remplacer les rÃ©compenses par dÃ©faut des paliers non spÃ©cifiÃ©s par des caisses/gemmes
                return (tier % 5 === 0) ? 'mega_caisse_loot:1' : 'gems:15';
            } else {
                return (tier % 3 === 0) ? 'gems:5' : 'coins:50';
            }
        };

        const Storage = {
            save() { localStorage.setItem(CURRENT_VERSION_KEY, JSON.stringify(USER)); },
            load() {
                // Check migration
                let d = localStorage.getItem(CURRENT_VERSION_KEY);
                let isMigration = false;
                
                if (!d) {
                    // Try to find old data
                    for (let key of PREVIOUS_KEYS) {
                        const oldData = localStorage.getItem(key);
                        if (oldData) {
                            d = oldData;
                            isMigration = true; // Found old data, so it's a migration
                            break;
                        }
                    }
                }

                if (d) {
                    try {
                        const saved = JSON.parse(d);
                        USER = { ...USER, ...saved,
                            stats: { ...USER.stats, ...(saved.stats||{}), losses: saved.stats?.losses || 0, maxPassTier: saved.stats?.maxPassTier || 1 },
                            pass: isMigration ? { tier: 1, xp: 0, claimed: [], claimedPro: [] } : { ...USER.pass, ...(saved.pass||{}) },
                            shop: { ...USER.shop, ...(saved.shop||{}) },
                            levels: { ...USER.levels, ...(saved.levels||{}) },
                            emotes: saved.emotes || ['happy', 'angry', 'gg', 'rip'],
                            equippedEmotes: saved.equippedEmotes || ['happy', 'angry', 'gg', 'rip'],
                            mPassPro: isMigration ? false : (saved.mPassPro || false), // Reset Pro status for new season
                            skins: saved.skins || {},
                            ownedSkins: saved.ownedSkins || [],
                            quests: { daily: [], season: [], lastGenerated: 0, ...(saved.quests || {}) }
                        };
                        
                        // Ensure new free hero is unlocked
                        if(!USER.unlocked.includes('drone')) USER.unlocked.push('drone');
                        
                        if (typeof window.game !== 'undefined') {
                            if(!window.game.conf) window.game.conf = {};
                            if(!saved.conf || !saved.conf.difficulty) window.game.conf.difficulty = 'normal';
                            else window.game.conf.difficulty = saved.conf.difficulty;
                            if(!saved.conf || !saved.conf.modifier) window.game.conf.modifier = 'normal';
                            else window.game.conf.modifier = saved.conf.modifier;
                        }
                        
                        this.save();
                        
                    } catch (e) {
                         console.error("Erreur de chargement des donnÃ©es:", e);
                    }
                } else {
                    // Brand new user
                    // Initialisation des nouvelles stats pour les nouveaux utilisateurs
                    USER.stats.losses = 0;
                    USER.stats.maxPassTier = 1;
                }
                QuestSystem.generateDaily();
                QuestSystem.generateSeason();
                window.ui.refreshShop();
            }
        };

        const Rnd = (min,max) => Math.random()*(max-min)+min;
        const Dist = (e1,e2) => Math.hypot(e1.x-e2.x, e1.y-e2.y);
        function ColRect(c, r) { return c.x+c.r > r.x && c.x-c.r < r.x+r.w && c.y+c.r > r.y && c.y-c.r < r.y+r.h; }
        
        // Fonction de collision plus subtile, Ã©vitant de repousser les objets statiques
        function resolveCollision(e1, e2) {
            let dx=e1.x-e2.x, dy=e1.y-e2.y; let dist=Math.hypot(dx,dy); const minDist=e1.r+e2.r;
            if(dist < minDist) {
                if(dist <= 0.01) { dx=1; dy=0; dist=1; }
                const overlap=minDist-dist, nx=dx/dist, ny=dy/dist;
                
                // VÃ©rifier si l'une des entitÃ©s est le joueur et l'autre un mur ou un bot
                const isPlayer = e1 === window.game.player || e2 === window.game.player;
                
                // Masse inversÃ©e: entitÃ©s statiques (chest/core/train/terminal) ont masse infinie (1 / Infinity = 0)
                const isStatic1 = (e1.type==='chest' || e1.type==='core' || e1.type==='train' || e1.type==='terminal');
                const isStatic2 = (e2.type==='chest' || e2.type==='core' || e2.type==='train' || e2.type==='terminal');
                
                let m1 = isStatic1 ? 0 : (e1 === window.game.player ? 1 : 0.5); // Player mass 1, Bot mass 0.5
                let m2 = isStatic2 ? 0 : (e2 === window.game.player ? 1 : 0.5); 
                
                const totalMass = m1 + m2;
                
                let ratio1 = m2 / totalMass; 
                let ratio2 = m1 / totalMass; 
                
                if (isStatic1 && !isStatic2) { ratio1 = 0; ratio2 = 1; }
                else if (!isStatic1 && isStatic2) { ratio1 = 1; ratio2 = 0; }
                else if (isStatic1 && isStatic2) { return; } 

                // FIX ANTI-PUSH: Si e2 est un joueur et e1 est un bot, on donne la prioritÃ© au joueur.
                // Si e1 est le joueur, il prend 100% de la correction (si e2 n'est pas statique).
                if (e1 === window.game.player && !isStatic2) { ratio1 = 1; ratio2 = 0; } 
                // Si e2 est le joueur, il prend 100% de la correction (si e1 n'est pas statique).
                else if (e2 === window.game.player && !isStatic1) { ratio1 = 0; ratio2 = 1; }
                // Si la collision est joueur-bot, le joueur ne devrait pas bouger si le bot pousse.
                // Logique pour s'assurer que si le joueur est contre un mur (statique), le bot ne puisse pas le pousser davantage (bug anti-push)
                if (e1 === window.game.player && isStatic2) { ratio1 = 0; } 
                else if (e2 === window.game.player && isStatic1) { ratio2 = 0; }


                e1.x += nx * overlap * ratio1;
                e1.y += ny * overlap * ratio1;
                e2.x -= nx * overlap * ratio2;
                e2.y -= ny * overlap * ratio2;
            }
        }
        const getGadgetName = (g) => { 
            const map = { 'heal': 'Soin (+1000)', 'shield': 'Bouclier (+1000)', 'teleport': 'TP', 'dash': 'Dash Feu', 'speed': 'Turbo', 'knockback': 'Choc', 'stun': 'Ã‰tourdissant', 'turret': 'Tourelle', 'invis': 'InvisibilitÃ©' }; // Feature 8
            return map[g] || g.toUpperCase(); 
        }

        const el = (id) => document.getElementById(id);
        const setStyle = (id, prop, val) => { const e=el(id); if(e) e.style[prop]=val; };
        const setText = (id, txt) => { const e=el(id); if(e) e.innerText=txt; };
        
        // NOUVELLE FONCTION : Gestion de l'ouverture de caisse Ã  gros butin
        function openLootCrate() {
            let rewards = [];
            let totalValue = 0;
            const pulls = 7; // Feature 3: Mega caisse plus gÃ©nÃ©reuse (7 pulls au lieu de 5)

            for (let i = 0; i < pulls; i++) {
                const r = Math.random();
                let type, value, color, icon;

                if (r < 0.5) { // 50% chance: Coins
                    value = 150 + Math.floor(Math.random() * 250);
                    USER.coins += value;
                    type = 'PiÃ¨ces'; icon = 'ğŸª™'; color = '#eab308';
                    totalValue += value;
                } else if (r < 0.85) { // 35% chance: Gems
                    value = 7 + Math.floor(Math.random() * 13);
                    USER.gems += value;
                    type = 'Gemmes'; icon = 'ğŸ’'; color = '#a855f7';
                    totalValue += value * 50; // Estimer la valeur
                } else { // 15% chance: XP Boost
                    value = 150;
                    USER.pass.xp += value;
                    type = 'XP Pass'; icon = 'ğŸ«'; color = '#22d3ee';
                    totalValue += value * 2;
                }
                rewards.push({ icon, value, type });
            }

            // Traitement de l'XP
            while(USER.pass.xp >= 100) {
                if(USER.pass.tier < 50) {
                    USER.pass.tier++;
                    USER.pass.xp -= 100;
                    window.ui.notif("PASS LEVEL UP!", "#facc15");
                } else {
                    USER.pass.xp = 100;
                    break;
                }
            }
            
            // Affichage des rÃ©compenses
            let message = rewards.map(r => `${r.icon} +${r.value} ${r.type}`).join(', ');
            window.ui.notif(`BUTIN DE LA CAISSE : ${message}`, '#facc15');
            Storage.save();
            window.ui.updateMenu();
            window.ui.renderPass();
        }

        function processPassReward(rewardString) {
            const [type, value] = rewardString.split(':');
            const val = parseInt(value) || 1;
            let success = false;

            if (type === 'coins') {
                USER.coins += val;
                Storage.save();
                window.ui.updateMenu();
                window.ui.notif(`+${val} ğŸª™`, "#eab308");
                try { el('top-coins').closest('.currency-badge').classList.add('flash-coins'); setTimeout(() => el('top-coins').closest('.currency-badge').classList.remove('flash-coins'), 300); } catch(e){}
                success = true;
            } else if (type === 'gems') {
                USER.gems += val;
                Storage.save();
                window.ui.updateMenu();
                window.ui.notif(`+${val} ğŸ’`, "#a855f7");
                try { el('top-gems').closest('.currency-badge').classList.add('flash-gems'); setTimeout(() => el('top-gems').closest('.currency-badge').classList.remove('flash-gems'), 300); } catch(e){}
                success = true;
            } else if (type === 'box') {
                window.ui.buy('box', 0, 'free');
                success = true;
            } else if (type === 'mega_caisse_loot') { // NOUVEAU TYPE DE BUTIN
                openLootCrate();
                success = true;
            } else if (type.startsWith('emote')) {
                const emoteId = type.split(':')[1];
                if (!USER.emotes.includes(emoteId)) {
                    USER.emotes.push(emoteId);
                    window.ui.notif(`EMOTE DÃ‰BLOQUÃ‰E: ${EMOTE_LIST.find(e => e.id === emoteId)?.i}`, "#22d3ee");
                    window.ui.renderEmotes();
                }
                success = true;
            } else if (type.startsWith('skin')) {
                const [heroId, skinId] = type.split(':')[1].split('_');
                const fullSkinId = `${heroId}_${skinId}`;
                if (!USER.ownedSkins.includes(fullSkinId)) {
                    USER.ownedSkins.push(fullSkinId);
                    const skinName = STARTERS[heroId]?.skins.find(s => s.id === skinId)?.name || 'Skin';
                    window.ui.notif(`SKIN DÃ‰BLOQUÃ‰: ${skinName}!`, "#facc15");
                    window.ui.renderLists(); // Pour mettre Ã  jour la sÃ©lection de skin
                }
                success = true;
            }
            return success;
        }

        window.ui = {
            showIntro() {
                /* Video Removed */
            },
            closeIntro() {
                /* Video Removed */
            },
            hud() {
                if(!window.game.player) return; const p = window.game.player;
                // FIX 1: Retrait de la transition CSS pour un update immÃ©diat de la barre de vie
                const hpBar = el('hud-hp-bar');
                if (hpBar) {
                    // Supprime les classes de transition pour un effet instantanÃ©
                    hpBar.classList.remove('transition-all', 'duration-75'); 
                    hpBar.style.width = (p.hp/p.maxHp*100)+'%';
                }
                
                // FIX: Update HUD Hero Level dynamically
                setText('hud-lvl', 'LVL ' + p.lvl);

                setText('hud-score', window.game.score); setText('hud-sub', MODES[window.game.conf.mode].name.toUpperCase());
                if(window.game.conf.mode !== 'survival' && window.game.conf.mode !== 'ranked' && window.game.conf.mode !== 'infection' && window.game.conf.mode !== 'duel') {
                    const min = Math.floor(window.game.timeLeft / 3600); const sec = Math.floor((window.game.timeLeft % 3600) / 60);
                    const te = el('hud-timer'); if(te) { te.innerText = (min < 10 ? "0"+min : min) + ":" + (sec < 10 ? "0"+sec : sec); te.classList.remove('hidden'); }
                } else { const te = el('hud-timer'); if(te) te.classList.add('hidden'); }
                if(window.game.conf.mode === 'thief') {
                    el('hud-objective').innerText = `Sacs: ${window.game.lootCollected}/10`;
                    el('hud-objective').classList.remove('hidden');
                } else if(window.game.conf.mode === 'cyber_hack') {
                    el('hud-objective').innerText = `Hack: ${Math.floor(window.game.hackProgress)}%`;
                    el('hud-objective').classList.remove('hidden');
                } else if(window.game.conf.mode === 'escape') {
                    const exit = window.game.ents.find(e => e.type === 'exit');
                    if(exit) {
                         const dist = Math.floor(Dist(window.game.player, exit) / 10);
                         el('hud-objective').innerText = `Extraction: ${dist}m`;
                         el('hud-objective').classList.remove('hidden');
                    }
                } else if(window.game.conf.mode === 'rampage') {
                    el('hud-objective').innerText = `Kills: ${window.game.killCount}/50`;
                    el('hud-objective').classList.remove('hidden');
                } else if(window.game.conf.mode === 'zone_control') {
                    el('hud-objective').innerText = `Zone: ${Math.floor(window.game.zoneProgress)}%`;
                    el('hud-objective').classList.remove('hidden');
                } else {
                    el('hud-objective').classList.add('hidden');
                }
                for(let i=1; i<=3; i++) setStyle('ammo-'+i, 'opacity', i <= Math.floor(p.ammo) ? 1 : 0.3);
                setStyle('dash-cd', 'height', Math.max(0,p.dashT/60*100)+'%');
                setText('gadget-count', p.gadgetCharges);
                const gb=el('btn-gadget'); if(gb) { gb.disabled = p.gadgetCharges<=0; if(p.gadgetCharges<=0)gb.classList.add('opacity-50');else gb.classList.remove('opacity-50'); }
                
                // Check for terminal in boss UI check
                const boss=window.game.ents.find(e=>e.isBoss||e.isBot||e.type==='core'||e.type==='train'||e.type==='terminal'); const bui=el('boss-ui');
                if(boss && bui){
                    bui.classList.remove('hidden');
                    // Update label logic for terminal
                    let label = boss.isBot ? "RIVAL" : (boss.type==='chest'?"COFFRE":(boss.type==='core'?"CRISTAL":(boss.type==='train'?"TRAIN":(boss.type==='terminal'?"TERMINAL":"BOSS"))));
                    setText('boss-name', label);
                    setStyle('boss-bar', 'width', (boss.hp/boss.maxHp*100)+'%'); setText('boss-pct', Math.ceil(boss.hp/boss.maxHp*100)+'%');
                    const bar = el('boss-bar');
                    // Use blue bar for friendly/neutral objectives (core, train, terminal)
                    if(boss.type==='core' || boss.type==='train' || boss.type==='terminal') { bar.classList.remove('bg-gradient-to-r', 'from-red-600', 'to-red-500'); bar.style.backgroundColor = '#3b82f6'; }
                    else { bar.classList.add('bg-gradient-to-r', 'from-red-600', 'to-red-500'); bar.style.backgroundColor = ''; }
                } else if(bui) bui.classList.add('hidden');
                setStyle('gas-overlay', 'opacity', 0);
            },
            notif(m,c) { const d=document.createElement('div'); d.className='text-2xl font-black italic drop-shadow-2xl animate-bounce text-center px-4 py-1 bg-black/60 rounded-xl border border-white/10 backdrop-blur-sm shadow-xl'; d.style.color=c; d.innerText=m; el('notif-area').appendChild(d); setTimeout(()=>d.remove(),2000); },
            flash() { setStyle('flash-layer', 'opacity', 0.6); setTimeout(()=>setStyle('flash-layer', 'opacity', 0), 100); },
            feed(k,v,g) { const d=document.createElement('div'); d.className=`kill-msg ${g?'':'red'}`; d.innerHTML=`<span class="${g?'text-blue-400':'text-red-400'}">${k}</span> â˜ ï¸ ${v}`; const c=el('kill-feed'); if(c){ c.prepend(d); if(c.children.length>4)c.lastChild.remove(); } setTimeout(()=>d.remove(),4000); },
            levelUp() { const s=el('levelup-screen'), c=el('perk-container'); c.innerHTML=''; s.classList.remove('hidden'); PERKS.sort(()=>0.5-Math.random()).slice(0,3).forEach(p=>{ const b=document.createElement('button'); b.className='glass-panel p-4 text-left flex items-center gap-4 active:scale-95 transition bg-blue-900/40 border border-blue-500/30'; b.innerHTML=`<div class="text-3xl">${p.icon}</div><div><div class="font-bold text-yellow-400 text-lg">${p.name}</div><div class="text-xs text-gray-300">${p.desc}</div></div>`; b.onclick=()=>{p.fn(window.game.player); s.classList.add('hidden'); window.game.state='PLAYING';}; c.appendChild(b); }); },
            drawMinimap() {
                const cvs = document.getElementById('minimap'); if(!cvs) return; const ctx = cvs.getContext('2d'); ctx.clearRect(0, 0, 100, 100); const scale = 100 / window.game.world;
                if (window.game.player) { ctx.fillStyle = '#3b82f6'; ctx.beginPath(); ctx.arc(window.game.player.x * scale, window.game.player.y * scale, 4, 0, Math.PI * 2); ctx.fill(); }
                // Added 'terminal' to the list of objective entities to display correctly on the minimap
                (window.game.ents||[]).forEach(e => { if(e.hidden)return; ctx.fillStyle = (e.isBoss || e.isBot) ? '#ef4444' : (e.type==='core'||e.type==='train'||e.type==='terminal'?'#3b82f6':'#f87171'); const r = (e.isBoss || e.isBot || e.type==='core' || e.type==='train' || e.type==='terminal') ? 4 : 2; ctx.beginPath(); ctx.arc(e.x * scale, e.y * scale, r, 0, Math.PI * 2); ctx.fill(); });
                (window.game.map||[]).forEach(w => { if(w.type === 1) ctx.fillStyle = 'rgba(34, 197, 94, 0.8)'; else if(w.type === 3) ctx.fillStyle = '#d97706'; else ctx.fillStyle = 'rgba(255,255,255,0.4)'; ctx.fillRect(w.x * scale, w.y * scale, w.w * scale, w.h * scale); });
            },
            showTab(id) { 
                document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden')); 
                document.getElementById('tab-' + id).classList.remove('hidden'); 
                document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active', 'selected')); 
                const btn = document.getElementById('nav-' + id); 
                if(btn) btn.classList.add('active', 'selected'); 
                
                if(id === 'starters' || id === 'modes') this.renderLists(); 
                if(id === 'infos') this.updateStats(); 
                if(id === 'pass') this.renderPass(); 
                if(id === 'shop') this.renderShop(); 
                if(id === 'profile') this.renderProfile(); 
                if(id === 'emotes') this.renderEmotes(); 
                if(id === 'play') this.updateDifficultyButtons(); 
                
                this.updateMenu(); // Force menu refresh
            },
            updateDifficultyButtons() {
                if(!window.game || !window.game.conf) return; 
                document.querySelectorAll('.diff-btn').forEach(btn => btn.classList.remove('active'));
                const activeBtn = el(`diff-${window.game.conf.difficulty}`);
                if (activeBtn) activeBtn.classList.add('active');
                
                // Also update modifier buttons
                document.querySelectorAll('.mod-btn').forEach(btn => btn.classList.remove('active'));
                const modBtn = el(`mod-${window.game.conf.modifier}`);
                if(modBtn) modBtn.classList.add('active');
            },
            refreshShop(force = false) {
                if (force) {
                    if (USER.gems >= 10) {
                        USER.gems -= 10;
                        this.notif("-10 ğŸ’ REROLL", "#a855f7");
                        this.updateMenu();
                        USER.shop.lastRefresh = 0; // Force refresh trigger
                    } else {
                        this.notif("PAS ASSEZ DE GEMMES", "#ef4444");
                        return;
                    }
                }
                
                // NOUVEAU : Plus d'items de base garantis
                USER.shop.items = USER.shop.items || [];
                if(USER.shop.items.length === 0 || Date.now() > USER.shop.lastRefresh + 86400000) {
                    USER.shop.lastRefresh = Date.now();
                    USER.shop.items = [];

                    // OFFRE GRATUITE GARANTIE (1 item)
                    const freeType = ['coins','xp','gems'][Math.floor(Math.random()*3)];
                    if(freeType === 'coins') USER.shop.items.push({ type: 'coins', cost: 0, val: 150, curr: 'free', name: "PiÃ¨ces Gratuites" });
                    if(freeType === 'xp') USER.shop.items.push({ type: 'xp', cost: 0, val: 75, curr: 'free', name: "XP Pass Gratuit" });
                    if(freeType === 'gems') USER.shop.items.push({ type: 'gems', cost: 0, val: 10, curr: 'free', name: "Gemmes Gratuites" });

                    // ITEMS DE BASE GARANTIS (3 items)
                    USER.shop.items.push({type:'coins',cost:20,val:500,curr:'gems', name: "Mega Pack de PiÃ¨ces"});
                    USER.shop.items.push({type:'xp',cost:100,val:200,curr:'coins', name: "Super Boost de Pass"});
                    USER.shop.items.push({type:'box',cost:80,val:1,curr:'coins', name: "Mega Caisse"});

                    // ITEMS ALÃ‰ATOIRES (3 items)
                    for(let i=0; i<3; i++) {
                        const t = ['coins','gems','box', 'xp', 'skin'][Math.floor(Math.random()*5)];
                        if(t==='coins') USER.shop.items.push({type:'coins',cost:20,val:300,curr:'gems', name: "Pack de PiÃ¨ces"});
                        if(t==='gems') USER.shop.items.push({type:'gems',cost:500,val:30,curr:'coins', name: "Sac de Gemmes"});
                        if(t==='box') USER.shop.items.push({type:'box',cost:80,val:1,curr:'coins', name: "Mega Caisse"});
                        if(t==='xp') USER.shop.items.push({type:'xp',cost:100,val:100,curr:'coins', name: "Boost de Pass"});
                        if(t==='skin') {
                            const keys = Object.keys(STARTERS);
                            const s = STARTERS[keys[Math.floor(Math.random()*keys.length)]];
                            if(s.skins && s.skins.length > 1) {
                                const skin = s.skins[1]; 
                                USER.shop.items.push({type:'skin',cost:skin.price,val:1,curr:'coins', name: `Skin ${skin.name}`, skinId: skin.id, hero: s.name, discount: Math.random() > 0.5 ? 30 : 0});
                            } else {
                                USER.shop.items.push({type:'coins',cost:20,val:300,curr:'gems', name: "Pack de PiÃ¨ces"});
                            }
                        }
                    }
                    Storage.save();
                    if(force) this.renderShop();
                }
            },
            renderShop() {
                this.refreshShop();
                const now = Date.now(); 
                const left = (USER.shop.lastRefresh + 86400000) - now; const hrs = Math.floor(left / 3600000); const mins = Math.floor((left % 3600000) / 60000);
                setText('shop-timer', `${hrs}h ${mins}m`);
                const c = el('shop-offers'); 
                if(!c) return;
                c.innerHTML = '';
                c.innerHTML += `<h3 class="col-span-1 md:col-span-2 text-xl font-bold text-yellow-400 flex items-center gap-2">ğŸ”¥ OFFRES FLASH ğŸ”¥</h3>`;
                USER.shop.items.forEach((item, idx) => {
                    let icon = item.type==='coins'?'ğŸª™':(item.type==='gems'?'ğŸ’':(item.type==='xp'?'ğŸ«':(item.type==='skin'?'ğŸ‘•':'ğŸ“¦')));
                    let curIcon = item.curr==='coins'?'ğŸª™':(item.curr==='gems'?'ğŸ’':'ğŸ');
                    let color = item.curr==='free' ? 'free-item' : 'bg-white/5';
                    let btnClass = item.curr==='free' ? 'bg-green-600 hover:bg-green-500' : (item.curr==='gems'?'bg-purple-600 hover:bg-purple-500':'bg-yellow-600 hover:bg-yellow-500');
                    let costDisplay = `${item.cost} ${curIcon}`;
                    let discountBadge = '';
                    if(item.discount) {
                        const newCost = Math.floor(item.cost * (1 - item.discount/100));
                        costDisplay = `<span class="line-through text-gray-400 text-xs mr-2">${item.cost}</span> ${newCost} ${curIcon}`;
                        item.realCost = newCost;
                    } else {
                        item.realCost = item.cost;
                    }
                    if(item.curr === 'free') costDisplay = 'GRATUIT';
                    c.innerHTML += `<div class="glass-panel p-6 text-center flex flex-col items-center active:scale-95 transition border border-white/10 ${color} relative overflow-hidden">
                        ${discountBadge}
                        <div class="text-5xl mb-2">${icon}</div>
                        <div class="font-bold text-lg">${item.name}</div>
                        <div class="text-xs text-gray-400 mb-4">${item.type==='skin' ? 'Skin Rare' : `+${item.val} ${icon}`}</div>
                        <button onclick="window.ui.buySpecial(${idx})" class="w-full ${btnClass} py-3 rounded-xl font-bold text-sm">${costDisplay}</button>
                    </div>`;
                });
            },
            renderPass() {
                setText('pass-lvl', USER.pass.tier); setText('pass-xp-txt', `${USER.pass.xp}/100 XP`); setStyle('pass-bar', 'width', `${USER.pass.xp}%`);
                const status = el('pass-pro-status');
                if(status) {
                    if(USER.mPassPro) { status.innerHTML = '<span class="text-yellow-400 font-black text-xl glow">PRO ACTIVÃ‰</span>'; }
                    else { status.innerHTML = `<button onclick="window.ui.buyPassPro()" class="bg-gradient-to-r from-purple-600 to-indigo-600 px-4 py-2 rounded-lg font-bold text-xs shadow-lg hover:scale-105 transition">ACHETER PASS PRO (159 ğŸ’)</button>`; }
                }
                const tr = el('pass-track-free');
                const trPro = el('pass-track-pro');
                if (!tr || !trPro) return;
                let freeHtml = '';
                let proHtml = '';
                
                const getRewardDisplay = (rewardString) => {
                    const [type, value] = rewardString.split(':');
                    const val = parseInt(value) || 1;
                    let icon = 'ğŸ', text = '';
                    if(type === 'coins') { icon = 'ğŸª™'; text = `+${val} PiÃ¨ces`; }
                    else if(type === 'gems') { icon = 'ğŸ’'; text = `+${val} Gemmes`; }
                    else if(type === 'box' || type === 'mega_caisse_loot') { icon = 'ğŸ“¦'; text = 'Caisse'; }
                    else if(type.startsWith('emote')) { icon = EMOTE_LIST.find(e => e.id === type.split(':')[1])?.i || 'ğŸ˜€'; text = 'Emote'; }
                    else if(type.startsWith('skin')) { icon = 'ğŸ‘•'; text = 'Skin'; }
                    return { icon, text };
                };
                
                for(let i=1; i<=100; i++) {
                    const freeRwdStr = getPassReward(i, false);
                    const proRwdStr = getPassReward(i, true);
                    
                    const displayF = getRewardDisplay(freeRwdStr);
                    const displayP = getRewardDisplay(proRwdStr);
                    
                    let claimedF = USER.pass.claimed.includes(i);
                    let claimedP = USER.pass.claimedPro.includes(i);
                    let unlocked = USER.pass.tier >= i;
                    let proLocked = !USER.mPassPro;
                    
                    let freeState = claimedF ? 'claimed' : (unlocked ? 'active cursor-pointer' : 'locked');
                    let proState = claimedP ? 'claimed' : ((unlocked && !proLocked) ? 'active cursor-pointer pro' : 'locked pro');
                    
                    let fnF = (unlocked && !claimedF) ? `onclick="window.ui.claimPass(${i}, false, '${freeRwdStr}')"` : '';
                    let fnP = (unlocked && !claimedP && !proLocked) ? `onclick="window.ui.claimPass(${i}, true, '${proRwdStr}')"` : (proLocked ? `onclick="window.ui.notif('ACHÃˆTE LE PASS PRO !', '#a855f7')"` : '');
                    
                    let contentF = claimedF ? `<div class="check-mark">âœ…</div>` : '';
                    contentF += `<div class="text-3xl mb-1 ${claimedF ? 'opacity-20' : ''}">${displayF.icon}</div>
                                 <div class="text-[9px] font-bold ${claimedF ? 'opacity-50' : ''} text-center leading-tight px-1">${displayF.text}</div>`;

                    let contentP = claimedP ? `<div class="check-mark">âœ…</div>` : '';
                    contentP += `<div class="text-3xl mb-1 ${claimedP ? 'opacity-20' : ''}">${displayP.icon}</div>
                                 <div class="text-[9px] font-bold ${claimedP ? 'opacity-50' : ''} text-center leading-tight px-1">${displayP.text}</div>`;

                    freeHtml += `
                        <div id="pass-free-tier-${i}" class="pass-step ${freeState} shrink-0" ${fnF}>
                            <div class="tier-badge">PALIER ${i}</div>
                            ${contentF}
                        </div>`;
                    proHtml += `
                        <div id="pass-pro-tier-${i}" class="pass-step ${proState} shrink-0" ${fnP}>
                            <div class="tier-badge">PALIER ${i}</div>
                            ${contentP}
                        </div>`;
                }
                tr.innerHTML = freeHtml;
                trPro.innerHTML = proHtml;

                const scrollContainer = el('pass-scroll-container');
                const currentTierIndex = USER.pass.tier;

                if (scrollContainer) {
                    const freeRow = el('pass-track-free');
                    if (freeRow && currentTierIndex > 0) {
                        const targetTier = Math.min(100, Math.max(1, currentTierIndex));
                        // On dÃ©file vers le palier actuel ou le dernier non rÃ©clamÃ© si infÃ©rieur
                        // Mais gÃ©nÃ©ralement on veut voir oÃ¹ on en est
                        const targetElement = freeRow.querySelector(`#pass-free-tier-${targetTier}`);
                        
                        if (targetElement) {
                            const centerOffset = targetElement.offsetLeft - (scrollContainer.offsetWidth / 2) + (targetElement.offsetWidth / 2);
                            // Petit delai pour que le rendu soit effectif
                            setTimeout(() => { scrollContainer.scrollLeft = centerOffset; }, 50);
                        }
                    }
                }
                
                USER.stats.maxPassTier = Math.max(USER.stats.maxPassTier || 1, USER.pass.tier);
                Storage.save();
            },
            renderLists() {
                const currentMode = (window.game && window.game.conf) ? window.game.conf.mode : 'survival';
                const currentArena = (window.game && window.game.conf) ? window.game.conf.arena : 'tokyo';
                
                // NOUVEAU: Utiliser la liste triÃ©e
                const sortedStarters = sortStartersByRarity();

                const sl = el('list-starters'); sl.innerHTML = '';
                Object.keys(sortedStarters).forEach(k => {
                    const s = sortedStarters[k], unlocked = USER.unlocked.includes(k), lvl = USER.levels[k]||1, active = USER.selected === k ? 'border-blue-500 bg-blue-900/20' : 'bg-white/5 border-white/5';
                    const rarity = RARITY[s.rarity] || RARITY.common;
                    const borderColor = active.includes('border-blue-500') ? '' : `border-color: ${rarity.color}40;`;
                    const bgStyle = active.includes('bg-blue-900') ? '' : `background: linear-gradient(135deg, ${rarity.color}10, rgba(255,255,255,0.02));`;
                    sl.innerHTML += `<div onclick="window.ui.openHeroDetails('${k}')" style="${borderColor} ${bgStyle}" class="glass-panel p-4 cursor-pointer active:scale-95 transition ${active} ${unlocked?'':'locked'} relative group border flex flex-col items-center text-center">
                        ${(window.QuestSystem && window.QuestSystem.hasQuest('play', {hero: k})) ? '<div class="absolute top-1 left-1 text-lg z-20 animate-bounce">ğŸ“œ</div>' : ''}
                        <div class="absolute top-2 right-2 px-2 py-0.5 rounded text-[8px] font-bold uppercase tracking-wider text-white shadow-sm" style="background-color:${rarity.color}">${rarity.name}</div>
                        <div class="w-12 h-12 rounded-xl bg-black/40 flex items-center justify-center text-3xl mb-2">${s.icon}</div>
                        <div class="font-black text-sm uppercase tracking-wider" style="color:${rarity.color}">${s.name}</div>
                        <div class="text-[10px] text-gray-400 leading-tight mb-2 h-6 overflow-hidden">${s.desc}</div>
                        <div class="text-[9px] font-bold text-blue-300 mb-1">Niv. ${lvl}</div>
                    </div>`;
                });
                const ml = el('list-modes'); ml.innerHTML = ''; 
                Object.keys(MODES).forEach(k => { 
                    const m = MODES[k]; 
                    const specialClass = m.special ? 'season-gold' : 'bg-white/5 border-white/5'; 
                    const active = currentMode === k ? 'border-purple-500 bg-purple-900/20' : specialClass; 
                    ml.innerHTML += `<div onclick="window.game.setMode('${k}')" class="glass-panel p-4 cursor-pointer flex items-center gap-4 ${active} active:scale-95 transition border relative">
                        ${(window.QuestSystem && (window.QuestSystem.hasQuest('play', {mode: k}) || window.QuestSystem.hasQuest('win', {mode: k}))) ? '<div class="absolute top-2 right-2 text-xl animate-bounce">ğŸ“œ</div>' : ''}
                        <div class="text-4xl p-2 bg-black/30 rounded-full icon-box">${m.icon}</div><div class="text-left flex-1"><div class="font-black text-lg">${m.name}</div><div class="text-xs text-gray-400">${m.desc}</div></div><div class="text-2xl text-gray-600">âœ</div></div>`; 
                }); 
                const al = el('list-arenas'); al.innerHTML = ''; 
                Object.keys(ARENAS).forEach(k => { 
                    const a = ARENAS[k]; 
                    const specialClass = a.special ? 'season-gold text-yellow-100' : 'bg-white/5 border-white/5 text-gray-400'; 
                    const active = currentArena === k ? 'border-green-500 bg-green-900/20 text-white' : specialClass; 
                al.innerHTML += `<div onclick="window.game.setArena('${k}')" class="glass-panel p-3 cursor-pointer text-center ${active} active:scale-95 transition border font-bold text-xs uppercase tracking-widest relative">
                    ${a.name}
                    ${(window.QuestSystem && window.QuestSystem.hasQuest('play', {arena: k}) || window.QuestSystem.hasQuest('win', {arena: k})) ? '<div class="absolute -top-1 -right-1 text-xs animate-bounce">ğŸ“œ</div>' : ''}
                </div>`; 
                });
            },
            openHeroDetails(k) {
                const s = STARTERS[k];
                const unlocked = USER.unlocked.includes(k);
                const lvl = USER.levels[k] || 1;
                const rarity = RARITY[s.rarity] || RARITY.common;
                const rBadge = el('hd-rarity');
                if(rBadge) {
                    rBadge.innerText = rarity.name;
                    rBadge.style.backgroundColor = rarity.color;
                    rBadge.style.color = '#000'; 
                    rBadge.style.boxShadow = `0 0 10px ${rarity.color}`;
                }
                setText('hd-icon', s.icon); setText('hd-name', s.name); setText('hd-lvl', "NIVEAU " + lvl); setText('hd-desc', s.lore || s.desc); setText('hd-gadget-name', getGadgetName(s.gadget)); setText('hd-passive', s.passive || "Aucun");
                
                // NOUVEAU : Affichage des stats dÃ©taillÃ©es
                const maxHp = 600, maxDmg = 150, maxSpd = 10;
                const statsData = [
                    { label: 'SANTÃ‰', base: s.hp, scale: s.scale.hp, max: maxHp, color: 'bg-green-500' },
                    { label: 'DÃ‰GÃ‚TS', base: s.dmg, scale: s.scale.dmg, max: maxDmg, color: 'bg-red-500' },
                    // La vitesse n'augmente pas par niveau, mais on affiche sa valeur
                    { label: 'VITESSE', base: s.spd, scale: 0, max: maxSpd, color: 'bg-yellow-400' } 
                ];

                let statsHTML = '';
                const currentSpd = s.spd; // Vitesse actuelle (dÃ©jÃ  mise Ã  l'Ã©chelle dans STARTERS)
                
                statsData.forEach(stat => {
                    const rawBase = stat.base;
                    const gainText = stat.scale > 0 ? `<span class="text-green-400">(+${stat.scale}/Niv)</span>` : '';
                    let currentValue = rawBase + stat.scale * (lvl - 1);
                    
                    if (stat.label === 'VITESSE') {
                        currentValue = parseFloat(currentSpd.toFixed(2)); // Afficher la vitesse aprÃ¨s rÃ©duction
                    } else {
                        currentValue = Math.floor(currentValue);
                    }

                    const barWidth = (currentValue / stat.max) * 100;
                    
                    statsHTML += `
                        <div class="stat-row flex flex-col">
                            <div class="flex justify-between items-end mb-1">
                                <div class="stat-label text-sm text-gray-400 uppercase font-bold">${stat.label}</div>
                                <div class="text-sm font-black text-white">${currentValue} ${gainText}</div>
                            </div>
                            <div class="stat-track h-2 bg-gray-800 rounded-full overflow-hidden">
                                <div class="stat-fill h-full ${stat.color} transition-all duration-300" style="width: ${Math.min(100, barWidth)}%;"></div>
                            </div>
                        </div>
                    `;
                });
                el('hero-stats-container').innerHTML = statsHTML;
                // FIN NOUVEAU

                const skinsContainer = el('hd-skins-list');
                skinsContainer.innerHTML = '';
                if(s.skins) {
                    s.skins.forEach(skin => {
                        const fullSkinId = `${k}_${skin.id}`;
                        const isOwned = skin.id === 'default' || (USER.ownedSkins && USER.ownedSkins.includes(fullSkinId));
                        const isSelected = (USER.skins && USER.skins[k] === skin.id) || (skin.id === 'default' && !USER.skins[k]);
                        const style = isSelected ? 'border-yellow-400 bg-yellow-900/30' : (isOwned ? 'border-white/20 bg-white/5' : 'border-gray-700 bg-black/50 grayscale');
                        const priceDisplay = skin.price ? `${skin.price}ğŸª™` : 'Gratuit';
                        const actionText = isOwned ? (isSelected?'Ã‰QUIPÃ‰':'METTRE') : priceDisplay;
                        const clickAction = isOwned ? `window.ui.equipSkin('${k}', '${skin.id}')` : `window.ui.buySkin('${k}', '${skin.id}', ${skin.price})`;
                        skinsContainer.innerHTML += `<div onclick="${clickAction}" class="w-16 h-16 rounded-lg border-2 ${style} flex flex-col items-center justify-center cursor-pointer shrink-0"><div class="text-2xl" style="color:${skin.c}">${s.icon}</div><div class="text-[8px] font-bold mt-1">${actionText}</div></div>`;
                    });
                }
                
                const actions = el('hd-actions');
                if(unlocked) {
                    const upgradeCost = lvl * 150;
                    if(lvl >= 10) { actions.innerHTML = `<button onclick="window.game.setStarter('${k}'); document.getElementById('hero-details-modal').classList.add('hidden')" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl">SÃ‰LECTIONNER</button><button class="w-full max-level font-bold py-3 rounded-xl flex justify-center items-center gap-2 cursor-default border border-yellow-500/50 text-yellow-500 bg-yellow-900/20">NIVEAU MAX</button>`; }
                    else { actions.innerHTML = `<button onclick="window.game.setStarter('${k}'); window.ui.openHeroDetails('${k}')" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl">SÃ‰LECTIONNER</button><button onclick="window.ui.upgrade('${k}'); window.ui.openHeroDetails('${k}')" class="w-full bg-green-600/80 hover:bg-green-500 text-white font-bold py-3 rounded-xl flex justify-center items-center gap-2">AMÃ‰LIORER <span class="bg-black/20 px-2 rounded text-xs">${upgradeCost} ğŸª™</span></button>`; }
                } else { 
                    actions.innerHTML = `<button onclick="window.ui.unlock('${k}'); document.getElementById('hero-details-modal').classList.add('hidden')" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 rounded-xl flex justify-center items-center gap-2 text-lg">ACHETER <span class="bg-black/20 px-3 py-1 rounded text-sm">${s.price} ğŸª™</span></button>`; 
                }
                el('hero-details-modal').classList.remove('hidden');
            },
            equipSkin(heroId, skinId) { if(!USER.skins) USER.skins = {}; USER.skins[heroId] = skinId; Storage.save(); this.openHeroDetails(heroId); },
            buySkin(heroId, skinId, price) { if(USER.coins >= price) { USER.coins -= price; if(!USER.ownedSkins) USER.ownedSkins = []; USER.ownedSkins.push(`${heroId}_${skinId}`); this.notif("SKIN DÃ‰BLOQUÃ‰ !", "#facc15"); this.equipSkin(heroId, skinId); } else { this.notif("PAS ASSEZ DE PIÃˆCES !", "#ef4444"); } },
            renderProfile() { 
                el('profile-name').value = USER.name; 
                setText('profile-tag', USER.tag); 
                
                // HANDLE CUSTOM IMAGE OR EMOJI
                const avatarContainer = el('profile-avatar');
                avatarContainer.innerHTML = ''; // Clear existing content
                if(USER.avatar.startsWith('data:image')) {
                    avatarContainer.innerHTML = `<img src="${USER.avatar}" class="avatar-img rounded-full">`;
                    avatarContainer.classList.remove('text-4xl');
                } else {
                    avatarContainer.innerHTML = USER.avatar;
                    avatarContainer.classList.add('text-4xl');
                }
                
                // UPDATE QUEST TIMER
                if (USER.quests && USER.quests.lastGenerated) {
                    const diff = (USER.quests.lastGenerated + 86400000) - Date.now();
                    const qt = el('quest-timer');
                    if (qt) {
                        if (diff > 0) {
                            const hrs = Math.floor(diff / 3600000);
                            const mins = Math.floor((diff % 3600000) / 60000);
                            qt.innerText = `Reset: ${hrs}h ${mins}m`;
                        } else {
                            qt.innerText = "Disponible !";
                        }
                    }
                }
                
                let totalLvl = Object.values(USER.levels).reduce((a,b)=>a+b, 0); 
                setText('profile-lvl', "LVL " + totalLvl); 

                // RENDER QUESTS
                const renderQ = (list, id, typeList) => {
                    const c = el(id); if(!c) return; c.innerHTML = '';
                    list.forEach(q => {
                        const pct = Math.min(100, (q.progress / q.target) * 100);
                        const rIcon = q.reward.type === 'xp' ? 'â­' : (q.reward.type === 'coins' ? 'ğŸª™' : 'ğŸ’');
                        const status = q.claimed ? '<span class="text-green-500 font-bold text-xs">OUI</span>' : (q.completed ? `<button onclick="window.QuestSystem.claim('${typeList}', '${q.id}')" class="bg-green-600 hover:bg-green-500 text-white font-bold px-3 py-1 rounded text-xs animate-pulse">RÃ‰CUPÃ‰RER</button>` : `<span class="text-gray-500 text-xs">${q.progress}/${q.target}</span>`);
                        const style = q.completed ? (q.claimed ? 'border-green-900/30 opacity-50' : 'border-green-500 bg-green-900/20') : 'border-white/10 bg-black/40';
                        
                        c.innerHTML += `<div class="p-3 rounded-lg border ${style} flex justify-between items-center transition">
                            <div class="flex-1">
                                <div class="text-sm font-bold text-white mb-1">${q.desc}</div>
                                <div class="w-full h-1.5 bg-gray-800 rounded-full overflow-hidden"><div class="h-full bg-blue-500 transition-all" style="width:${pct}%"></div></div>
                            </div>
                            <div class="ml-4 flex flex-col items-end gap-1">
                                <div class="text-xs font-bold text-yellow-400">+${q.reward.val}${rIcon}</div>
                                ${status}
                            </div>
                        </div>`;
                    });
                };
                if(USER.quests) {
                    renderQ(USER.quests.daily, 'daily-quests-list', 'daily');
                    renderQ(USER.quests.season, 'season-quests-list', 'season');
                }
            },
            openAvatarSelector() { const grid = el('avatar-grid'); grid.innerHTML = ''; ICONS.forEach(icon => { grid.innerHTML += `<button onclick="window.ui.selectAvatar('${icon}')" class="w-14 h-14 text-3xl bg-white/10 hover:bg-blue-600 rounded-xl transition flex items-center justify-center border border-white/10">${icon}</button>`; }); el('avatar-selector').classList.remove('hidden'); },
            selectAvatar(icon) { USER.avatar = icon; Storage.save(); el('avatar-selector').classList.add('hidden'); this.renderProfile(); },
            
            uploadAvatar(input) {
                if (input.files && input.files[0]) {
                    const file = input.files[0];
                    if (file.size > 500000) { // Limit size to 500KB
                        this.notif("IMAGE TROP GRANDE (MAX 500KB)!", "#ef4444");
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        USER.avatar = e.target.result;
                        Storage.save();
                        window.ui.renderProfile();
                        el('avatar-selector').classList.add('hidden');
                    }
                    reader.readAsDataURL(file);
                }
            },

            renderEmotes() { 
                const list = el('list-emotes'); 
                list.innerHTML = ''; 
                const equipped = el('equipped-emotes'); 
                equipped.innerHTML = ''; 
                // FIX: La limite est maintenant Ã  8
                const maxEquipped = 8; 

                USER.equippedEmotes.forEach(id => { 
                    const e = EMOTE_LIST.find(em => em.id === id); 
                    equipped.innerHTML += `<div class="w-12 h-12 bg-black/40 rounded-lg flex items-center justify-center text-2xl border border-blue-500/50 relative group cursor-pointer" onclick="window.ui.unequipEmote('${id}')">${e?.i || 'â“'}<div class="emote-remove-btn">Ã—</div></div>`; 
                }); 
                
                // Slots vides
                for(let i=USER.equippedEmotes.length; i < maxEquipped; i++) {
                     equipped.innerHTML += `<div class="w-12 h-12 bg-gray-900/50 rounded-lg flex items-center justify-center text-xl border border-gray-700/50 text-gray-700">#${i+1}</div>`;
                }

                EMOTE_LIST.forEach(e => { 
                    const unlocked = USER.emotes.includes(e.id); 
                    const selected = USER.equippedEmotes.includes(e.id); 
                    const priceTag = unlocked ? '' : `<div class="absolute bottom-1 right-1 text-[8px] font-bold bg-black/50 px-1 rounded text-purple-400">${e.price}ğŸ’</div>`; 
                    const clickAction = unlocked ? `window.ui.equipEmote('${e.id}')` : `window.ui.buyEmote('${e.id}', ${e.price})`; 
                    list.innerHTML += `<div onclick="${clickAction}" class="emote-grid-item ${unlocked ? 'unlocked' : 'locked'} ${selected ? 'selected' : ''}">${e.i}${priceTag}</div>`; 
                }); 
            },
            unequipEmote(id) { USER.equippedEmotes = USER.equippedEmotes.filter(e => e !== id); Storage.save(); this.renderEmotes(); this.toggleEmoteWheel(); },
            equipEmote(id) { 
                const maxEquipped = 8; // La nouvelle limite
                if(USER.equippedEmotes.includes(id)) { 
                    USER.equippedEmotes = USER.equippedEmotes.filter(e => e !== id); 
                } else { 
                    if(USER.equippedEmotes.length < maxEquipped) {
                        USER.equippedEmotes.push(id); 
                    } else {
                        this.notif("SLOTS PLEINS (Max 8) !", "#ef4444"); 
                    }
                } 
                Storage.save(); this.renderEmotes(); 
            },
            buyEmote(id, price) { if(USER.gems >= price) { USER.gems -= price; USER.emotes.push(id); Storage.save(); this.notif("EMOTE DÃ‰BLOQUÃ‰E!", "#a855f7"); this.renderEmotes(); this.updateMenu(); } else { this.notif("PAS ASSEZ DE GEMMES!", "#ef4444"); } },
            toggleEmoteWheel() { const wheel = el('emote-wheel'); if(wheel.classList.contains('hidden')) { wheel.innerHTML = ''; USER.equippedEmotes.forEach(id => { const e = EMOTE_LIST.find(em => em.id === id); wheel.innerHTML += `<div onclick="window.ui.triggerEmote('${e.i}'); window.ui.toggleEmoteWheel()" class="emote-btn">${e.i}</div>`; }); wheel.classList.remove('hidden'); } else { wheel.classList.add('hidden'); } },
            triggerEmote(emoji) { window.game.player.emote = emoji; window.game.player.emoteTimer = 120; },
            updateMenu() {
                // FIX: Ensure game exists before accessing properties
                let confMode = 'survival';
                if(typeof window.game !== 'undefined' && window.game.conf && window.game.conf.mode) {
                    confMode = window.game.conf.mode;
                }
                const m = MODES[confMode] || MODES['survival'];
                
                let s = STARTERS[USER.selected];
                if (!s) {
                    // Fallback to soldier if selected hero is invalid
                    USER.selected = 'soldier';
                    s = STARTERS['soldier'];
                    Storage.save();
                }
                
                // Gestion des animations de gain (non persistantes, elles sont sur set/add)
                
                setText('top-coins', USER.coins); setText('top-gems', USER.gems); setText('menu-trophies', USER.trophies);
                let rIdx = 0; for(let i=0; i<RANKS.length; i++) { if(USER.trophies >= RANKS[i].t) rIdx = i; }
                const currRank = RANKS[rIdx], nextRank = RANKS[rIdx+1];
                const re = el('menu-rank'); if(re) { re.innerText = currRank.n; re.style.backgroundImage = `linear-gradient(to right, #fff, ${currRank.c})`; }
                if(nextRank) { const diff = nextRank.t - USER.trophies, range = nextRank.t - currRank.t, done = USER.trophies - currRank.t, pct = Math.min(100, Math.max(0, (done / range) * 100)); setText('rank-progress-text', `Encore ${diff} ğŸ† avant ${nextRank.n}`); setText('rank-progress-pct', Math.floor(pct) + '%'); setStyle('rank-progress-fill', 'width', pct + '%'); } else { setText('rank-progress-text', "RANG MAXIMUM !"); setText('rank-progress-pct', "100%"); setStyle('rank-progress-fill', 'width', '100%'); }
                setText('play-starter', s.name); setText('play-icon', s.icon); setText('play-lvl', "Niveau "+(USER.levels[USER.selected]||1));
                setText('play-mode', m.name); setText('play-mode-icon', m.icon);
                this.updateDifficultyButtons(); 
            },
            updateStats() { 
                setText('stat-kills', USER.stats.kills); 
                setText('stat-wave', USER.stats.maxWave); 
                setText('stat-games', USER.stats.games); 
                setText('stat-wins', USER.stats.wins); 
                setText('stat-dmg', Math.floor(USER.stats.dmg/1000)+"k"); 
                // Nouvelle stats
                setText('stat-losses', USER.stats.games - USER.stats.wins); // DÃ©faites
                setText('stat-unlocked', `${USER.unlocked.length}/${Object.keys(STARTERS).length}`); // HÃ©ros dÃ©bloquÃ©s (mis Ã  jour Ã  25)
                setText('stat-pass-tier', USER.stats.maxPassTier || 1); // Palier Pass Max
            },
            unlock(k) { const s = STARTERS[k]; if(USER.coins >= s.price) { USER.coins -= s.price; USER.unlocked.push(k); USER.selected = k; Storage.save(); this.notif(`DÃ‰BLOQUÃ‰!`, "#22c55e"); this.renderLists(); this.updateMenu(); } else this.notif("PAS ASSEZ!", "#ef4444"); },
            upgrade(k) { const cost = (USER.levels[k]||1) * 150; if(USER.coins >= cost) { USER.coins -= cost; USER.levels[k]++; Storage.save(); this.notif(`NIVEAU UP!`, "#3b82f6"); this.renderLists(); this.updateMenu(); } else this.notif("PAS ASSEZ!", "#ef4444"); },
            claimDaily() { 
                USER.coins += 200; 
                USER.lastDaily = Date.now(); 
                Storage.save(); 
                this.updateMenu();
                this.notif("+200 ğŸª™", "#eab308"); 
                try { el('top-coins').closest('.currency-badge').classList.add('flash-coins'); setTimeout(() => el('top-coins').closest('.currency-badge').classList.remove('flash-coins'), 300); } catch(e){}
                this.renderLists(); 
                this.renderShop(); 
            },
            buy(t, cost, curr) { let ok = false; if(curr === 'free') ok = true; else if(curr === 'coins' && USER.coins >= cost) { USER.coins -= cost; ok = true; } else if(curr === 'gems' && USER.gems >= cost) { USER.gems -= cost; ok = true; } if(ok) { if(t==='box'){ const r=Math.random(); if(r<0.8){const c=50+Math.floor(Math.random()*100);USER.coins+=c;this.notif(`+${c} ğŸª™`,"#eab308");} else{const g=2+Math.floor(Math.random()*5);USER.gems+=g;this.notif(`+${g} ğŸ’`,"#a855f7");} } else if(t==='coins') { USER.coins += 300; this.notif("+300 ğŸª™","#eab308"); } else if(t==='gems') { USER.gems += 30; this.notif("+30 ğŸ’","#a855f7"); } 
                
                // Trigger flash on manual purchase/gain
                try { if (t === 'coins') { el('top-coins').closest('.currency-badge').classList.add('flash-coins'); setTimeout(() => el('top-coins').closest('.currency-badge').classList.remove('flash-coins'), 300); } } catch(e){}
                try { if (t === 'gems') { el('top-gems').closest('.currency-badge').classList.add('flash-gems'); setTimeout(() => el('top-gems').closest('.currency-badge').classList.remove('flash-gems'), 300); } } catch(e){}
                
                Storage.save(); this.updateMenu(); this.renderShop(); } else this.notif("PAS ASSEZ!", "#ef4444"); },
            buySpecial(idx) { 
                const item = USER.shop.items[idx]; if(!item) return; 
                let ok = false; 
                const actualCost = item.realCost || item.cost; 
                
                // 1. VÃ©rification du coÃ»t et soustraction
                if(item.curr === 'free') {
                    ok = true;
                } else if(item.curr === 'coins') { 
                    if (USER.coins >= actualCost) { USER.coins -= actualCost; ok = true; }
                } else if(item.curr === 'gems') { 
                    if (USER.gems >= actualCost) { USER.gems -= actualCost; ok = true; } 
                } 

                if(ok) { 
                    // 2. Attribution de la rÃ©compense
                    // FIX: Les gains ne doivent pas Ãªtre soustraits
                    if(item.type==='gems') { 
                        USER.gems += item.val; 
                        this.notif(`+${item.val} ğŸ’`, "#a855f7"); 
                        try { el('top-gems').closest('.currency-badge').classList.add('flash-gems'); setTimeout(() => el('top-gems').closest('.currency-badge').classList.remove('flash-gems'), 300); } catch(e){} 
                    } 
                    if(item.type==='coins') { 
                        USER.coins += item.val; 
                        this.notif(`+${item.val} ğŸª™`, "#eab308"); 
                        try { el('top-coins').closest('.currency-badge').classList.add('flash-coins'); setTimeout(() => el('top-coins').closest('.currency-badge').classList.remove('flash-coins'), 300); } catch(e){} 
                    } 
                    if(item.type==='xp') { USER.pass.xp += item.val; this.notif(`+${item.val} XP`, "#facc15"); while(USER.pass.xp >= 100) { if(USER.pass.tier < 50) { USER.pass.tier++; USER.pass.xp -= 100; window.ui.notif("PASS LEVEL UP!", "#facc15"); } else { USER.pass.xp = 100; break; } } } 
                    if(item.type==='box') { this.buy('box', 0, 'free'); } 
                    if(item.type==='skin') { 
                        if(!USER.ownedSkins) USER.ownedSkins = []; 
                        const heroKey = Object.keys(STARTERS).find(k => STARTERS[k].name === item.hero); 
                        if(heroKey) { 
                            USER.ownedSkins.push(`${heroKey}_${item.skinId}`); 
                            this.notif(`SKIN ${item.name} OBTENU !`, "#facc15"); 
                        } 
                    } 
                    
                    // 3. Suppression de l'offre
                    USER.shop.items.splice(idx, 1); 
                    
                    Storage.save(); this.updateMenu(); this.renderShop(); this.renderPass(); 
                } else {
                    this.notif("PAS ASSEZ!", "#ef4444");
                }
            },
            buyPassPro() { 
                // NOUVEAU PRIX PASS PRO (159)
                if(USER.gems >= 159) { 
                    USER.gems -= 159; 
                    USER.mPassPro = true; 
                    this.notif("PASS PRO ACTIVÃ‰ !", "#facc15"); 
                    el('top-gems').closest('.currency-badge').classList.add('flash-gems'); setTimeout(() => el('top-gems').closest('.currency-badge').classList.remove('flash-gems'), 300);
                    Storage.save(); 
                    this.updateMenu(); 
                    this.renderPass(); 
                } else { 
                    this.notif("PAS ASSEZ DE GEMMES ! (159 ğŸ’)", "#ef4444"); 
                } 
            },
            claimPass(tier, isPro, rewardString) { const hasPass = isPro ? USER.mPassPro : true; const alreadyClaimed = isPro ? USER.pass.claimedPro.includes(tier) : USER.pass.claimed.includes(tier); if(USER.pass.tier >= tier && hasPass && !alreadyClaimed) { if (processPassReward(rewardString)) { if(isPro) USER.pass.claimedPro.push(tier); else USER.pass.claimed.push(tier); Storage.save(); this.renderPass(); this.updateMenu(); } else { this.notif("Erreur RÃ©compense", "#ff0000"); } } },
            exportSave() { const data = btoa(JSON.stringify(USER)); navigator.clipboard.writeText(data).then(() => this.notif("CODE COPIÃ‰ !", "#22c55e")); },
            importSave() { 
                const code = prompt("Colle ton code de sauvegarde ici:"); 
                if(code) { 
                    try { 
                        const data = JSON.parse(atob(code)); 
                        // Simple structure check
                        if(data && data.name && data.coins !== undefined) {
                            USER = data; 
                            Storage.save(); 
                            location.reload(); 
                        } else {
                            this.notif("CODE INVALIDE !", "#ef4444");
                        }
                    } catch(e) { 
                        this.notif("CODE INVALIDE !", "#ef4444"); 
                    } 
                } 
            }
        };

        const Input={k:{},jL:{a:0,x:0,y:0,i:null},jR:{a:0,x:0,y:0,i:null},m:{x:0,y:0,d:0},init(){ 
            window.addEventListener('keydown',e=>{this.k[e.code]=1;if(e.code==='Space')window.game.player?.dash();if(e.code==='KeyE')window.game.player?.useGadget();if(e.code==='KeyV'){window.ui.toggleEmoteWheel();}}); 
            window.addEventListener('keyup',e=>this.k[e.code]=0); 
            window.addEventListener('mousemove',e=>{this.m.x=e.clientX;this.m.y=e.clientY;}); 
            window.addEventListener('mousedown',()=>this.m.d=1); 
            window.addEventListener('mouseup',()=>this.m.d=0); 
            const z=el('mobile-controls'); 
            const leftBase = el('stick-left-base');
            const rightBase = el('stick-right-base');
            
            // Calculate base centers for touch processing
            const getCenter = (el) => {
                const rect = el.getBoundingClientRect();
                return { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 };
            };

            const h=(e, isEnd)=>{ 
                if(e.target.tagName !== 'BUTTON') e.preventDefault(); 
                let lf=false, rf=false; 
                const W=window.innerWidth;
                const L_CENTER = getCenter(leftBase);
                const R_CENTER = getCenter(rightBase);

                for(let i=0;i<e.touches.length;i++){ 
                    const t=e.touches[i],x=t.clientX,y=t.clientY; 
                    
                    // Check if touch is near the left joystick area
                    if(Math.hypot(x - L_CENTER.x, y - L_CENTER.y) < 150) { 
                        lf=true; 
                        const d=Math.min(60, Math.hypot(x-L_CENTER.x, y-L_CENTER.y)); 
                        const a=Math.atan2(y-L_CENTER.y, x-L_CENTER.x); 
                        const k=document.querySelector('#stick-left-base .stick-knob'); 
                        if(k) k.style.transform=`translate(-50%,-50%) translate(${Math.cos(a)*d}px,${Math.sin(a)*d}px)`; 
                        if(d>5){ 
                            this.jL.x=Math.cos(a)*d/60; 
                            this.jL.y=Math.sin(a)*d/60; 
                            this.jL.a=1; 
                        } 
                    }
                    
                    // Check if touch is near the right joystick/action area
                    if(Math.hypot(x - R_CENTER.x, y - R_CENTER.y) < 150) { 
                        rf=true; 
                        const d=Math.min(60, Math.hypot(x-R_CENTER.x, y-R_CENTER.y)); 
                        const a=Math.atan2(y-R_CENTER.y, x-R_CENTER.x); 
                        const k=document.querySelector('#stick-right-base .stick-knob'); 
                        if(k) k.style.transform=`translate(-50%,-50%) translate(${Math.cos(a)*d}px,${Math.sin(a)*d}px)`; 
                        if(d>5){ 
                            this.jR.x=Math.cos(a)*d/60; 
                            this.jR.y=Math.sin(a)*d/60; 
                            this.jR.a=1; 
                        } 
                    }
                } 
                if(!lf){ 
                    this.jL.x=0;this.jL.y=0;this.jL.a=0; 
                    const k=document.querySelector('#stick-left-base .stick-knob'); 
                    if(k) k.style.transform=`translate(-50%,-50%)`; 
                } 
                if(!rf){ 
                    this.jR.x=0;this.jR.y=0;this.jR.a=0; 
                    const k=document.querySelector('#stick-right-base .stick-knob'); 
                    if(k) k.style.transform=`translate(-50%,-50%)`; 
                } 
            }; 
            z.addEventListener('touchstart',e=>h(e,false),{passive:false}); 
            z.addEventListener('touchmove',e=>h(e,false),{passive:false}); 
            z.addEventListener('touchend',e=>h(e,true)); 
        }};
        class Entity{constructor(x,y,r,c){this.x=x;this.y=y;this.r=r;this.c=c;this.dead=false; this.hitTimer = 300;} draw(ctx){ ctx.save(); ctx.translate(this.x, this.y); let isHidden = false; if (window.game.map) { for(let w of window.game.map) { if(w.type === 1 && ColRect(this, w)) { isHidden = true; break; } } } if(isHidden && this === window.game.player) { ctx.fillStyle = 'rgba(255, 255, 255, 0.8)'; ctx.font = "20px Arial"; ctx.fillText("ğŸ‘ï¸", -10, -this.r - 10); ctx.beginPath(); ctx.moveTo(-10, -this.r - 5); ctx.lineTo(10, -this.r - 25); ctx.strokeStyle = 'red'; ctx.lineWidth = 2; ctx.stroke(); } if(isHidden) ctx.globalAlpha = 0.5; ctx.shadowColor = 'rgba(0,0,0,0.5)'; ctx.shadowBlur = 15; ctx.beginPath(); ctx.arc(0, 0, this.r, 0, Math.PI*2); ctx.fillStyle = this.c; ctx.fill(); ctx.shadowBlur = 0; ctx.beginPath(); ctx.arc(-5, -5, this.r*0.3, 0, Math.PI*2); ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.fill(); ctx.globalAlpha = 1; if(this.emoteTimer > 0) { ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(0, -this.r - 30, 20, 0, Math.PI*2); ctx.fill(); ctx.font = "24px Arial"; ctx.fillStyle = 'black'; ctx.textAlign = 'center'; ctx.fillText(this.emote, 0, -this.r - 22); this.emoteTimer--; } ctx.restore(); }}
        class Wall{constructor(x,y,w,h,t){this.x=x;this.y=y;this.w=w;this.h=h;this.type=t;} draw(ctx,c){ 
            // Ambiance ombre sous les murs
            ctx.save();
            ctx.fillStyle = '#0f172a'; ctx.fillRect(this.x, this.y + this.h, this.w, 20); // Ombre portÃ©e
            ctx.fillStyle = c; 
            ctx.shadowColor = 'black'; ctx.shadowBlur = 10; 
            ctx.fillRect(this.x, this.y, this.w, this.h); 
            ctx.shadowBlur = 0; 
            ctx.fillStyle = 'rgba(255,255,255,0.05)'; 
            ctx.fillRect(this.x, this.y, this.w, 5);
            ctx.restore();
            
            if(this.type===1){
                ctx.fillStyle='rgba(34,197,94,0.9)';
                ctx.strokeStyle='#15803d';ctx.lineWidth=4;ctx.strokeRect(this.x,this.y,this.w,this.h);
                // Rendu des buissons plus vifs
                ctx.fillStyle='rgba(34,197,94,0.7)';
                ctx.fillRect(this.x,this.y,this.w,this.h);
                return;
            } 
            const h = 20; 
            ctx.fillStyle = '#0f172a'; 
            ctx.fillRect(this.x, this.y + this.h, this.w, h); 
            ctx.fillStyle = c; 
            ctx.shadowColor = 'black'; 
            ctx.shadowBlur = 10; 
            ctx.fillRect(this.x, this.y, this.w, this.h); 
            ctx.shadowBlur = 0; 
            ctx.fillStyle = 'rgba(255,255,255,0.05)'; 
            ctx.fillRect(this.x, this.y, this.w, 5); 
        } 
        collide(e){return e.x+e.r>this.x&&e.x-e.r<this.x+this.w&&e.y+e.r>this.y&&e.y-e.r<this.y+this.h;}}
        class Player extends Entity{ constructor(k){ 
            const s=STARTERS[k], l=(USER.levels[k]||1)-1; 
            let c = s.color; 
            if(USER.skins && USER.skins[k]) { const skinId = USER.skins[k]; const heroSkinList = STARTERS[k]?.skins; if(skinId !== 'default' && heroSkinList) { const skinObj = heroSkinList.find(sk => sk.id === skinId); if(skinObj) c = skinObj.c; } } 
            super(window.game.world/2,window.game.world/2,20,c); 
            this.stats={...s}; 
            this.stats.hp+=s.scale.hp*l; 
            this.stats.dmg+=s.scale.dmg*l; 
            this.hp=this.stats.hp; 
            this.maxHp=this.stats.hp; 
            this.xp=0;this.xpMax=100;this.lvl=1;this.super=0;this.cd=0;this.dashT=0;this.angle=0;
            // FIX 1: Initialize ammo based on hero stats
            this.ammo=s.ammo;
            this.ammoMax=s.ammo;
            this.reloadT=0;this.gadgetCharges=3;this.cubes=0; 
            this.activeEffects={}; 
            this.isStunned = 0;
            this.passiveTimer = 0; // Timer pour les passifs pÃ©riodiques (Shaman)
            this.hitTimer = 300; // FIX 2: Timer de rÃ©gÃ©nÃ©ration

            if(window.game.conf.modifier === 'giant') { this.r *= 2; this.maxHp *= 2; this.hp *= 2; }
            if(window.game.conf.modifier === 'oneshot') { this.hp = 1; this.maxHp = 1; } // Force One Shot HP
            this.invisible = 0; // New Invisible state
        } 
        update(){ 
            if (this.isStunned > 0) { this.isStunned--; return; } // Stunned = skip update
            this.hitTimer++; // IncrÃ©menter le timer de non-hit
            
            let speedMult = 1; 
            if(this.activeEffects.speed > 0) { speedMult = 1.5; this.activeEffects.speed--; } 
            if(window.game.conf.modifier === 'speed') speedMult *= 2; 

            // FIX 2: RÃ©gÃ©nÃ©ration HP aprÃ¨s 5s sans dÃ©gÃ¢ts (hitTimer > 300 frames)
            if(this.stats.passive === "Regen Rapide" && window.game.frame % 60 === 0 && this.hitTimer > 300 && window.game.conf.modifier !== 'oneshot') {
                this.hp = Math.min(this.maxHp, this.hp + 50); 
            }
            
            let dx=0,dy=0; 
            if(Input.jL.a){dx=Input.jL.x;dy=Input.jL.y;} else {if(Input.k['KeyW'])dy=-1;if(Input.k['KeyS'])dy=1;if(Input.k['KeyA'])dx=-1;if(Input.k['KeyD'])dx=1;} 
            const l=Math.hypot(dx,dy); 
            // Vitesse de base ajustÃ©e (base 5.5, ici *1.1 pour un meilleur feeling global)
            const actualSpd = this.stats.spd * speedMult * 1.1; 

            if(l>0.1){if(l>1){dx/=l;dy/=l;} this.move(dx*actualSpd, dy*actualSpd); 
                // Nouvelle fonctionnalitÃ©: TraÃ®nÃ©e de mouvement (Particules)
                if (window.game.frame % 2 === 0) {
                    window.game.parts.push({ x: this.x, y: this.y, vx: -dx * 0.5, vy: -dy * 0.5, life: 10, c: this.c, r: 2 });
                }
            } 
            
            if(Input.jR.a){this.angle=Math.atan2(Input.jR.y,Input.jR.x);if(Math.hypot(Input.jR.x,Input.jR.y)>0.5)this.shoot();} 
            else {const wx=Input.m.x+window.game.cam.x, wy=Input.m.y+window.game.cam.y;this.angle=Math.atan2(wy-this.y,wx-this.x);if(Input.m.d)this.shoot();} 
            
            if(this.cd>0)this.cd--; 
            if(this.dashT>0)this.dashT--; 

            // PASSIVE DU SHAMAN : Poison Aura (Feature 2)
            if (this.stats.passive === "Poison Aura") {
                this.passiveTimer++;
                if (this.passiveTimer >= 30) { // Toutes les 0.5 secondes
                    this.passiveTimer = 0;
                    window.game.ents.forEach(e => {
                        if (!e.friend && Dist(this, e) < 150) {
                            e.hp -= 5;
                            e.hitTimer = 0;
                            e.flashColor = '#10b981'; e.flashTimer = 5;
                            window.game.parts.push({x:e.x,y:e.y,vx:Rnd(-2,2),vy:Rnd(-2,2),life:10,c:'#10b981',r:2});
                            if(e.hp<=0 && !e.dead) window.game.kill(e);
                        }
                    });
                }
            }

            if(this.ammo<this.ammoMax){this.reloadT++;if(this.reloadT>this.stats.reload){this.ammo++;this.reloadT=0;}} 
            // FIX 2: RÃ©gÃ©nÃ©ration gÃ©nÃ©rale aprÃ¨s 5s sans dÃ©gÃ¢ts
            if(window.game.frame%60===0 && this.hp<this.maxHp && this.hitTimer > 300 && window.game.conf.modifier !== 'oneshot') this.hp+=this.maxHp*0.05; 
            
            if(window.game.gasRadius && Dist(this, {x:window.game.world/2, y:window.game.world/2}) > window.game.gasRadius) { this.hp -= 10; this.hitTimer = 0; window.ui.flash(); if(this.hp<=0) window.game.over("TuÃ© par le Gaz"); } 
            if(this.activeEffects.poison > 0) { this.hp -= 1; this.activeEffects.poison--; this.hitTimer = 0; if(this.hp<=0) window.game.over("EmpoisonnÃ©"); } 
        } move(dx,dy){const nx=this.x+dx,ny=this.y+dy;let cx=0,cy=0;for(let w of window.game.map){if(w.type===1)continue;if(w.collide({x:nx,y:this.y,r:this.r}))cx=1;if(w.collide({x:this.x,y:ny,r:this.r}))cy=1;}if(!cx)this.x=Math.max(this.r,Math.min(window.game.world-this.r,nx));if(!cy)this.y=Math.max(this.r,Math.min(window.game.world-this.r,ny));} shoot(){ 
            window.game.shake = 2;
            const selectedHero = STARTERS[USER.selected];
            if (selectedHero.name === 'Harpy' && this.cd > 0) {
                 // Harpy a un CD trÃ¨s court (7), pas besoin de bloquer s'il est bas
            } else if(this.cd>0 || (this.ammo<1 && window.game.conf.modifier !== 'infinite')) {
                return;
            } 

            const pStats = selectedHero.proj;
            
            // Les hÃ©ros au corps-Ã -corps ont une gestion spÃ©ciale du CD et des munitions
            if (selectedHero.type === 'melee') {
                this.cd = this.stats.rate; 
                // Le projectile corps-Ã -corps a une vie trÃ¨s courte (1 frame)
                window.game.projs.push({
                    x: this.x + Math.cos(this.angle) * 25, y: this.y + Math.sin(this.angle) * 25,
                    vx: 0, vy: 0, dmg: this.stats.dmg * (1 + this.cubes * 0.1), life: 1,
                    r: pStats.r, c: pStats.color, friend: true, shape: pStats.shape, trailColor: pStats.trailColor, melee: true
                });
                return;
            }

            this.cd = this.stats.rate; 
            if(window.game.conf.modifier !== 'infinite') this.ammo--; 
            this.reloadT = -20; 
            
            const cnt = selectedHero.type === 'shotgun' ? 5 : 1; 
            const spr = selectedHero.type === 'shotgun' ? 0.3 : 0.05; // Spread uniquement pour les shotguns
            
            let dmg = this.stats.dmg * (1 + this.cubes * 0.1);
            let isCrit = this.stats.passive === "Critique +10%" && Math.random() < 0.1;

            if (isCrit) {
                dmg *= 1.5; // DÃ©gÃ¢ts critiques +50%
            }
            
            if(window.game.conf.modifier === 'recoil') { this.move(Math.cos(this.angle + Math.PI) * 15, Math.sin(this.angle + Math.PI) * 15); }

            for(let i=0;i<cnt;i++){ 
                const a=this.angle+(Math.random()-0.5)*spr+(i-(cnt-1)/2)*0.1;
                
                window.game.projs.push({
                    x: this.x + Math.cos(this.angle) * 25,
                    y: this.y + Math.sin(this.angle) * 25,
                    vx: Math.cos(a) * pStats.speed,
                    vy: Math.sin(a) * pStats.speed,
                    dmg: dmg,
                    life: pStats.life,
                    r: pStats.r,
                    c: pStats.color,
                    friend: true, 
                    isCrit: isCrit,
                    shape: pStats.shape, // NOUVEAU
                    trailColor: pStats.trailColor // NOUVEAU
                }); 
            } 
        } dash(){ if(this.dashT>0)return; this.dashT=60; window.game.shake=10; const stepSize = 20; const totalDist = 180; const steps = totalDist / stepSize; const dx = Math.cos(this.angle) * stepSize; const dy = Math.sin(this.angle) * stepSize; for(let i=0; i<steps; i++) { this.move(dx, dy); } for(let i=0;i<8;i++)window.game.parts.push({x:this.x,y:this.y,vx:(Math.random()-0.5)*5,vy:(Math.random()-0.5)*5,life:20,c:'#fff',r:4}); } useGadget() { 
            if(this.gadgetCharges <= 0) return; 
            this.gadgetCharges--; 
            window.ui.notif("GADGET!", "#22c55e"); 
            const t=this.stats.gadget; 
            
            if(t==="heal") { 
                if(window.game.conf.modifier === 'oneshot') { window.ui.notif("SOIN IMPOSSIBLE (ONE SHOT)", "#ef4444"); this.gadgetCharges++; return; }
                this.hp=Math.min(this.maxHp,this.hp+1000); for(let i=0;i<10;i++)window.game.parts.push({x:this.x,y:this.y,vx:Rnd(-2,2),vy:Rnd(-2,2),life:30,c:'#22c55e',r:3}); 
            } 
            if(t==="shield") { 
                if(window.game.conf.modifier === 'oneshot') { window.ui.notif("BOUCLIER IMPOSSIBLE", "#ef4444"); this.gadgetCharges++; return; }
                this.maxHp+=1000; this.hp+=1000; 
            } 
            if(t==="teleport") { let tx=this.x+Math.cos(this.angle)*300, ty=this.y+Math.sin(this.angle)*300; let cx=false; for(let w of window.game.map){ if(w.type!==1 && w.collide({x:tx,y:ty,r:this.r})) cx=true; } if(!cx) { this.x=tx; this.y=ty; } else window.ui.notif("BLOQUÃ‰ !", "#ef4444"); } 
            if(t==="speed") { this.activeEffects.speed = 180; } 
            if(t==="knockback") { for(let e of window.game.ents) { let d = Dist(this, e); if(d < 300) { let a = Math.atan2(e.y-this.y, e.x-this.x); e.x += Math.cos(a)*200; e.y += Math.sin(a)*200; } } } 
            // Feature 8: Nouveau Gadget 'stun'
            if(t==="stun") {
                for(let e of window.game.ents) {
                    if(Dist(this, e) < 300) { 
                        e.isStunned = 120; 
                        window.game.parts.push({x:e.x,y:e.y,vx:Rnd(-2,2),vy:Rnd(-2,2),life:30,c:'#facc15',r:5}); 
                    }
                }
            }
            if(t==="invis") { this.invisible = 180; window.ui.notif("INVISIBLE !", "#94a3b8"); }
        } draw(ctx){ 
            ctx.save(); 
            ctx.shadowColor = this.c; ctx.shadowBlur = 20; 
            
            // Si le joueur est stun, montrer un effet visuel
            if (this.isStunned > 0) {
                 ctx.shadowColor = '#facc15'; 
                 ctx.shadowBlur = 30;
            }
            if (this.invisible > 0) ctx.globalAlpha = 0.4; else ctx.globalAlpha = 1;
            
            super.draw(ctx); 
            ctx.translate(this.x,this.y); 
            ctx.rotate(this.angle); 
            ctx.fillStyle='#1e293b'; 
            ctx.fillRect(10,-6,28,12); 
            if(this.reloadT > 0 && window.game.conf.modifier !== 'infinite') { 
                ctx.rotate(-this.angle); 
                ctx.fillStyle = 'white'; 
                ctx.fillRect(-15, 30, 30 * (this.reloadT/this.stats.reload), 3); 
            } 
            ctx.restore(); 
        } }
        class Bot extends Player{ 
            constructor(){ 
                super(USER.selected==='soldier'?'tank':'soldier'); 
                this.c='#ef4444'; 
                this.isBot=true; 
                this.x=100; 
                this.y=100; 
                this.mode='CHASE'; 
                this.target=null; 
                this.isStunned = 0; // Ajout du stun
                this.hitTimer = 300; 
                // Buff PV
                this.hp += ENEMY_HP_BUFF;
                this.maxHp += ENEMY_HP_BUFF;
                
                // Difficulty Scaling for Bots
                const diffMult = DIFFICULTY[window.game.conf.difficulty].mult;
                this.hp *= diffMult;
                this.maxHp *= diffMult;
                this.stats.dmg *= diffMult;
                // Vitesse lÃ©gÃ¨rement augmentÃ©e en difficultÃ© supÃ©rieure
                this.stats.spd *= (1 + (diffMult - 1) * 0.3);

                if(window.game.conf.modifier === 'oneshot') { this.hp = 1; this.maxHp = 1; }
            } 
            update(){ 
                if (this.isStunned > 0) { this.isStunned--; return; } // Stunned = skip update
                this.hitTimer++; // IncrÃ©menter le timer de non-hit
                
                if(this.cd>0)this.cd--; 
                const p=window.game.player, d=Dist(this,p); 
                this.angle=Math.atan2(p.y-this.y,p.x-this.x); 
                let playerHidden = false; 
                // Fix Vision
                const distV = Math.hypot(p.x - this.x, p.y - this.y);
                const stepsV = Math.min(10, Math.floor(distV / 50));
                for(let i = 1; i < stepsV; i++) {
                    const cx = this.x + (p.x - this.x) * (i / stepsV);
                    const cy = this.y + (p.y - this.y) * (i / stepsV);
                    for(let w of window.game.map) {
                        if(w.type !== 1 && ColRect({x:cx, y:cy, r:5}, w)) {
                            playerHidden = true;
                            break;
                        }
                    }
                    if(playerHidden) break;
                } 

                if (window.game.player.invisible > 0) playerHidden = true; // Bot can't see invisible player
                
                // Logique de tir
                if(d < 500 && !playerHidden && this.cd <= 0) {
                    this.shoot();
                } else if(this.mode === 'CHASE' && Math.random()<0.05) {
                    this.shoot();
                }
                
                // Logique de Mouvement (IA AmÃ©liorÃ©e)
                let tx,ty; 
                if(this.mode==='CHASE'){ 
                    // Logique d'Esquive/Strafe (IA 2.0)
                    let strafe = Math.sin(window.game.frame * 0.08) * 150; // Strafe plus prononcÃ©
                    tx = p.x + Math.cos(this.angle + Math.PI/2) * strafe; 
                    ty = p.y + Math.sin(this.angle + Math.PI/2) * strafe; 
                } else if(this.mode==='CHASE_TRAIN') {
                    tx = this.target.x; ty = this.target.y;
                } else { 
                    if(window.game.conf.mode === 'duel') { 
                        if(!this.target || Dist(this,this.target)<50) this.target={x:window.game.world/2 + Rnd(-300,300), y:window.game.world/2 + Rnd(-300,300)};
                    } else {
                        // Feature 5: Ramassage Rapide (le bot aussi ramasse)
                        let item = window.game.items.find(i => Dist(this, i) < 300); 
                        if(item) { this.target = item; } 
                        else if(!this.target || Dist(this,this.target)<50 || Math.random()<0.02) { this.target={x:Rnd(100,window.game.world-100), y:Rnd(100,window.game.world-100)}; }
                    }
                    tx=this.target.x; ty=this.target.y; 
                } 
                const a=Math.atan2(ty-this.y, tx-this.x); 
                let speed = this.stats.spd * 0.96; 
                if(window.game.conf.modifier === 'speed') speed *= 2; 
                
                this.move(Math.cos(a)*speed, Math.sin(a)*speed); 
                if(Math.random()<0.01) this.dash(); 
                // FIX 2: RÃ©gÃ©nÃ©ration HP aprÃ¨s 5s sans dÃ©gÃ¢ts (bots aussi)
                if(window.game.frame%60===0 && this.hp<this.maxHp && this.hitTimer > 300 && window.game.conf.modifier !== 'oneshot')this.hp += Math.max(1, Math.floor(this.maxHp * 0.01)); 
                if(window.game.gasRadius && Dist(this, {x:window.game.world/2, y:window.game.world/2}) > window.game.gasRadius) this.hp -= 10; 
                if(this.activeEffects.poison > 0) { this.hp -= 1; this.activeEffects.poison--; } 
            } 
            shoot(){ 
                if(this.cd>0)return; 
                this.cd=Math.ceil(20 * RATE_FACTOR); // Appliquer le facteur de tir aux bots
                window.game.projs.push({x:this.x,y:this.y,vx:Math.cos(this.angle)*15*1.08,vy:Math.sin(this.angle)*15*1.08,dmg:10,life:60,r:6,c:this.c,friend:false, shape: 'circle', trailColor: this.c}); // Bot uses simple projectile
            } 
        }
        class Enemy extends Entity{ constructor(t,m=1){ const diffMult = DIFFICULTY[window.game.conf.difficulty].mult; const enemyMult = m * diffMult; super(0,0,20,'#ef4444'); let safe=false; while(!safe){ this.x=Rnd(100,window.game.world-100);this.y=Rnd(100,window.game.world-100); let wallCol = false; for(let w of window.game.map) { if(w.type!==1 && w.collide({x:this.x, y:this.y, r:this.r})) wallCol=true; } if(!wallCol && Dist(this,window.game.player)>600) safe=true; } this.type=t; let hp=60,s=2.0, dmg=1; 
            // Vitesse des ennemis ajustÃ©e par le facteur global
            s = s * SPEED_FACTOR;
            
            // Feature 1: Mini-Boss stats pour vagues 3 et 6
            if(t==='fast'){hp=40;s=4.0 * SPEED_FACTOR;this.c='#f97316';this.r=15;} 
            if(t==='tank'){hp=200;s=1.2 * SPEED_FACTOR;this.c='#7e22ce';this.r=30;} 
            if(t==='mini_boss'){hp=1000;s=2.5 * SPEED_FACTOR;this.c='#facc15';this.r=40;this.isBoss=true;this.cd=Math.ceil(100*RATE_FACTOR); dmg=2; this.name = "MINI BOSS";}
            if(t==='boss'){hp=5000;s=1.5 * SPEED_FACTOR;this.c='#dc2626';this.r=60;this.isBoss=true;this.cd=Math.ceil(0*RATE_FACTOR); dmg=3;} 
            if(t==='chest'){hp=5000;s=0;this.c='#facc15';this.r=40;this.isBoss=true;} 
            if(t==='train'){hp=10000;s=1.0 * SPEED_FACTOR;this.c='#3b82f6';this.r=30;this.type='train';} 
            if(t==='terminal'){hp=5000;s=0;this.c='#22d3ee';this.r=40;this.type='terminal';}

            // AJOUT: +20PV de base aux ennemis/bots
            hp += ENEMY_HP_BUFF;

            if(window.game.conf.modifier === 'giant') { this.r *= 2; hp *= 2; s *= 0.8; }
            if(window.game.conf.modifier === 'oneshot') { hp = 1; }

            this.hp=hp * enemyMult; 
            
            // Apply Speed Scaling specifically for difficulty (since enemyMult handles HP/DMG based on diffMult)
            // Note: enemyMult = m * diffMult. 
            // So hp and dmg are already scaled by diffMult.
            // But 's' (speed) was not.
            const diffSpeedMult = 1 + (diffMult - 1) * 0.3;
            
            this.maxHp=this.hp; 
            this.spd=s * 0.85 * diffSpeedMult; 
            this.baseDmg = dmg * enemyMult; 
            // Application du facteur de tir sur le CD
            this.cd = Math.ceil((100 + Math.random() * 100) * RATE_FACTOR); 
            
            if(this.isBoss) this.name = t === 'boss' ? 'BOSS' : (t === 'mini_boss' ? 'MINI BOSS' : (t === 'chest' ? 'COFFRE' : t.toUpperCase())); else this.name = `Bot nÂ°${Math.floor(Math.random() * 89999) + 10000}`; this.activeEffects = {}; 
            this.isStunned = 0; // Ajout du stun
            this.flashTimer = 0; // Timer pour le flash de dÃ©gÃ¢t
            this.flashColor = null; // Couleur du flash
            this.hitTimer = 300; // FIX 2: Timer de rÃ©gÃ©nÃ©ration
        } 
        update(){ 
            if (this.isStunned > 0) { this.isStunned--; return; } // Stunned = skip update
            this.hitTimer++; // IncrÃ©menter le timer de non-hit

            if(this.spd === 0) return; const p=window.game.player; 
            let sepX = 0, sepY = 0; 
            for(let other of window.game.ents) { 
                if(other !== this) { 
                    let d = Dist(this, other); 
                    if(d < this.r * 2.5 && d > 0) { 
                        let ang = Math.atan2(this.y - other.y, this.x - other.x); 
                        sepX += Math.cos(ang); sepY += Math.sin(ang); 
                    } 
                } 
            } 
            
            if (this.type === 'basic' || this.type === 'fast' || this.type === 'tank' || this.type === 'mini_boss' ) { 
                if (this.cd > 0) this.cd--; 
                // IA 2.0 : Attaque les ennemis proches s'ils sont Ã  portÃ©e
                if (this.cd <= 0 && Dist(this, p) < 400) { 
                    const a = Math.atan2(p.y - this.y, p.x - this.x); 
                    window.game.projs.push({ x: this.x, y: this.y, vx: Math.cos(a) * 3 * 1.08, vy: Math.sin(a) * 3 * 1.08, dmg: 10 * DIFFICULTY[window.game.conf.difficulty].mult, life: 100, r: 6, c: this.c, friend: false, shape: 'circle', trailColor: this.c }); 
                    this.cd = Math.ceil(150 * RATE_FACTOR); 
                } 
            } 

            if(this.type === 'boss' || this.type === 'mini_boss') { 
                const d = Dist(this, p); 
                const a = Math.atan2(p.y - this.y, p.x - this.x); 
                this.x += Math.cos(a) * this.spd; 
                this.y += Math.sin(a) * this.spd; 
                if(this.cd > 0) this.cd--; 
                if(this.cd <= 0 && d < 800) { 
                    this.cd = Math.ceil(60 * RATE_FACTOR); 
                    window.game.projs.push({ x: this.x, y: this.y, vx: Math.cos(a) * 2.5 * 1.08, vy: Math.sin(a) * 2.5 * 1.08, dmg: 40 * DIFFICULTY[window.game.conf.difficulty].mult, life: 200, r: 20, c: '#ef4444', friend: false, shape: 'circle', trailColor: '#dc2626' }); 
                } 
            } else { 
                let playerHidden = false; 
                // Fix Vision
                const distV = Math.hypot(p.x - this.x, p.y - this.y);
                const stepsV = Math.min(10, Math.floor(distV / 50));
                for(let i = 1; i < stepsV; i++) {
                    const cx = this.x + (p.x - this.x) * (i / stepsV);
                    const cy = this.y + (p.y - this.y) * (i / stepsV);
                    for(let w of window.game.map) {
                        if(w.type !== 1 && ColRect({x:cx, y:cy, r:5}, w)) {
                            playerHidden = true;
                            break;
                        }
                    }
                    if(playerHidden) break;
                }
                if (window.game.player.invisible > 0) playerHidden = true; // Enemy can't see invisible player
                
                let tx, ty; 
                if(playerHidden && Dist(this, p) > 150) { 
                    if(!this.target || Dist(this,this.target)<50 || Math.random()<0.01) this.target={x:Rnd(100,window.game.world-100), y:Rnd(100,window.game.world-100)}; 
                    tx=this.target.x; ty=this.target.y; 
                } else { 
                    tx=p.x; ty=p.y; 
                } 
                const a=Math.atan2(ty-this.y, tx-this.x); 
                let speed = this.spd; 
                if(window.game.conf.modifier === 'speed') speed *= 2; 
                let mx = Math.cos(a)*speed + sepX*0.5; 
                let my = Math.sin(a)*speed + sepY*0.5; 
                const nx=this.x+mx, ny=this.y+my; 
                let cx=false, cy=false; 
                for(let w of window.game.map){if(w.type===1)continue; if(w.collide({x:nx,y:this.y,r:this.r}))cx=true;if(w.collide({x:this.x,y:ny,r:this.r}))cy=true;} 
                if(!cx)this.x=nx;if(!cy)this.y=ny; 
            } 
            if(Math.hypot(this.x-p.x,this.y-p.y)<this.r+p.r){
                let dmg = this.baseDmg;
                if(window.game.conf.modifier === 'fragile') dmg *= 2; // Fragile = Double DÃ©gÃ¢ts subis
                p.hp -= dmg; 
                p.hitTimer = 0; window.ui.flash();if(window.game.conf.modifier === 'oneshot') p.hp = 0; if(p.hp<=0)window.game.over("TuÃ© par "+this.name);
            } 
            if(this.activeEffects.poison > 0) { this.hp -= 1; this.activeEffects.poison--; this.hitTimer = 0; } 
            
            // FIX 2: RÃ©gÃ©nÃ©ration HP aprÃ¨s 5s sans dÃ©gÃ¢ts
            if(window.game.frame%60===0 && this.hp<this.maxHp && this.hitTimer > 300 && window.game.conf.modifier !== 'oneshot') this.hp += Math.max(1, Math.floor(this.maxHp * 0.01));

            if (this.flashTimer > 0) this.flashTimer--;
        } 
        draw(ctx){ 
            if(this.flashTimer > 0 && this.flashColor) {
                ctx.save();
                ctx.globalAlpha = 0.8;
                ctx.fillStyle = this.flashColor;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.r * 1.2, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }

            if(this.isBoss){
                ctx.beginPath();ctx.arc(this.x,this.y,this.r+5,0,Math.PI*2);
                ctx.strokeStyle=this.type==='chest'?'#facc15':'#ef4444';
                ctx.setLineDash([5,5]);ctx.stroke();ctx.setLineDash([]);
            } 
            super.draw(ctx); 
            const pct=this.hp/this.maxHp; 
            ctx.save(); 
            ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(this.x-20,this.y-this.r-15,40,6); 
            ctx.fillStyle=this.isBoss?'#ef4444':'#22c55e';
            
            // Si le bot est stun, couleur de la barre de vie en jaune
            if (this.isStunned > 0) ctx.fillStyle = '#facc15';

            ctx.fillRect(this.x-19,this.y-this.r-14,38*pct,4); 
            ctx.restore(); 
        } 
        }
        class Train extends Entity {
            constructor() {
                super(100, window.game.world/2, 30, '#3b82f6');
                this.hp = 20000; this.maxHp = 20000; this.type = 'train';
                this.angle = 0;
            }
            update() {
                // Move constantly to the right/across (vitesse du train rÃ©duite de 13%)
                this.x += 1 * SPEED_FACTOR;
                if(this.x > window.game.world - 100) {
                    this.x = 100; // Loop or just end? Let's loop for defense duration
                }
                // Visual smoke
                if(Math.random()<0.3) {
                    window.game.parts.push({x:this.x-30,y:this.y,vx:-2,vy:(Math.random()-0.5),life:40,c:'#555',r:5});
                }
            }
            draw(ctx) {
                super.draw(ctx);
                // Health bar
                const pct=this.hp/this.maxHp;
                ctx.save();
                ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(this.x-30,this.y-this.r-20,60,8);
                ctx.fillStyle='#3b82f6';ctx.fillRect(this.x-29,this.y-this.r-19,58*pct,6);
                // Train body detail
                ctx.translate(this.x, this.y);
                ctx.fillStyle = '#1e3a8a';
                ctx.fillRect(-20, -15, 40, 30);
                ctx.restore();
            }
        }
        
        window.game = { 
            cvs:document.getElementById('gameCanvas'), 
            ctx:document.getElementById('gameCanvas').getContext('2d'), 
            conf:{mode:'survival', arena:'tokyo', difficulty: 'normal', modifier: 'normal'}, 
            state:'MENU', frame:0, world:2000, cam:{x:0,y:0}, shake:0, gasRadius:0, timeLeft: 0, 
            player:null, ents:[], projs:[], parts:[], bgParts: [], items:[], texts:[], score:0, wave:1, boost:false, train: null, lootCollected: 0, hackProgress: 0, killCount: 0, zoneProgress: 0,
            init() { 
                this.resize(); 
                window.onresize=()=>this.resize(); 
                Input.init(); 
                Storage.load(); 
                // Initialize conf with loaded/default values
                if(typeof window.game.conf.difficulty === 'undefined') window.game.conf.difficulty = 'normal';
                if(typeof window.game.conf.modifier === 'undefined') window.game.conf.modifier = 'normal';
                window.ui.updateMenu(); 
                if('ontouchstart' in window)el('mobile-controls').classList.remove('hidden'); 
                this.loop(); 
            }, 
            resize(){ 
                this.cvs.width=window.innerWidth; 
                this.cvs.height=window.innerHeight; 
                CFG.w=this.cvs.width; CFG.h=this.cvs.height; 
            }, 
            setStarter(k){USER.selected=k; Storage.save(); window.ui.updateMenu(); window.ui.showTab('play');}, 
            setMode(m){this.conf.mode=m; Storage.save(); window.ui.updateMenu(); window.ui.showTab('play');}, 
            setArena(a){this.conf.arena=a; Storage.save(); window.ui.updateMenu(); window.ui.showTab('play');}, 
            setDifficulty(d) { if(DIFFICULTY[d]) { this.conf.difficulty = d; Storage.save(); window.ui.updateMenu(); window.ui.showTab('play'); } }, 
            setModifier(m) { this.conf.modifier = m; Storage.save(); window.ui.updateMenu(); }, 
            start(){ 
                el('menu-screen').classList.add('hidden'); 
                el('hud').classList.remove('hidden'); 
                
                // FIX: Update HUD Hero Info
                setText('hud-lvl', 'LVL ' + (USER.levels[USER.selected]||1));
                setText('hud-icon', STARTERS[USER.selected].icon);

                this.player=new Player(USER.selected); 
                this.ents=[]; this.projs=[]; this.parts=[]; this.bgParts = []; this.items=[]; this.texts=[]; this.score=0; this.wave=1; this.gasRadius=0; this.timeLeft = 3 * 60 * 60; 
                this.map=[]; this.train = null; this.lootCollected = 0; this.hackProgress = 0; this.killCount = 0; this.zoneProgress = 0;
                
                for(let i=0;i<25;i++){const w=Math.random()*150+50,h=Math.random()*150+50,x=Math.random()*(this.world-w),y=Math.random()*(this.world-h);if(Math.hypot(x-this.world/2,y-this.world/2)>400)this.map.push(new Wall(x,y,w,h,0));} 
                // FIX 1: RÃ©duction du nombre de buissons (40 -> 38)
                for(let i=0;i<38;i++){const w=Math.random()*100+100,h=Math.random()*100+100,x=Math.random()*(this.world-w),y=Math.random()*(this.world-h);this.map.push(new Wall(x,y,w,h,1));} 
                for(let i=0;i<20;i++){const x=Math.random()*(this.world-60),y=Math.random()*(this.world-60);if(Math.hypot(x-this.world/2,y-this.world/2)>400)this.map.push(new Wall(x,y,60,60,3));} 
                const enemyBaseMult = 1+(this.conf.mode==='ranked'?0.2:0.1)*this.wave; 
                if(this.conf.mode==='duel'){ 
                    const bot = new Bot(); bot.x = this.world/2 + 400; bot.y = this.world/2; this.ents.push(bot); window.ui.notif("1 VS 1", "#fff"); 
                } else if(this.conf.mode==='heist') { 
                    const chest = new Enemy('chest', enemyBaseMult); chest.x = this.world/2; chest.y = 100; this.ents.push(chest); this.spawnDefenders(chest.x, chest.y, 3); this.map = this.map.filter(w => Math.hypot(w.x-chest.x, w.y-chest.y) > 300 && Math.hypot(w.x-this.player.x, w.y-this.player.y) > 300); window.ui.notif("DÃ‰TRUIS LE COFFRE !", "#facc15"); 
                } else if(this.conf.mode==='boss_rush') { 
                    this.ents.push(new Enemy('boss', 3)); window.ui.notif("BOSS RUSH !", "#ef4444"); 
                } else if(this.conf.mode==='titan_raid') { 
                    this.ents.push(new Enemy('boss', 5)); window.ui.notif("RAID TITAN !", "#ef4444"); 
                } else if(this.conf.mode === 'train_defense') {
                    this.train = new Train();
                    this.ents.push(this.train);
                    this.map = this.map.filter(w => Math.abs(w.y - this.world/2) > 100); // Clear path for train
                    window.ui.notif("PROTÃˆGE LE TRAIN !", "#3b82f6");
                } else if(this.conf.mode === 'thief') {
                    // Spawn Loot
                    for(let i=0; i<15; i++) {
                        this.items.push({x:Rnd(100,this.world-100), y:Rnd(100,this.world-100), type:'loot_bag'});
                    }
                    window.ui.notif("VOLE 10 SACS !", "#facc15");
                } else if(this.conf.mode === 'cyber_hack') {
                    // Spawn Hack Terminal
                    const term = new Enemy('chest', enemyBaseMult * 5); // Use chest model as terminal base but stronger
                    term.x = this.world/2; term.y = this.world/2; term.type = 'terminal'; term.c = '#22d3ee';
                    this.ents.push(term);
                    // Clear center
                    this.map = this.map.filter(w => Math.hypot(w.x-term.x, w.y-term.y) > 400);
                    window.ui.notif("PIRATE LE TERMINAL !", "#22d3ee");
                } else if(this.conf.mode === 'escape') {
                    // Spawn extraction point at end of world
                    const exit = new Enemy('chest', 10);
                    exit.x = this.world - 150; exit.y = this.world - 150; exit.type = 'exit'; exit.c = '#10b981'; exit.r = 60;
                    this.ents.push(exit);
                    // Clear area
                    this.map = this.map.filter(w => Math.hypot(w.x-exit.x, w.y-exit.y) > 400);
                    window.ui.notif("REJOINS L'EXTRACTION !", "#10b981");
                } else if(this.conf.mode === 'rampage') {
                    window.ui.notif("CARNAGE : 50 KILLS", "#ef4444");
                } else if(this.conf.mode === 'zone_control') {
                    // Zone centrale
                    window.ui.notif("CONTRÃ”LE LA ZONE", "#a855f7");
                } else if(this.conf.mode === 'sniper_duel') {
                    const bot = new Bot(); bot.x = this.world/2 + 600; bot.y = this.world/2; 
                    bot.c = '#a855f7'; // Sniper color
                    // Force bot to simulate sniper if possible, or just standard bot
                    this.ents.push(bot); window.ui.notif("DUEL SNIPER", "#a855f7");
                } else if(this.conf.mode === 'giant_hunt') {
                    const boss = new Enemy('boss', 5); // Huge HP
                    boss.x = this.world/2; boss.y = this.world/2; boss.r = 80; boss.name = "GÃ‰ANT";
                    this.ents.push(boss); window.ui.notif("CHASSE AU GÃ‰ANT", "#ef4444");
                } else if(this.conf.mode === 'golden_chase') {
                    for(let i=0; i<30; i++) this.items.push({x:Rnd(100,this.world-100), y:Rnd(100,this.world-100), type:'coins', val: 50});
                    window.ui.notif("RUÃ‰E VERS L'OR !", "#eab308");
                } else if(this.conf.mode === 'infection_hard') {
                    // Start with more enemies
                    for(let i=0; i<20; i++) this.ents.push(new Enemy('fast', 1.5));
                    window.ui.notif("INFECTION EXTRÃŠME", "#dc2626");
                } else if(this.conf.mode === 'speed_run') {
                    const exit = new Enemy('chest', 1); exit.type='exit'; exit.x = this.world-100; exit.y = this.world-100; exit.c='#22d3ee';
                    this.ents.push(exit);
                    window.ui.notif("SPEED RUN !", "#22d3ee");

                } else { 
                    window.ui.notif(MODES[this.conf.mode].name.toUpperCase(), "#fff"); 
                } 
                setText('hud-icon', STARTERS[USER.selected].icon); 
                this.state='PLAYING'; // Set state to PLAYING
            }, 
            spawnDefenders(cx, cy, count) { for(let i=0; i<count; i++) { const angle = (Math.PI*2/count)*i; const e = new Enemy('basic', 1); e.x = cx + Math.cos(angle)*150; e.y = cy + Math.sin(angle)*150; this.ents.push(e); } }, 
            togglePause(){this.state=this.state==='PLAYING'?'PAUSED':(this.state==='PAUSED'?'PLAYING':this.state);}, 
            toMenu(){el('gameover-screen').classList.add('hidden');el('menu-screen').classList.remove('hidden');el('hud').classList.add('hidden');this.state='MENU';window.ui.updateMenu();game.boost=false;}, 
            over(r){ 
                this.state='GAMEOVER'; 
                el('gameover-screen').classList.remove('hidden'); 
                
                // Stats updates
                if (r !== "VICTOIRE") {
                    USER.stats.losses++;
                }

                const title = el('go-title');
                if (r === "VICTOIRE") {
                    title.innerText = "VICTOIRE";
                    title.className = "text-6xl md:text-8xl font-black text-yellow-400 mb-2 drop-shadow-[0_0_25px_rgba(250,204,21,0.8)] tracking-tighter animate-bounce";
                } else {
                    title.innerText = "KO";
                    title.className = "text-8xl font-black text-white mb-2 drop-shadow-2xl tracking-tighter";
                }
                setText('go-reason', r); 
                // Feature 2: Score Multiplier
                let finalScore = this.score * DIFFICULTY[this.conf.difficulty].mult;
                setText('go-score', Math.floor(finalScore)); 

                let gt = 1 + Math.floor(finalScore / 100) * 2; 
                if(this.boost) gt *= 2; 
                if(this.boost) gt *= 2; 
                if((this.conf.mode==='duel' || this.conf.mode==='heist' || this.conf.mode==='boss_rush' || this.conf.mode==='titan_raid' || this.conf.mode==='train_defense' || this.conf.mode==='cyber_hack' || this.conf.mode === 'escape' || this.conf.mode === 'rampage' || this.conf.mode === 'zone_control') && r==="VICTOIRE") { gt += 20; USER.stats.wins++; } 
                let gc = Math.floor(finalScore/10); 
                if(r==="VICTOIRE") gc += 50; 
                if(finalScore >= 200 || r==="VICTOIRE") { 
                    USER.pass.xp += 50; 
                    while(USER.pass.xp >= 100) { 
                        if(USER.pass.tier < 50) { 
                            USER.pass.tier++; USER.pass.xp -= 100; window.ui.notif("PASS LEVEL UP!", "#facc15"); 
                        } else { 
                            USER.pass.xp = 100; break; 
                        } 
                    } 
                } 
                USER.trophies+=gt; USER.coins+=gc; 
                USER.stats.maxWave=Math.max(USER.stats.maxWave,this.wave); 
                USER.stats.games++; 
                USER.stats.maxPassTier = Math.max(USER.stats.maxPassTier || 1, USER.pass.tier); // Mise Ã  jour de la stat de Palier Max
                
                // Quest Check
                if (window.QuestSystem) {
                    window.QuestSystem.check('play', { mode: this.conf.mode, arena: this.conf.arena, hero: USER.selected });
                    if(r === "VICTOIRE") window.QuestSystem.check('win', { mode: this.conf.mode });
                    window.QuestSystem.check('survive', { wave: this.wave });
                }

                Storage.save(); setText('go-rewards', `+${gt}ğŸ† +${gc}ğŸª™`); 
            }, 
            // AmÃ©lioration de l'effet d'ambiance 2.0
            drawTerrainEffects() { 
                if(this.state !== 'PLAYING') return; 
                const arena = this.conf.arena; 
                let spawnRate = 0.3; let color = 'rgba(255,255,255,0.5)'; let vy = 2; let vx = 0; let size = 3; let life = 200;
                
                // Configs uniques par terrain
                if(arena === 'ice') { spawnRate = 0.9; color = 'rgba(220,240,255,0.8)'; vy = 3.5; vx = 1; } 
                else if(arena === 'magma') { spawnRate = 0.6; color = 'rgba(255,80,0,0.6)'; vy = -3; size = 5; } 
                else if(arena === 'tokyo') { spawnRate = 0.3; color = 'rgba(0, 255, 200, 0.4)'; vy = 5; } 
                else if(arena === 'cyber_city') { spawnRate = 0.3; color = 'rgba(232, 121, 249, 0.4)'; vy = 6; }
                else if(arena === 'sand') { spawnRate = 0.7; color = 'rgba(230,180,50,0.4)'; vy = 4; vx = 3; } 
                else if(arena === 'jungle') { spawnRate = 0.4; color = 'rgba(50, 200, 100, 0.4)'; vy = 1.5; vx = -0.5; }
                else if(arena === 'nebula') { spawnRate = 0.6; color = 'rgba(168, 85, 247, 0.5)'; vy = 0.5; vx = 0.5; size = 2; }
                else if(arena === 'mainframe') { spawnRate = 1.0; color = 'rgba(34, 211, 238, 0.6)'; vy = -4.5; size = 2; } // Code rain up
                else if(arena === 'ruins') { spawnRate = 0.8; color = 'rgba(148, 163, 184, 0.5)'; vy = 5; vx = -1; } // Rain
                else if(arena === 'moon') { spawnRate = 0.2; color = 'rgba(255, 255, 255, 0.8)'; vy = -0.5; size=1; } // Stars
                else if(arena === 'crystal') { spawnRate = 0.6; color = 'rgba(192, 132, 252, 0.6)'; vy = -1; vx = 0; size = 4; } // Glitter
                else if(arena === 'solaris') { spawnRate = 0.5; color = 'rgba(253, 186, 116, 0.6)'; vy = -4; size = 5; } // Sparks
                
                if(Math.random() < spawnRate) { 
                    this.bgParts.push({ 
                        x: this.cam.x + Math.random() * CFG.w, 
                        y: (vy > 0 ? this.cam.y - 10 : this.cam.y + CFG.h + 10), 
                        vx: (Math.random() - 0.5) * 2 + vx, 
                        vy: vy * (0.8 + Math.random() * 0.4), 
                        life: life, c: color, r: Math.random() * size + 1 
                    }); 
                } 
                for(let i=this.bgParts.length-1; i>=0; i--) { 
                    const p = this.bgParts[i]; p.x += p.vx; p.y += p.vy; p.life--; 
                    if(p.life <= 0) { this.bgParts.splice(i, 1); continue; } 
                    
                    // Optimisation: Suppression hors Ã©cran large
                    if(p.x < this.cam.x - 50 || p.x > this.cam.x + CFG.w + 50 || p.y < this.cam.y - 50 || p.y > this.cam.y + CFG.h + 50) { 
                        this.bgParts.splice(i, 1); continue; 
                    } 
                    
                    this.ctx.fillStyle = p.c; this.ctx.beginPath(); this.ctx.arc(p.x - this.cam.x, p.y - this.cam.y, p.r, 0, Math.PI*2); this.ctx.fill(); 
                } 
            }, 
            loop(){ 
                requestAnimationFrame(()=>this.loop()); 
                this.frame++; 
                const ctx=this.ctx; 
                if(this.state==='PLAYING'){ 
                    if(this.conf.mode === 'heist' || this.conf.mode === 'boss_rush' || this.conf.mode === 'titan_raid' || this.conf.mode === 'train_defense' || this.conf.mode === 'cyber_hack') { 
                        this.timeLeft--; 
                        if(this.timeLeft <= 0) { 
                            this.over(this.conf.mode === 'cyber_hack' && this.hackProgress < 100 ? "ECHEC PIRATAGE" : "VICTOIRE"); return; 
                        }
                    }
                    if(this.conf.mode === 'escape') {
                        this.timeLeft--;
                        if(this.timeLeft <= 0) { this.over("TEMPS Ã‰COULÃ‰"); return; }
                    }
                    if((this.conf.mode === 'heist') && this.frame % (20*60) === 0) { 
                            const chest = this.ents.find(e => e.type === 'chest'); 
                            if(chest) { 
                                this.spawnDefenders(chest.x, chest.y, 3); window.ui.notif("RENFORTS !", "#ef4444"); 
                            } 
                        } 
                    if(!this.ents) this.ents = []; if(!this.map) this.map = []; 
                    
                    // SPAWN LOGIC
                    if(this.conf.mode === 'survival' || this.conf.mode === 'ranked' || this.conf.mode === 'train_defense' || this.conf.mode === 'thief' || this.conf.mode === 'cyber_hack' || this.conf.mode === 'escape' || this.conf.mode === 'rampage' || this.conf.mode === 'zone_control'){ 
                        if(!this.ents.find(e=>e.isBoss && e.type !== 'train' && e.type !== 'terminal' && e.type !== 'exit')){ 
                            let max=5+Math.floor(this.wave*1.5); 
                            if(this.conf.mode === 'rampage') max *= 2; // Double spawn for rampage
                            const enemyWaveMult = 1+(this.conf.mode==='ranked'?0.2:0.1)*this.wave; 
                            
                            // Feature 1: Mini-Boss Spawn (Vague 3 & 6)
                            if(this.frame%1800===0){
                                this.wave++;
                                if(this.wave % 5 === 0 && this.conf.mode !== 'thief' && this.conf.mode !== 'cyber_hack' && this.conf.mode !== 'escape' && this.conf.mode !== 'rampage' && this.conf.mode !== 'zone_control'){
                                    this.ents.push(new Enemy('boss', enemyWaveMult * 2));
                                    window.ui.notif("BOSS !!!","#ef4444");
                                } else if ((this.wave === 3 || this.wave === 6) && this.conf.mode !== 'thief' && this.conf.mode !== 'cyber_hack' && this.conf.mode !== 'escape' && this.conf.mode !== 'rampage' && this.conf.mode !== 'zone_control') {
                                    this.ents.push(new Enemy('mini_boss', enemyWaveMult * 1.5));
                                    window.ui.notif("MINI BOSS !","#facc15");
                                } else {
                                    window.ui.notif("VAGUE "+this.wave,"#fff");
                                }
                            }
                            
                            // Spawn enemies
                            if(this.ents.filter(e => !e.friend && e.type !== 'train' && e.type !== 'terminal' && e.type !== 'exit').length < max && this.frame%60===0){
                                let t='basic'; if(this.wave>2&&Math.random()>0.7)t='fast'; if(this.wave>4&&Math.random()>0.8)t='tank'; 
                                const en = new Enemy(t, enemyWaveMult);
                                // For Train mode, spawn near train sometimes
                                if(this.conf.mode === 'train_defense' && this.train && Math.random() < 0.5) {
                                    en.x = this.train.x + Rnd(-300, 300);
                                    en.y = this.train.y + Rnd(-300, 300); 
                                }
                                // Escape mode: spawn near player (chose)
                                if(this.conf.mode === 'escape') {
                                     en.x = this.player.x + Rnd(-400, 400); en.y = this.player.y + Rnd(-400, 400);
                                     if(Dist(en, this.player) < 300) { en.x += 300; }
                                     en.mode = 'CHASE';
                                }
                                this.ents.push(en);
                            } 
                            
                        } 
                    } else if(this.ents.length===0 && this.conf.mode !== 'train_defense' && this.conf.mode !== 'cyber_hack' && this.conf.mode !== 'escape') this.over("VICTOIRE"); 
                    
                    this.player.update(); 
                    if(this.train) {
                        this.train.update();
                        if(this.train.hp <= 0) this.over("TRAIN DÃ‰TRUIT");
                    }
                    if(this.conf.mode === 'cyber_hack') {
                        const term = this.ents.find(e => e.type === 'terminal');
                        if(term) {
                            if(Dist(this.player, term) < 200) {
                                this.hackProgress += 0.05;
                                if(Math.random() < 0.1) window.game.parts.push({x:term.x+Rnd(-20,20),y:term.y+Rnd(-20,20),vx:0,vy:-2,life:30,c:'#22d3ee',r:2});
                            }
                            if(this.hackProgress >= 100) this.over("VICTOIRE");
                        }
                    }
                    if(this.conf.mode === 'escape') {
                        const exit = this.ents.find(e => e.type === 'exit');
                        if(exit && Dist(this.player, exit) < exit.r + this.player.r) {
                            this.over("VICTOIRE");
                        }
                    }
                    if(this.conf.mode === 'rampage') {
                         if(this.killCount >= 50) this.over("VICTOIRE");
                    }
                    if(this.conf.mode === 'zone_control') {
                        // Check if player is in center zone (radius 200)
                        if(Dist(this.player, {x:this.world/2, y:this.world/2}) < 200) {
                            this.zoneProgress += 0.1;
                            if(this.frame % 30 === 0) window.ui.notif("CAPTURE...", "#a855f7");
                            if(this.zoneProgress >= 100) this.over("VICTOIRE");
                        }
                    }
                    
                    this.ents.forEach(e=>e.update());
                    // Fix: Remove dead entities (e.g. from poison) that didn't go through kill()
                    for(let e of this.ents) {
                        if(e.hp <= 0 && !e.dead) this.kill(e);
                    }
                    
                    this.ents.forEach(e => resolveCollision(this.player, e)); 
                    for(let i=0; i<this.ents.length; i++) for(let j=i+1; j<this.ents.length; j++) resolveCollision(this.ents[i], this.ents[j]); 
                    
                    // CAM FOLLOW
                    let targetX = this.player.x, targetY = this.player.y;
                    const tx=targetX-CFG.w/2, ty=targetY-CFG.h/2; 
                    this.cam.x+=(tx-this.cam.x)*0.1; 
                    this.cam.y+=(ty-this.cam.y)*0.1; 
                    this.cam.x=Math.max(0,Math.min(this.world-CFG.w,this.cam.x)); 
                    this.cam.y=Math.max(0,Math.min(this.world-CFG.h,this.cam.y)); 
                    if(this.shake>0)this.shake*=0.9; 
                    
                    // PROJECTILES
                    for(let i=this.projs.length-1;i>=0;i--){ 
                        const b=this.projs[i]; 
                        
                        // Melee attacks do not move
                        if(b.melee){ 
                            b.x=window.game.player.x+Math.cos(window.game.player.angle)*40; 
                            b.y=window.game.player.y+Math.sin(window.game.player.angle)*40; 
                            b.life--; 
                            
                            // Logique de Siphon de Vie pour Reaper (Feature Reaper)
                            if (USER.selected === 'reaper' && b.life === 0) {
                                // Reaper Melee hit logic moved to kill() or handled after damage application
                                // Let the hit logic handle the lifesteal (in the collision loop)
                            }

                            if(b.life<=0){this.projs.splice(i,1);continue;} 
                            
                            for(let e of this.ents) if(Dist(b,e)<b.r+e.r && !e.hitCD){ 
                                e.hitCD=20; 
                                e.hp-=b.dmg; 
                                e.hitTimer = 0; // Reset hitTimer
                                if(b.friend) {
                                    USER.stats.dmg+=b.dmg; 
                                    window.QuestSystem.check('dmg', { amount: Math.floor(b.dmg) });
                                } 
                                if(window.game.conf.modifier === 'poison') e.activeEffects.poison = 120; 
                                // FIX: Lifesteal handled for melee
                                if(b.friend && (USER.selected === 'ronin' || USER.selected === 'reaper')) { // Ronin et Reaper ont le lifesteal
                                    if(window.game.conf.modifier !== 'oneshot') window.game.player.hp = Math.min(window.game.player.maxHp, window.game.player.hp + Math.floor(b.dmg * 0.4));
                                }
                                if(window.game.conf.modifier === 'recoil' && b.friend) { e.x += Math.cos(window.game.player.angle)*20; e.y += Math.sin(window.game.player.angle)*20; } // Knockback enemy
                                
                                e.flashColor = b.c; e.flashTimer = 5; // Flash Feedback
                                for(let k=0;k<3;k++)window.game.parts.push({x:e.x,y:e.y,vx:(Math.random()-0.5)*5,vy:(Math.random()-0.5)*5,life:15,c:'#fff',r:3}); 
                                this.texts.push({x:e.x,y:e.y-40,t:Math.floor(b.dmg),life:40,c:'#fff',vy:-2}); 
                                if(window.game.conf.modifier === 'oneshot') e.hp = 0; 
                                if(e.hp<=0 && !e.dead) this.kill(e); 
                            } 
                            continue; 
                        } 
                        
                        // Ranged attacks move
                        b.x+=b.vx; b.y+=b.vy; b.life--; 
                        if(b.life<=0){this.projs.splice(i,1);continue;} 
                        let wh=false; 
                        for(let k=this.map.length-1; k>=0; k--) { 
                            const w=this.map[k]; 
                            if(w.type!==1 && ColRect(b, w)) { 
                                // FIX: EmpÃªcher les projectiles de casser les murs (sauf les caisses de butin type 3)
                                if(w.type===0) wh=true; // Mur normal
                                
                                if(w.type===3 && b.friend) { // Mur destructible par projectile joueur
                                    this.map.splice(k,1); 
                                    this.items.push({x:w.x+30, y:w.y+30, type:'cube'}); 
                                    for(let j=0;j<5;j++) this.parts.push({x:w.x+30, y:w.y+30, vx:Rnd(-5,5), vy:Rnd(-5,5), life:20, c:'#d97706', r:5}); 
                                    wh=true; 
                                } else if (w.type === 3 && !b.friend) {
                                    // Projectiles ennemis ne cassent pas les murs
                                    wh = true; 
                                }
                            } 
                        } 
                        if(wh){for(let j=0;j<3;j++)this.parts.push({x:b.x,y:b.y,vx:(Math.random()-0.5)*3,vy:(Math.random()-0.5)*3,life:10,c:b.c,r:2}); this.projs.splice(i,1);continue;} 
                        
                        if(b.friend){ 
                            for(let e of this.ents){ 
                                if(Dist(b,e)<b.r+e.r){ 
                                    e.hp-=b.dmg; 
                                    e.hitTimer = 0; // Reset hitTimer
                                    USER.stats.dmg+=b.dmg; 
                                    window.QuestSystem.check('dmg', { amount: Math.floor(b.dmg) }); 
                                    
                                    if(window.game.conf.modifier === 'poison') e.activeEffects.poison = 120; 
                                    // FIX: Lifesteal for ranged
                                    if(window.game.conf.modifier === 'vampire' && window.game.conf.modifier !== 'oneshot') window.game.player.hp = Math.min(window.game.player.maxHp, window.game.player.hp + 5); // Life Steal (Vampire modifier)
                                    if(window.game.conf.modifier === 'recoil') { e.x += Math.cos(Math.atan2(b.vy, b.vx))*20; e.y += Math.sin(Math.atan2(b.vy, b.vx))*20; }
                                    
                                    // Flash Feedback
                                    e.flashColor = b.c; e.flashTimer = 5; 

                                    // Feature 6: DÃ©gÃ¢ts Critiques
                                    this.texts.push({x:e.x,y:e.y-40,t:Math.floor(b.dmg),life:40,c:b.isCrit?'#facc15':'#fff',vy:-2}); 
                                    for(let k=0;k<5;k++)this.parts.push({x:e.x,y:e.y,vx:(Math.random()-0.5)*8,vy:(Math.random()-0.5)*8,life:20,c:e.c,r:4}); 
                                    if(window.game.conf.modifier === 'oneshot') e.hp = 0; 
                                    if(e.hp<=0 && !e.dead) this.kill(e); 
                                    this.projs.splice(i,1); wh=true; break; 
                                } 
                            } 
                        } else { 
                            // Enemy projectiles hit player or TRAIN
                            let hit = false;
                            if(Dist(b,this.player)<b.r+this.player.r){
                                this.player.hp-=b.dmg;
                                this.player.hitTimer = 0; // Reset hitTimer
                                window.ui.flash();
                                if(window.game.conf.modifier === 'poison') this.player.activeEffects.poison = 120;
                                if(window.game.conf.modifier === 'oneshot') this.player.hp = 0; 
                                if(this.player.hp<=0)this.over("TuÃ© par Tir Ennemi");
                                hit=true;
                            }
                            if(!hit && this.train && Dist(b, this.train) < b.r + this.train.r) {
                                this.train.hp -= b.dmg;
                                hit=true;
                            }
                            if(hit) this.projs.splice(i,1);
                        } 
                    } 
                    this.ents.forEach(e=>{if(e.hitCD)e.hitCD--}); 
                    for(let i=this.ents.length-1;i>=0;i--)if(this.ents[i].dead)this.ents.splice(i,1); 
                    for(let i=this.items.length-1;i>=0;i--){
                        const l=this.items[i];
                        // Feature 5: Ramassage Rapide (les items suivent le joueur)
                        if (Dist(l, this.player) < 150) {
                            let angleToPlayer = Math.atan2(this.player.y - l.y, this.player.x - l.x);
                            l.x += Math.cos(angleToPlayer) * 5;
                            l.y += Math.sin(angleToPlayer) * 5;
                        }
                        
                        if(Dist(l,this.player)<30){
                            if(l.type==='cube'){this.player.cubes++;this.player.maxHp+=400;this.player.hp+=400;window.ui.notif("POWER UP!","#22c55e");}
                            else if(l.type==='loot_bag'){
                                this.lootCollected++;
                                window.QuestSystem.check('collect', { itemType: 'loot_bag', amount: 1 });
                                window.ui.notif(`SAC RÃ‰CUPÃ‰RÃ‰ (${this.lootCollected}/10)`, "#facc15");
                                if(this.lootCollected >= 10) this.over("VICTOIRE");
                            }
                            else{
                                window.QuestSystem.check('collect', { itemType: l.t, amount: 1 });
                                if(l.t==='hp'){
                                    this.player.hp=Math.min(this.player.maxHp,this.player.hp+30);
                                    for(let j=0;j<5;j++) this.parts.push({x:l.x,y:l.y,vx:Rnd(-3,3),vy:Rnd(-3,3),life:20,c:'#22c55e',r:3}); // VFX
                                } else if(l.t==='coins') {
                                    USER.coins += 10;
                                    window.ui.feed("PiÃ¨ces", "+10 ğŸª™", true);
                                    for(let j=0;j<5;j++) this.parts.push({x:l.x,y:l.y,vx:Rnd(-3,3),vy:Rnd(-3,3),life:20,c:'#eab308',r:3});
                                } else if(l.t==='gems') {
                                    USER.gems += 1;
                                    window.ui.feed("Gemme", "+1 ğŸ’", true);
                                    for(let j=0;j<5;j++) this.parts.push({x:l.x,y:l.y,vx:Rnd(-3,3),vy:Rnd(-3,3),life:20,c:'#a855f7',r:3});
                                } else {
                                    // xp
                                    this.player.xp=Math.min(this.player.xpMax-1, this.player.xp+30); 
                                    window.QuestSystem.check('xp', { amount: 30 }); 
                                    for(let j=0;j<5;j++) this.parts.push({x:l.x,y:l.y,vx:Rnd(-3,3),vy:Rnd(-3,3),life:20,c:'#a855f7',r:3}); 
                                }
                            }
                            this.items.splice(i,1);
                        }
                    } 
                    for(let i=this.parts.length-1;i>=0;i--){const p=this.parts[i]; p.x+=p.vx;p.y+=p.vy;p.life--;if(p.life<=0)this.parts.splice(i,1);} 
                    window.ui.hud(); 
                    window.ui.drawMinimap(); 
                } 
                const map=ARENAS[this.conf.arena]; ctx.fillStyle=map.color; ctx.fillRect(0,0,CFG.w,CFG.h); 
                ctx.save(); 
                if(this.state!=='MENU'){ 
                    const sx=(Math.random()-0.5)*this.shake, sy=(Math.random()-0.5)*this.shake; 
                    ctx.translate(-this.cam.x+sx, -this.cam.y+sy); 
                    this.drawTerrainEffects(); 
                    ctx.strokeStyle=map.grid; ctx.lineWidth=2; 
                    const tx=Math.floor(this.cam.x/100)*100, ty=Math.floor(this.cam.y/100)*100; 
                    ctx.beginPath(); 
                    for(let x=tx;x<tx+CFG.w+100;x+=100){ctx.moveTo(x,0);ctx.lineTo(x,this.world);} 
                    for(let y=ty;y<ty+CFG.h+100;y+=100){ctx.moveTo(0,y);ctx.lineTo(this.world,y);} 
                    ctx.stroke(); 
                    if(this.conf.mode === 'heist') { 
                        const chest = this.ents.find(e => e.type === 'chest'); 
                        if(chest) { 
                            const angle = Math.atan2(chest.y - this.player.y, chest.x - this.player.x); 
                            ctx.save(); ctx.translate(this.player.x, this.player.y); ctx.rotate(angle); 
                            ctx.fillStyle = '#facc15'; ctx.beginPath(); ctx.moveTo(60, 0); ctx.lineTo(50, -10); ctx.lineTo(50, 10); ctx.fill(); 
                            ctx.restore(); 
                        } 
                    } else if(this.conf.mode === 'train_defense' && this.train) {
                        const angle = Math.atan2(this.train.y - this.player.y, this.train.x - this.player.x);
                        ctx.save(); ctx.translate(this.player.x, this.player.y); ctx.rotate(angle);
                        ctx.fillStyle = '#3b82f6'; ctx.beginPath(); ctx.moveTo(60, 0); ctx.lineTo(50, -10); ctx.lineTo(50, 10); ctx.fill();
                        ctx.restore();
                    } else if(this.conf.mode === 'cyber_hack') {
                        const term = this.ents.find(e => e.type === 'terminal');
                        if(term) {
                            ctx.save(); ctx.translate(term.x, term.y); 
                            ctx.fillStyle = `rgba(34, 211, 238, 0.3)`;
                            ctx.beginPath(); ctx.arc(0, 0, 200, 0, Math.PI*2); ctx.fill(); // Zone
                            ctx.fillStyle = '#22d3ee'; ctx.fillRect(-20, -20, 40, 40); // Terminal
                            ctx.fillStyle = 'white'; ctx.font = "bold 20px Orbitron"; ctx.textAlign = 'center';
                            ctx.fillText(Math.floor(this.hackProgress)+"%", 0, -40);
                            ctx.restore();
                        }
                    } else if(this.conf.mode === 'escape') {
                         const exit = this.ents.find(e => e.type === 'exit');
                         if(exit) {
                             ctx.save(); ctx.translate(exit.x, exit.y);
                             ctx.fillStyle = `rgba(16, 185, 129, 0.3)`;
                             ctx.beginPath(); ctx.arc(0, 0, 100 + Math.sin(this.frame*0.1)*20, 0, Math.PI*2); ctx.fill();
                             ctx.fillStyle = '#10b981'; ctx.font = "bold 30px Orbitron"; ctx.textAlign = 'center';
                             ctx.fillText("EXIT", 0, -40);
                             ctx.restore();
                         }
                    } else if(this.conf.mode === 'zone_control') {
                         ctx.save(); ctx.translate(this.world/2, this.world/2);
                         ctx.fillStyle = `rgba(168, 85, 247, 0.2)`;
                         ctx.beginPath(); ctx.arc(0, 0, 200, 0, Math.PI*2); ctx.fill(); 
                         ctx.strokeStyle = '#a855f7'; ctx.lineWidth = 5; ctx.stroke();
                         ctx.beginPath(); ctx.arc(0, 0, 200 * (this.zoneProgress/100), 0, Math.PI*2); 
                         ctx.fillStyle = `rgba(168, 85, 247, 0.5)`; ctx.fill();
                         ctx.restore();
                    }
                    ctx.strokeStyle='#ef4444'; ctx.lineWidth=5; ctx.strokeRect(0,0,this.world,this.world); 
                    this.items.forEach(l=>{
                        if(l.type==='cube'){ctx.fillStyle='#22c55e';ctx.fillRect(l.x-10,l.y-10,20,20);ctx.shadowColor='#22c55e';ctx.shadowBlur=10;ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.strokeRect(l.x-10,l.y-10,20,20);ctx.shadowBlur=0;}
                        else if(l.type==='loot_bag'){ctx.fillStyle='#facc15';ctx.font='30px Arial';ctx.fillText('ğŸ’°',l.x-15,l.y+10);}
                        else{ctx.fillStyle=l.t==='hp'?'#22c55e':'#a855f7';ctx.beginPath();ctx.arc(l.x,l.y,8,0,Math.PI*2);ctx.fill();}
                    }); 
                    const renderList = [...this.map, ...this.ents, this.player, ...this.projs, ...this.parts]; 
                    renderList.sort((a,b) => a.y - b.y); 
                    renderList.forEach(o => { 
                        if(o instanceof Wall) o.draw(ctx, map.wall); 
                        else if(o.draw) o.draw(ctx); 
                        else { 
                            ctx.fillStyle=o.c;ctx.beginPath();ctx.arc(o.x,o.y,o.r,0,Math.PI*2);ctx.fill(); 
                        } 
                    }); 
                    
                    // RENDU DES PROJECTILES UNIQUES
                    this.projs.forEach(p => { 
                        // TraÃ®nÃ©e
                        if (p.trailColor && this.frame % 3 === 0 && !p.melee) {
                            this.parts.push({ x: p.x, y: p.y, vx: -p.vx * 0.1, vy: -p.vy * 0.1, life: 10, c: p.trailColor, r: p.r / 3 });
                        }

                        ctx.shadowColor=p.c; ctx.shadowBlur=10; 
                        ctx.fillStyle=p.c; 

                        // Dessin par forme
                        if (p.shape === 'rock') {
                            ctx.font = `${p.r * 1.5}px Arial`;
                            ctx.fillText("ğŸ—¿", p.x - p.r, p.y + p.r / 2);
                        } else if (p.shape === 'snake') {
                            ctx.font = `${p.r * 2}px Arial`;
                            ctx.fillText("ğŸ", p.x - p.r, p.y + p.r / 2);
                        } else if (p.shape === 'flame') {
                            ctx.font = `${p.r * 1.5}px Arial`;
                            ctx.fillText("ğŸ”¥", p.x - p.r, p.y + p.r / 2);
                        } else if (p.shape === 'melee') {
                            // Melee est un simple arc trÃ¨s rapide pour simuler un coup
                            ctx.save();
                            ctx.translate(p.x, p.y);
                            ctx.rotate(this.player.angle);
                            ctx.fillStyle = p.c;
                            ctx.globalAlpha = 0.8 * (p.life / 1); // DisparaÃ®t immÃ©diatement
                            ctx.beginPath();
                            ctx.arc(0, 0, p.r, -0.5, 0.5); // Arc devant le joueur
                            ctx.lineTo(0, 0);
                            ctx.fill();
                            ctx.restore();
                        } else {
                            // Projectile standard (cercle/laser)
                            ctx.beginPath();
                            ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); 
                            ctx.fill(); 
                        }
                        
                        ctx.shadowBlur=0; 
                    }); 
                    this.texts.forEach((t,i)=>{t.y+=t.vy;t.life--;ctx.globalAlpha=t.life/40;ctx.fillStyle=t.c;ctx.font="bold 20px Orbitron";ctx.fillText(t.t,t.x,t.y);ctx.globalAlpha=1;if(t.life<=0)this.texts.splice(i,1);}); 
                } 
                ctx.restore(); 
            }, 
            kill(e){ 
                e.dead=true; 
                const diffMult = DIFFICULTY[window.game.conf.difficulty].mult;
                this.score+=(e.isBoss||e.isBot?500:100) * diffMult; 
                this.player.xp=Math.min(this.player.xpMax-1, this.player.xp+(e.isBoss?300:20) * diffMult); 
                this.player.super=Math.min(100,this.player.super+(e.isBoss?30:10));   
                // Fix: Lifesteal passive for non-melee heroes
                if(this.player.stats.passive === "Vol de Vie" && this.player.stats.type !== 'melee') {
                     if(window.game.conf.modifier !== 'oneshot') this.player.hp=Math.min(this.player.maxHp,this.player.hp+(e.isBoss?50:10)); // Heal on kill for ranged lifesteal
                }

                // Feature: Bot Emote on Kill (5% chance)
                if (e.isBot && Math.random() < 0.05) {
                    const randomEmote = EMOTE_LIST[Math.floor(Math.random() * EMOTE_LIST.length)].i;
                    window.ui.triggerEmote(randomEmote);
                }

                // EXPLOSIVE MOD
                if (window.game.conf.modifier === 'explosif') {
                    for(let i=0; i<8; i++) {
                        window.game.parts.push({x:e.x, y:e.y, vx:Rnd(-5,5), vy:Rnd(-5,5), life:30, c:'#f97316', r:6});
                    }
                    if (Dist(e, this.player) < 100) {
                        this.player.hp -= 50;
                        window.ui.flash();
                        if (this.player.hp <= 0) this.over("TuÃ© par Explosion");
                    }
                }

                if(Math.random()<0.3) {
                     const r = Math.random();
                     let t = 'xp';
                     if(r < 0.35) t = 'hp';
                     else if(r < 0.7) t = 'xp';
                     else if(r < 0.95) t = 'coins';
                     else t = 'gems';
                     
                     this.items.push({x:e.x, y:e.y, t:t});
                }  
                // Manual check for 'collect' logic if we want "enemies drop X" or similar, but 'collect' is on pickup.
                // However, coins and gems from box:
                
                USER.stats.kills++; 
                this.killCount++;
                window.QuestSystem.check('kill', {}); // Quest Check
                window.ui.feed("Toi",e.isBot?"Rival":(e.type==='chest'?"COFFRE":e.name),true); 
                if(this.player.xp>=this.player.xpMax){this.player.xp=0;this.player.xpMax*=1.2;this.player.lvl++;this.player.hp=this.player.maxHp;this.state='LEVELUP';window.ui.levelUp();} 
            } 
        };
        
        window.onload=function(){ if(window.game) window.game.init(); };
    </script>
</body></html>
