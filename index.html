<!DOCTYPE html><html lang="fr"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>mBattle v1.4.6 - Cyber Future</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- CORE & VARIABLES --- */
        :root {
            --primary: #22d3ee;
            --secondary: #a855f7;
            --accent: #f472b6;
            --bg-dark: #020617;
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-bg: rgba(10, 15, 30, 0.75);
            --neon-blue: #00f3ff;
            --neon-purple: #bc13fe;
        }

        /* --- VISUAL FX --- */
        @keyframes coin-pop { 0% { transform: scale(1); filter: brightness(1); } 50% { transform: scale(1.4); filter: brightness(1.5); } 100% { transform: scale(1); filter: brightness(1); } }
        .flash-coins { animation: coin-pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); color: #facc15 !important; text-shadow: 0 0 15px gold; }
        .flash-gems { animation: coin-pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); color: #d8b4fe !important; text-shadow: 0 0 15px #a855f7; }
        
        @keyframes shiny-wipe { 0% { left: -100%; opacity: 0; } 50% { opacity: 0.5; } 100% { left: 200%; opacity: 0; } }


        body { 
            margin: 0; 
            overflow: hidden; 
            background: radial-gradient(circle at 50% 120%, #1e1b4b 0%, #020617 60%, #000000 100%);
            font-family: 'Rajdhani', sans-serif; 
            color: white; 
            touch-action: none; 
            user-select: none; 
            -webkit-user-select: none; 
            -webkit-tap-highlight-color: transparent;
            height: 100vh;
        }

        /* Subtle animated background grid */
        body::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 0;
            mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
            -webkit-mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
        }

        canvas { display: block; position: relative; z-index: 1; }

        /* --- TYPOGRAPHY --- */
        .font-tech { font-family: 'Orbitron', sans-serif; letter-spacing: 1px; text-transform: uppercase; }
        
        /* --- PREMIUM GLASS UI --- */
        .glass-panel { 
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.85) 0%, rgba(15, 23, 42, 0.65) 100%);
            backdrop-filter: blur(25px); 
            -webkit-backdrop-filter: blur(25px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5), inset 0 0 0 1px rgba(255, 255, 255, 0.02); 
            border-radius: 20px; 
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        /* Subtle shine effect on panels */
        .glass-panel::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03), transparent);
            transform: skewX(-25deg);
            pointer-events: none;
            transition: 0.5s;
        }
        .glass-panel:hover::before { left: 100%; transition: 0.7s; }

        .glass-nav { 
            background: rgba(2, 6, 23, 0.9); 
            backdrop-filter: blur(30px); 
            border-top: 1px solid rgba(255,255,255,0.08); 
            box-shadow: 0 -4px 30px rgba(0,0,0,0.6);
        }

        /* --- BUTTONS & INTERACTIVE --- */
        .glass-btn { 
            position: relative; 
            overflow: hidden; 
            background: linear-gradient(180deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%); 
            border: 1px solid rgba(255,255,255,0.12); 
            transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            cursor: pointer;
        }
        
        .glass-btn:active { transform: scale(0.96); filter: brightness(1.2); }
        .glass-btn::after { content: ''; position: absolute; top:0; left:-100%; width:100%; height:100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); transform: skewX(-20deg); transition: 0s; pointer-events: none; }
        .glass-btn:active::after { animation: shiny-wipe 0.4s; transition: 0s; }
        .glass-btn:hover { 
            border-color: rgba(255,255,255,0.4); 
            background: linear-gradient(180deg, rgba(255,255,255,0.12) 0%, rgba(255,255,255,0.05) 100%); 
            box-shadow: 0 0 15px rgba(255,255,255,0.1);
        }
        
        .glass-btn.selected { 
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.2), rgba(59, 130, 246, 0.1)) !important; 
            border-color: #22d3ee !important; 
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.25) inset, 0 0 10px rgba(34, 211, 238, 0.3) !important; 
            color: #fff !important;
            text-shadow: 0 0 5px rgba(34, 211, 238, 0.8) !important;
        }

        /* --- NAVIGATION --- */
        .nav-item { 
            color: #64748b; 
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            opacity: 0.7;
        }
        
        .nav-item:hover { opacity: 1; color: #94a3b8; }

        .nav-item.active { 
            color: #22d3ee; 
            opacity: 1;
            transform: translateY(-8px); 
            text-shadow: 0 0 15px rgba(34, 211, 238, 0.8); 
        }
        
        .nav-item.active .icon { 
            transform: scale(1.25); 
            filter: drop-shadow(0 0 8px rgba(34,211,238,0.6));
        }
        
        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 5px; height: 5px;
            background: #22d3ee;
            border-radius: 50%;
            box-shadow: 0 0 10px #22d3ee, 0 0 20px #22d3ee;
        }

        /* --- BADGES & TAGS --- */
        .currency-badge { 
            background: rgba(0,0,0,0.6); 
            padding: 5px 12px; 
            border-radius: 14px; 
            border: 1px solid rgba(255,255,255,0.15); 
            font-family: 'Orbitron'; 
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 13px; 
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .rarity-badge { 
            position: absolute; top: 6px; right: 6px; 
            padding: 4px 8px; border-radius: 6px; 
            font-size: 9px; font-weight: 900; 
            text-transform: uppercase; z-index: 10; 
            border: 1px solid rgba(255,255,255,0.3); 
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            letter-spacing: 1px;
            backdrop-filter: blur(4px);
            text-shadow: 0 1px 2px black;
        }
        
        /* SAISON 2 THEME: CYAN/PURPLE GLOW */
        .season-gold { 
            border-color: #22d3ee !important; 
            background: linear-gradient(145deg, rgba(34, 211, 238, 0.15), rgba(168, 85, 247, 0.1)) !important; 
            box-shadow: 0 0 25px rgba(34, 211, 238, 0.2) !important; 
            animation: pulse-border 4s infinite ease-in-out; 
        }
        @keyframes pulse-border { 0%, 100% { border-color: rgba(34,211,238,0.5); box-shadow: 0 0 20px rgba(34,211,238,0.2); } 50% { border-color: rgba(168,85,247,0.7); box-shadow: 0 0 30px rgba(168,85,247,0.3); } }

        .locked { opacity: 0.6; filter: grayscale(1) brightness(0.6); cursor: not-allowed; position: relative; } 
        .locked::after { content: 'üîí'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; opacity: 0.8; filter: drop-shadow(0 0 5px black); }

        /* --- ANIMATIONS --- */
        @keyframes gainFlash { 0% { transform: scale(1.0); filter: brightness(1); } 50% { transform: scale(1.2); filter: brightness(1.7); text-shadow: 0 0 20px currentColor; } 100% { transform: scale(1.0); } }
        .currency-badge.flash-coins { animation: gainFlash 0.4s ease-out; color: #fbbf24; border-color: #fbbf24; }
        .currency-badge.flash-gems { animation: gainFlash 0.4s ease-out; color: #a855f7; border-color: #a855f7; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        @keyframes shine { 
            0% { left: -100%; opacity: 0; } 
            50% { opacity: 0.5; } 
            100% { left: 100%; opacity: 0; } 
        }
        .btn-shine { position: relative; overflow: hidden; }
        .btn-shine::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: skewX(-20deg);
            animation: shine 3s infinite;
            pointer-events: none;
        }

        /* --- VFX LAYERS --- */
        #vignette { position: absolute; inset: 0; pointer-events: none; background: radial-gradient(circle, transparent 40%, rgba(0,0,0,0.95) 130%); z-index: 5; }
        #gas-overlay { position: absolute; inset: 0; pointer-events: none; opacity: 0; background: radial-gradient(circle, transparent 30%, rgba(34, 197, 94, 0.2) 90%); z-index: 4; transition: opacity 0.5s; mix-blend-mode: hard-light; }
        #flash-layer { position: absolute; inset: 0; pointer-events: none; background: white; opacity: 0; transition: opacity 0.05s; z-index: 100; mix-blend-mode: overlay; }

        /* --- CONTROLS --- */
        .joystick-zone { position: absolute; width: 140px; height: 140px; pointer-events: auto; z-index: 50; opacity: 0; transition: opacity 0.2s; }
        .joystick-zone.active { opacity: 1; }
        .stick-base { 
            width: 120px; height: 120px; border-radius: 50%; 
            background: rgba(255,255,255,0.03); 
            border: 2px solid rgba(255,255,255,0.08); 
            position: absolute; bottom: 50px; pointer-events: auto; 
            backdrop-filter: blur(4px);
            transition: all 0.2s;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        .stick-base.active { border-color: rgba(34, 211, 238, 0.5); background: radial-gradient(circle, rgba(34, 211, 238, 0.15) 0%, transparent 70%); box-shadow: 0 0 25px rgba(34, 211, 238, 0.2); }
        .stick-knob { width: 50px; height: 50px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #fff, #cbd5e1); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        
        .action-btn { 
            position: absolute; border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            z-index: 60; pointer-events: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.5); 
            transition: all 0.1s; border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(12px);
        }
        .action-btn:active { transform: scale(0.9); box-shadow: 0 2px 10px rgba(0,0,0,0.5); margin-top: 5px;}

        /* --- PASS TRACK --- */
        .pass-track-container { overflow-x: auto; padding: 40px 20px; scroll-behavior: smooth; position: relative; white-space: nowrap; -webkit-overflow-scrolling: touch; width: 100%; mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent); -webkit-mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent); }
        .pass-wrapper { display: inline-flex; flex-direction: column; min-width: 100%; position: relative; gap: 30px; padding: 0 40px; }
        .pass-track-main-line { position: absolute; left: 0; right: 0; top: 50%; height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; z-index: 0; transform: translateY(-50%); border: 1px solid rgba(255,255,255,0.05); }
        .pass-row { display: flex; gap: 40px; align-items: center; position: relative; z-index: 10; padding: 10px 0; }
        
        .pass-step { 
            width: 90px; height: 110px; 
            background: #1e293b; 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 16px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            position: relative; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            box-shadow: 0 8px 20px rgba(0,0,0,0.4); 
        }
        
        .pass-step.active { transform: scale(1.15) translateY(-5px); border-color: #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.2); z-index: 20; background: #334155; }
        .pass-step.claimed { opacity: 0.6; border-color: #22c55e; background: rgba(34, 197, 94, 0.05); filter: grayscale(0.5); }
        .pass-step.pro { background: radial-gradient(circle at top right, #312e81, #0f172a); border-color: rgba(168, 85, 247, 0.3); }
        .pass-step.active.pro { border-color: #d8b4fe; box-shadow: 0 0 30px rgba(168, 85, 247, 0.4); }
        
        .check-mark { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 32px; color: #22c55e; background: rgba(0,0,0,0.8); border-radius: 16px; backdrop-filter: blur(2px); animation: popIn 0.3s; z-index: 25; }
        
        /* --- INTRO & UTILS --- */
/* Intro Styles */
        .intro-text { filter: drop-shadow(0 0 20px rgba(168,85,247,0.5)); animation: introShine 3s infinite; }
        @keyframes introShine { 0% { filter: hue-rotate(0deg) drop-shadow(0 0 20px rgba(168,85,247,0.5)); } 50% { filter: hue-rotate(30deg) drop-shadow(0 0 40px rgba(34,211,238,0.8)); } 100% { filter: hue-rotate(0deg) drop-shadow(0 0 20px rgba(168,85,247,0.5)); } }
        .intro-bg { background: radial-gradient(circle at center, #1e1b4b 0%, #000 70%); }

        @keyframes slideIn { from { opacity:0; transform:translateX(-50px); } to { opacity:1; transform:translateX(0); } }
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .safe-pb { padding-bottom: max(90px, env(safe-area-inset-bottom) + 90px); }
        .menu-anim { background: radial-gradient(circle at 50% 30%, #172554 0%, #020617 60%); }

        /* --- FORMS --- */
        .profile-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 14px;
            color: white;
            font-family: 'Rajdhani', sans-serif;
            font-weight: bold;
            transition: all 0.3s ease;
            outline: none;
            backdrop-filter: blur(10px);
        }
        .profile-input:focus {
            background: rgba(0, 0, 0, 0.7);
            border-color: #22d3ee;
            box-shadow: 0 0 15px rgba(34, 211, 238, 0.2);
        }
        .profile-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
            font-style: italic;
        }

        /* --- CUSTOM SCROLLBAR FOR DESKTOP --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }
        /* --- SETTINGS & EXTRAS --- */
        .settings-grp { margin-bottom: 12px; }
        .settings-label { display: block; font-size: 11px; font-weight: bold; color: #94a3b8; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .diff-btn { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; position: relative; overflow: hidden; }
        .mod-btn { font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Rank Progress Fill */
        .rank-progress-bg { width: 100%; height: 6px; background: rgba(0,0,0,0.5); border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .rank-progress-fill { height: 100%; transition: width 0.5s ease-out; box-shadow: 0 0 10px currentColor; }

        /* --- PATCH NOTES --- */
        .patch-note { 
            margin-bottom: 40px; 
            padding-bottom: 20px; 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            position: relative;
            transition: all 0.3s ease;
        }
        .patch-note:hover {
            background: linear-gradient(90deg, rgba(255,255,255,0.03), transparent);
            padding-left: 15px;
            border-left: 2px solid #22d3ee;
        }
        .patch-note:last-child { border-bottom: none; margin-bottom: 0; }
        .patch-note h3 {
            color: #22d3ee;
            font-family: 'Orbitron'; 
            margin-bottom: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .patch-note h3::before { content: 'üí†'; font-size: 10px; }
        .patch-note ul { list-style: none; padding: 0; }
        .patch-note li { 
            margin-bottom: 4px; 
            padding-left: 14px; 
            position: relative;
            color: #ccc;
        }
        .patch-note li::before {
            content: '‚Ä¢';
            color: #a855f7;
            position: absolute;
            left: 0;
            font-weight: bold;
        }
    </style>
</head><body>
    <canvas id="gameCanvas"></canvas>
    <div id="gas-overlay"></div>
    <div id="vignette"></div>
    <div id="flash-layer"></div>
    <div id="season-particles" class="absolute inset-0 pointer-events-none overflow-hidden z-0"></div>
    <div id="ui-layer" class="absolute inset-0 pointer-events-none overflow-hidden z-10">
        <div id="hud" class="hidden w-full h-full relative">
            <div class="absolute top-4 left-4 flex flex-col gap-4 pointer-events-auto">
                <div class="glass-panel p-2 flex items-center gap-3 pr-4 scale-90 origin-top-left md:scale-100">
                    <div class="relative">
                        <div class="w-14 h-14 rounded-xl bg-gray-900 border border-white/20 flex items-center justify-center text-2xl shadow-lg overflow-hidden">
                            <span id="hud-icon" class="z-10 relative">ü§ñ</span>
                            <div class="absolute inset-0 bg-gradient-to-br from-blue-600/40 to-transparent"></div>
                        </div>
                        <div class="absolute -bottom-2 -right-1 bg-black border border-gray-600 text-[9px] px-1.5 py-0.5 rounded text-yellow-400 font-bold" id="hud-lvl">LVL 1</div>
                    </div>

                    <div class="flex flex-col w-28 gap-1">

                        <div class="h-2.5 bg-gray-800 rounded-full overflow-hidden border border-gray-600 relative"><div id="hud-hp-bar" class="h-full bg-green-500" style="width: 100%;"></div></div>
                        <div class="flex gap-1 h-1 mt-0.5">
                            <div id="ammo-1" class="flex-1 bg-orange-500 rounded-full opacity-50 transition"></div>
                            <div id="ammo-2" class="flex-1 bg-orange-500 rounded-full opacity-50 transition"></div>
                            <div id="ammo-3" class="flex-1 bg-orange-500 rounded-full opacity-50 transition"></div>
                        </div>
                    </div>
                </div>
                <div class="glass-panel p-1 border-white/20 bg-black/50"><canvas id="minimap" width="100" height="100" class="rounded-lg bg-black/80 opacity-90"></canvas></div>
            </div>
            <div class="absolute top-6 left-1/2 -translate-x-1/2 text-center pointer-events-auto">
                <div id="hud-score" class="font-tech text-5xl font-bold text-white leading-none drop-shadow-[0_0_15px_rgba(255,255,255,0.4)]">0</div>
                <div class="text-[10px] font-bold text-blue-400 bg-black/50 px-2 rounded mt-1" id="hud-sub">VAGUE 1</div>
                <div id="hud-timer" class="text-xl font-black text-yellow-400 drop-shadow-lg mt-1 hidden">03:00</div>
                <div id="hud-objective" class="text-xs font-bold text-yellow-300 mt-1 hidden">Objectif</div>
            </div>
            <div class="absolute top-4 right-4 flex flex-col gap-4 pointer-events-auto items-end">
                <button onclick="window.game.togglePause()" class="glass-panel w-10 h-10 flex items-center justify-center hover:bg-white/10 text-lg transition active:scale-90">‚è∏</button>
            </div>
            <div id="boss-ui" class="hidden absolute top-24 left-1/2 -translate-x-1/2 w-3/4 max-w-lg pointer-events-auto transition-all duration-500">
                <div class="flex justify-between text-[10px] text-red-400 font-bold mb-1 uppercase tracking-widest"><span id="boss-name">BOSS</span><span id="boss-pct">100%</span></div>
                <div class="h-4 bg-red-950/80 border border-red-500/50 rounded-full overflow-hidden shadow-[0_0_20px_rgba(220,38,38,0.4)]"><div id="boss-bar" class="h-full bg-gradient-to-r from-red-600 to-red-500 w-full transition-all duration-200"></div></div>
            </div>
            <div id="kill-feed" class="absolute top-32 left-4 flex flex-col gap-2 w-48 pointer-events-none"></div>
            <div id="notif-area" class="absolute top-48 left-1/2 -translate-x-1/2 pointer-events-none flex flex-col items-center gap-2 w-full z-30"></div>
            <button id="btn-emote" class="absolute top-32 right-4 w-10 h-10 rounded-full glass-panel flex items-center justify-center text-xl pointer-events-auto active:scale-90 transition z-50" onmousedown="window.ui.toggleEmoteWheel()" ontouchstart="event.stopPropagation(); window.ui.toggleEmoteWheel()">üòÄ</button>
            <div id="emote-wheel" class="emote-wheel hidden"></div>
            <div id="mobile-controls" class="hidden absolute inset-0 z-40">
                <div id="stick-left-base" class="stick-base" style="left: 40px; bottom: 40px;"><div class="stick-knob"></div></div>
                <div id="stick-right-base" class="stick-base" style="right: 40px; bottom: 40px;"><div class="stick-knob"></div></div>
                <button id="btn-gadget" class="action-btn bottom-36 right-12 w-16 h-16 bg-green-900/90 border-2 border-green-500 active:scale-90 flex items-center justify-center pointer-events-auto transition shadow-lg" ontouchstart="event.stopPropagation(); window.game.player?.useGadget()" onmousedown="window.game.player?.useGadget()"><span class="font-tech font-bold text-[10px] z-10">GADGET</span><div class="absolute -top-1 -right-1 bg-black border border-white text-[9px] w-5 h-5 rounded-full flex items-center justify-center" id="gadget-count">3</div></button>
                <button id="btn-dash" class="action-btn bottom-12 right-36 w-20 h-20 rounded-full glass-panel border border-white/40 active:scale-90 flex items-center justify-center pointer-events-auto transition shadow-lg bg-blue-900/30" ontouchstart="event.stopPropagation(); window.game.player?.dash()" onmousedown="window.game.player?.dash()"><span class="text-3xl">‚ö°</span><div id="dash-cd" class="absolute inset-0 bg-black/70 origin-bottom h-0 transition-all duration-75 rounded-full"></div></button>
            </div>
        </div>
        
        <div id="intro-screen" class="absolute inset-0 z-[100] bg-black flex flex-col items-center justify-center pointer-events-auto transition-opacity duration-1000 hidden">
            <div class="intro-bg absolute inset-0 opacity-50"></div>
            <div class="relative z-10 flex flex-col items-center animate-popIn">
                <h1 class="text-7xl md:text-9xl font-black italic tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-purple-500 to-pink-500 mb-4 intro-text">mBATTLE</h1>
                <div class="text-xl md:text-2xl font-bold text-white tracking-[1em] uppercase animate-pulse">Saison 2</div>
                <div class="mt-2 text-cyan-400 font-mono text-sm">CYBER FUTURE</div>
            </div>
        </div>

        <div id="menu-screen" class="absolute inset-0 menu-anim pointer-events-auto z-50 flex flex-col">
            <div class="w-full h-16 flex items-center justify-between px-5 pt-safe z-30 bg-gradient-to-b from-black/80 to-transparent">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-cyan-500/20 border border-cyan-400/30 flex items-center justify-center text-xl text-cyan-400">üåÄ</div>
                    <div><div class="font-tech font-bold leading-none text-lg">mBATTLE</div><div class="text-[10px] text-cyan-400 font-bold tracking-widest">v1.4.8</div></div>
                </div>
                <div class="flex gap-3">
                    <div class="currency-badge"><span class="text-yellow-400">ü™ô</span> <span id="top-coins">0</span></div>
                    <div class="currency-badge"><span class="text-purple-400">üíé</span> <span id="top-gems">0</span></div>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto safe-pb p-5 hide-scrollbar relative">
                <div id="tab-play" class="tab-content flex flex-col items-center justify-center min-h-[65vh] gap-6 animate-fadeIn pb-40">
                    <div onclick="window.ui.openTrophyRoad()" class="w-full max-w-md glass-panel p-5 border-l-4 border-cyan-500 bg-cyan-900/10 relative overflow-hidden cursor-pointer active:scale-95 transition hover:brightness-110">
                        <div class="flex items-center justify-between mb-2 relative z-10">
                            <div><div class="text-[10px] text-gray-400 uppercase font-bold">Rang Actuel</div><div class="text-2xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-cyan-200 to-cyan-500 font-tech" id="menu-rank">BRONZE I</div></div>
                            <div class="text-center"><div class="text-2xl">üèÜ</div><div class="font-bold text-white text-xl" id="menu-trophies">0</div></div>
                        </div>
                        <div class="flex justify-between text-[10px] font-bold text-gray-300 mt-1 relative z-10">
                            <span id="rank-progress-text">Encore 100 üèÜ avant BRONZE II</span><span id="rank-progress-pct">0%</span>
                        </div>
                        <div class="rank-progress-bg relative z-10"><div id="rank-progress-fill" class="rank-progress-fill bg-cyan-500"></div></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 w-full max-w-md">
                        <div onclick="window.ui.showTab('starters')" class="glass-panel p-4 flex flex-col items-center justify-center aspect-square active:scale-95 transition bg-blue-900/10 border-blue-500/30">
                            <div class="text-[10px] text-blue-300 font-bold mb-2 uppercase">H√©ros</div><div class="text-5xl mb-2 drop-shadow-xl" id="play-icon">üéØ</div><div class="font-black text-lg leading-none" id="play-starter">Soldier</div>
                        </div>
                        <div onclick="window.ui.showTab('modes')" class="glass-panel p-4 flex flex-col items-center justify-center aspect-square active:scale-95 transition bg-purple-900/10 border-purple-500/30">
                            <div class="text-[10px] text-purple-300 font-bold mb-2 uppercase">Mission</div><div class="text-5xl mb-2 drop-shadow-xl" id="play-mode-icon">üî•</div><div class="font-black text-lg leading-none" id="play-mode">Survie</div>
                        </div>
                    </div>
                    <!-- NOUVEAU BOUTON MAP MAKER -->
                    <div onclick="window.ui.startMapMaker()" class="w-full max-w-md glass-panel p-3 mt-4 flex items-center justify-between cursor-pointer active:scale-95 transition hover:bg-white/5 border-green-500/30">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl">üèóÔ∏è</div>
                            <div><div class="font-bold text-green-400">CR√âATIF</div><div class="text-[10px] text-gray-400">Cr√©e ton propre terrain</div></div>
                        </div>
                        <div class="text-2xl text-gray-600">‚ûú</div>
                    </div>
                    <div class="w-full max-w-md glass-panel p-4 flex flex-col items-center mt-4">
                        <div class="text-[10px] text-yellow-300 font-bold mb-3 uppercase tracking-widest">DIFFICULT√â</div>
                        <div class="flex gap-3 w-full">
                            <button id="diff-easy" onclick="window.game.setDifficulty('easy')" style="--tw-shadow-color:#22c55e;" class="diff-btn flex-1 glass-btn py-3 rounded-xl font-bold text-sm bg-gradient-to-r from-green-600/30 to-green-900/30 border-green-600/50 text-green-400 active:scale-95 transition">Facile</button>
                            <button id="diff-normal" onclick="window.game.setDifficulty('normal')" style="--tw-shadow-color:#3b82f6;" class="diff-btn flex-1 glass-btn py-3 rounded-xl font-bold text-sm bg-gradient-to-r from-blue-600/30 to-blue-900/30 border-blue-600/50 text-blue-400 active:scale-95 transition">Normal</button>
                            <button id="diff-hard" onclick="window.game.setDifficulty('hard')" style="--tw-shadow-color:#ef4444;" class="diff-btn flex-1 glass-btn py-3 rounded-xl font-bold text-sm bg-gradient-to-r from-red-600/30 to-red-900/30 border-red-600/50 text-red-400 active:scale-95 transition">Difficile</button>
                            <button id="diff-expert" onclick="window.game.setDifficulty('expert')" style="--tw-shadow-color:#a855f7;" class="diff-btn flex-1 glass-btn py-3 rounded-xl font-bold text-sm bg-gradient-to-r from-purple-600/30 to-purple-900/30 border-purple-600/50 text-purple-400 active:scale-95 transition">Expert</button>
                        </div>
                        <div class="text-[10px] text-purple-300 font-bold mb-2 uppercase tracking-widest mt-4">MODIFICATEURS</div>
                        <div class="grid grid-cols-3 gap-2 w-full">
                            <button onclick="window.game.setModifier('normal')" id="mod-normal" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-gray-300">Classique</button>
                            <button onclick="window.game.setModifier('oneshot')" id="mod-oneshot" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-red-400">‚ò†Ô∏è One Shot</button>
                            <button onclick="window.game.setModifier('poison')" id="mod-poison" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-green-400">üß™ Poison</button>
                            <button onclick="window.game.setModifier('speed')" id="mod-speed" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-yellow-400">‚ö° Speed</button>
                            <button onclick="window.game.setModifier('vampire')" id="mod-vampire" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-pink-500">üßõ Vampire</button>
                            <button onclick="window.game.setModifier('infinite')" id="mod-infinite" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-blue-400">‚ôæÔ∏è Infini</button>
                            <button onclick="window.game.setModifier('explosive')" id="mod-explosive" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-orange-500">üí• Explosif</button>
                            <button onclick="window.game.setModifier('recoil')" id="mod-recoil" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-white">üîô Recul</button>
                            <button onclick="window.game.setModifier('giant')" id="mod-giant" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-purple-600">üêò G√©ant</button>
                            <button onclick="window.game.setModifier('blind')" id="mod-blind" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-gray-500">üåë Aveugle</button>
                            <button onclick="window.game.setModifier('slow_mo')" id="mod-slow_mo" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-blue-300">üêå Slow Mo</button>
                            <button onclick="window.game.setModifier('chaos')" id="mod-chaos" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-purple-500">üé≤ Chaos</button>
                        </div>
                    </div>
                    <button onclick="window.game.start()" class="btn-shine w-full max-w-md bg-gradient-to-r from-blue-600 to-indigo-600 h-20 rounded-2xl shadow-[0_0_40px_rgba(37,99,235,0.4)] flex items-center justify-center gap-4 active:scale-95 transition transform hover:-translate-y-1 mt-4 border border-white/20 hover:shadow-[0_0_60px_rgba(37,99,235,0.6)] hover:from-blue-500 hover:to-indigo-500 relative overflow-hidden group">
                        <div class="absolute inset-0 bg-white/20 blur-xl opacity-0 group-hover:opacity-100 transition duration-700 animate-pulse"></div>
                        <span class="text-3xl font-black italic tracking-tighter relative z-10">JOUER</span><span class="text-2xl animate-bounce relative z-10">üöÄ</span>
                    </button>
                </div>
                <div id="tab-pass" class="tab-content hidden animate-fadeIn w-full max-w-5xl mx-auto pb-40">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-3xl font-black flex items-center gap-2 font-tech"><span class="text-cyan-400">///</span> mPASS</h2>
                        <!-- TITRE S2 ANIM√â -->
                        <div class="text-right">
                            <div class="text-xl md:text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400 animate-pulse font-tech tracking-widest drop-shadow-[0_0_10px_rgba(34,211,238,0.5)]">SAISON 2: TEMP√äTE CYBER</div>
                            <div class="text-[10px] text-gray-400 font-bold tracking-widest uppercase mt-1">Prochaine saison le Samedi 27 D√©cembre 2025</div>
                        </div>
                    </div>



                    <div class="glass-panel p-6 mb-6 bg-gradient-to-r from-cyan-900/20 to-transparent border-cyan-500/30">
                        <div class="flex justify-between items-center mb-4">
                             <div><div class="text-2xl font-black text-white">Palier <span id="pass-lvl">1</span></div><div class="text-xs text-gray-400" id="pass-xp-txt">0/100 XP</div></div>
                             <!-- Mise √† jour du prix du Pass Pro -->
                             <div id="pass-pro-status"></div>
                        </div>
                        <div class="h-4 bg-black/50 rounded-full overflow-hidden"><div id="pass-bar" class="h-full bg-gradient-to-r from-cyan-500 to-purple-500 w-0 transition-all duration-300"></div></div>
                    </div>
                    <!-- Le conteneur pass-track-container est d√©filable -->
                    <div class="pass-track-container hide-scrollbar" id="pass-scroll-container">
                        <div class="pass-wrapper">
                             <div class="pass-track-main-line"></div>
                             <div class="pass-row" id="pass-track-free"></div>
                             <div class="pass-row pro" id="pass-track-pro"></div>
                             <div class="pass-row max" id="pass-track-max"></div>
                        </div>
                    </div>
                </div>
                <!-- TAB CLUB (NOUVEAU) -->
                <div id="tab-clubs" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto pb-40">
                     <h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-orange-500">///</span> CLUB</h2>
                     <div id="club-container" class="glass-panel p-6 min-h-[60vh] flex flex-col items-center justify-center text-center">
                         <div class="text-6xl mb-4">üõ°Ô∏è</div>
                         <h3 class="text-2xl font-black text-white mb-2">REJOINS UN CLUB</h3>
                         <p class="text-gray-400 mb-6 text-sm">Discute, joue et progresse avec tes amis !</p>
                         <button onclick="window.ui.createClub()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg mb-4 w-full max-w-xs">CR√âER UN CLUB</button>
                         
                         <!-- SEARCH BAR CLUBS -->
                         <div class="w-full max-w-md mb-4 relative">
                             <input type="text" placeholder="Trouver un club..." class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 pl-10 text-white focus:outline-none focus:border-orange-500 transition" oninput="window.ui.search('clubs', this.value)">
                             <div class="absolute left-3 top-3.5 text-gray-400">üîç</div>
                         </div>

                         <div class="grid grid-cols-1 gap-2 w-full max-w-md" id="club-list">
                             <!-- Dynamic Content -->
                         </div>
                     </div>
                </div>

                <!-- TAB AVENTURES (NOUVEAU) -->
                <div id="tab-adventures" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto pb-40">
                     <h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-emerald-500">///</span> AVENTURES</h2>
                     
                     <!-- SEARCH BAR ADVENTURES -->
                     <div class="w-full mb-4 relative">
                         <input type="text" placeholder="Rechercher une histoire..." class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 pl-10 text-white focus:outline-none focus:border-emerald-500 transition" oninput="window.ui.search('adventures', this.value)">
                         <div class="absolute left-3 top-3.5 text-gray-400">üîç</div>
                     </div>

                     <div id="adventure-list" class="flex flex-col gap-4"></div>
                </div>
                <div id="tab-starters" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto pb-40">
                    <h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-blue-500">///</span> ARMURERIE</h2>
                    <!-- SEARCH BAR HEROES -->
                    <div class="w-full mb-4 relative">
                        <input type="text" placeholder="Rechercher un h√©ros..." class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 pl-10 text-white focus:outline-none focus:border-blue-500 transition" oninput="window.ui.search('starters', this.value)">
                        <div class="absolute left-3 top-3.5 text-gray-400">üîç</div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-10" id="list-starters"></div>
                </div>
                <div id="tab-modes" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto pb-40"><h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-purple-500">///</span> MISSIONS</h2><div class="grid grid-cols-1 gap-3 mb-8" id="list-modes"></div><h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-gray-400">TERRAINS</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-3" id="list-arenas"></div></div>
                <div id="tab-emotes" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto pb-40">
                    <h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-pink-500">///</span> COLLECTION</h2>
                    <div class="glass-panel p-6 mb-4"><div class="text-xs text-gray-400 mb-4 uppercase font-bold">Emotes √âquip√©es (Max 8)</div><div class="flex justify-center gap-4 mb-2 flex-wrap" id="equipped-emotes"></div></div>
                    <!-- SEARCH BAR EMOTES -->
                    <div class="w-full mb-4 relative">
                        <input type="text" placeholder="Rechercher une emote..." class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 pl-10 text-white focus:outline-none focus:border-pink-500 transition" oninput="window.ui.search('emotes', this.value)">
                        <div class="absolute left-3 top-3.5 text-gray-400">üîç</div>
                    </div>
                    <div class="grid grid-cols-4 md:grid-cols-6 gap-3" id="list-emotes"></div>
                </div>
                <div id="tab-shop" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto pb-40">
                    <h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-yellow-500">///</span> MEGA MALL</h2>
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-xs text-gray-400">Nouveaux items: <span id="shop-timer" class="text-yellow-400 font-mono">--:--</span></div>
                        <button onclick="window.ui.refreshShop(true)" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-1 px-3 rounded-lg text-xs shadow-lg flex items-center gap-1 active:scale-95 transition">üîÑ 10üíé</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="shop-offers"></div>
                </div>
                <!-- TAB FRIENDS (NOUVEAU) -->
                <div id="tab-friends" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto pb-40">
                     <h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-green-500">///</span> AMIS</h2>
                     <div id="friends-container" class="glass-panel p-6 flex flex-col items-center justify-center text-center">
                         <div class="text-6xl mb-4">üë•</div>
                         <h3 class="text-2xl font-black text-white mb-2">LISTE D'AMIS</h3>
                         <p class="text-gray-400 mb-6 text-sm">Ajoute des amis pour jouer et discuter avec eux !</p>
                         
                         <!-- SEARCH BAR FRIENDS -->
                         <div class="w-full mb-4 relative max-w-md">
                             <input type="text" placeholder="Rechercher un ami (ex: Toto)..." class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 pl-10 text-white focus:outline-none focus:border-green-500 transition" oninput="window.ui.search('friends', this.value)">
                             <div class="absolute left-3 top-3.5 text-gray-400">üîç</div>
                         </div>

                         <button onclick="window.ui.addFriend()" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg mb-4 w-full max-w-xs flex items-center justify-center gap-2"><span>‚ûï</span> AJOUTER UN AMI VIA TAG</button>
                         
                         <!-- LISTE AMIS -->
                         <div class="w-full max-w-md mt-4">
                             <div class="flex justify-between items-center mb-2 px-2">
                                 <h4 class="text-xs font-bold text-gray-500 uppercase tracking-widest">En Ligne</h4>
                                 <span class="text-[10px] text-green-400 bg-green-900/20 px-2 py-0.5 rounded border border-green-500/20" id="online-count">0</span>
                             </div>
                             <div class="grid grid-cols-1 gap-2" id="friends-list">
                                 <!-- Dynamic Content -->
                             </div>
                         </div>
                     </div>
                </div>
                <div id="tab-infos" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto pb-40">
                    <h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-gray-500">///</span> INFOS</h2>
                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">‚ò†Ô∏è</div><div class="text-[10px] text-gray-500 uppercase font-bold">Kills</div><div class="text-2xl font-bold" id="stat-kills">0</div></div>
                        <div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">üåä</div><div class="text-[10px] text-gray-500 uppercase font-bold">Max Vague</div><div class="text-2xl font-bold" id="stat-wave">0</div></div>
                        <div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">üéÆ</div><div class="text-[10px] text-gray-500 uppercase font-bold">Parties</div><div class="text-2xl font-bold" id="stat-games">0</div></div>
                        <div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">‚öîÔ∏è</div><div class="text-[10px] text-gray-500 uppercase font-bold">Victoires</div><div class="text-2xl font-bold" id="stat-wins">0</div></div>
                        <div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">üíÄ</div><div class="text-[10px] text-gray-500 uppercase font-bold">D√©faites</div><div class="text-2xl font-bold" id="stat-losses">0</div></div>
                        <div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">ü¶∏</div><div class="text-[10px] text-gray-500 uppercase font-bold">H√©ros D√©bloqu√©s</div><div class="text-2xl font-bold" id="stat-unlocked">0/20</div></div>
                        <div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">üí•</div><div class="text-[10px] text-gray-500 uppercase font-bold">D√©g√¢ts Totaux</div><div class="text-2xl font-bold" id="stat-dmg">0</div></div>
                        <div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">üé´</div><div class="text-[10px] text-gray-500 uppercase font-bold">Palier Pass Max</div><div class="text-2xl font-bold" id="stat-pass-tier">1</div></div>
                    </div>
                    
                    <h3 class="text-xl font-bold mb-4 text-blue-400">COMPARATIF mPASS</h3>
                    <div class="glass-panel p-4 mb-8 overflow-hidden relative">
                        <div class="absolute top-0 right-0 p-2 opacity-20 text-6xl">üé´</div>
                        <table class="w-full text-sm text-left text-gray-300 relative z-10">
                            <tr class="border-b border-gray-700 text-[10px] md:text-xs text-gray-500 uppercase tracking-wider">
                                <th class="py-3 pl-2">Avantage</th>
                                <th class="py-3 text-center text-gray-400">Gratuit</th>
                                <th class="py-3 text-center text-purple-400">Pro</th>
                                <th class="py-3 text-center text-yellow-400">Max</th>
                            </tr>
                            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                                <td class="py-3 pl-2 font-bold flex items-center gap-2"><span class="text-xl">üí∞</span> Valeur Totale</td>
                                <td class="text-center text-gray-400">Standard</td>
                                <td class="text-center text-purple-300 font-bold">x10</td>
                                <td class="text-center text-yellow-300 font-black">x25</td>
                            </tr>
                            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                                <td class="py-3 pl-2 font-bold flex items-center gap-2"><span class="text-xl">üíé</span> Gemmes</td>
                                <td class="text-center">150</td>
                                <td class="text-center text-green-400 font-bold">2 500</td>
                                <td class="text-center text-green-400 font-black">5 000+</td>
                            </tr>
                            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                                <td class="py-3 pl-2 font-bold flex items-center gap-2"><span class="text-xl">ü™ô</span> Pi√®ces</td>
                                <td class="text-center">2 000</td>
                                <td class="text-center text-green-400 font-bold">15 000</td>
                                <td class="text-center text-green-400 font-black">30 000+</td>
                            </tr>
                            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                                <td class="py-3 pl-2 font-bold flex items-center gap-2"><span class="text-xl">üì¶</span> Mega Caisses</td>
                                <td class="text-center">-</td>
                                <td class="text-center font-bold">5</td>
                                <td class="text-center font-black">15</td>
                            </tr>
                            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                                <td class="py-3 pl-2 font-bold flex items-center gap-2"><span class="text-xl">üëï</span> Skins Exclusifs</td>
                                <td class="text-center">-</td>
                                <td class="text-center font-bold">‚úÖ</td>
                                <td class="text-center font-black">‚úÖ + Mythique</td>
                            </tr>
                            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                                <td class="py-3 pl-2 font-bold flex items-center gap-2"><span class="text-xl">‚ö°</span> Boost Progression</td>
                                <td class="text-center">-</td>
                                <td class="text-center">-</td>
                                <td class="text-center font-black text-yellow-400">+20% XP</td>
                            </tr>
                        </table>
                    </div>

                    <h3 class="text-xl font-bold mb-4 text-blue-400">GUIDE DU JEU</h3>
                    
                    <div class="mb-6">
                        <h4 class="text-sm font-bold text-purple-400 mb-2 uppercase tracking-widest border-b border-purple-500/30 pb-1">MISSIONS</h4>
                        <div class="grid gap-2 text-xs text-gray-300">
                            <div class="flex gap-2"><span class="text-xl">üßü</span> <div><b class="text-white">Survie :</b> R√©siste aux vagues infinies d'ennemis. Combien de temps tiendras-tu ?</div></div>
                            <div class="flex gap-2"><span class="text-xl">üèÜ</span> <div><b class="text-white">Class√© :</b> Mode comp√©titif intense. Gagne des points de classement (RP) pour monter en grade.</div></div>
                            <div class="flex gap-2"><span class="text-xl">‚öîÔ∏è</span> <div><b class="text-white">Duel 1v1 :</b> Affronte un IA d'√©lite dans une ar√®ne ferm√©e. Que le meilleur gagne.</div></div>
                            <div class="flex gap-2"><span class="text-xl">üíé</span> <div><b class="text-white">Braquage :</b> Infiltre la base et d√©truis le coffre-fort avant la fin du chrono !</div></div>
                            <div class="flex gap-2"><span class="text-xl">üëπ</span> <div><b class="text-white">Boss Rush :</b> Encha√Æne 3 Boss majeurs sans r√©pit. Pour les experts.</div></div>
                            <div class="flex gap-2"><span class="text-xl">üåã</span> <div><b class="text-white">Raid Titan :</b> Survivre contre 5 Boss simultan√©s. Chaos total garanti.</div></div>
                            <div class="flex gap-2"><span class="text-xl">üõ°Ô∏è</span> <div><b class="text-white">D√©fense :</b> Emp√™che les hordes de d√©truire le Cristal d'√ânergie au centre.</div></div>
                            <div class="flex gap-2"><span class="text-xl">üöÇ</span> <div><b class="text-white">Train Express :</b> Escorte le train de marchandises. Ne le laisse pas se faire d√©truire !</div></div>
                            <div class="flex gap-2"><span class="text-xl">üí∞</span> <div><b class="text-white">Voleur :</b> R√©cup√®re 10 sacs d'or √©parpill√©s sur la carte sans te faire tuer.</div></div>
                            <div class="flex gap-2"><span class="text-xl">üåÄ</span> <div><b class="text-white">Cyber Hack :</b> Reste dans la zone du terminal pour le pirater √† 100%.</div></div>
                            <div class="flex gap-2"><span class="text-xl">üò°</span> <div><b class="text-white">Carnage :</b> Mode bourrin. √âlimine 50 ennemis le plus vite possible !</div></div>
                            <div class="flex gap-2"><span class="text-xl">‚≠ï</span> <div><b class="text-white">Zone :</b> Capture et maintiens la position centrale pour gagner.</div></div>
                            <div class="flex gap-2"><span class="text-xl">üëë</span> <div><b class="text-white">Chasse :</b> Trouve et ouvre tous les coffres cach√©s sur la carte.</div></div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h4 class="text-sm font-bold text-green-400 mb-2 uppercase tracking-widest border-b border-green-500/30 pb-1">TERRAINS</h4>
                        <div class="grid grid-cols-2 gap-2 text-xs text-gray-300">
                            <div><b class="text-white">Neon Tokyo :</b> M√©galopole cyberpunk sous une pluie √©ternelle et des n√©ons aveuglants.</div>
                            <div><b class="text-white">Sandstorm :</b> D√©sert aride balay√© par des temp√™tes de sable violentes. Visibilit√© r√©duite.</div>
                            <div><b class="text-white">Ice Age :</b> Toundra glaciale. Le sol est glissant et le froid est mordant.</div>
                            <div><b class="text-white">Jungle :</b> For√™t dense et sauvage. Parfait pour les embuscades.</div>
                            <div><b class="text-white">Magma :</b> Terre br√ªl√©e par la lave en fusion. Attention aux √©ruptions.</div>
                            <div><b class="text-white">Ruines :</b> Vestiges d'une ancienne civilisation, d√©lav√©s par la pluie acide.</div>
                            <div><b class="text-white">Cyber City :</b> Architecture futuriste propre et froide. Flux de donn√©es visibles.</div>
                            <div><b class="text-white">N√©buleuse :</b> Plateforme spatiale d√©rivant dans le vide cosmique.</div>
                            <div><b class="text-white">Mainframe :</b> Au c≈ìur du syst√®me informatique. Murs de code binaire.</div>
                            <div><b class="text-white">Moon Base :</b> Station lunaire √† faible gravit√© et ciel √©toil√©.</div>
                            <div><b class="text-white">Cristal :</b> Caverne souterraine illumin√©e par des cristaux g√©ants magiques.</div>
                            <div><b class="text-white">Solaris :</b> Surface d'une √©toile mourante, chaleur extr√™me et vents solaires.</div>
                            <div><b class="text-white">Marais :</b> Zone humide et toxique, brouillard verd√¢tre et v√©g√©tation pourrie.</div>
                            <div><b class="text-white">Usine :</b> Zone industrielle pollu√©e, machines rouill√©es et fum√©e noire.</div>
                            <div><b class="text-white">N√©ant :</b> Dimension parall√®le vide et sombre. Seule la lumi√®re des combattants existe.</div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h4 class="text-sm font-bold text-yellow-400 mb-2 uppercase tracking-widest border-b border-yellow-500/30 pb-1">MODIFICATEURS</h4>
                        <div class="grid gap-2 text-xs text-gray-300">
                            <div><b class="text-white">‚ò†Ô∏è One Shot :</b> Tout le monde a 1 PV. Une balle = mort.</div>
                            <div><b class="text-white">üß™ Poison :</b> D√©g√¢ts sur la dur√©e pour tous les tirs.</div>
                            <div><b class="text-white">‚ö° Speed :</b> Tout le monde (toi + ennemis) est ultra rapide.</div>
                            <div><b class="text-white">üßõ Vampire :</b> Tu voles de la vie en tirant.</div>
                            <div><b class="text-white">‚ôæÔ∏è Infini :</b> Munitions illimit√©es.</div>
                            <div><b class="text-white">üí• Explosif :</b> Les ennemis explosent √† leur mort.</div>
                            <div><b class="text-white">üîô Recul :</b> Tirer te propulse en arri√®re.</div>

                            <div><b class="text-white">üêò G√©ant :</b> Tout le monde est g√©ant (x2 taille).</div>
                            <div><b class="text-white">üåë Aveugle :</b> Champ de vision tr√®s r√©duit.</div>
                            <div><b class="text-white">üêå Slow Mo :</b> Le temps passe 2x moins vite.</div>
                            <div><b class="text-white">üé≤ Chaos :</b> Un modificateur al√©atoire toutes les 10s !</div>
                        </div>
                    </div>

                    <div class="glass-panel p-6 mb-6 hidden md:block"><h3 class="text-xl font-bold text-blue-400 mb-4">COMMANDES PC</h3><table class="w-full text-sm text-left text-gray-300"><tr class="border-b border-gray-700"><th class="py-2">Action</th><th class="py-2">Touche</th></tr><tr><td class="py-2">D√©placement</td><td class="font-mono text-yellow-400">Z Q S D</td></tr><tr><td class="py-2">Viser</td><td class="font-mono text-yellow-400">Souris</td></tr><tr><td class="py-2">Tirer</td><td class="font-mono text-yellow-400">Clic Gauche</td></tr><tr><td class="py-2">Dash</td><td class="font-mono text-yellow-400">Espace</td></tr><tr><td class="py-2">Gadget</td><td class="font-mono text-yellow-400">E</td></tr><tr><td class="py-2">Emote</td><td class="font-mono text-yellow-400">V</td></tr></table></div>
                    
                    <h3 class="text-xl font-bold mb-4 text-blue-400">PATCH NOTES</h3>
                    <div class="glass-panel p-6 text-sm text-gray-300">
                    <div class="patch-note relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-green-500 text-[10px] text-black font-black px-2 py-0.5 rounded-bl-lg z-10 animate-pulse shadow-lg">NEW</div>
                        <h3>v1.4.7 (SOCIAL UPDATE 2.0)</h3>
                        <ul>
                            <li>üë• <b>Amis:</b> Recherche + Ajout d'amis via Tag avec UI d√©di√©e.</li>
                            <li>üîç <b>Recherche:</b> Ajout√© barre de recherche pour Qu√™tes et Aventures.</li>
                            <li>‚ú® <b>Interface:</b> Am√©lioration interfaces Clubs et Amis.</li>
                            <li>üêõ <b>Fixes:</b> Corrections bugs divers.</li>
                        </ul>
                    </div>
                    <div class="patch-note relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-yellow-400 text-[10px] text-black font-black px-2 py-0.5 rounded-bl-lg z-10 shadow-lg opacity-80">ULTIMATE</div>
                        <h3>v1.4.4 (FINAL POLISH)</h3>
                        <ul>
                            <li>‚ú® <b>Polissage:</b> Interface plus fluide et r√©active.</li>
                            <li>üé® <b>Visuel:</b> Nouveaux effets de particules et lueurs.</li>
                            <li>üõ°Ô∏è <b>√âquilibrage:</b> Bots et h√©ros ajust√©s pour le fun.</li>
                            <li>üêõ <b>Fixes:</b> Corrections ultimes.</li>
                        </ul>
                    </div>
                    <div class="patch-note relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-cyan-500 text-[10px] text-black font-black px-2 py-0.5 rounded-bl-lg z-10 shadow-lg opacity-80">LATEST</div>
                        <h3>v1.4.2 (HOLIDAY UPDATE)</h3>
                        <ul>
                            <li>üéÖ <b>No√´l:</b> Il neige ! + Cadeaux en boutique.</li>
                            <li>üõ°Ô∏è <b>Clubs:</b> Timestamps dans le chat.</li>
                            <li>‚ú® <b>Saison:</b> Date de fin ajout√©e.</li>
                            <li>üêõ <b>Fixes:</b> Optimisation Aventures & Clubs.</li>
                        </ul>
                    </div>
                    <div class="patch-note">
                        <h3>v1.4.1 (SOUND & STORY)</h3>
                        <ul>
                            <li>üìú <b>Nouvelles Aventures:</b> D√©couvrez les histoires de Scout et Heavy (Tank) !</li>
                            <li>üîä <b>Audio HD:</b> Nouveaux effets sonores premium pour les tirs, impacts et victoires.</li>
                            <li>üêõ <b>Correctifs:</b> Optimisation globale et corrections de bugs mineurs.</li>
                        </ul>
                    </div>
                    <div class="patch-note relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-red-600 text-[10px] font-black px-2 py-0.5 rounded-bl-lg z-10 animate-pulse shadow-lg">NOUVEAU</div>
                        <h3>v1.3.5 (TROPHY UPDATE)</h3>
                        <ul>
                            <li>üèÜ <b>Trophy Road :</b> Extension massive ! 25 Paliers jusqu'√† 20 000 Troph√©es.</li>
                            <li>üéÅ <b>R√©compenses :</b> Nouveaux paliers Elite, Master, Legend et Cyber God.</li>
                            <li>‚ú® <b>Visuel :</b> Interface de progression am√©lior√©e et plus fluide.</li>
                            <li>üêõ <b>Correctifs :</b> Optimisation du code et corrections diverses.</li>
                        </ul>
                    </div>
                    <div class="patch-note">
                        <h3>v1.3.4 (SOCIAL UPDATE)</h3>
                        <ul>
                            <li>ü§ñ <b>Bot Emotes :</b> Les bots expriment leurs √©motions (Joie, Col√®re) !</li>
                            <li>üí¢ <b>R√©actions :</b> Emotes quand ils sont touch√©s ou tu√©s.</li>
                            <li>‚ú® <b>Immersion :</b> Le monde semble plus vivant.</li>
                        </ul>
                    </div>
                    <div class="patch-note"><h3>v1.3.3 (VISUAL ENHANCED)</h3><ul><li>‚ú® <b>VFX Engine :</b> Physique de particules, rotations et nouvelles formes !</li><li>üí¨ <b>Textes :</b> Animation "Pop" fluide pour les d√©g√¢ts.</li><li>üí• <b>Impact :</b> Muzzle flash et d√©bris am√©lior√©s.</li></ul></div>
                    <div class="patch-note"><h3>v1.3.2 (SMART UPDATE)</h3><ul><li>üß† <b>IA Intelligente :</b> Les bots jouent les objectifs (CTF, Wagon) !</li><li>üõí <b>Wagon :</b> Les alli√©s aident √† pousser.</li><li>üõ†Ô∏è <b>Optimisation :</b> Nettoyage du code.</li></ul></div>
                        <div class="patch-note"><h3>v1.3.1 (VISUAL UPDATE)</h3><ul><li>üî• <b>Kill Streaks :</b> Encha√Ænez les kills pour des effets sp√©ciaux !</li><li>‚ú® <b>Effets :</b> Nouveaux VFX et animations d'UI.</li><li>üêõ <b>Fixes :</b> Corrections de bugs (Bio, Score).</li></ul></div>
                        <div class="patch-note"><h3>v1.3 (CYBER FUTURE)</h3><ul><li>üöÉ <b>Nouveau Mode :</b> Payload (Convoi) ! Poussez le wagon jusqu'√† la fin.</li><li>‚òÑÔ∏è <b>Nouveaux H√©ros :</b> Cosmo (Mythique) et Brick (Commun).</li><li>‚ö° <b>Nouvelle Ar√®ne :</b> R√©acteur.</li><li>üí∞ <b>Golden Chase :</b> Plus de pi√®ces !</li></ul></div>
                        <div class="patch-note"><h3>v1.2.9 (Crash Fix)</h3><ul><li>üõ†Ô∏è <b>CRITIQUE :</b> Correction du crash "timeScale" (Slow Mo).</li><li>‚ö° <b>Optimisation :</b> Stabilit√© am√©lior√©e.</li></ul></div>
                        <div class="patch-note"><h3>v1.2.8 (Hotfix Update)</h3><ul><li>ü§ñ <b>IA Bots :</b> Les bots alli√©s n'attaquent plus le joueur.</li><li>üí∞ <b>Golden Chase :</b> Correction de la collecte des pi√®ces.</li><li>üõ†Ô∏è <b>Stabilit√© :</b> Corrections de crashs majeurs (match error).</li></ul></div>
                        <div class="patch-note"><h3>v1.2.7 (Bug Fix Update)</h3><ul><li>üõ†Ô∏è <b>Modes de Jeu :</b> Victoire/D√©faite corrig√©e pour tous les modes.</li><li>üíé <b>Defense :</b> Ajout du Cristal √† prot√©ger.</li><li>üëæ <b>Spawns :</b> Ennemis corrig√©s pour tous les modes.</li></ul></div>
                        <div class="patch-note"><h3>v1.2.6 (Feature Update)</h3><ul><li>üö© <b>Capture le Drapeau :</b> Nouveau mode strat√©gique en 4v4 ! Volez le drapeau ennemi et prot√©gez le v√¥tre.</li><li>‚ú® <b>Am√©liorations :</b> Meilleur HUD pour les modes d'√©quipe.</li><li>üêõ <b>Correctifs :</b> Stabilit√© et bugs mineurs.</li></ul></div>
                        <div class="patch-note"><h3>v1.2.5 (Polish & Fixes)</h3><ul><li>üí∞ <b>Golden Chase :</b> Mode survie haute-r√©compense (2 min). Collectez l'or !</li><li>üõ°Ô∏è <b>Team Battle :</b> Score d'√©quipe corrig√©. Premier √† 40 Kills !</li><li>‚ú® <b>Visuel :</b> Effets am√©lior√©s pour Marais, Usine et N√©ant.</li><li>üêõ <b>Correctifs :</b> Bugs de spawn et munitions r√©solus.</li></ul></div>
                        <div class="patch-note"><h3>v1.2.4 (WILD UPDATE)</h3><ul><li>üêæ <b>5 Nouveaux H√©ros "SAUVAGES" :</b> Bear, Wolf, Eagle, Rhino, Shark !</li><li>üåø <b>Th√®me Nature :</b> La nature reprend ses droits dans mBattle.</li><li>‚ö° <b>√âquilibrage :</b> Ajustements divers sur les h√©ros.</li></ul></div>
                        <div class="patch-note"><h3>v1.2.3 (Trophy Road Update)</h3><ul><li>üèÜ <b>Voie des Troph√©es :</b> Gagnez 1000 ü™ô et 25 üíé √† chaque palier de troph√©es !</li><li>üìà <b>Progression :</b> Cliquez sur votre rang dans le menu pour voir les r√©compenses.</li><li>üõ†Ô∏è <b>Correctifs :</b> Optimisation et corrections mineures.</li></ul></div><div class="patch-note"><h3>v1.2.2 (CONTENT UPDATE)</h3><ul><li>üíé <b>Skins Diamant :</b> Nouveaux skins de prestige pour Soldier, Heavy et Sniper (5000 ü™ô).</li><li>üåä <b>Nouveau Terrain :</b> Atlantis ! Combattez sous l'oc√©an.</li><li>üé≤ <b>3 Nouveaux Modificateurs :</b> Aveugle, Slow Mo et Chaos !</li><li>üêõ <b>Correctifs :</b> Am√©liorations diverses.</li></ul></div><div class="patch-note"><h3>v1.2.1 (Fixes)</h3><ul><li>üêõ <b>HUD :</b> Correction de l'affichage du niveau du h√©ros en jeu.</li><li>üõ†Ô∏è <b>Stabilit√© :</b> Corrections de bugs divers et optimisations.</li></ul></div><div class="patch-note"><h3>v1.2.0 (THE HEROIC UPDATE)</h3><ul><li>‚≠êÔ∏è <b>10 Nouveaux H√©ros :</b> Vulcan, Zephyr, Necro, Gladiator, Bouncer, Fungus, Wasp, Mirage, Juggernaut, Eclipse ! (Total 60 H√©ros)</li><li>üé≠ <b>100 Emotes :</b> Collection massive de nouvelles emotes !</li><li>üé´ <b>mPass MAX :</b> Le Pass de Combat s'√©tend maintenant jusqu'au palier 100 avec une r√©compense ultime !</li><li>üé® <b>Skins :</b> 5 Skins pour TOUS les nouveaux h√©ros.</li><li>üêõ <b>Optimisation :</b> Fluidit√© accrue.</li></ul></div><div class="patch-note"><h3>v1.1.5 (Content Explosion)</h3><ul><li>üî• <b>Missions & Terrains :</b> Total 20 Modes et 15 Ar√®nes !</li><li>üé® <b>Skins :</b> 5 Skins minimum pour CHAQUE h√©ros !</li><li>‚öôÔ∏è <b>Modificateurs :</b> Total 15 modificateurs (Nouveau: Fragile).</li><li>üòÄ <b>Emotes :</b> 25 Nouvelles Emotes (Total 75+).</li><li>üêõ <b>Correctifs :</b> Stabilit√© et bugs mineurs corrig√©s.</li></ul></div><div class="patch-note"><h3>v1.1.4 (Packs Corrections)</h3><ul><li>üõ†Ô∏è Corrections de bugs sur les qu√™tes et r√©compenses.</li><li>‚ö° Optimisation des performances.</li><li>üêõ Fix: Orthographe Modificateurs.</li></ul></div><div class="patch-note"><h3>v1.1.3 (Update Heroes)</h3><ul><li>ü¶∏ 5 Nouveaux H√©ros : Cyclops, Banshee, Druid, Spartan, Hydra !</li><li>üìù Descriptions : Am√©lioration des textes d'Infos (Missions & Terrains).</li><li>üêõ Bugs : Corrections mineures et optimisation.</li></ul></div><div class="patch-note"><h3>v1.1.2 (Big Content Update)</h3><ul><li>üî• 5 Nouveaux H√©ros : Vulcan, Zephyr, Necro, Gladiator, Bouncer !</li><li>üëï SKINS : Tous les h√©ros ont maintenant 5 skins minimum !</li><li>‚öôÔ∏è 5 Nouveaux Modificateurs : Low Gravity, Double D√©g√¢ts, Tiny, Pluie de Balles, No Regen.</li><li>üè∞ 3 Nouveaux Terrains : Marais, Usine, N√©ant.</li><li>‚ò†Ô∏è Nouvelle Mission : Chasse au Tr√©sor.</li><li>üòÄ Emotes : Collection √©tendue √† 50 emotes !</li></ul></div><div class="patch-note"><h3>v1.1.1 (Patch mPass)</h3><ul><li>üé® mPASS 2.0 : Refonte compl√®te du design du Pass de Combat !</li><li>üåã Nouveau Terrain : Solaris (Ambiance volcanique et cendres).</li><li>üõ†Ô∏è Bugs Corrig√©s : Fiabilisation de la boutique et du changement d'onglets.</li></ul></div><div class="patch-note"><h3>v1.1.0</h3><ul><li>ü¶∏ 5 Nouveaux H√©ros (FINAL) : Spike, Tesla, Siren, Paladin, Zenith !</li><li>üìú Syst√®me de Qu√™tes : Qu√™tes Quotidiennes (Reset 24h) et de Saison.</li><li>üéØ Nouvelles Missions de qu√™tes : D√©g√¢ts, Collecte, Survie...</li><li>üí∏ Drops : Les ennemis l√¢chent parfois des Pi√®ces et Gemmes !</li><li>üî• Level 45+ H√©ros total !</li></ul></div><div class="patch-note"><h3>v1.0.6</h3><ul><li>üöÄ 2 Nouvelles Missions : Carnage (Tuer 50 ennemis) & Zone (Contr√¥le de zone).</li><li>üíé Nouveau Terrain : Grotte de Cristal.</li><li>‚ú® Am√©lioration visuelle : Plus d'effets sur tous les terrains !</li><li>üõ†Ô∏è Correction de bugs : Gestion de la cam√©ra et spawns.</li></ul></div><div class="patch-note"><h3>v1.0.5</h3><ul><li>üõ†Ô∏è CRITIQUE : R√©paration de l'IA (Vision des bots).</li><li>‚ö° Optimisation du code.</li></ul></div><div class="patch-note"><h3>v1.0.4</h3><ul><li>ü¶∏ 5 Nouveaux H√©ros : Spectre, Solar, Orbit, Raptor, Grunt !</li><li>üöÄ Nouvelle Mission : Cyber Escape. Rejoins la zone d'extraction !</li><li>üõ†Ô∏è Bugs corrig√©s : Soin impossible en One Shot, IA am√©lior√©e vs Invisibilit√©.</li></ul></div><div class="patch-note"><h3>v1.0.3</h3><ul><li>ü¶∏ 5 Nouveaux H√©ros : Rock, Frost, Blaze, Storm, Glitch !</li><li>üõ†Ô∏è Corrections de bugs (R√©g√©n√©ration Bots).</li><li>‚ö° Am√©liorations diverses.</li></ul></div><div class="patch-note"><h3>v1.0.2</h3><ul><li>üõ†Ô∏è Corrections de bugs : Refresh Shop et Affichage des r√©compenses.</li><li>üíé Optimisation de l'interface.</li></ul></div><div class=\"patch-note\"><h3>v1.0.1</h3><ul><li>ü¶∏ 5 Nouveaux H√©ros : Archer, Brawler, Grenadier, Vortex, Nova !</li><li>üî´ Nouveau Mode : Jeu d'Armes (Gun Game).</li><li>üåë Nouvelle Ar√®ne : Moon Base.</li><li>üëï Nouveaux Skins : Ajout de 5 nouveaux skins pour Chrono, Viper, Bomber, Samurai et Cyber.</li><li>üéÅ Offres Gratuites : Nouvelles r√©compenses temporaires gratuites dans la boutique !</li><li>‚ö° Optimisations diverses et corrections mineures.</li></ul></div><div class="patch-note"><h3>v1.0.0 (Saison 2)</h3><ul><li>2Ô∏è‚É£ Ajout du contenu de saison 2</li><li>üö´ Correction de bugs majeurs principalement.</li><li>üëï Nouveaux Skins : Ajout de skins pour Drone, Harpy, Shaman et Reaper.</li><li> üëï Nouveaux h√©ros : ajout pour 30 au total</li><li>‚è≥ Am√©liorations divers (profil, shop...)</li><li>ü¶æ PV Bots : Augmentation des PV de base des bots (+20 PV) et am√©lioration de l'intelligence des bots.</li></ul></div></div>
                </div>
                <div id="tab-profile" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto pb-40">
                    <h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-white">///</span> COMPTE</h2>
                    <div id="profile-main-card" class="glass-panel p-6 mb-6 relative overflow-hidden bg-gradient-to-br from-blue-900/20 to-purple-900/20 border-blue-500/30">
                        <div class="absolute top-0 right-0 p-4 opacity-50 z-20"><button onclick="window.ui.openSettings()" class="text-xl hover:scale-110 transition md:text-2xl bg-black/40 p-2 rounded-xl backdrop-blur-md border border-white/10">‚öôÔ∏è</button></div>
                        <div class="flex flex-col md:flex-row items-center gap-6 relative z-10">
                            <div class="relative group cursor-pointer" onclick="window.ui.openAvatarSelector()">
                                <div class="w-24 h-24 rounded-full bg-gray-800 border-4 border-blue-500/30 flex items-center justify-center text-5xl shadow-[0_0_30px_rgba(59,130,246,0.3)] overflow-hidden hover:border-blue-400 transition" id="profile-avatar">üë§</div>
                                <div class="absolute bottom-1 right-1 bg-blue-600 border border-white text-xs p-1.5 rounded-full text-white shadow-lg">‚úèÔ∏è</div>
                            </div>
                            <div class="flex-1 text-center md:text-left w-full">
                                <div class="text-[10px] text-blue-300 font-bold uppercase tracking-widest mb-1">IDENTIT√â</div>
                                <div class="flex justify-center md:justify-start items-center gap-2 mb-2">
                                     <h3 class="text-3xl font-black text-white tracking-tight" id="profile-display-name">Player</h3>
                                     <div class="bg-blue-600/20 text-blue-300 text-[10px] font-mono px-2 py-0.5 rounded border border-blue-500/30" id="profile-tag">#TAG</div>
                                </div>
                                <div class="text-sm text-gray-300 italic mb-3 min-h-[1.25em]" id="profile-bio">"Aucune bio d√©finie..."</div>
                                
                                <div class="flex justify-center md:justify-start gap-4">
                                     <div class="px-3 py-1 rounded bg-black/40 border border-white/10 text-xs font-bold text-yellow-400 flex items-center gap-2"><span class="text-lg">‚ö°</span> <span id="profile-lvl">LVL 1</span></div>
                                     <div class="px-3 py-1 rounded bg-black/40 border border-white/10 text-xs font-bold text-purple-400 flex items-center gap-2"><span class="text-lg">üèÜ</span> <span id="profile-trophies">0</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="absolute bottom-2 right-2 text-[8px] text-gray-600 font-mono">v1.4.4</div>
                    </div>
                <div class="glass-panel p-6 mb-6 bg-blue-900/10 border-blue-500/30 hidden"> <!-- HIDDEN V1.4.6 -->
                    </div>

                    <div class="glass-panel p-6 mb-6 bg-purple-900/10 border-purple-500/30 hidden"> <!-- HIDDEN V1.4.6 -->
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="glass-panel p-6">
                            <div class="font-bold text-lg mb-2 flex items-center gap-2">üíæ Sauvegarde</div>
                            <div class="text-xs text-gray-400 mb-4">Copie ce code pour transf√©rer ton compte.</div>
                            <button onclick="window.ui.exportSave()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition text-sm">COPIER MA SAUVEGARDE üìã</button>
                        </div>
                        <div class="glass-panel p-6">
                            <div class="font-bold text-lg mb-2 flex items-center gap-2">üì• Importer</div>
                            <div class="text-xs text-gray-400 mb-4">Colle un code de sauvegarde ici.</div>
                            <button onclick="window.ui.importSave()" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-xl transition text-sm">IMPORTER SAUVEGARDE üîÑ</button>
                        </div>
                </div>
            </div>
            
            <div id="tab-quests" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto pb-40">
                <h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-yellow-400">///</span> QU√äTES & D√âFIS</h2>
                
                <!-- SEARCH BAR QUESTS -->
                <div class="w-full mb-4 relative">
                    <input type="text" placeholder="Rechercher une qu√™te..." class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 pl-10 text-white focus:outline-none focus:border-yellow-400 transition" oninput="window.ui.search('quests', this.value)">
                    <div class="absolute left-3 top-3.5 text-gray-400">üîç</div>
                </div>

                <div class="glass-panel p-6 mb-6 bg-blue-900/10 border-blue-500/30">
                    <h3 class="text-xl font-bold mb-4 flex items-center gap-2 text-yellow-400">
                        üìú QU√äTES DU JOUR 
                        <span class="text-[10px] text-gray-500 bg-black px-2 py-0.5 rounded" id="quest-timer-tab">Reset 24h</span>
                        <button onclick="window.QuestSystem.refreshDaily()" class="ml-auto bg-purple-600 hover:bg-purple-500 text-white font-bold py-1 px-3 rounded-lg text-xs shadow-lg flex items-center gap-1 active:scale-95 transition">üîÑ 10üíé</button>
                    </h3>
                    <div id="daily-quests-list-tab" class="flex flex-col gap-2"></div>
                </div>
                <div class="glass-panel p-6 mb-6 bg-purple-900/10 border-purple-500/30">
                    <h3 class="text-xl font-bold mb-4 flex items-center gap-2 text-purple-400">üåü QU√äTES DE SAISON</h3>
                    <div id="season-quests-list-tab" class="flex flex-col gap-2"></div>
                </div>
            </div>
        <div class="w-full glass-nav h-[90px] pb-safe flex justify-around items-center px-2 z-50 fixed bottom-0 left-0 right-0 overflow-x-auto hide-scrollbar bg-black/90 backdrop-blur-xl border-t border-white/10 shadow-[0_-5px_20px_rgba(0,0,0,0.5)]">
                <button onclick="window.ui.showTab('play')" id="nav-play" class="nav-item flex flex-col items-center p-2 min-w-[60px] active selected"><span class="text-2xl icon mb-1">‚öîÔ∏è</span><span class="text-[9px] font-bold">JOUER</span></button>
                <button onclick="window.ui.showTab('starters')" id="nav-starters" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">ü¶∏</span><span class="text-[9px] font-bold">H√âROS</span></button>
                <button onclick="window.ui.showTab('adventures')" id="nav-adventures" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">üìú</span><span class="text-[9px] font-bold">AVENTURE</span></button>
                <button onclick="window.ui.showTab('pass')" id="nav-pass" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">üé´</span><span class="text-[9px] font-bold">PASS</span></button>
                <button onclick="window.ui.showTab('clubs')" id="nav-clubs" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">üõ°Ô∏è</span><span class="text-[9px] font-bold">CLUBS</span></button>
                <button onclick="window.ui.showTab('shop')" id="nav-shop" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">üõí</span><span class="text-[9px] font-bold">SHOP</span></button>
                <button onclick="window.ui.showTab('friends')" id="nav-friends" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">üë•</span><span class="text-[9px] font-bold">AMIS</span></button>
                <button onclick="window.ui.showTab('emotes')" id="nav-emotes" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">üòÄ</span><span class="text-[9px] font-bold">EMOTES</span></button>
                <button onclick="window.ui.showTab('quests')" id="nav-quests" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">üéØ</span><span class="text-[9px] font-bold">QU√äTES</span></button>
                <button onclick="window.ui.showTab('profile')" id="nav-profile" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">üë§</span><span class="text-[9px] font-bold">PROFIL</span></button>
            </div>
        </div>

        <!-- TROPHY ROAD MODAL -->
        <div id="trophy-road-modal" class="hidden absolute inset-0 bg-black/95 backdrop-blur-xl flex items-center justify-center z-[60] pointer-events-auto animate-fadeIn" onclick="this.classList.add('hidden')">
             <div class="glass-panel p-6 max-w-lg w-full mx-4 flex flex-col gap-4 max-h-[80vh] overflow-y-auto hide-scrollbar" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center border-b border-white/10 pb-4"><h3 class="text-xl font-black text-yellow-400">VOIE DES TROPH√âES üèÜ</h3><button onclick="document.getElementById('trophy-road-modal').classList.add('hidden')" class="text-2xl text-gray-400 hover:text-white">√ó</button></div>
                <div id="trophy-list" class="flex flex-col gap-3"></div>
             </div>
        </div>

        <!-- SETTINGS MODAL -->
        <div id="settings-modal" class="hidden absolute inset-0 bg-black/95 backdrop-blur-xl flex items-center justify-center z-[60] pointer-events-auto animate-fadeIn" onclick="window.ui.closeSettings()">
             <div class="glass-panel p-6 max-w-sm w-full mx-4 flex flex-col gap-4 max-h-[80vh] overflow-y-auto hide-scrollbar" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center border-b border-white/10 pb-4"><h3 class="text-xl font-black">PARAM√àTRES ‚öôÔ∏è</h3><button onclick="window.ui.closeSettings()" class="text-2xl text-gray-400 hover:text-white">√ó</button></div>
                <div class="settings-grp"><label class="settings-label">Pseudonyme</label><input type="text" id="setting-name" class="profile-input" placeholder="Ton pseudo..."></div>
                <div class="settings-grp"><label class="settings-label">Avatar</label><button onclick="window.ui.openAvatarSelector()" class="w-full bg-white/10 hover:bg-white/20 border border-white/20 py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2">CHANGER D'AVATAR üë§</button></div>
                <div class="settings-grp"><label class="settings-label">Email</label><input type="email" id="setting-email" placeholder="email@exemple.com" class="profile-input"></div>
                <div class="settings-grp"><label class="settings-label">T√©l√©phone</label><input type="tel" id="setting-phone" placeholder="+33 6..." class="profile-input"></div>
                <div class="settings-grp"><label class="settings-label">Date de Naissance</label><input type="date" id="setting-dob" class="profile-input"></div>
                <div class="settings-grp"><label class="settings-label">Bio</label><textarea id="setting-bio" placeholder="Ta description..." class="profile-input resize-none h-20"></textarea></div>
                <div class="settings-grp pt-2 border-t border-white/10 mt-2"><div class="flex justify-between items-center mb-2"><label class="settings-label text-yellow-400">Th√®me du Profil <span class="bg-yellow-500 text-black px-1 rounded text-[8px]">PRO</span></label><div id="theme-lock-icon" class="text-[10px] text-gray-500"></div></div><div class="flex gap-2 overflow-x-auto hide-scrollbar p-1" id="profile-theme-selector"></div></div>
                <button onclick="window.ui.saveSettings()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl mt-2">ENREGISTRER</button>
                <div class="mt-4 pt-4 border-t border-white/10 text-center"><p class="text-[10px] text-gray-500 leading-relaxed">mBattle est un jeu vid√©o gratuit con√ßu par Mathias Tusseau. Les bots sont pilot√©s par mAI.<br>Si vous rencontrez un probl√®me, rendez vous sur : <a href="https://forms.gle/1PVVdcSi3mYyq3XeA" target="_blank" class="text-blue-400 hover:underline">Support</a></p><div class="text-[8px] text-gray-600 mt-1">v1.4.6</div></div>
             </div>
        </div>

        <!-- HERO DETAILS MODAL -->
        <div id="hero-details-modal" class="hidden absolute inset-0 bg-black/95 backdrop-blur-xl flex items-center justify-center z-[60] pointer-events-auto animate-fadeIn" onclick="this.classList.add('hidden')">
            <div class="glass-panel p-6 max-w-md w-full mx-4 relative border-2 border-blue-500/30" onclick="event.stopPropagation()" id="hero-card-inner">
                <button onclick="document.getElementById('hero-details-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl z-10">√ó</button>
                <div class="flex flex-col items-center mb-6"><div class="w-24 h-24 rounded-2xl bg-black/50 border-2 border-white/20 flex items-center justify-center text-6xl shadow-[0_0_30px_rgba(59,130,246,0.3)] mb-3" id="hd-icon"></div><h2 class="text-3xl font-black uppercase font-tech tracking-wider" id="hd-name"></h2><div id="hd-rarity" class="mb-1 text-xs font-bold uppercase tracking-widest px-3 py-1 rounded bg-gray-800">COMMUN</div><div class="text-blue-400 font-bold text-sm" id="hd-lvl"></div></div>
                <!-- REMPLAC√â PAR hero-stats-container pour les d√©tails par niveau -->
                <div id="hero-stats-container" class="space-y-4 mb-6"></div>
                <!-- FIN REMPLAC√â -->
                <div class="mb-4" id="hd-skins-container"><div class="text-[10px] text-gray-400 uppercase font-bold mb-2">SKINS</div><div class="flex gap-2 overflow-x-auto hide-scrollbar" id="hd-skins-list"></div></div>
                <div class="bg-white/5 p-4 rounded-xl border border-white/10 mb-4"><div class="flex justify-between"><div><div class="text-[10px] text-gray-400 uppercase font-bold mb-1">GADGET</div><div class="text-sm font-bold text-white flex items-center gap-2"><span id="hd-gadget-icon">‚ö°</span> <span id="hd-gadget-name"></span></div></div><div><div class="text-[10px] text-gray-400 uppercase font-bold mb-1 text-right">PASSIF</div><div class="text-sm font-bold text-yellow-400 text-right" id="hd-passive"></div></div></div></div>
                <p class="text-xs text-gray-400 italic text-center mb-6 leading-relaxed whitespace-pre-line" id="hd-desc"></p>
                <div id="hd-actions" class="grid gap-2"></div>
            </div>
        </div>
        <!-- AVATAR SELECTOR WITH UPLOAD -->
        <div id="avatar-selector" class="hidden absolute inset-0 bg-black/90 backdrop-blur-xl flex items-center justify-center z-[60] pointer-events-auto animate-fadeIn" onclick="this.classList.add('hidden')">
            <div class="glass-panel p-6 max-w-sm w-full mx-4 flex flex-col gap-4" onclick="event.stopPropagation()">
                <h3 class="text-xl font-black text-center">CHOISIS TON AVATAR</h3>
                <div class="grid grid-cols-5 gap-2 mb-2 overflow-y-auto max-h-64 hide-scrollbar" id="avatar-grid"></div>
                <div class="border-t border-white/10 pt-4">
                    <input type="file" id="upload-avatar" hidden accept="image/*" onchange="window.ui.uploadAvatar(this)">
                    <button onclick="document.getElementById('upload-avatar').click()" class="w-full bg-blue-600/50 hover:bg-blue-500 border border-blue-500/50 py-3 rounded-xl font-bold text-sm mb-2">IMPORTER IMAGE üì∏</button>
                    <button onclick="document.getElementById('avatar-selector').classList.add('hidden')" class="w-full bg-gray-700 py-3 rounded-xl font-bold text-sm">ANNULER</button>
                </div>
            </div>
        </div>
        <div id="friend-profile-modal" class="hidden absolute inset-0 bg-black/95 backdrop-blur-xl flex items-center justify-center z-[60] pointer-events-auto animate-fadeIn" onclick="this.classList.add('hidden')">
            <div class="glass-panel p-6 max-w-sm w-full mx-4 flex flex-col items-center relative border-2 border-blue-500/30" onclick="event.stopPropagation()">
                <button onclick="document.getElementById('friend-profile-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">√ó</button>
                <div class="w-24 h-24 rounded-full bg-black/50 border-2 border-white/20 flex items-center justify-center text-6xl shadow-[0_0_30px_rgba(59,130,246,0.3)] mb-4" id="fp-avatar">üë§</div>
                <h2 class="text-3xl font-black text-white mb-1" id="fp-name">Player</h2>
                <div class="text-xs font-bold uppercase tracking-widest px-3 py-1 rounded bg-green-900/50 text-green-400 border border-green-500/30 mb-4" id="fp-status">En Ligne</div>
                
                <div class="grid grid-cols-2 gap-3 w-full mb-6">
                    <div class="bg-white/5 p-3 rounded-lg text-center border border-white/10">
                        <div class="text-xs text-gray-400 uppercase font-bold">Troph√©es</div>
                        <div class="text-xl font-black text-yellow-400" id="fp-trophies">0 üèÜ</div>
                    </div>
                    <div class="bg-white/5 p-3 rounded-lg text-center border border-white/10">
                        <div class="text-xs text-gray-400 uppercase font-bold">Club</div>
                        <div class="text-xl font-bold text-blue-400" id="fp-club">-</div>
                    </div>
                </div>
                
                <div class="flex gap-2 w-full">
                    <button class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg">INVITER ‚úâÔ∏è</button>
                    <button onclick="document.getElementById('friend-profile-modal').classList.add('hidden')" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-xl">FERMER</button>
                </div>
            </div>
        </div>
        <div id="levelup-screen" class="hidden absolute inset-0 bg-black/90 backdrop-blur-xl flex items-center justify-center z-[60] pointer-events-auto animate-fadeIn">
            <div class="w-full max-w-sm p-6 text-center"><h2 class="text-5xl font-tech text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 font-black mb-4 animate-bounce">LEVEL UP!</h2><div id="perk-container" class="grid gap-3"></div></div>
        </div>
        <div id="gameover-screen" class="hidden absolute inset-0 bg-red-950/95 backdrop-blur-2xl flex items-center justify-center z-[70] pointer-events-auto animate-fadeIn">
            <div class="text-center max-w-sm w-full p-6">
                <h1 id="go-title" class="text-8xl font-black text-white mb-2 drop-shadow-2xl tracking-tighter">KO</h1>
                <p class="text-red-400 font-bold text-xl mb-8 uppercase tracking-widest" id="go-reason">√âlimin√©</p>
                <div class="glass-panel p-6 mb-6 grid grid-cols-2 gap-4 text-left bg-black/40">
                    <div><div class="text-[10px] text-gray-500 uppercase font-bold mb-1">Score</div><div id="go-score" class="text-2xl font-black text-white font-tech">0</div></div>
                    <div><div class="text-[10px] text-gray-500 uppercase font-bold mb-1">Gains</div><div class="text-xl font-bold text-yellow-400" id="go-rewards"></div></div>
                </div>
                <button onclick="game.toMenu()" class="w-full bg-gradient-to-r from-gray-100 to-gray-300 hover:from-white hover:to-gray-100 text-black font-black py-4 rounded-xl active:scale-95 transition shadow-[0_0_20px_rgba(255,255,255,0.3)] text-lg uppercase tracking-widest border border-white/50">RETOUR MENU üè†</button>
            </div>
        </div>
    </div>
    <script>
        /* mBATTLE v1.4.4 - FINAL POLISH */
        
        // --- SOUND MANAGER (v1.4.1) ---
        // --- SOUND MANAGER (v1.4.1) ---
        const SoundManager = {
            ctx: null,
            init() { 
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if(AudioContext) this.ctx = new AudioContext(); 
                } catch(e) { console.error("Audio init failed", e); }
            },
            play(id) {
                if(typeof USER !== 'undefined' && USER.settings && !USER.settings.sound) return;
                if(!this.ctx) this.init();
                if(!this.ctx) return;

                const t = this.ctx.currentTime;
                
                // Helper for noise
                const playNoise = (duration, filterFreq) => {
                    const bufferSize = this.ctx.sampleRate * duration;
                    const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                    const data = buffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;

                    const noise = this.ctx.createBufferSource();
                    noise.buffer = buffer;
                    const filter = this.ctx.createBiquadFilter();
                    filter.type = 'lowpass';
                    filter.frequency.setValueAtTime(filterFreq || 1000, t);
                    filter.frequency.exponentialRampToValueAtTime(100, t + duration); // Filter sweep
                    
                    const gain = this.ctx.createGain();
                    gain.gain.setValueAtTime(0.1, t);
                    gain.gain.exponentialRampToValueAtTime(0.01, t + duration);
                    
                    noise.connect(filter);
                    filter.connect(gain);
                    gain.connect(this.ctx.destination);
                    noise.start(t);
                    noise.stop(t + duration);
                };

                const osc = (type, freq, dur, vol=0.1, sweep=0) => {
                    const o = this.ctx.createOscillator();
                    const g = this.ctx.createGain();
                    o.type = type;
                    o.frequency.setValueAtTime(freq, t);
                    if(sweep) o.frequency.exponentialRampToValueAtTime(sweep, t + dur);
                    
                    g.gain.setValueAtTime(vol, t);
                    g.gain.exponentialRampToValueAtTime(0.01, t + dur);
                    
                    o.connect(g);
                    g.connect(this.ctx.destination);
                    o.start(t);
                    o.stop(t + dur);
                };

                if(id === 'click' || id === 'ui') {
                    osc('sine', 800, 0.05, 0.05, 1200);
                } else if(id === 'shoot') {
                    // Layered shoot sound
                    playNoise(0.1, 800);
                    osc('square', 150, 0.1, 0.05, 40);
                } else if(id === 'hit') {
                    osc('sawtooth', 200, 0.1, 0.05, 50);
                } else if(id === 'start') {
                    osc('triangle', 300, 0.5, 0.1, 600);
                    setTimeout(() => osc('triangle', 600, 0.5, 0.1, 1200), 100);
                } else if(id === 'win') {
                    osc('triangle', 440, 0.2, 0.1);
                    setTimeout(() => osc('triangle', 554, 0.2, 0.1), 100); // C#
                    setTimeout(() => osc('triangle', 659, 0.4, 0.1), 200); // E
                } else if(id === 'lose') {
                    osc('sawtooth', 300, 0.4, 0.1, 100);
                    setTimeout(() => osc('sawtooth', 200, 0.4, 0.1, 50), 300);
                } else if(id === 'collect') {
                    osc('sine', 1200, 0.1, 0.05); // High ping
                } else if(id === 'purchase') {
                    osc('sine', 1500, 0.1, 0.05); 
                    setTimeout(()=>osc('sine', 2000, 0.1, 0.05), 50);
                } else if(id === 'error') {
                    osc('sawtooth', 150, 0.2, 0.1, 100);
                } else if(id === 'levelup') {
                    osc('triangle', 400, 0.2, 0.1);
                    setTimeout(()=>osc('triangle', 500, 0.2, 0.1), 100);
                    setTimeout(()=>osc('triangle', 600, 0.2, 0.1), 200);
                    setTimeout(()=>osc('triangle', 800, 0.4, 0.2), 300);
                } else if(id === 'open_chest') {
                    playNoise(0.5, 300);
                    osc('sine', 800, 0.3, 0.1, 100);
                    setTimeout(()=>osc('triangle', 1200, 0.4, 0.1), 200);
                } else if(id === 'equip') {
                     osc('square', 300, 0.05, 0.05, 400);
                } else if(id === 'ui_hover') {
                     osc('sine', 440, 0.02, 0.01);
                } else if(id === 'start_game') {
                     osc('sawtooth', 200, 0.5, 0.1, 50);
                     setTimeout(()=>osc('sawtooth', 100, 0.5, 0.1), 200);
                }
            }
        };

        // --- MAP MAKER (v1.4.0) ---
        const MapMaker = {
            active: false,
            grid: [],
            size: 20,
            init() {
                this.grid = [];
                for(let i=0; i<this.size*this.size; i++) this.grid.push(0);
                this.renderEditor();
            },
            renderEditor() {
                const el = document.getElementById('map-maker-ui');
                if(!el) {
                    const d = document.createElement('div');
                    d.id = 'map-maker-ui';
                    d.className = 'absolute inset-0 z-[60] bg-black flex flex-col items-center justify-center';
                    d.innerHTML = `
                        <div class="absolute top-4 left-4 text-white font-tech text-xl">MAP MAKER <span class="text-green-400">BETA</span></div>
                        <button onclick="document.getElementById('map-maker-ui').remove()" class="absolute top-4 right-4 text-red-500 text-2xl font-bold">√ó</button>
                        <div class="grid grid-cols-20 gap-0.5 bg-gray-900 border border-white/20 p-2" id="mm-grid" style="grid-template-columns: repeat(20, 1fr);">
                            ${this.grid.map((c,i) => `<div onclick="MapMaker.toggle(${i})" id="cell-${i}" class="w-4 h-4 ${c===1?'bg-white':'bg-gray-800 hover:bg-gray-700'} cursor-pointer"></div>`).join('')}
                        </div>
                        <div class="flex gap-4 mt-6">
                            <button onclick="MapMaker.play()" class="glass-btn px-6 py-2 bg-green-600 hover:bg-green-500">JOUER</button>
                            <button onclick="MapMaker.save()" class="glass-btn px-6 py-2">SAUVEGARDER</button>
                            <button onclick="MapMaker.clear()" class="glass-btn px-6 py-2 text-red-400">EFFACER</button>
                        </div>
                    `;
                    document.body.appendChild(d);
                } else {
                    document.getElementById('mm-grid').innerHTML = this.grid.map((c,i) => `<div onclick="MapMaker.toggle(${i})" id="cell-${i}" class="w-4 h-4 ${c===1?'bg-white':'bg-gray-800 hover:bg-gray-700'} cursor-pointer"></div>`).join('');
                }
            },
            toggle(i) {
                this.grid[i] = this.grid[i] === 0 ? 1 : 0;
                document.getElementById(`cell-${i}`).className = `w-4 h-4 ${this.grid[i]===1?'bg-white':'bg-gray-800 hover:bg-gray-700'} cursor-pointer`;
            },
            save() {
                const name = prompt("Nom de la carte ?");
                if(name) {
                    if(!USER.maps) USER.maps = [];
                    USER.maps.push({ name, grid: [...this.grid], date: Date.now() });
                    Storage.save();
                    alert("Carte sauvegard√©e !");
                    document.getElementById('map-maker-ui').remove();
                }
            },
            play() {
                 if(!confirm("Jouer sur cette carte ?")) return;
                 // Set custom game mode
                 window.game.customGrid = [...this.grid];
                 window.game.conf.mode = 'custom';
                 document.getElementById('map-maker-ui').remove();
                 window.ui.showTab('play');
                 window.game.start();
            },
            clear() { this.grid = this.grid.map(()=>0); this.renderEditor(); }
        };

        window.game = {}; 

        const CFG = { w: 0, h: 0, world: 2500 };
        
        // --- FACTEURS DE TUNING V1.0.0 ---
        const SPEED_FACTOR = 0.64; 
        const RATE_FACTOR = 1.38; 
        const RELOAD_FACTOR = 1.02;
        const PROJ_SPEED_FACTOR = 0.93;
        const ENEMY_HP_BUFF = 20; // +20 PV pour les bots/ennemis

        const RARITY = { common: { name: 'Commun', color: '#94a3b8', bg: 'bg-gray-500' }, rare: { name: 'Rare', color: '#3b82f6', bg: 'bg-blue-500' }, epic: { name: '√âpique', color: '#a855f7', bg: 'bg-purple-500' }, legendary: { name: 'L√©gendaire', color: '#eab308', bg: 'bg-yellow-500' }, mythic: { name: 'Mythique', color: '#ef4444', bg: 'bg-red-600' } };
        
        // PRIX STANDARDIS√âS
        // PRIX STANDARDIS√âS (Mise √† jour v1.4.0)
        const PRICE_COMMON = 500;
        const PRICE_RARE = 1500;
        const PRICE_EPIC = 2500;
        const PRICE_LEGENDARY = 4000;
        const PRICE_MYTHIC = 6000;

        // --- NOUVEAUT√â v1.4.0 : CLUBS & MAITRISES ---
        const CLUB_ICONS = ["üõ°Ô∏è","‚öîÔ∏è","üëë","üíÄ","üî•","‚ùÑÔ∏è","‚ö°","üåü","üêâ","ü¶Å"];
        const MASTERY_MAX = 10;
        const MASTERY_XP = [0, 50, 150, 300, 500, 800, 1200, 1700, 2300, 3000]; // XP requis pour chaque niveau
        
        // --- NOUVEAUT√â v1.4.0 : AVENTURES ---
        // Histoires h√©ro√Øques
        const ADVENTURES = {
            soldier: { title: "Le D√©serteur", desc: "La fuite de Soldier vers la libert√©.", color: "#3b82f6", bg: "linear-gradient(135deg, #1e3a8a, #3b82f6)", parts: [
                { type: 'story', text: "2077. Base Lunaire Alpha. L'ordre 66 est donn√©. Je refuse d'ob√©ir." },
                { type: 'battle', mode: 'survival', target: 3, desc: "√âchappe aux gardes de la base (3 vagues) !" },
                { type: 'reward', coin: 300, xp: 50 },
                { type: 'story', text: "L'alarme r√©sonne. Les portes du hangar sont bloqu√©es." },
                { type: 'battle', mode: 'cyber_hack', target: 50, desc: "Pirate le terminal de s√©curit√© (50%)." },
                { type: 'reward', coin: 400, gems: 5 },
                { type: 'battle', mode: 'escape', target: 1, desc: "Rejoins le vaisseau d'extraction !" },
                { type: 'story', text: "Ils ont envoy√© le Capitaine pour m'arr√™ter..." },
                { type: 'battle', mode: 'duel', target: 1, desc: "Duel contre le Capitaine !" },
                { type: 'reward', skin: 'soldier_veteran_free', xp: 200 },
                { type: 'story', text: "Je suis libre... mais pour combien de temps ?" },
                { type: 'battle', mode: 'survival', target: 8, desc: "Survivre aux chasseurs de primes (Vague 8)." },
                { type: 'reward', box: 2, xp: 300 }
            ]},
            drone: { title: "Protocole Vengeance", desc: "Un drone solitaire.", color: "#94a3b8", bg: "linear-gradient(135deg, #475569, #94a3b8)", parts: [
                { type: 'story', text: "Syst√®me red√©marr√©. M√©moire corrompue. Seule la vengeance reste." },
                { type: 'collect', item: 'coins', target: 50, desc: "R√©cup√®re des composants (50 pi√®ces)." },
                { type: 'reward', coin: 100, xp: 50 },
                { type: 'battle', mode: 'rampage', target: 15, desc: "√âlimine 15 ennemis." },
                { type: 'reward', gems: 10, xp: 100 },
                { type: 'battle', mode: 'boss_rush', target: 1, desc: "D√©truis le boss Pilleur." },
                { type: 'reward', skin: 'drone_stealth_free' }
            ]},
            scout: { title: "Op√©ration Fant√¥me", desc: "Infiltration et sabotage.", color: "#f59e0b", bg: "linear-gradient(135deg, #b45309, #f59e0b)", parts: [
                { type: 'story', text: "La mission est simple : entrer, voler les donn√©es, sortir." },
                { type: 'battle', mode: 'escape', target: 1, desc: "Traverse les lignes ennemies sans mourir." },
                { type: 'reward', coin: 300, xp: 75 },
                { type: 'story', text: "Le coffre est gard√© par un Titan." },
                { type: 'battle', mode: 'boss_rush', target: 1, desc: "Neutralise le Titan Gardien." },
                { type: 'reward', coin: 500, gems: 10 },
                { type: 'battle', mode: 'cyber_hack', target: 100, desc: "Upload les donn√©es (100%)." },
                 { type: 'reward', skin: 'scout_forest_free' }
            ]},
            tank: { title: "La Forteresse Mobile", desc: "Un mur infranchissable.", color: "#22c55e", bg: "linear-gradient(135deg, #15803d, #22c55e)", parts: [
                { type: 'story', text: "Ils arrivent par milliers. Je suis le dernier rempart." },
                { type: 'battle', mode: 'defense', target: 5, desc: "D√©fends le noyau (5 mins / vagues)." },
                { type: 'reward', coin: 400, xp: 100 },
                { type: 'story', text: "Le noyau surchauffe. Il faut gagner du temps." },
                { type: 'battle', mode: 'rampage', target: 30, desc: "Fais le m√©nage (30 ennemis)." },
                { type: 'reward', coin: 800, skin: 'tank_rusty_free' },
                 { type: 'battle', mode: 'boss_rush', target: 3, desc: "Survis √† l'assaut des Boss (3)." },
                 { type: 'reward', box: 5 }
            ]},
            assassin: { title: "L'Ombre Silencieuse", desc: "La voie du sabre.", color: "#ef4444", bg: "linear-gradient(135deg, #991b1b, #ef4444)", parts: [
                 { type: 'story', text: "Mon clan a √©t√© trahi. L'honneur exige r√©paration." },
                 { type: 'battle', mode: 'survival', target: 5, desc: "Survis √† l'embuscade (5 vagues)." },
                 { type: 'reward', coin: 300, xp: 100 },
                 { type: 'battle', mode: 'duel', target: 1, desc: "Duel contre le Ma√Ætre Tra√Ætre." },
                 { type: 'reward', skin: 'ninja', gems: 20 }
            ]},
            reaper: { title: "Le Moissonneur", desc: "La mort vient d'en haut.", color: "#8b5cf6", bg: "linear-gradient(135deg, #5b21b6, #8b5cf6)", parts: [
                 { type: 'story', text: "Je suis le cauchemar qu'ils ont cr√©√©." },
                 { type: 'battle', mode: 'rampage', target: 50, desc: "Moissonne 50 √¢mes." },
                 { type: 'reward', xp: 500, gems: 50 },
                 { type: 'battle', mode: 'structure_war', target: 1, desc: "D√©truis le g√©n√©rateur central." },
                 { type: 'reward', skin: 'toxic' }
            ]}
        };


        // D√âFINITION DES PROPRI√âT√âS DES PROJECTILES UNIQUES PAR H√âROS
        const STARTERS = { 
            soldier: { name: "Soldier", rarity: 'common', icon: "üî´", hp: 130, dmg: 22, spd: 5.5 * SPEED_FACTOR, rate: Math.ceil(14 * RATE_FACTOR), ammo:3, reload:Math.ceil(40 * RELOAD_FACTOR), price: PRICE_COMMON, scale:{hp:10, dmg:2}, color: '#3b82f6', desc: "Polyvalent.", gadget: "heal", lore: "V√©t√©ran des guerres galactiques.", passive: "Regen Rapide", 
                       proj: { r: 5, speed: Math.ceil(20 * PROJ_SPEED_FACTOR), life: 60, shape: 'circle', color: '#3b82f6', trailColor: '#1e3a8a' },
                       skins: [ {id:'default', name:'Soldat', c:'#3b82f6'}, {id:'gold', name:'Soldat Or', c:'#fbbf24', price: 2000}, {id:'commando', name:'Commando', c:'#166534', price: 1500}, {id:'pixel', name:'Pixel', c:'#60a5fa', price: 1000}, {id:'veteran', name:'V√©t√©ran', c:'#4b5563', price: 2500}, {id:'diamond', name:'Diamant', c:'#b9f2ff', price: 5000} ] }, 
            drone: { name: "Drone", rarity: 'common', icon: "üõ∏", hp: 80, dmg: 15, spd: 7.0 * SPEED_FACTOR, rate: Math.ceil(8 * RATE_FACTOR), ammo:10, reload:Math.ceil(30 * RELOAD_FACTOR), price: PRICE_COMMON, scale:{hp:5, dmg:2}, color: '#94a3b8', type: 'laser', desc: "Rapide et fragile.", gadget: "speed", lore: "Un drone de surveillance devenu fou.", passive: "Esquive", 
                     proj: { r: 4, speed: Math.ceil(30 * PROJ_SPEED_FACTOR), life: 70, shape: 'laser', color: '#94a3b8', trailColor: '#cbd5e1' },
                     skins: [{id:'default', name:'Drone', c:'#94a3b8'}, {id:'stealth', name:'Furtif', c:'#0f172a', price: 1000}, {id:'glow', name:'N√©on Bleu', c:'#0ea5e9', price: 1500}, {id:'gold', name:'Or', c:'#fbbf24', price: 2000}, {id:'red', name:'Alerte', c:'#ef4444', price: 1000}] },
            // NOUVEAU H√âROS : COMMUN (Scout)
            scout: { name: "Scout", rarity: 'common', icon: "üèÉ", hp: 110, dmg: 18, spd: 7.5 * SPEED_FACTOR, rate: Math.ceil(12 * RATE_FACTOR), ammo:5, reload:Math.ceil(30 * RELOAD_FACTOR), price: PRICE_COMMON, scale:{hp:8, dmg:2}, color: '#94a3b8', type: 'normal', desc: "√âclaireur ultra-rapide.", gadget: "speed", lore: "Sp√©cialiste de la reconnaissance.", passive: "Course",
                     proj: { r: 4, speed: Math.ceil(28 * PROJ_SPEED_FACTOR), life: 60, shape: 'circle', color: '#f59e0b', trailColor: '#fbbf24' },
                     skins: [{id:'default', name:'Scout', c:'#94a3b8'}, {id:'desert', name:'D√©sert', c:'#d97706', price: 1500}, {id:'solaire', name:'Solaire', c:'#fef08a', price: 2000}, {id:'forest', name:'For√™t', c:'#166534', price: 1500}, {id:'night', name:'Nuit', c:'#1e1b4b', price: 2500}] },

            tank: { name: "Heavy", rarity: 'rare', icon: "üõ°Ô∏è", hp: 320, dmg: 14, spd: 3.5 * SPEED_FACTOR, rate: Math.ceil(35 * RATE_FACTOR), ammo:3, reload:Math.ceil(55 * RELOAD_FACTOR), price: PRICE_RARE, scale:{hp:30, dmg:1}, color: '#22c55e', type: 'shotgun', desc: "Sac √† PV.", gadget: "shield", lore: "Une forteresse mobile.", passive: "Armure +20%", 
                    proj: { r: 8, speed: Math.ceil(15 * PROJ_SPEED_FACTOR), life: 50, shape: 'circle', color: '#22c55e', trailColor: '#166534' },
                    skins: [ {id:'default', name:'Heavy', c:'#22c55e'}, {id:'toxic', name:'Toxic', c:'#a3e635', price: 1500}, {id:'mecha', name:'Mecha', c:'#f3f4f6', price: 2500}, {id:'rusty', name:'Rouill√©', c:'#78350f', price: 1000}, {id:'titan', name:'Titan', c:'#eab308', price: 3000}, {id:'diamond', name:'Diamant', c:'#b9f2ff', price: 5000} ] }, 
            bomber: { name: "Bomber", rarity: 'rare', icon: "üí£", hp: 150, dmg: 45, spd: 4.5 * SPEED_FACTOR, rate: Math.ceil(40 * RATE_FACTOR), ammo:2, reload:Math.ceil(60 * RELOAD_FACTOR), price: PRICE_RARE, scale:{hp:15, dmg:5}, color: '#f59e0b', type: 'shotgun', desc: "Explosifs.", gadget: "knockback", lore: "Adore les feux d'artifice.", passive: "D√©g√¢ts Zone", 
                      proj: { r: 10, speed: Math.ceil(12 * PROJ_SPEED_FACTOR), life: 40, shape: 'circle', color: '#f59e0b', trailColor: '#fed7aa' },
                      skins: [{id:'default', name:'Bomber', c:'#f59e0b'}, {id:'nuke', name:'Nucl√©aire', c:'#84cc16', price: 1800}, {id:'frost', name:'Givre', c:'#0ea5e9', price: 1500}, {id:'shadow', name:'Ombre', c:'#171717', price: 2200}, {id:'fire', name:'Feu', c:'#b91c1c', price: 2500}] },
            sniper: { name: "Sniper", rarity: 'rare', icon: "ü¶Ö", hp: 80, dmg: 120, spd: 5 * SPEED_FACTOR, rate: Math.ceil(65 * RATE_FACTOR), ammo:3, reload:Math.ceil(80 * RELOAD_FACTOR), price: PRICE_RARE, scale:{hp:5, dmg:15}, color: '#a855f7', type: 'sniper', desc: "Tireur d'√©lite.", gadget: "knockback", lore: "Ne rate jamais sa cible.", passive: "Critique +10%", 
                      proj: { r: 6, speed: Math.ceil(25 * PROJ_SPEED_FACTOR), life: 100, shape: 'sniper', color: '#a855f7', trailColor: '#7c3aed' },
                      skins: [ {id:'default', name:'Sniper', c:'#a855f7'}, {id:'elite', name:'Elite', c:'#1e1b4b', price: 3000}, {id:'camo', name:'Camo', c:'#3f6212', price: 1500}, {id:'ghillie', name:'Ghillie', c:'#14532d', price: 2000}, {id:'desert', name:'D√©sert', c:'#d97706', price: 2500}, {id:'diamond', name:'Diamant', c:'#b9f2ff', price: 5000} ] }, 
            harpy: { name: "Harpy", rarity: 'rare', icon: "üïäÔ∏è", hp: 100, dmg: 18, spd: 6.8 * SPEED_FACTOR, rate: Math.ceil(7 * RATE_FACTOR), ammo:8, reload:Math.ceil(35 * RELOAD_FACTOR), price: PRICE_RARE, scale:{hp:7, dmg:3}, color: '#84cc16', type: 'normal', desc: "Rapide et agile.", gadget: "speed", lore: "Chasseur a√©rien.", passive: "Tir Rapide",
                     proj: { r: 4, speed: Math.ceil(25 * PROJ_SPEED_FACTOR), life: 50, shape: 'circle', color: '#84cc16', trailColor: '#a7f3d0' },
                     skins: [{id:'default', name:'Harpy', c:'#84cc16'}, {id:'frost', name:'Givre', c:'#bae6fd', price: 1000}, {id:'fire', name:'Ardente', c:'#dc2626', price: 1500}, {id:'storm', name:'Temp√™te', c:'#6366f1', price: 2000}, {id:'dark', name:'Sombre', c:'#1f2937', price: 2500}] }, 
            // NOUVEAU H√âROS : RARE
            engineer: { name: "Engineer", rarity: 'rare', icon: "‚öôÔ∏è", hp: 180, dmg: 15, spd: 4.8 * SPEED_FACTOR, rate: Math.ceil(18 * RATE_FACTOR), ammo:8, reload:Math.ceil(40 * RELOAD_FACTOR), price: PRICE_RARE, scale:{hp:15, dmg:2}, color: '#fbbf24', type: 'normal', desc: "Construit des tourelles de d√©fense.", gadget: "turret", lore: "Le g√©nie du champ de bataille.", passive: "Tourelle",
                     proj: { r: 6, speed: Math.ceil(20 * PROJ_SPEED_FACTOR), life: 60, shape: 'circle', color: '#fbbf24', trailColor: '#eab308' },
                     skins: [{id:'default', name:'Engineer', c:'#fbbf24'}, {id:'robot', name:'Robotique', c:'#94a3b8', price: 1000}, {id:'stealth', name:'Furtif', c:'#1e293b', price: 1500}, {id:'cyber', name:'Cyber', c:'#06b6d4', price: 2000}, {id:'builder', name:'Constructeur', c:'#ea580c', price: 2500}] },

            assassin:{ name: "Assassin", rarity: 'epic', icon: "üó°Ô∏è", hp: 90, dmg: 18, spd: 7.5 * SPEED_FACTOR, rate: Math.ceil(8 * RATE_FACTOR), ammo:4, reload:Math.ceil(30 * RELOAD_FACTOR), price: PRICE_EPIC, scale:{hp:8, dmg:4}, color: '#ef4444', desc: "Ultra rapide.", gadget: "speed", lore: "Une ombre dans la nuit.", passive: "Vitesse Kill", 
                       proj: { r: 5, speed: Math.ceil(22 * PROJ_SPEED_FACTOR), life: 55, shape: 'circle', color: '#ef4444', trailColor: '#991b1b' },
                       skins: [{id:'default', name:'Assassin', c:'#ef4444'}, {id:'ninja', name:'Ninja', c:'#171717', price: 2500}, {id:'void', name:'N√©ant', c:'#4c1d95', price: 3500}, {id:'crimson', name:'Pourpre', c:'#be185d', price: 3000}, {id:'white', name:'Blanc', c:'#e5e5e5', price: 4000}] }, 
            pyro: { name: "Pyro", rarity: 'epic', icon: "üî•", hp: 160, dmg: 7, spd: 5 * SPEED_FACTOR, rate: Math.ceil(4 * RATE_FACTOR), ammo:50, reload:Math.ceil(10 * RELOAD_FACTOR), price: PRICE_EPIC, scale:{hp:15, dmg:1}, color: '#f97316', type: 'flame', desc: "Zone de feu.", gadget: "dash", lore: "Adore l'odeur du napalm.", passive: "Br√ªlure", 
                    proj: { r: 15, speed: Math.ceil(10 * PROJ_SPEED_FACTOR), life: 30, shape: 'flame', color: '#f97316', trailColor: '#fef3c7' },
                    skins: [{id:'default', name:'Pyro', c:'#f97316'}, {id:'blueflame', name:'Flamme Bleue', c:'#3b82f6', price: 2000}, {id:'toxic', name:'Toxique', c:'#16a34a', price: 1500}, {id:'inferno', name:'Inferno', c:'#7f1d1d', price: 2500}, {id:'charcoal', name:'Charbon', c:'#262626', price: 3000}] }, 
            viper: { name: "Viper", rarity: 'epic', icon: "üêç", hp: 110, dmg: 10, spd: 6.2 * SPEED_FACTOR, rate: Math.ceil(5 * RATE_FACTOR), ammo: 25, reload: Math.ceil(40 * RELOAD_FACTOR), price: PRICE_EPIC, scale:{hp:8, dmg:1}, color: '#4d7c0f', type: 'flame', desc: "Tire du poison.", gadget: "speed", lore: "Mortel et silencieux.", passive: "Poison", 
                     proj: { r: 6, speed: Math.ceil(28 * PROJ_SPEED_FACTOR), life: 70, shape: 'snake', color: '#4d7c0f', trailColor: '#10b981' },
                     skins: [{id:'default', name:'Viper', c:'#4d7c0f'}, {id:'cobra', name:'Cobra', c:'#eab308', price: 2000}, {id:'venom', name:'Venin', c:'#10b981', price: 2500}, {id:'ice', name:'Glace', c:'#0ea5e9', price: 2200}, {id:'purple', name:'Violet', c:'#9333ea', price: 2800}] }, 
            shaman: { name: "Shaman", rarity: 'epic', icon: "üåø", hp: 140, dmg: 15, spd: 5.2 * SPEED_FACTOR, rate: Math.ceil(18 * RATE_FACTOR), ammo:4, reload:Math.ceil(30 * RELOAD_FACTOR), price: PRICE_EPIC, scale:{hp:12, dmg:2}, color: '#10b981', type: 'normal', desc: "Aura toxique.", gadget: "heal", lore: "Force de la nature.", passive: "Poison Aura",
                      proj: { r: 7, speed: Math.ceil(18 * PROJ_SPEED_FACTOR), life: 65, shape: 'circle', color: '#10b981', trailColor: '#6ee7b7' },
                      skins: [{id:'default', name:'Shaman', c:'#10b981'}, {id:'spirit', name:'Esprit', c:'#e5e7eb', price: 2000}, {id:'void', name:'N√©ant', c:'#374151', price: 3000}, {id:'fire', name:'Feu', c:'#ef4444', price: 3000}, {id:'ice', name:'Glace', c:'#3b82f6', price: 3500}] }, 
            reaper: { name: "Reaper", rarity: 'epic', icon: "üíÄ", hp: 200, dmg: 55, spd: 6.0 * SPEED_FACTOR, rate: Math.ceil(20 * RATE_FACTOR), ammo:1, reload:Math.ceil(35 * RELOAD_FACTOR), price: PRICE_EPIC, scale:{hp:15, dmg:7}, color: '#171717', type: 'melee', desc: "Faux de l'ombre.", gadget: "dash", lore: "S√®me la mort.", passive: "Vol de Vie",
                      proj: { r: 50, speed: 0, life: 1, shape: 'melee', color: '#171717', trailColor: '#a8a29e' },
                      skins: [{id:'default', name:'Reaper', c:'#171717'}, {id:'blood', name:'Sanglant', c:'#b91c1c', price: 2500}, {id:'toxic', name:'Toxique', c:'#10b981', price: 3500}, {id:'bone', name:'Os', c:'#e5e5e5', price: 4000}, {id:'phantom', name:'Fant√¥me', c:'#8b5cf6', price: 4500}] }, 
            volt: { name: "Volt", rarity: 'epic', icon: "‚ö°", hp: 110, dmg: 18, spd: 6.0 * SPEED_FACTOR, rate: Math.ceil(10 * RATE_FACTOR), ammo: 4, reload: Math.ceil(30 * RELOAD_FACTOR), price: PRICE_EPIC, scale:{hp:8, dmg:3}, color: '#facc15', desc: "Tir √©lectrique.", gadget: "speed", lore: "√ânergie statique.", passive: "Etourdissement", 
                    proj: { r: 6, speed: Math.ceil(28 * PROJ_SPEED_FACTOR), life: 60, shape: 'laser', color: '#facc15', trailColor: '#fef08a' },
                    skins: [{id:'default', name:'Volt', c:'#facc15'}, {id:'plasma', name:'Plasma', c:'#8b5cf6', price: 2500}, {id:'dark', name:'Sombre', c:'#1e293b', price: 2000}, {id:'neon', name:'N√©on', c:'#22d3ee', price: 2800}, {id:'overload', name:'Surcharge', c:'#f87171', price: 3000}] }, 
            // NOUVEAU H√âROS : √âPIQUE
            hex: { name: "Hex", rarity: 'epic', icon: "üîÆ", hp: 130, dmg: 10, spd: 5.5 * SPEED_FACTOR, rate: Math.ceil(25 * RATE_FACTOR), ammo:2, reload:Math.ceil(60 * RELOAD_FACTOR), price: PRICE_EPIC, scale:{hp:10, dmg:1}, color: '#a855f7', type: 'normal', desc: "Mal√©diction.", gadget: "knockback", lore: "Jette des sorts de ralentissement.", passive: "D√©g√¢ts DOT",
                   proj: { r: 8, speed: Math.ceil(15 * PROJ_SPEED_FACTOR), life: 90, shape: 'hex', color: '#a855f7', trailColor: '#d8b4fe' },
                   skins: [{id:'default', name:'Hex', c:'#a855f7'}, {id:'crimson', name:'Pourpre', c:'#be185d', price: 2000}, {id:'ombre', name:'Ombre', c:'#0f172a', price: 2500}, {id:'swamp', name:'Marais', c:'#4d7c0f', price: 2800}, {id:'blood', name:'Sang', c:'#991b1b', price: 3200}] },

            ronin: { name: "Ronin", rarity: 'legendary', icon: "üëπ", hp: 180, dmg: 60, spd: 6.5 * SPEED_FACTOR, rate: Math.ceil(25 * RATE_FACTOR), ammo:3, reload:Math.ceil(40 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale:{hp:12, dmg:8}, color: '#be185d', type: 'melee', desc: "Katana.", gadget: "heal", lore: "Cherche la r√©demption.", passive: "Vol de Vie", 
                     proj: { r: 50, speed: 0, life: 1, shape: 'melee', color: '#be185d', trailColor: '#f0f' },
                     skins: [{id:'default', name:'Ronin', c:'#be185d'}, {id:'ghost', name:'Fant√¥me', c:'#e5e7eb', price: 3500}, {id:'cyber', name:'Cyber', c:'#06b6d4', price: 3000}, {id:'demon', name:'D√©mon', c:'#7f1d1d', price: 4000}, {id:'master', name:'Ma√Ætre', c:'#a3e635', price: 4500}] }, 
            samurai: { name: "Samurai", rarity: 'legendary', icon: "‚öîÔ∏è", hp: 250, dmg: 70, spd: 5.5 * SPEED_FACTOR, rate: Math.ceil(30 * RATE_FACTOR), ammo:2, reload:Math.ceil(50 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale:{hp:20, dmg:10}, color: '#1e3a8a', type: 'melee', desc: "Lame lourde.", gadget: "shield", lore: "Le protecteur de l'empereur.", passive: "Parade", 
                       proj: { r: 60, speed: 0, life: 1, shape: 'melee', color: '#1e3a8a', trailColor: '#3b82f6' },
                       skins: [{id:'default', name:'Samurai', c:'#1e3a8a'}, {id:'gold', name:'Samurai Or', c:'#eab308', price: 3500}, {id:'shogun', name:'Shogun', c:'#7f1d1d', price: 4000}, {id:'shadow', name:'Ombre', c:'#0f172a', price: 3800}, {id:'jade', name:'Jade', c:'#10b981', price: 4500}] },
            cyber: { name: "Cyber", rarity: 'legendary', icon: "üíª", hp: 140, dmg: 35, spd: 5 * SPEED_FACTOR, rate: Math.ceil(20 * RATE_FACTOR), ammo:3, reload:Math.ceil(45 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale:{hp:10, dmg:5}, color: '#06b6d4', type: 'laser', desc: "Laser.", gadget: "teleport", lore: "Fusion homme-machine.", passive: "Pr√©cision", 
                     proj: { r: 4, speed: 40, life: 80, shape: 'laser', color: '#06b6d4', trailColor: '#67e8f9' },
                     skins: [{id:'default', name:'Cyber', c:'#06b6d4'}, {id:'neon', name:'N√©on', c:'#d946ef', price: 4000}, {id:'proto', name:'Proto', c:'#64748b', price: 2000}, {id:'matrix', name:'Matrix', c:'#10b981', price: 3500}, {id:'gold', name:'Or', c:'#fbbf24', price: 4500}] }, 
            pulse: { name: "Pulse", rarity: 'legendary', icon: "üí†", hp: 100, dmg: 25, spd: 5.8 * SPEED_FACTOR, rate: Math.ceil(12 * RATE_FACTOR), ammo: 4, reload: Math.ceil(25 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale:{hp:8, dmg:3}, color: '#22d3ee', type: 'laser', desc: "Ondes d'√©nergie.", gadget: "stun", lore: "Technicien sonique.", passive: "Aura Dmg", 
                     proj: { r: 8, speed: 35, life: 60, shape: 'laser', color: '#22d3ee', trailColor: '#67e8f9' },
                     skins: [{id:'default', name:'Pulse', c:'#22d3ee'}, {id:'neon', name:'N√©on', c:'#f0abfc', price: 2500}, {id:'darkmatter', name:'Mati√®re Noire', c:'#312e81', price: 3500}, {id:'quantum', name:'Quantique', c:'#a855f7', price: 4000}, {id:'sonic', name:'Sonique', c:'#3b82f6', price: 4000}] }, 
            // NOUVEAU H√âROS : L√âGENDAIRE
            centurion: { name: "Centurion", rarity: 'legendary', icon: "üõ°Ô∏è", hp: 400, dmg: 25, spd: 3.2 * SPEED_FACTOR, rate: Math.ceil(30 * RATE_FACTOR), ammo:5, reload:Math.ceil(50 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale:{hp:35, dmg:4}, color: '#78350f', type: 'shotgun', desc: "Lenteur. Bouclier frontal.", gadget: "shield", lore: "Le dernier rempart de l'ancienne garde.", passive: "Blocage",
                       proj: { r: 7, speed: Math.ceil(15 * PROJ_SPEED_FACTOR), life: 60, shape: 'circle', color: '#f59e0b', trailColor: '#78350f' },
                       skins: [{id:'default', name:'Centurion', c:'#78350f'}, {id:'silver', name:'Argent', c:'#e5e7eb', price: 4000}, {id:'gold', name:'Or', c:'#eab308', price: 4500}, {id:'bronze', name:'Bronze', c:'#78350f', price: 3500}, {id:'ghost', name:'Spectre', c:'#9ca3af', price: 5000}] },

            titan: { name: "Titan", rarity: 'mythic', icon: "ü¶æ", hp: 600, dmg: 40, spd: 3.0 * SPEED_FACTOR, rate: Math.ceil(50 * RATE_FACTOR), ammo:2, reload:Math.ceil(70 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale:{hp:50, dmg:5}, color: '#eab308', type: 'melee', desc: "SAISON 1.", gadget: "shield", lore: "Gardien l√©gendaire.", passive: "R√©sistance", 
                     proj: { r: 60, speed: 0, life: 1, shape: 'melee', color: '#eab308', trailColor: '#fde047' },
                     skins: [{id:'default', name:'Titan', c:'#eab308'}, {id:'prime', name:'Titan Prime', c:'#713f12', price: 9999}, {id:'frozen', name:'Givr√©', c:'#0ea5e9', price: 5000}, {id:'dark', name:'Sombre', c:'#0f172a', price: 6000}, {id:'glitch', name:'Bug', c:'#10b981', price: 7000}] }, 
            goliath: { name: "Goliath", rarity: 'mythic', icon: "üóø", hp: 450, dmg: 12, spd: 3.0 * SPEED_FACTOR, rate: Math.ceil(40 * RATE_FACTOR), ammo: 2, reload: Math.ceil(60 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale:{hp:40, dmg:2}, color: '#78716c', type: 'shotgun', desc: "Lance des rochers.", gadget: "shield", lore: "G√©ant de pierre.", passive: "√âcrasement", 
                       proj: { r: 18, speed: 10, life: 120, shape: 'rock', color: '#78716c', trailColor: '#a8a29e' },
                       skins: [{id:'default', name:'Goliath', c:'#78716c'}, {id:'moss', name:'Mousse', c:'#166534', price: 1500}, {id:'obsidian', name:'Obsidienne', c:'#0f172a', price: 3500}, {id:'crystal', name:'Cristal', c:'#67e8f9', price: 4500}, {id:'sand', name:'Sable', c:'#d6d3d1', price: 2500}] }, 
            magma: { name: "Magma", rarity: 'mythic', icon: "üåã", hp: 380, dmg: 60, spd: 3.2 * SPEED_FACTOR, rate: Math.ceil(45 * RATE_FACTOR), ammo: 2, reload: Math.ceil(55 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale:{hp:25, dmg:4}, color: '#7f1d1d', type: 'flame', desc: "SAISON 1.", gadget: "dash", lore: "N√© dans un volcan.", passive: "Lave", 
                     proj: { r: 12, speed: 14, life: 40, shape: 'flame', color: '#7f1d1d', trailColor: '#f97316' },
                     skins: [{id:'default', name:'Magma', c:'#7f1d1d'}, {id:'blue', name:'Flamme Bleue', c:'#2563eb', price: 3000}, {id:'obsidian', name:'Obsidienne', c:'#171717', price: 4000}, {id:'core', name:'Noyau', c:'#fcd34d', price: 5000}, {id:'ash', name:'Cendres', c:'#52525b', price: 3500}] }, 
            chrono: { name: "Chrono", rarity: 'mythic', icon: "‚è≥", hp: 100, dmg: 12, spd: 6.5 * SPEED_FACTOR, rate: Math.ceil(4 * RATE_FACTOR), ammo: 30, reload: 15, price: PRICE_MYTHIC, scale:{hp:8, dmg:1}, color: '#0ea5e9', type: 'laser', desc: "Ma√Ætre du temps.", gadget: "teleport", lore: "Vient du futur pour gagner.", passive: "Recharge Rapide", 
                      proj: { r: 5, speed: 32, life: 90, shape: 'laser', color: '#0ea5e9', trailColor: '#7dd3fc' },
                      skins: [{id:'default', name:'Chrono', c:'#0ea5e9'}, {id:'future', name:'Future', c:'#f472b6', price: 5000}, {id:'past', name:'Pass√©', c:'#78350f', price: 4500}, {id:'void', name:'Vide', c:'#4c1d95', price: 5200}, {id:'matrix', name:'Matrice', c:'#10b981', price: 6000}] },
            // NOUVEAU H√âROS : MYTHIQUE
            overlord: { name: "Overlord", rarity: 'mythic', icon: "üëë", hp: 550, dmg: 35, spd: 2.8 * SPEED_FACTOR, rate: Math.ceil(45 * RATE_FACTOR), ammo:5, reload:Math.ceil(80 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale:{hp:45, dmg:4}, color: '#ef4444', type: 'shotgun', desc: "Tir en c√¥ne, tr√®s lent.", gadget: "knockback", lore: "Le chef supr√™me de l'invasion.", passive: "Omni-vision",
                        proj: { r: 15, speed: 15, life: 50, shape: 'circle', color: '#be185d', trailColor: '#fecaca' },
                        skins: [{id:'default', name:'Overlord', c:'#ef4444'}, {id:'dark', name:'Seigneur Noir', c:'#000000', price: 6000}, {id:'gold', name:'Empereur', c:'#facc15', price: 7000}, {id:'ice', name:'Roi Liche', c:'#3b82f6', price: 6500}, {id:'cyber', name:'Cyber Lord', c:'#a855f7', price: 5500}] },

            // NOUVEAUX H√âROS v1.2.4 (WILD UPDATE)
            bear: { name: "Bear", rarity: 'common', icon: "üêª", hp: 190, dmg: 20, spd: 4.8 * SPEED_FACTOR, rate: Math.ceil(18 * RATE_FACTOR), ammo: 3, reload: Math.ceil(35 * RELOAD_FACTOR), price: PRICE_COMMON, scale: {hp: 15, dmg: 2}, color: '#78350f', type: 'melee', desc: "Gros et costaud.", gadget: "heal", lore: "La force de la for√™t.", passive: "R√©sistance", proj: { r: 20, speed: 0, life: 1, shape: 'melee', color: '#78350f', trailColor: '#92400e' }, skins: [{id:'default', name:'Bear', c:'#78350f'}, {id:'polar', name:'Polaire', c:'#f1f5f9', price: 1000}, {id:'panda', name:'Panda', c:'#171717', price: 1500}, {id:'cyber', name:'Cyber Ours', c:'#0ea5e9', price: 2000}, {id:'teddy', name:'Peluche', c:'#f472b6', price: 2500}] },
            wolf: { name: "Wolf", rarity: 'rare', icon: "üê∫", hp: 120, dmg: 18, spd: 7.0 * SPEED_FACTOR, rate: Math.ceil(10 * RATE_FACTOR), ammo: 6, reload: Math.ceil(25 * RELOAD_FACTOR), price: PRICE_RARE, scale: {hp: 8, dmg: 3}, color: '#64748b', type: 'normal', desc: "Chasseur en meute.", gadget: "speed", lore: "Le pr√©dateur alpha.", passive: "Rage", proj: { r: 5, speed: Math.ceil(28 * PROJ_SPEED_FACTOR), life: 60, shape: 'paw', color: '#64748b', trailColor: '#94a3b8' }, skins: [{id:'default', name:'Wolf', c:'#64748b'}, {id:'black', name:'Noir', c:'#171717', price: 1500}, {id:'fire', name:'Fenrir', c:'#ef4444', price: 2000}, {id:'ice', name:'Loup des Glaces', c:'#bae6fd', price: 2500}, {id:'mecha', name:'Robo-Loup', c:'#eab308', price: 3000}] },
            eagle: { name: "Eagle", rarity: 'epic', icon: "ü¶Ö", hp: 90, dmg: 60, spd: 6.5 * SPEED_FACTOR, rate: Math.ceil(40 * RATE_FACTOR), ammo: 2, reload: Math.ceil(50 * RELOAD_FACTOR), price: PRICE_EPIC, scale: {hp: 5, dmg: 8}, color: '#b45309', type: 'sniper', desc: "Vue per√ßante.", gadget: "teleport", lore: "Roi des cieux.", passive: "Vision", proj: { r: 6, speed: Math.ceil(40 * PROJ_SPEED_FACTOR), life: 100, shape: 'sniper', color: '#b45309', trailColor: '#d97706' }, skins: [{id:'default', name:'Eagle', c:'#b45309'}, {id:'usa', name:'Patriote', c:'#3b82f6', price: 3000}, {id:'phoenix', name:'Ph√©nix', c:'#f97316', price: 3500}, {id:'golden', name:'Aigle Royal', c:'#facc15', price: 4000}, {id:'harpy', name:'Harpie', c:'#10b981', price: 3500}] },
            rhino: { name: "Rhino", rarity: 'legendary', icon: "ü¶è", hp: 350, dmg: 35, spd: 4.2 * SPEED_FACTOR, rate: Math.ceil(25 * RATE_FACTOR), ammo: 4, reload: Math.ceil(40 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale: {hp: 25, dmg: 5}, color: '#52525b', type: 'melee', desc: "Charge d√©vastatrice.", gadget: "knockback", lore: "Rien ne l'arr√™te.", passive: "Blocage", proj: { r: 25, speed: 0, life: 1, shape: 'melee', color: '#52525b', trailColor: '#71717a' }, skins: [{id:'default', name:'Rhino', c:'#52525b'}, {id:'armored', name:'Blind√©', c:'#1e293b', price: 4500}, {id:'red', name:'Fureur', c:'#b91c1c', price: 5000}, {id:'jade', name:'Jade', c:'#10b981', price: 5500}, {id:'gold', name:'Lingot', c:'#facc15', price: 6000}] },
            shark: { name: "Shark", rarity: 'mythic', icon: "ü¶à", hp: 220, dmg: 28, spd: 6.0 * SPEED_FACTOR, rate: Math.ceil(12 * RATE_FACTOR), ammo: 8, reload: Math.ceil(30 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale: {hp: 15, dmg: 4}, color: '#0ea5e9', type: 'shotgun', desc: "M√¢choires d'acier.", gadget: "speed", lore: "Terreur des oc√©ans.", passive: "Saignement", proj: { r: 8, speed: Math.ceil(22 * PROJ_SPEED_FACTOR), life: 50, shape: 'shark', color: '#0ea5e9', trailColor: '#7dd3fc' }, skins: [{id:'default', name:'Shark', c:'#0ea5e9'}, {id:'greatwhite', name:'Grand Blanc', c:'#e2e8f0', price: 6000}, {id:'hammer', name:'Marteau', c:'#64748b', price: 6500}, {id:'lava', name:'Magma Shark', c:'#ef4444', price: 7000}, {id:'void', name:'Abyssal', c:'#1e1b4b', price: 8000}] },

            // --- NOUVEAUX H√âROS AJOUT√âS (v1.0.1) ---
            archer: { name: "Archer", rarity: 'common', icon: "üèπ", hp: 100, dmg: 25, spd: 6.0 * SPEED_FACTOR, rate: Math.ceil(15 * RATE_FACTOR), ammo:1, reload:Math.ceil(20 * RELOAD_FACTOR), price: PRICE_COMMON, scale:{hp:5, dmg:3}, color: '#166534', type: 'normal', desc: "Tire des fl√®ches pr√©cises.", gadget: "speed", lore: "Chasseur de la for√™t cybern√©tique.", passive: "Pr√©cision",
                      proj: { r: 3, speed: Math.ceil(35 * PROJ_SPEED_FACTOR), life: 80, shape: 'arrow', color: '#166534', trailColor: '#86efac' },
                      skins: [{id:'default', name:'Archer', c:'#166534'}, {id:'elf', name:'Elfe', c:'#4ade80', price: 1000}, {id:'dark', name:'Sombre', c:'#1e293b', price: 1500}, {id:'fire', name:'Feu', c:'#ef4444', price: 2000}, {id:'ice', name:'Glace', c:'#bae6fd', price: 1800}] },

            brawler: { name: "Brawler", rarity: 'common', icon: "ü•ä", hp: 160, dmg: 12, spd: 6.5 * SPEED_FACTOR, rate: Math.ceil(6 * RATE_FACTOR), ammo:20, reload:Math.ceil(25 * RELOAD_FACTOR), price: PRICE_COMMON, scale:{hp:12, dmg:1}, color: '#b91c1c', type: 'melee', desc: "Combat au corps √† corps.", gadget: "dash", lore: "Champion de boxe clandestin.", passive: "Rage",
                       proj: { r: 15, speed: 0, life: 1, shape: 'melee', color: '#b91c1c', trailColor: '#fca5a5' },
                       skins: [{id:'default', name:'Brawler', c:'#b91c1c'}, {id:'gold', name:'Champion', c:'#eab308', price: 2000}, {id:'street', name:'Rue', c:'#475569', price: 1000}, {id:'lucha', name:'Luchador', c:'#16a34a', price: 1500}, {id:'robot', name:'Cyborg', c:'#64748b', price: 2500}] },

            doc: { name: "Doc", rarity: 'rare', icon: "üë®‚Äç‚öïÔ∏è", hp: 130, dmg: 12, spd: 5.2 * SPEED_FACTOR, rate: Math.ceil(15 * RATE_FACTOR), ammo: 10, reload: Math.ceil(25 * RELOAD_FACTOR), price: PRICE_RARE, scale: {hp: 10, dmg: 2}, color: '#22c55e', type: 'normal', desc: "Soigne les alli√©s et le joueur.", gadget: "heal", lore: "Chirurgien de combat.", passive: "Regen Rapide", proj: { r: 5, speed: Math.ceil(25 * PROJ_SPEED_FACTOR), life: 60, shape: 'cross', color: '#22c55e', trailColor: '#86efac' }, skins: [{id:'default', name:'Doc', c:'#22c55e'}, {id:'plague', name:'Peste', c:'#1e293b', price: 2000}, {id:'combat', name:'Combat', c:'#b91c1c', price: 2500}, {id:'angel', name:'Ange', c:'#fcd34d', price: 3000}, {id:'cyber', name:'Cyber-Doc', c:'#0ea5e9', price: 3500}] },

            grenadier: { name: "Grenadier", rarity: 'rare', icon: "üß®", hp: 140, dmg: 35, spd: 5.0 * SPEED_FACTOR, rate: Math.ceil(25 * RATE_FACTOR), ammo:3, reload:Math.ceil(45 * RELOAD_FACTOR), price: PRICE_RARE, scale:{hp:10, dmg:4}, color: '#ea580c', type: 'shotgun', desc: "Lance-grenades.", gadget: "knockback", lore: "Expert en d√©molition.", passive: "Explosion+",
                         proj: { r: 8, speed: Math.ceil(18 * PROJ_SPEED_FACTOR), life: 50, shape: 'circle', color: '#ea580c', trailColor: '#fdba74' },
                         skins: [{id:'default', name:'Grenadier', c:'#ea580c'}, {id:'military', name:'Militaire', c:'#3f6212', price: 1500}, {id:'party', name:'F√™te', c:'#db2777', price: 2000}, {id:'toxic', name:'Toxique', c:'#84cc16', price: 1800}, {id:'ice', name:'Givre', c:'#bae6fd', price: 2200}] },
            vortex: { name: "Vortex", rarity: 'epic', icon: "üåÄ", hp: 120, dmg: 15, spd: 5.8 * SPEED_FACTOR, rate: Math.ceil(10 * RATE_FACTOR), ammo:8, reload:Math.ceil(35 * RELOAD_FACTOR), price: PRICE_EPIC, scale:{hp:8, dmg:2}, color: '#7c3aed', type: 'normal', desc: "Tirs gravitationnels.", gadget: "teleport", lore: "Manipule l'espace-temps.", passive: "Ralentissement",
                      proj: { r: 6, speed: Math.ceil(22 * PROJ_SPEED_FACTOR), life: 60, shape: 'circle', color: '#7c3aed', trailColor: '#c4b5fd' },
                      skins: [{id:'default', name:'Vortex', c:'#7c3aed'}, {id:'galaxy', name:'Galaxie', c:'#1e1b4b', price: 3000}, {id:'blackhole', name:'Trou Noir', c:'#000000', price: 3500}, {id:'sun', name:'Solaire', c:'#facc15', price: 2500}, {id:'nebula', name:'N√©buleuse', c:'#ec4899', price: 3200}] },

            nova: { name: "Nova", rarity: 'legendary', icon: "üåü", hp: 130, dmg: 28, spd: 6.2 * SPEED_FACTOR, rate: Math.ceil(15 * RATE_FACTOR), ammo:5, reload:Math.ceil(30 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale:{hp:10, dmg:3}, color: '#fef08a', type: 'laser', desc: "√ânergie stellaire.", gadget: "stun", lore: "Une √©toile vivante.", passive: "√âblouissement",
                    proj: { r: 5, speed: Math.ceil(30 * PROJ_SPEED_FACTOR), life: 70, shape: 'star', color: '#fef08a', trailColor: '#facc15' },
                    skins: [{id:'default', name:'Nova', c:'#fef08a'}, {id:'supernova', name:'Supernova', c:'#f97316', price: 4000}, {id:'dwarf', name:'Naine Blanche', c:'#e2e8f0', price: 3500}, {id:'neutron', name:'Neutron', c:'#8b5cf6', price: 4500}, {id:'pulsar', name:'Pulsar', c:'#3b82f6', price: 4200}] },

            // NOUVEAUX H√âROS v1.0.3
            rock: { name: "Rock", rarity: 'common', icon: "ü™®", hp: 150, dmg: 20, spd: 5.0 * SPEED_FACTOR, rate: Math.ceil(20 * RATE_FACTOR), ammo: 3, reload: Math.ceil(40 * RELOAD_FACTOR), price: PRICE_COMMON, scale: {hp: 12, dmg: 2}, color: '#78716c', type: 'shotgun', desc: "Lance des pierres.", gadget: "shield", lore: "Un golem de pierre.", passive: "R√©sistance", proj: { r: 6, speed: Math.ceil(15 * PROJ_SPEED_FACTOR), life: 50, shape: 'rock', color: '#78716c', trailColor: '#a8a29e' }, skins: [{id:'default', name:'Rock', c:'#78716c'}, {id:'moss', name:'Mousse', c:'#65a30d', price: 1000}, {id:'magma', name:'Magma', c:'#ef4444', price: 1500}, {id:'gold', name:'P√©pite', c:'#fbbf24', price: 2000}, {id:'ice', name:'Givre', c:'#bae6fd', price: 1800}] },
            frost: { name: "Frost", rarity: 'rare', icon: "‚ùÑÔ∏è", hp: 120, dmg: 15, spd: 5.5 * SPEED_FACTOR, rate: Math.ceil(15 * RATE_FACTOR), ammo: 5, reload: Math.ceil(35 * RELOAD_FACTOR), price: PRICE_RARE, scale: {hp: 8, dmg: 2}, color: '#0ea5e9', type: 'normal', desc: "G√®le les ennemis.", gadget: "stun", lore: "Venu du grand nord.", passive: "Ralentissement", proj: { r: 5, speed: Math.ceil(22 * PROJ_SPEED_FACTOR), life: 60, shape: 'circle', color: '#0ea5e9', trailColor: '#7dd3fc' }, skins: [{id:'default', name:'Frost', c:'#0ea5e9'}, {id:'dark', name:'Sombre', c:'#1e3a8a', price: 1500}, {id:'polar', name:'Polaire', c:'#f0f9ff', price: 2000}, {id:'yeti', name:'Y√©ti', c:'#e2e8f0', price: 2500}, {id:'fire', name:'Fondu', c:'#fdba74', price: 2000}] },
            blaze: { name: "Blaze", rarity: 'epic', icon: "üî•", hp: 110, dmg: 8, spd: 6.0 * SPEED_FACTOR, rate: Math.ceil(5 * RATE_FACTOR), ammo: 30, reload: Math.ceil(20 * RELOAD_FACTOR), price: PRICE_EPIC, scale: {hp: 8, dmg: 1}, color: '#f97316', type: 'flame', desc: "Lance-flammes.", gadget: "dash", lore: "Pyromane expert.", passive: "Br√ªlure", proj: { r: 8, speed: Math.ceil(12 * PROJ_SPEED_FACTOR), life: 40, shape: 'flame', color: '#f97316', trailColor: '#fdba74' }, skins: [{id:'default', name:'Blaze', c:'#f97316'}, {id:'blueflame', name:'Flamme Bleue', c:'#3b82f6', price: 2500}, {id:'shadow', name:'Ombre', c:'#171717', price: 3000}, {id:'toxic', name:'Toxique', c:'#16a34a', price: 2800}, {id:'white', name:'Pur', c:'#ffffff', price: 3500}] },
            storm: { name: "Storm", rarity: 'legendary', icon: "‚õàÔ∏è", hp: 100, dmg: 25, spd: 6.5 * SPEED_FACTOR, rate: Math.ceil(12 * RATE_FACTOR), ammo: 4, reload: Math.ceil(30 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale: {hp: 6, dmg: 3}, color: '#6366f1', type: 'laser', desc: "Foudre en cha√Æne.", gadget: "teleport", lore: "Ma√Ætre des orages.", passive: "Choc", proj: { r: 4, speed: Math.ceil(35 * PROJ_SPEED_FACTOR), life: 80, shape: 'laser', color: '#6366f1', trailColor: '#818cf8' }, skins: [{id:'default', name:'Storm', c:'#6366f1'}, {id:'red', name:'Rouge', c:'#ef4444', price: 3500}, {id:'zeus', name:'Divin', c:'#facc15', price: 4500}, {id:'dark', name:'Sombre', c:'#312e81', price: 4000}, {id:'neon', name:'N√©on', c:'#d946ef', price: 5000}] },
            glitch: { name: "Glitch", rarity: 'mythic', icon: "üëæ", hp: 90, dmg: 40, spd: 7.0 * SPEED_FACTOR, rate: Math.ceil(10 * RATE_FACTOR), ammo: 3, reload: Math.ceil(25 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale: {hp: 5, dmg: 5}, color: '#10b981', type: 'normal', desc: "Bug du syst√®me.", gadget: "teleport", lore: "Une anomalie dans le code.", passive: "Esquive", proj: { r: 6, speed: Math.ceil(30 * PROJ_SPEED_FACTOR), life: 70, shape: 'square', color: '#10b981', trailColor: '#34d399' }, skins: [{id:'default', name:'Glitch', c:'#10b981'}, {id:'error', name:'Erreur', c:'#dc2626', price: 5000}, {id:'matrix', name:'Matrice', c:'#22c55e', price: 6000}, {id:'void', name:'Vide', c:'#000000', price: 5500}, {id:'rgb', name:'RGB', c:'#facc15', price: 6500}] },
            
            // NOUVEAUX H√âROS v1.0.4
            grunt: { name: "Grunt", rarity: 'common', icon: "ü™ñ", hp: 160, dmg: 18, spd: 5.5 * SPEED_FACTOR, rate: Math.ceil(10 * RATE_FACTOR), ammo: 10, reload: Math.ceil(30 * RELOAD_FACTOR), price: PRICE_COMMON, scale: {hp: 10, dmg: 2}, color: '#57534e', type: 'normal', desc: "Soldat lourd.", gadget: "knockback", lore: "L'infanterie de base.", passive: "Gilet Pare-balles", proj: { r: 5, speed: Math.ceil(25 * PROJ_SPEED_FACTOR), life: 60, shape: 'circle', color: '#57534e', trailColor: '#a8a29e' }, skins: [{id:'default', name:'Grunt', c:'#57534e'}, {id:'sand', name:'Sable', c:'#d6d3d1', price: 1000}, {id:'jungle', name:'Jungle', c:'#166534', price: 1500}, {id:'urban', name:'Urbain', c:'#94a3b8', price: 2000}, {id:'elite', name:'Elite', c:'#1e293b', price: 2500}] },
            raptor: { name: "Raptor", rarity: 'rare', icon: "ü¶ñ", hp: 140, dmg: 25, spd: 7.0 * SPEED_FACTOR, rate: Math.ceil(8 * RATE_FACTOR), ammo: 5, reload: Math.ceil(25 * RELOAD_FACTOR), price: PRICE_RARE, scale: {hp: 8, dmg: 2}, color: '#65a30d', type: 'melee', desc: "Pr√©dateur rapide.", gadget: "dash", lore: "Une exp√©rience g√©n√©tique √©chapp√©e.", passive: "Saignement", proj: { r: 15, speed: 0, life: 1, shape: 'melee', color: '#65a30d', trailColor: '#bef264' }, skins: [{id:'default', name:'Raptor', c:'#65a30d'}, {id:'blue', name:'Alpha', c:'#2563eb', price: 2000}, {id:'red', name:'F√©roce', c:'#dc2626', price: 1500}, {id:'albino', name:'Albinos', c:'#f1f5f9', price: 2500}, {id:'gold', name:'Dor√©', c:'#fbbf24', price: 3000}] },
            orbit: { name: "Orbit", rarity: 'epic', icon: "ü™ê", hp: 150, dmg: 12, spd: 5.2 * SPEED_FACTOR, rate: Math.ceil(15 * RATE_FACTOR), ammo: 6, reload: Math.ceil(30 * RELOAD_FACTOR), price: PRICE_EPIC, scale: {hp: 12, dmg: 2}, color: '#ec4899', type: 'normal', desc: "Tirs orbitaux.", gadget: "shield", lore: "Contr√¥le des satellites tueurs.", passive: "Satellite", proj: { r: 6, speed: Math.ceil(20 * PROJ_SPEED_FACTOR), life: 70, shape: 'circle', color: '#ec4899', trailColor: '#fbcfe8' }, skins: [{id:'default', name:'Orbit', c:'#ec4899'}, {id:'space', name:'Espace', c:'#1e3a8a', price: 2500}, {id:'sun', name:'Solaire', c:'#ea580c', price: 3000}, {id:'moon', name:'Lunaire', c:'#94a3b8', price: 2800}, {id:'cyber', name:'Cyber', c:'#06b6d4', price: 3500}] },
            solar: { name: "Solar", rarity: 'legendary', icon: "‚òÄÔ∏è", hp: 160, dmg: 40, spd: 5.5 * SPEED_FACTOR, rate: Math.ceil(25 * RATE_FACTOR), ammo: 3, reload: Math.ceil(40 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale: {hp: 15, dmg: 4}, color: '#f59e0b', type: 'shotgun', desc: "√âruptions solaires.", gadget: "stun", lore: "Puissance d'une √©toile.", passive: "Radiance", proj: { r: 10, speed: Math.ceil(18 * PROJ_SPEED_FACTOR), life: 60, shape: 'star', color: '#f59e0b', trailColor: '#fde047' }, skins: [{id:'default', name:'Solar', c:'#f59e0b'}, {id:'eclipse', name:'√âclipse', c:'#1f2937', price: 4000}, {id:'blue', name:'G√©ante Bleue', c:'#3b82f6', price: 4500}, {id:'red', name:'G√©ante Rouge', c:'#ef4444', price: 5000}, {id:'white', name:'Naine Blanche', c:'#f8fafc', price: 5500}] },
            spectre: { name: "Spectre", rarity: 'mythic', icon: "üëª", hp: 100, dmg: 55, spd: 6.8 * SPEED_FACTOR, rate: Math.ceil(15 * RATE_FACTOR), ammo: 2, reload: Math.ceil(35 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale: {hp: 5, dmg: 6}, color: '#64748b', type: 'normal', desc: "Tueur fant√¥me.", gadget: "invis", lore: "On ne le voit que trop tard.", passive: "Esquive", proj: { r: 6, speed: Math.ceil(35 * PROJ_SPEED_FACTOR), life: 60, shape: 'circle', color: '#64748b', trailColor: '#f1f5f9' }, skins: [{id:'default', name:'Spectre', c:'#64748b'}, {id:'demon', name:'D√©mon', c:'#b91c1c', price: 5500}, {id:'void', name:'N√©ant', c:'#000000', price: 6000}, {id:'angel', name:'Ange', c:'#fef08a', price: 7000}, {id:'pixel', name:'Pixel', c:'#22c55e', price: 6500}] },
            
            // NOUVEUX H√âROS v1.1.0 (FINAL)
            spike: { name: "Spike", rarity: 'common', icon: "üåµ", hp: 170, dmg: 25, spd: 5.5 * SPEED_FACTOR, rate: Math.ceil(18 * RATE_FACTOR), ammo: 3, reload: Math.ceil(35 * RELOAD_FACTOR), price: PRICE_COMMON, scale: {hp: 12, dmg: 3}, color: '#166534', type: 'shotgun', desc: "Explosion d'√©pines.", gadget: "knockback", lore: "La nature se d√©fend.", passive: "D√©g√¢ts Zone", proj: { r: 5, speed: Math.ceil(20 * PROJ_SPEED_FACTOR), life: 50, shape: 'star', color: '#166534', trailColor: '#86efac' }, skins: [{id:'default', name:'Spike', c:'#166534'}, {id:'sakura', name:'Sakura', c:'#f9a8d4', price: 1500}, {id:'dark', name:'Sombre', c:'#0f172a', price: 1000}, {id:'desert', name:'D√©sert', c:'#d97706', price: 2000}, {id:'mushroom', name:'Champignon', c:'#b91c1c', price: 2500}] },
            tesla: { name: "Tesla", rarity: 'rare', icon: "üîã", hp: 130, dmg: 14, spd: 6.0 * SPEED_FACTOR, rate: Math.ceil(8 * RATE_FACTOR), ammo: 15, reload: Math.ceil(30 * RELOAD_FACTOR), price: PRICE_RARE, scale: {hp: 8, dmg: 2}, color: '#0ea5e9', type: 'laser', desc: "Tir √©lectrique continu.", gadget: "stun", lore: "Inventeur fou.", passive: "Recharge Rapide", proj: { r: 4, speed: Math.ceil(30 * PROJ_SPEED_FACTOR), life: 60, shape: 'laser', color: '#0ea5e9', trailColor: '#bae6fd' }, skins: [{id:'default', name:'Tesla', c:'#0ea5e9'}, {id:'gold', name:'Or', c:'#eab308', price: 2000}, {id:'coil', name:'Bobine', c:'#b91c1c', price: 1500}, {id:'plasma', name:'Plasma', c:'#a855f7', price: 2500}, {id:'steampunk', name:'Vapeur', c:'#78350f', price: 3000}] },
            siren: { name: "Siren", rarity: 'epic', icon: "üé§", hp: 120, dmg: 20, spd: 6.0 * SPEED_FACTOR, rate: Math.ceil(12 * RATE_FACTOR), ammo: 5, reload: Math.ceil(25 * RELOAD_FACTOR), price: PRICE_EPIC, scale: {hp: 8, dmg: 3}, color: '#ec4899', type: 'normal', desc: "Ondes sonores.", gadget: "knockback", lore: "Sa voix est une arme.", passive: "Pr√©cision", proj: { r: 10, speed: Math.ceil(20 * PROJ_SPEED_FACTOR), life: 70, shape: 'circle', color: '#ec4899', trailColor: '#fbcfe8' }, skins: [{id:'default', name:'Siren', c:'#ec4899'}, {id:'pop', name:'Popstar', c:'#f472b6', price: 2500}, {id:'rock', name:'Rockstar', c:'#111827', price: 3000}, {id:'opera', name:'Op√©ra', c:'#fbbf24', price: 3500}, {id:'techno', name:'Techno', c:'#0ea5e9', price: 4000}] },
            paladin: { name: "Paladin", rarity: 'legendary', icon: "üî®", hp: 300, dmg: 45, spd: 4.5 * SPEED_FACTOR, rate: Math.ceil(35 * RATE_FACTOR), ammo: 3, reload: Math.ceil(50 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale: {hp: 30, dmg: 5}, color: '#facc15', type: 'melee', desc: "Marteau sacr√©.", gadget: "heal", lore: "D√©fenseur de la lumi√®re.", passive: "Regen Rapide", proj: { r: 40, speed: 0, life: 1, shape: 'melee', color: '#facc15', trailColor: '#fef9c3' }, skins: [{id:'default', name:'Paladin', c:'#facc15'}, {id:'fallen', name:'D√©chu', c:'#7f1d1d', price: 4500}, {id:'ice', name:'Givre', c:'#e0f2fe', price: 4000}, {id:'jade', name:'Jade', c:'#10b981', price: 5000}, {id:'royal', name:'Royal', c:'#4c1d95', price: 5500}] },
            zenith: { name: "Zenith", rarity: 'mythic', icon: "üåå", hp: 200, dmg: 80, spd: 7.5 * SPEED_FACTOR, rate: Math.ceil(20 * RATE_FACTOR), ammo: 2, reload: Math.ceil(40 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale: {hp: 15, dmg: 10}, color: '#4c1d95', type: 'sniper', desc: "Rayon cosmique.", gadget: "teleport", lore: "Au-del√† de l'univers.", passive: "Pr√©cision", proj: { r: 8, speed: Math.ceil(40 * PROJ_SPEED_FACTOR), life: 100, shape: 'star', color: '#4c1d95', trailColor: '#a78bfa' }, skins: [{id:'default', name:'Zenith', c:'#4c1d95'}, {id:'infinity', name:'Infini', c:'#000000', price: 6000}, {id:'light', name:'Lumi√®re', c:'#ffffff', price: 5500}, {id:'nebula', name:'N√©buleuse', c:'#d946ef', price: 6500}, {id:'antimatter', name:'Antimati√®re', c:'#ef4444', price: 7000}] },
            
            // NOUVEAUX H√âROS v1.1.3
            cyclops: { name: "Cyclops", rarity: 'common', icon: "üëÅÔ∏è", hp: 180, dmg: 40, spd: 4.5 * SPEED_FACTOR, rate: Math.ceil(30 * RATE_FACTOR), ammo: 2, reload: Math.ceil(45 * RELOAD_FACTOR), price: PRICE_COMMON, scale: {hp: 15, dmg: 4}, color: '#991b1b', type: 'laser', desc: "Tir laser unique puissant.", gadget: "shield", lore: "Un regard qui tue.", passive: "Vision", proj: { r: 6, speed: Math.ceil(35 * PROJ_SPEED_FACTOR), life: 60, shape: 'laser', color: '#991b1b', trailColor: '#ef4444' }, skins: [{id:'default', name:'Cyclops', c:'#991b1b'}, {id:'robot', name:'Cyborg', c:'#94a3b8', price: 1000}, {id:'alien', name:'Alien', c:'#22c55e', price: 1500}, {id:'mutant', name:'Mutant', c:'#a3e635', price: 2000}, {id:'demon', name:'D√©mon', c:'#7f1d1d', price: 2500}] },
            banshee: { name: "Banshee", rarity: 'rare', icon: "üßú‚Äç‚ôÄÔ∏è", hp: 110, dmg: 18, spd: 6.5 * SPEED_FACTOR, rate: Math.ceil(15 * RATE_FACTOR), ammo: 8, reload: Math.ceil(30 * RELOAD_FACTOR), price: PRICE_RARE, scale: {hp: 8, dmg: 2}, color: '#8b5cf6', type: 'normal', desc: "Onde de choc sonique.", gadget: "stun", lore: "Son cri glace le sang.", passive: "Peur", proj: { r: 12, speed: Math.ceil(20 * PROJ_SPEED_FACTOR), life: 50, shape: 'circle', color: '#8b5cf6', trailColor: '#ddd6fe' }, skins: [{id:'default', name:'Banshee', c:'#8b5cf6'}, {id:'ghost', name:'Spectre', c:'#f3f4f6', price: 1500}, {id:'dark', name:'T√©n√®bres', c:'#111827', price: 2000}, {id:'sea', name:'Marine', c:'#0ea5e9', price: 2500}, {id:'forest', name:'For√™t', c:'#166534', price: 1800}] },
            druid: { name: "Druid", rarity: 'epic', icon: "ü¶å", hp: 150, dmg: 22, spd: 5.5 * SPEED_FACTOR, rate: Math.ceil(20 * RATE_FACTOR), ammo: 5, reload: Math.ceil(35 * RELOAD_FACTOR), price: PRICE_EPIC, scale: {hp: 12, dmg: 3}, color: '#15803d', type: 'normal', desc: "Magie de la nature.", gadget: "heal", lore: "Gardien de la for√™t ancienne.", passive: "Racines", proj: { r: 8, speed: Math.ceil(22 * PROJ_SPEED_FACTOR), life: 70, shape: 'star', color: '#15803d', trailColor: '#86efac' }, skins: [{id:'default', name:'Druid', c:'#15803d'}, {id:'autumn', name:'Automne', c:'#d97706', price: 2500}, {id:'winter', name:'Hiver', c:'#e0f2fe', price: 3000}, {id:'spring', name:'Printemps', c:'#86efac', price: 2000}, {id:'corrupted', name:'Corrompu', c:'#4c1d95', price: 3500}] },
            spartan: { name: "Spartan", rarity: 'legendary', icon: "üõ°Ô∏è", hp: 350, dmg: 30, spd: 4.0 * SPEED_FACTOR, rate: Math.ceil(25 * RATE_FACTOR), ammo: 4, reload: Math.ceil(40 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale: {hp: 30, dmg: 4}, color: '#b91c1c', type: 'melee', desc: "Coup de bouclier.", gadget: "knockback", lore: "CECI EST SPARTE !", passive: "Blocage", proj: { r: 35, speed: 0, life: 1, shape: 'melee', color: '#b91c1c', trailColor: '#fca5a5' }, skins: [{id:'default', name:'Spartan', c:'#b91c1c'}, {id:'gold', name:'Divin', c:'#facc15', price: 4500}, {id:'shadow', name:'Ombre', c:'#1f2937', price: 4000}, {id:'leonidas', name:'Leonidas', c:'#7f1d1d', price: 5000}, {id:'stone', name:'Pierre', c:'#78716c', price: 3500}] },
            hydra: { name: "Hydra", rarity: 'mythic', icon: "üêâ", hp: 300, dmg: 25, spd: 5.0 * SPEED_FACTOR, rate: Math.ceil(30 * RATE_FACTOR), ammo: 3, reload: Math.ceil(50 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale: {hp: 25, dmg: 5}, color: '#047857', type: 'shotgun', desc: "Tir triple t√™tes.", gadget: "speed", lore: "Coupez une t√™te, deux repoussent.", passive: "Regen", proj: { r: 8, speed: Math.ceil(25 * PROJ_SPEED_FACTOR), life: 60, shape: 'snake', color: '#047857', trailColor: '#34d399' }, skins: [{id:'default', name:'Hydra', c:'#047857'}, {id:'fire', name:'Feu', c:'#ef4444', price: 5500}, {id:'void', name:'Abysses', c:'#312e81', price: 6000}, {id:'ice', name:'Glace', c:'#bae6fd', price: 5000}, {id:'gold', name:'Hydre d\'Or', c:'#eab308', price: 7000}] },

            // NOUVEAUX H√âROS v1.2.0 (Part 1)
            vulcan: { name: "Vulcan", rarity: 'common', icon: "‚öíÔ∏è", hp: 200, dmg: 15, spd: 4.5 * SPEED_FACTOR, rate: Math.ceil(5 * RATE_FACTOR), ammo: 40, reload: Math.ceil(20 * RELOAD_FACTOR), price: PRICE_COMMON, scale: {hp: 15, dmg: 1}, color: '#c2410c', type: 'flame', desc: "Forge vivante.", gadget: "shield", lore: "Il forge ses armes au combat.", passive: "Br√ªlure", proj: { r: 6, speed: Math.ceil(15 * PROJ_SPEED_FACTOR), life: 40, shape: 'flame', color: '#c2410c', trailColor: '#fb923c' }, skins: [{id:'default', name:'Vulcan', c:'#c2410c'}, {id:'steel', name:'Acier', c:'#94a3b8', price: 1000}, {id:'gold', name:'Or', c:'#facc15', price: 1500}, {id:'lava', name:'Lave', c:'#ef4444', price: 2000}, {id:'coal', name:'Charbon', c:'#171717', price: 2500}] },
            zephyr: { name: "Zephyr", rarity: 'rare', icon: "üçÉ", hp: 100, dmg: 18, spd: 7.2 * SPEED_FACTOR, rate: Math.ceil(12 * RATE_FACTOR), ammo: 6, reload: Math.ceil(25 * RELOAD_FACTOR), price: PRICE_RARE, scale: {hp: 6, dmg: 2}, color: '#6ee7b7', type: 'normal', desc: "Ma√Ætre des vents.", gadget: "speed", lore: "Insaisissable comme la brise.", passive: "Esquive", proj: { r: 5, speed: Math.ceil(30 * PROJ_SPEED_FACTOR), life: 70, shape: 'circle', color: '#6ee7b7', trailColor: '#d1fae5' }, skins: [{id:'default', name:'Zephyr', c:'#6ee7b7'}, {id:'cloud', name:'Nuage', c:'#e0f2fe', price: 1500}, {id:'storm', name:'Temp√™te', c:'#6366f1', price: 2000}, {id:'autumn', name:'Automne', c:'#fb923c', price: 1800}, {id:'night', name:'Brise Nocturne', c:'#1e1b4b', price: 2500}] },
            necro: { name: "Necro", rarity: 'epic', icon: "üíÄ", hp: 130, dmg: 25, spd: 5.5 * SPEED_FACTOR, rate: Math.ceil(20 * RATE_FACTOR), ammo: 4, reload: Math.ceil(35 * RELOAD_FACTOR), price: PRICE_EPIC, scale: {hp: 10, dmg: 3}, color: '#4c1d95', type: 'normal', desc: "Magie noire.", gadget: "invis", lore: "Commande aux esprits.", passive: "Vol de Vie", proj: { r: 8, speed: Math.ceil(18 * PROJ_SPEED_FACTOR), life: 60, shape: 'skull', color: '#4c1d95', trailColor: '#a78bfa' }, skins: [{id:'default', name:'Necro', c:'#4c1d95'}, {id:'green', name:'Peste', c:'#166534', price: 2500}, {id:'red', name:'Sang', c:'#991b1b', price: 3000}, {id:'white', name:'Fant√¥me', c:'#f8fafc', price: 3500}, {id:'gold', name:'Liche', c:'#facc15', price: 4000}] },
            gladiator: { name: "Gladiator", rarity: 'legendary', icon: "‚öîÔ∏è", hp: 280, dmg: 50, spd: 5.0 * SPEED_FACTOR, rate: Math.ceil(25 * RATE_FACTOR), ammo: 3, reload: Math.ceil(40 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale: {hp: 25, dmg: 5}, color: '#b45309', type: 'melee', desc: "Champion de l'ar√®ne.", gadget: "shield", lore: "N'a jamais connu la d√©faite.", passive: "Rage", proj: { r: 30, speed: 0, life: 1, shape: 'melee', color: '#b45309', trailColor: '#fcba03' }, skins: [{id:'default', name:'Gladiator', c:'#b45309'}, {id:'iron', name:'Fer', c:'#64748b', price: 4000}, {id:'gold', name:'Champion Or', c:'#facc15', price: 5000}, {id:'tiger', name:'Tigre', c:'#f97316', price: 4500}, {id:'shadow', name:'Murmillo', c:'#171717', price: 5500}] },
            bouncer: { name: "Bouncer", rarity: 'mythic', icon: "üèê", hp: 220, dmg: 30, spd: 5.5 * SPEED_FACTOR, rate: Math.ceil(20 * RATE_FACTOR), ammo: 4, reload: Math.ceil(35 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale: {hp: 15, dmg: 4}, color: '#ec4899', type: 'shotgun', desc: "Projectiles rebondissants.", gadget: "knockback", lore: "Tout rebondit sur lui.", passive: "Rebond", proj: { r: 10, speed: Math.ceil(20 * PROJ_SPEED_FACTOR), life: 80, shape: 'circle', color: '#ec4899', trailColor: '#fbcfe8' }, skins: [{id:'default', name:'Bouncer', c:'#ec4899'}, {id:'slime', name:'Slime', c:'#84cc16', price: 5500}, {id:'rubber', name:'Gomme', c:'#f472b6', price: 6000}, {id:'space', name:'Anti-Gravit√©', c:'#6366f1', price: 6500}, {id:'bubble', name:'Bulle', c:'#0ea5e9', price: 7000}] },

            // NOUVEAUX H√âROS v1.2.0 (Part 2)
            fungus: { name: "Fungus", rarity: 'common', icon: "üçÑ", hp: 160, dmg: 12, spd: 5.0 * SPEED_FACTOR, rate: Math.ceil(15 * RATE_FACTOR), ammo: 10, reload: Math.ceil(30 * RELOAD_FACTOR), price: PRICE_COMMON, scale: {hp: 12, dmg: 2}, color: '#a21caf', type: 'normal', desc: "Spores toxiques.", gadget: "heal", lore: "Un champignon mutant.", passive: "Poison", proj: { r: 6, speed: Math.ceil(18 * PROJ_SPEED_FACTOR), life: 50, shape: 'circle', color: '#a21caf', trailColor: '#f0abfc' }, skins: [{id:'default', name:'Fungus', c:'#a21caf'}, {id:'amanita', name:'Amanite', c:'#dc2626', price: 1000}, {id:'blue', name:'Bleu', c:'#3b82f6', price: 1500}, {id:'glow', name:'Radioactif', c:'#bef264', price: 2000}, {id:'dark', name:'Moisissure', c:'#3f3f46', price: 1800}] },
            wasp: { name: "Wasp", rarity: 'rare', icon: "üêù", hp: 80, dmg: 20, spd: 7.5 * SPEED_FACTOR, rate: Math.ceil(8 * RATE_FACTOR), ammo: 12, reload: Math.ceil(25 * RELOAD_FACTOR), price: PRICE_RARE, scale: {hp: 5, dmg: 3}, color: '#facc15', type: 'normal', desc: "Rapide et piquant.", gadget: "speed", lore: "Attaque en essaim.", passive: "Saignement", proj: { r: 3, speed: Math.ceil(32 * PROJ_SPEED_FACTOR), life: 60, shape: 'arrow', color: '#facc15', trailColor: '#fef08a' }, skins: [{id:'default', name:'Wasp', c:'#facc15'}, {id:'hornet', name:'Frelon', c:'#b45309', price: 1500}, {id:'mech', name:'M√©ca', c:'#94a3b8', price: 2000}, {id:'killer', name:'Tueur', c:'#171717', price: 2500}, {id:'queen', name:'Reine', c:'#ef4444', price: 3000}] },
            mirage: { name: "Mirage", rarity: 'epic', icon: "üé≠", hp: 110, dmg: 22, spd: 6.0 * SPEED_FACTOR, rate: Math.ceil(15 * RATE_FACTOR), ammo: 5, reload: Math.ceil(30 * RELOAD_FACTOR), price: PRICE_EPIC, scale: {hp: 8, dmg: 3}, color: '#14b8a6', type: 'normal', desc: "Trompe l'ennemi.", gadget: "invis", lore: "Maintenant tu me vois...", passive: "Esquive", proj: { r: 6, speed: Math.ceil(25 * PROJ_SPEED_FACTOR), life: 70, shape: 'star', color: '#14b8a6', trailColor: '#99f6e4' }, skins: [{id:'default', name:'Mirage', c:'#14b8a6'}, {id:'sand', name:'Illusion', c:'#d6d3d1', price: 2500}, {id:'neon', name:'Hologramme', c:'#dd88e1', price: 3000}, {id:'crimson', name:'Masque Rouge', c:'#be185d', price: 3500}, {id:'shadow', name:'Ombre', c:'#1e293b', price: 4000}] },
            juggernaut: { name: "Juggernaut", rarity: 'legendary', icon: "üöÜ", hp: 500, dmg: 20, spd: 2.5 * SPEED_FACTOR, rate: Math.ceil(10 * RATE_FACTOR), ammo: 20, reload: Math.ceil(60 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale: {hp: 40, dmg: 2}, color: '#1e293b', type: 'shotgun', desc: "Un tank inarr√™table.", gadget: "shield", lore: "Rien ne l'arr√™te.", passive: "Blocage", proj: { r: 8, speed: Math.ceil(18 * PROJ_SPEED_FACTOR), life: 50, shape: 'square', color: '#1e293b', trailColor: '#64748b' }, skins: [{id:'default', name:'Juggernaut', c:'#1e293b'}, {id:'rust', name:'Rouille', c:'#78350f', price: 4000}, {id:'camo', name:'Militaire', c:'#3f6212', price: 4500}, {id:'police', name:'Anti-√âmeute', c:'#1d4ed8', price: 5000}, {id:'cyber', name:'Cyber Tank', c:'#ef4444', price: 5500}] },
            eclipse: { name: "Eclipse", rarity: 'mythic', icon: "üåë", hp: 200, dmg: 45, spd: 5.5 * SPEED_FACTOR, rate: Math.ceil(25 * RATE_FACTOR), ammo: 3, reload: Math.ceil(45 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale: {hp: 15, dmg: 6}, color: '#171717', type: 'normal', desc: "T√©n√®bres pures.", gadget: "teleport", lore: "Il a √©teint le soleil.", passive: "Aveuglement", proj: { r: 10, speed: Math.ceil(28 * PROJ_SPEED_FACTOR), life: 80, shape: 'circle', color: '#000000', trailColor: '#1e1b4b' }, skins: [{id:'default', name:'Eclipse', c:'#171717'}, {id:'blood', name:'Lune de Sang', c:'#991b1b', price: 6000}, {id:'solar', name:'√âclipse Totale', c:'#f59e0b', price: 7000}, {id:'void', name:'N√©ant', c:'#4c1d95', price: 6500}, {id:'white', name:'Inversion', c:'#ffffff', price: 8000}] },
            
            // NOUVEUX H√âROS v1.3
            cosmo: { name: "Cosmo", rarity: 'mythic', icon: "‚òÑÔ∏è", hp: 180, dmg: 35, spd: 6.0 * SPEED_FACTOR, rate: Math.ceil(20 * RATE_FACTOR), ammo: 4, reload: Math.ceil(40 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale: {hp: 12, dmg: 5}, color: '#8b5cf6', type: 'normal', desc: "Com√®tes rebondissantes.", gadget: "teleport", lore: "Venu d'une autre galaxie.", passive: "Rebond", proj: { r: 8, speed: Math.ceil(25 * PROJ_SPEED_FACTOR), life: 80, shape: 'star', color: '#8b5cf6', trailColor: '#c4b5fd' }, skins: [{id:'default', name:'Cosmo', c:'#8b5cf6'}, {id:'ice', name:'Com√®te Glac√©e', c:'#bae6fd', price: 6000}, {id:'fire', name:'M√©t√©ore', c:'#f97316', price: 6500}, {id:'gold', name:'Poussi√®re d\'Or', c:'#facc15', price: 7000}, {id:'void', name:'Trou Noir', c:'#000000', price: 8000}] },
            brick: { name: "Brick", rarity: 'common', icon: "üß±", hp: 250, dmg: 20, spd: 4.8 * SPEED_FACTOR, rate: Math.ceil(25 * RATE_FACTOR), ammo: 3, reload: Math.ceil(45 * RELOAD_FACTOR), price: PRICE_COMMON, scale: {hp: 20, dmg: 3}, color: '#7c2d12', type: 'shotgun', desc: "Lance des briques.", gadget: "shield", lore: "Solide comme un mur.", passive: "R√©sistance", proj: { r: 8, speed: Math.ceil(18 * PROJ_SPEED_FACTOR), life: 50, shape: 'square', color: '#7c2d12', trailColor: '#ea580c' }, skins: [{id:'default', name:'Brick', c:'#7c2d12'}, {id:'cement', name:'Ciment', c:'#9ca3af', price: 1000}, {id:'red', name:'Brique Rouge', c:'#ef4444', price: 1500}, {id:'blue', name:'Brique Bleue', c:'#3b82f6', price: 2000}, {id:'obsidian', name:'Obsidienne', c:'#171717', price: 2500}] },
        };
        
        // Fonction pour trier les h√©ros par raret√©
        const sortStartersByRarity = () => {
            const order = ['common', 'rare', 'epic', 'legendary', 'mythic'];
            const sortedKeys = Object.keys(STARTERS).sort((a, b) => {
                const rarityA = STARTERS[a].rarity;
                const rarityB = STARTERS[b].rarity;
                return order.indexOf(rarityA) - order.indexOf(rarityB);
            });
            const sortedStarters = {};
            sortedKeys.forEach(key => {
                sortedStarters[key] = STARTERS[key];
            });
            return sortedStarters;
        };

        const MODES = { 
            survival: { name: "Survie", icon: "üßü", desc: "Vagues infinies.", ranked: false }, 
            ranked: { name: "Class√©", icon: "üèÜ", desc: "Comp√©tition.", ranked: true }, 
            duel: { name: "1v1 Duel", icon: "‚öîÔ∏è", desc: "Duel Bot IA.", ranked: false, boss: true }, 
            heist: { name: "Braquage", icon: "üíé", desc: "D√©truis le coffre!", ranked: false, boss: true }, 
            boss_rush: { name: "Boss Rush", icon: "üëπ", desc: "Combat de Boss.", ranked: false, boss: true }, 
            defense: { name: "D√©fense", icon: "üõ°Ô∏è", desc: "Prot√®ge le cristal.", ranked: false, boss: true }, 
            infection: { name: "Infection", icon: "‚ò£Ô∏è", desc: "Survivre √† la horde.", ranked: false }, 
            train_defense: { name: "Train Express", icon: "üöÇ", desc: "Prot√®ge le train !", ranked: false }, 
            thief: { name: "Voleur", icon: "üí∞", desc: "Vole 10 sacs !", ranked: false },
            cyber_hack: { name: "Cyber Hack", icon: "üíª", desc: "Pirate les zones !", ranked: false, special: true },
            gungame: { name: "Jeu d'Armes", icon: "üî´", desc: "Change d'arme √† chaque kill !", ranked: false, special: false },
            escape: { name: "Cyber Escape", icon: "üõ∏", desc: "Rejoins l'extraction !", ranked: false, special: false },
            rampage: { name: "Carnage", icon: "üò°", desc: "Tuer 50 ennemis !", ranked: false, special: false },
            zone_control: { name: "Zone", icon: "‚≠ï", desc: "Contr√¥le la zone !", ranked: false, special: false },
            treasure: { name: "Chasse", icon: "üëë", desc: "Trouve les tr√©sors !", ranked: false, special: false },
            sniper_duel: { name: "Duel Sniper", icon: "üî≠", desc: "Tir de pr√©cision.", ranked: false },
            giant_hunt: { name: "Chasse G√©ant", icon: "üëπ", desc: "Abattez le colosse.", ranked: false },
            golden_chase: { name: "Ru√©e vers l'Or", icon: "üí∞", desc: "Collecte max !", ranked: false },
            infection_hard: { name: "Infection +", icon: "üßü‚Äç‚ôÇÔ∏è", desc: "Survivre √† l'enfer.", ranked: false },
            speed_run: { name: "Speed Run", icon: "‚ö°", desc: "Extraction Rapide.", ranked: false },
            team_battle: { name: "Team Battle", icon: "üõ°Ô∏è", desc: "4 vs 4 !", ranked: false },
            ctf: { name: "Capture Drapeau", icon: "üö©", desc: "Vole le drapeau !", ranked: false },
            payload: { name: "Convoi", icon: "üöÉ", desc: "Pousse le wagon !", ranked: false },
            royale: { name: "Battle Royale", icon: "üöÅ", desc: "Survivre √† la zone !", ranked: false }
        };
        const ARENAS = { 
            tokyo: { name: "Neon Tokyo", color: '#050b14', grid: 'rgba(59,130,246,0.15)', wall: '#1e293b' }, 
            sand: { name: "Sandstorm", color: '#271a0c', grid: 'rgba(245,158,11,0.15)', wall: '#451a03' }, 
            ice: { name: "Ice Age", color: '#082f49', grid: 'rgba(255,255,255,0.1)', wall: '#164e63' }, 
            jungle: { name: "Jungle", color: '#064e3b', grid: 'rgba(34,197,94,0.2)', wall: '#052e16' }, 
            magma: { name: "Magma", color: '#450a0a', grid: 'rgba(239,68,68,0.2)', wall: '#280505' }, 
            ruins: { name: "Ruines", color: '#292524', grid: 'rgba(168,162,158,0.1)', wall: '#44403c' }, 
            cyber_city: { name: "Cyber City", color: '#0f172a', grid: 'rgba(6,182,212,0.2)', wall: '#164e63' }, 
            nebula: { name: "N√©buleuse", color: '#1e1b4b', grid: 'rgba(232, 121, 249, 0.2)', wall: '#312e81' },
            mainframe: { name: "Mainframe", color: '#022c22', grid: 'rgba(34, 211, 238, 0.3)', wall: '#134e4a', special: true },
            moon: { name: "Moon Base", color: '#1e293b', grid: 'rgba(148, 163, 184, 0.1)', wall: '#334155' },
            crystal: { name: "Cristal", color: '#2e1065', grid: 'rgba(167, 139, 250, 0.2)', wall: '#4c1d95', special: false },
            solaris: { name: "Solaris", color: '#451a03', grid: 'rgba(251, 146, 60, 0.2)', wall: '#7c2d12', special: false },
            swamp: { name: "Marais", color: '#222d1d', grid: 'rgba(132, 204, 22, 0.2)', wall: '#1a1f16' },
            factory: { name: "Usine", color: '#332e2b', grid: 'rgba(249, 115, 22, 0.2)', wall: '#292524' },
            void: { name: "N√©ant", color: '#000000', grid: 'rgba(255, 255, 255, 0.05)', wall: '#171717', special: false },
            atlantis: { name: "Atlantis", color: '#083344', grid: 'rgba(6, 182, 212, 0.2)', wall: '#155e75', special: false },
            dungeon: { name: "Donjon", color: '#1c1917', grid: 'rgba(120, 113, 108, 0.2)', wall: '#292524', special: false },
            reactor: { name: "R√©acteur", color: '#1a202c', grid: 'rgba(132, 204, 22, 0.2)', wall: '#365314', special: false }
        };
        
        const CLUBS = [
            { id: 'c1', name: "Elite Cyber", tag: "ELITE", members: 28, max: 30, trophies: 15400, desc: "Les meilleurs.", open: false, icon: "üëë" },
            { id: 'c2', name: "Mathias Team", tag: "DEV", members: 5, max: 30, trophies: 0, desc: "Club officiel.", open: true, icon: "‚öîÔ∏è" },
            { id: 'c3', name: "Noob Slayers", tag: "KILL", members: 12, max: 30, trophies: 4500, desc: "Fun only.", open: true, icon: "üíÄ" },
            { id: 'c4', name: "Golden Boys", tag: "GOLD", members: 29, max: 30, trophies: 25000, desc: "Rich ppl.", open: false, icon: "üíé" },
            { id: 'c5', name: "Neon City", tag: "NEON", members: 18, max: 30, trophies: 8900, desc: "Cyberpunk Vibe.", open: true, icon: "üåÜ" }
        ];

        const RANKS = [{n:"BRONZE I", t:0, c:"#cd7f32"}, {n:"BRONZE II", t:100, c:"#cd7f32"}, {n:"BRONZE III", t:200, c:"#cd7f32"}, {n:"SILVER I", t:300, c:"#c0c0c0"}, {n:"SILVER II", t:500, c:"#c0c0c0"}, {n:"SILVER III", t:700, c:"#c0c0c0"}, {n:"GOLD I", t:1000, c:"#ffd700"}, {n:"GOLD II", t:1300, c:"#ffd700"}, {n:"GOLD III", t:1600, c:"#ffd700"}, {n:"PLATINUM I", t:2000, c:"#22d3ee"}, {n:"PLATINUM II", t:2500, c:"#22d3ee"}, {n:"DIAMOND", t:3500, c:"#a855f7"}, {n:"mMASTER", t:5000, c:"#ef4444"}];
        
        // NOUVELLE GRANDE LISTE D'IC√îNES POUR PLUS DE CHOIX (160+)
        const ICONS = ["üë§","ü§ñ","üëΩ","ü¶Å","ü¶Ñ","üíÄ","‚öîÔ∏è","üíé","üëë","üéÆ","üöÄ","üî•","‚ùÑÔ∏è","‚ö°","üåü","üê±","üê∂","ü¶ä","üê∏","üêµ","üêº","üê®","üêØ","üêô","ü¶ñ","üëª","üí©","ü§°","üëπ","üë∫","üéÉ","ü¶æ","üß†","üëÄ","üí•","üíØ","ü•∂","ü•µ","ü§†","ü•∏","ü§ë", "ü•∑", "üßô", "üß™", "ü¶†", "üß¨", "üíæ", "‚öôÔ∏è", "üí°", "üì°", "üõ∏", "üëæ", "üêâ", "üê∫", "ü¶â", "ü¶ã", "üçÑ", "üå∑", "üå≤", "üåä", "üåã", "üèñÔ∏è", "üåÉ", "üèôÔ∏è", "üèõÔ∏è", "üß±", "üèÆ", "‚õ©Ô∏è", "üèØ", "üóº", "üóΩ", "üîî", "üé∂", "üé§", "üé∏", "üéß", "üïπÔ∏è", "üéØ", "üé≤", "üé±", "üèÄ", "‚öΩ", "üèà", "‚öæ", "üéæ", "ü•ä", "ü•ã", "ü•á", "ü•à", "ü•â", "üéâ", "üéà", "üéÅ", "üßß", "üéÄ", "üì¶", "‚úâÔ∏è", "üîë", "üóùÔ∏è", "üî®", "üõ†Ô∏è", "ü™ì", "üî´", "üèπ", "üõ°Ô∏è", "‚ö∞Ô∏è", "‚ö±Ô∏è", "üëë", "üîÆ", "ü™Ñ", "üîë", "üõ°Ô∏è", "üî•", "üíß", "üåç", "‚ú®", "üí´", "üåë", "‚òÄÔ∏è", "üåô", "‚≠ê", "üåà", "‚òÑÔ∏è", "üí•", "‚ö°", "üå©Ô∏è", "‚òî", "üå™Ô∏è", "üí®", "üçÇ", "üçÅ", "üçè", "üçé", "üçê", "üçä", "üçã", "üçå", "üçâ", "üçá", "üçì", "üçà", "üçí", "üçë", "üçç", "ü••", "ü•ù", "ü•≠", "üçÖ", "üçÜ", "üå∂Ô∏è", "üåΩ", "ü•ï", "ü•î", "üç†", "ü•ê", "üçû", "ü•ñ", "ü•®", "ü•û", "üßá", "üßÄ", "ü•ö", "üç≥", "ü•ì", "ü•©", "üçó", "üçñ", "üçî", "üçü", "üçï", "üå≠", "ü•™", "üåÆ", "üåØ", "ü•ô", "üßÜ", "ü•ó", "ü•ò", "üç≤", "üçù", "üçú", "üç£", "üç§", "üç•", "üç°", "ü•†", "ü•°", "üçö", "üçõ", "üçó", "üç£", "üç§", "üç•", "üç°", "ü•†", "ü•°", "üçö", "üçõ"];
        
        const EMOTE_LIST = [
            {id:'happy', i:'üòÄ', price: 0}, {id:'angry', i:'üò°', price: 0}, {id:'gg', i:'üëç', price: 0}, {id:'rip', i:'üíÄ', price: 0},
            {id:'love', i:'üòç', price: 15}, {id:'clown', i:'ü§°', price: 15}, {id:'fire', i:'üî•', price: 25}, {id:'crown', i:'üëë', price: 45},
            {id:'ghost', i:'üëª', price: 25}, {id:'robot', i:'ü§ñ', price: 25}, {id:'flex', i:'üí™', price: 15}, {id:'cry', i:'üò≠', price: 15},
            {id:'cool', i:'üòé', price: 15}, {id:'party', i:'ü•≥', price: 15}, {id:'sleeping', i:'üò¥', price: 5}, {id:'devil', i:'üòà', price: 25},
            {id:'money', i:'ü§ë', price: 35}, {id:'sick', i:'ü§¢', price: 5}, {id:'shhh', i:'ü§´', price: 10}, {id:'think', i:'ü§î', price: 10},
            {id:'dab', i:'üôÖ', price: 95}, {id:'rich', i:'üí∏', price: 195}, {id:'hacker', i:'üíª', price: 145}, {id:'cat', i:'üôÄ', price: 115},
            {id:'alien', i:'üëΩ', price: 20}, {id:'nerd', i:'ü§ì', price: 10}, {id:'rage', i:'ü§¨', price: 30}, {id:'mindblown', i:'ü§Ø', price: 25},
            {id:'scream', i:'üò±', price: 15}, {id:'star', i:'ü§©', price: 20}, {id:'cowboy', i:'ü§†', price: 25}, {id:'mask', i:'üò∑', price: 5},
            {id:'ice', i:'ü•∂', price: 25}, {id:'boxe', i:'ü•ä', price: 30}, {id:'zen', i:'üßò', price: 10}, {id:'dice', i:'üé≤', price: 15},
            // NEW 1.1.2
            {id:'zipper', i:'ü§ê', price: 10}, {id:'melting', i:'ü´†', price: 20}, {id:'salute', i:'ü´°', price: 25}, {id:'peeking', i:'ü´£', price: 20},
            {id:'diagonal', i:'üòµ‚Äçüí´', price: 25}, {id:'ninja', i:'ü•∑', price: 80}, {id:'king', i:'ü§¥', price: 50}, {id:'zombie', i:'üßü', price: 30},
            {id:'brain', i:'üß†', price: 40}, {id:'rockon', i:'ü§ò', price: 20}, {id:'poop', i:'üí©', price: 5}, {id:'chicken', i:'üêî', price: 35},
            {id:'dragon', i:'üê≤', price: 100}, {id:'unicorn', i:'ü¶Ñ', price: 90}, {id:'ufo', i:'üõ∏', price: 60},
            // NEW 1.1.5
            {id:'hamburger', i:'üçî', price: 20}, {id:'pizza', i:'üçï', price: 20}, {id:'fries', i:'üçü', price: 15}, {id:'hotdog', i:'üå≠', price: 15},
            {id:'popcorn', i:'üçø', price: 10}, {id:'donut', i:'üç©', price: 15}, {id:'cookie', i:'üç™', price: 10}, {id:'beer', i:'üç∫', price: 30},
            {id:'cheers', i:'üçª', price: 40}, {id:'wine', i:'üç∑', price: 35}, {id:'cocktail', i:'üçπ', price: 35}, {id:'tropical', i:'üèùÔ∏è', price: 50},
            {id:'sun', i:'‚òÄÔ∏è', price: 10}, {id:'cloud', i:'‚òÅÔ∏è', price: 5}, {id:'rain', i:'üåßÔ∏è', price: 15}, {id:'snow', i:'‚ùÑÔ∏è', price: 20},
            {id:'umbrella', i:'‚òÇÔ∏è', price: 15}, {id:'rainbow', i:'üåà', price: 40}, {id:'soccer', i:'‚öΩ', price: 25}, {id:'basketball', i:'üèÄ', price: 25},
            {id:'tennis', i:'üéæ', price: 25}, {id:'baseball', i:'‚öæ', price: 25}, {id:'trophy', i:'üèÜ', price: 100}, {id:'medal', i:'ü•á', price: 50},
            {id:'gamer', i:'üéÆ', price: 30}, {id:'music', i:'üéµ', price: 15},
            // NEW 1.2.0 - 100 EMOTES UPDATE
            {id:'mouse', i:'üê≠', price: 10}, {id:'hamster', i:'üêπ', price: 10}, {id:'rabbit', i:'üê∞', price: 15}, {id:'fox', i:'ü¶ä', price: 20},
            {id:'bear', i:'üêª', price: 20}, {id:'panda', i:'üêº', price: 25}, {id:'koala', i:'üê®', price: 25}, {id:'tiger', i:'üêØ', price: 30},
            {id:'lion', i:'ü¶Å', price: 30}, {id:'cow', i:'üêÆ', price: 15}, {id:'pig', i:'üê∑', price: 15}, {id:'frog', i:'üê∏', price: 10},
            {id:'monkey', i:'üêµ', price: 20}, {id:'penguin', i:'üêß', price: 30}, {id:'bird', i:'üê¶', price: 10}, {id:'chick', i:'üê•', price: 10},
            {id:'duck', i:'ü¶Ü', price: 15}, {id:'eagle', i:'ü¶Ö', price: 40}, {id:'owl', i:'ü¶â', price: 30}, {id:'bat', i:'ü¶á', price: 20},
            {id:'wolf', i:'üê∫', price: 35}, {id:'boar', i:'üêó', price: 25}, {id:'horse', i:'üê¥', price: 20}, {id:'bomb', i:'üí£', price: 25},
            {id:'dagger', i:'üó°Ô∏è', price: 35}, {id:'shield', i:'üõ°Ô∏è', price: 20}, {id:'potion', i:'üß™', price: 15}, {id:'map', i:'üó∫Ô∏è', price: 10},
            {id:'compass', i:'üß≠', price: 15}, {id:'anchor', i:'‚öì', price: 20}, {id:'rocket', i:'üöÄ', price: 50}, {id:'ship', i:'üö¢', price: 40},
            {id:'car', i:'üöó', price: 20}, {id:'bus', i:'üöå', price: 20}, {id:'police', i:'üöì', price: 25}, {id:'taxi', i:'üöï', price: 20},
            {id:'bicycle', i:'üö≤', price: 10}, {id:'broken', i:'üíî', price: 5}, {id:'heartfire', i:'‚ù§Ô∏è‚Äçüî•', price: 30}, {id:'sparkle', i:'‚ú®', price: 25},
            {id:'cyclone', i:'üåÄ', price: 35}, {id:'fog', i:'üå´Ô∏è', price: 10}, {id:'zap', i:'‚ö°', price: 20}, {id:'extinguisher', i:'üßØ', price: 15},
            {id:'moai', i:'üóø', price: 50}, {id:'peach', i:'üçë', price: 10}, {id:'eggplant', i:'üçÜ', price: 10}, {id:'cherries', i:'üçí', price: 10}
        ];
        // Sort emotes by price
        EMOTE_LIST.sort((a, b) => a.price - b.price);

        const DIFFICULTY = {
            easy: { name: 'Facile', mult: 0.8, color: 'text-green-400' }, // Feature 2: Score Multiplier adjusted
            normal: { name: 'Normal', mult: 1.0, color: 'text-blue-400' },
            hard: { name: 'Difficile', mult: 1.5, color: 'text-red-400' },
            expert: { name: 'Expert', mult: 2.0, color: 'text-purple-600' }
        };

        // NEW MODIFIERS
        const MODIFIERS = {
            normal: { name: 'Classique', color: 'text-gray-300' },
            oneshot: { name: 'One Shot', color: 'text-red-500' },
            poison: { name: 'Poison', color: 'text-green-500' },
            speed: { name: 'Speed', color: 'text-yellow-500' },
            vampire: { name: 'Vampire', color: 'text-pink-500' },
            infinite: { name: 'Infini', color: 'text-blue-400' },
            explosive: { name: 'Explosif', color: 'text-orange-500' },
            recoil: { name: 'Recul', color: 'text-white' },
            giant: { name: 'G√©ant', color: 'text-purple-600' },
            low_grav: { name: 'Gravity', color: 'text-indigo-400' },
            double_dmg: { name: 'Double D√©g√¢ts', color: 'text-red-600' },
            tiny: { name: 'Tiny', color: 'text-xs text-blue-300' },
            pluie: { name: 'Pluie Balles', color: 'text-cyan-400' },
            no_regen: { name: 'No Regen', color: 'text-gray-500' },
            fragile: { name: 'Fragile', color: 'text-red-300' },
            blind: { name: 'Aveugle', color: 'text-gray-500' },
            slow_mo: { name: 'Slow Mo', color: 'text-blue-300' },
            chaos: { name: 'Chaos', color: 'text-purple-500' }
        };

        const CURRENT_VERSION_KEY = 'mBattle_Data_v1_4_8';
        const PREVIOUS_KEYS = ['mBattle_Data_v1_4_4', 'mBattle_Data_v1_4_3', 'mBattle_Data_v1_4_2', 'mBattle_Data_v1_4_1', 'mBattle_Data_v1_4_0', 'mBattle_Data_v1_3_5', 'mBattle_Data_v1_3', 'mBattle_Data_v1_2_9', 'mBattle_Data_v1_2_8', 'mBattle_Data_v1_2_7', 'mBattle_Data_v1_2_5', 'mBattle_Data_v1_2_4', 'mBattle_Data_v1_2_1', 'mBattle_Data_v1_1_5', 'mBattle_Data_v1_1_4', 'mBattle_Data_v1_1_3', 'mBattle_Data_v1_1_2', 'mBattle_Data_v1_1_0', 'mBattle_Data_v1_0_6', 'mBattle_Data_v1_0', 'mBattle_Data_v1_0_5', 'mBattle_Data_v20', 'mBattle_Data_v19', 'mBattle_Data_v18', 'mBattle_Data_v17', 'mBattle_Data_v16'];
        let USER = {
            name: "Joueur", avatar: "üë§", tag: "#" + Math.random().toString(36).substr(2, 6).toUpperCase(),
            coins: 500, gems: 10, trophies: 0, unlocked: ['soldier', 'drone'], levels: { soldier: 1, drone: 1 }, selected: 'soldier',
            stats: { kills: 0, maxWave: 0, games: 0, wins: 0, dmg: 0, losses: 0, maxPassTier: 1 },
            lastDaily: 0,
            pass: { tier: 1, xp: 0, claimed: [], claimedPro: [] },
            shop: { lastRefresh: 0, items: [] },
            emotes: ['happy', 'angry', 'gg', 'rip'], equippedEmotes: ['happy', 'angry', 'gg', 'rip'],
            mPassPro: false,
            skins: {}, 
            ownedSkins: [],
            quests: { daily: [], season: [], club: [], lastGenerated: 0, lastClubGenerated: 0 },
            // V1.4.0 Features
            friends: [], // [{ name, avatar, status }]
            bio: "Aucune bio d√©finie...", email: "", phone: "", dob: "", theme: "blue",
            claimedRanks: [],
            club: null, // { name: "Alpha", role: "Member", messages: [] }
            mastery: {}, // { soldier: { xp: 0, lvl: 1 } }
            adventures: {}, // { soldier: 1 } (Chapter unlocked)
            maps: [], // Custom maps { name: "My Map", data: ... }
            weaponSkins: {}, // { soldier: 'gold_gun' }
            settings: { sound: true, music: true }
        };

        const PERKS = [
            { name: "Puissance", icon: "üí™", desc: "D√©g√¢ts +10%", fn: (p) => { p.stats.dmg *= 1.1; window.ui.notif("D√âG√ÇTS UP!", "#ef4444"); } },
            { name: "Vitalit√©", icon: "‚ù§Ô∏è", desc: "Sant√© +20%", fn: (p) => { const add = p.maxHp * 0.2; p.maxHp += add; p.hp += add; window.ui.notif("SANT√â UP!", "#22c55e"); } },
            { name: "Agilit√©", icon: "‚ö°", desc: "Vitesse +10%", fn: (p) => { p.stats.spd *= 1.1; window.ui.notif("VITESSE UP!", "#facc15"); } },
            { name: "Recharge", icon: "üîÑ", desc: "Recharge -10%", fn: (p) => { p.stats.reload *= 0.9; window.ui.notif("RECHARGE UP!", "#3b82f6"); } },
            { name: "Furie", icon: "üî´", desc: "Cadence +10%", fn: (p) => { p.stats.rate *= 0.9; window.ui.notif("CADENCE UP!", "#f97316"); } },
            { name: "Chargeur", icon: "üì¶", desc: "Munitions +1", fn: (p) => { p.ammoMax += 1; p.ammo += 1; window.ui.notif("MUNITIONS UP!", "#a855f7"); } }
        ];

        const QuestSystem = {
            generateDaily() {
                const now = Date.now();
                if (now - USER.quests.lastGenerated > 86400000) { // 24h
                    USER.quests.daily = [];
                    USER.quests.lastGenerated = now;
                    // Generate 5 to 7 random quests
                    const count = 5 + Math.floor(Math.random() * 3);
                    const modeKeys = Object.keys(MODES).filter(k => !MODES[k].boss && !MODES[k].special);
                    const heroKeys = Object.keys(STARTERS);

                    for(let i=0; i<count; i++) {
                        const type = Math.random();
                        let q = { id: Math.random().toString(36).substr(2, 9), progress: 0, completed: false, claimed: false };
                        
                        if (type < 0.15) { 
                            const m = modeKeys[Math.floor(Math.random() * modeKeys.length)];
                            q.type = 'play'; q.mode = m; q.target = 3; q.desc = `Jouer 3 parties en ${MODES[m].name}`; q.reward = { type: 'xp', val: 150 };
                        } else if (type < 0.30) {
                            const arenaKeys = Object.keys(ARENAS);
                            const a = arenaKeys[Math.floor(Math.random() * arenaKeys.length)];
                            q.type = 'play'; q.arena = a; q.target = 3; q.desc = `Jouer 3 parties sur ${ARENAS[a].name}`; q.reward = { type: 'xp', val: 150 };
                        } else if (type < 0.45) { 
                            q.type = 'kill'; q.target = 50 + Math.floor(Math.random()*50); q.desc = `√âliminer ${q.target} ennemis`; q.reward = { type: 'coins', val: 200 };
                        } else if (type < 0.55) { 
                            q.type = 'xp'; q.target = 500 + Math.floor(Math.random()*500); q.desc = `Gagner ${q.target} XP`; q.reward = { type: 'xp', val: 150 };
                        } else if (type < 0.70) {
                            const h = heroKeys[Math.floor(Math.random() * heroKeys.length)];
                            q.type = 'play'; q.hero = h; q.target = 2; q.desc = `Jouer 2 parties avec ${STARTERS[h].name}`; q.reward = { type: 'gems', val: 5 };
                        } else if (type < 0.85) {
                            const amount = 5000 + Math.floor(Math.random() * 10000);
                            q.type = 'dmg'; q.target = amount; q.desc = `Infliger ${amount} d√©g√¢ts`; q.reward = { type: 'coins', val: 250 };
                        } else if (type < 0.93) {
                            q.type = 'collect'; q.target = 10; q.itemType = 'coins'; q.desc = "Ramasser 10 tas de pi√®ces"; q.reward = { type: 'coins', val: 300 };
                        } else {
                            q.type = 'win'; q.target = 1; q.desc = "Gagner 1 partie"; q.reward = { type: 'box', val: 1 };
                        }
                        USER.quests.daily.push(q);
                    }
                    Storage.save();
                }
            },
            generateClub() {
                const now = Date.now();
                if (!USER.club) return;
                
                // Initialize club quests if missing
                if (!USER.quests.club) USER.quests.club = [];
                
                if (USER.club && (USER.quests.club.length === 0 || now - (USER.quests.lastClubGenerated || 0) > 86400000)) {
                    USER.quests.club = [];
                    USER.quests.lastClubGenerated = now;
                    // Generate 3 random club quests
                    for(let i=0; i<3; i++) {
                        const type = Math.random();
                        let q = { id: 'c'+Math.random().toString(36).substr(2, 9), progress: 0, completed: false, claimed: false };
                        
                        // Club Quests are harder but give more
                        if (type < 0.3) { 
                            q.type = 'play'; q.mode = 'team_battle'; q.target = 5; q.desc = `Jouer 5 Team Battle avec le Club`; q.reward = { type: 'xp', val: 300 };
                        } else if (type < 0.6) {
                            q.type = 'win'; q.target = 3; q.desc = "Gagner 3 parties pour le Club"; q.reward = { type: 'coins', val: 500 };
                        } else {
                            const amount = 20000;
                            q.type = 'dmg'; q.target = amount; q.desc = `Infliger ${amount} d√©g√¢ts (Club)`; q.reward = { type: 'gems', val: 10 };
                        }
                        USER.quests.club.push(q);
                    }
                    Storage.save();
                }
            },
            generateSeason() {
                if (!USER.quests.season || USER.quests.season.length < 10) { // Force update if not enough quests
                   // Existing quests preservation could be done here, but simpler to reset/init for this "Saison 2" update
                   USER.quests.season = [
                       { id: 's2_q1', type: 'play', arena: 'crystal', target: 5, progress: 0, completed: false, claimed: false, desc: "Jouer 5 parties Grotte de Cristal", reward: { type: 'xp', val: 500 } },
                       { id: 's2_q2', type: 'play', mode: 'cyber_hack', target: 5, progress: 0, completed: false, claimed: false, desc: "Jouer 5 parties Cyber Hack", reward: { type: 'gems', val: 20 } },
                       { id: 's2_q3', type: 'kill', target: 500, progress: 0, completed: false, claimed: false, desc: "√âliminer 500 ennemis (Total)", reward: { type: 'coins', val: 2000 } },
                       { id: 's2_q4', type: 'dmg', target: 100000, progress: 0, completed: false, claimed: false, desc: "Infliger 100k D√©g√¢ts", reward: { type: 'mega_caisse_loot', val: 1 } },
                       { id: 's2_q5', type: 'win', target: 10, progress: 0, completed: false, claimed: false, desc: "Gagner 10 parties", reward: { type: 'gems', val: 50 } },
                       { id: 's2_q6', type: 'play', hero: 'drone', target: 3, progress: 0, completed: false, claimed: false, desc: "Jouer 3 fois avec Drone", reward: { type: 'xp', val: 300 } },
                       { id: 's2_q7', type: 'play', hero: 'soldier', target: 3, progress: 0, completed: false, claimed: false, desc: "Jouer 3 fois avec Soldier", reward: { type: 'xp', val: 300 } },
                       { id: 's2_q8', type: 'collect', itemType: 'gems', target: 50, progress: 0, completed: false, claimed: false, desc: "R√©cup√©rer 50 Gemmes au sol", reward: { type: 'skin', val: 1, name: 'Skin Al√©atoire' } },
                       { id: 's2_q9', type: 'survive', target: 10, progress: 0, completed: false, claimed: false, desc: "Survivre Vague 10 (Survie)", reward: { type: 'box', val: 2 } },
                       { id: 's2_q10', type: 'play', mode: 'heist', target: 5, progress: 0, completed: false, claimed: false, desc: "Jouer 5 parties Braquage", reward: { type: 'xp', val: 400 } },
                       { id: 's2_q11', type: 'kill', target: 1000, progress: 0, completed: false, claimed: false, desc: "Tueur en s√©rie (1000 Kills)", reward: { type: 'gems', val: 100 } },
                       { id: 's2_q12', type: 'xp', target: 5000, progress: 0, completed: false, claimed: false, desc: "Gagner 5000 XP", reward: { type: 'coins', val: 5000 } },
                       { id: 's2_q13', type: 'play', mode: 'ranked', target: 10, progress: 0, completed: false, claimed: false, desc: "Jouer 10 parties Class√©es", reward: { type: 'mega_caisse_loot', val: 2 } },
                       { id: 's2_q14', type: 'play', mode: 'boss_rush', target: 3, progress: 0, completed: false, claimed: false, desc: "Survivre 3 Boss Rush", reward: { type: 'gems', val: 30 } },
                       { id: 's2_q15', type: 'play', hero: 'tank', target: 5, progress: 0, completed: false, claimed: false, desc: "Jouer 5 fois avec Heavy", reward: { type: 'xp', val: 500 } },
                       { id: 's2_q16', type: 'dmg', target: 500000, progress: 0, completed: false, claimed: false, desc: "D√©g√¢ts Massifs (500k)", reward: { type: 'gems', val: 150 } },
                       { id: 's2_q17', type: 'collect', itemType: 'coins', target: 100, progress: 0, completed: false, claimed: false, desc: "Riche: 100 tas de pi√®ces", reward: { type: 'xp', val: 800 } },
                       { id: 's2_q18', type: 'play', arena: 'moon', target: 5, progress: 0, completed: false, claimed: false, desc: "Mission Lunaire (5 parties)", reward: { type: 'box', val: 3 } },
                       { id: 's2_q19', type: 'play', mode: 'infection', target: 5, progress: 0, completed: false, claimed: false, desc: "Survivre √† l'infection (5 fois)", reward: { type: 'coin', val: 1000 } },
                       { id: 's2_q20', type: 'win', target: 50, progress: 0, completed: false, claimed: false, desc: "Gagner 50 parties", reward: { type: 'skin', val: 1, name: 'Skin √âpique' } },
                       { id: 's2_q21', type: 'kill', target: 100, progress: 0, completed: false, claimed: false, desc: "Chasseur : 100 Kills", reward: { type: 'xp', val: 200 } },
                       { id: 's2_q22', type: 'play', mode: 'rampage', target: 3, progress: 0, completed: false, claimed: false, desc: "Faire 3 Carnages", reward: { type: 'coins', val: 500 } },
                       { id: 's2_q23', type: 'play', mode: 'zone_control', target: 3, progress: 0, completed: false, claimed: false, desc: "Contr√¥ler la zone 3 fois", reward: { type: 'gems', val: 15 } },
                       // Add more static quests here as requested by "beaucoup plus de qu√™tes"
                   ];
                   
                   // Ensure loaded quests for existing users are merged if we really wanted, 
                   // but hard reset for season update is cleaner to ensure they see the new ones.
                   Storage.save();
                }
            },
            check(type, data) {
                let changed = false;
                const checkList = (list) => {
                    list.forEach(q => {
                        if (q.completed) return;
                        let match = false;
                        if (q.type === type) {
                            if (q.type === 'play') {
                                if (q.mode && q.mode !== data.mode) return;
                                if (q.arena && q.arena !== data.arena) return;
                                if (q.hero && q.hero !== data.hero) return;
                                match = true;
                            } else if (q.type === 'kill') {
                                match = true;
                            } else if (q.type === 'xp') {
                                match = true;
                            } else if (q.type === 'dmg') {
                                match = true;
                            } else if (q.type === 'collect') {
                                if (q.itemType && q.itemType !== data.itemType) return;
                                match = true;
                            } else if (q.type === 'win') {
                                if (q.mode && q.mode !== data.mode) return;
                                if (q.arena && q.arena !== data.arena) return;
                                match = true;
                            } else if (q.type === 'survive') {
                                if (data.wave >= q.target) { q.progress = q.target; match = true; } // Direct completion for survive wave X
                            }
                        }
                        if (match) {
                            if (type === 'xp' || type === 'dmg' || type === 'collect') q.progress += data.amount || 1; 
                            else if(type !== 'survive') q.progress++;
                            
                            if (q.progress >= q.target) { q.progress = q.target; q.completed = true; window.ui.notif("QU√äTE TERMIN√âE !", "#22c55e", "quest"); }
                            changed = true;
                        }
                    });
                };
                if (USER.quests) { 
                    checkList(USER.quests.daily); 
                    checkList(USER.quests.season);
                    if(USER.quests.club) checkList(USER.quests.club);
                }
                if (changed) Storage.save();
            },
            claim(listType, id) {
                const list = USER.quests[listType];
                const q = list.find(x => x.id === id);
                if (q && q.completed && !q.claimed) {
                    q.claimed = true;
                    if (q.reward.type === 'xp') {
                        USER.pass.xp += q.reward.val; window.ui.notif(`+${q.reward.val} XP`, "#22c55e");
                        while(USER.pass.xp >= 100) { if(USER.pass.tier < 50) { USER.pass.tier++; USER.pass.xp -= 100; window.ui.notif("PASS LEVEL UP!", "#facc15"); } else { USER.pass.xp = 100; break; } }
                    } else if (q.reward.type === 'coins') { USER.coins += q.reward.val; window.ui.notif(`+${q.reward.val} ü™ô`, "#eab308"); } 
                    else if (q.reward.type === 'gems') { USER.gems += q.reward.val; window.ui.notif(`+${q.reward.val} üíé`, "#a855f7"); }
                    else if (q.reward.type === 'box') { window.ui.buy('box', 0, 'free'); }
                    else if (q.reward.type === 'mega_caisse_loot') { openLootCrate(); }
                    else if (q.reward.type === 'skin') {
                        // R√©compense Skin Al√©atoire
                        const keys = Object.keys(STARTERS);
                        const candidates = [];
                        keys.forEach(k => {
                            if(STARTERS[k].skins) STARTERS[k].skins.forEach(s => {
                                if(!USER.ownedSkins.includes(`${k}_${s.id}`)) candidates.push({h: k, s: s});
                            });
                        });
                        
                        if(candidates.length > 0) {
                            const win = candidates[Math.floor(Math.random() * candidates.length)];
                            USER.ownedSkins.push(`${win.h}_${win.s.id}`);
                            window.ui.notif(`SKIN D√âBLOQU√â: ${win.s.name} (${STARTERS[win.h].name})`, "#facc15");
                        } else {
                            USER.gems += 50; window.ui.notif("TOUS SKINS POSS√âD√âS -> +50 üíé", "#a855f7");
                        }
                    }
                    Storage.save(); window.ui.renderProfile(); window.ui.updateMenu();
                }
            },
            refreshDaily() {
                if (USER.gems >= 10) {
                    console.log("[SECURE] Daily Quests Refresh (-10 gems)");
                    USER.gems -= 10;
                    USER.quests.lastGenerated = 0; // Force regen
                    this.generateDaily();
                    Storage.save();
                    window.ui.renderProfile();
                    window.ui.updateMenu();
                    window.ui.notif("-10 üíé QU√äTES ACTUALIS√âES", "#a855f7");
                } else {
                    window.ui.notif("PAS ASSEZ DE GEMMES (10 üíé)", "#ef4444");
                }
            },
            hasQuest(type, filter) {
                if(!USER.quests) return false;
                const all = [...USER.quests.daily, ...USER.quests.season];
                return all.some(q => {
                   if(q.completed || q.claimed) return false;
                   if(q.type !== type) return false;
                   if(filter) {
                       for(let k in filter) {
                           if(q[k] !== filter[k]) return false;
                       }
                   }
                   return true;
                });
            }
        };
        window.QuestSystem = QuestSystem;

        // MISE √Ä JOUR : Remplacement des skins mPass par des caisses
        const PASS_REWARDS = {
            1: { free: 'coins:100', pro: 'mega_caisse_loot:1', max: 'gems:50' },
            5: { free: 'emote:hacker', pro: 'gems:50', max: 'box:3' },
            10: { free: 'box:1', pro: 'mega_caisse_loot:1', max: 'gems:100' },
            15: { free: 'coins:200', pro: 'emote:alien', max: 'coins:2000' },
            20: { free: 'box:1', pro: 'gems:100', max: 'mega_caisse_loot:1' },
            30: { free: 'box:1', pro: 'emote:mindblown', max: 'gems:150' },
            40: { free: 'coins:500', pro: 'coins:1000', max: 'mega_caisse_loot:2' },
            50: { free: 'box:1', pro: 'gems:300', max: 'gems:400' },
            60: { free: 'coins:1000', pro: 'coins:2000', max: 'mega_caisse_loot:3' },
            70: { free: 'box:2', pro: 'gems:150', max: 'gems:250' },
            80: { free: 'coins:2000', pro: 'coins:4000', max: 'mega_caisse_loot:4' },
            90: { free: 'box:3', pro: 'emote:moai', max: 'gems:500' },
            100: { free: 'mega_caisse_loot:1', pro: 'gems:500', max: 'mega_caisse_loot:10' } 
        };

        const getPassReward = (tier, type) => { 
            const r = PASS_REWARDS[tier];
            if (r && r[type]) return r[type];
            if (type === 'max') return (tier % 5 === 0) ? 'gems:30' : 'coins:200';
            if (type === 'pro') return (tier % 5 === 0) ? 'mega_caisse_loot:1' : 'gems:15';
            return (tier % 3 === 0) ? 'gems:5' : 'coins:50';
        };

        const Storage = {
            save() { localStorage.setItem(CURRENT_VERSION_KEY, JSON.stringify(USER)); },
            load() {
                // Check migration
                let d = localStorage.getItem(CURRENT_VERSION_KEY);
                let isMigration = false;
                
                if (!d) {
                    // Try to find old data
                    for (let key of PREVIOUS_KEYS) {
                        const oldData = localStorage.getItem(key);
                        if (oldData) {
                            d = oldData;
                            isMigration = true; // Found old data, so it's a migration
                            break;
                        }
                    }
                }

                if (d) {
                    try {
                        const saved = JSON.parse(d);
                        USER = { ...USER, ...saved,
                            stats: { ...USER.stats, ...(saved.stats||{}), losses: saved.stats?.losses || 0, maxPassTier: saved.stats?.maxPassTier || 1 },
                            pass: isMigration ? { tier: 1, xp: 0, claimed: [], claimedPro: [], claimedMax: [] } : { ...USER.pass, ...(saved.pass||{}) },
                            shop: { ...USER.shop, ...(saved.shop||{}) },
                            levels: { ...USER.levels, ...(saved.levels||{}) },
                            emotes: saved.emotes || ['happy', 'angry', 'gg', 'rip'],
                            equippedEmotes: saved.equippedEmotes || ['happy', 'angry', 'gg', 'rip'],
                            mPassPro: saved.mPassPro || false, mPassMax: saved.mPassMax || false,
                            skins: saved.skins || {},
                            ownedSkins: saved.ownedSkins || [],
                            quests: { daily: [], season: [], club: [], lastGenerated: 0, lastClubGenerated: 0, ...(saved.quests || {}) },
                            friends: saved.friends || [],
                            claimedRanks: saved.claimedRanks || []
                        };
                        
                        // Ensure new free hero is unlocked
                        if(!USER.unlocked.includes('drone')) USER.unlocked.push('drone');
                        
                        if (typeof window.game !== 'undefined') {
                            if(!window.game.conf) window.game.conf = {};
                            if(!saved.conf || !saved.conf.difficulty) window.game.conf.difficulty = 'normal';
                            else window.game.conf.difficulty = saved.conf.difficulty;
                            if(!saved.conf || !saved.conf.modifier) window.game.conf.modifier = 'normal';
                            else window.game.conf.modifier = saved.conf.modifier;
                            if(!saved.conf || typeof saved.conf.bots === 'undefined') window.game.conf.bots = 0;
                            else window.game.conf.bots = saved.conf.bots;
                        }
                        
                        this.save();
                        
                    } catch (e) {
                         console.error("Erreur de chargement des donn√©es:", e);
                    }
                } else {
                    // Brand new user
                    // Initialisation des nouvelles stats pour les nouveaux utilisateurs
                    USER.stats.losses = 0;
                    USER.stats.maxPassTier = 1;
                }
                QuestSystem.generateDaily();
                QuestSystem.generateSeason();
                QuestSystem.generateClub();
                window.ui.refreshShop();
            }
        };

        const Rnd = (min,max) => Math.random()*(max-min)+min;
        const Dist = (e1,e2) => Math.hypot(e1.x-e2.x, e1.y-e2.y);
        function ColRect(c, r) { return c.x+c.r > r.x && c.x-c.r < r.x+r.w && c.y+c.r > r.y && c.y-c.r < r.y+r.h; }
        
        // Fonction de collision plus subtile, √©vitant de repousser les objets statiques
        function resolveCollision(e1, e2) {
            let dx=e1.x-e2.x, dy=e1.y-e2.y; let dist=Math.hypot(dx,dy); const minDist=e1.r+e2.r;
            if(dist < minDist) {
                if(dist <= 0.01) { dx=1; dy=0; dist=1; }
                const overlap=minDist-dist, nx=dx/dist, ny=dy/dist;
                
                // V√©rifier si l'une des entit√©s est le joueur et l'autre un mur ou un bot
                const isPlayer = e1 === window.game.player || e2 === window.game.player;
                
                // Masse invers√©e: entit√©s statiques (chest/core/train/terminal) ont masse infinie (1 / Infinity = 0)
                const isStatic1 = (e1.type==='chest' || e1.type==='core' || e1.type==='train' || e1.type==='terminal');
                const isStatic2 = (e2.type==='chest' || e2.type==='core' || e2.type==='train' || e2.type==='terminal');
                
                let m1 = isStatic1 ? 0 : (e1 === window.game.player ? 1 : 0.5); // Player mass 1, Bot mass 0.5
                let m2 = isStatic2 ? 0 : (e2 === window.game.player ? 1 : 0.5); 
                
                const totalMass = m1 + m2;
                
                let ratio1 = m2 / totalMass; 
                let ratio2 = m1 / totalMass; 
                
                if (isStatic1 && !isStatic2) { ratio1 = 0; ratio2 = 1; }
                else if (!isStatic1 && isStatic2) { ratio1 = 1; ratio2 = 0; }
                else if (isStatic1 && isStatic2) { return; } 

                // FIX ANTI-PUSH REWORK: Player Heavy, Bots Light
                const isPlayer1 = e1 === window.game.player;
                const isPlayer2 = e2 === window.game.player;
                
                if (isPlayer1 && !isStatic2 && (e2.isBot || (!e2.isBoss && e2.type !== 'train'))) { 
                    ratio1 = 0.1; ratio2 = 0.9; // Player pushes bot/enemy
                } else if (isPlayer2 && !isStatic1 && (e1.isBot || (!e1.isBoss && e1.type !== 'train'))) {
                    ratio1 = 0.9; ratio2 = 0.1; // Bot/enemy bounces off player
                } else if (e1 === window.game.player && isStatic2) { ratio1 = 1; ratio2 = 0; } 
                else if (e2 === window.game.player && isStatic1) { ratio1 = 0; ratio2 = 1; }


                e1.x += nx * overlap * ratio1;
                e1.y += ny * overlap * ratio1;
                e2.x -= nx * overlap * ratio2;
                e2.y -= ny * overlap * ratio2;
            }
        }
        const getGadgetName = (g) => { 
            const map = { 'heal': 'Soin (+1000)', 'shield': 'Bouclier (+1000)', 'teleport': 'TP', 'dash': 'Dash Feu', 'speed': 'Turbo', 'knockback': 'Choc', 'stun': '√âtourdissant', 'turret': 'Tourelle', 'invis': 'Invisibilit√©' }; // Feature 8
            return map[g] || g.toUpperCase(); 
        }

        const el = (id) => document.getElementById(id);
        const setStyle = (id, prop, val) => { const e=el(id); if(e) e.style[prop]=val; };
        const setText = (id, txt) => { const e=el(id); if(e) e.innerText=txt; };
        
        // NOUVELLE FONCTION : Gestion de l'ouverture de caisse √† gros butin
        function openLootCrate() {
            let rewards = [];
            let totalValue = 0;
            const pulls = 7; // Feature 3: Mega caisse plus g√©n√©reuse (7 pulls au lieu de 5)

            for (let i = 0; i < pulls; i++) {
                const r = Math.random();
                let type, value, color, icon;

                if (r < 0.5) { // 50% chance: Coins
                    value = 150 + Math.floor(Math.random() * 250);
                    USER.coins += value;
                    type = 'Pi√®ces'; icon = 'ü™ô'; color = '#eab308';
                    totalValue += value;
                } else if (r < 0.85) { // 35% chance: Gems
                    value = 7 + Math.floor(Math.random() * 13);
                    USER.gems += value;
                    type = 'Gemmes'; icon = 'üíé'; color = '#a855f7';
                    totalValue += value * 50; // Estimer la valeur
                } else { // 15% chance: XP Boost
                    value = 150;
                    USER.pass.xp += value;
                    type = 'XP Pass'; icon = 'üé´'; color = '#22d3ee';
                    totalValue += value * 2;
                }
                rewards.push({ icon, value, type });
            }

            // Traitement de l'XP
            while(USER.pass.xp >= 100) {
                if(USER.pass.tier < 50) {
                    USER.pass.tier++;
                    USER.pass.xp -= 100;
                    window.ui.notif("PASS LEVEL UP!", "#facc15");
                } else {
                    USER.pass.xp = 100;
                    break;
                }
            }
            
            // Affichage des r√©compenses
            let message = rewards.map(r => `${r.icon} +${r.value} ${r.type}`).join(', ');
            window.ui.notif(`BUTIN DE LA CAISSE : ${message}`, '#facc15');
            Storage.save();
            window.ui.updateMenu();
            window.ui.renderPass();
        }

        function processPassReward(rewardString) {
            const [type, value] = rewardString.split(':');
            const val = parseInt(value) || 1;
            let success = false;
            
            // SECURITY CHECK
            console.log(`[SECURE] Processing Reward: ${type} x${val}`);

            if (type === 'coins') {
                USER.coins += val;
                Storage.save();
                window.ui.updateMenu();
                window.ui.notif(`+${val} ü™ô`, "#eab308", "reward");
                try { el('top-coins').closest('.currency-badge').classList.add('flash-coins'); setTimeout(() => el('top-coins').closest('.currency-badge').classList.remove('flash-coins'), 300); } catch(e){}
                success = true;
            } else if (type === 'gems') {
                USER.gems += val;
                Storage.save();
                window.ui.updateMenu();
                window.ui.notif(`+${val} üíé`, "#a855f7", "reward");
                try { el('top-gems').closest('.currency-badge').classList.add('flash-gems'); setTimeout(() => el('top-gems').closest('.currency-badge').classList.remove('flash-gems'), 300); } catch(e){}
                success = true;
            } else if (type === 'box') {
                for(let i=0; i<val; i++) window.ui.buy('box', 0, 'free');
                success = true;
            } else if (type === 'mega_caisse_loot') { // NOUVEAU TYPE DE BUTIN
                for(let i=0; i<val; i++) openLootCrate();
                success = true;
            } else if (type.startsWith('emote')) {
                const emoteId = type.split(':')[1];
                if (!USER.emotes.includes(emoteId)) {
                    USER.emotes.push(emoteId);
                    window.ui.notif(`EMOTE D√âBLOQU√âE: ${EMOTE_LIST.find(e => e.id === emoteId)?.i}`, "#22d3ee");
                    window.ui.renderEmotes();
                }
                success = true;
            } else if (type.startsWith('skin')) {
                const [heroId, skinId] = type.split(':')[1].split('_');
                const fullSkinId = `${heroId}_${skinId}`;
                if (!USER.ownedSkins.includes(fullSkinId)) {
                    USER.ownedSkins.push(fullSkinId);
                    const skinName = STARTERS[heroId]?.skins.find(s => s.id === skinId)?.name || 'Skin';
                    window.ui.notif(`SKIN D√âBLOQU√â: ${skinName}!`, "#facc15");
                    window.ui.renderLists(); // Pour mettre √† jour la s√©lection de skin
                }
                success = true;
            }
            return success;
        }



        window.ui = {
            showIntro() {
                const el = document.getElementById('intro-screen');
                if(el) {
                    el.classList.remove('hidden');
                    el.style.opacity = 1;
                    // Flashy effect
                    document.querySelector('.intro-text').classList.add('animate-pulse');
                    if(SoundManager) setTimeout(()=>SoundManager.play('start_game'), 500);
                    el.onclick = () => this.closeIntro();
                    setTimeout(() => this.closeIntro(), 3500);
                }
            },
            closeIntro() {
                const el = document.getElementById('intro-screen');
                if(el) {
                    el.style.opacity = 0;
                    setTimeout(() => el.classList.add('hidden'), 1000);
                }
            },
             search(context, query) {
                 query = query.toLowerCase();
                 // Call specific render functions with filter
                 if(context === 'starters') this.renderStarters(query);
                 if(context === 'adventures') this.renderAdventures(query);
                 if(context === 'clubs') this.renderClubs(query);
                 if(context === 'emotes') this.renderEmotes(query);
                 if(context === 'friends') this.renderFriends(query);
                 if(context === 'quests') this.renderQuests(query);
             },

            hud() {
                if(!window.game.player) return; const p = window.game.player;

                const hpBar = el('hud-hp-bar');
                if (hpBar) {
                    // Supprime les classes de transition pour un effet instantan√©
                    hpBar.classList.remove('transition-all', 'duration-75'); 
                    hpBar.style.width = (p.hp/p.maxHp*100)+'%';
                }
                

                setText('hud-lvl', 'LVL ' + p.lvl);

                setText('hud-score', window.game.score); setText('hud-sub', MODES[window.game.conf.mode].name.toUpperCase());
                if(window.game.conf.mode !== 'survival' && window.game.conf.mode !== 'ranked' && window.game.conf.mode !== 'infection' && window.game.conf.mode !== 'duel') {
                    const min = Math.floor(window.game.timeLeft / 3600); const sec = Math.floor((window.game.timeLeft % 3600) / 60);
                    const te = el('hud-timer'); if(te) { te.innerText = (min < 10 ? "0"+min : min) + ":" + (sec < 10 ? "0"+sec : sec); te.classList.remove('hidden'); }
                } else { const te = el('hud-timer'); if(te) te.classList.add('hidden'); }
                if(window.game.conf.mode === 'thief') {
                    el('hud-objective').innerText = `Sacs: ${window.game.lootCollected}/10`;
                    el('hud-objective').classList.remove('hidden');
                } else if(window.game.conf.mode === 'cyber_hack') {
                    el('hud-objective').innerText = `Hack: ${Math.floor(window.game.hackProgress)}%`;
                    el('hud-objective').classList.remove('hidden');
                } else if(window.game.conf.mode === 'escape') {
                    const exit = window.game.ents.find(e => e.type === 'exit');
                    if(exit) {
                         const dist = Math.floor(Dist(window.game.player, exit) / 10);
                         el('hud-objective').innerText = `Extraction: ${dist}m`;
                         el('hud-objective').classList.remove('hidden');
                    }
                } else if(window.game.conf.mode === 'rampage') {
                    el('hud-objective').innerText = `Kills: ${window.game.killCount}/50`;
                    el('hud-objective').classList.remove('hidden');
                } else if(window.game.conf.mode === 'zone_control') {
                    el('hud-objective').innerText = `Zone: ${Math.floor(window.game.zoneProgress)}%`;
                    el('hud-objective').classList.remove('hidden');
                } else if(window.game.conf.mode === 'team_battle' || window.game.conf.mode === 'ctf') {
                    if(window.game.teamScore === undefined) window.game.teamScore = 0;
                    if(window.game.enemyScore === undefined) window.game.enemyScore = 0;
                    const icon = window.game.conf.mode === 'ctf' ? 'üö©' : 'üîµ';
                    const icon2 = window.game.conf.mode === 'ctf' ? 'üö©' : 'üî¥';
                    el('hud-objective').innerHTML = `<span class="text-blue-400">${icon} ${window.game.teamScore}</span> - <span class="text-red-400">${icon2} ${window.game.enemyScore}</span>`;
                    el('hud-objective').classList.remove('hidden');
                } else if(window.game.conf.mode === 'royale') {
                    const survivors = window.game.ents.filter(e => e.isBot && !e.dead).length + 1;
                    el('hud-objective').innerText = `SURVIVANTS: ${survivors}`;
                    el('hud-objective').classList.remove('hidden');
                } else {
                    el('hud-objective').classList.add('hidden');
                }
                for(let i=1; i<=3; i++) setStyle('ammo-'+i, 'opacity', i <= Math.floor(p.ammo) ? 1 : 0.3);
                setStyle('dash-cd', 'height', Math.max(0,p.dashT/60*100)+'%');
                setText('gadget-count', p.gadgetCharges);
                const gb=el('btn-gadget'); if(gb) { gb.disabled = p.gadgetCharges<=0; if(p.gadgetCharges<=0)gb.classList.add('opacity-50');else gb.classList.remove('opacity-50'); }
                
                // Check for terminal in boss UI check
                const boss=window.game.ents.find(e=>e.isBoss||e.isBot||e.type==='core'||e.type==='train'||e.type==='terminal'); const bui=el('boss-ui');
                if(boss && bui){
                    bui.classList.remove('hidden');
                    // Update label logic for terminal
                    let label = boss.isBot ? "RIVAL" : (boss.type==='chest'?"COFFRE":(boss.type==='core'?"CRISTAL":(boss.type==='train'?"TRAIN":(boss.type==='terminal'?"TERMINAL":"BOSS"))));
                    setText('boss-name', label);
                    setStyle('boss-bar', 'width', (boss.hp/boss.maxHp*100)+'%'); setText('boss-pct', Math.ceil(boss.hp/boss.maxHp*100)+'%');
                    const bar = el('boss-bar');
                    // Use blue bar for friendly/neutral objectives (core, train, terminal)
                    if(boss.type==='core' || boss.type==='train' || boss.type==='terminal') { bar.classList.remove('bg-gradient-to-r', 'from-red-600', 'to-red-500'); bar.style.backgroundColor = '#3b82f6'; }
                    else { bar.classList.add('bg-gradient-to-r', 'from-red-600', 'to-red-500'); bar.style.backgroundColor = ''; }
                } else if(bui) bui.classList.add('hidden');
                setStyle('gas-overlay', 'opacity', 0);
                
                // Blind Modifier Effect
                const mod = window.game.activeModifier || window.game.conf.modifier;
                if(mod === 'blind') {
                    const v = el('vignette'); if (v) v.style.background = 'radial-gradient(circle, transparent 15%, #000 70%)';
                } else {
                    const v = el('vignette'); if (v) v.style.background = '';
                }
            },
            notif(m,c, type='default') { 
                const d=document.createElement('div'); 
                let classes = 'text-sm font-bold backdrop-blur-md shadow-xl border px-4 py-2 rounded-lg transform transition-all duration-500 translate-y-4 opacity-0 flex items-center gap-3';
                
                if(type==='quest') {
                    classes += ' bg-gradient-to-r from-green-900/90 to-emerald-900/90 border-emerald-500/50 text-white font-tech tracking-wider uppercase pr-6';
                    d.innerHTML = `<div class="text-2xl animate-bounce">‚ú®</div><div><div class="text-[10px] text-green-300">MISSION ACCOMPLIE</div><div class="text-lg text-white font-black italic">${m}</div></div>`;
                } else if(type==='reward') {
                    classes += ' bg-gradient-to-r from-yellow-600/90 to-amber-800/90 border-yellow-300 text-white font-black tracking-widest uppercase py-3 px-8 text-lg shadow-[0_0_40px_rgba(234,179,8,0.5)] border-2 backdrop-blur-xl scale-110 flex-col gap-0 min-w-[200px] justify-center';
                    d.innerHTML = `<div class="text-3xl animate-bounce filter drop-shadow-lg mb-1">üéÅ</div><div class="text-yellow-100 drop-shadow-md">${m}</div>`;
                } else if(type==='streak') {
                    classes += ' bg-gradient-to-r from-purple-600/90 to-pink-600/90 border-purple-400 text-white font-black italic tracking-widest uppercase py-4 px-10 text-2xl shadow-[0_0_50px_rgba(168,85,247,0.8)] border-y-4 backdrop-blur-xl scale-125 z-50';
                    d.innerHTML = `<div class="animate-pulse filter drop-shadow-[0_0_10px_white]">${m}</div>`;
                } else if(type==='warn') {
                    classes += ' bg-red-900/80 border-red-500 text-white';
                    d.innerText = m;
                } else {
                    classes += ' bg-black/70 border-white/20 text-white';
                    d.style.color = c || 'white';
                    d.innerText = m;
                }
                
                d.className = classes; 
                el('notif-area').appendChild(d); 
                
                requestAnimationFrame(()=>{ d.classList.remove('translate-y-4', 'opacity-0'); });
                
                setTimeout(()=>{
                    d.classList.add('opacity-0', '-translate-y-4');
                    setTimeout(()=>d.remove(), 500);
                }, type==='quest' ? 4000 : (type==='streak' ? 2500 : 2000)); 
            },
            showStreak(n) {
                const streaks = {
                    2: "DOUBLE KILL !",
                    3: "TRIPLE KILL !",
                    4: "QUADRA KILL !",
                    5: "PENTA KILL !",
                    6: "HEXA KILL !",
                    7: "RAMPAGE !",
                    8: "UNSTOPPABLE !",
                    9: "DOMINATING !",
                    10: "GODLIKE !"
                };
                if(streaks[n] || n > 10) {
                    const msg = streaks[n] || `X${n} STREAK !`;
                    this.notif(msg, null, 'streak');
                    // Add screen shake and flash
                    window.game.shake = 5 + n;
                    window.ui.flash();
                }
            },
            flash() { setStyle('flash-layer', 'opacity', 0.6); setTimeout(()=>setStyle('flash-layer', 'opacity', 0), 100); },
            feed(k,v,g) { const d=document.createElement('div'); d.className=`kill-msg ${g?'':'red'}`; d.innerHTML=`<span class="${g?'text-blue-400':'text-red-400'}">${k}</span> ‚ò†Ô∏è ${v}`; const c=el('kill-feed'); if(c){ c.prepend(d); if(c.children.length>4)c.lastChild.remove(); } setTimeout(()=>d.remove(),4000); },
            levelUp() { 
                if(SoundManager) SoundManager.play('levelup');
                const s=el('levelup-screen'), c=el('perk-container'); c.innerHTML=''; s.classList.remove('hidden'); 
                PERKS.sort(()=>0.5-Math.random()).slice(0,3).forEach(p=>{ 
                    const b=document.createElement('button'); 
                    b.className='glass-panel p-5 text-left flex items-center gap-5 active:scale-95 transition-all duration-300 cursor-pointer group hover:border-yellow-400/50 hover:shadow-[0_0_20px_rgba(250,204,21,0.2)] w-full relative overflow-hidden'; 
                    b.innerHTML=`<div class="absolute inset-0 bg-yellow-400/5 opacity-0 group-hover:opacity-100 transition duration-500"></div><div class="text-4xl filter drop-shadow-lg group-hover:scale-110 transition duration-300 relative z-10">${p.icon}</div><div class="relative z-10"><div class="font-black font-tech text-yellow-400 text-xl tracking-wide group-hover:text-yellow-300 transition">${p.name.toUpperCase()}</div><div class="text-sm text-gray-300 font-bold">${p.desc}</div></div>`; 
                    b.onclick=()=>{p.fn(window.game.player); s.classList.add('hidden'); window.game.state='PLAYING';}; 
                    c.appendChild(b); 
                }); 
            },
            drawMinimap() { const cvs = el('minimap'); if(!cvs) return; const ctx = cvs.getContext('2d'); const scale = cvs.width / window.game.world; ctx.clearRect(0, 0, cvs.width, cvs.height);
                (window.game.ents||[]).forEach(e => { if(e.hidden)return; ctx.fillStyle = (e.isBoss || e.isBot) ? '#ef4444' : (e.type==='core'||e.type==='train'||e.type==='terminal'?'#3b82f6':'#f87171'); const r = (e.isBoss || e.isBot || e.type==='core' || e.type==='train' || e.type==='terminal') ? 4 : 2; ctx.beginPath(); ctx.arc(e.x * scale, e.y * scale, r, 0, Math.PI * 2); ctx.fill(); });
                (window.game.map||[]).forEach(w => { if(w.type === 1) ctx.fillStyle = 'rgba(34, 197, 94, 0.8)'; else if(w.type === 3) ctx.fillStyle = '#d97706'; else ctx.fillStyle = 'rgba(255,255,255,0.4)'; ctx.fillRect(w.x * scale, w.y * scale, w.w * scale, w.h * scale); });
            },
            openTrophyRoad() {
                el('trophy-road-modal').classList.remove('hidden');
                const c = el('trophy-list'); c.innerHTML = '';
                const maxTrophies = RANKS[RANKS.length-1].t;
                const pct = Math.min(100, (USER.trophies / maxTrophies) * 100);    
                
                c.innerHTML += `<div class="glass-panel p-5 mb-4 bg-gradient-to-r from-cyan-900/40 to-purple-900/40 border border-white/10 shadow-[0_0_15px_rgba(34,211,238,0.2)]">
                    <div class="flex justify-between mb-2 text-xs font-black tracking-widest text-cyan-400"><span>PROGRESSION</span><span class="text-white">${USER.trophies} / ${maxTrophies} üèÜ</span></div>
                    <div class="h-3 bg-black/50 rounded-full overflow-hidden border border-white/5 relative">
                        <div class="absolute inset-0 bg-white/5 animate-pulse"></div>
                        <div class="h-full bg-gradient-to-r from-cyan-400 to-purple-500 shadow-[0_0_10px_rgba(56,189,248,0.5)] transition-all duration-1000" style="width:${pct}%"></div>
                    </div>
                </div>`;
                
                RANKS.forEach((r, i) => {
                    if(i === 0) return; // Skip base rank
                    
                    const reached = USER.trophies >= r.t;
                    const claimed = USER.claimedRanks && USER.claimedRanks.includes(i);
                    const isNext = !reached && USER.trophies >= RANKS[i-1].t;
                    
                    // Dynamic Style based on Rank Color
                    let bgStyle = reached 
                        ? `background: linear-gradient(90deg, ${r.c}22, transparent); border-color: ${r.c}66;` 
                        : `background: rgba(0,0,0,0.3); border-color: rgba(255,255,255,0.05);`;
                    
                    if(isNext) bgStyle = `background: linear-gradient(90deg, ${r.c}15, transparent); border-color: ${r.c}55; box-shadow: 0 0 20px ${r.c}15;`;

                    let btn = '';
                    if(claimed) btn = `<div class="text-green-400 font-bold text-[10px] flex items-center gap-1 bg-green-900/20 px-3 py-1.5 rounded-lg border border-green-500/30 shadow-[0_0_10px_rgba(34,197,94,0.1)]">‚úÖ R√âCUP√âR√â</div>`;
                    else if(reached) btn = `<button onclick="window.ui.claimRankReward(${i})" class="bg-gradient-to-r from-yellow-500 to-amber-600 hover:scale-105 transition text-black font-black py-2 px-5 rounded-lg animate-pulse text-xs shadow-[0_0_20px_rgba(234,179,8,0.5)] border border-yellow-400/50 flex items-center gap-2"><span class="text-lg">üéÅ</span> R√âCUP√âRER</button>`;
                    else btn = `<div class="text-gray-500 font-bold text-[10px] bg-black/40 px-3 py-1.5 rounded-lg border border-white/5 flex items-center gap-2 opacity-50"><span class="text-xs">üîí</span> ${r.t} üèÜ</div>`;
                    
                    c.innerHTML += `<div class="glass-panel p-4 flex items-center justify-between border-l-4 transition-all duration-300 group hover:translate-x-1 mb-2 relative overflow-hidden ${reached ? '' : 'grayscale opacity-60 hover:opacity-100 hover:grayscale-0'}" style="${bgStyle} border-left-color: ${r.c};">
                        ${isNext ? `<div class="absolute inset-0 bg-white/5 animate-pulse pointer-events-none"></div>` : ''}
                        <div class="flex items-center gap-4 relative z-10">
                            <div class="w-14 h-14 rounded-xl bg-black/40 flex items-center justify-center text-3xl shadow-[inset_0_0_10px_rgba(0,0,0,0.5)] border border-white/10 group-hover:scale-110 transition duration-300" style="text-shadow: 0 0 15px ${r.c}">üèÜ</div>
                            <div>
                                <div class="font-black text-sm tracking-widest mb-1 uppercase" style="color:${r.c}; text-shadow: 0 0 15px ${r.c}50">${r.n}</div>
                                <div class="text-[10px] text-gray-400 flex gap-2 font-bold items-center">
                                    <div class="flex items-center gap-1 bg-black/30 px-2 py-0.5 rounded text-yellow-400 border border-yellow-500/10"><span class="text-xs">ü™ô</span> 1000</div>
                                    <div class="flex items-center gap-1 bg-black/30 px-2 py-0.5 rounded text-purple-400 border border-purple-500/10"><span class="text-xs">üíé</span> 25</div>
                                </div>
                            </div>
                        </div>
                        <div class="relative z-10 pl-2">${btn}</div>
                    </div>`;
                });
            },
            claimRankReward(i) {
                if(USER.trophies >= RANKS[i].t && (!USER.claimedRanks || !USER.claimedRanks.includes(i))) {
                    console.log(`[SECURE] Claim Rank Reward: ${i}`);
                    if(!USER.claimedRanks) USER.claimedRanks = [];
                    USER.claimedRanks.push(i);
                    USER.coins += 1000;
                    USER.gems += 25;
                    this.notif("R√âCOMPENSE DE RANG R√âCUP√âR√âE !", "#facc15");
                    try { el('top-coins').closest('.currency-badge').classList.add('flash-coins'); setTimeout(() => el('top-coins').closest('.currency-badge').classList.remove('flash-coins'), 300); } catch(e){}
                    try { el('top-gems').closest('.currency-badge').classList.add('flash-gems'); setTimeout(() => el('top-gems').closest('.currency-badge').classList.remove('flash-gems'), 300); } catch(e){}
                    Storage.save();
                    this.openTrophyRoad();
                    this.updateMenu();
                }
            },
            showTab(id) { 
                if(SoundManager) SoundManager.play('ui');
                document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden')); 
                document.getElementById('tab-' + id).classList.remove('hidden'); 
                document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active', 'selected')); 
                const btn = document.getElementById('nav-' + id); 
                if(btn) btn.classList.add('active', 'selected'); 
                
                if(id === 'starters' || id === 'modes') this.renderLists(); 
                if(id === 'infos') this.updateStats(); 
                if(id === 'pass') this.renderPass(); 
                if(id === 'shop') this.renderShop(); 
                if(id === 'profile') this.renderProfile(); 
                if(id === 'emotes') this.renderEmotes(); 
                if(id === 'play') { this.updateDifficultyButtons(); this.renderBotSelector(); } 
                if(id === 'adventures') this.renderAdventures();
                if(id === 'clubs') this.renderClubs();
                if(id === 'friends') this.renderFriends();
                if(id === 'quests') this.renderQuests();
                
                this.updateMenu(); // Force menu refresh
            },
            startMapMaker() { MapMaker.init(); },
            renderAdventures(filter='') {
                const c = document.getElementById('adventure-list');
                if(!c) return;
                c.innerHTML = '';
                
                // Header Visual Improved
                c.innerHTML += `<div class="glass-panel p-8 mb-8 relative overflow-hidden text-center bg-gradient-to-r from-blue-900/60 to-purple-900/60 border-blue-500/40 shadow-2xl rounded-3xl group">
                    <div class="absolute inset-0 bg-[url('https://cdn.tailwindcss.com/img/beams.png')] bg-cover opacity-20 animate-pulse group-hover:opacity-30 transition"></div>
                    <div class="relative z-10 scale-100 group-hover:scale-105 transition duration-500">
                        <h2 class="text-4xl md:text-5xl font-black italic tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400 mb-3 drop-shadow-[0_0_15px_rgba(34,211,238,0.5)]">MODE AVENTURE</h2>
                        <p class="text-sm md:text-base text-gray-300 font-bold uppercase tracking-[0.2em] mb-4">D√©couvre l'histoire des h√©ros & Gagne des skins</p>
                        <div class="h-1 w-24 bg-gradient-to-r from-transparent via-cyan-500 to-transparent mx-auto"></div>
                    </div>
                </div>`;

                // CHALLENGE DU JOUR (NOUVEAU)
                c.innerHTML += `<div class="glass-panel p-6 mb-6 flex justify-between items-center border border-yellow-500/30 bg-yellow-900/10">
                    <div>
                        <div class="text-xs font-bold text-yellow-500 uppercase tracking-widest mb-1">üî• CHALLENGE DU JOUR</div>
                        <div class="text-lg font-black text-white italic">SURVIVRE 10 MIN (MODE SURVIE)</div>
                        <div class="text-xs text-gray-400">R√©compense : 1 Caisse</div>
                    </div>
                    <button onclick="window.ui.notif('Challenge lanc√© !', '#facc15'); window.game.setMode('survival'); window.ui.showTab('play'); window.game.start();" class="bg-yellow-600 hover:bg-yellow-500 text-black font-black px-6 py-3 rounded-xl shadow-lg shadow-yellow-900/40 animate-pulse">GO ‚ñ∂</button>
                </div>`;

                c.innerHTML += `<div class="grid grid-cols-1 gap-8 pb-10">`;

                Object.keys(ADVENTURES).forEach(k => {
                   const adv = ADVENTURES[k];
                   if(filter && !adv.title.toLowerCase().includes(filter) && !adv.desc.toLowerCase().includes(filter)) return;

                   const hero = STARTERS[k];
                   if(!hero) return; 
                   const progress = (USER.adventures && USER.adventures[k]) ? USER.adventures[k] : { part: 0 };
                   const totalParts = adv.parts.length;
                   const pct = Math.floor((progress.part / totalParts) * 100);
                   const isComplete = progress.part >= totalParts;
                   
                   // New MO.CO Style Card: Big, Visual, Chapters list
                   let chaptersHtml = '';
                   adv.parts.forEach((p, idx) => {
                       let stateIcon = 'üîí';
                       let stateClass = 'opacity-40 grayscale';
                       if(idx < progress.part) { stateIcon = '‚úÖ'; stateClass = 'text-green-400'; }
                       else if(idx === progress.part) { stateIcon = '‚ñ∂'; stateClass = 'text-white bg-white/10 rounded px-2'; }
                       
                       // Only show a few chapters (current + next few) or summary
                       if(idx >= progress.part - 1 && idx <= progress.part + 2) {
                           let typeIcon = p.type==='battle'?'‚öîÔ∏è':(p.type==='story'?'üìú':'üéÅ');
                           let desc = p.type === 'story' ? 'Chapitre Histoire' : (p.type==='battle'? (MODES[p.mode] ? MODES[p.mode].name : p.mode) : 'R√©compense');
                           chaptersHtml += `<div class="flex items-center gap-3 text-xs mb-1 ${stateClass}">
                               <span class="w-4">${stateIcon}</span>
                               <span class="opacity-70">${typeIcon}</span>
                               <span class="truncate max-w-[200px]">${desc}</span>
                           </div>`;
                       }
                   });

                   c.innerHTML += `<div class="glass-panel p-0 flex flex-col md:flex-row relative overflow-hidden group hover:scale-[1.01] transition-all duration-300 border-0 shadow-[0_10px_40px_rgba(0,0,0,0.5)] bg-black/40 rounded-3xl border-t border-white/10">
                       <div class="absolute inset-0 bg-gradient-to-r from-black/80 via-black/50 to-transparent z-10 pointer-events-none"></div>
                       
                       <!-- Background Image / Gradient -->
                       <div class="absolute inset-0 z-0 opacity-40 group-hover:opacity-60 transition duration-700" style="background:${adv.bg || adv.color}"></div>
                       
                       <!-- Left Side: Hero Art -->
                       <div class="relative z-20 w-full md:w-1/3 min-h-[200px] flex items-center justify-center overflow-hidden">
                            <div class="text-9xl filter drop-shadow-[0_0_30px_rgba(0,0,0,0.5)] transform group-hover:scale-110 group-hover:-rotate-3 transition duration-500">${hero.icon}</div>
                            ${isComplete ? '<div class="absolute top-4 left-4 bg-green-500 text-black font-black text-xs px-3 py-1 rounded shadow-lg">COMPLET 100%</div>' : ''}
                       </div>
                       
                       <!-- Right Side: Info & Actions -->
                       <div class="relative z-20 flex-1 p-6 flex flex-col justify-center bg-black/30 backdrop-blur-sm border-l border-white/5">
                           <div class="flex justify-between items-start mb-2">
                               <div>
                                   <div class="text-5xl font-black italic text-white/5 absolute -top-4 right-0 pointer-events-none select-none">${k.toUpperCase()}</div>
                                   <h3 class="font-black font-tech text-3xl uppercase text-white mb-1 leading-none drop-shadow-md italic tracking-wide" style="text-shadow: 0 0 20px ${adv.color}88;">${adv.title}</h3>
                                   <div class="h-1 w-12 rounded bg-white/20 mb-3"></div>
                               </div>
                               <div class="text-right">
                                   <div class="text-2xl font-black" style="color:${adv.color}">${pct}%</div>
                               </div>
                           </div>
                           
                           <p class="text-sm text-gray-300 font-medium mb-4 italic border-l-2 pl-3 py-1" style="border-color:${adv.color}">${adv.desc}</p>
                           
                           <!-- Progress Bar -->
                           <div class="w-full h-3 bg-gray-900/80 rounded-full overflow-hidden border border-white/10 mb-4 relative">
                                <div class="absolute inset-0 bg-white/5 animate-pulse"></div>
                                <div class="h-full shadow-[0_0_15px_currentColor]" style="width:${pct}%; background:${adv.color}"></div>
                           </div>
                           
                           <!-- Chapters Preview -->
                           <div class="mb-5 pl-2 border-l border-white/10">
                               ${chaptersHtml}
                               ${totalParts - progress.part > 3 ? `<div class="text-[10px] text-gray-500 italic pl-6">+ ${totalParts - progress.part - 3} √©tapes...</div>` : ''}
                           </div>
                           
                           <button class="w-full glass-btn py-4 rounded-xl text-lg font-black tracking-widest uppercase hover:brightness-125 transition border border-white/20 relative overflow-hidden group/btn" 
                                style="background:linear-gradient(90deg, ${adv.color}66, ${adv.color}33)"
                                onclick="window.ui.startAdventure('${k}')">
                                <span class="relative z-10 flex items-center justify-center gap-2">
                                    ${isComplete ? 'REJOUER L\'HISTOIRE ‚Ü∫' : (progress.part===0 ? 'COMMENCER L\'AVENTURE ‚ñ∂' : 'CONTINUER L\'AVENTURE ‚è©')}
                                </span>
                                <div class="absolute inset-0 bg-white/20 translate-y-full group-hover/btn:translate-y-0 transition duration-300"></div>
                           </button>
                       </div>
                   </div>`;
                });
                c.innerHTML += `</div>`;
            },
            startAdventure(id) {
                this.playStory(id);
            },
            playStory(id) {
                const adv = ADVENTURES[id];
                if(!USER.adventures) USER.adventures = {};
                let partIdx = (USER.adventures[id]?.part || 0);
                if(partIdx >= adv.parts.length) { 
                    this.notif("AVENTURE TERMIN√âE !", "#22c55e"); 
                    // Reset for replayability?
                    if(confirm("Rejouer l'histoire ?")) { USER.adventures[id].part = 0; this.playStory(id); }
                    return; 
                }
                const part = adv.parts[partIdx];
                
                    if(part.type === 'story') {
                        // Show Story Modal with typing animation
                        const m = document.createElement('div');
                        m.id = 'story-modal';
                        m.className = 'fixed inset-0 z-[60] bg-black/95 flex flex-col items-center justify-center p-8 text-center';
                        m.innerHTML = `<div id="story-text" style="white-space: pre-wrap;" class="text-xl md:text-3xl text-white font-tech font-bold leading-relaxed mb-8 max-w-2xl"></div><button id="story-next" class="hidden glass-btn px-8 py-3 text-xl animate-pulse">CONTINUER ‚ûú</button>`;
                        document.body.appendChild(m);
                        
                        let i = 0;
                        const txt = part.text;
                        if(SoundManager) SoundManager.play('ui');
                        
                        const interval = setInterval(() => {
                            document.getElementById('story-text').textContent += txt[i];
                            i++;
                            if(i >= txt.length) {
                                clearInterval(interval);
                                const btn = document.getElementById('story-next');
                                btn.classList.remove('hidden');
                                btn.onclick = () => {
                                   m.remove();
                                   this.completeAdventurePart(id);
                                };
                            }
                        }, 30);
                } else if (part.type === 'battle') {
                    // BEFORE: alert(`MISSION : ${part.desc}`); this.completeAdventurePart(id);
                    // AFTER: Start actual game with adventure context
                    window.game.adventure = { id: id, partIdx: partIdx, target: part.target, mode: part.mode, item: part.item };
                    window.game.conf.mode = part.mode;
                    
                    // Special config based on adventure settings
                    if(part.mode === 'duel') { window.game.conf.bots = 0; } 
                    else if(part.mode === 'survival') { window.game.conf.bots = 0; }
                    
                    window.ui.showTab('play'); 
                    window.game.start();
                    window.ui.notif(`MISSION: ${part.desc}`, "#facc15");
                } else if (part.type === 'reward') {
                    if(part.coin) {
                        USER.coins += part.coin;
                        this.notif(`R√âCOMPENSE : ${part.coin} ü™ô`, "#facc15");
                    }
                    if(part.gems) {
                        USER.gems = (USER.gems || 0) + part.gems;
                        this.notif(`R√âCOMPENSE : ${part.gems} üíé`, "#a855f7");
                    }
                    if(part.xp) {
                         if(USER.pass) USER.pass.xp += part.xp;
                         if(this.updateClubLevel) this.updateClubLevel(part.xp); 
                         
                         if(STARTERS[id]) {
                             if(!USER.mastery) USER.mastery = {};
                             if(!USER.mastery[id]) USER.mastery[id] = { xp: 0, lvl: 1 };
                             USER.mastery[id].xp += part.xp;
                         }
                         this.notif(`R√âCOMPENSE : ${part.xp} XP`, "#3b82f6");
                    }
                    if(part.box) {
                         this.notif(`R√âCOMPENSE : ${part.box} CAISSE(S) (TODO)`, "#f59e0b");
                    }
                    if(part.skin) {
                         if(!USER.skins) USER.skins = [];
                         if(!USER.skins.includes(part.skin)) {
                             USER.skins.push(part.skin);
                             this.notif(`SKIN D√âBLOQU√â : ${part.skin}`, "#a855f7");
                         }
                    }
                    this.completeAdventurePart(id);
                } else {
                    this.completeAdventurePart(id);
                }
            },
            completeAdventurePart(id) {
                if(!USER.adventures[id]) USER.adventures[id] = { part: 0 };
                USER.adventures[id].part++;
                Storage.save();
                this.renderAdventures();
                setTimeout(() => this.playStory(id), 500); // Chain events
            },
            renderClubs(filter='') {
                const c = document.getElementById('club-container');
                if(USER.club) {
                     // Ensure new fields exist
                     if(!USER.club.level) USER.club.level = 1;
                     if(!USER.club.xp) USER.club.xp = 0;
                     if(!USER.club.photo) USER.club.photo = 'üõ°Ô∏è';
                     if(!USER.club.mentions) USER.club.mentions = 0;

                     const nextLvl = USER.club.level * 1000;
                     const pct = Math.min(100, (USER.club.xp / nextLvl) * 100);

                     c.innerHTML = `<div class="flex flex-col h-full">
                         <!-- Header Club -->
                         <div class="glass-panel p-6 mb-4 flex flex-col items-center relative overflow-hidden bg-gradient-to-b from-blue-900/20 to-black/40 border-blue-500/30">
                             <div class="absolute inset-0 bg-[url('https://cdn.tailwindcss.com/img/beams.png')] bg-cover opacity-5"></div>
                             
                             <div class="relative z-10 flex flex-col items-center">
                                 <button class="text-6xl mb-2 hover:scale-110 transition shadow-[0_0_30px_rgba(59,130,246,0.3)] bg-black/30 rounded-full w-24 h-24 flex items-center justify-center border-2 border-white/10" onclick="window.ui.changeClubIcon()">${USER.club.photo}</button>
                                 <h3 class="text-3xl font-black text-white mb-0 uppercase tracking-tight flex items-center gap-2">${USER.club.name} ${USER.club.verified ? '<span class="text-blue-400 text-lg" title="V√©rifi√©">‚òëÔ∏è</span>' : ''}</h3>
                                 <div class="text-green-400 font-bold mb-4 text-xs tracking-widest uppercase bg-green-900/20 px-3 py-1 rounded border border-green-500/20">${USER.club.role || 'Membre'}</div>
                                 
                                 <div class="w-full max-w-sm">
                                     <div class="flex justify-between text-[10px] font-bold text-gray-400 mb-1">
                                         <span>NIVEAU ${USER.club.level}</span>
                                         <span>${USER.club.xp} / ${nextLvl} XP</span>
                                     </div>
                                     <div class="h-3 bg-black/60 rounded-full overflow-hidden border border-white/10 shadow-inner">
                                         <div class="h-full bg-gradient-to-r from-blue-500 to-cyan-400 shadow-[0_0_15px_rgba(59,130,246,0.5)] transition-all duration-1000" style="width:${pct}%"></div>
                                     </div>
                                 </div>
                             </div>
                             <div class="absolute top-4 right-4 flex flex-col gap-2">
                                 <button onclick="window.ui.leaveClub()" class="text-red-500 text-[10px] font-bold hover:underline bg-black/30 px-2 py-1 rounded">QUITTER</button>
                             </div>
                         </div>

                     </div>
                     
                     <!-- Club Tabs -->
                     <div class="flex gap-2 mb-2">
                        <button onclick="document.getElementById('club-view-chat').classList.remove('hidden'); document.getElementById('club-view-members').classList.add('hidden');" class="flex-1 bg-blue-600/50 hover:bg-blue-600 text-xs font-bold py-2 rounded-lg transition border border-white/10">DISCUSSION</button>
                        <button onclick="document.getElementById('club-view-chat').classList.add('hidden'); document.getElementById('club-view-members').classList.remove('hidden'); window.ui.renderClubMembers();" class="flex-1 bg-purple-600/50 hover:bg-purple-600 text-xs font-bold py-2 rounded-lg transition border border-white/10">MEMBRES</button>
                     </div>

                         <!-- Chat Area -->
                         <div id="club-view-chat" class="flex-1 glass-panel p-0 flex flex-col relative overflow-hidden mb-4 min-h-[500px]">
                             <div class="bg-black/20 p-2 border-b border-white/5 text-[10px] font-bold text-gray-400 uppercase tracking-widest flex justify-between">
                                 <span>Canal de discussion</span>
                                 <span>${(USER.club.members||[]).length + 1} Membres</span>
                             </div>
                             <div class="flex-1 overflow-y-auto p-4 space-y-3 hide-scrollbar" id="club-chat">
                                 <div class="text-center text-xs text-gray-500 my-4 italic">--- D√©but de la discussion ---</div>
                                 ${(USER.club.messages||[]).map(m=>`
                                     <div class="animate-fadeIn flex flex-col ${m.u===USER.name?'items-end':''}">
                                         <div class="text-[9px] text-gray-500 font-bold mb-0.5 ${m.u===USER.name?'mr-1':'ml-1'}">${m.u} <span class="text-[8px] opacity-50 ml-1">${m.time || ''}</span></div>
                                         <div class="${m.u===USER.name?'bg-blue-600/80 text-white rounded-tr-sm':'bg-gray-800 text-gray-200 rounded-tl-sm'} px-3 py-2 rounded-xl text-sm max-w-[85%] shadow-md backdrop-blur-sm border border-white/5 break-words">
                                             ${m.t}
                                         </div>
                                     </div>
                                 `).join('')}
                             </div>
                             <!-- Input Area -->
                             <div class="p-3 bg-black/40 border-t border-white/5">
                                 <div class="flex gap-2 relative">
                                    <button onclick="document.getElementById('emoji-picker').classList.toggle('hidden')" class="bg-white/5 hover:bg-white/10 px-3 rounded-xl border border-white/5 transition">üòÄ</button>
                                     <input type="text" id="club-msg-input" class="flex-1 bg-black/50 border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:border-blue-500/50 focus:outline-none transition" placeholder="Message..." onkeydown="if(event.key==='Enter'){event.preventDefault(); window.ui.sendClubMsg();}">
                                     <button onclick="window.ui.sendClubMsg()" class="bg-blue-600 hover:bg-blue-500 px-4 rounded-xl shadow-lg shadow-blue-900/50 transition">‚ûú</button>
                                     
                                     <!-- Emoji Picker -->
                                     <div id="emoji-picker" class="hidden absolute bottom-full left-0 mb-2 bg-gray-900 border border-white/10 rounded-xl p-2 shadow-2xl z-50 grid grid-cols-6 gap-2 w-64">
                                         ${['üòÄ','üòÇ','üî•','‚ù§Ô∏è','üëç','üëã','üéâ','üíÄ','ü§ñ','üíé','üõ°Ô∏è','‚öîÔ∏è'].map(e=>`<button onclick="window.ui.addClubEmoji('${e}')" class="text-xl hover:bg-white/10 p-1 rounded transition">${e}</button>`).join('')}
                                     </div>
                                 </div>
                             </div>
                         </div>
                         
                         <!-- Members Area -->
                         <div id="club-view-members" class="hidden flex-1 glass-panel p-4 flex flex-col relative overflow-hidden mb-4 min-h-[500px]">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Liste des membres</h4>
                                <div class="relative w-1/2">
                                    <input type="text" placeholder="Rechercher..." class="w-full bg-black/30 border border-white/10 rounded-lg px-2 py-1 pl-7 text-xs text-white focus:outline-none focus:border-purple-500 transition" oninput="window.ui.renderClubMembers(this.value)">
                                    <div class="absolute left-2 top-1.5 text-gray-500 text-[10px]">üîç</div>
                                </div>
                            </div>
                            <div class="flex-1 overflow-y-auto space-y-2 hide-scrollbar" id="club-members-list">
                                <!-- Populated by renderClubMembers -->
                            </div>
                            
                            <!-- CLUB QUESTS SECTION -->
                            <div class="mt-4 pt-4 border-t border-white/10">
                                <h4 class="text-xs font-bold text-yellow-400 mb-2 uppercase tracking-widest flex items-center gap-2">üõ°Ô∏è QU√äTES DE CLUB</h4>
                                <div id="club-quests-list" class="space-y-2">
                                     ${(USER.quests.club || []).map(q => `
                                        <div class="bg-black/20 p-2 rounded border border-yellow-500/20 text-xs flex justify-between items-center">
                                            <div>
                                                <div class="font-bold text-gray-300">${q.desc}</div>
                                                <div class="text-[9px] text-gray-500">${q.progress}/${q.target}</div>
                                            </div>
                                            <div class="text-yellow-400 font-bold">+${q.reward.val} ${q.reward.type==='xp'?'XP':'ü™ô'}</div>
                                        </div>
                                     `).join('')}
                                    ${(!USER.quests.club || USER.quests.club.length === 0) ? '<div class="text-[10px] text-gray-500 italic">Aucune qu√™te active.</div>' : ''}
                                </div>
                            </div>
                         </div>
                     </div>`;
                     
                     // Scroll to bottom
                     setTimeout(() => {
                         const chat = document.getElementById('club-chat');
                         if(chat) chat.scrollTop = chat.scrollHeight;
                     }, 100);
                     
                } else {
                     // Empty state - Suggest Clubs
                     
                     let html = `<div class="text-center mb-6 h-full flex flex-col items-center justify-center">
                        <div class="glass-panel p-8 max-w-2xl w-full relative overflow-hidden bg-gradient-to-b from-blue-900/10 to-black/40">
                             <div class="text-6xl mb-4 animate-bounce">üõ°Ô∏è</div>
                            <h3 class="text-4xl font-black text-white mb-2 tracking-tighter italic">REJOINS UN CLUB !</h3>
                            <p class="text-gray-400 mb-8 max-w-md mx-auto">Discute, progresse et gagne des r√©compenses exclusives avec ton √©quipe.</p>
                            
                            <button onclick="window.ui.createClub()" class="glass-btn px-8 py-4 font-black text-yellow-400 mb-8 border-yellow-500/50 hover:bg-yellow-900/20 text-lg shadow-[0_0_30px_rgba(234,179,8,0.2)]">CR√âER UN CLUB</button>
                            
                            <div class="w-full text-left">
                                <h4 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">Clubs Recommand√©s</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">`;
                     
                     let found = false;
                     CLUBS.forEach(mck => {
                         if(filter && !mck.name.toLowerCase().includes(filter) && !mck.tag.toLowerCase().includes(filter)) return;
                         found = true;
                         html += `<div class="glass-panel p-4 flex justify-between items-center hover:bg-white/5 transition hover:scale-[1.02] cursor-pointer group border-white/5 hover:border-blue-500/30">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-black/30 flex items-center justify-center text-xl border border-white/5">${mck.icon}</div>
                                <div>
                                    <div class="font-bold text-white group-hover:text-blue-400 transition">${mck.name}</div>
                                    <div class="text-[10px] text-gray-400">${mck.members} membres | "${mck.desc}"</div>
                                </div>
                            </div>
                            <button onclick="window.ui.joinClub('${mck.name}')" class="bg-blue-600 hover:bg-blue-500 px-4 py-1.5 rounded-lg text-xs font-bold shadow-lg shadow-blue-900/20">REJOINDRE</button>
                         </div>`;
                     });
                     if(!found) html += '<div class="col-span-2 text-center text-gray-500 py-4">Aucun club trouv√©.</div>';
                     
                     html += `</div></div></div></div>`;
                     c.innerHTML = html;
                }
            },
            renderFriends(filter='') {
                const list = el('friends-list');
                const count = el('online-count');
                if(!list) return;
                list.innerHTML = '';
                
                // FAKE USERS DATABASE FOR SEARCH
                const FAKE_USERS = [
                    {name: 'Mathias', avatar: 'üë®‚Äçüíª', trophies: 15000, status: 'online'},
                    {name: 'DarkVador', avatar: 'üíÄ', trophies: 4500, status: 'game'},
                    {name: 'SkyWalker', avatar: '‚öîÔ∏è', trophies: 3200, status: 'offline'},
                    {name: 'Princess', avatar: 'üëë', trophies: 8900, status: 'online'},
                    {name: 'NoobMaster', avatar: 'ü§°', trophies: 100, status: 'game'},
                    {name: 'ProGamer', avatar: 'üéÆ', trophies: 25000, status: 'online'},
                    {name: 'Bot_Alpha', avatar: 'ü§ñ', trophies: 500, status: 'online'},
                    {name: 'Ghost', avatar: 'üëª', trophies: 6666, status: 'offline'},
                    {name: 'Ninja', avatar: 'ü•∑', trophies: 7777, status: 'game'}
                ];

                // SEARCH MODE
                if(filter && filter.length > 0) {
                     filter = filter.toLowerCase();
                     list.innerHTML = `<div class="text-[10px] text-gray-400 mb-2 uppercase tracking-widest">R√©sultats de recherche</div>`;
                     
                     // Combined: Existing Friends + Fake Users (excluding existing)
                     const existingNames = USER.friends.map(f => f.name.toLowerCase());
                     
                     // 1. Matched Friends
                     const matchedFriends = USER.friends.filter(f => f.name.toLowerCase().includes(filter));
                     matchedFriends.forEach(f => {
                         // Render as Friend
                         this.renderFriendItem(list, f, true);
                     });

                     // 2. Suggestions (Fake Users)
                     const suggestions = FAKE_USERS.filter(u => u.name.toLowerCase().includes(filter) && !existingNames.includes(u.name.toLowerCase()));
                     suggestions.forEach(u => {
                         // Render as Suggestion
                         list.innerHTML += `
                            <div class="glass-panel p-3 flex justify-between items-center border border-white/5 bg-blue-900/10 hover:bg-blue-900/20 transition">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-black/40 flex items-center justify-center text-xl border border-white/10 opacity-70">
                                        ${u.avatar}
                                    </div>
                                    <div class="text-left">
                                        <div class="text-sm font-bold text-white leading-none mb-1">${u.name}</div>
                                        <div class="text-[10px] text-blue-400 font-mono">Joueur sugg√©r√©</div>
                                    </div>
                                </div>
                                <button onclick="window.ui.addFakeFriend('${u.name}')" class="bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-bold px-3 py-2 rounded-lg shadow-lg flex items-center gap-1">AJOUTER ‚ûï</button>
                            </div>
                         `;
                     });
                     
                     if(matchedFriends.length === 0 && suggestions.length === 0) {
                         list.innerHTML += `<div class="text-center text-gray-500 py-4 italic text-xs">Aucun joueur trouv√©.</div>`;
                     }
                     return;
                }

                // NORMAL MODE (My Friends)
                if(!USER.friends || USER.friends.length === 0) {
                     list.innerHTML = `<div class="text-center text-gray-500 py-4 italic text-xs">Aucun ami pour le moment.<br>Recherche des joueurs ci-dessus !</div>`;
                     if(count) count.innerText = '0';
                     return;
                }
                
                let online = 0;
                USER.friends.forEach((f, i) => {
                    const isOnline = f.status === 'online' || f.status === 'game';
                    if(isOnline) online++;
                    this.renderFriendItem(list, f, true, i);
                });
                
                if(count) count.innerText = online;
            },
            
            // Helper for rendering friend
            renderFriendItem(container, f, isFriend, index) {
                const statusColor = f.status === 'online' ? 'bg-green-500' : (f.status === 'game' ? 'bg-yellow-500' : 'bg-gray-500');
                const statusText = f.status === 'online' ? 'En Ligne' : (f.status === 'game' ? 'En Jeu' : 'Hors Ligne');
                const i = index !== undefined ? index : USER.friends.findIndex(x => x.name === f.name);

                container.innerHTML += `

                    <div class="glass-panel p-3 flex justify-between items-center border border-white/5 hover:bg-white/5 transition">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-black/40 flex items-center justify-center text-xl border border-white/10 relative">
                                ${f.avatar || 'üë§'}
                                <div class="absolute bottom-0 right-0 w-3 h-3 ${statusColor} rounded-full border border-black shadow-md"></div>
                            </div>
                            <div class="text-left">
                                <div class="text-sm font-bold text-white leading-none mb-1">${f.name}</div>
                                <div class="text-xs text-gray-400 font-bold flex gap-2"><span>${statusText}</span> <span class="text-yellow-500">üèÜ ${f.trophies || 0}</span></div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.ui.sendGift(${i})" class="w-8 h-8 rounded-lg bg-pink-600/20 hover:bg-pink-600/40 text-pink-400 border border-pink-500/30 flex items-center justify-center transition animate-pulse" title="Envoyer Cadeau">üéÅ</button>
                            <button onclick="window.ui.inspectFriend(${i})" class="w-8 h-8 rounded-lg bg-blue-600/20 hover:bg-blue-600/40 text-blue-400 border border-blue-500/30 flex items-center justify-center transition" title="Profil">üëÅÔ∏è</button>
                            <button onclick="alert('Messagerie bient√¥t disponible !')" class="w-8 h-8 rounded-lg bg-purple-600/20 hover:bg-purple-600/40 text-purple-400 border border-purple-500/30 flex items-center justify-center transition" title="Message">‚úâÔ∏è</button>
                            <button onclick="window.ui.removeFriend(${i})" class="w-8 h-8 rounded-lg bg-red-600/20 hover:bg-red-600/40 text-red-400 border border-red-500/30 flex items-center justify-center transition" title="Supprimer">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            },
            sendGift(i) {
                const f = USER.friends[i];
                if(f) {
                    if(USER.coins >= 100) {
                        if(confirm(`Envoyer un cadeau √† ${f.name} pour 100 pi√®ces ?`)) {
                            USER.coins -= 100;
                            Storage.save();
                            this.updateMenu();
                            this.notif(`CADEAU ENVOY√â √Ä ${f.name.toUpperCase()} !`, "#ec4899");
                        }
                    } else {
                        this.notif("PAS ASSEZ DE PI√àCES (100) !", "#ef4444");
                    }
                },

            addFakeFriend(name) {
                 if(!USER.friends) USER.friends = [];
                 const FAKE_USERS = [
                    {name: 'Mathias', avatar: 'üë®‚Äçüíª', trophies: 15000, status: 'online'},
                    {name: 'DarkVador', avatar: 'üíÄ', trophies: 4500, status: 'game'},
                    {name: 'SkyWalker', avatar: '‚öîÔ∏è', trophies: 3200, status: 'offline'},
                    {name: 'Princess', avatar: 'üëë', trophies: 8900, status: 'online'},
                    {name: 'NoobMaster', avatar: 'ü§°', trophies: 100, status: 'game'},
                    {name: 'ProGamer', avatar: 'üéÆ', trophies: 25000, status: 'online'},
                    {name: 'Bot_Alpha', avatar: 'ü§ñ', trophies: 500, status: 'online'},
                    {name: 'Ghost', avatar: 'üëª', trophies: 6666, status: 'offline'},
                    {name: 'Ninja', avatar: 'ü•∑', trophies: 7777, status: 'game'}
                ];
                const user = FAKE_USERS.find(u => u.name === name) || {name: name, avatar: 'üë§', trophies: 0, status: 'offline'};
                
                USER.friends.push(user);
                Storage.save();
                this.renderFriends();
                this.notif(`AMI AJOUT√â: ${name}`, "#22c55e");
                // Clear search if possible
                const input = document.querySelector('input[oninput="window.ui.search(\'friends\', this.value)"]');
                if(input) input.value = '';
            },
            addFriend() {
                // UI MODAL
                if(document.getElementById('add-friend-modal')) return;
                const m = document.createElement('div');
                m.id = 'add-friend-modal';
                m.className = 'fixed inset-0 z-[70] bg-black/80 flex items-center justify-center p-4 animate-fadeIn';
                m.innerHTML = `
                    <div class="glass-panel p-6 w-full max-w-sm relative flex flex-col gap-4 border border-blue-500/30 shadow-[0_0_50px_rgba(59,130,246,0.3)]">
                        <button onclick="document.getElementById('add-friend-modal').remove()" class="absolute top-2 right-2 text-gray-400 hover:text-white text-xl">√ó</button>
                        <h3 class="text-xl font-black text-white italic tracking-wider flex items-center gap-2">AJOUTER UN AMI <span class="text-blue-500">///</span></h3>
                        <p class="text-sm text-gray-400">Entre le Tag ou Pseudo de ton ami.</p>
                        
                        <input type="text" id="add-friend-input" placeholder="Ex: #Player123" class="w-full bg-black/50 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition font-mono">
                        
                        <div class="flex gap-2 mt-2">
                            <button onclick="document.getElementById('add-friend-modal').remove()" class="flex-1 py-3 rounded-xl font-bold text-gray-400 hover:bg-white/5 transition">ANNULER</button>
                            <button id="add-friend-confirm" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-900/40 transition">ENVOYER</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(m);
                setTimeout(() => { const i = document.getElementById('add-friend-input'); if(i) i.focus(); }, 100);
                
                const submit = () => {
                    const val = document.getElementById('add-friend-input').value.trim();
                    if(val) {
                        document.getElementById('add-friend-modal').remove();
                        this.processAddFriend(val);
                    }
                };
                
                document.getElementById('add-friend-confirm').onclick = submit;
                document.getElementById('add-friend-input').onkeydown = (e) => { if(e.key === 'Enter') submit(); };
            },
            processAddFriend(name) {
                this.notif(`Demande envoy√©e √† ${name}...`, "#3b82f6");
                 // Simulation de r√©ponse serveur
                 setTimeout(() => {
                     if(Math.random() < 0.2) {
                          this.notif(`Joueur ${name} introuvable.`, "#ef4444");
                     } else {
                         if(!USER.friends) USER.friends = [];
                         // Simulate adding a bot friend for now
                         const statusList = ['online', 'offline', 'game'];
                         const s = statusList[Math.floor(Math.random()*statusList.length)];
                         const newFriend = {
                             name: name, 
                             avatar: ['ü¶Å','üêØ','üêª','üêº','üëΩ','ü§ñ'][Math.floor(Math.random()*6)], 
                             status: s,
                             trophies: Math.floor(Math.random() * 5000),
                             added: Date.now()
                         };
                         USER.friends.push(newFriend);
                         Storage.save();
                         this.renderFriends();
                         this.notif(`${name} a accept√© votre demande !`, "#22c55e");
                     }
                 }, 1500);
            },
            removeFriend(index) {
                if(confirm("Supprimer cet ami ?")) {
                    USER.friends.splice(index, 1);
                    Storage.save();
                    this.renderFriends();
                    this.notif("AMI SUPPRIM√â", "#ef4444");
                }
            },
            inspectFriend(index) {
                const f = USER.friends[index];
                if(!f) return;
                
                document.getElementById('fp-name').innerText = f.name;
                document.getElementById('fp-avatar').innerText = f.avatar || 'üë§';
                document.getElementById('fp-trophies').innerText = f.trophies + ' üèÜ';
                document.getElementById('fp-status').innerText = f.status === 'online' ? 'EN LIGNE' : (f.status === 'game' ? 'EN JEU' : 'HORS LIGNE');
                document.getElementById('fp-status').className = `text-xs font-bold uppercase tracking-widest px-3 py-1 rounded border mb-4 ${f.status === 'online' ? 'bg-green-900/50 text-green-400 border-green-500/30' : (f.status === 'game' ? 'bg-yellow-900/50 text-yellow-400 border-yellow-500/30' : 'bg-gray-800 text-gray-400 border-gray-600')}`;
                document.getElementById('fp-club').innerText = f.club || 'Aucun';
                
                document.getElementById('friend-profile-modal').classList.remove('hidden');
            },
            kickMember(name) {
                if(confirm(`Voulez-vous vraiment expulser ${name} du club ?`)) {
                     USER.club.members = USER.club.members.filter(m => m.name !== name);
                     Storage.save();
                     this.renderClubMembers();
                     this.renderClubs();
                     this.notif(`${name} a √©t√© exclu.`, "#ef4444");
                }
            },
            renderClubMembers(filter='') {
                 const list = document.getElementById('club-members-list');
                 if(!list || !USER.club) return;
                 list.innerHTML = '';
                 
                 // Fake members if empty (simulation)
                 if(!USER.club.members) {
                     USER.club.members = [
                         { name: 'Bot_Alpha', role: 'V√©t√©ran', trophies: 1200, status: 'online' },
                         { name: 'Bot_Beta', role: 'Membre', trophies: 800, status: 'offline' },
                         { name: 'Bot_Omega', role: 'Membre', trophies: 1500, status: 'game' }
                     ];
                 }
                 
                 // Add self
                 const self = { name: USER.name, role: USER.club.role, trophies: USER.trophies, status: 'online', isSelf: true };
                 const allMembers = [self, ...USER.club.members];
                 
                 allMembers.sort((a,b) => b.trophies - a.trophies);
                 
                 allMembers.forEach(m => {
                     if(filter && !m.name.toLowerCase().includes(filter.toLowerCase())) return;
                     const statusColor = m.status === 'online' ? 'bg-green-500' : (m.status === 'game' ? 'bg-yellow-500' : 'bg-gray-500');
                     list.innerHTML += `
                        <div class="flex items-center justify-between bg-black/20 p-2 rounded-lg border border-white/5">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-gray-800 flex items-center justify-center relative">
                                    ${m.isSelf ? USER.avatar : 'üë§'}
                                    <div class="absolute bottom-0 right-0 w-2.5 h-2.5 ${statusColor} rounded-full border border-black"></div>
                                </div>
                                <div>
                                    <div class="text-xs font-bold text-white ${m.isSelf?'text-yellow-400':''}">${m.name}</div>
                                    <div class="text-[9px] text-gray-400">${m.role} ‚Ä¢ üèÜ ${m.trophies}</div>
                                </div>
                            </div>
                            ${(!m.isSelf && USER.club.role === 'Chef') ? `<button onclick="window.ui.kickMember('${m.name}')" class="text-[9px] text-red-500 border border-red-500/30 px-2 py-1 rounded hover:bg-red-900/40">KICK</button>` : ''}
                        </div>
                     `;
                 });
            },
            addClubEmoji(e) {
                const inp = document.getElementById('club-msg-input');
                if(inp) { inp.value += e; inp.focus(); }
                document.getElementById('emoji-picker').classList.add('hidden');
            },
            changeClubIcon() {
                if(USER.club.role !== 'Chef') { this.notif("Seul le Chef peut changer l'ic√¥ne !", "#ef4444"); return; }
                const icons = ['üõ°Ô∏è','‚öîÔ∏è','üëë','üíÄ','üî•','üíé','üöÄ','‚≠ê','ü§ñ','üëª'];
                let n = prompt("Choisi une ic√¥ne :\n" + icons.join("  "));
                if(icons.includes(n)) {
                    USER.club.photo = n;
                    Storage.save();
                    this.renderClubs();
                } else if(n) {
                    this.notif("Ic√¥ne invalide !", "#ef4444");
                }
            },
            updateClubLevel(xp) {
                if(!USER.club) return;
                USER.club.xp = (USER.club.xp || 0) + xp;
                const next = USER.club.level * 1000;
                if(USER.club.xp >= next) {
                    USER.club.level++;
                    USER.club.xp -= next;
                    this.notif(`CLUB NIVEAU ${USER.club.level} !`, "#facc15");
                    // Reward?
                }
                Storage.save();
            },
            createClub() {
                const name = prompt("Nom du club ?");
                if(name) {
                    USER.club = { name, role: 'Chef', messages: [] };
                    Storage.save();
                    this.renderClubs();
                    this.notif("CLUB CR√â√â !", "#22c55e");
                }
            },
            joinClub(name) {
                USER.club = { name, role: 'Recrue', messages: [{u:'Sys', t:'Bienvenue !'}] };
                Storage.save();
                this.renderClubs();
                this.notif("CLUB REJOINT !", "#22c55e");
            },
            sendClubMsg() {
                const inp = document.getElementById('club-msg-input');
                if(inp && inp.value.trim() !== '') {

                    const btn = document.querySelector('button[onclick="window.ui.sendClubMsg()"]');
                    if(btn) btn.disabled = true;

                    const now = new Date();
                    const ts = now.getHours() + ':' + (now.getMinutes()<10?'0':'') + now.getMinutes();
                    USER.club.messages.push({u: USER.name, t: inp.value, time: ts});
                    inp.value = '';
                    Storage.save();
                    this.renderClubs();

                    // Re-enable safely
                    setTimeout(() => { 
                         const b = document.querySelector('button[onclick="window.ui.sendClubMsg()"]');
                         if(b) b.disabled = false;
                         const i = document.getElementById('club-msg-input');
                         if(i) i.focus();
                    }, 200);
                }
            },
            leaveClub() {
                if(confirm("Quitter le club ?")) { USER.club = null; Storage.save(); document.getElementById('club-container').innerHTML = `...`; this.renderClubs(); window.ui.showTab('clubs'); }
            },
            updateDifficultyButtons() {
                if(!window.game || !window.game.conf) return; 
                console.log("[UI] Update Difficulty Buttons:", window.game.conf.difficulty, window.game.conf.modifier);
                
                // Update Difficulty Buttons
                document.querySelectorAll('.diff-btn').forEach(btn => {
                    btn.classList.remove('selected', 'active');
                    btn.style.borderColor = ''; // Reset inline style
                });
                
                const activeBtn = document.getElementById(`diff-${window.game.conf.difficulty}`);
                if (activeBtn) {
                     activeBtn.classList.add('selected');
                }
                
                // Update Modifier Buttons
                document.querySelectorAll('.mod-btn').forEach(btn => {
                    btn.classList.remove('selected', 'active');
                    btn.style.borderColor = ''; // Reset inline style
                });
                
                const mod = window.game.conf.modifier;
                if(mod) {
                    const modBtn = document.getElementById(`mod-${mod}`);
                    if(modBtn) {
                        modBtn.classList.add('selected');
                    }
                }
            },
            renderBotSelector() {
                 let c = el('bot-selector');
                 if(!c) {
                     const tab = el('tab-play');
                     if(!tab) return;
                     const div = document.createElement('div');
                     div.id = 'bot-selector';
                     div.className = 'glass-panel p-3 mb-4 border border-white/10';
                     // Insert after first child which is usually header, or just append
                     if(tab.children.length > 2) tab.insertBefore(div, tab.children[2]);
                     else tab.appendChild(div);
                     c = div;
                 }
                 
                 const cur = (window.game && window.game.conf) ? (window.game.conf.bots || 0) : 0;
                 let html = '<div class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-wider">Escouade (Bots Alli√©s)</div><div class="flex gap-2">';
                 [0,1,2,3].forEach(n => {
                     const active = cur === n ? 'selected text-cyan-400' : 'text-gray-400';
                     html += `<button onclick="window.game.setBots(${n})" class="glass-btn flex-1 py-3 rounded-lg font-bold ${active} transition text-sm">${n}</button>`;
                 });
                 html += '</div>';
                 c.innerHTML = html;
            },
            refreshShop(force = false) {
                if (force) {
                    if (USER.gems >= 10) {
                        console.log("[SECURE] Market Refresh (-10 gems)");
                        USER.gems -= 10;
                        this.notif("-10 üíé REROLL", "#a855f7");
                        this.updateMenu();
                        USER.shop.lastRefresh = 0; // Force refresh trigger
                    } else {
                        this.notif("PAS ASSEZ DE GEMMES", "#ef4444");
                        return;
                    }
                }
                
                // NOUVEAU : Plus d'items de base garantis
                USER.shop.items = USER.shop.items || [];
                if(USER.shop.items.length === 0 || Date.now() > USER.shop.lastRefresh + 86400000) {
                    USER.shop.lastRefresh = Date.now();
                    USER.shop.items = [];

                    // OFFRE GRATUITE GARANTIE (1 item)
                    const freeType = ['coins','xp','gems'][Math.floor(Math.random()*3)];
                    if(freeType === 'coins') USER.shop.items.push({ type: 'coins', cost: 0, val: 150, curr: 'free', name: "Pi√®ces Gratuites" });
                    if(freeType === 'xp') USER.shop.items.push({ type: 'xp', cost: 0, val: 75, curr: 'free', name: "XP Pass Gratuit" });
                    if(freeType === 'gems') USER.shop.items.push({ type: 'gems', cost: 0, val: 10, curr: 'free', name: "Gemmes Gratuites" });

                    // EVENT: NOEL 2025 (Cadeau Sp√©cial)
                    if(new Date().getMonth() === 11) { // D√©cembre
                        USER.shop.items.push({ type: 'box', cost: 0, val: 3, curr: 'free', name: "Cadeau de No√´l üéÖ", special: 'christmas' });
                    }

                    // ITEMS DE BASE GARANTIS (3 items)
                    USER.shop.items.push({type:'coins',cost:20,val:500,curr:'gems', name: "Mega Pack de Pi√®ces"});
                    USER.shop.items.push({type:'xp',cost:100,val:200,curr:'coins', name: "Super Boost de Pass"});
                    USER.shop.items.push({type:'box',cost:80,val:1,curr:'coins', name: "Mega Caisse"});

                    // ITEMS AL√âATOIRES (3 items)
                    for(let i=0; i<3; i++) {
                        const t = ['coins','gems','box', 'xp', 'skin'][Math.floor(Math.random()*5)];
                        if(t==='coins') USER.shop.items.push({type:'coins',cost:20,val:300,curr:'gems', name: "Pack de Pi√®ces"});
                        if(t==='gems') USER.shop.items.push({type:'gems',cost:500,val:30,curr:'coins', name: "Sac de Gemmes"});
                        if(t==='box') USER.shop.items.push({type:'box',cost:80,val:1,curr:'coins', name: "Mega Caisse"});
                        if(t==='xp') USER.shop.items.push({type:'xp',cost:100,val:100,curr:'coins', name: "Boost de Pass"});
                        if(t==='skin') {
                            const keys = Object.keys(STARTERS);
                            const s = STARTERS[keys[Math.floor(Math.random()*keys.length)]];
                            if(s.skins && s.skins.length > 1) {
                                const skin = s.skins[1]; 
                                USER.shop.items.push({type:'skin',cost:skin.price,val:1,curr:'coins', name: `Skin ${skin.name}`, skinId: skin.id, hero: s.name, discount: Math.random() > 0.5 ? 30 : 0});
                            } else {
                                USER.shop.items.push({type:'coins',cost:20,val:300,curr:'gems', name: "Pack de Pi√®ces"});
                            }
                        }
                    }
                    Storage.save();
                    if(force) this.renderShop();
                }
            },
            renderShop() {
                this.refreshShop();
                const now = Date.now(); 
                const left = (USER.shop.lastRefresh + 86400000) - now; const hrs = Math.floor(left / 3600000); const mins = Math.floor((left % 3600000) / 60000);
                setText('shop-timer', `${hrs}h ${mins}m`);
                const c = el('shop-offers'); 
                if(!c) return;
                c.innerHTML = '';
                c.innerHTML += `<h3 class="col-span-1 md:col-span-2 text-xl font-bold text-yellow-400 flex items-center gap-2">üî• OFFRES FLASH üî•</h3>`;
                USER.shop.items.forEach((item, idx) => {
                    let icon = item.type==='coins'?'ü™ô':(item.type==='gems'?'üíé':(item.type==='xp'?'üé´':(item.type==='skin'?'üëï':'üì¶')));
                    let curIcon = item.curr==='coins'?'ü™ô':(item.curr==='gems'?'üíé':'üéÅ');
                    let color = item.curr==='free' ? 'border-green-500/30 bg-green-900/10' : 'bg-white/5';
                    let btnClass = item.curr==='free' ? 'bg-green-600 hover:bg-green-500 shadow-green-900/50' : (item.curr==='gems'?'bg-purple-600 hover:bg-purple-500 shadow-purple-900/50':'bg-yellow-600 hover:bg-yellow-500 shadow-yellow-900/50');
                    let costDisplay = `${item.cost} ${curIcon}`;
                    let discountBadge = '';
                    if(item.discount) {
                        const newCost = Math.floor(item.cost * (1 - item.discount/100));
                        costDisplay = `<span class="line-through text-gray-400 text-xs mr-2">${item.cost}</span> ${newCost} ${curIcon}`;
                        item.realCost = newCost;
                        discountBadge = `<div class="absolute top-0 right-0 bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded-bl-lg shadow-lg z-10">-${item.discount}%</div>`;
                    } else {
                        item.realCost = item.cost;
                    }
                    if(item.curr === 'free') costDisplay = 'GRATUIT';
                    c.innerHTML += `<div class="glass-panel p-6 text-center flex flex-col items-center active:scale-95 transition border border-white/10 ${color} relative overflow-hidden group hover:border-white/30 hover:shadow-[0_0_20px_rgba(255,255,255,0.1)]">
                        ${discountBadge}
                        <div class="text-5xl mb-3 transform group-hover:scale-110 transition duration-300 drop-shadow-lg">${icon}</div>
                        <div class="font-black text-lg mb-1 tracking-wide">${item.name}</div>
                        <div class="text-xs text-gray-400 mb-4 font-bold uppercase tracking-wider">${item.type==='skin' ? 'Skin Rare' : `+${item.val} ${icon}`}</div>
                        <button onclick="window.ui.buySpecial(${idx})" class="w-full ${btnClass} py-3 rounded-xl font-bold text-sm shadow-xl transition-all hover:scale-105 active:scale-95 border border-white/10 uppercase tracking-widest">${costDisplay}</button>
                    </div>`;
                });
            },
            renderPass() {
                setText('pass-lvl', USER.pass.tier); setText('pass-xp-txt', `${USER.pass.xp}/100 XP`); setStyle('pass-bar', 'width', `${USER.pass.xp}%`);
                const status = el('pass-pro-status');
                if(status) {
                    if(USER.mPassMax) { 
                        status.innerHTML = '<span class="text-yellow-400 font-black text-xl drop-shadow-[0_0_10px_rgba(250,204,21,0.5)]">mPASS MAX ACTIV√â</span>'; 
                    } else if(USER.mPassPro) {
                        status.innerHTML = `<div class="flex gap-2 items-center"><span class="text-purple-400 font-bold drop-shadow-md">PRO ACTIV√â</span> <button onclick="window.ui.buyPass('upgrade')" class="bg-gradient-to-r from-yellow-500 to-amber-600 px-4 py-2 rounded-xl font-bold text-xs shadow-lg hover:scale-105 transition animate-pulse border border-yellow-300/30">UPGRADE MAX (40üíé)</button></div>`;
                    } else { 
                        status.innerHTML = `<div class="flex gap-2">
                            <button onclick="window.ui.buyPass('pro')" class="bg-gradient-to-r from-purple-600 to-indigo-600 px-4 py-2 rounded-xl font-bold text-xs shadow-lg hover:scale-105 transition border border-purple-400/30">mPASS PRO (159üíé)</button>
                            <button onclick="window.ui.buyPass('max')" class="bg-gradient-to-r from-yellow-500 to-amber-600 px-4 py-2 rounded-xl font-bold text-xs shadow-lg hover:scale-105 transition border border-yellow-300/30">mPASS MAX (199üíé)</button>
                        </div>`; 
                    }
                }
                const tr = el('pass-track-free');
                const trPro = el('pass-track-pro');
                const trMax = el('pass-track-max');
                if (!tr || !trPro || !trMax) return;
                let freeHtml = '';
                let proHtml = '';
                let maxHtml = '';
                
                const getRewardDisplay = (rewardString) => {
                    const [type, value] = rewardString.split(':');
                    const val = parseInt(value) || 1;
                    let icon = 'üéÅ', text = '';
                    if(type === 'coins') { icon = 'ü™ô'; text = `+${val}`; }
                    else if(type === 'gems') { icon = 'üíé'; text = `+${val}`; }
                    else if(type === 'box' || type === 'mega_caisse_loot') { icon = 'üì¶'; text = 'Caisse'; }
                    else if(type.startsWith('emote')) { icon = EMOTE_LIST.find(e => e.id === type.split(':')[1])?.i || 'üòÄ'; text = 'Emote'; }
                    else if(type.startsWith('skin')) { icon = 'üëï'; text = 'Skin'; }
                    return { icon, text };
                };
                
                for(let i=1; i<=100; i++) {
                    const freeRwdStr = getPassReward(i, 'free');
                    const proRwdStr = getPassReward(i, 'pro');
                    const maxRwdStr = getPassReward(i, 'max');
                    
                    const displayF = getRewardDisplay(freeRwdStr);
                    const displayP = getRewardDisplay(proRwdStr);
                    const displayM = getRewardDisplay(maxRwdStr);
                    
                    let claimedF = USER.pass.claimed.includes(i);
                    let claimedP = USER.pass.claimedPro.includes(i);
                    let claimedM = USER.pass.claimedMax && USER.pass.claimedMax.includes(i);
                    let unlocked = USER.pass.tier >= i;
                    
                    let proLocked = !USER.mPassPro && !USER.mPassMax;
                    let maxLocked = !USER.mPassMax;

                    // Manual color mappings
                    let fClass = claimedF ? "border-green-500/20 bg-green-900/10 opacity-60 grayscale" : (unlocked ? "border-blue-400 bg-blue-900/30 shadow-[0_0_10px_rgba(56,189,248,0.3)] cursor-pointer hover:scale-105 active:scale-95" : "border-white/5 bg-black/20 opacity-50");
                    let pClass = claimedP ? "border-purple-500/20 bg-purple-900/10 opacity-60 grayscale" : (unlocked ? (proLocked ? "border-purple-500/20 bg-purple-900/10 opacity-70 cursor-not-allowed" : "border-purple-500 bg-purple-900/30 shadow-[0_0_10px_rgba(168,85,247,0.3)] cursor-pointer hover:scale-105 active:scale-95") : "border-white/5 bg-black/20 opacity-50");
                    let mClass = claimedM ? "border-yellow-500/20 bg-yellow-900/10 opacity-60 grayscale" : (unlocked ? (maxLocked ? "border-yellow-500/20 bg-yellow-900/10 opacity-70 cursor-not-allowed" : "border-yellow-500 bg-yellow-900/30 shadow-[0_0_10px_rgba(234,179,8,0.3)] cursor-pointer hover:scale-105 active:scale-95") : "border-white/5 bg-black/20 opacity-50");

                    let fnF = (unlocked && !claimedF) ? `onclick="window.ui.claimPass(${i}, 'free', '${freeRwdStr}')"` : '';
                    let fnP = (unlocked && !claimedP && !proLocked) ? `onclick="window.ui.claimPass(${i}, 'pro', '${proRwdStr}')"` : (proLocked ? `onclick="window.ui.notif('ACH√àTE LE mPASS PRO !', '#a855f7')"` : '');
                    let fnM = (unlocked && !claimedM && !maxLocked) ? `onclick="window.ui.claimPass(${i}, 'max', '${maxRwdStr}')"` : (maxLocked ? `onclick="window.ui.notif('ACH√àTE LE mPASS MAX !', '#facc15')"` : '');
                    
                    const tierBadge = `<div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-black/80 px-2 py-0.5 rounded text-[8px] font-bold border border-white/10 text-gray-400 whitespace-nowrap">PALIER ${i}</div>`;
                    
                    const content = (chk, icon, txt) => chk ? `<div class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-xl z-10"><div class="text-2xl">‚úÖ</div></div><div class="opacity-20 flex flex-col items-center"><div class="text-2xl mb-1">${icon}</div><div class="text-[9px] font-bold">${txt}</div></div>` : `<div class="flex flex-col items-center"><div class="text-3xl mb-1 drop-shadow-md transition-transform group-hover:scale-110">${icon}</div><div class="text-[10px] font-bold tracking-wide">${txt}</div></div>`;

                    freeHtml += `
                        <div id="pass-free-tier-${i}" class="glass-panel w-24 h-28 shrink-0 rounded-xl border relative flex items-center justify-center transition-all duration-300 group ${fClass}" ${fnF}>
                            ${tierBadge}
                            ${content(claimedF, displayF.icon, displayF.text)}
                        </div>`;
                    proHtml += `
                        <div id="pass-pro-tier-${i}" class="glass-panel w-24 h-28 shrink-0 rounded-xl border relative flex items-center justify-center transition-all duration-300 group ${pClass}" ${fnP}>
                             ${tierBadge}
                             ${content(claimedP, displayP.icon, displayP.text)}
                             ${proLocked ? '<div class="absolute top-1 right-1 text-xs">üîí</div>' : ''}
                        </div>`;
                    maxHtml += `
                        <div id="pass-max-tier-${i}" class="glass-panel w-24 h-28 shrink-0 rounded-xl border relative flex items-center justify-center transition-all duration-300 group ${mClass}" ${fnM}>
                             ${tierBadge}
                             ${content(claimedM, displayM.icon, displayM.text)}
                             ${maxLocked ? '<div class="absolute top-1 right-1 text-xs">üîí</div>' : ''}
                        </div>`;
                }
                tr.innerHTML = `<div class="flex gap-4 p-4">${freeHtml}</div>`;
                trPro.innerHTML = `<div class="flex gap-4 p-4">${proHtml}</div>`;
                trMax.innerHTML = `<div class="flex gap-4 p-4">${maxHtml}</div>`;

                const scrollContainer = el('pass-scroll-container');
                const currentTierIndex = USER.pass.tier;

                if (scrollContainer) {
                    const freeRow = el('pass-track-free');
                    if (freeRow && currentTierIndex > 0) {
                        const targetTier = Math.min(100, Math.max(1, currentTierIndex));
                        const targetElement = freeRow.querySelector(`#pass-free-tier-${targetTier}`);
                        
                        if (targetElement) {
                            const centerOffset = targetElement.offsetLeft - (scrollContainer.offsetWidth / 2) + (targetElement.offsetWidth / 2);
                            setTimeout(() => { scrollContainer.scrollLeft = centerOffset; }, 50);
                        }
                    }
                }
                
                
                USER.stats.maxPassTier = Math.max(USER.stats.maxPassTier || 1, USER.pass.tier);
                Storage.save();
            },
            renderLists() {
                // EVENT BANNER
                const currentMode = (window.game && window.game.conf) ? window.game.conf.mode : 'survival';
                const eventBanner = document.getElementById('event-banner-container');
                if(!eventBanner) {
                     const b = document.createElement('div');
                     b.id = 'event-banner-container';
                     b.className = 'w-full max-w-md mb-4 glass-panel p-4 bg-gradient-to-r from-pink-900/40 to-purple-900/40 border-pink-500/30 flex justify-between items-center cursor-pointer hover:scale-105 transition';
                     b.onclick = () => window.ui.notif("√âV√àNEMENT SEMAINE PROCHAINE !", "#ec4899");
                     b.innerHTML = `<div><div class="text-xs text-pink-400 font-bold mb-1">√âV√àNEMENT SP√âCIAL</div><div class="font-black italic text-xl text-white">RAID CYBERNETIQUE</div></div><div class="text-3xl animate-pulse">üëæ</div>`;
                     // Insert after Top Rank Widget if possible, or prepended to tab-play
                     const tab = document.getElementById('tab-play');
                     if(tab) tab.insertBefore(b, tab.children[1]); // Insert after rank widget
                }

                const currentArena = (window.game && window.game.conf) ? window.game.conf.arena : 'tokyo';
                
                // NOUVEAU: Utiliser la liste tri√©e
                const sortedStarters = sortStartersByRarity();

                const sl = el('list-starters'); sl.innerHTML = '';
                this.renderStarters(); // Initial render with no filter
                this.renderModesAndArenas();
            },
            renderStarters(filter='') {
                const sl = el('list-starters'); 
                if(!sl) return;
                sl.innerHTML = '';
                
                const sortedStarters = sortStartersByRarity(); // Assume this helper exists or use STARTERS directly
                
                 Object.keys(sortedStarters).forEach(k => {
                    const s = sortedStarters[k];
                    if(filter && !s.name.toLowerCase().includes(filter) && !s.desc.toLowerCase().includes(filter)) return;

                    const unlocked = USER.unlocked.includes(k), lvl = USER.levels[k]||1, active = USER.selected === k;
                    const rarity = RARITY[s.rarity] || RARITY.common;
                    
                    sl.innerHTML += `<div onclick="window.ui.openHeroDetails('${k}')" style="--r-color:${rarity.color}" class="glass-panel p-3 cursor-pointer active:scale-95 transition-all duration-300 ${active ? 'bg-blue-900/40 border-blue-500 shadow-[0_0_15px_rgba(59,130,246,0.3)]' : `border-${rarity.color}/30 border-opacity-30 hover:border-${rarity.color}/60`} ${unlocked?'':'locked opacity-50 grayscale'} relative group border hover:shadow-lg hover:-translate-y-1 overflow-hidden flex flex-col items-center text-center">
                        <div class="absolute inset-0 bg-gradient-to-br from-[var(--r-color)] to-transparent opacity-5 group-hover:opacity-15 transition-opacity"></div>
                        ${(window.QuestSystem && window.QuestSystem.hasQuest('play', {hero: k})) ? '<div class="absolute top-1 left-1 text-lg z-20 animate-bounce">üìú</div>' : ''}
                        <div class="absolute top-2 right-2 px-2 py-0.5 rounded text-[8px] font-bold uppercase tracking-wider text-white shadow-sm z-10 backdrop-blur-md" style="background-color:${rarity.color}">${rarity.name}</div>
                        <div class="w-14 h-14 rounded-2xl bg-black/40 flex items-center justify-center text-3xl mb-3 shadow-inner group-hover:scale-110 transition-transform duration-300 relative z-10">${s.icon}</div>
                        <div class="font-black font-tech text-sm uppercase tracking-wider mb-1 relative z-10" style="color:${rarity.color}">${s.name}</div>
                        <div class="text-[10px] text-gray-400 leading-tight mb-2 h-6 overflow-hidden relative z-10">${s.desc}</div>
                        <div class="text-[9px] font-bold text-blue-300 bg-blue-900/30 px-2 py-0.5 rounded-full border border-blue-500/30 relative z-10">Niv. ${lvl}</div>
                    </div>`;
                });
            },
            renderModesAndArenas() {
                 
                 const currentMode = (window.game && window.game.conf) ? window.game.conf.mode : 'survival';
                 const currentArena = (window.game && window.game.conf) ? window.game.conf.arena : 'tokyo';
                
                 const ml = el('list-modes'); ml.innerHTML = ''; 
                Object.keys(MODES).forEach(k => { 
                    const m = MODES[k]; 
                    const isSelected = currentMode === k;
                    const specialClass = m.special ? 'season-gold' : ''; 
                    
                    ml.innerHTML += `<div onclick="window.game.setMode('${k}')" class="glass-panel p-4 cursor-pointer flex items-center gap-4 ${isSelected ? 'border-purple-500 bg-purple-900/20 shadow-[0_0_15px_rgba(168,85,247,0.2)]' : ''} ${specialClass} active:scale-95 transition-all duration-300 relative group overflow-hidden">
                        <div class="absolute inset-0 bg-white/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        ${(window.QuestSystem && (window.QuestSystem.hasQuest('play', {mode: k}) || window.QuestSystem.hasQuest('win', {mode: k}))) ? '<div class="absolute top-2 right-2 text-xl animate-bounce">üìú</div>' : ''}
                        <div class="text-4xl p-3 bg-black/40 rounded-full shadow-lg group-hover:scale-110 transition-transform duration-300">${m.icon}</div>
                        <div class="text-left flex-1 relative z-10"><div class="font-black font-tech text-lg group-hover:text-purple-300 transition-colors">${m.name}</div><div class="text-xs text-gray-400 font-bold">${m.desc}</div></div>
                        <div class="text-2xl text-gray-600 group-hover:text-white transition-colors">‚ûú</div>
                    </div>`; 
                }); 
                
                const al = el('list-arenas'); al.innerHTML = ''; 
                Object.keys(ARENAS).forEach(k => { 
                    const a = ARENAS[k]; 
                    const isSelected = currentArena === k;
                    al.innerHTML += `<div onclick="window.game.setArena('${k}')" class="glass-panel p-3 cursor-pointer text-center ${isSelected ? 'border-cyan-500 bg-cyan-900/20 shadow-[0_0_15px_rgba(34,211,238,0.2)] text-cyan-300' : 'text-gray-400'} active:scale-95 transition-all duration-300 group overflow-hidden relative font-bold text-xs uppercase tracking-widest">
                         <div class="absolute inset-0 bg-gradient-to-b from-transparent to-black/80 z-0 opacity-50"></div>
                         <div class="relative z-10 group-hover:text-cyan-300 transition-colors">${a.name}</div>
                         ${(window.QuestSystem && (window.QuestSystem.hasQuest('play', {arena: k}) || window.QuestSystem.hasQuest('win', {arena: k}))) ? '<div class="absolute -top-1 -right-1 text-xs animate-bounce">üìú</div>' : ''}
                    </div>`; 
                });
            },
            openHeroDetails(k) {
                const s = STARTERS[k];
                const unlocked = USER.unlocked.includes(k);
                const lvl = USER.levels[k] || 1;
                const rarity = RARITY[s.rarity] || RARITY.common;
                const rBadge = el('hd-rarity');
                if(rBadge) {
                    rBadge.innerText = rarity.name;
                    rBadge.style.backgroundColor = rarity.color;
                    rBadge.style.color = '#000'; 
                    rBadge.style.boxShadow = `0 0 10px ${rarity.color}`;
                }
                setText('hd-icon', s.icon); setText('hd-name', s.name); setText('hd-lvl', "NIVEAU " + lvl); setText('hd-desc', s.lore || s.desc); setText('hd-gadget-name', getGadgetName(s.gadget)); setText('hd-passive', s.passive || "Aucun");
                
                // NOUVEAU : Affichage des stats d√©taill√©es
                const maxHp = 600, maxDmg = 150, maxSpd = 10;
                const statsData = [
                    { label: 'SANT√â', base: s.hp, scale: s.scale.hp, max: maxHp, color: 'bg-green-500', shadow: 'shadow-green-500/50' },
                    { label: 'D√âG√ÇTS', base: s.dmg, scale: s.scale.dmg, max: maxDmg, color: 'bg-red-500', shadow: 'shadow-red-500/50' },
                    // La vitesse n'augmente pas par niveau, mais on affiche sa valeur
                    { label: 'VITESSE', base: s.spd, scale: 0, max: maxSpd, color: 'bg-yellow-400', shadow: 'shadow-yellow-400/50' } 
                ];

                let statsHTML = '';
                const currentSpd = s.spd; // Vitesse actuelle (d√©j√† mise √† l'√©chelle dans STARTERS)
                
                statsData.forEach(stat => {
                    const rawBase = stat.base;
                    const gainText = stat.scale > 0 ? `<span class="text-green-400">(+${stat.scale}/Niv)</span>` : '';
                    let currentValue = rawBase + stat.scale * (lvl - 1);
                    
                    if (stat.label === 'VITESSE') {
                        currentValue = parseFloat(currentSpd.toFixed(2)); // Afficher la vitesse apr√®s r√©duction
                    } else {
                        currentValue = Math.floor(currentValue);
                    }

                    const barWidth = (currentValue / stat.max) * 100;
                    
                    statsHTML += `
                        <div class="stat-row flex flex-col">
                            <div class="flex justify-between items-end mb-1">
                                <div class="stat-label text-sm text-gray-400 uppercase font-bold">${stat.label}</div>
                                <div class="text-sm font-black text-white">${currentValue} ${gainText}</div>
                            </div>
                            <div class="stat-track h-2 bg-gray-900/50 rounded-full overflow-hidden border border-white/5">
                                <div class="stat-fill h-full ${stat.color} transition-all duration-300 shadow-lg ${stat.shadow}" style="width: ${Math.min(100, barWidth)}%;"></div>
                            </div>
                        </div>
                    `;
                });
                el('hero-stats-container').innerHTML = statsHTML;

                // --- NOUVEAUT√â v1.4.0 : MA√éTRISE ---
                const masteryC = document.createElement('div');
                masteryC.className = 'mb-4 bg-black/30 p-3 rounded-xl border border-yellow-500/20';
                const mXp = (USER.mastery && USER.mastery[k]) ? USER.mastery[k].xp : 0;
                let mLvl = 1;
                for(let i=0; i<MASTERY_XP.length; i++) { if(mXp >= MASTERY_XP[i]) mLvl = i+1; }
                const nextXp = MASTERY_XP[mLvl] || MASTERY_XP[MASTERY_XP.length-1];
                const prevXp = MASTERY_XP[mLvl-1] || 0;
                const mPct = Math.min(100, Math.floor(((mXp - prevXp) / (nextXp - prevXp)) * 100));
                
                masteryC.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <div class="text-[10px] uppercase font-bold text-yellow-500 flex items-center gap-1"><span class="text-lg">üëë</span> MA√éTRISE</div>
                        <div class="text-xs font-black text-white">Niv. ${mLvl}</div>
                    </div>
                    <div class="h-3 bg-gray-800 rounded-full overflow-hidden border border-white/10 relative">
                        <div class="absolute inset-0 bg-white/5 animate-pulse"></div>
                        <div class="h-full bg-gradient-to-r from-yellow-600 to-yellow-400" style="width:${mPct}%"></div>
                    </div>
                    <div class="text-[8px] text-right text-gray-500 mt-1">${mXp} / ${nextXp} XP</div>
                `;
                el('hero-stats-container').appendChild(masteryC);
                // --- FIN MA√éTRISE ---

                const skinsContainer = el('hd-skins-list');
                skinsContainer.innerHTML = '';
                if(s.skins) {
                    s.skins.forEach(skin => {
                        const fullSkinId = `${k}_${skin.id}`;
                        const isOwned = skin.id === 'default' || (USER.ownedSkins && USER.ownedSkins.includes(fullSkinId));
                        const isSelected = (USER.skins && USER.skins[k] === skin.id) || (skin.id === 'default' && !USER.skins[k]);
                        const style = isSelected ? 'border-yellow-400 bg-yellow-900/30' : (isOwned ? 'border-white/20 bg-white/5' : 'border-gray-700 bg-black/50 grayscale');
                        const priceDisplay = skin.price ? `${skin.price}ü™ô` : 'Gratuit';
                        const actionText = isOwned ? (isSelected?'√âQUIP√â':'METTRE') : priceDisplay;
                        const clickAction = isOwned ? `window.ui.equipSkin('${k}', '${skin.id}')` : `window.ui.buySkin('${k}', '${skin.id}', ${skin.price})`;
                        skinsContainer.innerHTML += `<div onclick="${clickAction}" class="w-16 h-16 rounded-lg border-2 ${style} flex flex-col items-center justify-center cursor-pointer shrink-0"><div class="text-2xl" style="color:${skin.c}">${s.icon}</div><div class="text-[8px] font-bold mt-1">${actionText}</div></div>`;
                    });
                }
                
                const wSkinsC = document.createElement('div');
                wSkinsC.className = 'mt-3 pt-3 border-t border-white/10';
                
                const wSkins = [
                    { id: 'default', name: 'Standard', c: 'bg-gray-400', p: 0, hex: '#1e293b' },
                    { id: 'gold', name: 'Or', c: 'bg-yellow-400', p: 5000, curr: 'coins', hex: '#eab308' },
                    { id: 'magma', name: 'Magma', c: 'bg-red-600', p: 50, curr: 'gems', hex: '#ef4444' }
                ];

                let wHtml = `<div class="text-[10px] text-gray-400 uppercase font-bold mb-2">SKINS D'ARMES üî´</div><div class="flex gap-2 overflow-x-auto hide-scrollbar">`;
                
                wSkins.forEach(ws => {
                    const owned = ws.id === 'default' || (USER.weaponSkins && USER.weaponSkins.includes(ws.id));
                    const equipped = (USER.equippedWeaponSkin || 'default') === ws.id;
                    const style = equipped ? 'border-green-500 shadow-[0_0_10px_lime]' : (owned ? 'border-white/30' : 'border-white/5 opacity-70 grayscale');
                    const click = owned ? `window.ui.equipWeaponSkin('${ws.id}')` : `window.ui.buyWeaponSkin('${ws.id}', ${ws.p}, '${ws.curr}')`;
                    
                    wHtml += `<div onclick="${click}" class="w-12 h-12 rounded border-2 ${style} bg-white/5 flex items-center justify-center cursor-pointer relative group transition hover:scale-105">
                        <div class="w-4 h-4 rounded-full ${ws.c} shadow-[0_0_5px_currentColor]"></div>
                        ${equipped ? '<div class="absolute -top-2 -right-2 bg-green-500 text-black text-[8px] font-bold px-1 rounded">ON</div>' : ''}
                        ${!owned ? `<div class="absolute -bottom-3 text-[8px] whitespace-nowrap bg-black px-1 rounded border border-white/10 text-white">${ws.p}${ws.curr==='gems'?'üíé':'ü™ô'}</div>` : ''}
                    </div>`;
                });
                wHtml += `</div>`;
                wSkinsC.innerHTML = wHtml;
                el('hd-skins-container').appendChild(wSkinsC);

                
                const actions = el('hd-actions');
                if(unlocked) {
                    const upgradeCost = lvl * 150;
                    if(lvl >= 10) { actions.innerHTML = `<button onclick="window.game.setStarter('${k}'); document.getElementById('hero-details-modal').classList.add('hidden')" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl">S√âLECTIONNER</button><button class="w-full max-level font-bold py-3 rounded-xl flex justify-center items-center gap-2 cursor-default border border-yellow-500/50 text-yellow-500 bg-yellow-900/20">NIVEAU MAX</button>`; }
                    else { actions.innerHTML = `<button onclick="window.game.setStarter('${k}'); window.ui.openHeroDetails('${k}')" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl">S√âLECTIONNER</button><button onclick="window.ui.upgrade('${k}'); window.ui.openHeroDetails('${k}')" class="w-full bg-green-600/80 hover:bg-green-500 text-white font-bold py-3 rounded-xl flex justify-center items-center gap-2">AM√âLIORER <span class="bg-black/20 px-2 rounded text-xs">${upgradeCost} ü™ô</span></button>`; }
                } else { 
                    actions.innerHTML = `<button onclick="window.ui.unlock('${k}'); document.getElementById('hero-details-modal').classList.add('hidden')" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 rounded-xl flex justify-center items-center gap-2 text-lg">ACHETER <span class="bg-black/20 px-3 py-1 rounded text-sm">${s.price} ü™ô</span></button>`; 
                }
                el('hero-details-modal').classList.remove('hidden');
            },
            equipSkin(heroId, skinId) { if(!USER.skins) USER.skins = {}; USER.skins[heroId] = skinId; Storage.save(); this.openHeroDetails(heroId); },
            buySkin(heroId, skinId, price) { if(USER.coins >= price) { if(SoundManager) SoundManager.play('purchase'); console.log(`[SECURE] Buy Skin: ${heroId}_${skinId} (-${price} coins)`); USER.coins -= price; if(!USER.ownedSkins) USER.ownedSkins = []; USER.ownedSkins.push(`${heroId}_${skinId}`); this.notif("SKIN D√âBLOQU√â !", "#facc15"); this.equipSkin(heroId, skinId); } else { if(SoundManager) SoundManager.play('error'); this.notif("PAS ASSEZ DE PI√àCES !", "#ef4444"); } },
            equipWeaponSkin(id) { USER.equippedWeaponSkin = id; Storage.save(); this.openHeroDetails(USER.selected); this.notif("ARME √âQUIP√âE !", "#22c55e"); },
            buyWeaponSkin(id, price, curr) {
                let ok = false;
                if(curr === 'coins' && USER.coins >= price) { USER.coins -= price; ok = true; }
                else if(curr === 'gems' && USER.gems >= price) { USER.gems -= price; ok = true; }
                
                if(ok) {
                    if(SoundManager) SoundManager.play('purchase');
                    if(!USER.weaponSkins) USER.weaponSkins = [];
                    USER.weaponSkins.push(id);
                    this.equipWeaponSkin(id);
                    this.notif("SKIN D'ARME ACHET√â !", "#facc15");
                } else {
                    if(SoundManager) SoundManager.play('error');
                    this.notif("PAS ASSEZ DE FONDS !", "#ef4444");
                }
            },
            renderProfile() { 
                setText('profile-display-name', USER.name); 
                setText('profile-tag', USER.tag);
                setText('profile-bio', USER.bio || "Aucune bio d√©finie...");
                setText('profile-trophies', USER.trophies + " Troph√©es");
                
                // CALCUL STATS
                let bestHero = 'Aucun';
                let maxLvl = 0;
                Object.keys(USER.levels).forEach(k => {
                   if(USER.levels[k] > maxLvl) { maxLvl = USER.levels[k]; bestHero = STARTERS[k]?.name || k; }
                });

                // Calc Fav Mode
                let favMode = 'Aucun';
                let maxPlays = 0;
                if(USER.stats.modes) {
                    Object.keys(USER.stats.modes).forEach(m => {
                        if(USER.stats.modes[m] > maxPlays) { maxPlays = USER.stats.modes[m]; favMode = MODES[m]?.name || m; }
                    });
                }
                
                // INJECT NEW STATS
                const statsDiv = document.querySelector('#profile-main-card .flex-1 .flex.justify-center.gap-4');
                if(statsDiv) {
                    // Clear previous injections to avoid dupes
                    const old1 = document.getElementById('profile-best-hero'); if(old1) old1.remove();
                    const old2 = document.getElementById('profile-fav-mode'); if(old2) old2.remove();

                    statsDiv.innerHTML += `
                        <div class="px-3 py-1 rounded bg-black/40 border border-white/10 text-xs font-bold text-cyan-400 flex items-center gap-2" id="profile-best-hero"><span class="text-lg">üëë</span> <span>${bestHero}</span></div>
                        <div class="px-3 py-1 rounded bg-black/40 border border-white/10 text-xs font-bold text-purple-400 flex items-center gap-2" id="profile-fav-mode"><span class="text-lg">üéÆ</span> <span>${favMode}</span></div>
                    `;
                }

                // Theme Update
                const theme = USER.theme || 'blue';
                const themeClasses = {
                    blue: 'from-blue-900/20 to-purple-900/20 border-blue-500/30',
                    purple: 'from-purple-900/20 to-pink-900/20 border-purple-500/30',
                    green: 'from-green-900/20 to-teal-900/20 border-green-500/30',
                    red: 'from-red-900/20 to-orange-900/20 border-red-500/30',
                    yellow: 'from-yellow-900/20 to-amber-900/20 border-yellow-500/30'
                };
                const card = el('profile-main-card');
                if(card) {
                    // Reset basic classes and apply new
                    card.className = `glass-panel p-6 mb-6 relative overflow-hidden bg-gradient-to-br ${themeClasses[theme]} transition-colors duration-500`;
                }

                // HANDLE CUSTOM IMAGE OR EMOJI
                const avatarContainer = el('profile-avatar');
                avatarContainer.innerHTML = ''; // Clear existing content
                if(USER.avatar.startsWith('data:image')) {
                    avatarContainer.innerHTML = `<img src="${USER.avatar}" class="avatar-img rounded-full">`;
                    avatarContainer.classList.remove('text-4xl');
                } else {
                    avatarContainer.innerHTML = USER.avatar;
                    avatarContainer.classList.add('text-4xl');
                }
                
                // UPDATE QUEST TIMER
                if (USER.quests && USER.quests.lastGenerated) {
                    const diff = (USER.quests.lastGenerated + 86400000) - Date.now();
                    const qt = el('quest-timer');
                    if (qt) {
                        if (diff > 0) {
                            const hrs = Math.floor(diff / 3600000);
                            const mins = Math.floor((diff % 3600000) / 60000);
                            qt.innerText = `Reset: ${hrs}h ${mins}m`;
                        } else {
                            qt.innerText = "Disponible !";
                        }
                    }
                }
                
                let totalLvl = Object.values(USER.levels).reduce((a,b)=>a+b, 0); 
                setText('profile-lvl', "LVL " + totalLvl); 
            },
            renderQuests(filter='') {
                 const c = document.getElementById('tab-quests');
                 if(!c) return;

                 // Update Quest Timer
                 if (USER.quests && USER.quests.lastGenerated) {
                    const diff = (USER.quests.lastGenerated + 86400000) - Date.now();
                    const qt = document.getElementById('quest-timer-tab');
                    if (qt) {
                        if (diff > 0) {
                            const hrs = Math.floor(diff / 3600000);
                            const mins = Math.floor((diff % 3600000) / 60000);
                            qt.innerText = `Reset: ${hrs}h ${mins}m`;
                        } else {
                            qt.innerText = "Disponible !";
                        }
                    }
                 }

                 const renderQ = (list, id, typeList) => {
                    const elC = document.getElementById(id); if(!elC) return; elC.innerHTML = '';
                    list.forEach(q => {
                        if(filter && !q.desc.toLowerCase().includes(filter.toLowerCase()) && !q.reward.type.includes(filter.toLowerCase())) return;
                        const pct = Math.min(100, (q.progress / q.target) * 100);
                        const rIcon = q.reward.type === 'xp' ? '‚≠ê' : (q.reward.type === 'coins' ? 'ü™ô' : 'üíé');
                        const status = q.claimed ? '<span class="text-green-500 font-bold text-xs">OUI</span>' : (q.completed ? `<button onclick="window.QuestSystem.claim('${typeList}', '${q.id}')" class="bg-green-600 hover:bg-green-500 text-white font-bold px-3 py-1 rounded-xs animate-pulse">R√âCUP√âRER</button>` : `<span class="text-gray-500 text-xs">${q.progress}/${q.target}</span>`);
                        const style = q.completed ? (q.claimed ? 'border-green-900/30 opacity-50' : 'border-green-500 bg-green-900/20') : 'border-white/10 bg-black/40';
                        
                        elC.innerHTML += `<div class="glass-panel p-3 rounded-lg border flex justify-between items-center transition ${style}">
                            <div class="flex-1">
                                <div class="text-sm font-bold text-white mb-1.5 drop-shadow-md">${q.desc}</div>
                                <div class="w-full h-1.5 bg-black/50 rounded-full overflow-hidden border border-white/5"><div class="h-full bg-blue-400 shadow-[0_0_8px_rgba(96,165,250,0.6)] transition-all" style="width:${pct}%"></div></div>
                            </div>
                            <div class="ml-4 flex flex-col items-end gap-1">
                                <div class="text-xs font-black text-yellow-400 drop-shadow-sm">+${q.reward.val}${rIcon}</div>
                                ${status}
                            </div>
                        </div>`;
                    });
                };
                if(USER.quests) {
                    renderQ(USER.quests.daily, 'daily-quests-list-tab', 'daily');
                    renderQ(USER.quests.season, 'season-quests-list-tab', 'season');
                }
            },
            renderFriends(filter='') {
                const c = document.getElementById('friends-list'); 
                const count = document.getElementById('online-count');
                if(!c) return;
                c.innerHTML = '';
                
                if(!USER.friends) USER.friends = [];
                
                let online = 0;
                
                if(USER.friends.length === 0 && !filter) {
                     c.innerHTML = `<div class="text-center py-8 opacity-50"><div class="text-4xl mb-2">ü§∑</div><div class="text-sm font-bold">Aucun ami ajout√©.</div></div>`;
                }

                USER.friends.forEach((f, idx) => {
                    if(filter && !f.name.toLowerCase().includes(filter.toLowerCase()) && !f.tag.includes(filter)) return;
                    
                    // Simple deterministic "online" status based on tag hash + time for consistency or random for demo
                    const hash = f.tag.split('').reduce((a,b)=>a+b.charCodeAt(0),0);
                    const isOnline = (Date.now() + hash) % 20000000 < 10000000; // ~50% chance
                    
                    if(isOnline) online++;
                    
                    const statusClass = isOnline ? 'bg-green-500' : 'bg-gray-500';
                    const statusText = isOnline ? 'En ligne' : 'Hors ligne';
                    
                    c.innerHTML += `<div class="glass-panel p-3 flex justify-between items-center group hover:bg-white/5 transition cursor-pointer" onclick="window.ui.showFriendProfile('${f.name}', '${f.tag}', ${isOnline})">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-black/40 border border-white/10 flex items-center justify-center text-xl relative">
                                üë§
                                <div class="absolute bottom-0 right-0 w-3 h-3 rounded-full ${statusClass} border-2 border-black"></div>
                            </div>
                            <div class="text-left">
                                <div class="font-bold text-sm text-white">${f.name}</div>
                                <div class="text-[10px] text-gray-400 font-mono">${f.tag}</div>
                            </div>
                        </div>
                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition">
                             <button onclick="event.stopPropagation(); window.ui.removeFriend(${idx})" class="w-8 h-8 rounded-lg bg-red-600/20 text-red-400 hover:bg-red-600 hover:text-white flex items-center justify-center transition" title="Supprimer">üóëÔ∏è</button>
                            <button class="w-8 h-8 rounded-lg bg-blue-600/20 text-blue-400 hover:bg-blue-600 hover:text-white flex items-center justify-center transition" title="Message">‚úâÔ∏è</button>
                        </div>
                    </div>`;
                });
                
                if(count) count.innerText = online;
            },
            addFriend() {
                const tag = prompt("Entrez le Tag de votre ami (ex: #1234) :");
                if(tag) {
                    this.notif("Recherche...", "#3b82f6");
                    setTimeout(() => {
                        if(tag.startsWith('#') && tag.length >= 5) {
                            const name = "Ami_" + tag.replace('#','');
                            if(!USER.friends) USER.friends = [];
                            if(USER.friends.find(f => f.tag === tag)) {
                                this.notif("D√©j√† dans la liste d'amis !", "#ef4444");
                                return;
                            }
                            USER.friends.push({ name: name, tag: tag, added: Date.now() });
                            Storage.save();
                            this.renderFriends();
                            this.notif(`AMI AJOUT√â: ${name}`, "#22c55e");
                        } else {
                            this.notif("TAG INVALIDE (Format #1234)", "#ef4444");
                        }
                    }, 500);
                }
            },
            removeFriend(idx) {
                if(confirm("Supprimer cet ami ?")) {
                    USER.friends.splice(idx, 1);
                    Storage.save();
                    this.renderFriends();
                    this.notif("Ami supprim√©", "#ef4444");
                }
            },
            showFriendProfile(name, tag, online) {
                 const m = document.getElementById('friend-profile-modal');
                 if(m) {
                     document.getElementById('fp-name').innerText = name;
                     const st = document.getElementById('fp-status');
                     if(st) {
                         st.innerText = online ? "EN LIGNE" : "HORS LIGNE";
                         st.className = `text-xs font-bold uppercase tracking-widest px-3 py-1 rounded border ${online ? 'bg-green-900/50 text-green-400 border-green-500/30' : 'bg-gray-800 text-gray-400 border-gray-600'}`;
                     }
                     document.getElementById('fp-trophies').innerText = Math.floor(Math.random() * 5000) + " üèÜ";
                     document.getElementById('fp-club').innerText = "Aucun";
                     m.classList.remove('hidden');
                 }
            },
            openAvatarSelector() { const grid = el('avatar-grid'); grid.innerHTML = ''; ICONS.forEach(icon => { grid.innerHTML += `<button onclick="window.ui.selectAvatar('${icon}')" class="glass-panel w-16 h-16 text-4xl flex items-center justify-center hover:bg-blue-600/50 hover:scale-110 hover:border-blue-400 active:scale-95 transition cursor-pointer rounded-2xl border border-white/5 shadow-lg">${icon}</button>`; }); el('avatar-selector').classList.remove('hidden'); },
            selectAvatar(icon) { USER.avatar = icon; Storage.save(); el('avatar-selector').classList.add('hidden'); this.renderProfile(); },
            
            uploadAvatar(input) {
                if (input.files && input.files[0]) {
                    const file = input.files[0];
                    if (file.size > 500000) { // Limit size to 500KB
                        this.notif("IMAGE TROP GRANDE (MAX 500KB)!", "#ef4444");
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        USER.avatar = e.target.result;
                        Storage.save();
                        window.ui.renderProfile();
                        el('avatar-selector').classList.add('hidden');
                    }
                    reader.readAsDataURL(file);
                }
            },

            renderEmotes(filter='') { 
                const list = el('list-emotes'); 
                list.innerHTML = ''; 
                const equipped = el('equipped-emotes'); 
                equipped.innerHTML = ''; 
                // FIX: La limite est maintenant √† 8
                const maxEquipped = 8; 

                USER.equippedEmotes.forEach(id => { 
                    const e = EMOTE_LIST.find(em => em.id === id); 
                    equipped.innerHTML += `<div class="glass-panel w-14 h-14 rounded-xl flex items-center justify-center text-2xl border border-blue-500/50 relative group cursor-pointer hover:bg-red-900/20 transition" onclick="window.ui.unequipEmote('${id}')">${e?.i || '‚ùì'}<div class="emote-remove-btn absolute -top-2 -right-2 bg-red-500 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold shadow-lg scale-0 group-hover:scale-100 transition duration-200">√ó</div></div>`; 
                }); 
                
                // Slots vides
                for(let i=USER.equippedEmotes.length; i < maxEquipped; i++) {
                     equipped.innerHTML += `<div class="w-14 h-14 bg-black/20 rounded-xl flex items-center justify-center text-xl border border-white/5 text-gray-700">#${i+1}</div>`;
                }

                EMOTE_LIST.forEach(e => { 
                    if(filter && !e.id.includes(filter)) return;

                    const unlocked = USER.emotes.includes(e.id); 
                    const selected = USER.equippedEmotes.includes(e.id); 
                    const priceTag = unlocked ? '' : `<div class="absolute bottom-1 right-1 text-[8px] font-bold bg-black/50 px-1 rounded text-purple-400 backdrop-blur-sm">${e.price}üíé</div>`; 
                    const clickAction = unlocked ? `window.ui.equipEmote('${e.id}')` : `window.ui.buyEmote('${e.id}', ${e.price})`; 
                    list.innerHTML += `<div onclick="${clickAction}" class="glass-panel w-16 h-16 flex items-center justify-center text-3xl cursor-pointer transition active:scale-95 rounded-xl border ${unlocked ? 'hover:bg-white/10 hover:border-white/30 border-white/10' : 'opacity-50 grayscale border-white/5'} ${selected ? 'border-green-500 bg-green-900/20 shadow-[0_0_15px_rgba(34,197,94,0.3)]' : ''}">${e.i}${priceTag}</div>`; 
                }); 
            },
            unequipEmote(id) { USER.equippedEmotes = USER.equippedEmotes.filter(e => e !== id); Storage.save(); this.renderEmotes(); this.toggleEmoteWheel(); },
            equipEmote(id) { 
                const maxEquipped = 8; // La nouvelle limite
                if(USER.equippedEmotes.includes(id)) { 
                    USER.equippedEmotes = USER.equippedEmotes.filter(e => e !== id); 
                } else { 
                    if(USER.equippedEmotes.length < maxEquipped) {
                        USER.equippedEmotes.push(id); 
                    } else {
                        this.notif("SLOTS PLEINS (Max 8) !", "#ef4444"); 
                    }
                } 
                Storage.save(); this.renderEmotes(); 
            },
            buyEmote(id, price) { if(USER.gems >= price) { if(SoundManager) SoundManager.play('purchase'); console.log(`[SECURE] Buy Emote: ${id} (-${price} gems)`); USER.gems -= price; USER.emotes.push(id); Storage.save(); this.notif("EMOTE D√âBLOQU√âE!", "#a855f7"); this.renderEmotes(); this.updateMenu(); } else { if(SoundManager) SoundManager.play('error'); this.notif("PAS ASSEZ DE GEMMES!", "#ef4444"); } },
            toggleEmoteWheel() { const wheel = el('emote-wheel'); if(wheel.classList.contains('hidden')) { wheel.innerHTML = ''; USER.equippedEmotes.forEach(id => { const e = EMOTE_LIST.find(em => em.id === id); wheel.innerHTML += `<div onclick="window.ui.triggerEmote('${e.i}'); window.ui.toggleEmoteWheel()" class="emote-btn">${e.i}</div>`; }); wheel.classList.remove('hidden'); } else { wheel.classList.add('hidden'); } },
            triggerEmote(emoji) { window.game.player.emote = emoji; window.game.player.emoteTimer = 120; },
            updateMenu() {
                // FIX: Ensure game exists before accessing properties
                let confMode = 'survival';
                if(typeof window.game !== 'undefined' && window.game.conf && window.game.conf.mode) {
                    confMode = window.game.conf.mode;
                }
                const m = MODES[confMode] || MODES['survival'];

                // Ensure adventures and clubs are rendered on menu update
                if(this.renderAdventures) this.renderAdventures(); 
                if(this.renderClubs) this.renderClubs();
                
                let s = STARTERS[USER.selected];
                if (!s) {
                    // Fallback to soldier if selected hero is invalid
                    USER.selected = 'soldier';
                    s = STARTERS['soldier'];
                    Storage.save();
                }
                
                // Gestion des animations de gain (non persistantes, elles sont sur set/add)
                
                setText('top-coins', USER.coins); setText('top-gems', USER.gems); setText('menu-trophies', USER.trophies);
                let rIdx = 0; for(let i=0; i<RANKS.length; i++) { if(USER.trophies >= RANKS[i].t) rIdx = i; }
                const currRank = RANKS[rIdx], nextRank = RANKS[rIdx+1];
                const re = el('menu-rank'); if(re) { re.innerText = currRank.n; re.style.backgroundImage = `linear-gradient(to right, #fff, ${currRank.c})`; }
                if(nextRank) { const diff = nextRank.t - USER.trophies, range = nextRank.t - currRank.t, done = USER.trophies - currRank.t, pct = Math.min(100, Math.max(0, (done / range) * 100)); setText('rank-progress-text', `Encore ${diff} üèÜ avant ${nextRank.n}`); setText('rank-progress-pct', Math.floor(pct) + '%'); setStyle('rank-progress-fill', 'width', pct + '%'); } else { setText('rank-progress-text', "RANG MAXIMUM !"); setText('rank-progress-pct', "100%"); setStyle('rank-progress-fill', 'width', '100%'); }
                setText('play-starter', s.name); setText('play-icon', s.icon); setText('play-lvl', "Niveau "+(USER.levels[USER.selected]||1));
                setText('play-mode', m.name); setText('play-mode-icon', m.icon);
                this.updateDifficultyButtons(); 
            },
            updateStats() { 
                setText('stat-kills', USER.stats.kills); 
                setText('stat-wave', USER.stats.maxWave); 
                setText('stat-games', USER.stats.games); 
                setText('stat-wins', USER.stats.wins); 
                setText('stat-dmg', Math.floor(USER.stats.dmg/1000)+"k"); 
                // Nouvelle stats
                setText('stat-losses', USER.stats.games - USER.stats.wins); // D√©faites
                setText('stat-unlocked', `${USER.unlocked.length}/${Object.keys(STARTERS).length}`); // H√©ros d√©bloqu√©s (mis √† jour √† 25)
                setText('stat-pass-tier', USER.stats.maxPassTier || 1); // Palier Pass Max
            },
            unlock(k) { const s = STARTERS[k]; if(USER.coins >= s.price) { if(SoundManager) SoundManager.play('purchase'); console.log(`[SECURE] Unlock Hero: ${k} (-${s.price} coins)`); USER.coins -= s.price; USER.unlocked.push(k); USER.selected = k; Storage.save(); this.notif(`D√âBLOQU√â!`, "#22c55e"); this.renderLists(); this.updateMenu(); } else { if(SoundManager) SoundManager.play('error'); this.notif("PAS ASSEZ!", "#ef4444"); } },
            upgrade(k) { const cost = (USER.levels[k]||1) * 150; if(USER.coins >= cost) { if(SoundManager) SoundManager.play('purchase'); console.log(`[SECURE] Upgrade Hero: ${k} (-${cost} coins)`); USER.coins -= cost; USER.levels[k]++; Storage.save(); this.notif(`NIVEAU UP!`, "#3b82f6"); this.renderLists(); this.updateMenu(); } else { if(SoundManager) SoundManager.play('error'); this.notif("PAS ASSEZ!", "#ef4444"); } },
            claimDaily() { 
                console.log("[SECURE] Claim Daily Reward");
                USER.coins += 200; 
                USER.lastDaily = Date.now(); 
                Storage.save(); 
                this.updateMenu();
                this.notif("+200 ü™ô", "#eab308"); 
                try { el('top-coins').closest('.currency-badge').classList.add('flash-coins'); setTimeout(() => el('top-coins').closest('.currency-badge').classList.remove('flash-coins'), 300); } catch(e){}
                this.renderLists(); 
                this.renderShop(); 
            },
            buy(t, cost, curr) { let ok = false; if(curr === 'free') ok = true; else if(curr === 'coins' && USER.coins >= cost) { USER.coins -= cost; ok = true; } else if(curr === 'gems' && USER.gems >= cost) { USER.gems -= cost; ok = true; } if(ok) { if(SoundManager) SoundManager.play('purchase'); if(t==='box'){ const r=Math.random(); if(r<0.8){const c=50+Math.floor(Math.random()*100);USER.coins+=c;this.notif(`+${c} ü™ô`,"#eab308");} else{const g=2+Math.floor(Math.random()*5);USER.gems+=g;this.notif(`+${g} üíé`,"#a855f7");} } else if(t==='coins') { USER.coins += 300; this.notif("+300 ü™ô","#eab308"); } else if(t==='gems') { USER.gems += 30; this.notif("+30 üíé","#a855f7"); } 
                
                // Trigger flash on manual purchase/gain
                try { if (t === 'coins') { el('top-coins').closest('.currency-badge').classList.add('flash-coins'); setTimeout(() => el('top-coins').closest('.currency-badge').classList.remove('flash-coins'), 300); } } catch(e){}
                try { if (t === 'gems') { el('top-gems').closest('.currency-badge').classList.add('flash-gems'); setTimeout(() => el('top-gems').closest('.currency-badge').classList.remove('flash-gems'), 300); } } catch(e){}
                
                Storage.save(); this.updateMenu(); this.renderShop(); } else { if(SoundManager) SoundManager.play('error'); this.notif("PAS ASSEZ!", "#ef4444"); } },
            buySpecial(idx) { 
                const item = USER.shop.items[idx]; if(!item) return; 
                let ok = false; 
                const actualCost = item.realCost || item.cost; 
                
                // 1. V√©rification du co√ªt et soustraction
                if(item.curr === 'free') {
                    console.log(`[SECURE] Buy Special Free: ${item.name}`);
                    ok = true;
                } else if(item.curr === 'coins') { 
                    if (USER.coins >= actualCost) { console.log(`[SECURE] Buy Special: ${item.name} (-${actualCost} coins)`); USER.coins -= actualCost; ok = true; }
                } else if(item.curr === 'gems') { 
                    if (USER.gems >= actualCost) { console.log(`[SECURE] Buy Special: ${item.name} (-${actualCost} gems)`); USER.gems -= actualCost; ok = true; } 
                } 

                if(ok) { 
                    // 2. Attribution de la r√©compense
                    // FIX: Les gains ne doivent pas √™tre soustraits
                    if(item.type==='gems') { 
                        USER.gems += item.val; 
                        this.notif(`+${item.val} üíé`, "#a855f7"); 
                        try { el('top-gems').closest('.currency-badge').classList.add('flash-gems'); setTimeout(() => el('top-gems').closest('.currency-badge').classList.remove('flash-gems'), 300); } catch(e){} 
                    } 
                    if(item.type==='coins') { 
                        USER.coins += item.val; 
                        this.notif(`+${item.val} ü™ô`, "#eab308"); 
                        try { el('top-coins').closest('.currency-badge').classList.add('flash-coins'); setTimeout(() => el('top-coins').closest('.currency-badge').classList.remove('flash-coins'), 300); } catch(e){} 
                    } 
                    if(item.type==='xp') { USER.pass.xp += item.val; this.notif(`+${item.val} XP`, "#facc15"); while(USER.pass.xp >= 100) { if(USER.pass.tier < 50) { USER.pass.tier++; USER.pass.xp -= 100; window.ui.notif("PASS LEVEL UP!", "#facc15"); } else { USER.pass.xp = 100; break; } } } 
                    if(item.type==='box') { this.buy('box', 0, 'free'); } 
                    if(item.type==='skin') { 
                        if(!USER.ownedSkins) USER.ownedSkins = []; 
                        const heroKey = Object.keys(STARTERS).find(k => STARTERS[k].name === item.hero); 
                        if(heroKey) { 
                            USER.ownedSkins.push(`${heroKey}_${item.skinId}`); 
                            this.notif(`SKIN ${item.name} OBTENU !`, "#facc15"); 
                        } 
                    } 
                    
                    // 3. Suppression de l'offre
                    USER.shop.items.splice(idx, 1); 
                    
                    Storage.save(); this.updateMenu(); this.renderShop(); this.renderPass(); 
                } else {
                    this.notif("PAS ASSEZ!", "#ef4444");
                }
            },
            buyPass(type) { 
                let cost = 0;
                let name = "";
                
                if (type === 'pro') { cost = 159; name = "mPASS PRO"; }
                else if (type === 'max') { cost = 199; name = "mPASS MAX"; }
                else if (type === 'upgrade') { cost = 40; name = "UPGRADE MAX"; }
                
                if(USER.gems >= cost) { 
                    console.log(`[SECURE] Buy Pass: ${type} (-${cost} gems)`);
                    USER.gems -= cost; 
                    if (type === 'pro') { USER.mPassPro = true; }
                    else if (type === 'max') { USER.mPassMax = true; USER.mPassPro = true; }
                    else if (type === 'upgrade') { USER.mPassMax = true; }
                    
                    this.notif(`${name} ACTIV√â !`, "#facc15"); 
                    el('top-gems').closest('.currency-badge').classList.add('flash-gems'); setTimeout(() => el('top-gems').closest('.currency-badge').classList.remove('flash-gems'), 300);
                    Storage.save(); 
                    this.updateMenu(); 
                    this.renderPass(); 
                } else { 
                    this.notif(`PAS ASSEZ DE GEMMES ! (${cost} üíé)`, "#ef4444"); 
                } 
            },
            claimPass(tier, type, rewardString) { 
                let allowed = false;
                let alreadyClaimed = false;
                
                if (type === 'free') { allowed = true; alreadyClaimed = USER.pass.claimed.includes(tier); }
                else if (type === 'pro') { allowed = USER.mPassPro || USER.mPassMax; alreadyClaimed = USER.pass.claimedPro.includes(tier); }
                else if (type === 'max') { allowed = USER.mPassMax; alreadyClaimed = USER.pass.claimedMax && USER.pass.claimedMax.includes(tier); }
                
                if(USER.pass.tier >= tier && allowed && !alreadyClaimed) { 
                    if (processPassReward(rewardString)) { 
                        if(type === 'free') USER.pass.claimed.push(tier);
                        else if(type === 'pro') USER.pass.claimedPro.push(tier);
                        else if(type === 'max') {
                             if(!USER.pass.claimedMax) USER.pass.claimedMax = [];
                             USER.pass.claimedMax.push(tier);
                        }
                        Storage.save(); 
                        this.renderPass(); 
                        this.updateMenu(); 
                    } else { 
                        this.notif("Erreur R√©compense", "#ff0000"); 
                    } 
                } 
            },
            openSettings() {
                el('settings-modal').classList.remove('hidden');
                // FIX: Clear default values to avoid "JoueurPSEUDO" or default bio concatenation
                el('setting-name').value = (USER.name === 'Joueur') ? '' : (USER.name || '');
                el('setting-email').value = USER.email || '';
                el('setting-phone').value = USER.phone || '';
                el('setting-dob').value = USER.dob || '';
                el('setting-bio').value = (USER.bio === 'Aucune bio d√©finie...') ? '' : (USER.bio || '');
                
                // Render Theme Selector in Settings
                const themeContainer = el('profile-theme-selector');
                themeContainer.innerHTML = '';
                const themes = ['blue', 'purple', 'green', 'red', 'yellow'];
                const themeColors = { blue: '#3b82f6', purple: '#a855f7', green: '#22c55e', red: '#ef4444', yellow: '#eab308' };
                
                themes.forEach(t => {
                     const isSelected = USER.theme === t;
                     const activeClass = isSelected ? 'ring-2 ring-white scale-110' : 'opacity-50 hover:opacity-100';
                     const locked = !USER.mPassPro && t !== 'blue'; // Example: Only Blue is free, others require Pro
                     const lockIcon = locked ? '<span class="absolute inset-0 flex items-center justify-center text-[8px]">üîí</span>' : '';
                     
                     themeContainer.innerHTML += `<div onclick="${locked ? "window.ui.notif('R√©serv√© mPASS PRO', '#a855f7')" : `USER.theme='${t}'; Storage.save(); window.ui.openSettings(); window.ui.renderProfile()`}" 
                     class="w-6 h-6 rounded-full cursor-pointer relative transition ${activeClass}" style="background-color: ${themeColors[t]}">${lockIcon}</div>`;
                });
                
                if (USER.mPassPro) el('theme-lock-icon').innerText = "D√âBLOQU√â";
                else el('theme-lock-icon').innerText = "Requis : mPass Pro";
            },
            saveSettings() {
                const name = el('setting-name').value;
                const bio = el('setting-bio').value;
                const email = el('setting-email').value;
                const phone = el('setting-phone').value;
                const dob = el('setting-dob').value;
                
                if(name) USER.name = name;
                if(bio !== undefined) USER.bio = bio;
                if(email !== undefined) USER.email = email;
                if(phone !== undefined) USER.phone = phone;
                if(dob !== undefined) USER.dob = dob;

                Storage.save();
                this.renderProfile();
                this.closeSettings();
                this.notif("PROFIL MIS √Ä JOUR !", "#22c55e");
            },
            closeSettings() {
                el('settings-modal').classList.add('hidden');
                this.renderProfile();
            },
            exportSave() { const data = btoa(JSON.stringify(USER)); navigator.clipboard.writeText(data).then(() => this.notif("CODE COPI√â !", "#22c55e")); },
            importSave() { 
                const code = prompt("Colle ton code de sauvegarde ici:"); 
                if(code) { 
                    try { 
                        const data = JSON.parse(atob(code)); 
                        // Simple structure check
                        if(data && data.name && data.coins !== undefined) {
                            USER = data; 
                            Storage.save(); 
                            location.reload(); 
                        } else {
                            this.notif("CODE INVALIDE !", "#ef4444");
                        }
                    } catch(e) { 
                        this.notif("CODE INVALIDE !", "#ef4444"); 
                    } 
                } 
            }
        };

        const Input={k:{},jL:{a:0,x:0,y:0,i:null},jR:{a:0,x:0,y:0,i:null},m:{x:0,y:0,d:0},init(){ 
            window.addEventListener('keydown',e=>{this.k[e.code]=1;if(e.code==='Space')window.game.player?.dash();if(e.code==='KeyE')window.game.player?.useGadget();if(e.code==='KeyV'){window.ui.toggleEmoteWheel();}}); 
            window.addEventListener('keyup',e=>this.k[e.code]=0); 
            window.addEventListener('mousemove',e=>{this.m.x=e.clientX;this.m.y=e.clientY;}); 
            window.addEventListener('mousedown',()=>this.m.d=1); 
            window.addEventListener('mouseup',()=>this.m.d=0); 
            const z=el('mobile-controls'); 
            const leftBase = el('stick-left-base');
            const rightBase = el('stick-right-base');
            
            // Calculate base centers for touch processing
            const getCenter = (el) => {
                const rect = el.getBoundingClientRect();
                return { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 };
            };

            const h=(e, isEnd)=>{ 
                if(e.target.tagName !== 'BUTTON') e.preventDefault(); 
                let lf=false, rf=false; 
                const W=window.innerWidth;
                const L_CENTER = getCenter(leftBase);
                const R_CENTER = getCenter(rightBase);

                for(let i=0;i<e.touches.length;i++){ 
                    const t=e.touches[i],x=t.clientX,y=t.clientY; 
                    
                    // Check if touch is near the left joystick area
                    if(Math.hypot(x - L_CENTER.x, y - L_CENTER.y) < 150) { 
                        lf=true; 
                        const d=Math.min(60, Math.hypot(x-L_CENTER.x, y-L_CENTER.y)); 
                        const a=Math.atan2(y-L_CENTER.y, x-L_CENTER.x); 
                        const k=document.querySelector('#stick-left-base .stick-knob'); 
                        if(k) k.style.transform=`translate(-50%,-50%) translate(${Math.cos(a)*d}px,${Math.sin(a)*d}px)`; 
                        if(d>5){ 
                            this.jL.x=Math.cos(a)*d/60; 
                            this.jL.y=Math.sin(a)*d/60; 
                            this.jL.a=1; 
                        } 
                    }
                    
                    // Check if touch is near the right joystick/action area
                    if(Math.hypot(x - R_CENTER.x, y - R_CENTER.y) < 150) { 
                        rf=true; 
                        const d=Math.min(60, Math.hypot(x-R_CENTER.x, y-R_CENTER.y)); 
                        const a=Math.atan2(y-R_CENTER.y, x-R_CENTER.x); 
                        const k=document.querySelector('#stick-right-base .stick-knob'); 
                        if(k) k.style.transform=`translate(-50%,-50%) translate(${Math.cos(a)*d}px,${Math.sin(a)*d}px)`; 
                        if(d>5){ 
                            this.jR.x=Math.cos(a)*d/60; 
                            this.jR.y=Math.sin(a)*d/60; 
                            this.jR.a=1; 
                        } 
                    }
                } 
                if(!lf){ 
                    this.jL.x=0;this.jL.y=0;this.jL.a=0; 
                    const k=document.querySelector('#stick-left-base .stick-knob'); 
                    if(k) k.style.transform=`translate(-50%,-50%)`; 
                } 
                if(!rf){ 
                    this.jR.x=0;this.jR.y=0;this.jR.a=0; 
                    const k=document.querySelector('#stick-right-base .stick-knob'); 
                    if(k) k.style.transform=`translate(-50%,-50%)`; 
                } 
            }; 
            z.addEventListener('touchstart',e=>h(e,false),{passive:false}); 
            z.addEventListener('touchmove',e=>h(e,false),{passive:false}); 
            z.addEventListener('touchend',e=>h(e,true)); 
        }
    };

    class Entity {
        constructor(x,y,r,c){
                this.x=x;this.y=y;this.r=r;this.c=c;this.dead=false; this.hitTimer = 300;
                this.emote = ''; this.emoteTimer = 0;
            } 
            triggerEmote(emoji) {
                this.emote = emoji;
                this.emoteTimer = 120;
            }
            draw(ctx){ ctx.save(); ctx.translate(this.x, this.y); let isHidden = false; if (window.game.map) { for(let w of window.game.map) { if(w.type === 1 && ColRect(this, w)) { isHidden = true; break; } } } if(isHidden && this === window.game.player) { ctx.fillStyle = 'rgba(255, 255, 255, 0.8)'; ctx.font = "20px Arial"; ctx.fillText("üëÅÔ∏è", -10, -this.r - 10); ctx.beginPath(); ctx.moveTo(-10, -this.r - 5); ctx.lineTo(10, -this.r - 25); ctx.strokeStyle = 'red'; ctx.lineWidth = 2; ctx.stroke(); } if(isHidden) ctx.globalAlpha = 0.5; ctx.shadowColor = 'rgba(0,0,0,0.5)'; ctx.shadowBlur = 15; ctx.beginPath(); ctx.arc(0, 0, this.r, 0, Math.PI*2); ctx.fillStyle = this.c; ctx.fill(); ctx.shadowBlur = 0; ctx.beginPath(); ctx.arc(-5, -5, this.r*0.3, 0, Math.PI*2); ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.fill(); ctx.globalAlpha = 1; if(this.emoteTimer > 0) { ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(0, -this.r - 30, 20, 0, Math.PI*2); ctx.fill(); ctx.font = "24px Arial"; ctx.fillStyle = 'black'; ctx.textAlign = 'center'; ctx.fillText(this.emote, 0, -this.r - 22); this.emoteTimer--; } ctx.restore(); }}
        class Flag extends Entity {
            constructor(team, x, y) {
                super(x, y, 15, team === 'blue' ? '#3b82f6' : '#ef4444');
                this.team = team;
                this.baseX = x; this.baseY = y;
                this.carrier = null;
                this.isHome = true;
                this.returnTimer = 0;
            }
            update() {
                if (this.carrier) {
                    if (this.carrier.dead) { this.drop(); }
                    else { this.x = this.carrier.x; this.y = this.carrier.y - 20; this.isHome = false; }
                } else {
                    if (!this.isHome) {
                        this.returnTimer--;
                        if (this.returnTimer <= 0) this.returnToBase();
                    }
                    let inRange = [window.game.player, ...window.game.ents].filter(e => !e.dead && Dist(this, e) < this.r + e.r && !(e instanceof Flag));
                    for (let e of inRange) {
                        let isFriend = (e.friend && this.team === 'blue') || (!e.friend && this.team === 'red');
                        if (!isFriend) { this.pickUp(e); break; }
                        else {
                            if (!this.isHome) { this.returnToBase(); break; }
                            else if (window.game.flags) { 
                                let other = window.game.flags.find(f => f.team !== this.team);
                                if (other && other.carrier === e) {
                                    if (this.team === 'blue') { 
                                        window.game.teamScore++; 
                                        window.ui.notif("POINT BLEU !", "#3b82f6"); 
                                    } else {
                                        window.game.enemyScore++;
                                        window.ui.notif("POINT ROUGE !", "#ef4444");
                                    }
                                    other.returnToBase(); 
                                    if(window.game.teamScore >= 3) window.game.over("VICTOIRE");
                                    if(window.game.enemyScore >= 3) window.game.over("D√âFAITE");
                                    break;
                                }
                            }
                        }
                    }
                }
            }
            drop() {
                this.carrier = null; this.returnTimer = 600;
                window.ui.notif(`DRAPEAU ${this.team==='blue'?'BLEU':'ROUGE'} TOMB√â !`, this.c);
            }
            pickUp(e) {
                if (this.carrier) return;
                this.carrier = e; this.isHome = false;
                window.ui.notif(`DRAPEAU LEV√â !`, this.c);
            }
            returnToBase() {
                this.x = this.baseX; this.y = this.baseY;
                this.carrier = null; this.isHome = true;
                window.ui.notif(`DRAPEAU ${this.team==='blue'?'BLEU':'ROUGE'} RETOURN√â !`, this.c);
            }
            draw(ctx) {
                ctx.save(); ctx.translate(this.x, this.y);
                ctx.fillStyle = 'white'; ctx.fillRect(-2, -30, 4, 30);
                ctx.fillStyle = this.c; ctx.beginPath(); ctx.moveTo(0, -30); ctx.lineTo(20, -20); ctx.lineTo(0, -10); ctx.fill();
                if (this.isHome) {
                    ctx.strokeStyle = this.c; ctx.globalAlpha = 0.3; ctx.lineWidth = 2;
                    ctx.beginPath(); ctx.arc(0, 0, 25, 0, Math.PI * 2); ctx.stroke();
                }
                ctx.restore();
            }
        }
        class Wall{constructor(x,y,w,h,t){this.x=x;this.y=y;this.w=w;this.h=h;this.type=t;} draw(ctx,c){ 
            // Ambiance ombre sous les murs
            ctx.save();
            ctx.fillStyle = '#0f172a'; ctx.fillRect(this.x, this.y + this.h, this.w, 20); // Ombre port√©e
            ctx.fillStyle = c; 
            ctx.shadowColor = 'black'; ctx.shadowBlur = 10; 
            ctx.fillRect(this.x, this.y, this.w, this.h); 
            ctx.shadowBlur = 0; 
            ctx.fillStyle = 'rgba(255,255,255,0.05)'; 
            ctx.fillRect(this.x, this.y, this.w, 5);
            ctx.restore();
            
            if(this.type===1){
                ctx.fillStyle='rgba(34,197,94,0.9)';
                ctx.strokeStyle='#15803d';ctx.lineWidth=4;ctx.strokeRect(this.x,this.y,this.w,this.h);
                // Rendu des buissons plus vifs
                ctx.fillStyle='rgba(34,197,94,0.7)';
                ctx.fillRect(this.x,this.y,this.w,this.h);
                return;
            } 
            const h = 20; 
            ctx.fillStyle = '#0f172a'; 
            ctx.fillRect(this.x, this.y + this.h, this.w, h); 
            ctx.fillStyle = c; 
            ctx.shadowColor = 'black'; 
            ctx.shadowBlur = 10; 
            ctx.fillRect(this.x, this.y, this.w, this.h); 
            ctx.shadowBlur = 0; 
            ctx.fillStyle = 'rgba(255,255,255,0.05)'; 
            ctx.fillRect(this.x, this.y, this.w, 5); 
        } 
        collide(e){return e.x+e.r>this.x&&e.x-e.r<this.x+this.w&&e.y+e.r>this.y&&e.y-e.r<this.y+this.h;}}
        class Player extends Entity{ constructor(k){ 
            const s=STARTERS[k], l=(USER.levels[k]||1)-1; 
            let c = s.color; 
            if(USER.skins && USER.skins[k]) { const skinId = USER.skins[k]; const heroSkinList = STARTERS[k]?.skins; if(skinId !== 'default' && heroSkinList) { const skinObj = heroSkinList.find(sk => sk.id === skinId); if(skinObj) c = skinObj.c; } } 
            super(window.game.world/2,window.game.world/2,20,c); 
            this.stats={...s}; 
            this.stats.hp+=s.scale.hp*l; 
            this.stats.dmg+=s.scale.dmg*l; 
            this.hp=this.stats.hp; 
            this.maxHp=this.stats.hp; 
            this.xp=0;this.xpMax=100;this.lvl=1;this.super=0;this.cd=0;this.dashT=0;this.angle=0;
            this.friend = true; 
            this.ammo=s.ammo;
            this.ammoMax=s.ammo;
            this.reloadT=0;this.gadgetCharges=3;this.cubes=0; 
            this.activeEffects={}; 
            this.isStunned = 0;
            this.passiveTimer = 0; // Timer pour les passifs p√©riodiques (Shaman)
            this.hitTimer = 300;

            if(window.game.conf.modifier === 'giant') { this.r *= 2; this.maxHp *= 2; this.hp *= 2; }
            if(window.game.conf.modifier === 'oneshot') { this.hp = 1; this.maxHp = 1; } // Force One Shot HP
            this.invisible = 0; // New Invisible state
        } 
        update(){ 
            if (this.isStunned > 0) { this.isStunned--; return; } // Stunned = skip update
            this.hitTimer++; // Incr√©menter le timer de non-hit
            
            // Slow Mo Logic
            const mod = window.game.activeModifier || window.game.conf.modifier;
            const timeScale = mod === 'slow_mo' ? 0.5 : 1.0;

            let speedMult = 1; 
            if(this.activeEffects.speed > 0) { speedMult = 1.5; this.activeEffects.speed--; } 
            if(mod === 'speed') speedMult *= 2; 

            // R√©g√©n√©ration HP apr√®s 5s sans d√©g√¢ts (hitTimer > 300 frames)
            if(this.stats.passive === "Regen Rapide" && window.game.frame % 60 === 0 && this.hitTimer > 300 && mod !== 'oneshot') {
                this.hp = Math.min(this.maxHp, this.hp + 50); 
            }
            
            let dx=0,dy=0; 
            if(Input.jL.a){dx=Input.jL.x;dy=Input.jL.y;} else {if(Input.k['KeyW'])dy=-1;if(Input.k['KeyS'])dy=1;if(Input.k['KeyA'])dx=-1;if(Input.k['KeyD'])dx=1;} 
            const l=Math.hypot(dx,dy); 
            // Vitesse de base ajust√©e (base 5.5, ici *1.1 pour un meilleur feeling global)
            const actualSpd = this.stats.spd * speedMult * 1.1 * timeScale; 

            if(l>0.1){if(l>1){dx/=l;dy/=l;} this.move(dx*actualSpd, dy*actualSpd); 
                // Nouvelle fonctionnalit√©: Tra√Æn√©e de mouvement (Particules)
                if (window.game.frame % 2 === 0) {
                    window.game.parts.push({ x: this.x, y: this.y, vx: -dx * 0.5, vy: -dy * 0.5, life: 10, c: this.c, r: 2 });
                }
            } 
            
            if(Input.jR.a){this.angle=Math.atan2(Input.jR.y,Input.jR.x);if(Math.hypot(Input.jR.x,Input.jR.y)>0.5)this.shoot();} 
            else {const wx=Input.m.x+window.game.cam.x, wy=Input.m.y+window.game.cam.y;this.angle=Math.atan2(wy-this.y,wx-this.x);if(Input.m.d)this.shoot();} 
            
            if(this.cd>0)this.cd--; 
            if(this.dashT>0)this.dashT--; 

            // PASSIVE DU SHAMAN : Poison Aura (Feature 2)
            if (this.stats.passive === "Poison Aura") {
                this.passiveTimer++;
                if (this.passiveTimer >= 30) { // Toutes les 0.5 secondes
                    this.passiveTimer = 0;
                    window.game.ents.forEach(e => {
                        if (!e.friend && Dist(this, e) < 150) {
                            e.hp -= 5;
                            e.hitTimer = 0;
                            e.flashColor = '#10b981'; e.flashTimer = 5;
                            window.game.parts.push({x:e.x,y:e.y,vx:Rnd(-2,2),vy:Rnd(-2,2),life:10,c:'#10b981',r:2});
                            if(e.hp<=0 && !e.dead) window.game.kill(e);
                        }
                    });
                }
            }

            if(this.ammo<this.ammoMax){this.reloadT++;if(this.reloadT>this.stats.reload){this.ammo++;this.reloadT=0;}} 
            // R√©g√©n√©ration g√©n√©rale apr√®s 5s sans d√©g√¢ts
            if(window.game.frame%60===0 && this.hp<this.maxHp && this.hitTimer > 300 && window.game.conf.modifier !== 'oneshot') this.hp+=this.maxHp*0.05; 
            
            if(window.game.gasRadius && Dist(this, {x:window.game.world/2, y:window.game.world/2}) > window.game.gasRadius) { this.hp -= 10; this.hitTimer = 0; window.ui.flash(); if(this.hp<=0) window.game.over("Tu√© par le Gaz"); } 
            if(this.activeEffects.poison > 0) { this.hp -= 1; this.activeEffects.poison--; this.hitTimer = 0; if(this.hp<=0) window.game.over("Empoisonn√©"); } 
        } move(dx,dy){const nx=this.x+dx,ny=this.y+dy;let cx=0,cy=0;for(let w of window.game.map){if(w.type===1)continue;if(w.collide({x:nx,y:this.y,r:this.r}))cx=1;if(w.collide({x:this.x,y:ny,r:this.r}))cy=1;}if(!cx)this.x=Math.max(this.r,Math.min(window.game.world-this.r,nx));if(!cy)this.y=Math.max(this.r,Math.min(window.game.world-this.r,ny));} shoot(){ 
            // FIX: Define timeScale from modifier (ReferenceError Fix)
            const mod = window.game.activeModifier || window.game.conf.modifier;
            const timeScale = mod === 'slow_mo' ? 0.5 : 1.0;
            window.game.shake = 2;
            if(SoundManager) SoundManager.play('shoot');
            const selectedHero = STARTERS[USER.selected];
            if (selectedHero.name === 'Harpy' && this.cd > 0) {
                 // Harpy a un CD tr√®s court (7), pas besoin de bloquer s'il est bas
            } else if(this.cd>0 || (this.ammo<1 && window.game.conf.modifier !== 'infinite')) {
                return;
            } 

            const pStats = selectedHero.proj;
            
            // Les h√©ros au corps-√†-corps ont une gestion sp√©ciale du CD et des munitions
            if (selectedHero.type === 'melee') {
                this.cd = this.stats.rate; 
                // Le projectile corps-√†-corps a une vie tr√®s courte (1 frame)
                window.game.projs.push({
                    x: this.x + Math.cos(this.angle) * 25, y: this.y + Math.sin(this.angle) * 25,
                    vx: 0, vy: 0, dmg: this.stats.dmg * (1 + this.cubes * 0.1), life: 3,
                    r: pStats.r, c: pStats.color, friend: true, shape: pStats.shape, trailColor: pStats.trailColor, melee: true
                });
                return;
            }

            this.cd = this.stats.rate; 
            if(window.game.conf.modifier !== 'infinite') this.ammo--; 
            this.reloadT = -20; 
            
            const cnt = selectedHero.type === 'shotgun' ? 5 : 1; 
            const spr = selectedHero.type === 'shotgun' ? 0.3 : 0.05; // Spread uniquement pour les shotguns
            
            let dmg = this.stats.dmg * (1 + this.cubes * 0.1);
            let isCrit = this.stats.passive === "Critique +10%" && Math.random() < 0.1;

            if (isCrit) {
                dmg *= 1.5; // D√©g√¢ts critiques +50%
            }
            
            if(window.game.conf.modifier === 'recoil') { this.move(Math.cos(this.angle + Math.PI) * 15, Math.sin(this.angle + Math.PI) * 15); }

            for(let i=0;i<cnt;i++){ 
                const a=this.angle+(Math.random()-0.5)*spr+(i-(cnt-1)/2)*0.1;
                
                window.game.projs.push({
                    x: this.x + Math.cos(this.angle) * 25,
                    y: this.y + Math.sin(this.angle) * 25,
                    vx: Math.cos(a) * pStats.speed,
                    vy: Math.sin(a) * pStats.speed,
                    dmg: dmg,
                    life: pStats.life,
                    r: pStats.r,
                    c: pStats.color,
                    friend: true, 
                    isCrit: isCrit,
                    shape: pStats.shape, // NOUVEAU
                    trailColor: pStats.trailColor // NOUVEAU
                }); 
            } 
            
            // Muzzle Flash
            const muzzleX = this.x + Math.cos(this.angle)*25;
            const muzzleY = this.y + Math.sin(this.angle)*25;
            for(let i=0; i<5; i++) {
                 window.game.parts.push({
                     x: muzzleX, y: muzzleY, 
                     vx: Math.cos(this.angle+Rnd(-0.5,0.5))*3, 
                     vy: Math.sin(this.angle+Rnd(-0.5,0.5))*3, 
                     life: 8, c: '#fff', r: Rnd(2,5), decay: 0.5, shape: 'spark', angle: this.angle, vRot: 0
                 });
            }
        } dash(){ if(this.dashT>0)return; this.dashT=60; window.game.shake=10; const stepSize = 20; const totalDist = 180; const steps = totalDist / stepSize; const dx = Math.cos(this.angle) * stepSize; const dy = Math.sin(this.angle) * stepSize; for(let i=0; i<steps; i++) { this.move(dx, dy); } for(let i=0;i<8;i++)window.game.parts.push({x:this.x,y:this.y,vx:(Math.random()-0.5)*5,vy:(Math.random()-0.5)*5,life:20,c:'#fff',r:4, gravity:false}); } useGadget() { 
            if(this.gadgetCharges <= 0) return; 
            this.gadgetCharges--; 
            window.ui.notif("GADGET!", "#22c55e"); 
            const t=this.stats.gadget; 
            
            if(t==="heal") { 
                if(window.game.conf.modifier === 'oneshot') { window.ui.notif("SOIN IMPOSSIBLE (ONE SHOT)", "#ef4444"); this.gadgetCharges++; return; }
                this.hp=Math.min(this.maxHp,this.hp+1000); for(let i=0;i<10;i++)window.game.parts.push({x:this.x,y:this.y,vx:Rnd(-2,2),vy:Rnd(-2,2),life:30,c:'#22c55e',r:3}); 
            } 
            if(t==="shield") { 
                if(window.game.conf.modifier === 'oneshot') { window.ui.notif("BOUCLIER IMPOSSIBLE", "#ef4444"); this.gadgetCharges++; return; }
                this.maxHp+=1000; this.hp+=1000; 
            } 
            if(t==="teleport") { let tx=this.x+Math.cos(this.angle)*300, ty=this.y+Math.sin(this.angle)*300; let cx=false; for(let w of window.game.map){ if(w.type!==1 && w.collide({x:tx,y:ty,r:this.r})) cx=true; } if(!cx) { this.x=tx; this.y=ty; } else window.ui.notif("BLOQU√â !", "#ef4444"); } 
            if(t==="speed") { this.activeEffects.speed = 180; } 
            if(t==="knockback") { for(let e of window.game.ents) { let d = Dist(this, e); if(d < 300) { let a = Math.atan2(e.y-this.y, e.x-this.x); e.x += Math.cos(a)*200; e.y += Math.sin(a)*200; } } } 
            // Feature 8: Nouveau Gadget 'stun'
            if(t==="stun") {
                for(let e of window.game.ents) {
                    if(Dist(this, e) < 300) { 
                        e.isStunned = 120; 
                        e.flashColor = '#facc15'; e.flashTimer = 10;
                        window.game.parts.push({x:e.x,y:e.y,vx:Rnd(-2,2),vy:Rnd(-2,2),life:30,c:'#facc15',r:5}); 
                    }
                }
            }
            if(t==="turret") { window.game.ents.push(new Turret(this.x, this.y, true)); window.ui.notif("TOURELLE D√âPLOY√âE", "#fbbf24"); }
            if(t==="dash") { this.dashT = 0; this.dash(); }
            if(t==="invis") { this.invisible = 180; window.ui.notif("INVISIBLE !", "#94a3b8"); }
        } draw(ctx){ 
            ctx.save(); 
            ctx.shadowColor = this.c; ctx.shadowBlur = 20; 
            
            // Si le joueur est stun, montrer un effet visuel
            if (this.isStunned > 0) {
                 ctx.shadowColor = '#facc15'; 
                 ctx.shadowBlur = 30;
            }
            if (this.invisible > 0) ctx.globalAlpha = 0.4; else ctx.globalAlpha = 1;
            
            super.draw(ctx); 
            ctx.translate(this.x,this.y); 
            ctx.rotate(this.angle); 
            ctx.fillStyle = (USER.equippedWeaponSkin === 'gold') ? '#eab308' : ((USER.equippedWeaponSkin === 'magma') ? '#ef4444' : '#1e293b'); 
            ctx.fillRect(10,-6,28,12); 
            if(this.reloadT > 0 && window.game.conf.modifier !== 'infinite') { 
                ctx.rotate(-this.angle); 
                ctx.fillStyle = 'white'; 
                ctx.fillRect(-15, 30, 30 * (this.reloadT/this.stats.reload), 3); 
            } 
            ctx.restore(); 
        } }
        class Bot extends Player{ 
            constructor(isFriendly = false, heroType = null){ 
                super(heroType || (USER.selected==='soldier'?'tank':'soldier')); 
                this.c= isFriendly ? '#3b82f6' : '#ef4444'; 
                this.isBot=true; 
                this.friend = isFriendly;
                this.x=100; 
                this.y=100; 
                this.mode='CHASE'; 
                this.target=null; 
                this.isStunned = 0; 
                this.hitTimer = 300; 
                this.hp += ENEMY_HP_BUFF;
                this.maxHp += ENEMY_HP_BUFF;
                
                const diffMult = DIFFICULTY[window.game.conf.difficulty].mult;
                this.hp *= diffMult;
                this.maxHp *= diffMult;
                this.stats.dmg *= diffMult;
                this.stats.spd *= (1 + (diffMult - 1) * 0.3);

                if(window.game.conf.modifier === 'oneshot') { this.hp = 1; this.maxHp = 1; }
            } 
            update(){ 
                if (this.isStunned > 0) { this.isStunned--; return; }
                this.hitTimer++;
                
                // Bot Random Emote Logic
                if (Math.random() < 0.002) { // 0.2% chance per frame (approx once every 8-10 seconds)
                    const happyEmotes = ['üòÄ', 'üòé', 'üëç', 'üí™', 'üëë', 'üòÇ', 'üëª', 'ü§ñ'];
                    const em = happyEmotes[Math.floor(Math.random() * happyEmotes.length)];
                    this.triggerEmote(em);
                }

                if(this.cd>0)this.cd--; 
                
                // Logic Target Selection
                let target = null;
                if (!this.friend) {
                    // Enemy Bot Target Selection (Player or Friendly Bots)
                    let maxDist = 9999;
                    // Check dist to player
                    if (window.game.player && !window.game.player.dead) {
                        const d = Dist(this, window.game.player);
                        target = window.game.player;
                        maxDist = d;
                    }
                    // Check dist to friendly bots
                    window.game.ents.forEach(e => {
                        if (e.friend && e !== window.game.player && !e.dead) {
                            const d = Dist(this, e);
                            if (d < maxDist) {
                                maxDist = d;
                                target = e;
                            }
                        }
                    });
                } else {
                     let minD = 500;
                    window.game.ents.forEach(e => {
                        if ((!e.friend || (e.isBot && !e.friend) || (e.type && typeof e.type === 'string' && e.type.match(/basic|fast|tank|boss|mini_boss/))) && !e.dead && e !== this) {
                            // Friendly bot targeting enemy
                            if (this.friend && !e.friend) {
                                const d = Dist(this, e);
                                if (d < minD) { minD = d; target = e; }
                            }
                            // Enemy bot targeting friendlies (Player or Friendly Bots)
                            else if (!this.friend && e.friend) {
                                const d = Dist(this, e);
                                if (d < minD) { minD = d; target = e; }
                            }
                        }
                    });
                    
                    if (!target && this.friend) { // If friendly bot has no enemy target, chase player
                        if (window.game.player && !window.game.player.dead) {
                            target = window.game.player;
                        }
                    }
                }

                // AI OBJECTIVE OVERRIDE
                if (window.game.conf.mode === 'ctf' && window.game.flags) {
                     const myTeam = this.friend ? 'blue' : 'red';
                     const enemyTeam = this.friend ? 'red' : 'blue';
                     const myFlag = window.game.flags.find(f => f.team === myTeam);
                     const enemyFlag = window.game.flags.find(f => f.team === enemyTeam);
                     
                     if (enemyFlag && enemyFlag.carrier === this) {
                         // I have the flag! Return to base! Target is my flag base (implicit via start pos)
                         // Blue Base ~ (100,100), Red Base ~ (World-100, World-100)
                         target = {x: (this.friend ? 200 : window.game.world-200), y: (this.friend ? 200 : window.game.world-200), r: 10}; 
                     } else if (myFlag && myFlag.carrier) {
                         // Enemy has my flag! Chase him! priority over other targets
                         target = myFlag.carrier;
                     } else if (enemyFlag && !enemyFlag.carrier) {
                         // Enemy flag is available! Go get it!
                         // Only switch if we don't have a critical target close by
                         if (!target || Dist(this, target) > 300) target = enemyFlag;
                     } else if (myFlag && !myFlag.isHome && !myFlag.carrier) {
                         // My flag is dropped! Go return it!
                         target = myFlag;
                     }
                } else if (window.game.conf.mode === 'payload' && window.game.train) {
                     // Stay near payload
                     if (Dist(this, window.game.train) > 200) {
                         target = window.game.train;
                     }
                }
                
                if (!target) return; // No target, do nothing (or wander)

                const d=Dist(this,target); 
                this.angle=Math.atan2(target.y-this.y,target.x-this.x); 
                
                let targetHidden = false; 

                const distV = Math.hypot(target.x - this.x, target.y - this.y);
                const stepsV = Math.min(10, Math.floor(distV / 50));
                for(let i = 1; i < stepsV; i++) {
                    const cx = this.x + (target.x - this.x) * (i / stepsV);
                    const cy = this.y + (target.y - this.y) * (i / stepsV);
                    for(let w of window.game.map) {
                        if(w.type !== 1 && ColRect({x:cx, y:cy, r:5}, w)) {
                            targetHidden = true;
                            break;
                        }
                    }
                    if(targetHidden) break;
                } 

                if (target.invisible > 0) targetHidden = true;
                
                // Logique de tir
                if(d < 500 && !targetHidden && this.cd <= 0) {
                    this.shoot();
                } else if(this.mode === 'CHASE' && Math.random()<0.05 && d < 600) {
                    this.shoot();
                }
                
                let tx,ty; 
                if(this.mode==='CHASE'){ 
                    let strafe = Math.sin(window.game.frame * 0.08) * 150; 
                    tx = target.x + Math.cos(this.angle + Math.PI/2) * strafe; 
                    ty = target.y + Math.sin(this.angle + Math.PI/2) * strafe; 
                } else if(this.mode==='CHASE_TRAIN') {
                    tx = this.target.x; ty = this.target.y; // Warning: this.target might be different logic in subclasses, keeping for safety
                } else { 
                    if(window.game.conf.mode === 'duel') { 
                        if(!this.target || Dist(this,this.target)<50) this.target={x:window.game.world/2 + Rnd(-300,300), y:window.game.world/2 + Rnd(-300,300)};
                    } else {
                        let item = window.game.items.find(i => Dist(this, i) < 300); 
                        if(item) { this.target = item; } 
                        else if(!this.target || Dist(this,this.target)<50 || Math.random()<0.02) { this.target={x:Rnd(100,window.game.world-100), y:Rnd(100,window.game.world-100)}; }
                    }
                    tx=this.target?.x || this.x; ty=this.target?.y || this.y; 
                } 
                const a=Math.atan2(ty-this.y, tx-this.x); 
                let speed = this.stats.spd * 0.96;
                const mod = window.game.activeModifier || window.game.conf.modifier; 
                if(mod === 'speed') speed *= 2;
                if(mod === 'slow_mo') speed *= 0.5;
                
                this.move(Math.cos(a)*speed, Math.sin(a)*speed); 
                if(Math.random()<0.01) this.dash(); 
                if(window.game.frame%60===0 && this.hp<this.maxHp && this.hitTimer > 300 && window.game.conf.modifier !== 'oneshot')this.hp += Math.max(1, Math.floor(this.maxHp * 0.01)); 
                if(window.game.gasRadius && Dist(this, {x:window.game.world/2, y:window.game.world/2}) > window.game.gasRadius) this.hp -= 10; 
                if(this.activeEffects.poison > 0) { this.hp -= 1; this.activeEffects.poison--; } 
            } 
            shoot(){ 
                if(this.cd>0)return; 
                this.cd=Math.ceil(20 * RATE_FACTOR); 
                window.game.projs.push({x:this.x,y:this.y,vx:Math.cos(this.angle)*15*1.08,vy:Math.sin(this.angle)*15*1.08,dmg:10,life:60,r:6,c:this.c,friend:this.friend, shape: 'circle', trailColor: this.c});
            } 
        }
        class Turret extends Entity {
            constructor(x, y, isFriendly) {
                super(x, y, 15, isFriendly ? '#10b981' : '#ef4444');
                this.friend = isFriendly;
                this.type = 'turret';
                this.hp = 800; this.maxHp = 800;
                this.cd = 0;
                this.life = 900; // 15 seconds
                this.angle = 0;
            }
            update() {
                this.life--;
                if(this.life <= 0) { this.hp = 0; return; }
                if(this.cd > 0) this.cd--;
                
                let target = null;
                let minD = 400;
                for(let e of window.game.ents) {
                    if(e !== this && !e.dead) {
                        const isEnemy = this.friend ? (!e.friend || (e.isBot && !e.friend) || (e.type && typeof e.type === 'string' && e.type.match(/basic|fast|tank|boss|mini_boss/))) : (e.friend);
                        if(isEnemy) {
                            const d = Dist(this, e);
                            if(d < minD) { minD = d; target = e; }
                        }
                    }
                }
                
                if(target) {
                    this.angle = Math.atan2(target.y - this.y, target.x - this.x);
                    if(this.cd <= 0) this.shoot();
                } else {
                    this.angle += 0.05; // Scan
                }
            }
            shoot() {
                this.cd = 15;
                window.game.projs.push({
                    x: this.x + Math.cos(this.angle)*20, y: this.y + Math.sin(this.angle)*20,
                    vx: Math.cos(this.angle) * 18, vy: Math.sin(this.angle) * 18,
                    dmg: 12, life: 60, r: 5, c: this.friend ? '#34d399' : '#f87171', friend: this.friend, shape: 'circle', trailColor: this.friend ? '#10b981' : '#ef4444'
                });
            }
            draw(ctx) {
                ctx.save();
                ctx.translate(this.x, this.y);
                // Tripod legs
                ctx.fillStyle = '#1e293b';
                for(let i=0; i<3; i++) {
                    ctx.save(); ctx.rotate(i * (Math.PI*2/3)); 
                    ctx.fillRect(-2, 0, 4, 20);
                    ctx.restore();
                }
                // Head
                ctx.rotate(this.angle);
                ctx.fillStyle = '#334155';
                ctx.fillRect(-10, -10, 20, 20); // Base
                ctx.fillStyle = this.c;
                ctx.fillRect(0, -6, 24, 12); // Barrel
                ctx.beginPath(); ctx.arc(0, 0, 8, 0, Math.PI*2); ctx.fill(); // Top
                ctx.restore();
                
                // Life bar
                const lp = this.hp / this.maxHp;
                ctx.fillStyle = 'red'; ctx.fillRect(this.x-15, this.y-25, 30, 4);
                ctx.fillStyle = '#0f0'; ctx.fillRect(this.x-15, this.y-25, 30*lp, 4);
            }
        }
        class Enemy extends Entity{ constructor(t,m=1){ const diffMult = DIFFICULTY[window.game.conf.difficulty].mult; const enemyMult = m * diffMult; super(0,0,20,'#ef4444'); let safe=false; while(!safe){ this.x=Rnd(100,window.game.world-100);this.y=Rnd(100,window.game.world-100); let wallCol = false; for(let w of window.game.map) { if(w.type!==1 && w.collide({x:this.x, y:this.y, r:this.r})) wallCol=true; } if(!wallCol && Dist(this,window.game.player)>600) safe=true; } this.type=t; this.friend = false; let hp=60,s=2.0, dmg=1; 
            // Vitesse des ennemis ajust√©e par le facteur global
            s = s * SPEED_FACTOR;
            
            // Feature 1: Mini-Boss stats pour vagues 3 et 6
            if(t==='fast'){hp=40;s=4.0 * SPEED_FACTOR;this.c='#f97316';this.r=15;} 
            if(t==='tank'){hp=200;s=1.2 * SPEED_FACTOR;this.c='#7e22ce';this.r=30;} 
            if(t==='mini_boss'){hp=1000;s=2.5 * SPEED_FACTOR;this.c='#facc15';this.r=40;this.isBoss=true;this.cd=Math.ceil(100*RATE_FACTOR); dmg=2; this.name = "MINI BOSS";}
            if(t==='boss'){hp=5000;s=1.5 * SPEED_FACTOR;this.c='#dc2626';this.r=60;this.isBoss=true;this.cd=Math.ceil(0*RATE_FACTOR); dmg=3;} 
            if(t==='chest'){hp=5000;s=0;this.c='#facc15';this.r=40;this.isBoss=true;} 
            if(t==='train'){hp=10000;s=1.0 * SPEED_FACTOR;this.c='#3b82f6';this.r=30;this.type='train';} 
            if(t==='terminal'){hp=5000;s=0;this.c='#22d3ee';this.r=40;this.type='terminal';}

            // AJOUT: +20PV de base aux ennemis/bots
            hp += ENEMY_HP_BUFF;

            if(window.game.conf.modifier === 'giant') { this.r *= 2; hp *= 2; s *= 0.8; }
            if(window.game.conf.modifier === 'oneshot') { hp = 1; }

            this.hp=hp * enemyMult; 
            
            // Apply Speed Scaling specifically for difficulty (since enemyMult handles HP/DMG based on diffMult)
            // Note: enemyMult = m * diffMult. 
            // So hp and dmg are already scaled by diffMult.
            // But 's' (speed) was not.
            const diffSpeedMult = 1 + (diffMult - 1) * 0.3;
            
            this.maxHp=this.hp; 
            this.spd=s * 0.85 * diffSpeedMult; 
            this.baseDmg = dmg * enemyMult; 
            // Application du facteur de tir sur le CD
            this.cd = Math.ceil((100 + Math.random() * 100) * RATE_FACTOR); 
            
            if(this.isBoss) this.name = t === 'boss' ? 'BOSS' : (t === 'mini_boss' ? 'MINI BOSS' : (t === 'chest' ? 'COFFRE' : t.toUpperCase())); else this.name = `Bot n¬∞${Math.floor(Math.random() * 89999) + 10000}`; this.activeEffects = {}; 
            this.isStunned = 0; // Ajout du stun
            this.flashTimer = 0; // Timer pour le flash de d√©g√¢t
            this.flashColor = null; // Couleur du flash
            this.hitTimer = 300; // FIX 2: Timer de r√©g√©n√©ration
        } 
        update(){ 
            if (this.isStunned > 0) { this.isStunned--; return; } // Stunned = skip update
            this.hitTimer++; // Incr√©menter le timer de non-hit

            if(this.spd === 0) return; const p=window.game.player; 
            let sepX = 0, sepY = 0; 
            for(let other of window.game.ents) { 
                if(other !== this) { 
                    let d = Dist(this, other); 
                    if(d < this.r * 2.5 && d > 0) { 
                        let ang = Math.atan2(this.y - other.y, this.x - other.x); 
                        sepX += Math.cos(ang); sepY += Math.sin(ang); 
                    } 
                } 
            } 
            
            if (this.type === 'basic' || this.type === 'fast' || this.type === 'tank' || this.type === 'mini_boss' ) { 
                if (this.cd > 0) this.cd--; 
                // IA 2.0 : Attaque les ennemis proches s'ils sont √† port√©e
                if (this.cd <= 0 && Dist(this, p) < 400) { 
                    const a = Math.atan2(p.y - this.y, p.x - this.x); 
                    window.game.projs.push({ x: this.x, y: this.y, vx: Math.cos(a) * 3 * 1.08, vy: Math.sin(a) * 3 * 1.08, dmg: 10 * DIFFICULTY[window.game.conf.difficulty].mult, life: 100, r: 6, c: this.c, friend: false, shape: 'circle', trailColor: this.c }); 
                    this.cd = Math.ceil(150 * RATE_FACTOR); 
                } 
            } 

            if(this.type === 'boss' || this.type === 'mini_boss') { 
                const d = Dist(this, p); 
                const a = Math.atan2(p.y - this.y, p.x - this.x); 
                // Boss Movement with Slow Mo Support
                let bossSpd = this.spd;
                const mod = window.game.activeModifier || window.game.conf.modifier;
                if(mod === 'speed') bossSpd *= 2;
                if(mod === 'slow_mo') bossSpd *= 0.5;

                this.x += Math.cos(a) * bossSpd; 
                this.y += Math.sin(a) * bossSpd; 
                if(this.cd > 0) this.cd--; 
                if(this.cd <= 0 && d < 800) { 
                    this.cd = Math.ceil(60 * RATE_FACTOR); 
                    window.game.projs.push({ x: this.x, y: this.y, vx: Math.cos(a) * 2.5 * 1.08, vy: Math.sin(a) * 2.5 * 1.08, dmg: 40 * DIFFICULTY[window.game.conf.difficulty].mult, life: 200, r: 20, c: '#ef4444', friend: false, shape: 'circle', trailColor: '#dc2626' }); 
                } 
            } else { 
                let playerHidden = false; 
                // Fix Vision
                const distV = Math.hypot(p.x - this.x, p.y - this.y);
                const stepsV = Math.min(10, Math.floor(distV / 50));
                for(let i = 1; i < stepsV; i++) {
                    const cx = this.x + (p.x - this.x) * (i / stepsV);
                    const cy = this.y + (p.y - this.y) * (i / stepsV);
                    for(let w of window.game.map) {
                        if(w.type !== 1 && ColRect({x:cx, y:cy, r:5}, w)) {
                            playerHidden = true;
                            break;
                        }
                    }
                    if(playerHidden) break;
                }
                if (window.game.player.invisible > 0) playerHidden = true; // Enemy can't see invisible player
                
                let tx, ty; 
                if(playerHidden && Dist(this, p) > 150) { 
                    if(!this.target || Dist(this,this.target)<50 || Math.random()<0.01) this.target={x:Rnd(100,window.game.world-100), y:Rnd(100,window.game.world-100)}; 
                    tx=this.target.x; ty=this.target.y; 
                } else { 
                    tx=p.x; ty=p.y; 
                } 
                const a=Math.atan2(ty-this.y, tx-this.x); 
                let speed = this.spd;
                const mod = window.game.activeModifier || window.game.conf.modifier;
                if(mod === 'speed') speed *= 2;
                if(mod === 'slow_mo') speed *= 0.5; 
                let mx = Math.cos(a)*speed + sepX*0.5; 
                let my = Math.sin(a)*speed + sepY*0.5; 
                const nx=this.x+mx, ny=this.y+my; 
                let cx=false, cy=false; 
                for(let w of window.game.map){if(w.type===1)continue; if(w.collide({x:nx,y:this.y,r:this.r}))cx=true;if(w.collide({x:this.x,y:ny,r:this.r}))cy=true;} 
                if(!cx)this.x=nx;if(!cy)this.y=ny; 
            } 
            if(Math.hypot(this.x-p.x,this.y-p.y)<this.r+p.r){
                let dmg = this.baseDmg;
                if(window.game.conf.modifier === 'fragile') dmg *= 2; // Fragile = Double D√©g√¢ts subis
                p.hp -= dmg; 
                p.hitTimer = 0; window.ui.flash();if(window.game.conf.modifier === 'oneshot') p.hp = 0; if(p.hp<=0)window.game.over("Tu√© par "+this.name);
            } 
            if(this.activeEffects.poison > 0) { this.hp -= 1; this.activeEffects.poison--; this.hitTimer = 0; } 
            
            // FIX 2: R√©g√©n√©ration HP apr√®s 5s sans d√©g√¢ts
            if(window.game.frame%60===0 && this.hp<this.maxHp && this.hitTimer > 300 && window.game.conf.modifier !== 'oneshot') this.hp += Math.max(1, Math.floor(this.maxHp * 0.01));

            if (this.flashTimer > 0) this.flashTimer--;
        } 
        draw(ctx){ 
            if(this.flashTimer > 0 && this.flashColor) {
                ctx.save();
                ctx.globalAlpha = 0.8;
                ctx.fillStyle = this.flashColor;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.r * 1.2, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }

            if(this.isBoss){
                ctx.beginPath();ctx.arc(this.x,this.y,this.r+5,0,Math.PI*2);
                ctx.strokeStyle=this.type==='chest'?'#facc15':'#ef4444';
                ctx.setLineDash([5,5]);ctx.stroke();ctx.setLineDash([]);
            } 
            super.draw(ctx); 
            const pct=this.hp/this.maxHp; 
            ctx.save(); 
            ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(this.x-20,this.y-this.r-15,40,6); 
            ctx.fillStyle=this.isBoss?'#ef4444':'#22c55e';
            
            // Si le bot est stun, couleur de la barre de vie en jaune
            if (this.isStunned > 0) ctx.fillStyle = '#facc15';

            ctx.fillRect(this.x-19,this.y-this.r-14,38*pct,4); 
            ctx.restore(); 
        } 
        }
        class Train extends Entity {
            constructor() {
                super(100, window.game.world/2, 30, '#3b82f6');
                this.hp = 20000; this.maxHp = 20000; this.type = 'train';
                this.angle = 0;
            }
            update() {
                // Move constantly to the right/across (vitesse du train r√©duite de 13%)
                const mod = window.game.activeModifier || window.game.conf.modifier;
                const timeScale = mod === 'slow_mo' ? 0.5 : 1.0;
                this.x += 1 * SPEED_FACTOR * timeScale;
                if(this.x > window.game.world - 100) {
                    this.x = 100; // Loop or just end? Let's loop for defense duration
                }
                // Visual smoke
                if(Math.random()<0.3) {
                    window.game.parts.push({x:this.x-30,y:this.y,vx:-2,vy:(Math.random()-0.5),life:40,c:'#555',r:5});
                }
            }
            draw(ctx) {
                super.draw(ctx);
                // Health bar
                const pct=this.hp/this.maxHp;
                ctx.save();
                ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(this.x-30,this.y-this.r-20,60,8);
                ctx.fillStyle='#3b82f6';ctx.fillRect(this.x-29,this.y-this.r-19,58*pct,6);
                // Train body detail
                ctx.translate(this.x, this.y);
                ctx.fillStyle = '#1e3a8a';
                ctx.fillRect(-20, -15, 40, 30);
                ctx.restore();
            }
        }
        class Payload extends Entity {
            constructor() {
                super(150, window.game.world/2, 40, '#f97316');
                this.hp = 10000; this.maxHp = 10000; this.type = 'payload';
                this.angle = 0;
            }
            update() {
                // Move if player or friendly bot is near
                let pushing = false;
                if(Dist(this, window.game.player) < 250) pushing = true;
                else {
                    for(let e of window.game.ents) {
                        if(e.friend && e.isBot && Dist(this, e) < 250) { pushing = true; break; }
                    }
                }

                if(pushing) {
                     const mod = window.game.activeModifier || window.game.conf.modifier;
                     const timeScale = mod === 'slow_mo' ? 0.5 : 1.0;
                     this.x += 1.5 * SPEED_FACTOR * timeScale;
                     if(window.game.frame % 20 === 0) window.game.parts.push({x:this.x-30,y:this.y+20,vx:-2,vy:0,life:20,c:'#555',r:4});
                }
                
                if(this.x > window.game.world - 150) {
                    window.game.over("VICTOIRE");
                }
            }
            draw(ctx) {
                super.draw(ctx);
                // Health bar
                const pct=this.hp/this.maxHp;
                ctx.save();
                ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(this.x-30,this.y-this.r-25,60,8);
                ctx.fillStyle='#f97316';ctx.fillRect(this.x-29,this.y-this.r-24,58*pct,6);
                
                // Draw Wagon
                ctx.translate(this.x, this.y);
                ctx.fillStyle = '#7c2d12';
                ctx.fillRect(-25, -20, 50, 40);
                ctx.fillStyle = '#fdba74'; // Gold/Cargo
                ctx.fillRect(-20, -15, 40, 30);
                // Wheels
                ctx.fillStyle = '#000';
                ctx.beginPath(); ctx.arc(-20, 20, 10, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(20, 20, 10, 0, Math.PI*2); ctx.fill();
                
                // Radius circle
                let inRange = Dist(this, window.game.player) < 250;
                if (!inRange) {
                     for(let e of window.game.ents) { if(e.friend && e.isBot && Dist(this, e) < 250) { inRange = true; break; } }
                }

                if(!inRange) {
                     ctx.strokeStyle = 'rgba(249, 115, 22, 0.3)';
                     ctx.lineWidth = 2;
                     ctx.setLineDash([10, 10]);
                     ctx.beginPath(); ctx.arc(0, 0, 250, 0, Math.PI*2); ctx.stroke();
                     ctx.setLineDash([]);
                } else {
                     ctx.strokeStyle = 'rgba(34, 197, 94, 0.5)'; // Green when pushing
                     ctx.lineWidth = 4;
                     ctx.beginPath(); ctx.arc(0, 0, 250, 0, Math.PI*2); ctx.stroke();
                }
                ctx.restore();
            }
        }
        
        window.game = { 
            cvs:document.getElementById('gameCanvas'), 
            ctx:document.getElementById('gameCanvas').getContext('2d'), 
            conf:{mode:'survival', arena:'tokyo', difficulty: 'normal', modifier: 'normal'}, 
            state:'MENU', frame:0, world:2000, cam:{x:0,y:0}, shake:0, gasRadius:0, timeLeft: 0, 
            player:null, ents:[], projs:[], parts:[], bgParts: [], items:[], texts:[], score:0, wave:1, boost:false, train: null, lootCollected: 0, hackProgress: 0, killCount: 0, zoneProgress: 0, activeModifier: null, chaosTimer: 0, adventure: null,
            init() { 
                this.resize(); 
                window.onresize=()=>this.resize(); 
                Input.init(); 
                Storage.load(); 
                // Initialize conf with loaded/default values
                if(typeof window.game.conf.difficulty === 'undefined') window.game.conf.difficulty = 'normal';
                if(typeof window.game.conf.modifier === 'undefined') window.game.conf.modifier = 'normal';
                if(typeof window.game.conf.bots === 'undefined') window.game.conf.bots = 0;
                window.ui.updateMenu(); 
                if('ontouchstart' in window)el('mobile-controls').classList.remove('hidden'); 
                this.loop(); 
            }, 
            resize(){ 
                this.cvs.width=window.innerWidth; 
                this.cvs.height=window.innerHeight; 
                CFG.w=this.cvs.width; CFG.h=this.cvs.height; 
            }, 
            setBots(n){this.conf.bots=n; Storage.save(); window.ui.renderBotSelector();}, 
            setStarter(k){USER.selected=k; Storage.save(); window.ui.updateMenu(); window.ui.showTab('play');}, 
            setMode(m){this.conf.mode=m; Storage.save(); window.ui.updateMenu(); window.ui.showTab('play');}, 
            setArena(a){this.conf.arena=a; Storage.save(); window.ui.updateMenu(); window.ui.showTab('play');}, 
            setDifficulty(d) { if(DIFFICULTY[d]) { this.conf.difficulty = d; Storage.save(); window.ui.updateMenu(); window.ui.showTab('play'); } }, 
            setModifier(m) { this.conf.modifier = m; Storage.save(); window.ui.updateMenu(); window.ui.updateDifficultyButtons(); }, 
            start(){ 
                el('menu-screen').classList.add('hidden'); 
                el('hud').classList.remove('hidden'); 

                // Track Stats
                if(!USER.stats.modes) USER.stats.modes = {};
                USER.stats.modes[this.conf.mode] = (USER.stats.modes[this.conf.mode] || 0) + 1;
                Storage.save(); 
                

                setText('hud-lvl', 'LVL ' + (USER.levels[USER.selected]||1));
                setText('hud-icon', STARTERS[USER.selected].icon);

                this.player=new Player(USER.selected); 
                this.ents=[]; this.projs=[]; this.parts=[]; this.bgParts = []; this.items=[]; this.texts=[]; this.score=0; this.wave=1; this.gasRadius=0; this.timeLeft = 3 * 60 * 60; 
                this.map=[]; this.train = null; this.lootCollected = 0; this.hackProgress = 0; this.killCount = 0; this.zoneProgress = 0;
                this.teamScore = 0; this.enemyScore = 0; this.bossKills = 0;
                this.killStreak = 0; this.lastKillTime = 0;
                
                // Objective Notification
                setTimeout(() => {
                    let obj = "SURVIVRE";
                    if(this.conf.mode === 'heist') obj = "D√âTRUIS LE COFFRE";
                    else if(this.conf.mode === 'rampage') obj = "50 KILLS";
                    else if(this.conf.mode === 'team_battle') obj = "40 KILLS D'√âQUIPE";
                    else if(this.conf.mode === 'ctf') obj = "3 DRAPEAUX";
                    else if(this.conf.mode === 'defense') obj = "PROT√àGE LE CRISTAL";
                    else if(this.conf.mode === 'train_defense') obj = "PROT√àGE LE TRAIN";
                    else if(this.conf.mode === 'cyber_hack') obj = "PIRATE LE TERMINAL";
                    else if(this.conf.mode === 'escape') obj = "ATTEINS L'EXTRACTION";
                    else if(this.conf.mode === 'zone_control') obj = "CAPTURE LA ZONE";
                    else if(this.conf.mode === 'thief') obj = "VOLE 10 SACS";
                    else if(this.conf.mode === 'payload') obj = "POUSSE LE WAGON";
                    else if(this.conf.mode === 'royale') obj = "SURVIVRE √Ä LA ZONE";
                    
                    window.ui.notif("OBJECTIF : " + obj, "#22d3ee");
                }, 1000);

                // SPAWN USER BOTS (Escouade)
                if(this.conf.bots > 0 && this.conf.mode !== 'team_battle' && this.conf.mode !== 'ctf') {
                    for(let i=0; i<this.conf.bots; i++) {
                        const bot = new Bot(true); // Is Friendly
                        // Spawn around player
                        bot.x = this.player.x + Math.cos(i/this.conf.bots * Math.PI*2)*80;
                        bot.y = this.player.y + Math.sin(i/this.conf.bots * Math.PI*2)*80;
                        this.ents.push(bot);
                    }
                    window.ui.notif(`${this.conf.bots} ALLI√â(S) !`, "#3b82f6");
                }
                
                if(this.conf.mode === 'custom' && this.customGrid) {
                     // Custom Map Generation
                     this.customGrid.forEach((val, i) => {
                         if(val === 1) {
                             const col = i % 20;
                             const row = Math.floor(i / 20);
                             const x = col * 100;
                             const y = row * 100; 
                             this.map.push(new Wall(x, y, 100, 100, 0));
                         }
                     });
                     window.ui.notif("CARTE PERSONNALIS√âE", "#22d3ee");
                } else {
                    for(let i=0;i<25;i++){const w=Math.random()*150+50,h=Math.random()*150+50,x=Math.random()*(this.world-w),y=Math.random()*(this.world-h);if(Math.hypot(x-this.world/2,y-this.world/2)>400)this.map.push(new Wall(x,y,w,h,0));} 

                    for(let i=0;i<38;i++){const w=Math.random()*100+100,h=Math.random()*100+100,x=Math.random()*(this.world-w),y=Math.random()*(this.world-h);this.map.push(new Wall(x,y,w,h,1));} 
                    for(let i=0;i<20;i++){const x=Math.random()*(this.world-60),y=Math.random()*(this.world-60);if(Math.hypot(x-this.world/2,y-this.world/2)>400)this.map.push(new Wall(x,y,60,60,3));} 
                } 
                const enemyBaseMult = 1+(this.conf.mode==='ranked'?0.2:0.1)*this.wave; 
                if(this.conf.mode==='duel'){ 
                    const bot = new Bot(); bot.x = this.world/2 + 400; bot.y = this.world/2; this.ents.push(bot); window.ui.notif("1 VS 1", "#fff"); 
                } else if(this.conf.mode==='heist') { 
                    const chest = new Enemy('chest', enemyBaseMult); chest.x = this.world/2; chest.y = 100; this.ents.push(chest); this.spawnDefenders(chest.x, chest.y, 3); this.map = this.map.filter(w => Math.hypot(w.x-chest.x, w.y-chest.y) > 300 && Math.hypot(w.x-this.player.x, w.y-this.player.y) > 300); window.ui.notif("D√âTRUIS LE COFFRE !", "#facc15"); 
                } else if(this.conf.mode==='boss_rush') { 
                    this.ents.push(new Enemy('boss', 3)); window.ui.notif("BOSS RUSH !", "#ef4444"); 
                } else if(this.conf.mode==='titan_raid') { 
                    for(let i=0; i<5; i++) {
                        const boss = new Enemy('boss', 3);
                        boss.x = this.world/2 + Rnd(-200, 200); boss.y = this.world/2 + Rnd(-200, 200);
                        this.ents.push(boss);
                    }
                    window.ui.notif("RAID TITAN (5 BOSS) !", "#ef4444"); 
                } else if(this.conf.mode === 'train_defense') {
                    this.train = new Train();
                    this.ents.push(this.train);
                    this.map = this.map.filter(w => Math.abs(w.y - this.world/2) > 100); // Clear path for train
                    window.ui.notif("PROT√àGE LE TRAIN !", "#3b82f6");
                } else if(this.conf.mode === 'thief') {
                    // Spawn Loot
                    for(let i=0; i<15; i++) {
                        this.items.push({x:Rnd(100,this.world-100), y:Rnd(100,this.world-100), type:'loot_bag'});
                    }
                    window.ui.notif("VOLE 10 SACS !", "#facc15");
                } else if(this.conf.mode === 'cyber_hack') {
                    // Spawn Hack Terminal
                    const term = new Enemy('chest', enemyBaseMult * 5); // Use chest model as terminal base but stronger
                    term.x = this.world/2; term.y = this.world/2; term.type = 'terminal'; term.c = '#22d3ee';
                    this.ents.push(term);
                    // Clear center
                    this.map = this.map.filter(w => Math.hypot(w.x-term.x, w.y-term.y) > 400);
                    window.ui.notif("PIRATE LE TERMINAL !", "#22d3ee");
                } else if(this.conf.mode === 'escape') {
                    // Spawn extraction point at end of world
                    const exit = new Enemy('chest', 10);
                    exit.x = this.world - 150; exit.y = this.world - 150; exit.type = 'exit'; exit.c = '#10b981'; exit.r = 60;
                    this.ents.push(exit);
                    // Clear area
                    this.map = this.map.filter(w => Math.hypot(w.x-exit.x, w.y-exit.y) > 400);
                    window.ui.notif("REJOINS L'EXTRACTION !", "#10b981");
                } else if(this.conf.mode === 'rampage') {
                    window.ui.notif("CARNAGE : 50 KILLS", "#ef4444");
                } else if(this.conf.mode === 'zone_control') {
                    // Zone centrale
                    window.ui.notif("CONTR√îLE LA ZONE", "#a855f7");
                } else if(this.conf.mode === 'defense') {
                    const core = new Enemy('chest', 5); core.type = 'core'; core.x = this.world/2; core.y = this.world/2; core.c = '#3b82f6';
                    this.ents.push(core);
                    this.map = this.map.filter(w => Math.hypot(w.x-core.x, w.y-core.y) > 400);
                    window.ui.notif("PROT√àGE LE CRISTAL !", "#3b82f6");
                } else if(this.conf.mode === 'sniper_duel') {
                    const bot = new Bot(); bot.x = this.world/2 + 600; bot.y = this.world/2; 
                    bot.c = '#a855f7'; // Sniper color
                    // Force bot to simulate sniper if possible, or just standard bot
                    this.ents.push(bot); window.ui.notif("DUEL SNIPER", "#a855f7");
                } else if(this.conf.mode === 'giant_hunt') {
                    const boss = new Enemy('boss', 5); // Huge HP
                    boss.x = this.world/2; boss.y = this.world/2; boss.r = 80; boss.name = "G√âANT";
                    this.ents.push(boss); window.ui.notif("CHASSE AU G√âANT", "#ef4444");
                } else if(this.conf.mode === 'golden_chase') {
                    for(let i=0; i<30; i++) this.items.push({x:Rnd(100,this.world-100), y:Rnd(100,this.world-100), t:'coins', val: 50});
                    this.timeLeft = 120 * 60; // 2 Minutes
                    window.ui.notif("SURVIVRE & COLLECTER !", "#eab308");
                } else if(this.conf.mode === 'infection_hard') {
                    // Start with more enemies
                    for(let i=0; i<20; i++) this.ents.push(new Enemy('fast', 1.5));
                    window.ui.notif("INFECTION EXTR√äME", "#dc2626");
                } else if(this.conf.mode === 'speed_run') {
                    const exit = new Enemy('chest', 1); exit.type='exit'; exit.x = this.world-100; exit.y = this.world-100; exit.c='#22d3ee';
                    this.ents.push(exit);
                    window.ui.notif("SPEED RUN !", "#22d3ee");

                } else if(this.conf.mode === 'team_battle') {
                    // Spawn Friendly Bots
                    for(let i=0; i<3; i++) {
                        const fb = new Bot(true);
                        fb.x = this.player.x + Rnd(-200, 200); fb.y = this.player.y + Rnd(-200, 200);
                        this.ents.push(fb);
                    }
                    if(this.adventure && this.adventure.mode === 'duel') {
                         // Force duel opponent only
                         const opp = new Enemy('boss', 1); opp.isBoss = true; opp.name = "RIVAL";
                         opp.x = this.world/2; opp.y = this.world/2;
                         this.ents.push(opp);
                    }
                    // Enemy bots will be spawned by loop but let's spawn 4 immediately
                    for(let i=0; i<4; i++) {
                        const eb = new Bot(false);
                        eb.x = this.world - 200 + Rnd(-100, 100); eb.y = this.world - 200 + Rnd(-100, 100);
                        this.ents.push(eb);
                    }
                    window.ui.notif("BATAILLE D'√âQUIPE !", "#3b82f6");
                } else if(this.conf.mode === 'ctf') {
                    for(let i=0; i<3; i++) { const fb = new Bot(true); fb.x = this.player.x + Rnd(-200, 200); fb.y = this.player.y + Rnd(-200, 200); this.ents.push(fb); }
                    for(let i=0; i<4; i++) { const eb = new Bot(false); eb.x = this.world - 200 + Rnd(-100, 100); eb.y = this.world - 200 + Rnd(-100, 100); this.ents.push(eb); }
                    this.flags = [];
                    const blueFlag = new Flag('blue', this.player.x, this.player.y - 50);
                    const redFlag = new Flag('red', this.world - 200, this.world - 200);
                    this.flags.push(blueFlag, redFlag);
                    this.ents.push(blueFlag, redFlag);
                    window.ui.notif("CAPTURE LE DRAPEAU !", "#facc15");
                } else if(this.conf.mode === 'payload') {
                    this.train = new Payload(); // Reuse this.train variable for simplicity/compatibility since logic is similar
                    this.ents.push(this.train);
                    this.map = this.map.filter(w => Math.abs(w.y - this.world/2) > 150); // Clear wider path
                    window.ui.notif("POUSSE LE WAGON !", "#f97316");
                } else if(this.conf.mode === 'royale') {
                    this.gasRadius = this.world; 
                    const heroes = Object.keys(STARTERS);
                    for(let i=0; i<30; i++) {
                        const rndHero = heroes[Math.floor(Math.random()*heroes.length)];
                        const b = new Bot(false, rndHero);
                        b.x = Rnd(100, this.world-100); b.y = Rnd(100, this.world-100);
                        this.ents.push(b);
                    }
                    window.ui.notif("SURVIVRE √Ä LA ZONE !", "#ef4444");
                } else { 
                    window.ui.notif(MODES[this.conf.mode].name.toUpperCase(), "#fff"); 
                } 
                setText('hud-icon', STARTERS[USER.selected].icon); 
                this.state='PLAYING'; // Set state to PLAYING
            }, 
            spawnDefenders(cx, cy, count) { for(let i=0; i<count; i++) { const angle = (Math.PI*2/count)*i; const e = new Enemy('basic', 1); e.x = cx + Math.cos(angle)*150; e.y = cy + Math.sin(angle)*150; this.ents.push(e); } }, 
            togglePause(){this.state=this.state==='PLAYING'?'PAUSED':(this.state==='PAUSED'?'PLAYING':this.state);}, 
            toMenu(){el('gameover-screen').classList.add('hidden');el('menu-screen').classList.remove('hidden');el('hud').classList.add('hidden');this.state='MENU';window.ui.updateMenu();game.boost=false;this.adventure=null;}, 
            over(r){ 
                this.state='GAMEOVER'; 
                el('gameover-screen').classList.remove('hidden'); 
                
                // Stats updates
                if (r !== "VICTOIRE") {
                    USER.stats.losses++;
                }

                const title = el('go-title');
                if (r === "VICTOIRE") {
                    title.innerText = "VICTOIRE";
                    title.className = "text-6xl md:text-8xl font-black text-yellow-400 mb-2 drop-shadow-[0_0_25px_rgba(250,204,21,0.8)] tracking-tighter animate-bounce";
                } else {
                    title.innerText = "KO";
                    title.className = "text-8xl font-black text-white mb-2 drop-shadow-2xl tracking-tighter";
                }
                setText('go-reason', r); 
                // Feature 2: Score Multiplier
                let finalScore = this.score * DIFFICULTY[this.conf.difficulty].mult;
                setText('go-score', Math.floor(finalScore)); 

                let gt = 1 + Math.floor(finalScore / 100) * 2; 
                if(this.boost) gt *= 2; 
                if(this.boost) gt *= 2; 
                if((this.conf.mode==='duel' || this.conf.mode==='heist' || this.conf.mode==='boss_rush' || this.conf.mode==='titan_raid' || this.conf.mode==='train_defense' || this.conf.mode==='cyber_hack' || this.conf.mode === 'escape' || this.conf.mode === 'rampage' || this.conf.mode === 'zone_control' || this.conf.mode === 'team_battle') && r==="VICTOIRE") { gt += 20; USER.stats.wins++; } 
                let gc = Math.floor(finalScore/10); 
                if(r==="VICTOIRE") gc += 50; 
                if(finalScore >= 200 || r==="VICTOIRE") { 
                    USER.pass.xp += 50; 
                    while(USER.pass.xp >= 100) { 
                        if(USER.pass.tier < 50) { 
                            USER.pass.tier++; USER.pass.xp -= 100; window.ui.notif("PASS LEVEL UP!", "#facc15"); 
                        } else { 
                            USER.pass.xp = 100; break; 
                        } 
                    } 
                } 
                
                // New Rank Detection
                let oldR = 0;
                for(let i=0; i<RANKS.length; i++) { if(USER.trophies >= RANKS[i].t) oldR = i; }

                USER.trophies+=gt; USER.coins+=gc; 
                
                let newR = 0;
                for(let i=0; i<RANKS.length; i++) { if(USER.trophies >= RANKS[i].t) newR = i; }

                if (newR > oldR) {
                   const newRank = RANKS[newR];
                   setTimeout(() => window.ui.notif(`RANG ATTEINT : ${newRank.n} !`, newRank.c), 500);
                }

                USER.stats.maxWave=Math.max(USER.stats.maxWave,this.wave); 
                USER.stats.games++; 
                USER.stats.maxPassTier = Math.max(USER.stats.maxPassTier || 1, USER.pass.tier); // Mise √† jour de la stat de Palier Max
                
                // Quest Check
                if (window.QuestSystem) {
                    window.QuestSystem.check('play', { mode: this.conf.mode, arena: this.conf.arena, hero: USER.selected });
                    if(r === "VICTOIRE") window.QuestSystem.check('win', { mode: this.conf.mode });
                    window.QuestSystem.check('survive', { wave: this.wave });
                }
                
                // --- MASTERY XP & SOUNDS ---
                if(r === "VICTOIRE") {
                    if(SoundManager) SoundManager.play('win');
                    
                    // ADVENTURE PROGRESSION
                    if(this.adventure) {
                        window.ui.completeAdventurePart(this.adventure.id);
                        this.adventure = null; // Clear active adventure
                    }

                    const mXpGain = 50;
                    if(!USER.mastery) USER.mastery = {};
                    if(!USER.mastery[USER.selected]) USER.mastery[USER.selected] = { xp: 0, lvl: 1 };
                    USER.mastery[USER.selected].xp += mXpGain;
                    window.ui.notif(`+${mXpGain} MA√éTRISE`, "#fbbf24");
                } else {
                    const mXpGain = 10;
                    if(!USER.mastery) USER.mastery = {};
                    if(!USER.mastery[USER.selected]) USER.mastery[USER.selected] = { xp: 0, lvl: 1 };
                    USER.mastery[USER.selected].xp += mXpGain;
                }

                Storage.save(); setText('go-rewards', `+${gt}üèÜ +${gc}ü™ô`); 
            }, 
            // Am√©lioration de l'effet d'ambiance 2.0
            drawTerrainEffects() { 
                if(this.state !== 'PLAYING') return; 
                const arena = this.conf.arena; 
                let spawnRate = 0.3; let color = 'rgba(255,255,255,0.5)'; let vy = 2; let vx = 0; let size = 3; let life = 200;
                let isRect = false;
                
                // Configs uniques par terrain
                if(arena === 'ice') { spawnRate = 0.9; color = 'rgba(220,240,255,0.8)'; vy = 3.5; vx = 1; } 
                else if(arena === 'magma') { spawnRate = 0.6; color = 'rgba(255,80,0,0.6)'; vy = -3; size = 5; } 
                else if(arena === 'tokyo') { spawnRate = 0.3; color = 'rgba(0, 255, 200, 0.4)'; vy = 5; isRect = true; } 
                else if(arena === 'cyber_city') { spawnRate = 0.3; color = 'rgba(232, 121, 249, 0.4)'; vy = 6; isRect = true; }
                else if(arena === 'sand') { spawnRate = 0.7; color = 'rgba(230,180,50,0.4)'; vy = 4; vx = 3; } 
                else if(arena === 'jungle') { spawnRate = 0.4; color = 'rgba(50, 200, 100, 0.4)'; vy = 1.5; vx = -0.5; }
                else if(arena === 'nebula') { spawnRate = 0.6; color = 'rgba(168, 85, 247, 0.5)'; vy = 0.5; vx = 0.5; size = 2; }
                else if(arena === 'mainframe') { spawnRate = 1.0; color = 'rgba(34, 211, 238, 0.6)'; vy = -4.5; size = 2; isRect = true; } // Code rain up
                else if(arena === 'ruins') { spawnRate = 0.8; color = 'rgba(148, 163, 184, 0.5)'; vy = 5; vx = -1; } // Rain
                else if(arena === 'moon') { spawnRate = 0.2; color = 'rgba(255, 255, 255, 0.8)'; vy = -0.05; size=1.5; } // Stars
                else if(arena === 'crystal') { spawnRate = 0.6; color = 'rgba(192, 132, 252, 0.6)'; vy = -1; vx = 0; size = 4; } // Glitter
                else if(arena === 'solaris') { spawnRate = 0.5; color = 'rgba(253, 186, 116, 0.6)'; vy = -4; size = 5; } // Sparks
                else if(arena === 'atlantis') { spawnRate = 0.7; color = 'rgba(147, 197, 253, 0.4)'; vy = -2; size = 6; } // Bubbles
                else if(arena === 'dungeon') { spawnRate = 0.4; color = 'rgba(20, 20, 20, 0.8)'; vy = 3; size = 4; vx = 0; } // Darkness drops
                else if(arena === 'swamp') { spawnRate = 0.8; color = 'rgba(100, 255, 50, 0.4)'; vy = -1; vx = 0.5; size = 5; } // Spores & Bubbles
                else if(arena === 'factory') { spawnRate = 1.0; color = Math.random()>0.5 ? 'rgba(255, 120, 0, 0.8)' : 'rgba(100, 100, 100, 0.5)'; vy = -3; vx = 1; size = 3; } // Smoke & Sparks
                else if(arena === 'void') { spawnRate = 0.6; color = 'rgba(139, 92, 246, 0.6)'; vy = (Math.random()-0.5)*2; vx = (Math.random()-0.5)*2; size = 4; } // Cosmic Dust
                
                if(Math.random() < spawnRate) { 
                    this.bgParts.push({ 
                        x: this.cam.x + Math.random() * CFG.w, 
                        y: (vy > 0 ? this.cam.y - 10 : this.cam.y + CFG.h + 10), 
                        vx: (Math.random() - 0.5) * 2 + vx, 
                        vy: vy * (0.8 + Math.random() * 0.4), 
                        life: life, c: color, r: Math.random() * size + 1,
                        isRect: isRect
                    }); 
                } 
                for(let i=this.bgParts.length-1; i>=0; i--) { 
                    const p = this.bgParts[i]; p.x += p.vx; p.y += p.vy; p.life--; 
                    if(p.life <= 0) { this.bgParts.splice(i, 1); continue; } 
                    
                    if(p.x < this.cam.x - 50 || p.x > this.cam.x + CFG.w + 50 || p.y < this.cam.y - 50 || p.y > this.cam.y + CFG.h + 50) { 
                        this.bgParts.splice(i, 1); continue; 
                    } 
                    
                    this.ctx.fillStyle = p.c; this.ctx.beginPath(); 
                    if(p.isRect) this.ctx.fillRect(p.x - this.cam.x, p.y - this.cam.y, p.r, p.r * 2);
                    else this.ctx.arc(p.x - this.cam.x, p.y - this.cam.y, p.r, 0, Math.PI*2);
                    this.ctx.fill(); 
                } 
            }, 
            loop(){ 
                requestAnimationFrame(()=>this.loop()); 
                this.frame++; 
                const ctx=this.ctx; 
                if(this.state==='PLAYING'){ 
                    
                    // ADVENTURE SPECIFIC WIN CONDITIONS
                    if(this.adventure) {
                        const adv = this.adventure;
                        if(adv.mode === 'survival' && this.wave > adv.target) this.over("VICTOIRE");
                        if(adv.mode === 'collect' && adv.item === 'coins' && USER.coins >= (adv.startCoins || 0) + adv.target) this.over("VICTOIRE"); 
                        // Note: coins check assumes we track start amount, or simpler: just check session retrieval
                        // Let's rely on standard mode objectives which usually trigger over("VICTOIRE")
                        // Rampege: killCount >= target
                        if(adv.mode === 'rampage' && this.killCount >= adv.target) this.over("VICTOIRE");
                    }                    
                    // Chaos Modifier Logic
                    if(this.conf.modifier === 'chaos') {
                        if(this.frame % 600 === 0) { // Every 10 seconds
                            const mods = Object.keys(MODIFIERS).filter(k => k !== 'chaos' && k !== 'normal');
                            this.activeModifier = mods[Math.floor(Math.random() * mods.length)];
                            window.ui.notif("CHAOS: " + MODIFIERS[this.activeModifier].name.toUpperCase(), MODIFIERS[this.activeModifier].color.replace('text-', '#').replace('text-xs ', '').replace('-300','-400').replace('-400','-400').replace('-500','-500').replace('-600','-600').split(' ')[0]);
                        }
                    } else {
                        this.activeModifier = null;
                    }

                    if(this.conf.mode === 'heist' || this.conf.mode === 'boss_rush' || this.conf.mode === 'titan_raid' || this.conf.mode === 'train_defense' || this.conf.mode === 'cyber_hack') { 
                        this.timeLeft--; 
                        if(this.timeLeft <= 0) { 
                            if(this.conf.mode === 'train_defense') this.over("VICTOIRE");
                            else if(this.conf.mode === 'cyber_hack') this.over("ECHEC PIRATAGE");
                            else this.over("TEMPS √âCOUL√â"); // Heist, Boss Rush, etc = Defeat if time runs out
                            return; 
                        }
                    }
                    if(this.conf.mode === 'escape') {
                        this.timeLeft--;
                        if(this.timeLeft <= 0) { this.over("TEMPS √âCOUL√â"); return; }
                    }
                    if(this.conf.mode === 'golden_chase') {
                        this.timeLeft--;
                        if(this.timeLeft <= 0) { this.over("VICTOIRE"); return; }
                    }
                    if((this.conf.mode === 'heist') && this.frame % (20*60) === 0) { 
                            const chest = this.ents.find(e => e.type === 'chest'); 
                            if(chest) { 
                                this.spawnDefenders(chest.x, chest.y, 3); window.ui.notif("RENFORTS !", "#ef4444"); 
                            } 
                        } 
                    if(!this.ents) this.ents = []; if(!this.map) this.map = []; 
                    
                    // SPAWN LOGIC
                    if(this.conf.mode === 'survival' || this.conf.mode === 'ranked' || this.conf.mode === 'train_defense' || this.conf.mode === 'thief' || this.conf.mode === 'cyber_hack' || this.conf.mode === 'escape' || this.conf.mode === 'rampage' || this.conf.mode === 'zone_control' || this.conf.mode === 'golden_chase' || this.conf.mode === 'infection' || this.conf.mode === 'infection_hard' || this.conf.mode === 'heist' || this.conf.mode === 'defense' || this.conf.mode === 'treasure' || this.conf.mode === 'gungame' || this.conf.mode === 'payload'){ 
                        if(!this.ents.find(e=>e.isBoss && e.type !== 'train' && e.type !== 'terminal' && e.type !== 'exit' && e.type !== 'core' && e.type !== 'chest' && e.type !== 'payload')){ 
                            let max=5+Math.floor(this.wave*1.5); 
                            if(this.conf.mode === 'rampage') max *= 2; // Double spawn for rampage
                            const enemyWaveMult = 1+(this.conf.mode==='ranked'?0.2:0.1)*this.wave; 
                            
                            // Feature 1: Mini-Boss Spawn (Vague 3 & 6)
                            if(this.frame%1800===0){
                                this.wave++;
                                if(this.wave % 5 === 0 && this.conf.mode !== 'thief' && this.conf.mode !== 'cyber_hack' && this.conf.mode !== 'escape' && this.conf.mode !== 'rampage' && this.conf.mode !== 'zone_control' && this.conf.mode !== 'golden_chase' && this.conf.mode !== 'payload'){
                                    this.ents.push(new Enemy('boss', enemyWaveMult * 2));
                                    window.ui.notif("BOSS !!!","#ef4444");
                                } else if ((this.wave === 3 || this.wave === 6) && this.conf.mode !== 'thief' && this.conf.mode !== 'cyber_hack' && this.conf.mode !== 'escape' && this.conf.mode !== 'rampage' && this.conf.mode !== 'zone_control' && this.conf.mode !== 'golden_chase' && this.conf.mode !== 'payload') {
                                    this.ents.push(new Enemy('mini_boss', enemyWaveMult * 1.5));
                                    window.ui.notif("MINI BOSS !","#facc15");
                                } else {
                                    window.ui.notif("VAGUE "+this.wave,"#fff");
                                }
                            }
                            
                            // Spawn enemies
                            if(this.ents.filter(e => !e.friend && e.type !== 'train' && e.type !== 'terminal' && e.type !== 'exit').length < max && this.frame%60===0){
                                let t='basic'; if(this.wave>2&&Math.random()>0.7)t='fast'; if(this.wave>4&&Math.random()>0.8)t='tank'; 
                                const en = new Enemy(t, enemyWaveMult);
                                // For Train mode, spawn near train sometimes
                                if(this.conf.mode === 'train_defense' && this.train && Math.random() < 0.5) {
                                    en.x = this.train.x + Rnd(-300, 300);
                                    en.y = this.train.y + Rnd(-300, 300); 
                                }
                                // For Payload mode, spawn ahead of payload
                                if(this.conf.mode === 'payload' && this.train) {
                                     en.x = this.train.x + 400 + Rnd(-200, 200);
                                     en.y = this.train.y + Rnd(-300, 300);
                                     en.x = Math.min(this.world-50, Math.max(50, en.x)); // Clamp
                                }
                                // Escape mode: spawn near player (chose)
                                if(this.conf.mode === 'escape') {
                                     en.x = this.player.x + Rnd(-400, 400); en.y = this.player.y + Rnd(-400, 400);
                                     if(Dist(en, this.player) < 300) { en.x += 300; }
                                     en.mode = 'CHASE';
                                }
                                this.ents.push(en);
                            } 
                            
                        } 
                            
                            
                            // Respawn logic for Team Battle & CTF
                    } else if(this.conf.mode === 'team_battle' || this.conf.mode === 'ctf') {
                         
                         const friendlies = this.ents.filter(e => e.friend && e.isBot).length;
                         const enemies = this.ents.filter(e => !e.friend && e.isBot).length;
                         
                         if(friendlies < 3 && this.frame%120===0) {
                             const fb = new Bot(true); fb.x = this.player.x; fb.y = this.player.y; this.ents.push(fb);
                         }
                         if(enemies < 4 && this.frame%120===0) {
                             const eb = new Bot(false); eb.x = Rnd(100, this.world-100); eb.y = Rnd(100, this.world-100); this.ents.push(eb);
                         }
                    } else if(this.ents.length===0 && this.conf.mode !== 'train_defense' && this.conf.mode !== 'cyber_hack' && this.conf.mode !== 'escape' && this.conf.mode !== 'custom') this.over("VICTOIRE"); 
                    
                    this.player.update(); 
                    if(this.train) {
                        this.train.update();
                        if(this.train.hp <= 0) this.over(this.conf.mode === 'payload' ? "CONVOI D√âTRUIT" : "TRAIN D√âTRUIT");
                    }
                    if(this.conf.mode === 'cyber_hack') {
                        const term = this.ents.find(e => e.type === 'terminal');
                        if(term) {
                            if(Dist(this.player, term) < 200) {
                                this.hackProgress += 0.05;
                                if(Math.random() < 0.1) window.game.parts.push({x:term.x+Rnd(-20,20),y:term.y+Rnd(-20,20),vx:0,vy:-2,life:30,c:'#22d3ee',r:2});
                            }
                            if(this.hackProgress >= 100) this.over("VICTOIRE");
                        }
                    }
                    if(this.conf.mode === 'escape') {
                        const exit = this.ents.find(e => e.type === 'exit');
                        if(exit && Dist(this.player, exit) < exit.r + this.player.r) {
                            this.over("VICTOIRE");
                        }
                    }
                    if(this.conf.mode === 'rampage') {
                         if(this.killCount >= 50) this.over("VICTOIRE");
                    }
                    if(this.conf.mode === 'zone_control') {
                        // Check if player is in center zone (radius 200)
                        if(Dist(this.player, {x:this.world/2, y:this.world/2}) < 200) {
                            this.zoneProgress += 0.1;
                            if(this.frame % 30 === 0) window.ui.notif("CAPTURE...", "#a855f7");
                            if(this.zoneProgress >= 100) this.over("VICTOIRE");
                        }
                    }
                    if(this.conf.mode === 'royale') {
                        if(this.frame % 30 === 0 && this.gasRadius > 150) {
                            this.gasRadius -= 5;
                        }
                        const survivors = this.ents.filter(e => e.isBot && !e.dead).length;
                        if(survivors === 0) this.over("TOP 1 - VICTOIRE ROYAL");
                        
                        // Gas visual effect
                        if(this.frame % 20 === 0) {
                             const angle = Math.random() * Math.PI * 2;
                             const r = this.gasRadius;
                             window.game.parts.push({x:this.world/2 + Math.cos(angle)*r, y:this.world/2 + Math.sin(angle)*r, vx:0, vy:0, life:60, c:'#10b981', r:10});
                        }
                    }
                    
                    this.ents.forEach(e=>e.update());
                    // Fix: Remove dead entities (e.g. from poison) that didn't go through kill()
                    for(let e of this.ents) {
                        if(e.hp <= 0 && !e.dead) this.kill(e);
                    }
                    
                    this.ents.forEach(e => resolveCollision(this.player, e)); 
                    for(let i=0; i<this.ents.length; i++) for(let j=i+1; j<this.ents.length; j++) resolveCollision(this.ents[i], this.ents[j]); 
                    
                    // CAM FOLLOW
                    let targetX = this.player.x, targetY = this.player.y;
                    const tx=targetX-CFG.w/2, ty=targetY-CFG.h/2; 
                    this.cam.x+=(tx-this.cam.x)*0.1; 
                    this.cam.y+=(ty-this.cam.y)*0.1; 
                    this.cam.x=Math.max(0,Math.min(this.world-CFG.w,this.cam.x)); 
                    this.cam.y=Math.max(0,Math.min(this.world-CFG.h,this.cam.y)); 
                    if(this.shake>0)this.shake*=0.9; 
                    
                    // PROJECTILES
                    for(let i=this.projs.length-1;i>=0;i--){ 
                        const b=this.projs[i]; 
                        
                        // Melee attacks do not move
                        if(b.melee){ 
                            b.x=window.game.player.x+Math.cos(window.game.player.angle)*40; 
                            b.y=window.game.player.y+Math.sin(window.game.player.angle)*40; 
                            b.life--; 
                            
                            // Logique de Siphon de Vie pour Reaper (Feature Reaper)
                            if (USER.selected === 'reaper' && b.life === 0) {
                                // Reaper Melee hit logic moved to kill() or handled after damage application
                                // Let the hit logic handle the lifesteal (in the collision loop)
                            }

                            if(b.life<=0){this.projs.splice(i,1);continue;} 
                            
                            for(let e of this.ents) if(Dist(b,e)<b.r+e.r && !e.hitCD){ 
                                e.hitCD=20; 
                                e.hp-=b.dmg; 
                                e.hitTimer = 0; // Reset hitTimer
                                if(b.friend) {
                                    USER.stats.dmg+=b.dmg; 
                                    window.QuestSystem.check('dmg', { amount: Math.floor(b.dmg) });
                                } 
                                if(window.game.conf.modifier === 'poison') e.activeEffects.poison = 120;
                                
                                // Bot React Emote on Hit
                                if (e.isBot && Math.random() < 0.3) {
                                    const angryEmotes = ['üò°', 'ü§¨', 'üò≠', 'üíî', 'üòµ', 'ü§ï'];
                                    e.triggerEmote(angryEmotes[Math.floor(Math.random() * angryEmotes.length)]);
                                }
                                
                                // FIX: Lifesteal handled for melee
                                if(b.friend && (USER.selected === 'ronin' || USER.selected === 'reaper')) { // Ronin et Reaper ont le lifesteal
                                    if(window.game.conf.modifier !== 'oneshot') window.game.player.hp = Math.min(window.game.player.maxHp, window.game.player.hp + Math.floor(b.dmg * 0.4));
                                }
                                if(window.game.conf.modifier === 'recoil' && b.friend) { e.x += Math.cos(window.game.player.angle)*20; e.y += Math.sin(window.game.player.angle)*20; } // Knockback enemy
                                
                                e.flashColor = b.c; e.flashTimer = 5; // Flash Feedback
                                for(let k=0;k<7;k++)window.game.parts.push({x:e.x,y:e.y,vx:Rnd(-3,3),vy:Rnd(-3,3),life:15,c:b.c,r:Rnd(2,4), gravity:true, shape: 'rect', angle: Rnd(0, Math.PI), vRot: Rnd(-0.2, 0.2)}); // Debris
                                this.texts.push({x:e.x,y:e.y-40,t:Math.floor(b.dmg),life:50,c:'#fff',vy:-1.5, scale:1.5}); 
                                if(window.game.conf.modifier === 'oneshot') e.hp = 0; 
                                if(e.hp<=0 && !e.dead) this.kill(e); 
                            } 
                            continue; 
                        } 
                        
                        // Ranged attacks move
                        const mod = window.game.activeModifier || window.game.conf.modifier;
                        const timeScale = mod === 'slow_mo' ? 0.5 : 1.0;
                        b.x+=b.vx * timeScale; b.y+=b.vy * timeScale; b.life--; 
                        if(b.life<=0){this.projs.splice(i,1);continue;} 
                        let wh=false; 
                        for(let k=this.map.length-1; k>=0; k--) { 
                            const w=this.map[k]; 
                            if(w.type!==1 && ColRect(b, w)) { 
                                // FIX: Emp√™cher les projectiles de casser les murs (sauf les caisses de butin type 3)
                                if(w.type===0) wh=true; // Mur normal
                                
                                if(w.type===3 && b.friend) { // Mur destructible par projectile joueur
                                    this.map.splice(k,1); 
                                    this.items.push({x:w.x+30, y:w.y+30, type:'cube'}); 
                                    for(let j=0;j<8;j++) this.parts.push({x:w.x+30, y:w.y+30, vx:Rnd(-6,6), vy:Rnd(-6,6), life:25, c:'#d97706', r:Rnd(4,7), shape:'rect', angle:Rnd(0,6), vRot:Rnd(-0.3,0.3), gravity:true}); 
                                    wh=true; 
                                } else if (w.type === 3 && !b.friend) {
                                    // Projectiles ennemis ne cassent pas les murs
                                    wh = true; 
                                }
                            } 
                        } 
                        if(wh){for(let j=0;j<3;j++)this.parts.push({x:b.x,y:b.y,vx:(Math.random()-0.5)*3,vy:(Math.random()-0.5)*3,life:10,c:b.c,r:2}); this.projs.splice(i,1);continue;} 
                        
                        if(b.friend){ 
                            for(let e of this.ents){ 
                                if(Dist(b,e)<b.r+e.r){ 
                                    e.hp-=b.dmg; 
                                    e.hitTimer = 0; // Reset hitTimer
                                    USER.stats.dmg+=b.dmg; 
                                    window.QuestSystem.check('dmg', { amount: Math.floor(b.dmg) }); 
                                    
                                    if(window.game.conf.modifier === 'poison') e.activeEffects.poison = 120; 
                                    // FIX: Lifesteal for ranged
                                    if(window.game.conf.modifier === 'vampire' && window.game.conf.modifier !== 'oneshot') window.game.player.hp = Math.min(window.game.player.maxHp, window.game.player.hp + 5); // Life Steal (Vampire modifier)
                                    if(window.game.conf.modifier === 'recoil') { e.x += Math.cos(Math.atan2(b.vy, b.vx))*20; e.y += Math.sin(Math.atan2(b.vy, b.vx))*20; }
                                    
                                    // Flash Feedback
                                    e.flashColor = b.c; e.flashTimer = 5; 

                                    // Bot React Emote on Hit
                                    if (e.isBot && Math.random() < 0.3) {
                                        const angryEmotes = ['üò°', 'ü§¨', 'üò≠', 'üíî', 'üòµ', 'ü§ï'];
                                        e.triggerEmote(angryEmotes[Math.floor(Math.random() * angryEmotes.length)]);
                                    }

                                    // Feature 6: D√©g√¢ts Critiques
                                    const isCrit = b.isCrit;
                                    this.texts.push({x:e.x,y:e.y-40,t:Math.floor(b.dmg) + (isCrit?"!":""),life:50,c:isCrit?'#facc15':'#fff',vy:-2, scale: isCrit?2:1.2}); 
                                    for(let k=0;k<8;k++)this.parts.push({x:e.x,y:e.y,vx:Rnd(-5,5),vy:Rnd(-5,5),life:20,c:e.c,r:4, gravity:true}); 
                                    if(window.game.conf.modifier === 'oneshot') e.hp = 0; 
                                    if(e.hp<=0 && !e.dead) this.kill(e); 
                                    if(SoundManager) SoundManager.play('hit');
                                    this.projs.splice(i,1); wh=true; break; 
                                } 
                            } 
                        } else { 
                            // Enemy projectiles hit player or TRAIN
                            let hit = false;
                            if(Dist(b,this.player)<b.r+this.player.r){
                                this.player.hp-=b.dmg;
                                this.player.hitTimer = 0; // Reset hitTimer
                                window.ui.flash();
                                if(window.game.conf.modifier === 'poison') this.player.activeEffects.poison = 120;
                                if(window.game.conf.modifier === 'oneshot') this.player.hp = 0; 
                                if(this.player.hp<=0)this.over("Tu√© par Tir Ennemi");
                                hit=true;
                            }
                            if(!hit && this.train && Dist(b, this.train) < b.r + this.train.r) {
                                this.train.hp -= b.dmg;
                                hit=true;
                            }
                            if(hit) this.projs.splice(i,1);
                        } 
                    } 
                    this.ents.forEach(e=>{if(e.hitCD)e.hitCD--}); 
                    for(let i=this.ents.length-1;i>=0;i--)if(this.ents[i].dead)this.ents.splice(i,1); 
                    for(let i=this.items.length-1;i>=0;i--){
                        const l=this.items[i];
                        // Feature 5: Ramassage Rapide (les items suivent le joueur)
                        if (Dist(l, this.player) < 150) {
                            let angleToPlayer = Math.atan2(this.player.y - l.y, this.player.x - l.x);
                            l.x += Math.cos(angleToPlayer) * 5;
                            l.y += Math.sin(angleToPlayer) * 5;
                        }
                        
                        if(Dist(l,this.player)<30){
                            if(l.type==='cube'){if(SoundManager)SoundManager.play('collect');this.player.cubes++;this.player.maxHp+=400;this.player.hp+=400;window.ui.notif("POWER UP!","#22c55e");}
                            if(l.type==='loot_bag'){
                                this.lootCollected++;
                                window.QuestSystem.check('collect', { itemType: 'loot_bag', amount: 1 });
                                if(SoundManager)SoundManager.play('collect');
                                window.ui.notif(`SAC R√âCUP√âR√â (${this.lootCollected}/10)`, "#facc15");
                                if(this.lootCollected >= 10) this.over("VICTOIRE");
                            }
                            else{
                                if(SoundManager)SoundManager.play('collect');
                                window.QuestSystem.check('collect', { itemType: l.t, amount: 1 });
                                if(l.t==='hp'){
                                    this.player.hp=Math.min(this.player.maxHp,this.player.hp+30);
                                    for(let j=0;j<6;j++) this.parts.push({x:l.x,y:l.y,vx:Rnd(-3,3),vy:Rnd(-3,3),life:20,c:'#22c55e',r:3, shape:'spark', angle:Rnd(0,6), vRot:Rnd(-0.1,0.1)}); // VFX
                                } else if(l.t==='coins') {
                                    USER.coins += 10;
                                    window.ui.feed("Pi√®ces", "+10 ü™ô", true);
                                    for(let j=0;j<6;j++) this.parts.push({x:l.x,y:l.y,vx:Rnd(-3,3),vy:Rnd(-3,3),life:20,c:'#eab308',r:3, shape:'spark', angle:Rnd(0,6), vRot:Rnd(-0.1,0.1)});
                                } else if(l.t==='gems') {
                                    USER.gems += 1;
                                    window.ui.feed("Gemme", "+1 üíé", true);
                                    for(let j=0;j<6;j++) this.parts.push({x:l.x,y:l.y,vx:Rnd(-3,3),vy:Rnd(-3,3),life:20,c:'#a855f7',r:3, shape:'spark', angle:Rnd(0,6), vRot:Rnd(-0.1,0.1)});
                                } else {
                                    // xp
                                    this.player.xp=Math.min(this.player.xpMax-1, this.player.xp+30); 
                                    window.QuestSystem.check('xp', { amount: 30 }); 
                                    for(let j=0;j<6;j++) this.parts.push({x:l.x,y:l.y,vx:Rnd(-3,3),vy:Rnd(-3,3),life:20,c:'#a855f7',r:3, shape:'spark', angle:Rnd(0,6), vRot:Rnd(-0.1,0.1)}); 
                                }
                            }
                            this.items.splice(i,1);
                        }
                    } 
                    for(let i=this.parts.length-1;i>=0;i--){
                        const p=this.parts[i]; 
                        p.x+=p.vx; p.y+=p.vy;
                        if(p.vRot) p.angle = (p.angle || 0) + p.vRot; // Rotation update
                        p.vx *= 0.92; p.vy *= 0.92; // Friction
                        if(p.gravity) p.vy += 0.25; // Good gravity
                        p.life--; 
                        if(p.decay) p.r *= p.decay; else p.r = Math.max(0.1, p.r * 0.95); // Shrink 
                        if(p.life<=0 || p.r < 0.2) this.parts.splice(i,1);
                    } 
                    window.ui.hud(); 
                    window.ui.drawMinimap(); 
                } 
                const map=ARENAS[this.conf.arena]; ctx.fillStyle=map.color; ctx.fillRect(0,0,CFG.w,CFG.h); 
                ctx.save(); 
                if(this.state!=='MENU'){ 
                    const sx=(Math.random()-0.5)*this.shake, sy=(Math.random()-0.5)*this.shake; 
                    ctx.translate(-this.cam.x+sx, -this.cam.y+sy); 
                    this.drawTerrainEffects(); 
                    ctx.strokeStyle=map.grid; ctx.lineWidth=2; 
                    const tx=Math.floor(this.cam.x/100)*100, ty=Math.floor(this.cam.y/100)*100; 
                    ctx.beginPath(); 
                    for(let x=tx;x<tx+CFG.w+100;x+=100){ctx.moveTo(x,0);ctx.lineTo(x,this.world);} 
                    for(let y=ty;y<ty+CFG.h+100;y+=100){ctx.moveTo(0,y);ctx.lineTo(this.world,y);} 
                    ctx.stroke(); 
                    if(this.conf.mode === 'heist') { 
                        const chest = this.ents.find(e => e.type === 'chest'); 
                        if(chest) { 
                            const angle = Math.atan2(chest.y - this.player.y, chest.x - this.player.x); 
                            ctx.save(); ctx.translate(this.player.x, this.player.y); ctx.rotate(angle); 
                            ctx.fillStyle = '#facc15'; ctx.beginPath(); ctx.moveTo(60, 0); ctx.lineTo(50, -10); ctx.lineTo(50, 10); ctx.fill(); 
                            ctx.restore(); 
                        } 
                    } else if(this.conf.mode === 'train_defense' && this.train) {
                        const angle = Math.atan2(this.train.y - this.player.y, this.train.x - this.player.x);
                        ctx.save(); ctx.translate(this.player.x, this.player.y); ctx.rotate(angle);
                        ctx.fillStyle = '#3b82f6'; ctx.beginPath(); ctx.moveTo(60, 0); ctx.lineTo(50, -10); ctx.lineTo(50, 10); ctx.fill();
                        ctx.restore();
                    } else if(this.conf.mode === 'payload' && this.train) {
                        const angle = Math.atan2(this.train.y - this.player.y, this.train.x - this.player.x);
                        ctx.save(); ctx.translate(this.player.x, this.player.y); ctx.rotate(angle);
                        ctx.fillStyle = '#f97316'; ctx.beginPath(); ctx.moveTo(60, 0); ctx.lineTo(50, -10); ctx.lineTo(50, 10); ctx.fill();
                        ctx.restore();
                    } else if(this.conf.mode === 'cyber_hack') {
                        const term = this.ents.find(e => e.type === 'terminal');
                        if(term) {
                            ctx.save(); ctx.translate(term.x, term.y); 
                            ctx.fillStyle = `rgba(34, 211, 238, 0.3)`;
                            ctx.beginPath(); ctx.arc(0, 0, 200, 0, Math.PI*2); ctx.fill(); // Zone
                            ctx.fillStyle = '#22d3ee'; ctx.fillRect(-20, -20, 40, 40); // Terminal
                            ctx.fillStyle = 'white'; ctx.font = "bold 20px Orbitron"; ctx.textAlign = 'center';
                            ctx.fillText(Math.floor(this.hackProgress)+"%", 0, -40);
                            ctx.restore();
                        }
                    } else if(this.conf.mode === 'escape') {
                         const exit = this.ents.find(e => e.type === 'exit');
                         if(exit) {
                             ctx.save(); ctx.translate(exit.x, exit.y);
                             ctx.fillStyle = `rgba(16, 185, 129, 0.3)`;
                             ctx.beginPath(); ctx.arc(0, 0, 100 + Math.sin(this.frame*0.1)*20, 0, Math.PI*2); ctx.fill();
                             ctx.fillStyle = '#10b981'; ctx.font = "bold 30px Orbitron"; ctx.textAlign = 'center';
                             ctx.fillText("EXIT", 0, -40);
                             ctx.restore();
                          }
                     } else if(this.conf.mode === 'royale') {
                          ctx.save(); ctx.translate(this.world/2, this.world/2);
                          ctx.strokeStyle = '#10b981'; ctx.lineWidth = 10;
                          ctx.beginPath(); ctx.arc(0, 0, Math.max(0, this.gasRadius), 0, Math.PI*2); ctx.stroke();
                          // Gas overlay outside
                          ctx.beginPath(); ctx.arc(0, 0, Math.max(0, this.gasRadius), 0, Math.PI*2);
                          ctx.rect(this.world, -this.world, -this.world*2, this.world*2); // Inverse clip hack? No, simpler just draw giant ring
                          // Better: Draw full green screen with globalCompositeOperation but that's complex here.
                          // Just draw the circle limit.
                          ctx.restore();
                     } else if(this.conf.mode === 'zone_control') {
                         ctx.save(); ctx.translate(this.world/2, this.world/2);
                         ctx.fillStyle = `rgba(168, 85, 247, 0.2)`;
                         ctx.beginPath(); ctx.arc(0, 0, 200, 0, Math.PI*2); ctx.fill(); 
                         ctx.strokeStyle = '#a855f7'; ctx.lineWidth = 5; ctx.stroke();
                         ctx.beginPath(); ctx.arc(0, 0, 200 * (this.zoneProgress/100), 0, Math.PI*2); 
                         ctx.fillStyle = `rgba(168, 85, 247, 0.5)`; ctx.fill();
                         ctx.restore();
                    }
                    ctx.strokeStyle='#ef4444'; ctx.lineWidth=5; ctx.strokeRect(0,0,this.world,this.world); 
                    this.items.forEach(l=>{
                        if(l.type==='cube'){ctx.fillStyle='#22c55e';ctx.fillRect(l.x-10,l.y-10,20,20);ctx.shadowColor='#22c55e';ctx.shadowBlur=10;ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.strokeRect(l.x-10,l.y-10,20,20);ctx.shadowBlur=0;}
                        else if(l.type==='loot_bag'){ctx.fillStyle='#facc15';ctx.font='30px Arial';ctx.fillText('üí∞',l.x-15,l.y+10);}
                        else{ctx.fillStyle=l.t==='hp'?'#22c55e':'#a855f7';ctx.beginPath();ctx.arc(l.x,l.y,8,0,Math.PI*2);ctx.fill();}
                    }); 
                    const renderList = [...this.map, ...this.ents, this.player, ...this.projs, ...this.parts]; 
                    renderList.sort((a,b) => a.y - b.y); 
                    renderList.forEach(o => { 
                        if(o instanceof Wall) o.draw(ctx, map.wall); 
                        else if(o.draw) o.draw(ctx); 
                        else { 
                            ctx.fillStyle=o.c;
                            if (o.isRect || o.shape === 'rect') {
                                ctx.save(); ctx.translate(o.x, o.y); if(o.angle) ctx.rotate(o.angle);
                                ctx.fillRect(-o.r, -o.r, o.r*2, o.r*2);
                                ctx.restore();
                            } else if (o.shape === 'spark') {
                                ctx.save(); ctx.translate(o.x, o.y); if(o.angle) ctx.rotate(o.angle);
                                ctx.beginPath(); ctx.moveTo(0, -o.r*1.5); ctx.lineTo(o.r/2, 0); ctx.lineTo(0, o.r*1.5); ctx.lineTo(-o.r/2, 0); ctx.fill();
                                ctx.restore();
                            } else {
                                ctx.beginPath(); ctx.arc(o.x,o.y,o.r,0,Math.PI*2);ctx.fill(); 
                            }
                        } 
                    }); 
                    
                    // RENDU DES PROJECTILES UNIQUES
                    this.projs.forEach(p => { 
                        // Tra√Æn√©e
                        if (p.trailColor && this.frame % 3 === 0 && !p.melee) {
                            this.parts.push({ x: p.x, y: p.y, vx: -p.vx * 0.1, vy: -p.vy * 0.1, life: 10, c: p.trailColor, r: p.r / 3 });
                        }

                        ctx.shadowColor=p.c; ctx.shadowBlur=10; 
                        ctx.fillStyle=p.c; 

                        // Dessin par forme
                        if (p.shape === 'rock') {
                            ctx.font = `${p.r * 1.5}px Arial`;
                            ctx.fillText("üóø", p.x - p.r, p.y + p.r / 2);
                        } else if (p.shape === 'snake') {
                            ctx.font = `${p.r * 2}px Arial`;
                            ctx.fillText("üêç", p.x - p.r, p.y + p.r / 2);
                        } else if (p.shape === 'flame') {
                            ctx.font = `${p.r * 1.5}px Arial`;
                            ctx.fillText("üî•", p.x - p.r, p.y + p.r / 2);
                        } else if (p.shape === 'shark') {
                            ctx.font = `${p.r * 2}px Arial`;
                            ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(Math.atan2(p.vy, p.vx));
                            ctx.fillText("ü¶à", -p.r, p.r/2);
                            ctx.restore();
                        } else if (p.shape === 'arrow') {
                            ctx.font = `${p.r * 2}px Arial`;
                            ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(Math.atan2(p.vy, p.vx)+Math.PI/2); // Rotation 90deg for arrow
                            ctx.fillText("üèπ", -p.r, p.r/2);
                            ctx.restore();
                        } else if (p.shape === 'sniper') {
                            ctx.fillStyle = p.c;
                            ctx.beginPath();
                            ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
                            ctx.fill();
                            // Crosshair effect
                            ctx.strokeStyle = 'white';
                            ctx.lineWidth = 1;
                            ctx.beginPath(); ctx.moveTo(p.x-p.r*1.5, p.y); ctx.lineTo(p.x+p.r*1.5, p.y); ctx.stroke();
                            ctx.beginPath(); ctx.moveTo(p.x, p.y-p.r*1.5); ctx.lineTo(p.x, p.y+p.r*1.5); ctx.stroke();
                        } else if (p.shape === 'cross') {
                             ctx.font = `${p.r * 2}px Arial`;
                             ctx.fillText("‚úö", p.x - p.r, p.y + p.r / 2);
                        } else if (p.shape === 'paw') {
                            ctx.font = `${p.r * 1.5}px Arial`;
                            ctx.fillText("üêæ", p.x - p.r, p.y + p.r / 2);
                        } else if (p.shape === 'melee') {
                            // Melee est un simple arc tr√®s rapide pour simuler un coup
                            ctx.save();
                            ctx.translate(p.x, p.y);
                            ctx.rotate(this.player.angle);
                            ctx.fillStyle = p.c;
                            ctx.globalAlpha = 0.8 * (p.life / 1); // Dispara√Æt imm√©diatement
                            ctx.beginPath();
                            ctx.arc(0, 0, p.r, -0.5, 0.5); // Arc devant le joueur
                            ctx.lineTo(0, 0);
                            ctx.fill();
                            ctx.restore();
                        } else {
                            // Projectile standard (cercle/laser)
                            ctx.beginPath();
                            ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); 
                            ctx.fill(); 
                        }
                        
                        ctx.shadowBlur=0; 
                    }); 
                    this.texts.forEach((t,i)=>{
                        t.y+=t.vy; t.life--; 
                        t.vy *= 0.95; // Float slowing down
                        
                        ctx.save();
                        ctx.translate(t.x, t.y);
                        // Scale In/Out effect
                        const maxLife = 50;
                        let s = t.scale || 1;
                        const age = maxLife - t.life;
                        if (age < 10) s = s * Math.sin((age/10) * (Math.PI/2)); // Smooth pop in
                        if (t.life < 10) { ctx.globalAlpha = t.life/10; s *= 0.9; t.y -= 1; }
                        
                        ctx.scale(s, s);
                        ctx.fillStyle='black'; ctx.lineWidth=3; ctx.strokeText(t.t, 0, 0); // Outline for better visibility
                        ctx.fillStyle=t.c; ctx.font="900 24px 'Orbitron', 'Arial Black', sans-serif"; 
                        ctx.textAlign = 'center';
                        ctx.fillText(t.t,0,0);
                        ctx.restore();
                        ctx.globalAlpha=1;
                        if(t.life<=0)this.texts.splice(i,1);
                    }); 
                } 
                ctx.restore(); 
            }, 
            kill(e){ 
                e.dead=true; 
                
                // STREAK LOGIC
                const now = Date.now();
                if (now - (this.lastKillTime || 0) < 4000) { // 4 seconds window for streak
                    this.killStreak++;
                } else {
                    this.killStreak = 1;
                }
                this.lastKillTime = now;
                
                if (this.killStreak >= 2) {
                     window.ui.showStreak(this.killStreak);
                }

                const diffMult = DIFFICULTY[window.game.conf.difficulty].mult;
                this.score+=(e.isBoss||e.isBot?500:100) * diffMult; 
                this.player.xp=Math.min(this.player.xpMax-1, this.player.xp+(e.isBoss?300:20) * diffMult); 
                this.player.super=Math.min(100,this.player.super+(e.isBoss?30:10));   

                if(this.player.stats.passive === "Vol de Vie" && this.player.stats.type !== 'melee') {
                     if(window.game.conf.modifier !== 'oneshot') this.player.hp=Math.min(this.player.maxHp,this.player.hp+(e.isBoss?50:10)); // Heal on kill for ranged lifesteal
                }

                // Bot Death Emote (Spawns floating text)
                if (e.isBot && Math.random() < 0.5) {
                    const sadEmotes = ['üíÄ', 'üò≠', 'üíî', 'üòµ', 'üè≥Ô∏è', 'üëª'];
                    const em = sadEmotes[Math.floor(Math.random() * sadEmotes.length)];
                    this.texts.push({x:e.x, y:e.y-50, t:em, life:80, c:'#fff', vy:-1, scale:2});
                }

                // EXPLOSIVE MOD
                if (window.game.conf.modifier === 'explosive' || window.game.activeModifier === 'explosive') {
                    for(let i=0; i<8; i++) {
                        window.game.parts.push({x:e.x, y:e.y, vx:Rnd(-5,5), vy:Rnd(-5,5), life:30, c:'#f97316', r:6});
                    }
                    if (Dist(e, this.player) < 100) {
                        this.player.hp -= 50;
                        window.ui.flash();
                        if (this.player.hp <= 0) this.over("Tu√© par Explosion");
                    }
                }

                if(this.conf.mode === 'golden_chase' && Math.random() < 0.6) {
                    this.items.push({x:e.x, y:e.y, t:'coins'});
                }

                if(Math.random()<0.3) {
                     const r = Math.random();
                     let t = 'xp';
                     if(r < 0.35) t = 'hp';
                     else if(r < 0.7) t = 'xp';
                     else if(r < 0.95) t = 'coins';
                     else t = 'gems';
                     
                     this.items.push({x:e.x, y:e.y, t:t});
                }  
                // Manual check for 'collect' logic if we want "enemies drop X" or similar, but 'collect' is on pickup.
                // However, coins and gems from box:
                
                USER.stats.kills++; 
                this.killCount++;
                window.QuestSystem.check('kill', {}); // Quest Check
                window.ui.feed("Toi",e.isBot?"Rival":(e.type==='chest'?"COFFRE":e.name),true); 
                if(this.player.xp>=this.player.xpMax){this.player.xp=0;this.player.xpMax*=1.2;this.player.lvl++;this.player.hp=this.player.maxHp;this.state='LEVELUP';window.ui.levelUp();} 
                if(this.conf.mode === 'team_battle') {
                     if(!e.friend) this.teamScore++; else this.enemyScore++;
                     // Win Condition: 40 Kills
                     if(this.teamScore >= 40) this.over("VICTOIRE");
                     else if(this.enemyScore >= 40) this.over("D√âFAITE");
                }


                if(this.conf.mode === 'heist' && e.type === 'chest') this.over("VICTOIRE");
                if(this.conf.mode === 'defense' && e.type === 'core') this.over("D√âFAITE");
                if(this.conf.mode === 'boss_rush' && e.isBoss) {
                    this.bossKills = (this.bossKills || 0) + 1;
                    if(this.bossKills >= 3) this.over("VICTOIRE");
                    else {
                        const newBoss = new Enemy('boss', 3 + this.bossKills);
                        this.ents.push(newBoss);
                        window.ui.notif("BOSS SUIVANT !", "#ef4444");
                    }
                }
                if(this.conf.mode === 'titan_raid' && e.isBoss) {
                    this.bossKills = (this.bossKills || 0) + 1;
                    if(this.bossKills >= 5) this.over("VICTOIRE");
                }
            } 
        };
        
        window.onload=function(){ 
                if(window.game) { 
                window.game.init(); 
                window.ui.showIntro(); 
                
                // EVENT: NOEL SNOW
                const now = new Date();
                if(now.getMonth() === 11 || (now.getMonth() === 0 && now.getDate() < 15)) {
                    // Start snow effect
                    const c = document.getElementById('season-particles');
                    if(c) {
                        for(let i=0; i<50; i++) {
                            const s = document.createElement('div');
                            s.className = 'absolute bg-white rounded-full opacity-0 animate-snow';
                            s.style.width = Math.random()*4 + 2 + 'px';
                            s.style.height = s.style.width;
                            s.style.left = Math.random()*100 + '%';
                            s.style.animationDuration = Math.random()*10 + 5 + 's';
                            s.style.animationDelay = Math.random()*5 + 's';
                            s.style.opacity = Math.random()*0.5 + 0.3;
                            c.appendChild(s);
                        }
                        const style = document.createElement('style');
                        style.innerHTML = `
                            @keyframes animate-snow { 
                                0% { top: -10px; transform: translateX(0); } 
                                100% { top: 100%; transform: translateX(${Math.random()*100 - 50}px); } 
                            }
                            .animate-snow { animation-name: animate-snow; animation-iteration-count: infinite; animation-timing-function: linear; }
                        `;
                        document.head.appendChild(style);
                    }
                    // Visual Banner for Event
                     setTimeout(() => {
                        window.ui.notif("Joyeuses F√™tes ! üéÖüéÑ", "#ef4444");
                    }, 2000);
                }
            } 
        };
    </script>
</body></html>
