<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>mBattle v0.6.3 - mAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* --- CORE --- */
        body { margin: 0; overflow: hidden; background-color: #020617; font-family: 'Poppins', sans-serif; color: white; touch-action: none; user-select: none; -webkit-user-select: none; -webkit-tap-highlight-color: transparent; }
        canvas { display: block; }

        /* --- UI & GLASS --- */
        .glass-panel { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px rgba(0,0,0,0.6); border-radius: 24px; }
        .glass-nav { background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(30px); border-top: 1px solid rgba(255,255,255,0.1); }
        
        .glass-btn { position: relative; overflow: hidden; background: linear-gradient(180deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%); border: 1px solid rgba(255,255,255,0.15); transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1); }
        .glass-btn:active { transform: scale(0.96); filter: brightness(1.2); }
        .glass-btn.selected { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; box-shadow: 0 0 25px rgba(59, 130, 246, 0.25) inset; }
        
        .season-gold { border-color: #fbbf24 !important; background: linear-gradient(145deg, rgba(251, 191, 36, 0.1), rgba(0,0,0,0.6)) !important; box-shadow: 0 0 15px rgba(251, 191, 36, 0.2) !important; animation: pulse-gold-border 3s infinite; }
        .season-gold .icon-box { background: rgba(251, 191, 36, 0.2) !important; border: 1px solid rgba(251, 191, 36, 0.4); }
        
        .pass-pro-card { background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 0 30px rgba(147, 51, 234, 0.3); }

        .locked { opacity: 0.5; filter: grayscale(1); pointer-events: none; }
        .font-tech { font-family: 'Orbitron', sans-serif; letter-spacing: 1px; }
        .currency-badge { background: rgba(0,0,0,0.8); padding: 6px 14px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.15); font-family: 'Orbitron'; font-weight: 700; display: flex; align-items: center; gap: 8px; font-size: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        
        /* --- NAV ICONS --- */
        .nav-item { color: #64748b; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .nav-item.active { color: #60a5fa; transform: translateY(-4px) scale(1.05); text-shadow: 0 0 15px rgba(59, 130, 246, 0.6); }
        .nav-item.active .icon { transform: scale(1.1); }

        /* --- VFX --- */
        #vignette { position: absolute; inset: 0; pointer-events: none; background: radial-gradient(circle, transparent 50%, #000 120%); z-index: 5; }
        #gas-overlay { position: absolute; inset: 0; pointer-events: none; opacity: 0; background: radial-gradient(circle, transparent 30%, rgba(34, 197, 94, 0.4) 80%); z-index: 4; transition: opacity 0.5s; }
        #flash-layer { position: absolute; inset: 0; pointer-events: none; background: #ef4444; opacity: 0; transition: opacity 0.1s; z-index: 6; mix-blend-mode: overlay; }

        /* --- CONTROLS --- */
        .joystick-zone { position: absolute; width: 140px; height: 140px; pointer-events: auto; z-index: 50; opacity: 0; transition: opacity 0.2s; }
        .joystick-zone.active { opacity: 1; }
        
        .stick-base { 
            width: 130px; height: 130px; 
            border-radius: 50%; 
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(0,0,0,0.3) 70%); 
            border: 2px solid rgba(255,255,255,0.1); 
            position: absolute; bottom: 50px; 
            pointer-events: auto; 
            display: block !important; 
            transition: border-color 0.2s;
        }
        .stick-base.active { border-color: rgba(96, 165, 250, 0.5); background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, rgba(0,0,0,0.4) 70%); }
        
        #stick-left-base { left: 40px; }
        #stick-right-base { right: 40px; }
        
        .stick-knob { 
            width: 50px; height: 50px; 
            border-radius: 50%; 
            background: rgba(255,255,255,0.9); 
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            box-shadow: 0 0 20px rgba(255,255,255,0.3); 
            transition: transform 0.05s linear; 
        }
        
        .action-btn { position: absolute; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 60; pointer-events: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.5); transition: transform 0.1s; }
        .action-btn:active { transform: scale(0.9); }

        /* --- ANIM --- */
        .kill-msg { font-size: 12px; font-weight: 800; text-shadow: 0 2px 4px black; animation: slideIn 0.3s ease-out; margin-bottom: 6px; background: linear-gradient(90deg, rgba(0,0,0,0.9) 0%, transparent 100%); padding: 6px 12px; border-left: 4px solid #3b82f6; border-radius: 0 4px 4px 0; }
        .kill-msg.red { border-color: #ef4444; }
        @keyframes slideIn { from { opacity:0; transform:translateX(-30px); } to { opacity:1; transform:translateX(0); } }
        .menu-anim { background: radial-gradient(circle at center, #0f172a 0%, #020617 100%); }
        .safe-pb { padding-bottom: max(90px, env(safe-area-inset-bottom) + 90px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* --- PROGRESS BAR --- */
        .rank-progress-bg { background: rgba(255,255,255,0.1); border-radius: 10px; height: 8px; width: 100%; overflow: hidden; margin-top: 8px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); }
        .rank-progress-fill { height: 100%; background: linear-gradient(90deg, #fbbf24, #f59e0b); width: 0%; transition: width 0.5s ease-out; border-radius: 10px; }
        
        /* --- BATTLE PASS TRACK (DUAL) --- */
        .pass-track-container { overflow-x: auto; padding: 20px; scroll-behavior: smooth; position: relative; white-space: nowrap; -webkit-overflow-scrolling: touch; width: 100%; }
        .pass-wrapper { display: inline-block; min-width: 100%; }
        .pass-row { display: flex; gap: 20px; align-items: center; margin-bottom: 20px; position: relative; padding-left: 20px; padding-right: 20px; }
        .pass-row.pro { margin-top: 40px; }
        .pass-label { position: absolute; left: 10px; top: -25px; font-size: 12px; font-weight: bold; color: #94a3b8; text-transform: uppercase; letter-spacing: 2px; }
        .pro .pass-label { color: #d8b4fe; text-shadow: 0 0 10px rgba(168, 85, 247, 0.5); }
        
        .pass-step { 
            min-width: 100px; height: 100px; 
            background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            position: relative; z-index: 10; transition: all 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); white-space: normal; text-align: center;
        }
        .pass-step.pro { background: linear-gradient(145deg, rgba(88, 28, 135, 0.4), rgba(15, 23, 42, 0.8)); border-color: rgba(168, 85, 247, 0.4); }
        .pass-step.pro.locked::after { content: 'üîí'; position: absolute; font-size: 24px; opacity: 0.5; }
        
        .pass-step.claimed { opacity: 0.5; filter: grayscale(1); }
        .pass-step.claimed::before { content: '‚úì'; position: absolute; top: -5px; right: -5px; background: #10b981; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 2px solid #020617; z-index: 20; }
        
        .pass-step.active { transform: scale(1.1); z-index: 20; box-shadow: 0 0 20px rgba(255,255,255,0.2); border-color: white; }
        .pass-step.pro.active { box-shadow: 0 0 25px rgba(168, 85, 247, 0.4); border-color: #d8b4fe; }

        /* EMOTES */
        .emote-wheel { position: absolute; bottom: 120px; right: 20px; display: flex; flex-wrap: wrap; width: 160px; gap: 10px; z-index: 70; pointer-events: auto; }
        .emote-btn { width: 60px; height: 60px; background: rgba(0,0,0,0.8); border-radius: 50%; border: 2px solid white; font-size: 24px; display: flex; align-items: center; justify-content: center; transition: transform 0.1s; cursor: pointer; }
        .emote-btn:active { transform: scale(0.9); }
        .emote-grid-item { aspect-ratio: 1; background: rgba(255,255,255,0.05); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 32px; border: 2px solid transparent; cursor: pointer; transition: all 0.2s; }
        .emote-grid-item:hover { background: rgba(255,255,255,0.1); }
        .emote-grid-item.unlocked { border-color: rgba(255,255,255,0.1); }
        .emote-grid-item.locked { opacity: 0.3; filter: grayscale(1); cursor: not-allowed; }
        .emote-grid-item.selected { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); }

        /* STAT BARS */
        .stat-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .stat-label { width: 60px; font-size: 10px; font-weight: bold; color: #94a3b8; text-transform: uppercase; }
        .stat-track { flex: 1; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
        .stat-fill { height: 100%; border-radius: 4px; width: 0; transition: width 1s cubic-bezier(0.22, 1, 0.36, 1); }

        @keyframes pulse-gold-border { 0% { border-color: #fbbf24; box-shadow: 0 0 15px rgba(251, 191, 36, 0.2); } 50% { border-color: #fef3c7; box-shadow: 0 0 25px rgba(251, 191, 36, 0.5); } 100% { border-color: #fbbf24; box-shadow: 0 0 15px rgba(251, 191, 36, 0.2); } }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="gas-overlay"></div>
    <div id="vignette"></div>
    <div id="flash-layer"></div>
    <div id="season-particles" class="absolute inset-0 pointer-events-none overflow-hidden z-0"></div>

    <div id="ui-layer" class="absolute inset-0 pointer-events-none overflow-hidden z-10">
        
        <div id="hud" class="hidden w-full h-full relative">
            <!-- Top Left HUD -->
            <div class="absolute top-4 left-4 flex flex-col gap-4 pointer-events-auto">
                <div class="glass-panel p-2 flex items-center gap-3 pr-4 scale-90 origin-top-left md:scale-100">
                    <div class="relative">
                        <div class="w-14 h-14 rounded-xl bg-gray-900 border border-white/20 flex items-center justify-center text-2xl shadow-lg overflow-hidden">
                            <span id="hud-icon" class="z-10 relative">ü§ñ</span>
                            <div class="absolute inset-0 bg-gradient-to-br from-blue-600/40 to-transparent"></div>
                        </div>
                        <div class="absolute -bottom-2 -right-1 bg-black border border-gray-600 text-[9px] px-1.5 py-0.5 rounded text-yellow-400 font-bold" id="hud-lvl">LVL 1</div>
                    </div>
                    <div class="flex flex-col w-28 gap-1">
                        <div class="h-2.5 bg-gray-800 rounded-full overflow-hidden border border-gray-600 relative"><div id="hud-hp-bar" class="h-full bg-green-500 w-full transition-all duration-200"></div></div>
                        <div class="flex gap-1 h-1 mt-0.5">
                            <div id="ammo-1" class="flex-1 bg-orange-500 rounded-full opacity-50 transition"></div>
                            <div id="ammo-2" class="flex-1 bg-orange-500 rounded-full opacity-50 transition"></div>
                            <div id="ammo-3" class="flex-1 bg-orange-500 rounded-full opacity-50 transition"></div>
                        </div>
                    </div>
                </div>
                <div class="glass-panel p-1 border-white/20 bg-black/50"><canvas id="minimap" width="100" height="100" class="rounded-lg bg-black/80 opacity-90"></canvas></div>
            </div>
            
            <!-- Top Center HUD -->
            <div class="absolute top-6 left-1/2 -translate-x-1/2 text-center pointer-events-auto">
                <div id="hud-score" class="font-tech text-5xl font-bold text-white leading-none drop-shadow-[0_0_15px_rgba(255,255,255,0.4)]">0</div>
                <div class="text-[10px] font-bold text-blue-400 bg-black/50 px-2 rounded mt-1" id="hud-sub">VAGUE 1</div>
                <div id="hud-timer" class="text-xl font-black text-yellow-400 drop-shadow-lg mt-1 hidden">03:00</div>
            </div>

            <!-- Pause Button -->
            <div class="absolute top-4 right-4 flex flex-col gap-4 pointer-events-auto items-end">
                <button onclick="game.togglePause()" class="glass-panel w-10 h-10 flex items-center justify-center hover:bg-white/10 text-lg transition active:scale-90">‚è∏</button>
            </div>

            <!-- Boss Health -->
            <div id="boss-ui" class="hidden absolute top-24 left-1/2 -translate-x-1/2 w-3/4 max-w-lg pointer-events-auto transition-all duration-500">
                <div class="flex justify-between text-[10px] text-red-400 font-bold mb-1 uppercase tracking-widest"><span id="boss-name">BOSS</span><span id="boss-pct">100%</span></div>
                <div class="h-4 bg-red-950/80 border border-red-500/50 rounded-full overflow-hidden shadow-[0_0_20px_rgba(220,38,38,0.4)]"><div id="boss-bar" class="h-full bg-gradient-to-r from-red-600 to-red-500 w-full transition-all duration-200"></div></div>
            </div>

            <div id="kill-feed" class="absolute top-32 left-4 flex flex-col gap-2 w-48 pointer-events-none"></div>
            <div id="notif-area" class="absolute top-48 left-1/2 -translate-x-1/2 pointer-events-none flex flex-col items-center gap-2 w-full z-30"></div>
            
            <!-- EMOTES BTN -->
            <button id="btn-emote" class="absolute top-32 right-4 w-10 h-10 rounded-full glass-panel flex items-center justify-center text-xl pointer-events-auto active:scale-90 transition z-50" onmousedown="ui.toggleEmoteWheel()" ontouchstart="event.stopPropagation(); ui.toggleEmoteWheel()">üòÄ</button>
            <div id="emote-wheel" class="emote-wheel hidden"></div>

            <div id="mobile-controls" class="hidden absolute inset-0 z-40">
                <div id="stick-left-base" class="stick-base" style="left: 40px; bottom: 40px;"><div class="stick-knob"></div></div>
                <div id="stick-right-base" class="stick-base" style="right: 40px; bottom: 40px;"><div class="stick-knob"></div></div>
                <button id="btn-gadget" class="action-btn bottom-36 right-12 w-16 h-16 bg-green-900/90 border-2 border-green-500 active:scale-90 flex items-center justify-center pointer-events-auto transition shadow-lg" ontouchstart="event.stopPropagation(); game.player?.useGadget()" onmousedown="game.player?.useGadget()"><span class="font-tech font-bold text-[10px] z-10">GADGET</span><div class="absolute -top-1 -right-1 bg-black border border-white text-[9px] w-5 h-5 rounded-full flex items-center justify-center" id="gadget-count">3</div></button>
                <button id="btn-dash" class="action-btn bottom-12 right-36 w-20 h-20 rounded-full glass-panel border border-white/40 active:scale-90 flex items-center justify-center pointer-events-auto transition shadow-lg bg-blue-900/30" ontouchstart="event.stopPropagation(); game.player?.dash()" onmousedown="game.player?.dash()"><span class="text-3xl">‚ö°</span><div id="dash-cd" class="absolute inset-0 bg-black/70 origin-bottom h-0 transition-all duration-75 rounded-full"></div></button>
            </div>
        </div>

        <!-- MENU SCREEN -->
        <div id="menu-screen" class="absolute inset-0 menu-anim pointer-events-auto z-50 flex flex-col">
            <div class="w-full h-16 flex items-center justify-between px-5 pt-safe z-30 bg-gradient-to-b from-black/80 to-transparent">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-blue-500/20 border border-blue-400/30 flex items-center justify-center text-xl">ü§ñ</div>
                    <div><div class="font-tech font-bold leading-none text-lg">mBATTLE</div><div class="text-[10px] text-blue-400 font-bold tracking-widest">v0.6.0</div></div>
                </div>
                <div class="flex gap-3">
                    <div class="currency-badge"><span class="text-yellow-400">ü™ô</span> <span id="top-coins">0</span></div>
                    <div class="currency-badge"><span class="text-purple-400">üíé</span> <span id="top-gems">0</span></div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto safe-pb p-5 hide-scrollbar relative">
                <div id="tab-play" class="tab-content flex flex-col items-center justify-center min-h-[65vh] gap-6 animate-fadeIn">
                    <div class="w-full max-w-md glass-panel p-5 border-l-4 border-yellow-500 bg-yellow-900/10 relative overflow-hidden">
                        <div class="flex items-center justify-between mb-2 relative z-10">
                            <div><div class="text-[10px] text-gray-400 uppercase font-bold">Rang Actuel</div><div class="text-2xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 to-yellow-500 font-tech" id="menu-rank">BRONZE I</div></div>
                            <div class="text-center"><div class="text-2xl">üèÜ</div><div class="font-bold text-white text-xl" id="menu-trophies">0</div></div>
                        </div>
                        <div class="flex justify-between text-[10px] font-bold text-gray-300 mt-1 relative z-10">
                            <span id="rank-progress-text">Encore 100 üèÜ avant BRONZE II</span><span id="rank-progress-pct">0%</span>
                        </div>
                        <div class="rank-progress-bg relative z-10"><div id="rank-progress-fill" class="rank-progress-fill"></div></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 w-full max-w-md">
                        <div onclick="ui.showTab('starters')" class="glass-panel p-4 flex flex-col items-center justify-center aspect-square active:scale-95 transition bg-blue-900/10 border-blue-500/30">
                            <div class="text-[10px] text-blue-300 font-bold mb-2 uppercase">H√©ros</div><div class="text-5xl mb-2 drop-shadow-xl" id="play-icon">üéØ</div><div class="font-black text-lg leading-none" id="play-starter">Soldier</div>
                        </div>
                        <div onclick="ui.showTab('modes')" class="glass-panel p-4 flex flex-col items-center justify-center aspect-square active:scale-95 transition bg-purple-900/10 border-purple-500/30">
                            <div class="text-[10px] text-purple-300 font-bold mb-2 uppercase">Mission</div><div class="text-5xl mb-2 drop-shadow-xl" id="play-mode-icon">üî•</div><div class="font-black text-lg leading-none" id="play-mode">Survie</div>
                        </div>
                    </div>
                    <button onclick="game.start()" class="w-full max-w-md bg-gradient-to-r from-blue-600 to-indigo-600 h-20 rounded-2xl shadow-[0_0_40px_rgba(37,99,235,0.4)] flex items-center justify-center gap-4 active:scale-95 transition transform hover:-translate-y-1 mt-4 border border-white/20">
                        <span class="text-3xl font-black italic tracking-tighter">JOUER</span><span class="text-2xl animate-pulse">üöÄ</span>
                    </button>
                </div>

                <!-- PASS PRO DUO -->
                <div id="tab-pass" class="tab-content hidden animate-fadeIn w-full max-w-5xl mx-auto pb-20">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-3xl font-black flex items-center gap-2 font-tech"><span class="text-yellow-500">///</span> mPASS</h2>
                        <div class="text-right text-xs font-bold text-blue-300">SAISON 1: TITAN FURY</div>
                    </div>
                    
                    <div class="glass-panel p-6 mb-6 bg-gradient-to-r from-blue-900/20 to-transparent border-blue-500/30">
                        <div class="flex justify-between items-center mb-4">
                             <div><div class="text-2xl font-black text-white">Palier <span id="pass-lvl">1</span></div><div class="text-xs text-gray-400" id="pass-xp-txt">0/100 XP</div></div>
                             <div id="pass-pro-status"></div>
                        </div>
                        <div class="h-4 bg-black/50 rounded-full overflow-hidden"><div id="pass-bar" class="h-full bg-gradient-to-r from-blue-500 to-purple-500 w-0 transition-all duration-300"></div></div>
                    </div>

                    <div class="pass-track-container hide-scrollbar">
                        <div class="pass-wrapper">
                             <div class="pass-row" id="pass-track-free"><div class="pass-label">GRATUIT</div></div>
                             <div class="pass-row pro" id="pass-track-pro"><div class="pass-label">PRO üëë</div></div>
                        </div>
                    </div>
                </div>

                <div id="tab-starters" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto"><h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-blue-500">///</span> ARMURERIE</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-10" id="list-starters"></div></div>
                <div id="tab-modes" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto"><h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-purple-500">///</span> MISSIONS</h2><div class="grid grid-cols-1 gap-3 mb-8" id="list-modes"></div><h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-gray-400">TERRAINS</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-3" id="list-arenas"></div></div>
                <div id="tab-emotes" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto pb-20"><h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-pink-500">///</span> COLLECTION</h2><div class="glass-panel p-6 mb-4"><div class="text-xs text-gray-400 mb-4 uppercase font-bold">Emotes √âquip√©es</div><div class="flex justify-center gap-4 mb-2" id="equipped-emotes"></div></div><div class="grid grid-cols-4 md:grid-cols-6 gap-3" id="list-emotes"></div></div>
                
                <div id="tab-shop" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto pb-20">
                    <h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-yellow-500">///</span> MEGA MALL</h2>
                    <div class="text-xs text-right text-gray-400 mb-4">Nouveaux items: <span id="shop-timer" class="text-yellow-400 font-mono">--:--</span></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="shop-offers"></div>
                </div>
                
                <div id="tab-infos" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto"><h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-gray-500">///</span> INFOS</h2><div class="glass-panel p-6 mb-6 hidden md:block"><h3 class="text-xl font-bold text-blue-400 mb-4">COMMANDES PC</h3><table class="w-full text-sm text-left text-gray-300"><tr class="border-b border-gray-700"><th class="py-2">Action</th><th class="py-2">Touche</th></tr><tr><td class="py-2">D√©placement</td><td class="font-mono text-yellow-400">Z Q S D</td></tr><tr><td class="py-2">Viser</td><td class="font-mono text-yellow-400">Souris</td></tr><tr><td class="py-2">Tirer</td><td class="font-mono text-yellow-400">Clic Gauche</td></tr><tr><td class="py-2">Dash</td><td class="font-mono text-yellow-400">Espace</td></tr><tr><td class="py-2">Gadget</td><td class="font-mono text-yellow-400">E</td></tr><tr><td class="py-2">Emote</td><td class="font-mono text-yellow-400">V</td></tr></table></div><div class="grid grid-cols-2 gap-4 mb-8"><div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">‚ò†Ô∏è</div><div class="text-[10px] text-gray-500 uppercase font-bold">Kills</div><div class="text-2xl font-bold" id="stat-kills">0</div></div><div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">üåä</div><div class="text-[10px] text-gray-500 uppercase font-bold">Max Vague</div><div class="text-2xl font-bold" id="stat-wave">0</div></div><div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">üéÆ</div><div class="text-[10px] text-gray-500 uppercase font-bold">Parties</div><div class="text-2xl font-bold" id="stat-games">0</div></div><div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">‚öîÔ∏è</div><div class="text-[10px] text-gray-500 uppercase font-bold">Victoires</div><div class="text-2xl font-bold" id="stat-wins">0</div></div><div class="glass-panel p-4 col-span-2 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">üí•</div><div class="text-[10px] text-gray-500 uppercase font-bold">D√©g√¢ts Totaux</div><div class="text-2xl font-bold" id="stat-dmg">0</div></div></div><h3 class="text-xl font-bold mb-4 text-blue-400">PATCH NOTES</h3><div class="glass-panel p-6 text-sm text-gray-300"><div class="patch-note"><h3>v0.6.0 (SKINS & EMOTES)</h3><ul><li>üëï Skins : 2 nouveaux styles par h√©ros !</li><li>üòÄ Emotes : Exprime-toi en jeu (Touche V).</li><li>üõçÔ∏è Promo : Offres limit√©es dans la boutique.</li><li>üíé Pass V2 : Scroll infini & design Pro.</li></ul></div></div></div>
                <div id="tab-profile" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto pb-20">
                    <h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-white">///</span> COMPTE</h2>
                    <div class="glass-panel p-6 mb-6 flex items-center gap-6 bg-blue-900/10 border-blue-500/30">
                        <div class="relative group cursor-pointer" onclick="ui.openAvatarSelector()">
                            <div class="w-20 h-20 rounded-full bg-gray-800 border-2 border-white/20 flex items-center justify-center text-4xl shadow-lg overflow-hidden hover:border-blue-500 transition" id="profile-avatar">üë§</div>
                            <div class="absolute bottom-0 right-0 bg-blue-600 border border-white text-[10px] p-1 rounded-full text-white shadow-sm">‚úèÔ∏è</div>
                        </div>
                        <div class="flex-1">
                            <div class="text-xs text-gray-400 font-bold uppercase mb-1">Pseudonyme</div>
                            <input type="text" id="profile-name" class="bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-white font-bold w-full mb-2 focus:outline-none focus:border-blue-500 transition" onchange="USER.name = this.value; Storage.save();" value="Player">
                            <div class="flex justify-between items-center">
                                <div class="text-xs text-blue-400 font-tech tracking-widest" id="profile-tag">#TAG</div>
                                <div class="bg-black border border-gray-600 text-[10px] px-2 rounded text-yellow-400 font-bold" id="profile-lvl">LVL 1</div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="glass-panel p-6">
                            <div class="font-bold text-lg mb-2 flex items-center gap-2">üíæ Sauvegarde</div>
                            <div class="text-xs text-gray-400 mb-4">Copie ce code pour transf√©rer ton compte.</div>
                            <button onclick="ui.exportSave()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition text-sm">COPIER MA SAUVEGARDE üìã</button>
                        </div>
                        <div class="glass-panel p-6">
                            <div class="font-bold text-lg mb-2 flex items-center gap-2">üì• Importer</div>
                            <div class="text-xs text-gray-400 mb-4">Colle un code de sauvegarde ici.</div>
                            <button onclick="ui.importSave()" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-xl transition text-sm">IMPORTER SAUVEGARDE üîÑ</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="w-full glass-nav h-[90px] pb-safe flex justify-around items-center px-2 z-40 relative overflow-x-auto hide-scrollbar">
                <button onclick="ui.showTab('play')" id="nav-play" class="nav-item flex flex-col items-center p-2 min-w-[60px] active selected"><span class="text-2xl icon mb-1">‚öîÔ∏è</span><span class="text-[9px] font-bold">JOUER</span></button>
                <button onclick="ui.showTab('starters')" id="nav-starters" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">ü¶∏</span><span class="text-[9px] font-bold">H√âROS</span></button>
                <button onclick="ui.showTab('pass')" id="nav-pass" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">üé´</span><span class="text-[9px] font-bold">PASS</span></button>
                <button onclick="ui.showTab('emotes')" id="nav-emotes" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">üòÄ</span><span class="text-[9px] font-bold">EMOTES</span></button>
                <button onclick="ui.showTab('shop')" id="nav-shop" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">üõí</span><span class="text-[9px] font-bold">SHOP</span></button>
                <button onclick="ui.showTab('infos')" id="nav-infos" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">‚ÑπÔ∏è</span><span class="text-[9px] font-bold">STATS</span></button>
                <button onclick="ui.showTab('profile')" id="nav-profile" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">üë§</span><span class="text-[9px] font-bold">PROFIL</span></button>
            </div>
        </div>

        <!-- HERO DETAILS MODAL -->
        <div id="hero-details-modal" class="hidden absolute inset-0 bg-black/95 backdrop-blur-xl flex items-center justify-center z-[60] pointer-events-auto animate-fadeIn" onclick="this.classList.add('hidden')">
            <div class="glass-panel p-6 max-w-md w-full mx-4 relative border-2 border-blue-500/30" onclick="event.stopPropagation()" id="hero-card-inner">
                <button onclick="document.getElementById('hero-details-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl z-10">√ó</button>
                <div class="flex flex-col items-center mb-6"><div class="w-24 h-24 rounded-2xl bg-black/50 border-2 border-white/20 flex items-center justify-center text-6xl shadow-[0_0_30px_rgba(59,130,246,0.3)] mb-3" id="hd-icon"></div><h2 class="text-3xl font-black uppercase font-tech tracking-wider" id="hd-name"></h2><div class="text-blue-400 font-bold text-sm" id="hd-lvl"></div></div>
                <div class="space-y-4 mb-6"><div class="stat-row"><div class="stat-label">SANT√â</div><div class="stat-track"><div id="hd-bar-hp" class="stat-fill bg-green-500"></div></div></div><div class="stat-row"><div class="stat-label">D√âG√ÇTS</div><div class="stat-track"><div id="hd-bar-dmg" class="stat-fill bg-red-500"></div></div></div><div class="stat-row"><div class="stat-label">VITESSE</div><div class="stat-track"><div id="hd-bar-spd" class="stat-fill bg-yellow-400"></div></div></div></div>
                
                <!-- SKINS SELECTOR -->
                <div class="mb-4" id="hd-skins-container">
                    <div class="text-[10px] text-gray-400 uppercase font-bold mb-2">SKINS</div>
                    <div class="flex gap-2 overflow-x-auto hide-scrollbar" id="hd-skins-list"></div>
                </div>

                <div class="bg-white/5 p-4 rounded-xl border border-white/10 mb-4"><div class="flex justify-between"><div><div class="text-[10px] text-gray-400 uppercase font-bold mb-1">GADGET</div><div class="text-sm font-bold text-white flex items-center gap-2"><span id="hd-gadget-icon">‚ö°</span> <span id="hd-gadget-name"></span></div></div><div><div class="text-[10px] text-gray-400 uppercase font-bold mb-1 text-right">PASSIF</div><div class="text-sm font-bold text-yellow-400 text-right" id="hd-passive"></div></div></div></div>
                <p class="text-xs text-gray-400 italic text-center mb-6 leading-relaxed whitespace-pre-line" id="hd-desc"></p>
                <div id="hd-actions" class="grid gap-2"></div>
            </div>
        </div>

        <div id="avatar-selector" class="hidden absolute inset-0 bg-black/90 backdrop-blur-xl flex items-center justify-center z-[60] pointer-events-auto animate-fadeIn" onclick="this.classList.add('hidden')">
            <div class="glass-panel p-6 max-w-sm w-full mx-4" onclick="event.stopPropagation()"><h3 class="text-xl font-black mb-4 text-center">CHOISIS TON AVATAR</h3><div class="grid grid-cols-4 gap-4 mb-4" id="avatar-grid"></div><button onclick="document.getElementById('avatar-selector').classList.add('hidden')" class="w-full bg-gray-700 py-3 rounded-xl font-bold">ANNULER</button></div>
        </div>
        <div id="levelup-screen" class="hidden absolute inset-0 bg-black/90 backdrop-blur-xl flex items-center justify-center z-[60] pointer-events-auto animate-fadeIn">
            <div class="w-full max-w-sm p-6 text-center"><h2 class="text-5xl font-tech text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 font-black mb-4 animate-bounce">LEVEL UP!</h2><div id="perk-container" class="grid gap-3"></div></div>
        </div>
        <div id="gameover-screen" class="hidden absolute inset-0 bg-red-950/95 backdrop-blur-2xl flex items-center justify-center z-[70] pointer-events-auto animate-fadeIn">
            <div class="text-center max-w-sm w-full p-6">
                <h1 class="text-8xl font-black text-white mb-2 drop-shadow-2xl tracking-tighter">KO</h1>
                <p class="text-red-400 font-bold text-xl mb-8 uppercase tracking-widest" id="go-reason">√âlimin√©</p>
                <div class="glass-panel p-6 mb-6 grid grid-cols-2 gap-4 text-left bg-black/40">
                    <div><div class="text-[10px] text-gray-500 uppercase font-bold mb-1">Score</div><div id="go-score" class="text-2xl font-black text-white font-tech">0</div></div>
                    <div><div class="text-[10px] text-gray-500 uppercase font-bold mb-1">Gains</div><div class="text-xl font-bold text-yellow-400" id="go-rewards"></div></div>
                </div>
                <button onclick="game.toMenu()" class="w-full bg-white text-black font-black py-4 rounded-xl active:scale-95 transition shadow-xl text-lg">RETOUR MENU üè†</button>
            </div>
        </div>
    </div>

    <script>
        /* mBATTLE TITAN v0.6.0 - SKINS & EMOTES */
        const CFG = { w: 0, h: 0, world: 2500 };
        const STARTERS = {
            soldier: { name: "Soldier", icon: "üî´", hp: 130, dmg: 22, spd: 5.5, rate: 14, ammo:3, reload:40, price: 0, scale:{hp:10, dmg:2}, color: '#3b82f6', desc: "Polyvalent.", gadget: "heal", lore: "V√©t√©ran des guerres galactiques.", passive: "Regen Rapide", skins: [ {id:'default', name:'Soldat', c:'#3b82f6'}, {id:'gold', name:'Soldat Or', c:'#fbbf24', price: 2000}, {id:'commando', name:'Commando', c:'#166534', price: 1500} ] },
            tank:    { name: "Heavy",   icon: "üõ°Ô∏è", hp: 320, dmg: 14, spd: 3.5, rate: 35, ammo:3, reload:55, price: 500, scale:{hp:30, dmg:1}, color: '#22c55e', type: 'shotgun', desc: "Sac √† PV.", gadget: "shield", lore: "Une forteresse mobile.", passive: "Armure +20%", skins: [ {id:'default', name:'Heavy', c:'#22c55e'}, {id:'toxic', name:'Toxic', c:'#a3e635', price: 1500}, {id:'mecha', name:'Mecha', c:'#f3f4f6', price: 2500} ] },
            sniper:  { name: "Sniper",  icon: "ü¶Ö", hp: 80,  dmg: 120, spd: 5, rate: 65, ammo:3, reload:80, price: 800, scale:{hp:5, dmg:15}, color: '#a855f7', type: 'sniper', desc: "Tireur d'√©lite.", gadget: "knockback", lore: "Ne rate jamais sa cible.", passive: "Critique +10%", skins: [{id:'default', name:'Sniper', c:'#a855f7'}, {id:'elite', name:'Elite', c:'#1e1b4b', price: 3000}, {id:'camo', name:'Camo', c:'#3f6212', price: 1500}] },
            assassin:{ name: "Assassin",icon: "üó°Ô∏è", hp: 90,  dmg: 18, spd: 7.5, rate: 8, ammo:4, reload:30,  price: 1200, scale:{hp:8, dmg:4}, color: '#ef4444', desc: "Ultra rapide.", gadget: "speed", lore: "Une ombre dans la nuit.", passive: "Vitesse Kill", skins: [{id:'default', name:'Assassin', c:'#ef4444'}, {id:'ninja', name:'Ninja', c:'#171717', price: 2500}, {id:'void', name:'N√©ant', c:'#4c1d95', price: 3500}] },
            pyro:    { name: "Pyro",    icon: "üî•", hp: 160, dmg: 7, spd: 5, rate: 4, ammo:50, reload:10, price: 1500, scale:{hp:15, dmg:1}, color: '#f97316', type: 'flame', desc: "Zone de feu.", gadget: "dash", lore: "Adore l'odeur du napalm.", passive: "Br√ªlure", skins: [{id:'default', name:'Pyro', c:'#f97316'}, {id:'blueflame', name:'Flamme Bleue', c:'#3b82f6', price: 2000}, {id:'toxic', name:'Toxique', c:'#16a34a', price: 1500}] },
            ronin:   { name: "Ronin",   icon: "üëπ", hp: 180, dmg: 60, spd: 6.5, rate: 25, ammo:3, reload:40, price: 3000, scale:{hp:12, dmg:8}, color: '#be185d', type: 'melee', desc: "Katana.", gadget: "heal", lore: "Cherche la r√©demption.", passive: "Vol de Vie", skins: [{id:'default', name:'Ronin', c:'#be185d'}, {id:'ghost', name:'Fant√¥me', c:'#e5e7eb', price: 3500}, {id:'cyber', name:'Cyber', c:'#06b6d4', price: 3000}] },
            cyber:   { name: "Cyber",   icon: "ü¶æ", hp: 140, dmg: 35, spd: 5, rate: 20, ammo:3, reload:45, price: 5000, scale:{hp:10, dmg:5}, color: '#06b6d4', type: 'laser', desc: "Laser.", gadget: "teleport", lore: "Fusion homme-machine.", passive: "Pr√©cision", skins: [{id:'default', name:'Cyber', c:'#06b6d4'}, {id:'neon', name:'N√©on', c:'#d946ef', price: 4000}, {id:'proto', name:'Proto', c:'#64748b', price: 2000}] },
            titan:   { name: "Titan",   icon: "ü¶æ", hp: 600, dmg: 40, spd: 3.0, rate: 50, ammo:2, reload:70, price: 0, scale:{hp:50, dmg:5}, color: '#eab308', type: 'melee', desc: "SAISON 1 GRATUIT.", gadget: "shield", lore: "Gardien l√©gendaire.", passive: "R√©sistance", skins: [{id:'default', name:'Titan', c:'#eab308'}, {id:'prime', name:'Titan Prime', c:'#713f12', price: 9999}, {id:'frozen', name:'Givr√©', c:'#0ea5e9', price: 5000}] },
            volt:    { name: "Volt",    icon: "‚ö°", hp: 110, dmg: 18, spd: 6.0, rate: 10, ammo: 4, reload: 30, price: 2000, scale:{hp:8, dmg:3}, color: '#facc15', desc: "Tir √©lectrique.", gadget: "speed", lore: "√ânergie statique.", passive: "Etourdissement", skins: [{id:'default', name:'Volt', c:'#facc15'}, {id:'plasma', name:'Plasma', c:'#8b5cf6', price: 2500}, {id:'dark', name:'Sombre', c:'#1e293b', price: 2000}] },
            goliath: { name: "Goliath", icon: "üóø", hp: 450, dmg: 12, spd: 3.0, rate: 40, ammo: 2, reload: 60, price: 4000, scale:{hp:40, dmg:2}, color: '#78716c', type: 'shotgun', desc: "Lance des rochers.", gadget: "shield", lore: "G√©ant de pierre.", passive: "√âcrasement", skins: [{id:'default', name:'Goliath', c:'#78716c'}, {id:'moss', name:'Mousse', c:'#166534', price: 1500}, {id:'obsidian', name:'Obsidienne', c:'#0f172a', price: 3500}] },
            magma:   { name: "Magma",   icon: "üåã", hp: 380, dmg: 60, spd: 3.2, rate: 45, ammo: 2, reload: 55, price: 5000, scale:{hp:25, dmg:4}, color: '#7f1d1d', type: 'flame', desc: "SAISON 1.", gadget: "dash", lore: "N√© dans un volcan.", passive: "Lave", skins: [{id:'default', name:'Magma', c:'#7f1d1d'}, {id:'blue', name:'Flamme Bleue', c:'#2563eb', price: 3000}, {id:'obsidian', name:'Obsidienne', c:'#171717', price: 4000}] },
            pulse:   { name: "Pulse",   icon: "üí†", hp: 100, dmg: 25, spd: 5.8, rate: 12, ammo: 4, reload: 25, price: 3000, scale:{hp:8, dmg:3}, color: '#22d3ee', desc: "Ondes d'√©nergie.", gadget: "knockback", lore: "Technicien sonique.", passive: "Aura Dmg", skins: [{id:'default', name:'Pulse', c:'#22d3ee'}, {id:'neon', name:'N√©on', c:'#f0abfc', price: 2500}, {id:'darkmatter', name:'Mati√®re Noire', c:'#312e81', price: 3500}] }
        };
        
        const MODES = { survival: { name: "Survie", icon: "üßü", desc: "Vagues infinies.", ranked: false }, ranked: { name: "Class√©", icon: "üèÜ", desc: "Comp√©tition.", ranked: true }, duel: { name: "1v1 Duel", icon: "‚öîÔ∏è", desc: "Duel Bot IA.", ranked: false, boss: true }, heist: { name: "Braquage", icon: "üíé", desc: "D√©truis le coffre!", ranked: false, boss: true }, boss_rush: { name: "Boss Rush", icon: "üëπ", desc: "Combat de Boss.", ranked: false, boss: true }, titan_raid: { name: "Raid Titan", icon: "üåã", desc: "L'ultime d√©fi.", ranked: false, boss: true, special: true }, defense: { name: "D√©fense", icon: "üõ°Ô∏è", desc: "Prot√®ge le cristal.", ranked: false, boss: true }, infection: { name: "Infection", icon: "‚ò£Ô∏è", desc: "Survivre √† la horde.", ranked: false } };
        const ARENAS = { tokyo: { name: "Neon Tokyo", color: '#050b14', grid: 'rgba(59,130,246,0.15)', wall: '#1e293b' }, sand: { name: "Sandstorm",  color: '#271a0c', grid: 'rgba(245,158,11,0.15)', wall: '#451a03' }, ice: { name: "Ice Age", color: '#082f49', grid: 'rgba(255,255,255,0.1)', wall: '#164e63' }, jungle: { name: "Jungle", color: '#064e3b', grid: 'rgba(34,197,94,0.2)', wall: '#052e16' }, magma: { name: "Magma", color: '#450a0a', grid: 'rgba(239,68,68,0.2)', wall: '#280505' }, titan_forge: { name: "La Forge", color: '#2a0a0a', grid: 'rgba(250,204,21,0.2)', wall: '#4a0404', special: true }, ruins: { name: "Ruines", color: '#292524', grid: 'rgba(168,162,158,0.1)', wall: '#44403c' }, cyber_city: { name: "Cyber City", color: '#0f172a', grid: 'rgba(6,182,212,0.2)', wall: '#164e63' } };
        const PERKS = [{ name: 'Gros Calibre', icon: 'üí™', desc: '+25% D√©g√¢ts', fn: p => p.stats.dmg *= 1.25 }, { name: 'Armure Nano', icon: 'ü¶∫', desc: '+30% PV Max', fn: p => { p.maxHp *= 1.3; p.hp += 50; } }, { name: 'Turbo', icon: 'üëü', desc: '+15% Vitesse', fn: p => p.stats.spd *= 1.15 }];
        const RANKS = [{n:"BRONZE I", t:0, c:"#cd7f32"}, {n:"BRONZE II", t:100, c:"#cd7f32"}, {n:"BRONZE III", t:200, c:"#cd7f32"}, {n:"SILVER I", t:300, c:"#c0c0c0"}, {n:"SILVER II", t:500, c:"#c0c0c0"}, {n:"SILVER III", t:700, c:"#c0c0c0"}, {n:"GOLD I", t:1000, c:"#ffd700"}, {n:"GOLD II", t:1300, c:"#ffd700"}, {n:"GOLD III", t:1600, c:"#ffd700"}, {n:"PLATINUM I", t:2000, c:"#22d3ee"}, {n:"PLATINUM II", t:2500, c:"#22d3ee"}, {n:"DIAMOND", t:3500, c:"#a855f7"}, {n:"mMASTER", t:5000, c:"#ef4444"}];
        const ICONS = ["üë§","ü§ñ","üëΩ","ü¶Å","ü¶Ñ","üíÄ","‚öîÔ∏è","üíé","üëë","üéÆ","üöÄ","üî•","‚ùÑÔ∏è","‚ö°","üåü","üê±"];
        const EMOTE_LIST = [{id:'happy', i:'üòÄ'}, {id:'angry', i:'üò°'}, {id:'gg', i:'üëç'}, {id:'rip', i:'üíÄ'}, {id:'love', i:'üòç'}, {id:'clown', i:'ü§°'}, {id:'fire', i:'üî•'}, {id:'crown', i:'üëë'}, {id:'ghost', i:'üëª'}, {id:'robot', i:'ü§ñ'}, {id:'flex', i:'üí™'}, {id:'cry', i:'üò≠'}];

        const CURRENT_VERSION_KEY = 'mBattle_Data_v20';
        const PREVIOUS_KEYS = ['mBattle_Data_v19', 'mBattle_Data_v18', 'mBattle_Data_v17', 'mBattle_Data_v16']; 

        let USER = { 
            name: "Joueur", avatar: "üë§", tag: "#" + Math.random().toString(36).substr(2, 6).toUpperCase(),
            coins: 500, gems: 10, trophies: 0, unlocked: ['soldier', 'titan'], levels: { soldier: 1, titan: 1 }, selected: 'soldier', 
            stats: { kills: 0, maxWave: 0, games: 0, wins: 0, dmg: 0 }, lastDaily: 0, 
            pass: { tier: 1, xp: 0, claimed: [], claimedPro: [] }, 
            shop: { lastRefresh: 0, items: [] },
            emotes: ['happy', 'angry', 'gg', 'rip'], equippedEmotes: ['happy', 'angry', 'gg', 'rip'],
            mPassPro: false,
            skins: {}, // { heroId: 'skinId' }
            ownedSkins: [] // ['soldier_gold', 'tank_toxic']
        };

        const Storage = {
            save() { localStorage.setItem(CURRENT_VERSION_KEY, JSON.stringify(USER)); },
            load() {
                let d = localStorage.getItem(CURRENT_VERSION_KEY);
                if (!d) { for (let key of PREVIOUS_KEYS) { const oldData = localStorage.getItem(key); if (oldData) { d = oldData; break; } } }
                if (d) { 
                    try { 
                        const saved = JSON.parse(d); 
                        USER = { ...USER, ...saved, 
                            stats: { ...USER.stats, ...(saved.stats||{}) }, 
                            pass: { ...USER.pass, ...(saved.pass||{}), claimedPro: saved.pass?.claimedPro || [] }, 
                            shop: { ...USER.shop, ...(saved.shop||{}) }, 
                            levels: { ...USER.levels, ...(saved.levels||{}) },
                            emotes: saved.emotes || ['happy', 'angry', 'gg', 'rip'],
                            equippedEmotes: saved.equippedEmotes || ['happy', 'angry', 'gg', 'rip'],
                            mPassPro: saved.mPassPro || false,
                            skins: saved.skins || {},
                            ownedSkins: saved.ownedSkins || []
                        }; 
                        if(!USER.unlocked.includes('titan')) USER.unlocked.push('titan'); 
                        this.save(); 
                    } catch (e) {} 
                }
                ui.refreshShop();
            }
        };

        const Rnd = (min,max) => Math.random()*(max-min)+min;
        const Dist = (e1,e2) => Math.hypot(e1.x-e2.x, e1.y-e2.y);
        function ColRect(c, r) { return c.x+c.r > r.x && c.x-c.r < r.x+r.w && c.y+c.r > r.y && c.y-c.r < r.y+r.h; }
        function resolveCollision(e1, e2) { 
            let dx=e1.x-e2.x, dy=e1.y-e2.y; let dist=Math.hypot(dx,dy); const minDist=e1.r+e2.r; 
            if(dist < minDist) {
                if(dist <= 0.01) { dx=1; dy=0; dist=1; } 
                const o=minDist-dist, px=(dx/dist)*o*0.5, py=(dy/dist)*o*0.5; 
                const m1 = (e1.type==='chest' || e1.type==='core') ? Infinity : 1; 
                const m2 = (e2.type==='chest' || e2.type==='core') ? Infinity : 1;
                let r1, r2; if(m1===Infinity && m2===Infinity){r1=0;r2=0;} else if(m1===Infinity){r1=0;r2=1;} else if(m2===Infinity){r1=1;r2=0;} else {r1=0.5;r2=0.5;}
                e1.x+=px*r1; e1.y+=py*r1; e2.x-=px*r2; e2.y-=py*r2; 
            } 
        }
        const getGadgetName = (g) => { const map = { 'heal': 'Soin (+1000)', 'shield': 'Bouclier (+1000)', 'teleport': 'TP', 'dash': 'Dash Feu', 'speed': 'Turbo', 'knockback': 'Choc' }; return map[g] || g.toUpperCase(); }

        const el = (id) => document.getElementById(id);
        const setStyle = (id, prop, val) => { const e=el(id); if(e) e.style[prop]=val; };
        const setText = (id, txt) => { const e=el(id); if(e) e.innerText=txt; };

        const ui = {
            hud() {
                if(!game.player) return; const p = game.player;
                setStyle('hud-hp-bar', 'width', (p.hp/p.maxHp*100)+'%');
                setText('hud-score', game.score); setText('hud-sub', MODES[game.conf.mode].name.toUpperCase());
                if(game.conf.mode !== 'survival' && game.conf.mode !== 'ranked' && game.conf.mode !== 'infection' && game.conf.mode !== 'duel') {
                    const min = Math.floor(game.timeLeft / 3600); const sec = Math.floor((game.timeLeft % 3600) / 60);
                    const te = el('hud-timer'); if(te) { te.innerText = (min < 10 ? "0"+min : min) + ":" + (sec < 10 ? "0"+sec : sec); te.classList.remove('hidden'); }
                } else { const te = el('hud-timer'); if(te) te.classList.add('hidden'); }
                for(let i=1; i<=3; i++) setStyle('ammo-'+i, 'opacity', i <= Math.floor(p.ammo) ? 1 : 0.3);
                setStyle('dash-cd', 'height', Math.max(0,p.dashT/60*100)+'%');
                setText('gadget-count', p.gadgetCharges);
                const gb=el('btn-gadget'); if(gb) { gb.disabled = p.gadgetCharges<=0; if(p.gadgetCharges<=0)gb.classList.add('opacity-50');else gb.classList.remove('opacity-50'); }
                
                const boss=game.ents.find(e=>e.isBoss||e.isBot||e.type==='core'); const bui=el('boss-ui');
                if(boss && bui){ 
                    bui.classList.remove('hidden'); 
                    let label = boss.isBot ? "RIVAL" : (boss.type==='chest'?"COFFRE":(boss.type==='core'?"CRISTAL":"BOSS"));
                    setText('boss-name', label); 
                    setStyle('boss-bar', 'width', (boss.hp/boss.maxHp*100)+'%'); setText('boss-pct', Math.ceil(boss.hp/boss.maxHp*100)+'%');
                    const bar = el('boss-bar');
                    if(boss.type==='core') { bar.classList.remove('bg-gradient-to-r', 'from-red-600', 'to-red-500'); bar.style.backgroundColor = '#3b82f6'; }
                    else { bar.classList.add('bg-gradient-to-r', 'from-red-600', 'to-red-500'); bar.style.backgroundColor = ''; }
                } else if(bui) bui.classList.add('hidden');
                setStyle('gas-overlay', 'opacity', 0);
            },
            notif(m,c) { const d=document.createElement('div'); d.className='text-2xl font-black italic drop-shadow-2xl animate-bounce text-center px-4 py-1 bg-black/60 rounded-xl border border-white/10 backdrop-blur-sm shadow-xl'; d.style.color=c; d.innerText=m; el('notif-area').appendChild(d); setTimeout(()=>d.remove(),2000); },
            flash() { setStyle('flash-layer', 'opacity', 0.6); setTimeout(()=>setStyle('flash-layer', 'opacity', 0), 100); },
            feed(k,v,g) { const d=document.createElement('div'); d.className=`kill-msg ${g?'':'red'}`; d.innerHTML=`<span class="${g?'text-blue-400':'text-red-400'}">${k}</span> ‚ò†Ô∏è ${v}`; const c=el('kill-feed'); if(c){ c.prepend(d); if(c.children.length>4)c.lastChild.remove(); } setTimeout(()=>d.remove(),4000); },
            levelUp() { const s=el('levelup-screen'), c=el('perk-container'); c.innerHTML=''; s.classList.remove('hidden'); PERKS.sort(()=>0.5-Math.random()).slice(0,3).forEach(p=>{ const b=document.createElement('button'); b.className='glass-panel p-4 text-left flex items-center gap-4 active:scale-95 transition bg-blue-900/40 border border-blue-500/30'; b.innerHTML=`<div class="text-3xl">${p.icon}</div><div><div class="font-bold text-yellow-400 text-lg">${p.name}</div><div class="text-xs text-gray-300">${p.desc}</div></div>`; b.onclick=()=>{p.fn(game.player); s.classList.add('hidden'); game.state='PLAYING';}; c.appendChild(b); }); },
            drawMinimap() {
                const cvs = document.getElementById('minimap'); if(!cvs) return; const ctx = cvs.getContext('2d'); ctx.clearRect(0, 0, 100, 100); const scale = 100 / game.world;
                if (game.player) { ctx.fillStyle = '#3b82f6'; ctx.beginPath(); ctx.arc(game.player.x * scale, game.player.y * scale, 4, 0, Math.PI * 2); ctx.fill(); }
                (game.ents||[]).forEach(e => { if(e.hidden)return; ctx.fillStyle = (e.isBoss || e.isBot) ? '#ef4444' : (e.type==='core'?'#3b82f6':'#f87171'); const r = (e.isBoss || e.isBot || e.type==='core') ? 4 : 2; ctx.beginPath(); ctx.arc(e.x * scale, e.y * scale, r, 0, Math.PI * 2); ctx.fill(); });
                (game.map||[]).forEach(w => { if(w.type === 1) ctx.fillStyle = 'rgba(34, 197, 94, 0.8)'; else if(w.type === 3) ctx.fillStyle = '#d97706'; else ctx.fillStyle = 'rgba(255,255,255,0.4)'; ctx.fillRect(w.x * scale, w.y * scale, w.w * scale, w.h * scale); });
            },
            showTab(id) { document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden')); document.getElementById('tab-' + id).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active', 'selected')); const btn = document.getElementById('nav-' + id); if(btn) btn.classList.add('active', 'selected'); if(id === 'starters' || id === 'modes') this.renderLists(); if(id === 'infos') this.updateStats(); if(id === 'pass') this.renderPass(); if(id === 'shop') this.renderShop(); if(id === 'profile') this.renderProfile(); if(id === 'emotes') this.renderEmotes(); },
            refreshShop() {
                if(Date.now() > USER.shop.lastRefresh + 86400000) {
                    USER.shop.lastRefresh = Date.now();
                    USER.shop.items = [];
                    // SLOT 0: FREE
                    const freeType = ['coins','xp','gems'][Math.floor(Math.random()*3)];
                    if(freeType === 'coins') USER.shop.items.push({ type: 'coins', cost: 0, val: 100, curr: 'free', name: "Pi√®ces Gratuites" });
                    if(freeType === 'xp') USER.shop.items.push({ type: 'xp', cost: 0, val: 50, curr: 'free', name: "XP Pass Gratuit" });
                    if(freeType === 'gems') USER.shop.items.push({ type: 'gems', cost: 0, val: 5, curr: 'free', name: "Gemmes Gratuites" });

                    // SLOTS 1-3: Random
                    for(let i=0; i<3; i++) {
                        const t = ['coins','gems','box', 'xp', 'skin'][Math.floor(Math.random()*5)];
                        if(t==='coins') USER.shop.items.push({type:'coins',cost:20,val:300,curr:'gems', name: "Pack de Pi√®ces"});
                        if(t==='gems') USER.shop.items.push({type:'gems',cost:500,val:30,curr:'coins', name: "Sac de Gemmes"});
                        if(t==='box') USER.shop.items.push({type:'box',cost:80,val:1,curr:'coins', name: "Mega Caisse"});
                        if(t==='xp') USER.shop.items.push({type:'xp',cost:100,val:100,curr:'coins', name: "Boost de Pass"});
                        if(t==='skin') {
                            // Simple random skin logic
                            const s = STARTERS[Object.keys(STARTERS)[Math.floor(Math.random()*Object.keys(STARTERS).length)]];
                            if(s.skins && s.skins.length > 1) {
                                const skin = s.skins[1]; // Get non-default
                                USER.shop.items.push({type:'skin',cost:skin.price,val:1,curr:'coins', name: `Skin ${skin.name}`, skinId: skin.id, hero: s.name, discount: Math.random() > 0.5 ? 30 : 0});
                            } else {
                                // Fallback
                                USER.shop.items.push({type:'coins',cost:20,val:300,curr:'gems', name: "Pack de Pi√®ces"});
                            }
                        }
                    }
                    Storage.save();
                }
            },
            renderShop() {
                const now = Date.now(); const btn = el('btn-daily');
                if(btn) { if(now - USER.lastDaily > 86400000) { btn.disabled = false; btn.innerText = "R√âCLAMER"; btn.classList.remove('opacity-50'); } else { btn.disabled = true; btn.innerText = "D√âJ√Ä RE√áU"; btn.classList.add('opacity-50'); } }
                const left = (USER.shop.lastRefresh + 86400000) - now; const hrs = Math.floor(left / 3600000); const mins = Math.floor((left % 3600000) / 60000);
                setText('shop-timer', `${hrs}h ${mins}m`);
                
                const c = el('shop-offers'); c.innerHTML = '';
                
                // Flash Sales Section (New!)
                c.innerHTML += `<h3 class="col-span-1 md:col-span-2 text-xl font-bold text-yellow-400 flex items-center gap-2">üî• OFFRES FLASH üî•</h3>`;

                USER.shop.items.forEach((item, idx) => {
                    let icon = item.type==='coins'?'ü™ô':(item.type==='gems'?'üíé':(item.type==='xp'?'üé´':(item.type==='skin'?'üëï':'üì¶')));
                    let curIcon = item.curr==='coins'?'ü™ô':(item.curr==='gems'?'üíé':'üéÅ');
                    let color = item.curr==='free' ? 'free-item' : 'bg-white/5';
                    let btnClass = item.curr==='free' ? 'bg-green-600 hover:bg-green-500' : (item.curr==='gems'?'bg-purple-600 hover:bg-purple-500':'bg-yellow-600 hover:bg-yellow-500');
                    
                    let costDisplay = `${item.cost} ${curIcon}`;
                    let discountBadge = '';
                    
                    if(item.discount) {
                        const newCost = Math.floor(item.cost * (1 - item.discount/100));
                        costDisplay = `<span class="line-through text-gray-400 text-xs mr-2">${item.cost}</span> ${newCost} ${curIcon}`;
                        discountBadge = `<div class="absolute top-2 right-2 bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded-full animate-pulse">-${item.discount}%</div>`;
                        // Update item for purchase logic (hacky but works for display sync)
                        item.realCost = newCost; 
                    } else {
                        item.realCost = item.cost;
                    }
                    if(item.curr === 'free') costDisplay = 'GRATUIT';

                    c.innerHTML += `<div class="glass-panel p-6 text-center flex flex-col items-center active:scale-95 transition border border-white/10 ${color} relative overflow-hidden">
                        ${discountBadge}
                        <div class="text-5xl mb-2">${icon}</div>
                        <div class="font-bold text-lg">${item.name}</div>
                        <div class="text-xs text-gray-400 mb-4">${item.type==='skin' ? 'Skin Rare' : `+${item.val} ${icon}`}</div>
                        <button onclick="ui.buySpecial(${idx})" class="w-full ${btnClass} py-3 rounded-xl font-bold text-sm">${costDisplay}</button>
                    </div>`;
                });
            },
            renderPass() {
                setText('pass-lvl', USER.pass.tier); setText('pass-xp-txt', `${USER.pass.xp}/100 XP`); setStyle('pass-bar', 'width', `${USER.pass.xp}%`);
                
                // Pass Pro Button
                const status = el('pass-pro-status');
                if(status) {
                    if(USER.mPassPro) { status.innerHTML = '<span class="text-yellow-400 font-black text-xl glow">PRO ACTIV√â</span>'; }
                    else { status.innerHTML = `<button onclick="ui.buyPassPro()" class="bg-gradient-to-r from-purple-600 to-indigo-600 px-4 py-2 rounded-lg font-bold text-xs shadow-lg hover:scale-105 transition">ACHETER PASS PRO (169 üíé)</button>`; }
                }

                const tr = el('pass-track-free'); 
                const trPro = el('pass-track-pro');
                
                if (!tr || !trPro) return;

                let freeHtml = '<div class="pass-label">GRATUIT</div>';
                let proHtml = '<div class="pass-label">PRO üëë</div>';
                
                for(let i=1; i<=50; i++) {
                    // FREE REWARDS
                    let rwdF = (i%10===0)?'üì¶':((i%2===0)?'ü™ô':'üíé'); 
                    let valF = (i%10===0)?1:((i%2===0)?50:5);
                    let claimedF = USER.pass.claimed.includes(i); 
                    let unlocked = USER.pass.tier >= i;
                    
                    // PRO REWARDS (Better)
                    let rwdP = (i%10===0)?'üë∫':((i%2===0)?'üíé':'ü™ô'); // Skin/Emote placeholder
                    if(i===1) rwdP = 'üëï'; // Skin at tier 1
                    let valP = (i%10===0)?1:((i%2===0)?20:200);
                    let claimedP = USER.pass.claimedPro.includes(i);
                    let proLocked = !USER.mPassPro;

                    // HTML Construction
                    let freeState = claimedF ? 'claimed' : (unlocked ? 'active cursor-pointer' : 'locked');
                    let proState = claimedP ? 'claimed' : ((unlocked && !proLocked) ? 'active cursor-pointer pro' : 'locked pro');
                    
                    let fnF = (unlocked && !claimedF) ? `onclick="ui.claimPass(${i}, false)"` : '';
                    let fnP = (unlocked && !claimedP && !proLocked) ? `onclick="ui.claimPass(${i}, true)"` : (proLocked ? `onclick="ui.notif('ACH√àTE LE PASS PRO !', '#a855f7')"` : '');

                    freeHtml += `
                        <div class="pass-step ${freeState} shrink-0 mx-2" ${fnF}>
                            <div class="tier-badge">PALIER ${i}</div>
                            <div class="text-4xl mb-2">${rwdF}</div>
                            <div class="text-[10px] font-bold">+${valF}</div>
                        </div>`;

                    proHtml += `
                        <div class="pass-step ${proState} shrink-0 mx-2" ${fnP}>
                            <div class="tier-badge">PALIER ${i}</div>
                            <div class="text-4xl mb-2">${rwdP}</div>
                            <div class="text-[10px] font-bold">+${valP}</div>
                        </div>`;
                }
                tr.innerHTML = freeHtml;
                trPro.innerHTML = proHtml;
            },
            renderLists() {
                const sl = el('list-starters'); sl.innerHTML = ''; 
                Object.keys(STARTERS).forEach(k => { 
                    const s = STARTERS[k], unlocked = USER.unlocked.includes(k), lvl = USER.levels[k]||1, active = USER.selected === k ? 'border-blue-500 bg-blue-900/20' : 'bg-white/5 border-white/5'; 
                    sl.innerHTML += `<div onclick="ui.openHeroDetails('${k}')" class="glass-panel p-4 cursor-pointer active:scale-95 transition ${active} ${unlocked?'':'locked'} relative group border flex flex-col items-center text-center">
                        <div class="w-12 h-12 rounded-xl bg-black/40 flex items-center justify-center text-3xl mb-2">${s.icon}</div>
                        <div class="font-black text-sm uppercase tracking-wider">${s.name}</div>
                        <div class="text-[10px] text-gray-400 leading-tight mb-2 h-6 overflow-hidden">${s.desc}</div>
                        <div class="text-[9px] font-bold text-blue-300 mb-1">Niv. ${lvl}</div>
                    </div>`; 
                });
                const ml = el('list-modes'); ml.innerHTML = ''; Object.keys(MODES).forEach(k => { const m = MODES[k]; const specialClass = m.special ? 'season-gold' : 'bg-white/5 border-white/5'; const active = game.conf.mode === k ? 'border-purple-500 bg-purple-900/20' : specialClass; ml.innerHTML += `<div onclick="game.setMode('${k}')" class="glass-panel p-4 cursor-pointer flex items-center gap-4 ${active} active:scale-95 transition border"><div class="text-4xl p-2 bg-black/30 rounded-full icon-box">${m.icon}</div><div class="text-left flex-1"><div class="font-black text-lg">${m.name}</div><div class="text-xs text-gray-400">${m.desc}</div></div><div class="text-2xl text-gray-600">‚ûú</div></div>`; }); const al = el('list-arenas'); al.innerHTML = ''; Object.keys(ARENAS).forEach(k => { const a = ARENAS[k]; const specialClass = a.special ? 'season-gold text-yellow-100' : 'bg-white/5 border-white/5 text-gray-400'; const active = game.conf.arena === k ? 'border-green-500 bg-green-900/20 text-white' : specialClass; al.innerHTML += `<div onclick="game.setArena('${k}')" class="glass-panel p-3 cursor-pointer text-center ${active} active:scale-95 transition border font-bold text-xs uppercase tracking-widest">${a.name}</div>`; });
            },
            openHeroDetails(k) {
                const s = STARTERS[k];
                const unlocked = USER.unlocked.includes(k);
                const lvl = USER.levels[k] || 1;
                setText('hd-icon', s.icon); setText('hd-name', s.name); setText('hd-lvl', "NIVEAU " + lvl); setText('hd-desc', s.lore || s.desc); setText('hd-gadget-name', getGadgetName(s.gadget)); setText('hd-passive', s.passive || "Aucun");
                
                // Skins
                const skinsContainer = el('hd-skins-list');
                skinsContainer.innerHTML = '';
                if(s.skins) {
                    s.skins.forEach(skin => {
                        const isOwned = skin.id === 'default' || (USER.ownedSkins && USER.ownedSkins.includes(`${k}_${skin.id}`));
                        const isSelected = (USER.skins && USER.skins[k] === skin.id) || (skin.id === 'default' && !USER.skins[k]);
                        const style = isSelected ? 'border-yellow-400 bg-yellow-900/30' : (isOwned ? 'border-white/20 bg-white/5' : 'border-gray-700 bg-black/50 grayscale');
                        skinsContainer.innerHTML += `<div onclick="${isOwned ? `ui.equipSkin('${k}', '${skin.id}')` : `ui.buySkin('${k}', '${skin.id}', ${skin.price})`}" class="w-16 h-16 rounded-lg border-2 ${style} flex flex-col items-center justify-center cursor-pointer shrink-0"><div class="text-2xl" style="color:${skin.c}">${s.icon}</div><div class="text-[8px] font-bold mt-1">${isOwned ? (isSelected?'√âQUIP√â':'METTRE') : skin.price+'ü™ô'}</div></div>`;
                    });
                }

                setTimeout(() => { setStyle('hd-bar-hp', 'width', (s.hp/600*100) + '%'); setStyle('hd-bar-dmg', 'width', (s.dmg/150*100) + '%'); setStyle('hd-bar-spd', 'width', (s.spd/10*100) + '%'); }, 50);
                const actions = el('hd-actions');
                if(unlocked) {
                    const upgradeCost = lvl * 150;
                    if(lvl >= 10) { actions.innerHTML = `<button onclick="game.setStarter('${k}'); document.getElementById('hero-details-modal').classList.add('hidden')" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl">S√âLECTIONNER</button><button class="w-full max-level font-bold py-3 rounded-xl flex justify-center items-center gap-2 cursor-default border border-yellow-500/50 text-yellow-500 bg-yellow-900/20">NIVEAU MAX</button>`; } 
                    else { actions.innerHTML = `<button onclick="game.setStarter('${k}'); document.getElementById('hero-details-modal').classList.add('hidden')" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl">S√âLECTIONNER</button><button onclick="ui.upgrade('${k}'); document.getElementById('hero-details-modal').classList.add('hidden')" class="w-full bg-green-600/80 hover:bg-green-500 text-white font-bold py-3 rounded-xl flex justify-center items-center gap-2">AM√âLIORER <span class="bg-black/20 px-2 rounded text-xs">${upgradeCost} ü™ô</span></button>`; }
                } else { actions.innerHTML = `<button onclick="ui.unlock('${k}'); document.getElementById('hero-details-modal').classList.add('hidden')" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 rounded-xl flex justify-center items-center gap-2">D√âBLOQUER <span class="bg-black/20 px-2 rounded text-xs">${s.price} ü™ô</span></button>`; }
                el('hero-details-modal').classList.remove('hidden');
            },
            equipSkin(heroId, skinId) {
                if(!USER.skins) USER.skins = {};
                USER.skins[heroId] = skinId;
                Storage.save();
                ui.openHeroDetails(heroId); // refresh
            },
            buySkin(heroId, skinId, price) {
                if(USER.coins >= price) {
                    USER.coins -= price;
                    if(!USER.ownedSkins) USER.ownedSkins = [];
                    USER.ownedSkins.push(`${heroId}_${skinId}`);
                    this.notif("SKIN D√âBLOQU√â !", "#facc15");
                    this.equipSkin(heroId, skinId);
                } else {
                    this.notif("PAS ASSEZ DE PI√àCES !", "#ef4444");
                }
            },
            renderProfile() { el('profile-name').value = USER.name; setText('profile-tag', USER.tag); setText('profile-avatar', USER.avatar); let totalLvl = Object.values(USER.levels).reduce((a,b)=>a+b, 0); setText('profile-lvl', "LVL " + totalLvl); },
            openAvatarSelector() { const grid = el('avatar-grid'); grid.innerHTML = ''; ICONS.forEach(icon => { grid.innerHTML += `<button onclick="ui.selectAvatar('${icon}')" class="w-14 h-14 text-3xl bg-white/10 hover:bg-blue-600 rounded-xl transition flex items-center justify-center border border-white/10">${icon}</button>`; }); el('avatar-selector').classList.remove('hidden'); },
            selectAvatar(icon) { USER.avatar = icon; Storage.save(); el('avatar-selector').classList.add('hidden'); this.renderProfile(); },
            renderEmotes() { const list = el('list-emotes'); list.innerHTML = ''; const equipped = el('equipped-emotes'); equipped.innerHTML = ''; USER.equippedEmotes.forEach(id => { const e = EMOTE_LIST.find(em => em.id === id); equipped.innerHTML += `<div class="w-12 h-12 bg-black/40 rounded-lg flex items-center justify-center text-2xl border border-blue-500/50">${e.i}</div>`; }); EMOTE_LIST.forEach(e => { const unlocked = USER.emotes.includes(e.id); const selected = USER.equippedEmotes.includes(e.id); list.innerHTML += `<div onclick="${unlocked ? `ui.equipEmote('${e.id}')` : ''}" class="emote-grid-item ${unlocked ? 'unlocked' : 'locked'} ${selected ? 'selected' : ''}">${e.i}</div>`; }); },
            equipEmote(id) { if(USER.equippedEmotes.includes(id)) { USER.equippedEmotes = USER.equippedEmotes.filter(e => e !== id); } else { if(USER.equippedEmotes.length < 4) USER.equippedEmotes.push(id); else ui.notif("SLOTS PLEINS !", "#ef4444"); } Storage.save(); this.renderEmotes(); },
            toggleEmoteWheel() { const wheel = el('emote-wheel'); if(wheel.classList.contains('hidden')) { wheel.innerHTML = ''; USER.equippedEmotes.forEach(id => { const e = EMOTE_LIST.find(em => em.id === id); wheel.innerHTML += `<div onclick="ui.triggerEmote('${e.i}'); ui.toggleEmoteWheel()" class="emote-btn">${e.i}</div>`; }); wheel.classList.remove('hidden'); } else { wheel.classList.add('hidden'); } },
            triggerEmote(emoji) { game.player.emote = emoji; game.player.emoteTimer = 120; },
            updateMenu() { const s = STARTERS[USER.selected], m = MODES[game.conf.mode], a = ARENAS[game.conf.arena]; setText('top-coins', USER.coins); setText('top-gems', USER.gems); setText('menu-trophies', USER.trophies); let rIdx = 0; for(let i=0; i<RANKS.length; i++) { if(USER.trophies >= RANKS[i].t) rIdx = i; } const currRank = RANKS[rIdx], nextRank = RANKS[rIdx+1]; const re = el('menu-rank'); if(re) { re.innerText = currRank.n; re.style.backgroundImage = `linear-gradient(to right, #fff, ${currRank.c})`; } if(nextRank) { const diff = nextRank.t - USER.trophies, range = nextRank.t - currRank.t, done = USER.trophies - currRank.t, pct = Math.min(100, Math.max(0, (done / range) * 100)); setText('rank-progress-text', `Encore ${diff} üèÜ avant ${nextRank.n}`); setText('rank-progress-pct', Math.floor(pct) + '%'); setStyle('rank-progress-fill', 'width', pct + '%'); } else { setText('rank-progress-text', "RANG MAXIMUM !"); setText('rank-progress-pct', "100%"); setStyle('rank-progress-fill', 'width', '100%'); } setText('play-starter', s.name); setText('play-icon', s.icon); setText('play-lvl', "Niveau "+(USER.levels[USER.selected]||1)); setText('play-mode', m.name); setText('play-mode-icon', m.icon); setText('play-arena', a.name); },
            updateStats() { setText('stat-kills', USER.stats.kills); setText('stat-wave', USER.stats.maxWave); setText('stat-games', USER.stats.games); setText('stat-wins', USER.stats.wins); setText('stat-dmg', Math.floor(USER.stats.dmg/1000)+"k"); },
            unlock(k) { const s = STARTERS[k]; if(USER.coins >= s.price) { USER.coins -= s.price; USER.unlocked.push(k); USER.selected = k; Storage.save(); ui.notif(`D√âBLOQU√â!`, "#22c55e"); ui.renderLists(); ui.updateMenu(); } else ui.notif("PAS ASSEZ!", "#ef4444"); },
            upgrade(k) { const cost = (USER.levels[k]||1) * 150; if(USER.coins >= cost) { USER.coins -= cost; USER.levels[k]++; Storage.save(); ui.notif(`NIVEAU UP!`, "#3b82f6"); ui.renderLists(); ui.updateMenu(); } else ui.notif("PAS ASSEZ!", "#ef4444"); },
            claimDaily() { USER.coins += 200; USER.lastDaily = Date.now(); Storage.save(); ui.notif("+200 ü™ô", "#eab308"); ui.renderLists(); ui.updateMenu(); ui.renderShop(); },
            buy(t, cost, curr) { let ok = false; if(curr === 'free') ok = true; else if(curr === 'coins' && USER.coins >= cost) { USER.coins -= cost; ok = true; } else if(curr === 'gems' && USER.gems >= cost) { USER.gems -= cost; ok = true; } if(ok) { if(t==='box'){ const r=Math.random(); if(r<0.8){const c=50+Math.floor(Math.random()*100);USER.coins+=c;ui.notif(`+${c} ü™ô`,"#eab308");} else{const g=2+Math.floor(Math.random()*5);USER.gems+=g;ui.notif(`+${g} üíé`,"#a855f7");} } else if(t==='coins') { USER.coins += 300; ui.notif("+300 ü™ô","#eab308"); } else if(t==='gems') { USER.gems += 30; ui.notif("+30 üíé","#a855f7"); } Storage.save(); ui.updateMenu(); ui.renderShop(); } else ui.notif("PAS ASSEZ!", "#ef4444"); },
            buySpecial(idx) { 
                const item = USER.shop.items[idx]; if(!item) return; 
                let ok = false;
                const actualCost = item.realCost || item.cost; // Use discounted price if set
                
                if(item.curr === 'free') ok = true;
                else if(item.curr === 'coins' && USER.coins >= actualCost) { USER.coins -= actualCost; ok = true; } 
                else if(item.curr === 'gems' && USER.gems >= actualCost) { USER.gems -= actualCost; ok = true; }
                
                if(ok) {
                    if(item.type==='gems') { USER.gems += item.val; ui.notif(`+${item.val} üíé`, "#a855f7"); }
                    if(item.type==='coins') { USER.coins += item.val; ui.notif(`+${item.val} ü™ô`, "#eab308"); }
                    if(item.type==='xp') { 
                        USER.pass.xp += item.val; ui.notif(`+${item.val} XP`, "#facc15");
                        while(USER.pass.xp >= 100) { if(USER.pass.tier < 50) { USER.pass.tier++; USER.pass.xp -= 100; ui.notif("PASS LEVEL UP!", "#facc15"); } else { USER.pass.xp = 100; break; } }
                    }
                    if(item.type==='box') { ui.buy('box', 0, 'free'); } 
                    
                    if(item.type==='skin') {
                         if(!USER.ownedSkins) USER.ownedSkins = [];
                         const heroId = Object.keys(STARTERS).find(k => STARTERS[k].name === item.hero);
                         if(heroId) {
                             USER.ownedSkins.push(`${heroId}_${item.skinId}`);
                             ui.notif(`SKIN ${item.name} OBTENU !`, "#facc15");
                         }
                    }

                    USER.shop.items.splice(idx, 1); Storage.save(); ui.updateMenu(); ui.renderShop(); ui.renderPass();
                } else ui.notif("PAS ASSEZ!", "#ef4444");
            },
            buyPassPro() {
                if(USER.gems >= 169) {
                    USER.gems -= 169;
                    USER.mPassPro = true;
                    ui.notif("PASS PRO ACTIV√â !", "#facc15");
                    Storage.save(); ui.updateMenu(); ui.renderPass();
                } else { ui.notif("PAS ASSEZ DE GEMMES !", "#ef4444"); }
            },
            claimPass(tier, isPro) {
                const hasPass = isPro ? USER.mPassPro : true;
                const alreadyClaimed = isPro ? USER.pass.claimedPro.includes(tier) : USER.pass.claimed.includes(tier);
                
                if(USER.pass.tier >= tier && hasPass && !alreadyClaimed) {
                    if(isPro) USER.pass.claimedPro.push(tier); else USER.pass.claimed.push(tier);
                    
                    // Rewards Logic
                    let val = (tier%10===0) ? 1 : ((tier%2===0) ? (isPro?200:50) : (isPro?20:5)); 
                    let type = (tier%10===0) ? 'box' : ((tier%2===0) ? 'coins' : 'gems');
                    
                    if(type==='box') ui.buy('box', 0, 'free');
                    else if(type==='coins') { USER.coins+=val; ui.notif(`+${val} ü™ô`,"#eab308"); }
                    else { USER.gems+=val; ui.notif(`+${val} üíé`,"#a855f7"); }
                    
                    Storage.save(); ui.renderPass(); ui.updateMenu();
                }
            }
        };

        const Input={k:{},jL:{a:0,x:0,y:0,i:null},jR:{a:0,x:0,y:0,i:null},m:{x:0,y:0,d:0},init(){
            window.addEventListener('keydown',e=>{this.k[e.code]=1;if(e.code==='Space')game.player?.dash();if(e.code==='KeyE')game.player?.useGadget();if(e.code==='KeyV'){ui.toggleEmoteWheel();}});
            window.addEventListener('keyup',e=>this.k[e.code]=0);
            window.addEventListener('mousemove',e=>{this.m.x=e.clientX;this.m.y=e.clientY;});
            window.addEventListener('mousedown',()=>this.m.d=1);
            window.addEventListener('mouseup',()=>this.m.d=0);
            const z=el('mobile-controls');
            // JOYSTICK LOGIC V3 (FIXED)
            const h=(e, isEnd)=>{ 
                if(e.target.tagName !== 'BUTTON') e.preventDefault(); 
                let lf=false, rf=false; 
                const W=window.innerWidth, H=window.innerHeight;
                const lx = 40+65, ly = H-50-65; const rx = W-40-65, ry = H-50-65;
                for(let i=0;i<e.touches.length;i++){ 
                    const t=e.touches[i],x=t.clientX,y=t.clientY; 
                    if(x<W/2){ 
                        lf=true; const d=Math.min(60, Math.hypot(x-lx, y-ly)); const a=Math.atan2(y-ly, x-lx);
                        const k=document.querySelector('#stick-left-base .stick-knob');
                        if(k) k.style.transform=`translate(-50%,-50%) translate(${Math.cos(a)*d}px,${Math.sin(a)*d}px)`;
                        if(d>5){ this.jL.x=Math.cos(a)*d/60; this.jL.y=Math.sin(a)*d/60; this.jL.a=1; }
                    }else{ 
                        rf=true; const d=Math.min(60, Math.hypot(x-rx, y-ry)); const a=Math.atan2(y-ry, x-rx);
                        const k=document.querySelector('#stick-right-base .stick-knob');
                        if(k) k.style.transform=`translate(-50%,-50%) translate(${Math.cos(a)*d}px,${Math.sin(a)*d}px)`;
                        if(d>5){ this.jR.x=Math.cos(a)*d/60; this.jR.y=Math.sin(a)*d/60; this.jR.a=1; }
                    } 
                } 
                if(!lf){ this.jL.x=0;this.jL.y=0;this.jL.a=0; const k=document.querySelector('#stick-left-base .stick-knob'); if(k) k.style.transform=`translate(-50%,-50%)`; } 
                if(!rf){ this.jR.x=0;this.jR.y=0;this.jR.a=0; const k=document.querySelector('#stick-right-base .stick-knob'); if(k) k.style.transform=`translate(-50%,-50%)`; } 
            };
            z.addEventListener('touchstart',e=>h(e,false),{passive:false}); z.addEventListener('touchmove',e=>h(e,false),{passive:false}); z.addEventListener('touchend',e=>h(e,true));
        }};

        class Entity{constructor(x,y,r,c){this.x=x;this.y=y;this.r=r;this.c=c;this.dead=false;}
            draw(ctx){
                ctx.save(); ctx.translate(this.x, this.y);
                let isHidden = false; if (game.map) { for(let w of game.map) { if(w.type === 1 && ColRect(this, w)) { isHidden = true; break; } } }
                if(isHidden && this === game.player) { ctx.fillStyle = 'rgba(255, 255, 255, 0.8)'; ctx.font = "20px Arial"; ctx.fillText("üëÅÔ∏è", -10, -this.r - 10); ctx.beginPath(); ctx.moveTo(-10, -this.r - 5); ctx.lineTo(10, -this.r - 25); ctx.strokeStyle = 'red'; ctx.lineWidth = 2; ctx.stroke(); }
                if(isHidden) ctx.globalAlpha = 0.5;
                ctx.shadowColor = 'rgba(0,0,0,0.5)'; ctx.shadowBlur = 15; ctx.beginPath(); ctx.arc(0, 0, this.r, 0, Math.PI*2); ctx.fillStyle = this.c; ctx.fill(); ctx.shadowBlur = 0; ctx.beginPath(); ctx.arc(-5, -5, this.r*0.3, 0, Math.PI*2); ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.fill(); ctx.globalAlpha = 1;
                if(this.emoteTimer > 0) { ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(0, -this.r - 30, 20, 0, Math.PI*2); ctx.fill(); ctx.font = "24px Arial"; ctx.fillStyle = 'black'; ctx.textAlign = 'center'; ctx.fillText(this.emote, 0, -this.r - 22); this.emoteTimer--; }
                ctx.restore();
            }
        }
        class Wall{constructor(x,y,w,h,t){this.x=x;this.y=y;this.w=w;this.h=h;this.type=t;}
            draw(ctx,c){
                if(this.type===1){ctx.fillStyle='rgba(34,197,94,0.9)';ctx.strokeStyle='#15803d';ctx.lineWidth=4;ctx.strokeRect(this.x,this.y,this.w,this.h);ctx.fillRect(this.x,this.y,this.w,this.h);return;}
                const h = 20; ctx.fillStyle = '#0f172a'; ctx.fillRect(this.x, this.y + this.h, this.w, h); 
                ctx.fillStyle = c; ctx.shadowColor = 'black'; ctx.shadowBlur = 10; ctx.fillRect(this.x, this.y, this.w, this.h); ctx.shadowBlur = 0;
                ctx.fillStyle = 'rgba(255,255,255,0.05)'; ctx.fillRect(this.x, this.y, this.w, 5);
            }
            collide(e){return e.x+e.r>this.x&&e.x-e.r<this.x+this.w&&e.y+e.r>this.y&&e.y-e.r<this.y+this.h;}
        }

        class Player extends Entity{
            constructor(k){
                const s=STARTERS[k], l=(USER.levels[k]||1)-1; 
                let c = s.color;
                if(USER.skins && USER.skins[k]) {
                    const skinId = USER.skins[k];
                    if(skinId !== 'default' && s.skins) {
                        const skinObj = s.skins.find(sk => sk.id === skinId);
                        if(skinObj) c = skinObj.c;
                    }
                }
                super(game.world/2,game.world/2,20,c); this.stats={...s}; this.stats.hp+=s.scale.hp*l; this.stats.dmg+=s.scale.dmg*l; this.hp=this.stats.hp; this.maxHp=this.stats.hp; this.xp=0;this.xpMax=100;this.lvl=1;this.super=0;this.cd=0;this.dashT=0;this.angle=0;this.ammo=3;this.ammoMax=3;this.reloadT=0;this.gadgetCharges=3;this.cubes=0; this.activeEffects={};
            }
            update(){
                let speedMult = 1; if(this.activeEffects.speed > 0) { speedMult = 1.5; this.activeEffects.speed--; }
                if(this.stats.passive === "Regen Rapide" && game.frame % 60 === 0) this.hp = Math.min(this.maxHp, this.hp + 50);
                let dx=0,dy=0; if(Input.jL.a){dx=Input.jL.x;dy=Input.jL.y;} else {if(Input.k['KeyW'])dy=-1;if(Input.k['KeyS'])dy=1;if(Input.k['KeyA'])dx=-1;if(Input.k['KeyD'])dx=1;}
                const l=Math.hypot(dx,dy); if(l>0.1){if(l>1){dx/=l;dy/=l;} this.move(dx*this.stats.spd*speedMult, dy*this.stats.spd*speedMult);}
                if(Input.jR.a){this.angle=Math.atan2(Input.jR.y,Input.jR.x);if(Math.hypot(Input.jR.x,Input.jR.y)>0.5)this.shoot();} else {const wx=Input.m.x+game.cam.x, wy=Input.m.y+game.cam.y;this.angle=Math.atan2(wy-this.y,wx-this.x);if(Input.m.d)this.shoot();}
                if(this.cd>0)this.cd--; if(this.dashT>0)this.dashT--; if(this.ammo<this.ammoMax){this.reloadT++;if(this.reloadT>this.stats.reload){this.ammo++;this.reloadT=0;}}
                if(game.frame%60===0 && this.hp<this.maxHp && this.reloadT>20)this.hp+=this.maxHp*0.12;
                if(game.gasRadius && Dist(this, {x:game.world/2, y:game.world/2}) > game.gasRadius) { this.hp -= 10; ui.flash(); if(this.hp<=0) game.over("Tu√© par le Gaz"); }
            }
            move(dx,dy){const nx=this.x+dx,ny=this.y+dy;let cx=0,cy=0;for(let w of game.map){if(w.type===1)continue;if(w.collide({x:nx,y:this.y,r:this.r}))cx=1;if(w.collide({x:this.x,y:ny,r:this.r}))cy=1;}if(!cx)this.x=Math.max(this.r,Math.min(game.world-this.r,nx));if(!cy)this.y=Math.max(this.r,Math.min(game.world-this.r,ny));}
            shoot(){ if(this.cd>0 || this.ammo<1)return; this.cd=this.stats.rate; this.ammo--; this.reloadT=-20; game.shake=2; const t=this.stats.type||'normal', cnt=t==='shotgun'?5:(1+(this.stats.multi||0)), spr=t==='shotgun'?0.3:0.05, dmg=this.stats.dmg*(1+this.cubes*0.1); for(let i=0;i<cnt;i++){ const a=this.angle+(Math.random()-0.5)*spr+(i-(cnt-1)/2)*0.1, s=t==='sniper'?25:(t==='flame'?10:(t==='laser'?30:18)), l=t==='flame'?20:60; game.projs.push({x:this.x+Math.cos(this.angle)*25,y:this.y+Math.sin(this.angle)*25,vx:Math.cos(a)*s,vy:Math.sin(a)*s,dmg:dmg,life:l,r:t==='flame'?8:(t==='laser'?4:5),c:this.c,friend:true}); } }
            dash(){ if(this.dashT>0)return; this.dashT=60; game.shake=10; const dx=Math.cos(this.angle)*180,dy=Math.sin(this.angle)*180; this.move(dx,dy); for(let i=0;i<8;i++)game.parts.push({x:this.x,y:this.y,vx:(Math.random()-0.5)*5,vy:(Math.random()-0.5)*5,life:20,c:'#fff',r:4}); }
            useGadget() { 
                if(this.gadgetCharges <= 0) return; this.gadgetCharges--; ui.notif("GADGET!", "#22c55e"); 
                const t=this.stats.gadget; 
                if(t==="heal") { this.hp=Math.min(this.maxHp,this.hp+1000); for(let i=0;i<10;i++)game.parts.push({x:this.x,y:this.y,vx:Rnd(-2,2),vy:Rnd(-2,2),life:30,c:'#22c55e',r:3}); }
                if(t==="shield") { this.maxHp+=1000; this.hp+=1000; }
                if(t==="teleport") { this.x+=Math.cos(this.angle)*300; this.y+=Math.sin(this.angle)*300; }
                if(t==="speed") { this.activeEffects.speed = 180; } 
                if(t==="knockback") { for(let e of game.ents) { let d = Dist(this, e); if(d < 300) { let a = Math.atan2(e.y-this.y, e.x-this.x); e.x += Math.cos(a)*200; e.y += Math.sin(a)*200; } } }
            }
            draw(ctx){ ctx.save(); ctx.shadowColor = this.c; ctx.shadowBlur = 20; super.draw(ctx); ctx.translate(this.x,this.y); ctx.rotate(this.angle); ctx.fillStyle='#1e293b'; ctx.fillRect(10,-6,28,12); if(this.reloadT > 0) { ctx.rotate(-this.angle); ctx.fillStyle = 'white'; ctx.fillRect(-15, 30, 30 * (this.reloadT/this.stats.reload), 3); } ctx.restore(); }
        }

        class Bot extends Player{
            constructor(){ super(USER.selected==='soldier'?'tank':'soldier'); this.c='#ef4444'; this.isBot=true; this.x=100; this.y=100; this.mode='WANDER'; this.target=null; }
            update(){
                if(this.cd>0)this.cd--;
                const p=game.player, d=Dist(this,p); this.angle=Math.atan2(p.y-this.y,p.x-this.x);
                let playerHidden = false; for(let w of game.map) { if(w.type === 1 && ColRect(game.player, w)) { playerHidden = true; break; } }
                if(game.conf.mode === 'duel') { this.mode = 'CHASE'; } else { if(d < 500 && !playerHidden) this.mode = 'CHASE'; else this.mode = 'WANDER'; }
                let tx,ty;
                if(this.mode==='CHASE'){ let strafe = Math.sin(game.frame * 0.05) * 100; tx = p.x + Math.cos(this.angle + Math.PI/2) * strafe; ty = p.y + Math.sin(this.angle + Math.PI/2) * strafe; } 
                else { 
                    if(game.conf.mode === 'duel') { if(!this.target || Dist(this,this.target)<50) this.target={x:game.world/2 + Rnd(-300,300), y:game.world/2 + Rnd(-300,300)}; } 
                    else { let item = game.items.find(i => Dist(this, i) < 300); if(item) { this.target = item; } else if(!this.target || Dist(this,this.target)<50 || Math.random()<0.02) { this.target={x:Rnd(100,game.world-100), y:Rnd(100,game.world-100)}; } }
                    tx=this.target.x; ty=this.target.y; 
                }
                const a=Math.atan2(ty-this.y, tx-this.x);
                this.move(Math.cos(a)*this.stats.spd, Math.sin(a)*this.stats.spd);
                if(this.mode === 'CHASE' && Math.random()<0.05) this.shoot(); 
                if(Math.random()<0.01) this.dash(); 
                if(game.frame%60===0 && this.hp<this.maxHp)this.hp++;
                if(game.gasRadius && Dist(this, {x:game.world/2, y:game.world/2}) > game.gasRadius) this.hp -= 10;
            }
            shoot(){ if(this.cd>0)return; this.cd=20; game.projs.push({x:this.x,y:this.y,vx:Math.cos(this.angle)*15,vy:Math.sin(this.angle)*15,dmg:10,life:60,r:6,c:this.c,friend:false}); }
        }

        class Enemy extends Entity{
            constructor(t,m=1){
                super(0,0,20,'#ef4444'); let safe=false; 
                while(!safe){ this.x=Rnd(100,game.world-100);this.y=Rnd(100,game.world-100); let wallCol = false; for(let w of game.map) { if(w.type!==1 && w.collide({x:this.x, y:this.y, r:this.r})) wallCol=true; } if(!wallCol && Dist(this,game.player)>600) safe=true; }
                this.type=t; let hp=60,s=2.0; if(t==='fast'){hp=40;s=4.0;this.c='#f97316';this.r=15;} if(t==='tank'){hp=200;s=1.2;this.c='#7e22ce';this.r=30;} 
                if(t==='boss'){hp=5000;s=1.5;this.c='#dc2626';this.r=60;this.isBoss=true;this.cd=0;}
                if(t==='chest'){hp=5000;s=0;this.c='#facc15';this.r=40;this.isBoss=true;} 
                this.hp=hp*m; this.maxHp=this.hp; this.spd=s*0.85;
                this.cd = 100 + Math.random() * 100; 
                if(this.isBoss) this.name = t === 'boss' ? 'BOSS' : 'COFFRE'; else this.name = `Bot n¬∞${Math.floor(Math.random() * 89999) + 10000}`;
            }
            update(){
                if(this.spd === 0) return; 
                const p=game.player;
                let sepX = 0, sepY = 0;
                for(let other of game.ents) { if(other !== this) { let d = Dist(this, other); if(d < this.r * 2.5 && d > 0) { let ang = Math.atan2(this.y - other.y, this.x - other.x); sepX += Math.cos(ang); sepY += Math.sin(ang); } } }
                if (game.conf.mode === 'survival' || game.conf.mode === 'ranked') { if (this.cd > 0) this.cd--; if (this.cd <= 0 && Dist(this, p) < 400) { const a = Math.atan2(p.y - this.y, p.x - this.x); game.projs.push({ x: this.x, y: this.y, vx: Math.cos(a) * 3, vy: Math.sin(a) * 3, dmg: 10, life: 100, r: 6, c: this.c, friend: false }); this.cd = 150; } }
                if(this.type === 'boss') {
                    const d = Dist(this, p); const a = Math.atan2(p.y - this.y, p.x - this.x);
                    this.x += Math.cos(a) * this.spd; this.y += Math.sin(a) * this.spd;
                    if(this.cd > 0) this.cd--;
                    if(this.cd <= 0 && d < 800) { this.cd = 60; game.projs.push({ x: this.x, y: this.y, vx: Math.cos(a) * 2.5, vy: Math.sin(a) * 2.5, dmg: 40, life: 200, r: 20, c: '#ef4444', friend: false }); }
                } else {
                    let playerHidden = false; for(let w of game.map) { if(w.type === 1 && ColRect(game.player, w)) { playerHidden = true; break; } }
                    let tx, ty;
                    if(playerHidden && Dist(this, p) > 150) { if(!this.target || Dist(this,this.target)<50 || Math.random()<0.01) this.target={x:Rnd(100,game.world-100), y:Rnd(100,game.world-100)}; tx=this.target.x; ty=this.target.y; } else { tx=p.x; ty=p.y; }
                    const a=Math.atan2(ty-this.y, tx-this.x);
                    let mx = Math.cos(a)*this.spd + sepX*0.5; let my = Math.sin(a)*this.spd + sepY*0.5;
                    const nx=this.x+mx, ny=this.y+my; let cx=false, cy=false;
                    for(let w of game.map){if(w.type===1)continue; if(w.collide({x:nx,y:this.y,r:this.r}))cx=true;if(w.collide({x:this.x,y:ny,r:this.r}))cy=true;} if(!cx)this.x=nx;if(!cy)this.y=ny;
                }
                if(Math.hypot(this.x-p.x,this.y-p.y)<this.r+p.r){p.hp-=1;ui.flash();if(p.hp<=0)game.over("Tu√© par "+this.name);}
            }
            draw(ctx){ if(this.isBoss){ctx.beginPath();ctx.arc(this.x,this.y,this.r+5,0,Math.PI*2);ctx.strokeStyle=this.type==='chest'?'#facc15':'#ef4444';ctx.setLineDash([5,5]);ctx.stroke();ctx.setLineDash([]);} super.draw(ctx); const pct=this.hp/this.maxHp; ctx.save(); ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(this.x-20,this.y-this.r-15,40,6); ctx.fillStyle=this.isBoss?'#ef4444':'#22c55e';ctx.fillRect(this.x-19,this.y-this.r-14,38*pct,4); ctx.restore(); }
        }

        const game = {
            cvs:document.getElementById('gameCanvas'), ctx:document.getElementById('gameCanvas').getContext('2d'),
            conf:{mode:'survival', arena:'tokyo'}, state:'MENU', frame:0, world:2000, cam:{x:0,y:0}, shake:0, gasRadius:0, timeLeft: 0,
            player:null, ents:[], projs:[], map:[], parts:[], items:[], texts:[], score:0, wave:1, boost:false,
            init() { this.resize(); window.onresize=()=>this.resize(); Input.init(); Storage.load(); ui.updateMenu(); if('ontouchstart' in window)el('mobile-controls').classList.remove('hidden'); this.loop(); },
            resize(){ this.cvs.width=window.innerWidth; this.cvs.height=window.innerHeight; CFG.w=this.cvs.width; CFG.h=this.cvs.height; },
            setStarter(k){USER.selected=k; Storage.save(); ui.updateMenu(); ui.showTab('play');},
            setMode(m){this.conf.mode=m; ui.updateMenu(); ui.showTab('play');},
            setArena(a){this.conf.arena=a; ui.updateMenu(); ui.showTab('play');},
            start(){
                el('menu-screen').classList.add('hidden'); el('hud').classList.remove('hidden');
                this.player=new Player(USER.selected); this.ents=[]; this.projs=[]; this.parts=[]; this.items=[]; this.texts=[]; this.score=0; this.wave=1; this.gasRadius=0;
                this.timeLeft = 3 * 60 * 60; 
                this.map=[]; for(let i=0;i<25;i++){const w=Math.random()*150+50,h=Math.random()*150+50,x=Math.random()*(this.world-w),y=Math.random()*(this.world-h);if(Math.hypot(x-this.world/2,y-this.world/2)>400)this.map.push(new Wall(x,y,w,h,0));}
                for(let i=0;i<40;i++){const w=Math.random()*100+100,h=Math.random()*100+100,x=Math.random()*(this.world-w),y=Math.random()*(this.world-h);this.map.push(new Wall(x,y,w,h,1));}
                for(let i=0;i<20;i++){const x=Math.random()*(this.world-60),y=Math.random()*(this.world-60);if(Math.hypot(x-this.world/2,y-this.world/2)>400)this.map.push(new Wall(x,y,60,60,3));}
                
                if(this.conf.mode==='duel'){
                    const bot = new Bot(); bot.x = this.world/2 + 400; bot.y = this.world/2;
                    this.ents.push(bot); ui.notif("1 VS 1", "#fff");
                } else if(this.conf.mode==='heist') {
                    const chest = new Enemy('chest', 1); chest.x = this.world/2; chest.y = 100; 
                    this.ents.push(chest); this.spawnDefenders(chest.x, chest.y, 3);
                    this.map = this.map.filter(w => Math.hypot(w.x-chest.x, w.y-chest.y) > 300 && Math.hypot(w.x-this.player.x, w.y-this.player.y) > 300);
                    ui.notif("D√âTRUIS LE COFFRE !", "#facc15");
                } else if(this.conf.mode==='boss_rush') { this.ents.push(new Enemy('boss', 3)); ui.notif("BOSS RUSH !", "#ef4444"); } 
                else if(this.conf.mode==='titan_raid') { this.ents.push(new Enemy('boss', 5)); ui.notif("RAID TITAN !", "#ef4444"); } 
                else { ui.notif(MODES[this.conf.mode].name.toUpperCase(), "#fff"); }
                setText('hud-icon', STARTERS[USER.selected].icon); this.state='PLAYING';
            },
            spawnDefenders(cx, cy, count) { for(let i=0; i<count; i++) { const angle = (Math.PI*2/count)*i; const e = new Enemy('basic', 1); e.x = cx + Math.cos(angle)*150; e.y = cy + Math.sin(angle)*150; this.ents.push(e); } },
            togglePause(){this.state=this.state==='PLAYING'?'PAUSED':(this.state==='PAUSED'?'PLAYING':this.state);},
            toMenu(){el('gameover-screen').classList.add('hidden');el('menu-screen').classList.remove('hidden');el('hud').classList.add('hidden');this.state='MENU';ui.updateMenu();game.boost=false;},
            over(r){
                this.state='GAMEOVER'; el('gameover-screen').classList.remove('hidden'); setText('go-reason', r); setText('go-score', this.score);
                let gt = 1 + Math.floor(this.score / 100) * 2; if(this.boost) gt *= 2; 
                if((this.conf.mode==='duel' || this.conf.mode==='heist' || this.conf.mode==='boss_rush' || this.conf.mode==='titan_raid') && r==="VICTOIRE") { gt += 20; USER.stats.wins++; } 
                let gc = Math.floor(this.score/10); if(r==="VICTOIRE") gc += 50;
                if(this.score >= 200 || r==="VICTOIRE") { USER.pass.xp += 50; if(USER.pass.xp >= 100) { if(USER.pass.tier < 50) { USER.pass.tier++; USER.pass.xp -= 100; ui.notif("PASS LEVEL UP!", "#facc15"); } else USER.pass.xp = 100; } }
                USER.trophies+=gt; USER.coins+=gc; USER.stats.maxWave=Math.max(USER.stats.maxWave,this.wave); USER.stats.games++; Storage.save(); setText('go-rewards', `+${gt}üèÜ +${gc}ü™ô`);
            },
            loop(){
                requestAnimationFrame(()=>this.loop()); this.frame++; const ctx=this.ctx;
                if(this.state==='PLAYING'){
                    if(this.conf.mode === 'heist' || this.conf.mode === 'boss_rush' || this.conf.mode === 'titan_raid') {
                        this.timeLeft--;
                        if(this.timeLeft <= 0) { this.over("TEMPS √âCOUL√â"); return; }
                        if(this.conf.mode === 'heist' && this.frame % (20*60) === 0) { const chest = this.ents.find(e => e.type === 'chest'); if(chest) { this.spawnDefenders(chest.x, chest.y, 3); ui.notif("RENFORTS !", "#ef4444"); } }
                    }

                    if(!this.ents) this.ents = []; if(!this.map) this.map = [];
                    if(this.conf.mode === 'survival' || this.conf.mode === 'ranked'){
                        if(!this.ents.find(e=>e.isBoss)){
                            const max=5+Math.floor(this.wave*1.5);
                            if(this.ents.length<max && this.frame%60===0){let t='basic'; if(this.wave>2&&Math.random()>0.7)t='fast'; if(this.wave>4&&Math.random()>0.8)t='tank'; this.ents.push(new Enemy(t,1+(this.conf.mode==='ranked'?0.2:0.1)*this.wave));}
                            if(this.frame%1800===0){this.wave++;if(this.wave%5===0){this.ents.push(new Enemy('boss',1+this.wave*0.2));ui.notif("BOSS !!!","#ef4444");}else ui.notif("VAGUE "+this.wave,"#fff");}
                        }
                    } else if(this.ents.length===0) this.over("VICTOIRE");

                    this.player.update(); this.ents.forEach(e=>e.update());
                    this.ents.forEach(e => resolveCollision(this.player, e)); for(let i=0; i<this.ents.length; i++) for(let j=i+1; j<this.ents.length; j++) resolveCollision(this.ents[i], this.ents[j]);
                    const tx=this.player.x-CFG.w/2, ty=this.player.y-CFG.h/2; this.cam.x+=(tx-this.cam.x)*0.1; this.cam.y+=(ty-this.cam.y)*0.1;
                    this.cam.x=Math.max(0,Math.min(this.world-CFG.w,this.cam.x)); this.cam.y=Math.max(0,Math.min(this.world-CFG.h,this.cam.y));
                    if(this.shake>0)this.shake*=0.9;

                    for(let i=this.projs.length-1;i>=0;i--){
                        const b=this.projs[i];
                        if(b.melee){
                            b.x=game.player.x+Math.cos(game.player.angle)*40; b.y=game.player.y+Math.sin(game.player.angle)*40; b.life--; if(b.life<=0){this.projs.splice(i,1);continue;}
                            for(let e of this.ents) if(Dist(b,e)<b.r+e.r && !e.hitCD){ e.hitCD=20; e.hp-=b.dmg; if(b.friend) USER.stats.dmg+=b.dmg; for(let k=0;k<3;k++)game.parts.push({x:e.x,y:e.y,vx:(Math.random()-0.5)*5,vy:(Math.random()-0.5)*5,life:15,c:'#fff',r:3}); this.texts.push({x:e.x,y:e.y-40,t:Math.floor(b.dmg),life:40,c:'#fff',vy:-2}); if(e.hp<=0 && !e.dead) this.kill(e); }
                            continue;
                        }
                        b.x+=b.vx; b.y+=b.vy; b.life--; if(b.life<=0){this.projs.splice(i,1);continue;}
                        let wh=false; for(let k=this.map.length-1; k>=0; k--) { const w=this.map[k]; if(w.type!==1 && ColRect(b, w)) { if(w.type===0) wh=true; if(w.type===3 && b.friend) { this.map.splice(k,1); this.items.push({x:w.x+30, y:w.y+30, type:'cube'}); for(let j=0;j<5;j++) this.parts.push({x:w.x+30, y:w.y+30, vx:Rnd(-5,5), vy:Rnd(-5,5), life:20, c:'#d97706', r:5}); wh=true; } } }
                        if(wh){for(let j=0;j<3;j++)this.parts.push({x:b.x,y:b.y,vx:(Math.random()-0.5)*3,vy:(Math.random()-0.5)*3,life:10,c:b.c,r:2}); this.projs.splice(i,1);continue;}
                        if(b.friend){ for(let e of this.ents){ if(Dist(b,e)<b.r+e.r){ e.hp-=b.dmg; USER.stats.dmg+=b.dmg; this.texts.push({x:e.x,y:e.y-40,t:Math.floor(b.dmg),life:40,c:'#fff',vy:-2}); for(let k=0;k<5;k++)this.parts.push({x:e.x,y:e.y,vx:(Math.random()-0.5)*8,vy:(Math.random()-0.5)*8,life:20,c:e.c,r:4}); if(e.hp<=0 && !e.dead) this.kill(e); this.projs.splice(i,1); wh=true; break; } } } else { if(Dist(b,this.player)<b.r+this.player.r){this.player.hp-=b.dmg;ui.flash();if(this.player.hp<=0)this.over("Tu√© par Tir Ennemi");this.projs.splice(i,1);} }
                    }
                    this.ents.forEach(e=>{if(e.hitCD)e.hitCD--}); for(let i=this.ents.length-1;i>=0;i--)if(this.ents[i].dead)this.ents.splice(i,1);
                    for(let i=this.items.length-1;i>=0;i--){const l=this.items[i];if(Dist(l,this.player)<30){if(l.type==='cube'){this.player.cubes++;this.player.maxHp+=400;this.player.hp+=400;ui.notif("POWER UP!","#22c55e");}else{if(l.t==='hp')this.player.hp=Math.min(this.player.maxHp,this.player.hp+30);else this.player.xp+=30;}this.items.splice(i,1);}}
                    for(let i=this.parts.length-1;i>=0;i--){const p=this.parts[i]; p.x+=p.vx;p.y+=p.vy;p.life--;if(p.life<=0)this.parts.splice(i,1);}
                    ui.hud(); ui.drawMinimap();
                }
                const map=ARENAS[this.conf.arena]; ctx.fillStyle=map.color; ctx.fillRect(0,0,CFG.w,CFG.h);
                ctx.save(); if(this.state!=='MENU'){
                    const sx=(Math.random()-0.5)*this.shake, sy=(Math.random()-0.5)*this.shake; ctx.translate(-this.cam.x+sx, -this.cam.y+sy);
                    
                    // Grid Floor
                    ctx.strokeStyle=map.grid; ctx.lineWidth=2; const tx=Math.floor(this.cam.x/100)*100, ty=Math.floor(this.cam.y/100)*100; ctx.beginPath(); 
                    for(let x=tx;x<tx+CFG.w+100;x+=100){ctx.moveTo(x,0);ctx.lineTo(x,this.world);} for(let y=ty;y<ty+CFG.h+100;y+=100){ctx.moveTo(0,y);ctx.lineTo(this.world,y);} ctx.stroke();
                    
                    // HEIST ARROW
                    if(this.conf.mode === 'heist') {
                        const chest = this.ents.find(e => e.type === 'chest');
                        if(chest) {
                            const angle = Math.atan2(chest.y - this.player.y, chest.x - this.player.x);
                            ctx.save(); ctx.translate(this.player.x, this.player.y); ctx.rotate(angle); ctx.fillStyle = '#facc15'; ctx.beginPath(); ctx.moveTo(60, 0); ctx.lineTo(50, -10); ctx.lineTo(50, 10); ctx.fill(); ctx.restore();
                        }
                    }

                    // World Border
                    ctx.strokeStyle='#ef4444'; ctx.lineWidth=5; ctx.strokeRect(0,0,this.world,this.world);
                    
                    this.items.forEach(l=>{if(l.type==='cube'){ctx.fillStyle='#22c55e';ctx.fillRect(l.x-10,l.y-10,20,20);ctx.shadowColor='#22c55e';ctx.shadowBlur=10;ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.strokeRect(l.x-10,l.y-10,20,20);ctx.shadowBlur=0;}else{ctx.fillStyle=l.t==='hp'?'#22c55e':'#a855f7';ctx.beginPath();ctx.arc(l.x,l.y,8,0,Math.PI*2);ctx.fill();}});
                    
                    const renderList = [...this.map, ...this.ents, this.player, ...this.projs, ...this.parts]; renderList.sort((a,b) => a.y - b.y);
                    renderList.forEach(o => { if(o instanceof Wall) o.draw(ctx, map.wall); else if(o.draw) o.draw(ctx); else { ctx.fillStyle=o.c;ctx.beginPath();ctx.arc(o.x,o.y,o.r,0,Math.PI*2);ctx.fill(); } });
                    
                    // Projectiles Glow
                    this.projs.forEach(p => { ctx.shadowColor=p.c; ctx.shadowBlur=10; ctx.fillStyle=p.c; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0; });
                    
                    this.texts.forEach((t,i)=>{t.y+=t.vy;t.life--;ctx.globalAlpha=t.life/40;ctx.fillStyle=t.c;ctx.font="bold 20px Orbitron";ctx.fillText(t.t,t.x,t.y);ctx.globalAlpha=1;if(t.life<=0)this.texts.splice(i,1);});
                } ctx.restore();
            },
            kill(e){ e.dead=true; this.score+=(e.isBoss||e.isBot?500:100); this.player.xp+=(e.isBoss?300:20); this.player.super=Math.min(100,this.player.super+(e.isBoss?30:10)); this.player.hp=Math.min(this.player.maxHp,this.player.hp+(this.player.lifesteal||0)); if(Math.random()<0.3)this.items.push({x:e.x,y:e.y,t:Math.random()>0.5?'hp':'xp'}); USER.stats.kills++; ui.feed("Toi",e.isBot?"Rival":(e.type==='chest'?"COFFRE":e.name),true); if(this.player.xp>=this.player.xpMax){this.player.xp=0;this.player.xpMax*=1.2;this.player.lvl++;this.player.hp=this.player.maxHp;this.state='LEVELUP';ui.levelUp();} }
        };
        window.game=game; window.ui=ui; window.onload=()=>game.init();
    </script>
</body>
</html>
