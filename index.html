<!DOCTYPE html><html lang="fr"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>mBattle v0.7.6 - mAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- CORE --- */
        body { margin: 0; overflow: hidden; background-color: #020617; font-family: 'Rajdhani', sans-serif; color: white; touch-action: none; user-select: none; -webkit-user-select: none; -webkit-tap-highlight-color: transparent; }
        canvas { display: block; }
        /* --- UI & GLASS --- */
        .glass-panel { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px rgba(0,0,0,0.6); border-radius: 24px; }
        .glass-nav { background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(30px); border-top: 1px solid rgba(255,255,255,0.1); }
        .glass-btn { position: relative; overflow: hidden; background: linear-gradient(180deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%); border: 1px solid rgba(255,255,255,0.15); transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1); }
        .glass-btn:active { transform: scale(0.96); filter: brightness(1.2); }
        .glass-btn.selected { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; box-shadow: 0 0 25px rgba(59, 130, 246, 0.25) inset; }
        .season-gold { border-color: #fbbf24 !important; background: linear-gradient(145deg, rgba(251, 191, 36, 0.1), rgba(0,0,0,0.6)) !important; box-shadow: 0 0 15px rgba(251, 191, 36, 0.2) !important; animation: pulse-gold-border 3s infinite; }
        .season-gold .icon-box { background: rgba(251, 191, 36, 0.2) !important; border: 1px solid rgba(251, 191, 36, 0.4); }
        .pass-pro-card { background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 0 30px rgba(147, 51, 234, 0.3); }
        
        .locked { opacity: 0.8; filter: grayscale(0.8); cursor: pointer; position: relative; } 
        .locked::after { content: 'üîí'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; opacity: 0.5; }
        
        .font-tech { font-family: 'Orbitron', sans-serif; letter-spacing: 1px; }
        .currency-badge { background: rgba(0,0,0,0.8); padding: 6px 14px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.15); font-family: 'Orbitron'; font-weight: 700; display: flex; align-items: center; gap: 8px; font-size: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        /* --- NAV ICONS --- */
        .nav-item { color: #64748b; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .nav-item.active { color: #60a5fa; transform: translateY(-4px) scale(1.05); text-shadow: 0 0 15px rgba(59, 130, 246, 0.6); }
        .nav-item.active .icon { transform: scale(1.1); }
        /* --- VFX --- */
        #vignette { position: absolute; inset: 0; pointer-events: none; background: radial-gradient(circle, transparent 50%, #000 120%); z-index: 5; }
        #gas-overlay { position: absolute; inset: 0; pointer-events: none; opacity: 0; background: radial-gradient(circle, transparent 30%, rgba(34, 197, 94, 0.4) 80%); z-index: 4; transition: opacity 0.5s; }
        #flash-layer { position: absolute; inset: 0; pointer-events: none; background: #ef4444; opacity: 0; transition: opacity 0.1s; z-index: 6; mix-blend-mode: overlay; }
        /* --- CONTROLS --- */
        .joystick-zone { position: absolute; width: 140px; height: 140px; pointer-events: auto; z-index: 50; opacity: 0; transition: opacity 0.2s; }
        .joystick-zone.active { opacity: 1; }
        .stick-base {
            width: 130px; height: 130px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(0,0,0,0.3) 70%);
            border: 2px solid rgba(255,255,255,0.1);
            position: absolute; bottom: 50px;
            pointer-events: auto;
            display: block !important;
            transition: border-color 0.2s;
        }
        .stick-base.active { border-color: rgba(96, 165, 250, 0.5); background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, rgba(0,0,0,0.4) 70%); }
        #stick-left-base { left: 40px; }
        #stick-right-base { right: 40px; }
        .stick-knob {
            width: 50px; height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.9);
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px rgba(255,255,255,0.3);
            transition: transform 0.05s linear;
        }
        .action-btn { position: absolute; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 60; pointer-events: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.5); transition: transform 0.1s; }
        .action-btn:active { transform: scale(0.9); }
        /* --- ANIM --- */
        .kill-msg { font-size: 12px; font-weight: 800; text-shadow: 0 2px 4px black; animation: slideIn 0.3s ease-out; margin-bottom: 6px; background: linear-gradient(90deg, rgba(0,0,0,0.9) 0%, transparent 100%); padding: 6px 12px; border-left: 4px solid #3b82f6; border-radius: 0 4px 4px 0; }
        .kill-msg.red { border-color: #ef4444; }
        @keyframes slideIn { from { opacity:0; transform:translateX(-30px); } to { opacity:1; transform:translateX(0); } }
        .menu-anim { background: radial-gradient(circle at center, #0f172a 0%, #020617 100%); }
        .safe-pb { padding-bottom: max(90px, env(safe-area-inset-bottom) + 90px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        /* --- PROGRESS BAR --- */
        .rank-progress-bg { background: rgba(255,255,255,0.1); border-radius: 10px; height: 8px; width: 100%; overflow: hidden; margin-top: 8px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); }
        .rank-progress-fill { height: 100%; background: linear-gradient(90deg, #fbbf24, #f59e0b); width: 0%; transition: width 0.5s ease-out; border-radius: 10px; }
        /* --- BATTLE PASS TRACK (DUAL) --- */
        .pass-track-container { overflow-x: auto; padding: 30px 20px; scroll-behavior: smooth; position: relative; white-space: nowrap; -webkit-overflow-scrolling: touch; width: 100%; }
        .pass-wrapper { display: inline-block; min-width: 100%; position: relative; }
        .pass-track-line { position: absolute; top: 50%; left: 0; right: 0; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; z-index: 0; transform: translateY(-50%); }
        .pass-row { display: flex; gap: 40px; align-items: center; margin-bottom: 40px; position: relative; padding-left: 20px; padding-right: 20px; z-index: 10; }
        
        /* NEW STYLISH PASS DESIGN */
        .pass-label { position: absolute; left: 0; top: -30px; font-size: 14px; font-weight: 900; color: #94a3b8; text-transform: uppercase; letter-spacing: 2px; font-family: 'Orbitron'; background: rgba(0,0,0,0.6); padding: 4px 12px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .pro .pass-label { color: #fbbf24; border-color: #fbbf24; background: rgba(251, 191, 36, 0.1); box-shadow: 0 0 15px rgba(251, 191, 36, 0.3); }
        
        .pass-step {
            min-width: 110px; height: 130px;
            background: rgba(30, 41, 59, 0.8); 
            border: 1px solid rgba(255,255,255,0.15); 
            border-radius: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; z-index: 10; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); 
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); white-space: normal; text-align: center;
            overflow: hidden;
        }
        
        .pass-step::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 50%; background: linear-gradient(to bottom, rgba(255,255,255,0.05), transparent); pointer-events: none; }
        .tier-badge { background: #0f172a; color: #64748b; font-size: 10px; padding: 4px 10px; border-radius: 10px; margin-bottom: 8px; font-weight: 800; border: 1px solid rgba(255,255,255,0.1); }
        .pass-step.pro { background: linear-gradient(145deg, rgba(88, 28, 135, 0.6), rgba(15, 23, 42, 0.95)); border-color: rgba(168, 85, 247, 0.5); }
        .pass-step.pro.locked { opacity: 0.6; filter: grayscale(0.8); }
        .pass-step.pro.locked::before { content: 'üîí'; position: absolute; font-size: 32px; opacity: 0.8; z-index: 30; drop-shadow: 0 4px 4px black; }
        .pass-step.claimed { opacity: 0.5; filter: grayscale(1); transform: scale(0.95); }
        .pass-step.claimed .tier-badge { background: #10b981; color: white; border-color: #10b981; }
        @keyframes passPulse { 0% { transform: scale(1.15); box-shadow: 0 0 15px rgba(255,255,255,0.3); } 50% { transform: scale(1.2); box-shadow: 0 0 25px rgba(255,255,255,0.6); } 100% { transform: scale(1.15); box-shadow: 0 0 15px rgba(255,255,255,0.3); } }
        .pass-step.active { animation: passPulse 2s infinite ease-in-out; z-index: 20; border-color: white; border-width: 2px; }
        .pass-step.pro.active { box-shadow: 0 0 35px rgba(168, 85, 247, 0.5); border-color: #d8b4fe; }
        
        /* EMOTES */
        .emote-wheel { position: absolute; bottom: 120px; right: 20px; display: flex; flex-wrap: wrap; width: 160px; gap: 10px; z-index: 70; pointer-events: auto; }
        .emote-btn { width: 60px; height: 60px; background: rgba(0,0,0,0.8); border-radius: 50%; border: 2px solid white; font-size: 24px; display: flex; align-items: center; justify-content: center; transition: transform 0.1s; cursor: pointer; }
        .emote-btn:active { transform: scale(0.9); }
        .emote-grid-item { aspect-ratio: 1; background: rgba(255,255,255,0.05); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 32px; border: 2px solid transparent; cursor: pointer; transition: all 0.2s; position: relative; }
        .emote-grid-item:hover { background: rgba(255,255,255,0.1); }
        .emote-grid-item.unlocked { border-color: rgba(255,255,255,0.1); }
        .emote-grid-item.locked { border-color: rgba(255,255,255,0.05); }
        .emote-grid-item.selected { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); }
        
        /* STAT BARS */
        .stat-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .stat-label { width: 60px; font-size: 10px; font-weight: bold; color: #94a3b8; text-transform: uppercase; }
        .stat-track { flex: 1; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
        .stat-fill { height: 100%; border-radius: 4px; width: 0; transition: width 1s cubic-bezier(0.22, 1, 0.36, 1); }
        .diff-btn.active { background: linear-gradient(45deg, var(--tw-gradient-stops)) !important; border-color: rgba(255,255,255,0.5) !important; box-shadow: 0 0 15px var(--tw-shadow-color) !important; }
        @keyframes pulse-gold-border { 0% { border-color: #fbbf24; box-shadow: 0 0 15px rgba(251, 191, 36, 0.2); } 50% { border-color: #fef3c7; box-shadow: 0 0 25px rgba(251, 191, 36, 0.5); } 100% { border-color: #fbbf24; box-shadow: 0 0 15px rgba(251, 191, 36, 0.2); } }
        .rarity-badge { position: absolute; top: 4px; right: 4px; padding: 2px 6px; border-radius: 6px; font-size: 8px; font-weight: 900; text-transform: uppercase; z-index: 10; border: 1px solid rgba(255,255,255,0.2); }
    </style>
</head><body>
    <canvas id="gameCanvas"></canvas>
    <div id="gas-overlay"></div>
    <div id="vignette"></div>
    <div id="flash-layer"></div>
    <div id="season-particles" class="absolute inset-0 pointer-events-none overflow-hidden z-0"></div>
    <div id="ui-layer" class="absolute inset-0 pointer-events-none overflow-hidden z-10">
        <div id="hud" class="hidden w-full h-full relative">
            <div class="absolute top-4 left-4 flex flex-col gap-4 pointer-events-auto">
                <div class="glass-panel p-2 flex items-center gap-3 pr-4 scale-90 origin-top-left md:scale-100">
                    <div class="relative">
                        <div class="w-14 h-14 rounded-xl bg-gray-900 border border-white/20 flex items-center justify-center text-2xl shadow-lg overflow-hidden">
                            <span id="hud-icon" class="z-10 relative">ü§ñ</span>
                            <div class="absolute inset-0 bg-gradient-to-br from-blue-600/40 to-transparent"></div>
                        </div>
                        <div class="absolute -bottom-2 -right-1 bg-black border border-gray-600 text-[9px] px-1.5 py-0.5 rounded text-yellow-400 font-bold" id="hud-lvl">LVL 1</div>
                    </div>
                    <div class="flex flex-col w-28 gap-1">
                        <div class="h-2.5 bg-gray-800 rounded-full overflow-hidden border border-gray-600 relative"><div id="hud-hp-bar" class="h-full bg-green-500 w-full transition-all duration-200"></div></div>
                        <div class="flex gap-1 h-1 mt-0.5">
                            <div id="ammo-1" class="flex-1 bg-orange-500 rounded-full opacity-50 transition"></div>
                            <div id="ammo-2" class="flex-1 bg-orange-500 rounded-full opacity-50 transition"></div>
                            <div id="ammo-3" class="flex-1 bg-orange-500 rounded-full opacity-50 transition"></div>
                        </div>
                    </div>
                </div>
                <div class="glass-panel p-1 border-white/20 bg-black/50"><canvas id="minimap" width="100" height="100" class="rounded-lg bg-black/80 opacity-90"></canvas></div>
            </div>
            <div class="absolute top-6 left-1/2 -translate-x-1/2 text-center pointer-events-auto">
                <div id="hud-score" class="font-tech text-5xl font-bold text-white leading-none drop-shadow-[0_0_15px_rgba(255,255,255,0.4)]">0</div>
                <div class="text-[10px] font-bold text-blue-400 bg-black/50 px-2 rounded mt-1" id="hud-sub">VAGUE 1</div>
                <div id="hud-timer" class="text-xl font-black text-yellow-400 drop-shadow-lg mt-1 hidden">03:00</div>
            </div>
            <div class="absolute top-4 right-4 flex flex-col gap-4 pointer-events-auto items-end">
                <button onclick="game.togglePause()" class="glass-panel w-10 h-10 flex items-center justify-center hover:bg-white/10 text-lg transition active:scale-90">‚è∏</button>
            </div>
            <div id="boss-ui" class="hidden absolute top-24 left-1/2 -translate-x-1/2 w-3/4 max-w-lg pointer-events-auto transition-all duration-500">
                <div class="flex justify-between text-[10px] text-red-400 font-bold mb-1 uppercase tracking-widest"><span id="boss-name">BOSS</span><span id="boss-pct">100%</span></div>
                <div class="h-4 bg-red-950/80 border border-red-500/50 rounded-full overflow-hidden shadow-[0_0_20px_rgba(220,38,38,0.4)]"><div id="boss-bar" class="h-full bg-gradient-to-r from-red-600 to-red-500 w-full transition-all duration-200"></div></div>
            </div>
            <div id="kill-feed" class="absolute top-32 left-4 flex flex-col gap-2 w-48 pointer-events-none"></div>
            <div id="notif-area" class="absolute top-48 left-1/2 -translate-x-1/2 pointer-events-none flex flex-col items-center gap-2 w-full z-30"></div>
            <button id="btn-emote" class="absolute top-32 right-4 w-10 h-10 rounded-full glass-panel flex items-center justify-center text-xl pointer-events-auto active:scale-90 transition z-50" onmousedown="ui.toggleEmoteWheel()" ontouchstart="event.stopPropagation(); ui.toggleEmoteWheel()">üòÄ</button>
            <div id="emote-wheel" class="emote-wheel hidden"></div>
            <div id="mobile-controls" class="hidden absolute inset-0 z-40">
                <div id="stick-left-base" class="stick-base" style="left: 40px; bottom: 40px;"><div class="stick-knob"></div></div>
                <div id="stick-right-base" class="stick-base" style="right: 40px; bottom: 40px;"><div class="stick-knob"></div></div>
                <button id="btn-gadget" class="action-btn bottom-36 right-12 w-16 h-16 bg-green-900/90 border-2 border-green-500 active:scale-90 flex items-center justify-center pointer-events-auto transition shadow-lg" ontouchstart="event.stopPropagation(); game.player?.useGadget()" onmousedown="game.player?.useGadget()"><span class="font-tech font-bold text-[10px] z-10">GADGET</span><div class="absolute -top-1 -right-1 bg-black border border-white text-[9px] w-5 h-5 rounded-full flex items-center justify-center" id="gadget-count">3</div></button>
                <button id="btn-dash" class="action-btn bottom-12 right-36 w-20 h-20 rounded-full glass-panel border border-white/40 active:scale-90 flex items-center justify-center pointer-events-auto transition shadow-lg bg-blue-900/30" ontouchstart="event.stopPropagation(); game.player?.dash()" onmousedown="game.player?.dash()"><span class="text-3xl">‚ö°</span><div id="dash-cd" class="absolute inset-0 bg-black/70 origin-bottom h-0 transition-all duration-75 rounded-full"></div></button>
            </div>
        </div>
        <div id="menu-screen" class="absolute inset-0 menu-anim pointer-events-auto z-50 flex flex-col">
            <div class="w-full h-16 flex items-center justify-between px-5 pt-safe z-30 bg-gradient-to-b from-black/80 to-transparent">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-blue-500/20 border border-blue-400/30 flex items-center justify-center text-xl">ü§ñ</div>
                    <div><div class="font-tech font-bold leading-none text-lg">mBATTLE</div><div class="text-[10px] text-blue-400 font-bold tracking-widest">v0.7.6</div></div>
                </div>
                <div class="flex gap-3">
                    <div class="currency-badge"><span class="text-yellow-400">ü™ô</span> <span id="top-coins">0</span></div>
                    <div class="currency-badge"><span class="text-purple-400">üíé</span> <span id="top-gems">0</span></div>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto safe-pb p-5 hide-scrollbar relative">
                <div id="tab-play" class="tab-content flex flex-col items-center justify-center min-h-[65vh] gap-6 animate-fadeIn">
                    <div class="w-full max-w-md glass-panel p-5 border-l-4 border-yellow-500 bg-yellow-900/10 relative overflow-hidden">
                        <div class="flex items-center justify-between mb-2 relative z-10">
                            <div><div class="text-[10px] text-gray-400 uppercase font-bold">Rang Actuel</div><div class="text-2xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 to-yellow-500 font-tech" id="menu-rank">BRONZE I</div></div>
                            <div class="text-center"><div class="text-2xl">üèÜ</div><div class="font-bold text-white text-xl" id="menu-trophies">0</div></div>
                        </div>
                        <div class="flex justify-between text-[10px] font-bold text-gray-300 mt-1 relative z-10">
                            <span id="rank-progress-text">Encore 100 üèÜ avant BRONZE II</span><span id="rank-progress-pct">0%</span>
                        </div>
                        <div class="rank-progress-bg relative z-10"><div id="rank-progress-fill" class="rank-progress-fill"></div></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 w-full max-w-md">
                        <div onclick="ui.showTab('starters')" class="glass-panel p-4 flex flex-col items-center justify-center aspect-square active:scale-95 transition bg-blue-900/10 border-blue-500/30">
                            <div class="text-[10px] text-blue-300 font-bold mb-2 uppercase">H√©ros</div><div class="text-5xl mb-2 drop-shadow-xl" id="play-icon">üéØ</div><div class="font-black text-lg leading-none" id="play-starter">Soldier</div>
                        </div>
                        <div onclick="ui.showTab('modes')" class="glass-panel p-4 flex flex-col items-center justify-center aspect-square active:scale-95 transition bg-purple-900/10 border-purple-500/30">
                            <div class="text-[10px] text-purple-300 font-bold mb-2 uppercase">Mission</div><div class="text-5xl mb-2 drop-shadow-xl" id="play-mode-icon">üî•</div><div class="font-black text-lg leading-none" id="play-mode">Survie</div>
                        </div>
                    </div>
                    <div class="w-full max-w-md glass-panel p-4 flex flex-col items-center mt-4">
                        <div class="text-[10px] text-yellow-300 font-bold mb-3 uppercase tracking-widest">DIFFICULT√â</div>
                        <div class="flex gap-3 w-full">
                            <button id="diff-easy" onclick="game.setDifficulty('easy')" style="--tw-shadow-color:#22c55e;" class="diff-btn flex-1 glass-btn py-3 rounded-xl font-bold text-sm bg-gradient-to-r from-green-600/30 to-green-900/30 border-green-600/50 text-green-400 active:scale-95 transition">Facile</button>
                            <button id="diff-normal" onclick="game.setDifficulty('normal')" style="--tw-shadow-color:#3b82f6;" class="diff-btn flex-1 glass-btn py-3 rounded-xl font-bold text-sm bg-gradient-to-r from-blue-600/30 to-blue-900/30 border-blue-600/50 text-blue-400 active:scale-95 transition">Normal</button>
                            <button id="diff-hard" onclick="game.setDifficulty('hard')" style="--tw-shadow-color:#ef4444;" class="diff-btn flex-1 glass-btn py-3 rounded-xl font-bold text-sm bg-gradient-to-r from-red-600/30 to-red-900/30 border-red-600/50 text-red-400 active:scale-95 transition">Difficile</button>
                        </div>
                    </div>
                    <button onclick="game.start()" class="w-full max-w-md bg-gradient-to-r from-blue-600 to-indigo-600 h-20 rounded-2xl shadow-[0_0_40px_rgba(37,99,235,0.4)] flex items-center justify-center gap-4 active:scale-95 transition transform hover:-translate-y-1 mt-4 border border-white/20">
                        <span class="text-3xl font-black italic tracking-tighter">JOUER</span><span class="text-2xl animate-pulse">üöÄ</span>
                    </button>
                </div>
                <div id="tab-pass" class="tab-content hidden animate-fadeIn w-full max-w-5xl mx-auto pb-20">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-3xl font-black flex items-center gap-2 font-tech"><span class="text-yellow-500">///</span> mPASS</h2>
                        <div class="text-right text-xs font-bold text-blue-300">SAISON 1: TITAN FURY</div>
                    </div>
                    <div class="glass-panel p-6 mb-6 bg-gradient-to-r from-blue-900/20 to-transparent border-blue-500/30">
                        <div class="flex justify-between items-center mb-4">
                             <div><div class="text-2xl font-black text-white">Palier <span id="pass-lvl">1</span></div><div class="text-xs text-gray-400" id="pass-xp-txt">0/100 XP</div></div>
                             <div id="pass-pro-status"></div>
                        </div>
                        <div class="h-4 bg-black/50 rounded-full overflow-hidden"><div id="pass-bar" class="h-full bg-gradient-to-r from-blue-500 to-purple-500 w-0 transition-all duration-300"></div></div>
                    </div>
                    <div class="pass-track-container hide-scrollbar">
                        <div class="pass-wrapper">
                             <div class="pass-track-line"></div>
                             <div class="pass-row" id="pass-track-free"><div class="pass-label">GRATUIT</div></div>
                             <div class="pass-row pro" id="pass-track-pro"><div class="pass-label">PRO üëë</div></div>
                        </div>
                    </div>
                </div>
                <div id="tab-starters" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto"><h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-blue-500">///</span> ARMURERIE</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-10" id="list-starters"></div></div>
                <div id="tab-modes" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto"><h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-purple-500">///</span> MISSIONS</h2><div class="grid grid-cols-1 gap-3 mb-8" id="list-modes"></div><h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-gray-400">TERRAINS</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-3" id="list-arenas"></div></div>
                <div id="tab-emotes" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto pb-20"><h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-pink-500">///</span> COLLECTION</h2><div class="glass-panel p-6 mb-4"><div class="text-xs text-gray-400 mb-4 uppercase font-bold">Emotes √âquip√©es</div><div class="flex justify-center gap-4 mb-2" id="equipped-emotes"></div></div><div class="grid grid-cols-4 md:grid-cols-6 gap-3" id="list-emotes"></div></div>
                <div id="tab-shop" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto pb-20">
                    <h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-yellow-500">///</span> MEGA MALL</h2>
                    <div class="text-xs text-right text-gray-400 mb-4">Nouveaux items: <span id="shop-timer" class="text-yellow-400 font-mono">--:--</span></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="shop-offers"></div>
                </div>
                <div id="tab-infos" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto"><h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-gray-500">///</span> INFOS</h2><div class="glass-panel p-6 mb-6 hidden md:block"><h3 class="text-xl font-bold text-blue-400 mb-4">COMMANDES PC</h3><table class="w-full text-sm text-left text-gray-300"><tr class="border-b border-gray-700"><th class="py-2">Action</th><th class="py-2">Touche</th></tr><tr><td class="py-2">D√©placement</td><td class="font-mono text-yellow-400">Z Q S D</td></tr><tr><td class="py-2">Viser</td><td class="font-mono text-yellow-400">Souris</td></tr><tr><td class="py-2">Tirer</td><td class="font-mono text-yellow-400">Clic Gauche</td></tr><tr><td class="py-2">Dash</td><td class="font-mono text-yellow-400">Espace</td></tr><tr><td class="py-2">Gadget</td><td class="font-mono text-yellow-400">E</td></tr><tr><td class="py-2">Emote</td><td class="font-mono text-yellow-400">V</td></tr></table></div><div class="grid grid-cols-2 gap-4 mb-8"><div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">‚ò†Ô∏è</div><div class="text-[10px] text-gray-500 uppercase font-bold">Kills</div><div class="text-2xl font-bold" id="stat-kills">0</div></div><div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">üåä</div><div class="text-[10px] text-gray-500 uppercase font-bold">Max Vague</div><div class="text-2xl font-bold" id="stat-wave">0</div></div><div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">üéÆ</div><div class="text-[10px] text-gray-500 uppercase font-bold">Parties</div><div class="text-2xl font-bold" id="stat-games">0</div></div><div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">‚öîÔ∏è</div><div class="text-[10px] text-gray-500 uppercase font-bold">Victoires</div><div class="text-2xl font-bold" id="stat-wins">0</div></div><div class="glass-panel p-4 col-span-2 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">üí•</div><div class="text-[10px] text-gray-500 uppercase font-bold">D√©g√¢ts Totaux</div><div class="text-2xl font-bold" id="stat-dmg">0</div></div></div><h3 class="text-xl font-bold mb-4 text-blue-400">PATCH NOTES</h3><div class="glass-panel p-6 text-sm text-gray-300"><div class="patch-note"><h3>v0.7.6 (CRASH FIX)</h3><ul><li>‚úÖ Fix Bug Chargement (renderLists).</li><li>üõ°Ô∏è Initialisation s√©curis√©e.</li><li>‚ö° Gameplay toujours au top !</li></ul></div></div></div>
                <div id="tab-profile" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto pb-20">
                    <h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-white">///</span> COMPTE</h2>
                    <div class="glass-panel p-6 mb-6 flex items-center gap-6 bg-blue-900/10 border-blue-500/30">
                        <div class="relative group cursor-pointer" onclick="ui.openAvatarSelector()">
                            <div class="w-20 h-20 rounded-full bg-gray-800 border-2 border-white/20 flex items-center justify-center text-4xl shadow-lg overflow-hidden hover:border-blue-500 transition" id="profile-avatar">üë§</div>
                            <div class="absolute bottom-0 right-0 bg-blue-600 border border-white text-[10px] p-1 rounded-full text-white shadow-sm">‚úèÔ∏è</div>
                        </div>
                        <div class="flex-1">
                            <div class="text-xs text-gray-400 font-bold uppercase mb-1">Pseudonyme</div>
                            <input type="text" id="profile-name" class="bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-white font-bold w-full mb-2 focus:outline-none focus:border-blue-500 transition" onchange="USER.name = this.value; Storage.save();" value="Player">
                            <div class="flex justify-between items-center">
                                <div class="text-xs text-blue-400 font-tech tracking-widest" id="profile-tag">#TAG</div>
                                <div class="bg-black border border-gray-600 text-[10px] px-2 rounded text-yellow-400 font-bold" id="profile-lvl">LVL 1</div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="glass-panel p-6">
                            <div class="font-bold text-lg mb-2 flex items-center gap-2">üíæ Sauvegarde</div>
                            <div class="text-xs text-gray-400 mb-4">Copie ce code pour transf√©rer ton compte.</div>
                            <button onclick="ui.exportSave()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition text-sm">COPIER MA SAUVEGARDE üìã</button>
                        </div>
                        <div class="glass-panel p-6">
                            <div class="font-bold text-lg mb-2 flex items-center gap-2">üì• Importer</div>
                            <div class="text-xs text-gray-400 mb-4">Colle un code de sauvegarde ici.</div>
                            <button onclick="ui.importSave()" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-xl transition text-sm">IMPORTER SAUVEGARDE üîÑ</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="w-full glass-nav h-[90px] pb-safe flex justify-around items-center px-2 z-40 relative overflow-x-auto hide-scrollbar">
                <button onclick="ui.showTab('play')" id="nav-play" class="nav-item flex flex-col items-center p-2 min-w-[60px] active selected"><span class="text-2xl icon mb-1">‚öîÔ∏è</span><span class="text-[9px] font-bold">JOUER</span></button>
                <button onclick="ui.showTab('starters')" id="nav-starters" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">ü¶∏</span><span class="text-[9px] font-bold">H√âROS</span></button>
                <button onclick="ui.showTab('pass')" id="nav-pass" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">üé´</span><span class="text-[9px] font-bold">PASS</span></button>
                <button onclick="ui.showTab('emotes')" id="nav-emotes" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">üòÄ</span><span class="text-[9px] font-bold">EMOTES</span></button>
                <button onclick="ui.showTab('shop')" id="nav-shop" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">üõí</span><span class="text-[9px] font-bold">SHOP</span></button>
                <button onclick="ui.showTab('infos')" id="nav-infos" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">‚ÑπÔ∏è</span><span class="text-[9px] font-bold">STATS</span></button>
                <button onclick="ui.showTab('profile')" id="nav-profile" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">üë§</span><span class="text-[9px] font-bold">PROFIL</span></button>
            </div>
        </div>
        <!-- HERO DETAILS MODAL -->
        <div id="hero-details-modal" class="hidden absolute inset-0 bg-black/95 backdrop-blur-xl flex items-center justify-center z-[60] pointer-events-auto animate-fadeIn" onclick="this.classList.add('hidden')">
            <div class="glass-panel p-6 max-w-md w-full mx-4 relative border-2 border-blue-500/30" onclick="event.stopPropagation()" id="hero-card-inner">
                <button onclick="document.getElementById('hero-details-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl z-10">√ó</button>
                <div class="flex flex-col items-center mb-6"><div class="w-24 h-24 rounded-2xl bg-black/50 border-2 border-white/20 flex items-center justify-center text-6xl shadow-[0_0_30px_rgba(59,130,246,0.3)] mb-3" id="hd-icon"></div><h2 class="text-3xl font-black uppercase font-tech tracking-wider" id="hd-name"></h2><div id="hd-rarity" class="mb-1 text-xs font-bold uppercase tracking-widest px-3 py-1 rounded bg-gray-800">COMMUN</div><div class="text-blue-400 font-bold text-sm" id="hd-lvl"></div></div>
                <div class="space-y-4 mb-6"><div class="stat-row"><div class="stat-label">SANT√â</div><div class="stat-track"><div id="hd-bar-hp" class="stat-fill bg-green-500"></div></div></div><div class="stat-row"><div class="stat-label">D√âG√ÇTS</div><div class="stat-track"><div id="hd-bar-dmg" class="stat-fill bg-red-500"></div></div></div><div class="stat-row"><div class="stat-label">VITESSE</div><div class="stat-track"><div id="hd-bar-spd" class="stat-fill bg-yellow-400"></div></div></div></div>
                <!-- SKINS SELECTOR -->
                <div class="mb-4" id="hd-skins-container">
                    <div class="text-[10px] text-gray-400 uppercase font-bold mb-2">SKINS</div>
                    <div class="flex gap-2 overflow-x-auto hide-scrollbar" id="hd-skins-list"></div>
                </div>
                <div class="bg-white/5 p-4 rounded-xl border border-white/10 mb-4"><div class="flex justify-between"><div><div class="text-[10px] text-gray-400 uppercase font-bold mb-1">GADGET</div><div class="text-sm font-bold text-white flex items-center gap-2"><span id="hd-gadget-icon">‚ö°</span> <span id="hd-gadget-name"></span></div></div><div><div class="text-[10px] text-gray-400 uppercase font-bold mb-1 text-right">PASSIF</div><div class="text-sm font-bold text-yellow-400 text-right" id="hd-passive"></div></div></div></div>
                <p class="text-xs text-gray-400 italic text-center mb-6 leading-relaxed whitespace-pre-line" id="hd-desc"></p>
                <div id="hd-actions" class="grid gap-2"></div>
            </div>
        </div>
        <div id="avatar-selector" class="hidden absolute inset-0 bg-black/90 backdrop-blur-xl flex items-center justify-center z-[60] pointer-events-auto animate-fadeIn" onclick="this.classList.add('hidden')">
            <div class="glass-panel p-6 max-w-sm w-full mx-4" onclick="event.stopPropagation()"><h3 class="text-xl font-black mb-4 text-center">CHOISIS TON AVATAR</h3><div class="grid grid-cols-4 gap-4 mb-4" id="avatar-grid"></div><button onclick="document.getElementById('avatar-selector').classList.add('hidden')" class="w-full bg-gray-700 py-3 rounded-xl font-bold">ANNULER</button></div>
        </div>
        <div id="levelup-screen" class="hidden absolute inset-0 bg-black/90 backdrop-blur-xl flex items-center justify-center z-[60] pointer-events-auto animate-fadeIn">
            <div class="w-full max-w-sm p-6 text-center"><h2 class="text-5xl font-tech text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 font-black mb-4 animate-bounce">LEVEL UP!</h2><div id="perk-container" class="grid gap-3"></div></div>
        </div>
        <div id="gameover-screen" class="hidden absolute inset-0 bg-red-950/95 backdrop-blur-2xl flex items-center justify-center z-[70] pointer-events-auto animate-fadeIn">
            <div class="text-center max-w-sm w-full p-6">
                <h1 class="text-8xl font-black text-white mb-2 drop-shadow-2xl tracking-tighter">KO</h1>
                <p class="text-red-400 font-bold text-xl mb-8 uppercase tracking-widest" id="go-reason">√âlimin√©</p>
                <div class="glass-panel p-6 mb-6 grid grid-cols-2 gap-4 text-left bg-black/40">
                    <div><div class="text-[10px] text-gray-500 uppercase font-bold mb-1">Score</div><div id="go-score" class="text-2xl font-black text-white font-tech">0</div></div>
                    <div><div class="text-[10px] text-gray-500 uppercase font-bold mb-1">Gains</div><div class="text-xl font-bold text-yellow-400" id="go-rewards"></div></div>
                </div>
                <button onclick="game.toMenu()" class="w-full bg-white text-black font-black py-4 rounded-xl active:scale-95 transition shadow-xl text-lg">RETOUR MENU üè†</button>
            </div>
        </div>
    </div>
    <script>
        /* mBATTLE TITAN v0.7.6 - CRASH FIX & STABILITY */
        // FIX: Declare game variable immediately to avoid ReferenceError
        let game; 

        const CFG = { w: 0, h: 0, world: 2500 };
        
        // RARITY DEFINITIONS
        const RARITY = {
            common: { name: 'Commun', color: '#94a3b8', bg: 'bg-gray-500' },
            rare: { name: 'Rare', color: '#3b82f6', bg: 'bg-blue-500' },
            epic: { name: '√âpique', color: '#a855f7', bg: 'bg-purple-500' },
            legendary: { name: 'L√©gendaire', color: '#eab308', bg: 'bg-yellow-500' },
            mythic: { name: 'Mythique', color: '#ef4444', bg: 'bg-red-600' }
        };

        const STARTERS = {
            soldier: { name: "Soldier", rarity: 'common', icon: "üî´", hp: 130, dmg: 22, spd: 5.5, rate: 14, ammo:3, reload:40, price: 0, scale:{hp:10, dmg:2}, color: '#3b82f6', desc: "Polyvalent.", gadget: "heal", lore: "V√©t√©ran des guerres galactiques.", passive: "Regen Rapide", skins: [ {id:'default', name:'Soldat', c:'#3b82f6'}, {id:'gold', name:'Soldat Or', c:'#fbbf24', price: 2000}, {id:'commando', name:'Commando', c:'#166534', price: 1500}, {id:'pixel', name:'Pixel', c:'#60a5fa', price: 1000} ] },
            tank:    { name: "Heavy", rarity: 'rare',  icon: "üõ°Ô∏è", hp: 320, dmg: 14, spd: 3.5, rate: 35, ammo:3, reload:55, price: 500, scale:{hp:30, dmg:1}, color: '#22c55e', type: 'shotgun', desc: "Sac √† PV.", gadget: "shield", lore: "Une forteresse mobile.", passive: "Armure +20%", skins: [ {id:'default', name:'Heavy', c:'#22c55e'}, {id:'toxic', name:'Toxic', c:'#a3e635', price: 1500}, {id:'mecha', name:'Mecha', c:'#f3f4f6', price: 2500}, {id:'rusty', name:'Rouill√©', c:'#78350f', price: 1000} ] },
            sniper:  { name: "Sniper", rarity: 'rare', icon: "ü¶Ö", hp: 80,  dmg: 120, spd: 5, rate: 65, ammo:3, reload:80, price: 800, scale:{hp:5, dmg:15}, color: '#a855f7', type: 'sniper', desc: "Tireur d'√©lite.", gadget: "knockback", lore: "Ne rate jamais sa cible.", passive: "Critique +10%", skins: [{id:'default', name:'Sniper', c:'#a855f7'}, {id:'elite', name:'Elite', c:'#1e1b4b', price: 3000}, {id:'camo', name:'Camo', c:'#3f6212', price: 1500}, {id:'ghillie', name:'Ghillie', c:'#14532d', price: 2000}] },
            assassin:{ name: "Assassin", rarity: 'epic', icon: "üó°Ô∏è", hp: 90,  dmg: 18, spd: 7.5, rate: 8, ammo:4, reload:30,  price: 1200, scale:{hp:8, dmg:4}, color: '#ef4444', desc: "Ultra rapide.", gadget: "speed", lore: "Une ombre dans la nuit.", passive: "Vitesse Kill", skins: [{id:'default', name:'Assassin', c:'#ef4444'}, {id:'ninja', name:'Ninja', c:'#171717', price: 2500}, {id:'void', name:'N√©ant', c:'#4c1d95', price: 3500}] },
            pyro:    { name: "Pyro", rarity: 'epic',   icon: "üî•", hp: 160, dmg: 7, spd: 5, rate: 4, ammo:50, reload:10, price: 1500, scale:{hp:15, dmg:1}, color: '#f97316', type: 'flame', desc: "Zone de feu.", gadget: "dash", lore: "Adore l'odeur du napalm.", passive: "Br√ªlure", skins: [{id:'default', name:'Pyro', c:'#f97316'}, {id:'blueflame', name:'Flamme Bleue', c:'#3b82f6', price: 2000}, {id:'toxic', name:'Toxique', c:'#16a34a', price: 1500}] },
            ronin:   { name: "Ronin", rarity: 'legendary',  icon: "üëπ", hp: 180, dmg: 60, spd: 6.5, rate: 25, ammo:3, reload:40, price: 3000, scale:{hp:12, dmg:8}, color: '#be185d', type: 'melee', desc: "Katana.", gadget: "heal", lore: "Cherche la r√©demption.", passive: "Vol de Vie", skins: [{id:'default', name:'Ronin', c:'#be185d'}, {id:'ghost', name:'Fant√¥me', c:'#e5e7eb', price: 3500}, {id:'cyber', name:'Cyber', c:'#06b6d4', price: 3000}] },
            cyber:   { name: "Cyber", rarity: 'legendary',  icon: "ü¶æ", hp: 140, dmg: 35, spd: 5, rate: 20, ammo:3, reload:45, price: 5000, scale:{hp:10, dmg:5}, color: '#06b6d4', type: 'laser', desc: "Laser.", gadget: "teleport", lore: "Fusion homme-machine.", passive: "Pr√©cision", skins: [{id:'default', name:'Cyber', c:'#06b6d4'}, {id:'neon', name:'N√©on', c:'#d946ef', price: 4000}, {id:'proto', name:'Proto', c:'#64748b', price: 2000}] },
            titan:   { name: "Titan", rarity: 'mythic',  icon: "ü¶æ", hp: 600, dmg: 40, spd: 3.0, rate: 50, ammo:2, reload:70, price: 0, scale:{hp:50, dmg:5}, color: '#eab308', type: 'melee', desc: "SAISON 1 GRATUIT.", gadget: "shield", lore: "Gardien l√©gendaire.", passive: "R√©sistance", skins: [{id:'default', name:'Titan', c:'#eab308'}, {id:'prime', name:'Titan Prime', c:'#713f12', price: 9999}, {id:'frozen', name:'Givr√©', c:'#0ea5e9', price: 5000}] },
            volt:    { name: "Volt", rarity: 'epic',   icon: "‚ö°", hp: 110, dmg: 18, spd: 6.0, rate: 10, ammo: 4, reload: 30, price: 2000, scale:{hp:8, dmg:3}, color: '#facc15', desc: "Tir √©lectrique.", gadget: "speed", lore: "√ânergie statique.", passive: "Etourdissement", skins: [{id:'default', name:'Volt', c:'#facc15'}, {id:'plasma', name:'Plasma', c:'#8b5cf6', price: 2500}, {id:'dark', name:'Sombre', c:'#1e293b', price: 2000}] },
            goliath: { name: "Goliath", rarity: 'mythic', icon: "üóø", hp: 450, dmg: 12, spd: 3.0, rate: 40, ammo: 2, reload: 60, price: 4000, scale:{hp:40, dmg:2}, color: '#78716c', type: 'shotgun', desc: "Lance des rochers.", gadget: "shield", lore: "G√©ant de pierre.", passive: "√âcrasement", skins: [{id:'default', name:'Goliath', c:'#78716c'}, {id:'moss', name:'Mousse', c:'#166534', price: 1500}, {id:'obsidian', name:'Obsidienne', c:'#0f172a', price: 3500}] },
            magma:   { name: "Magma", rarity: 'mythic',  icon: "üåã", hp: 380, dmg: 60, spd: 3.2, rate: 45, ammo: 2, reload: 55, price: 5000, scale:{hp:25, dmg:4}, color: '#7f1d1d', type: 'flame', desc: "SAISON 1.", gadget: "dash", lore: "N√© dans un volcan.", passive: "Lave", skins: [{id:'default', name:'Magma', c:'#7f1d1d'}, {id:'blue', name:'Flamme Bleue', c:'#2563eb', price: 3000}, {id:'obsidian', name:'Obsidienne', c:'#171717', price: 4000}] },
            pulse:   { name: "Pulse", rarity: 'legendary',  icon: "üí†", hp: 100, dmg: 25, spd: 5.8, rate: 12, ammo: 4, reload: 25, price: 3000, scale:{hp:8, dmg:3}, color: '#22d3ee', desc: "Ondes d'√©nergie.", gadget: "knockback", lore: "Technicien sonique.", passive: "Aura Dmg", skins: [{id:'default', name:'Pulse', c:'#22d3ee'}, {id:'neon', name:'N√©on', c:'#f0abfc', price: 2500}, {id:'darkmatter', name:'Mati√®re Noire', c:'#312e81', price: 3500}] },
            viper: { name: "Viper", rarity: 'epic', icon: "üêç", hp: 110, dmg: 10, spd: 6.2, rate: 5, ammo: 25, reload: 40, price: 3500, scale:{hp:8, dmg:1}, color: '#4d7c0f', type: 'flame', desc: "Tire du poison.", gadget: "speed", lore: "Mortel et silencieux.", passive: "Poison", skins: [{id:'default', name:'Viper', c:'#4d7c0f'}, {id:'cobra', name:'Cobra', c:'#eab308', price: 2000}] },
            chrono: { name: "Chrono", rarity: 'mythic', icon: "‚è≥", hp: 100, dmg: 12, spd: 6.5, rate: 4, ammo: 30, reload: 15, price: 8000, scale:{hp:8, dmg:1}, color: '#0ea5e9', type: 'laser', desc: "Ma√Ætre du temps.", gadget: "teleport", lore: "Vient du futur pour gagner.", passive: "Recharge Rapide", skins: [{id:'default', name:'Chrono', c:'#0ea5e9'}, {id:'future', name:'Future', c:'#f472b6', price: 5000}] }
        };
        const MODES = { survival: { name: "Survie", icon: "üßü", desc: "Vagues infinies.", ranked: false }, ranked: { name: "Class√©", icon: "üèÜ", desc: "Comp√©tition.", ranked: true }, duel: { name: "1v1 Duel", icon: "‚öîÔ∏è", desc: "Duel Bot IA.", ranked: false, boss: true }, heist: { name: "Braquage", icon: "üíé", desc: "D√©truis le coffre!", ranked: false, boss: true }, boss_rush: { name: "Boss Rush", icon: "üëπ", desc: "Combat de Boss.", ranked: false, boss: true }, titan_raid: { name: "Raid Titan", icon: "üåã", desc: "L'ultime d√©fi.", ranked: false, boss: true, special: true }, defense: { name: "D√©fense", icon: "üõ°Ô∏è", desc: "Prot√®ge le cristal.", ranked: false, boss: true }, infection: { name: "Infection", icon: "‚ò£Ô∏è", desc: "Survivre √† la horde.", ranked: false } };
        const ARENAS = { tokyo: { name: "Neon Tokyo", color: '#050b14', grid: 'rgba(59,130,246,0.15)', wall: '#1e293b' }, sand: { name: "Sandstorm",  color: '#271a0c', grid: 'rgba(245,158,11,0.15)', wall: '#451a03' }, ice: { name: "Ice Age", color: '#082f49', grid: 'rgba(255,255,255,0.1)', wall: '#164e63' }, jungle: { name: "Jungle", color: '#064e3b', grid: 'rgba(34,197,94,0.2)', wall: '#052e16' }, magma: { name: "Magma", color: '#450a0a', grid: 'rgba(239,68,68,0.2)', wall: '#280505' }, titan_forge: { name: "La Forge", color: '#2a0a0a', grid: 'rgba(250,204,21,0.2)', wall: '#4a0404', special: true }, ruins: { name: "Ruines", color: '#292524', grid: 'rgba(168,162,158,0.1)', wall: '#44403c' }, cyber_city: { name: "Cyber City", color: '#0f172a', grid: 'rgba(6,182,212,0.2)', wall: '#164e63' } };
        const PERKS = [{ name: 'Gros Calibre', icon: 'üí™', desc: '+25% D√©g√¢ts', fn: p => p.stats.dmg *= 1.25 }, { name: 'Armure Nano', icon: 'ü¶∫', desc: '+30% PV Max', fn: p => { p.maxHp *= 1.3; p.hp += 50; } }, { name: 'Turbo', icon: 'üëü', desc: '+15% Vitesse', fn: p => p.stats.spd *= 1.15 }];
        const RANKS = [{n:"BRONZE I", t:0, c:"#cd7f32"}, {n:"BRONZE II", t:100, c:"#cd7f32"}, {n:"BRONZE III", t:200, c:"#cd7f32"}, {n:"SILVER I", t:300, c:"#c0c0c0"}, {n:"SILVER II", t:500, c:"#c0c0c0"}, {n:"SILVER III", t:700, c:"#c0c0c0"}, {n:"GOLD I", t:1000, c:"#ffd700"}, {n:"GOLD II", t:1300, c:"#ffd700"}, {n:"GOLD III", t:1600, c:"#ffd700"}, {n:"PLATINUM I", t:2000, c:"#22d3ee"}, {n:"PLATINUM II", t:2500, c:"#22d3ee"}, {n:"DIAMOND", t:3500, c:"#a855f7"}, {n:"mMASTER", t:5000, c:"#ef4444"}];
        const ICONS = ["üë§","ü§ñ","üëΩ","ü¶Å","ü¶Ñ","üíÄ","‚öîÔ∏è","üíé","üëë","üéÆ","üöÄ","üî•","‚ùÑÔ∏è","‚ö°","üåü","üê±"];
        const EMOTE_LIST = [
            {id:'happy', i:'üòÄ', price: 0}, {id:'angry', i:'üò°', price: 0}, {id:'gg', i:'üëç', price: 0}, {id:'rip', i:'üíÄ', price: 0},
            {id:'love', i:'üòç', price: 20}, {id:'clown', i:'ü§°', price: 20}, {id:'fire', i:'üî•', price: 30}, {id:'crown', i:'üëë', price: 50},
            {id:'ghost', i:'üëª', price: 30}, {id:'robot', i:'ü§ñ', price: 30}, {id:'flex', i:'üí™', price: 20}, {id:'cry', i:'üò≠', price: 20},
            {id:'cool', i:'üòé', price: 20}, {id:'party', i:'ü•≥', price: 20}, {id:'sleeping', i:'üò¥', price: 10}, {id:'devil', i:'üòà', price: 30},
            // NEW EMOTES
            {id:'money', i:'ü§ë', price: 40}, {id:'sick', i:'ü§¢', price: 10}, {id:'shhh', i:'ü§´', price: 15}, {id:'think', i:'ü§î', price: 15}
        ];
        const DIFFICULTY = {
            easy: { name: 'Facile', mult: 0.7, color: 'text-green-400' },
            normal: { name: 'Normal', mult: 1.0, color: 'text-blue-400' },
            hard: { name: 'Difficile', mult: 1.5, color: 'text-red-400' }
        };

        const CURRENT_VERSION_KEY = 'mBattle_Data_v20';
        const PREVIOUS_KEYS = ['mBattle_Data_v19', 'mBattle_Data_v18', 'mBattle_Data_v17', 'mBattle_Data_v16'];
        let USER = {
            name: "Joueur", avatar: "üë§", tag: "#" + Math.random().toString(36).substr(2, 6).toUpperCase(),
            coins: 500, gems: 10, trophies: 0, unlocked: ['soldier', 'titan'], levels: { soldier: 1, titan: 1 }, selected: 'soldier',
            stats: { kills: 0, maxWave: 0, games: 0, wins: 0, dmg: 0 }, lastDaily: 0,
            pass: { tier: 1, xp: 0, claimed: [], claimedPro: [] },
            shop: { lastRefresh: 0, items: [] },
            emotes: ['happy', 'angry', 'gg', 'rip'], equippedEmotes: ['happy', 'angry', 'gg', 'rip'],
            mPassPro: false,
            skins: {}, 
            ownedSkins: [] 
        };

        // --- PASS REWARD DEFINITION ---
        const PASS_REWARDS = {
            1: { free: 'coins:50', pro: 'skin:titan_prime' },
            5: { free: 'emote:love', pro: 'gems:20' },
            10: { free: 'box:1', pro: 'skin:assassin_ninja' },
            15: { free: 'coins:100', pro: 'emote:crown' },
            20: { free: 'box:1', pro: 'gems:40' },
            30: { free: 'box:1', pro: 'emote:robot' },
            40: { free: 'coins:200', pro: 'skin:pyro_blueflame' },
            50: { free: 'box:1', pro: 'skin:sniper_elite' }
        };

        const getPassReward = (tier, isPro) => {
            if (PASS_REWARDS[tier]) {
                const rewardString = isPro ? PASS_REWARDS[tier].pro : PASS_REWARDS[tier].free;
                if (rewardString.includes(':')) return rewardString;
            }
            if (isPro) {
                return (tier % 2 === 0) ? 'gems:10' : 'coins:150';
            } else {
                return (tier % 3 === 0) ? 'gems:3' : 'coins:30';
            }
        };

        const Storage = {
            save() { localStorage.setItem(CURRENT_VERSION_KEY, JSON.stringify(USER)); },
            load() {
                let d = localStorage.getItem(CURRENT_VERSION_KEY);
                if (!d) { for (let key of PREVIOUS_KEYS) { const oldData = localStorage.getItem(key); if (oldData) { d = oldData; break; } } }
                if (d) {
                    try {
                        const saved = JSON.parse(d);
                        USER = { ...USER, ...saved,
                            stats: { ...USER.stats, ...(saved.stats||{}) },
                            pass: { ...USER.pass, ...(saved.pass||{}), claimedPro: saved.pass?.claimedPro || [] },
                            shop: { ...USER.shop, ...(saved.shop||{}) },
                            levels: { ...USER.levels, ...(saved.levels||{}) },
                            emotes: saved.emotes || ['happy', 'angry', 'gg', 'rip'],
                            equippedEmotes: saved.equippedEmotes || ['happy', 'angry', 'gg', 'rip'],
                            mPassPro: saved.mPassPro || false,
                            skins: saved.skins || {},
                            ownedSkins: saved.ownedSkins || []
                        };
                        if(!USER.unlocked.includes('titan')) USER.unlocked.push('titan');
                        
                        // FIX: Ensure game exists before accessing properties to prevent crash on early load
                        if (typeof game !== 'undefined' && game.conf && !game.conf.difficulty) {
                             game.conf.difficulty = 'normal';
                        }
                        
                        this.save();
                    } catch (e) {}
                }
                ui.refreshShop();
            }
        };

        const Rnd = (min,max) => Math.random()*(max-min)+min;
        const Dist = (e1,e2) => Math.hypot(e1.x-e2.x, e1.y-e2.y);
        function ColRect(c, r) { return c.x+c.r > r.x && c.x-c.r < r.x+r.w && c.y+c.r > r.y && c.y-c.r < r.y+r.h; }
        function resolveCollision(e1, e2) {
            let dx=e1.x-e2.x, dy=e1.y-e2.y; let dist=Math.hypot(dx,dy); const minDist=e1.r+e2.r;
            if(dist < minDist) {
                if(dist <= 0.01) { dx=1; dy=0; dist=1; }
                const o=minDist-dist, px=(dx/dist)*o*0.5, py=(dy/dist)*o*0.5;
                const m1 = (e1.type==='chest' || e1.type==='core') ? Infinity : 1;
                const m2 = (e2.type==='chest' || e2.type==='core') ? Infinity : 1;
                let r1, r2; if(m1===Infinity && m2===Infinity){r1=0;r2=0;} else if(m1===Infinity){r1=0;r2=1;} else if(m2===Infinity){r1=1;r2=0;} else {r1=0.5;r2=0.5;}
                e1.x+=px*r1; e1.y+=py*r1; e2.x-=px*r2; e2.y-=py*r2;
            }
        }
        const getGadgetName = (g) => { const map = { 'heal': 'Soin (+1000)', 'shield': 'Bouclier (+1000)', 'teleport': 'TP', 'dash': 'Dash Feu', 'speed': 'Turbo', 'knockback': 'Choc' }; return map[g] || g.toUpperCase(); }

        const el = (id) => document.getElementById(id);
        const setStyle = (id, prop, val) => { const e=el(id); if(e) e.style[prop]=val; };
        const setText = (id, txt) => { const e=el(id); if(e) e.innerText=txt; };

        function processPassReward(rewardString) {
            const [type, value] = rewardString.split(':');
            const val = parseInt(value) || 1;
            let success = false;

            if (type === 'coins') {
                USER.coins += val;
                ui.notif(`+${val} ü™ô`, "#eab308");
                success = true;
            } else if (type === 'gems') {
                USER.gems += val;
                ui.notif(`+${val} üíé`, "#a855f7");
                success = true;
            } else if (type === 'box') {
                ui.buy('box', 0, 'free');
                success = true;
            } else if (type.startsWith('emote')) {
                const emoteId = type.split(':')[1];
                if (!USER.emotes.includes(emoteId)) {
                    USER.emotes.push(emoteId);
                    ui.notif(`EMOTE D√âBLOQU√âE: ${EMOTE_LIST.find(e => e.id === emoteId)?.i}`, "#22d3ee");
                    ui.renderEmotes();
                }
                success = true;
            } else if (type.startsWith('skin')) {
                const [heroId, skinId] = type.split(':')[1].split('_');
                const fullSkinId = `${heroId}_${skinId}`;
                if (!USER.ownedSkins.includes(fullSkinId)) {
                    USER.ownedSkins.push(fullSkinId);
                    const skinName = STARTERS[heroId]?.skins.find(s => s.id === skinId)?.name || 'Skin';
                    ui.notif(`SKIN D√âBLOQU√â: ${skinName}!`, "#facc15");
                }
                success = true;
            }
            return success;
        }

        const ui = {
            hud() {
                if(!game.player) return; const p = game.player;
                setStyle('hud-hp-bar', 'width', (p.hp/p.maxHp*100)+'%');
                setText('hud-score', game.score); setText('hud-sub', MODES[game.conf.mode].name.toUpperCase());
                if(game.conf.mode !== 'survival' && game.conf.mode !== 'ranked' && game.conf.mode !== 'infection' && game.conf.mode !== 'duel') {
                    const min = Math.floor(game.timeLeft / 3600); const sec = Math.floor((game.timeLeft % 3600) / 60);
                    const te = el('hud-timer'); if(te) { te.innerText = (min < 10 ? "0"+min : min) + ":" + (sec < 10 ? "0"+sec : sec); te.classList.remove('hidden'); }
                } else { const te = el('hud-timer'); if(te) te.classList.add('hidden'); }
                for(let i=1; i<=3; i++) setStyle('ammo-'+i, 'opacity', i <= Math.floor(p.ammo) ? 1 : 0.3);
                setStyle('dash-cd', 'height', Math.max(0,p.dashT/60*100)+'%');
                setText('gadget-count', p.gadgetCharges);
                const gb=el('btn-gadget'); if(gb) { gb.disabled = p.gadgetCharges<=0; if(p.gadgetCharges<=0)gb.classList.add('opacity-50');else gb.classList.remove('opacity-50'); }
                const boss=game.ents.find(e=>e.isBoss||e.isBot||e.type==='core'); const bui=el('boss-ui');
                if(boss && bui){
                    bui.classList.remove('hidden');
                    let label = boss.isBot ? "RIVAL" : (boss.type==='chest'?"COFFRE":(boss.type==='core'?"CRISTAL":"BOSS"));
                    setText('boss-name', label);
                    setStyle('boss-bar', 'width', (boss.hp/boss.maxHp*100)+'%'); setText('boss-pct', Math.ceil(boss.hp/boss.maxHp*100)+'%');
                    const bar = el('boss-bar');
                    if(boss.type==='core') { bar.classList.remove('bg-gradient-to-r', 'from-red-600', 'to-red-500'); bar.style.backgroundColor = '#3b82f6'; }
                    else { bar.classList.add('bg-gradient-to-r', 'from-red-600', 'to-red-500'); bar.style.backgroundColor = ''; }
                } else if(bui) bui.classList.add('hidden');
                setStyle('gas-overlay', 'opacity', 0);
            },
            notif(m,c) { const d=document.createElement('div'); d.className='text-2xl font-black italic drop-shadow-2xl animate-bounce text-center px-4 py-1 bg-black/60 rounded-xl border border-white/10 backdrop-blur-sm shadow-xl'; d.style.color=c; d.innerText=m; el('notif-area').appendChild(d); setTimeout(()=>d.remove(),2000); },
            flash() { setStyle('flash-layer', 'opacity', 0.6); setTimeout(()=>setStyle('flash-layer', 'opacity', 0), 100); },
            feed(k,v,g) { const d=document.createElement('div'); d.className=`kill-msg ${g?'':'red'}`; d.innerHTML=`<span class="${g?'text-blue-400':'text-red-400'}">${k}</span> ‚ò†Ô∏è ${v}`; const c=el('kill-feed'); if(c){ c.prepend(d); if(c.children.length>4)c.lastChild.remove(); } setTimeout(()=>d.remove(),4000); },
            levelUp() { const s=el('levelup-screen'), c=el('perk-container'); c.innerHTML=''; s.classList.remove('hidden'); PERKS.sort(()=>0.5-Math.random()).slice(0,3).forEach(p=>{ const b=document.createElement('button'); b.className='glass-panel p-4 text-left flex items-center gap-4 active:scale-95 transition bg-blue-900/40 border border-blue-500/30'; b.innerHTML=`<div class="text-3xl">${p.icon}</div><div><div class="font-bold text-yellow-400 text-lg">${p.name}</div><div class="text-xs text-gray-300">${p.desc}</div></div>`; b.onclick=()=>{p.fn(game.player); s.classList.add('hidden'); game.state='PLAYING';}; c.appendChild(b); }); },
            drawMinimap() {
                const cvs = document.getElementById('minimap'); if(!cvs) return; const ctx = cvs.getContext('2d'); ctx.clearRect(0, 0, 100, 100); const scale = 100 / game.world;
                if (game.player) { ctx.fillStyle = '#3b82f6'; ctx.beginPath(); ctx.arc(game.player.x * scale, game.player.y * scale, 4, 0, Math.PI * 2); ctx.fill(); }
                (game.ents||[]).forEach(e => { if(e.hidden)return; ctx.fillStyle = (e.isBoss || e.isBot) ? '#ef4444' : (e.type==='core'?'#3b82f6':'#f87171'); const r = (e.isBoss || e.isBot || e.type==='core') ? 4 : 2; ctx.beginPath(); ctx.arc(e.x * scale, e.y * scale, r, 0, Math.PI * 2); ctx.fill(); });
                (game.map||[]).forEach(w => { if(w.type === 1) ctx.fillStyle = 'rgba(34, 197, 94, 0.8)'; else if(w.type === 3) ctx.fillStyle = '#d97706'; else ctx.fillStyle = 'rgba(255,255,255,0.4)'; ctx.fillRect(w.x * scale, w.y * scale, w.w * scale, w.h * scale); });
            },
            showTab(id) { document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden')); document.getElementById('tab-' + id).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active', 'selected')); const btn = document.getElementById('nav-' + id); if(btn) btn.classList.add('active', 'selected'); if(id === 'starters' || id === 'modes') this.renderLists(); if(id === 'infos') this.updateStats(); if(id === 'pass') this.renderPass(); if(id === 'shop') this.renderShop(); if(id === 'profile') this.renderProfile(); if(id === 'emotes') this.renderEmotes(); if(id === 'play') this.updateDifficultyButtons(); },
            
            updateDifficultyButtons() {
                if(!window.game) return; 
                document.querySelectorAll('.diff-btn').forEach(btn => btn.classList.remove('active'));
                const activeBtn = el(`diff-${game.conf.difficulty}`);
                if (activeBtn) activeBtn.classList.add('active');
            },
            refreshShop() {
                // FIX: Ensure shop items are generated if empty or timer expired
                if(!USER.shop.items || USER.shop.items.length === 0 || Date.now() > USER.shop.lastRefresh + 86400000) {
                    USER.shop.lastRefresh = Date.now();
                    USER.shop.items = [];
                    // SLOT 0: FREE
                    const freeType = ['coins','xp','gems'][Math.floor(Math.random()*3)];
                    if(freeType === 'coins') USER.shop.items.push({ type: 'coins', cost: 0, val: 100, curr: 'free', name: "Pi√®ces Gratuites" });
                    if(freeType === 'xp') USER.shop.items.push({ type: 'xp', cost: 0, val: 50, curr: 'free', name: "XP Pass Gratuit" });
                    if(freeType === 'gems') USER.shop.items.push({ type: 'gems', cost: 0, val: 5, curr: 'free', name: "Gemmes Gratuites" });

                    // SLOTS 1-3: Random
                    for(let i=0; i<3; i++) {
                        const t = ['coins','gems','box', 'xp', 'skin'][Math.floor(Math.random()*5)];
                        if(t==='coins') USER.shop.items.push({type:'coins',cost:20,val:300,curr:'gems', name: "Pack de Pi√®ces"});
                        if(t==='gems') USER.shop.items.push({type:'gems',cost:500,val:30,curr:'coins', name: "Sac de Gemmes"});
                        if(t==='box') USER.shop.items.push({type:'box',cost:80,val:1,curr:'coins', name: "Mega Caisse"});
                        if(t==='xp') USER.shop.items.push({type:'xp',cost:100,val:100,curr:'coins', name: "Boost de Pass"});
                        if(t==='skin') {
                            const keys = Object.keys(STARTERS);
                            const s = STARTERS[keys[Math.floor(Math.random()*keys.length)]];
                            if(s.skins && s.skins.length > 1) {
                                const skin = s.skins[1]; 
                                USER.shop.items.push({type:'skin',cost:skin.price,val:1,curr:'coins', name: `Skin ${skin.name}`, skinId: skin.id, hero: s.name, discount: Math.random() > 0.5 ? 30 : 0});
                            } else {
                                USER.shop.items.push({type:'coins',cost:20,val:300,curr:'gems', name: "Pack de Pi√®ces"});
                            }
                        }
                    }
                    Storage.save();
                }
            },
            renderShop() {
                // Ensure refresh is called before rendering
                this.refreshShop();
                
                const now = Date.now(); const btn = el('btn-daily');
                if(btn) { if(now - USER.lastDaily > 86400000) { btn.disabled = false; btn.innerText = "R√âCLAMER"; btn.classList.remove('opacity-50'); } else { btn.disabled = true; btn.innerText = "D√âJ√Ä RE√áU"; btn.classList.add('opacity-50'); } }
                const left = (USER.shop.lastRefresh + 86400000) - now; const hrs = Math.floor(left / 3600000); const mins = Math.floor((left % 3600000) / 60000);
                setText('shop-timer', `${hrs}h ${mins}m`);

                const c = el('shop-offers'); 
                if(!c) return;
                c.innerHTML = '';
                
                c.innerHTML += `<h3 class="col-span-1 md:col-span-2 text-xl font-bold text-yellow-400 flex items-center gap-2">üî• OFFRES FLASH üî•</h3>`;

                USER.shop.items.forEach((item, idx) => {
                    let icon = item.type==='coins'?'ü™ô':(item.type==='gems'?'üíé':(item.type==='xp'?'üé´':(item.type==='skin'?'üëï':'üì¶')));
                    let curIcon = item.curr==='coins'?'ü™ô':(item.curr==='gems'?'üíé':'üéÅ');
                    let color = item.curr==='free' ? 'free-item' : 'bg-white/5';
                    let btnClass = item.curr==='free' ? 'bg-green-600 hover:bg-green-500' : (item.curr==='gems'?'bg-purple-600 hover:bg-purple-500':'bg-yellow-600 hover:bg-yellow-500');

                    let costDisplay = `${item.cost} ${curIcon}`;
                    let discountBadge = '';

                    if(item.discount) {
                        const newCost = Math.floor(item.cost * (1 - item.discount/100));
                        costDisplay = `<span class="line-through text-gray-400 text-xs mr-2">${item.cost}</span> ${newCost} ${curIcon}`;
                        discountBadge = `<div class="absolute top-2 right-2 bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded-full animate-pulse">-${item.discount}%</div>`;
                        item.realCost = newCost;
                    } else {
                        item.realCost = item.cost;
                    }
                    if(item.curr === 'free') costDisplay = 'GRATUIT';

                    c.innerHTML += `<div class="glass-panel p-6 text-center flex flex-col items-center active:scale-95 transition border border-white/10 ${color} relative overflow-hidden">
                        ${discountBadge}
                        <div class="text-5xl mb-2">${icon}</div>
                        <div class="font-bold text-lg">${item.name}</div>
                        <div class="text-xs text-gray-400 mb-4">${item.type==='skin' ? 'Skin Rare' : `+${item.val} ${icon}`}</div>
                        <button onclick="ui.buySpecial(${idx})" class="w-full ${btnClass} py-3 rounded-xl font-bold text-sm">${costDisplay}</button>
                    </div>`;
                });
            },
            renderPass() {
                setText('pass-lvl', USER.pass.tier); setText('pass-xp-txt', `${USER.pass.xp}/100 XP`); setStyle('pass-bar', 'width', `${USER.pass.xp}%`);

                // Pass Pro Button
                const status = el('pass-pro-status');
                if(status) {
                    if(USER.mPassPro) { status.innerHTML = '<span class="text-yellow-400 font-black text-xl glow">PRO ACTIV√â</span>'; }
                    else { status.innerHTML = `<button onclick="ui.buyPassPro()" class="bg-gradient-to-r from-purple-600 to-indigo-600 px-4 py-2 rounded-lg font-bold text-xs shadow-lg hover:scale-105 transition">ACHETER PASS PRO (99 üíé)</button>`; }
                }

                const tr = el('pass-track-free');
                const trPro = el('pass-track-pro');

                if (!tr || !trPro) return;

                let freeHtml = '<div class="pass-label">GRATUIT</div>';
                let proHtml = '<div class="pass-label">PRO üëë</div>';

                for(let i=1; i<=50; i++) {
                    const freeRwdStr = getPassReward(i, false);
                    const proRwdStr = getPassReward(i, true);

                    const [rwdFType, rwdFVal] = freeRwdStr.split(':');
                    const [rwdPType, rwdPVal] = proRwdStr.split(':');

                    const getDisplay = (type, val) => {
                        let icon = 'üéÅ', text = '';
                        if(type === 'coins') { icon = 'ü™ô'; text = `+${val} Pi√®ces`; }
                        else if(type === 'gems') { icon = 'üíé'; text = `+${val} Gemmes`; }
                        else if(type === 'box') { icon = 'üì¶'; text = 'Caisse'; }
                        else if(type.startsWith('emote')) { icon = EMOTE_LIST.find(e => e.id === type.split(':')[1])?.i || 'üòÄ'; text = 'Emote'; }
                        else if(type.startsWith('skin')) { icon = 'üëï'; text = (type.includes('titan_prime')) ? 'TITAN PRIME' : 'Skin Rare'; }
                        return { icon, text };
                    };

                    const displayF = getDisplay(rwdFType, rwdFVal);
                    const displayP = getDisplay(rwdPType, rwdPVal);

                    // States
                    let claimedF = USER.pass.claimed.includes(i);
                    let claimedP = USER.pass.claimedPro.includes(i);
                    let unlocked = USER.pass.tier >= i;
                    let proLocked = !USER.mPassPro;

                    let freeState = claimedF ? 'claimed' : (unlocked ? 'active cursor-pointer' : 'locked');
                    let proState = claimedP ? 'claimed' : ((unlocked && !proLocked) ? 'active cursor-pointer pro' : 'locked pro');

                    let fnF = (unlocked && !claimedF) ? `onclick="ui.claimPass(${i}, false, '${freeRwdStr}')"` : '';
                    let fnP = (unlocked && !claimedP && !proLocked) ? `onclick="ui.claimPass(${i}, true, '${proRwdStr}')"` : (proLocked ? `onclick="ui.notif('ACH√àTE LE PASS PRO !', '#a855f7')"` : '');

                    freeHtml += `
                        <div class="pass-step ${freeState} shrink-0 mx-2" ${fnF}>
                            <div class="tier-badge">PALIER ${i}</div>
                            <div class="text-4xl mb-2">${displayF.icon}</div>
                            <div class="text-[10px] font-bold">${displayF.text}</div>
                        </div>`;

                    proHtml += `
                        <div class="pass-step ${proState} shrink-0 mx-2" ${fnP}>
                            <div class="tier-badge">PALIER ${i}</div>
                            <div class="text-4xl mb-2">${displayP.icon}</div>
                            <div class="text-[10px] font-bold">${displayP.text}</div>
                        </div>`;
                }
                tr.innerHTML = freeHtml;
                trPro.innerHTML = proHtml;
            },
            renderLists() {
                // FIX: Provide fallback if game.conf is not ready yet
                const currentMode = (window.game && window.game.conf) ? window.game.conf.mode : 'survival';
                const currentArena = (window.game && window.game.conf) ? window.game.conf.arena : 'tokyo';
                
                const sl = el('list-starters'); sl.innerHTML = '';
                Object.keys(STARTERS).forEach(k => {
                    const s = STARTERS[k], unlocked = USER.unlocked.includes(k), lvl = USER.levels[k]||1, active = USER.selected === k ? 'border-blue-500 bg-blue-900/20' : 'bg-white/5 border-white/5';
                    
                    const rarity = RARITY[s.rarity] || RARITY.common;
                    const borderColor = active.includes('border-blue-500') ? '' : `border-color: ${rarity.color}40;`;
                    const bgStyle = active.includes('bg-blue-900') ? '' : `background: linear-gradient(135deg, ${rarity.color}10, rgba(255,255,255,0.02));`;

                    sl.innerHTML += `<div onclick="ui.openHeroDetails('${k}')" style="${borderColor} ${bgStyle}" class="glass-panel p-4 cursor-pointer active:scale-95 transition ${active} ${unlocked?'':'locked'} relative group border flex flex-col items-center text-center">
                        <div class="absolute top-2 right-2 px-2 py-0.5 rounded text-[8px] font-bold uppercase tracking-wider text-white shadow-sm" style="background-color:${rarity.color}">${rarity.name}</div>
                        <div class="w-12 h-12 rounded-xl bg-black/40 flex items-center justify-center text-3xl mb-2">${s.icon}</div>
                        <div class="font-black text-sm uppercase tracking-wider" style="color:${rarity.color}">${s.name}</div>
                        <div class="text-[10px] text-gray-400 leading-tight mb-2 h-6 overflow-hidden">${s.desc}</div>
                        <div class="text-[9px] font-bold text-blue-300 mb-1">Niv. ${lvl}</div>
                    </div>`;
                });
                
                const ml = el('list-modes'); ml.innerHTML = ''; 
                Object.keys(MODES).forEach(k => { 
                    const m = MODES[k]; 
                    const specialClass = m.special ? 'season-gold' : 'bg-white/5 border-white/5'; 
                    const active = currentMode === k ? 'border-purple-500 bg-purple-900/20' : specialClass; 
                    ml.innerHTML += `<div onclick="game.setMode('${k}')" class="glass-panel p-4 cursor-pointer flex items-center gap-4 ${active} active:scale-95 transition border"><div class="text-4xl p-2 bg-black/30 rounded-full icon-box">${m.icon}</div><div class="text-left flex-1"><div class="font-black text-lg">${m.name}</div><div class="text-xs text-gray-400">${m.desc}</div></div><div class="text-2xl text-gray-600">‚ûú</div></div>`; 
                }); 
                
                const al = el('list-arenas'); al.innerHTML = ''; 
                Object.keys(ARENAS).forEach(k => { 
                    const a = ARENAS[k]; 
                    const specialClass = a.special ? 'season-gold text-yellow-100' : 'bg-white/5 border-white/5 text-gray-400'; 
                    const active = currentArena === k ? 'border-green-500 bg-green-900/20 text-white' : specialClass; 
                    al.innerHTML += `<div onclick="game.setArena('${k}')" class="glass-panel p-3 cursor-pointer text-center ${active} active:scale-95 transition border font-bold text-xs uppercase tracking-widest">${a.name}</div>`; 
                });
            },
            openHeroDetails(k) {
                const s = STARTERS[k];
                const unlocked = USER.unlocked.includes(k);
                const lvl = USER.levels[k] || 1;
                
                const rarity = RARITY[s.rarity] || RARITY.common;
                const rBadge = el('hd-rarity');
                if(rBadge) {
                    rBadge.innerText = rarity.name;
                    rBadge.style.backgroundColor = rarity.color;
                    rBadge.style.color = '#000'; 
                    rBadge.style.boxShadow = `0 0 10px ${rarity.color}`;
                }

                setText('hd-icon', s.icon); setText('hd-name', s.name); setText('hd-lvl', "NIVEAU " + lvl); setText('hd-desc', s.lore || s.desc); setText('hd-gadget-name', getGadgetName(s.gadget)); setText('hd-passive', s.passive || "Aucun");

                const skinsContainer = el('hd-skins-list');
                skinsContainer.innerHTML = '';
                if(s.skins) {
                    s.skins.forEach(skin => {
                        const isOwned = skin.id === 'default' || (USER.ownedSkins && USER.ownedSkins.includes(`${k}_${skin.id}`));
                        const isSelected = (USER.skins && USER.skins[k] === skin.id) || (skin.id === 'default' && !USER.skins[k]);
                        const style = isSelected ? 'border-yellow-400 bg-yellow-900/30' : (isOwned ? 'border-white/20 bg-white/5' : 'border-gray-700 bg-black/50 grayscale');
                        skinsContainer.innerHTML += `<div onclick="${isOwned ? `ui.equipSkin('${k}', '${skin.id}')` : `ui.buySkin('${k}', '${skin.id}', ${skin.price})`}" class="w-16 h-16 rounded-lg border-2 ${style} flex flex-col items-center justify-center cursor-pointer shrink-0"><div class="text-2xl" style="color:${skin.c}">${s.icon}</div><div class="text-[8px] font-bold mt-1">${isOwned ? (isSelected?'√âQUIP√â':'METTRE') : skin.price+'ü™ô'}</div></div>`;
                    });
                }

                setTimeout(() => { setStyle('hd-bar-hp', 'width', (s.hp/600*100) + '%'); setStyle('hd-bar-dmg', 'width', (s.dmg/150*100) + '%'); setStyle('hd-bar-spd', 'width', (s.spd/10*100) + '%'); }, 50);
                const actions = el('hd-actions');
                if(unlocked) {
                    const upgradeCost = lvl * 150;
                    if(lvl >= 10) { actions.innerHTML = `<button onclick="game.setStarter('${k}'); document.getElementById('hero-details-modal').classList.add('hidden')" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl">S√âLECTIONNER</button><button class="w-full max-level font-bold py-3 rounded-xl flex justify-center items-center gap-2 cursor-default border border-yellow-500/50 text-yellow-500 bg-yellow-900/20">NIVEAU MAX</button>`; }
                    else { actions.innerHTML = `<button onclick="game.setStarter('${k}'); document.getElementById('hero-details-modal').classList.add('hidden')" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl">S√âLECTIONNER</button><button onclick="ui.upgrade('${k}'); document.getElementById('hero-details-modal').classList.add('hidden')" class="w-full bg-green-600/80 hover:bg-green-500 text-white font-bold py-3 rounded-xl flex justify-center items-center gap-2">AM√âLIORER <span class="bg-black/20 px-2 rounded text-xs">${upgradeCost} ü™ô</span></button>`; }
                } else { 
                    actions.innerHTML = `<button onclick="ui.unlock('${k}'); document.getElementById('hero-details-modal').classList.add('hidden')" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 rounded-xl flex justify-center items-center gap-2 text-lg">ACHETER <span class="bg-black/20 px-3 py-1 rounded text-sm">${s.price} ü™ô</span></button>`; 
                }
                el('hero-details-modal').classList.remove('hidden');
            },
            equipSkin(heroId, skinId) {
                if(!USER.skins) USER.skins = {};
                USER.skins[heroId] = skinId;
                Storage.save();
                ui.openHeroDetails(heroId); // refresh
            },
            buySkin(heroId, skinId, price) {
                if(USER.coins >= price) {
                    USER.coins -= price;
                    if(!USER.ownedSkins) USER.ownedSkins = [];
                    USER.ownedSkins.push(`${heroId}_${skinId}`);
                    this.notif("SKIN D√âBLOQU√â !", "#facc15");
                    this.equipSkin(heroId, skinId);
                } else {
                    this.notif("PAS ASSEZ DE PI√àCES !", "#ef4444");
                }
            },
            renderProfile() { el('profile-name').value = USER.name; setText('profile-tag', USER.tag); setText('profile-avatar', USER.avatar); let totalLvl = Object.values(USER.levels).reduce((a,b)=>a+b, 0); setText('profile-lvl', "LVL " + totalLvl); },
            openAvatarSelector() { const grid = el('avatar-grid'); grid.innerHTML = ''; ICONS.forEach(icon => { grid.innerHTML += `<button onclick="ui.selectAvatar('${icon}')" class="w-14 h-14 text-3xl bg-white/10 hover:bg-blue-600 rounded-xl transition flex items-center justify-center border border-white/10">${icon}</button>`; }); el('avatar-selector').classList.remove('hidden'); },
            selectAvatar(icon) { USER.avatar = icon; Storage.save(); el('avatar-selector').classList.add('hidden'); this.renderProfile(); },
            renderEmotes() { const list = el('list-emotes'); list.innerHTML = ''; const equipped = el('equipped-emotes'); equipped.innerHTML = ''; USER.equippedEmotes.forEach(id => { const e = EMOTE_LIST.find(em => em.id === id); equipped.innerHTML += `<div class="w-12 h-12 bg-black/40 rounded-lg flex items-center justify-center text-2xl border border-blue-500/50">${e?.i || '‚ùì'}</div>`; }); EMOTE_LIST.forEach(e => { const unlocked = USER.emotes.includes(e.id); const selected = USER.equippedEmotes.includes(e.id); const priceTag = unlocked ? '' : `<div class="absolute bottom-1 right-1 text-[8px] font-bold bg-black/50 px-1 rounded text-purple-400">${e.price}üíé</div>`; const clickAction = unlocked ? `ui.equipEmote('${e.id}')` : `ui.buyEmote('${e.id}', ${e.price})`; list.innerHTML += `<div onclick="${clickAction}" class="emote-grid-item ${unlocked ? 'unlocked' : 'locked'} ${selected ? 'selected' : ''}">${e.i}${priceTag}</div>`; }); },
            equipEmote(id) { if(USER.equippedEmotes.includes(id)) { USER.equippedEmotes = USER.equippedEmotes.filter(e => e !== id); } else { if(USER.equippedEmotes.length < 4) USER.equippedEmotes.push(id); else ui.notif("SLOTS PLEINS !", "#ef4444"); } Storage.save(); this.renderEmotes(); },
            buyEmote(id, price) { if(USER.gems >= price) { USER.gems -= price; USER.emotes.push(id); Storage.save(); ui.notif("EMOTE D√âBLOQU√âE!", "#a855f7"); ui.renderEmotes(); ui.updateMenu(); } else { ui.notif("PAS ASSEZ DE GEMMES!", "#ef4444"); } },
            toggleEmoteWheel() { const wheel = el('emote-wheel'); if(wheel.classList.contains('hidden')) { wheel.innerHTML = ''; USER.equippedEmotes.forEach(id => { const e = EMOTE_LIST.find(em => em.id === id); wheel.innerHTML += `<div onclick="ui.triggerEmote('${e.i}'); ui.toggleEmoteWheel()" class="emote-btn">${e.i}</div>`; }); wheel.classList.remove('hidden'); } else { wheel.classList.add('hidden'); } },
            triggerEmote(emoji) { game.player.emote = emoji; game.player.emoteTimer = 120; },
            updateMenu() {
                // FIX: Ensure game exists before accessing properties to prevent crash on early load
                const confMode = (typeof game !== 'undefined' && game.conf) ? game.conf.mode : 'survival';
                const m = MODES[confMode];
                
                const s = STARTERS[USER.selected];
                setText('top-coins', USER.coins); setText('top-gems', USER.gems); setText('menu-trophies', USER.trophies);
                let rIdx = 0; for(let i=0; i<RANKS.length; i++) { if(USER.trophies >= RANKS[i].t) rIdx = i; }
                const currRank = RANKS[rIdx], nextRank = RANKS[rIdx+1];
                const re = el('menu-rank'); if(re) { re.innerText = currRank.n; re.style.backgroundImage = `linear-gradient(to right, #fff, ${currRank.c})`; }
                if(nextRank) { const diff = nextRank.t - USER.trophies, range = nextRank.t - currRank.t, done = USER.trophies - currRank.t, pct = Math.min(100, Math.max(0, (done / range) * 100)); setText('rank-progress-text', `Encore ${diff} üèÜ avant ${nextRank.n}`); setText('rank-progress-pct', Math.floor(pct) + '%'); setStyle('rank-progress-fill', 'width', pct + '%'); } else { setText('rank-progress-text', "RANG MAXIMUM !"); setText('rank-progress-pct', "100%"); setStyle('rank-progress-fill', 'width', '100%'); }
                setText('play-starter', s.name); setText('play-icon', s.icon); setText('play-lvl', "Niveau "+(USER.levels[USER.selected]||1));
                setText('play-mode', m.name); setText('play-mode-icon', m.icon);
                this.updateDifficultyButtons(); 
            },
            updateStats() { setText('stat-kills', USER.stats.kills); setText('stat-wave', USER.stats.maxWave); setText('stat-games', USER.stats.games); setText('stat-wins', USER.stats.wins); setText('stat-dmg', Math.floor(USER.stats.dmg/1000)+"k"); },
            unlock(k) { const s = STARTERS[k]; if(USER.coins >= s.price) { USER.coins -= s.price; USER.unlocked.push(k); USER.selected = k; Storage.save(); ui.notif(`D√âBLOQU√â!`, "#22c55e"); ui.renderLists(); ui.updateMenu(); } else ui.notif("PAS ASSEZ!", "#ef4444"); },
            upgrade(k) { const cost = (USER.levels[k]||1) * 150; if(USER.coins >= cost) { USER.coins -= cost; USER.levels[k]++; Storage.save(); ui.notif(`NIVEAU UP!`, "#3b82f6"); ui.renderLists(); ui.updateMenu(); } else ui.notif("PAS ASSEZ!", "#ef4444"); },
            claimDaily() { USER.coins += 200; USER.lastDaily = Date.now(); Storage.save(); ui.notif("+200 ü™ô", "#eab308"); ui.renderLists(); ui.updateMenu(); ui.renderShop(); },
            buy(t, cost, curr) { let ok = false; if(curr === 'free') ok = true; else if(curr === 'coins' && USER.coins >= cost) { USER.coins -= cost; ok = true; } else if(curr === 'gems' && USER.gems >= cost) { USER.gems -= cost; ok = true; } if(ok) { if(t==='box'){ const r=Math.random(); if(r<0.8){const c=50+Math.floor(Math.random()*100);USER.coins+=c;ui.notif(`+${c} ü™ô`,"#eab308");} else{const g=2+Math.floor(Math.random()*5);USER.gems+=g;ui.notif(`+${g} üíé`,"#a855f7");} } else if(t==='coins') { USER.coins += 300; ui.notif("+300 ü™ô","#eab308"); } else if(t==='gems') { USER.gems += 30; ui.notif("+30 üíé","#a855f7"); } Storage.save(); ui.updateMenu(); ui.renderShop(); } else ui.notif("PAS ASSEZ!", "#ef4444"); },
            buySpecial(idx) { const item = USER.shop.items[idx]; if(!item) return; let ok = false; const actualCost = item.realCost || item.cost; if(item.curr === 'free') ok = true; else if(item.curr === 'coins' && USER.coins >= actualCost) { USER.coins -= actualCost; ok = true; } else if(item.curr === 'gems' && USER.gems >= actualCost) { USER.gems -= actualCost; ok = true; } if(ok) { if(item.type==='gems') { USER.gems += item.val; ui.notif(`+${item.val} üíé`, "#a855f7"); } if(item.type==='coins') { USER.coins += item.val; ui.notif(`+${item.val} ü™ô`, "#eab308"); } if(item.type==='xp') { USER.pass.xp += item.val; ui.notif(`+${item.val} XP`, "#facc15"); while(USER.pass.xp >= 100) { if(USER.pass.tier < 50) { USER.pass.tier++; USER.pass.xp -= 100; ui.notif("PASS LEVEL UP!", "#facc15"); } else { USER.pass.xp = 100; break; } } } if(item.type==='box') { ui.buy('box', 0, 'free'); } if(item.type==='skin') { if(!USER.ownedSkins) USER.ownedSkins = []; const heroId = Object.keys(STARTERS).find(k => STARTERS[k].name === item.hero); if(heroId) { USER.ownedSkins.push(`${heroId}_${item.skinId}`); ui.notif(`SKIN ${item.name} OBTENU !`, "#facc15"); } } USER.shop.items.splice(idx, 1); Storage.save(); ui.updateMenu(); ui.renderShop(); ui.renderPass(); } else ui.notif("PAS ASSEZ!", "#ef4444"); },
            buyPassPro() { if(USER.gems >= 99) { USER.gems -= 99; USER.mPassPro = true; ui.notif("PASS PRO ACTIV√â !", "#facc15"); Storage.save(); ui.updateMenu(); ui.renderPass(); } else { ui.notif("PAS ASSEZ DE GEMMES !", "#ef4444"); } },
            claimPass(tier, isPro, rewardString) { const hasPass = isPro ? USER.mPassPro : true; const alreadyClaimed = isPro ? USER.pass.claimedPro.includes(tier) : USER.pass.claimed.includes(tier); if(USER.pass.tier >= tier && hasPass && !alreadyClaimed) { if (processPassReward(rewardString)) { if(isPro) USER.pass.claimedPro.push(tier); else USER.pass.claimed.push(tier); Storage.save(); ui.renderPass(); ui.updateMenu(); } else { ui.notif("Erreur R√©compense", "#ff0000"); } } }
        };
        window.game=game; window.ui=ui; 
        window.onload=function(){ if(game) game.init(); };
    </script>
</body></html>
