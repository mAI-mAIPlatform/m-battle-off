<!DOCTYPE html><html lang="fr"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>mBattle v1.0.0 - Saison 2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- CORE --- */
        body { margin: 0; overflow: hidden; background-color: #020617; font-family: 'Rajdhani', sans-serif; color: white; touch-action: none; user-select: none; -webkit-user-select: none; -webkit-tap-highlight-color: transparent; }
        canvas { display: block; }
        /* --- UI & GLASS --- */
        .glass-panel { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px rgba(0,0,0,0.6); border-radius: 24px; }
        .glass-nav { background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(30px); border-top: 1px solid rgba(255,255,255,0.1); }
        .glass-btn { position: relative; overflow: hidden; background: linear-gradient(180deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%); border: 1px solid rgba(255,255,255,0.15); transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1); }
        .glass-btn:active { transform: scale(0.96); filter: brightness(1.2); }
        .glass-btn.selected { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; box-shadow: 0 0 25px rgba(59, 130, 246, 0.25) inset; }
        /* SAISON 2 THEME: CYAN/PURPLE */
        .season-gold { border-color: #22d3ee !important; background: linear-gradient(145deg, rgba(34, 211, 238, 0.1), rgba(0,0,0,0.6)) !important; box-shadow: 0 0 15px rgba(34, 211, 238, 0.2) !important; animation: pulse-cyan-border 3s infinite; }
        .season-gold .icon-box { background: rgba(34, 211, 238, 0.2) !important; border: 1px solid rgba(34, 211, 238, 0.4); }
        
        .locked { opacity: 0.8; filter: grayscale(0.8); cursor: pointer; position: relative; } 
        .locked::after { content: 'üîí'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; opacity: 0.5; }
        
        .font-tech { font-family: 'Orbitron', sans-serif; letter-spacing: 1px; }
        .currency-badge { background: rgba(0,0,0,0.8); padding: 6px 14px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.15); font-family: 'Orbitron'; font-weight: 700; display: flex; align-items: center; gap: 8px; font-size: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        /* ANIMATION GAIN MONNAIE */
        @keyframes gainFlash { 0% { transform: scale(1.0); opacity: 1; filter: brightness(1); } 50% { transform: scale(1.15); opacity: 1; filter: brightness(1.5); text-shadow: 0 0 10px white; } 100% { transform: scale(1.0); opacity: 1; filter: brightness(1); } }
        .currency-badge.flash-coins { animation: gainFlash 0.3s ease-out; }
        .currency-badge.flash-gems { animation: gainFlash 0.3s ease-out; }

        /* --- NAV ICONS --- */
        .nav-item { color: #64748b; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .nav-item.active { color: #22d3ee; transform: translateY(-4px) scale(1.05); text-shadow: 0 0 15px rgba(34, 211, 238, 0.6); }
        .nav-item.active .icon { transform: scale(1.1); }
        /* --- VFX --- */
        #vignette { position: absolute; inset: 0; pointer-events: none; background: radial-gradient(circle, transparent 50%, #000 120%); z-index: 5; }
        #gas-overlay { position: absolute; inset: 0; pointer-events: none; opacity: 0; background: radial-gradient(circle, transparent 30%, rgba(34, 197, 94, 0.4) 80%); z-index: 4; transition: opacity 0.5s; }
        #flash-layer { position: absolute; inset: 0; pointer-events: none; background: #ef4444; opacity: 0; transition: opacity 0.1s; z-index: 6; mix-blend-mode: overlay; }
        /* --- CONTROLS --- */
        .joystick-zone { position: absolute; width: 140px; height: 140px; pointer-events: auto; z-index: 50; opacity: 0; transition: opacity 0.2s; }
        .joystick-zone.active { opacity: 1; }
        .stick-base { width: 130px; height: 130px; border-radius: 50%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(0,0,0,0.3) 70%); border: 2px solid rgba(255,255,255,0.1); position: absolute; bottom: 50px; pointer-events: auto; display: block !important; transition: border-color 0.2s; }
        .stick-base.active { border-color: rgba(34, 211, 238, 0.5); background: radial-gradient(circle, rgba(34, 211, 238, 0.15) 0%, rgba(0,0,0,0.4) 70%); }
        #stick-left-base { left: 40px; }
        #stick-right-base { right: 40px; }
        .stick-knob { width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.9); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 20px rgba(255,255,255,0.3); transition: transform 0.05s linear; }
        .action-btn { position: absolute; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 60; pointer-events: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.5); transition: transform 0.1s; }
        .action-btn:active { transform: scale(0.9); }
        /* --- ANIM --- */
        .kill-msg { font-size: 12px; font-weight: 800; text-shadow: 0 2px 4px black; animation: slideIn 0.3s ease-out; margin-bottom: 6px; background: linear-gradient(90deg, rgba(0,0,0,0.9) 0%, transparent 100%); padding: 6px 12px; border-left: 4px solid #3b82f6; border-radius: 0 4px 4px 0; }
        .kill-msg.red { border-color: #ef4444; }
        @keyframes slideIn { from { opacity:0; transform:translateX(-30px); } to { opacity:1; transform:translateX(0); } }
        .menu-anim { background: radial-gradient(circle at center, #0f172a 0%, #020617 100%); }
        .safe-pb { padding-bottom: max(90px, env(safe-area-inset-bottom) + 90px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        /* --- PASS --- */
        .pass-track-container { overflow-x: auto; padding: 30px 20px; scroll-behavior: smooth; position: relative; white-space: nowrap; -webkit-overflow-scrolling: touch; width: 100%; }
        .pass-wrapper { display: inline-block; min-width: 100%; position: relative; }
        .pass-row { display: flex; gap: 40px; align-items: center; margin-bottom: 40px; position: relative; padding-left: 20px; padding-right: 20px; z-index: 10; }
        .pass-step { min-width: 110px; height: 130px; background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(255,255,255,0.15); border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; z-index: 10; transition: all 0.3s; box-shadow: 0 10px 25px rgba(0,0,0,0.3); white-space: normal; text-align: center; overflow: hidden; }
        .pass-step.pro { background: linear-gradient(145deg, rgba(88, 28, 135, 0.6), rgba(15, 23, 42, 0.95)); border-color: rgba(168, 85, 247, 0.5); }
        
        /* New Claimed Style */
        .pass-step.claimed { border-color: #22c55e !important; background: rgba(20, 83, 45, 0.6) !important; transform: scale(0.95); }
        .check-mark { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 40px; color: #22c55e; text-shadow: 0 0 10px rgba(0,0,0,0.8); z-index: 20; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .pass-step.active { transform: scale(1.15); z-index: 20; border-color: white; box-shadow: 0 0 20px rgba(255,255,255,0.3); }
        /* EMOTES */
        .emote-wheel { position: absolute; bottom: 120px; right: 20px; display: flex; flex-wrap: wrap; width: 160px; gap: 10px; z-index: 70; pointer-events: auto; }
        .emote-btn { width: 60px; height: 60px; background: rgba(0,0,0,0.8); border-radius: 50%; border: 2px solid white; font-size: 24px; display: flex; align-items: center; justify-content: center; transition: transform 0.1s; cursor: pointer; }
        .emote-grid-item { aspect-ratio: 1; background: rgba(255,255,255,0.05); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 32px; border: 2px solid transparent; cursor: pointer; transition: all 0.2s; position: relative; }
        .emote-grid-item.selected { border-color: #22d3ee; background: rgba(34, 211, 238, 0.1); }
        .emote-remove-btn { position: absolute; top: -5px; right: -5px; background: #ef4444; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; border: 2px solid #0f172a; }
        
        /* MODIFIERS & DIFF BTNS */
        .diff-btn.active { background: linear-gradient(45deg, var(--tw-gradient-stops)) !important; border-color: rgba(255,255,255,0.5) !important; box-shadow: 0 0 15px var(--tw-shadow-color) !important; }
        .mod-btn.active { background: #22d3ee !important; border-color: white !important; color: white !important; box-shadow: 0 0 15px #22d3ee !important; }
        
        .rarity-badge { position: absolute; top: 4px; right: 4px; padding: 2px 6px; border-radius: 6px; font-size: 8px; font-weight: 900; text-transform: uppercase; z-index: 10; border: 1px solid rgba(255,255,255,0.2); }
        
        /* Profile Avatar Image */
        .avatar-img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head><body>
    <canvas id="gameCanvas"></canvas>
    <div id="gas-overlay"></div>
    <div id="vignette"></div>
    <div id="flash-layer"></div>
    <div id="season-particles" class="absolute inset-0 pointer-events-none overflow-hidden z-0"></div>
    <div id="ui-layer" class="absolute inset-0 pointer-events-none overflow-hidden z-10">
        <div id="hud" class="hidden w-full h-full relative">
            <div class="absolute top-4 left-4 flex flex-col gap-4 pointer-events-auto">
                <div class="glass-panel p-2 flex items-center gap-3 pr-4 scale-90 origin-top-left md:scale-100">
                    <div class="relative">
                        <div class="w-14 h-14 rounded-xl bg-gray-900 border border-white/20 flex items-center justify-center text-2xl shadow-lg overflow-hidden">
                            <span id="hud-icon" class="z-10 relative">ü§ñ</span>
                            <div class="absolute inset-0 bg-gradient-to-br from-blue-600/40 to-transparent"></div>
                        </div>
                        <div class="absolute -bottom-2 -right-1 bg-black border border-gray-600 text-[9px] px-1.5 py-0.5 rounded text-yellow-400 font-bold" id="hud-lvl">LVL 1</div>
                    </div>
                    <!-- FIX 1: R√©activit√© de la barre de sant√© (duration-200 -> duration-75) -->
                    <div class="flex flex-col w-28 gap-1">
                        <!-- ENLEV√â transition-all duration-75 -->
                        <div class="h-2.5 bg-gray-800 rounded-full overflow-hidden border border-gray-600 relative"><div id="hud-hp-bar" class="h-full bg-green-500" style="width: 100%;"></div></div>
                        <div class="flex gap-1 h-1 mt-0.5">
                            <div id="ammo-1" class="flex-1 bg-orange-500 rounded-full opacity-50 transition"></div>
                            <div id="ammo-2" class="flex-1 bg-orange-500 rounded-full opacity-50 transition"></div>
                            <div id="ammo-3" class="flex-1 bg-orange-500 rounded-full opacity-50 transition"></div>
                        </div>
                    </div>
                </div>
                <div class="glass-panel p-1 border-white/20 bg-black/50"><canvas id="minimap" width="100" height="100" class="rounded-lg bg-black/80 opacity-90"></canvas></div>
            </div>
            <div class="absolute top-6 left-1/2 -translate-x-1/2 text-center pointer-events-auto">
                <div id="hud-score" class="font-tech text-5xl font-bold text-white leading-none drop-shadow-[0_0_15px_rgba(255,255,255,0.4)]">0</div>
                <div class="text-[10px] font-bold text-blue-400 bg-black/50 px-2 rounded mt-1" id="hud-sub">VAGUE 1</div>
                <div id="hud-timer" class="text-xl font-black text-yellow-400 drop-shadow-lg mt-1 hidden">03:00</div>
                <div id="hud-objective" class="text-xs font-bold text-yellow-300 mt-1 hidden">Objectif</div>
            </div>
            <div class="absolute top-4 right-4 flex flex-col gap-4 pointer-events-auto items-end">
                <button onclick="window.game.togglePause()" class="glass-panel w-10 h-10 flex items-center justify-center hover:bg-white/10 text-lg transition active:scale-90">‚è∏</button>
            </div>
            <div id="boss-ui" class="hidden absolute top-24 left-1/2 -translate-x-1/2 w-3/4 max-w-lg pointer-events-auto transition-all duration-500">
                <div class="flex justify-between text-[10px] text-red-400 font-bold mb-1 uppercase tracking-widest"><span id="boss-name">BOSS</span><span id="boss-pct">100%</span></div>
                <div class="h-4 bg-red-950/80 border border-red-500/50 rounded-full overflow-hidden shadow-[0_0_20px_rgba(220,38,38,0.4)]"><div id="boss-bar" class="h-full bg-gradient-to-r from-red-600 to-red-500 w-full transition-all duration-200"></div></div>
            </div>
            <div id="kill-feed" class="absolute top-32 left-4 flex flex-col gap-2 w-48 pointer-events-none"></div>
            <div id="notif-area" class="absolute top-48 left-1/2 -translate-x-1/2 pointer-events-none flex flex-col items-center gap-2 w-full z-30"></div>
            <button id="btn-emote" class="absolute top-32 right-4 w-10 h-10 rounded-full glass-panel flex items-center justify-center text-xl pointer-events-auto active:scale-90 transition z-50" onmousedown="window.ui.toggleEmoteWheel()" ontouchstart="event.stopPropagation(); window.ui.toggleEmoteWheel()">üòÄ</button>
            <div id="emote-wheel" class="emote-wheel hidden"></div>
            <div id="mobile-controls" class="hidden absolute inset-0 z-40">
                <div id="stick-left-base" class="stick-base" style="left: 40px; bottom: 40px;"><div class="stick-knob"></div></div>
                <div id="stick-right-base" class="stick-base" style="right: 40px; bottom: 40px;"><div class="stick-knob"></div></div>
                <button id="btn-gadget" class="action-btn bottom-36 right-12 w-16 h-16 bg-green-900/90 border-2 border-green-500 active:scale-90 flex items-center justify-center pointer-events-auto transition shadow-lg" ontouchstart="event.stopPropagation(); window.game.player?.useGadget()" onmousedown="window.game.player?.useGadget()"><span class="font-tech font-bold text-[10px] z-10">GADGET</span><div class="absolute -top-1 -right-1 bg-black border border-white text-[9px] w-5 h-5 rounded-full flex items-center justify-center" id="gadget-count">3</div></button>
                <button id="btn-dash" class="action-btn bottom-12 right-36 w-20 h-20 rounded-full glass-panel border border-white/40 active:scale-90 flex items-center justify-center pointer-events-auto transition shadow-lg bg-blue-900/30" ontouchstart="event.stopPropagation(); window.game.player?.dash()" onmousedown="window.game.player?.dash()"><span class="text-3xl">‚ö°</span><div id="dash-cd" class="absolute inset-0 bg-black/70 origin-bottom h-0 transition-all duration-75 rounded-full"></div></button>
            </div>
        </div>
        
        <div id="menu-screen" class="absolute inset-0 menu-anim pointer-events-auto z-50 flex flex-col">
            <div class="w-full h-16 flex items-center justify-between px-5 pt-safe z-30 bg-gradient-to-b from-black/80 to-transparent">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-cyan-500/20 border border-cyan-400/30 flex items-center justify-center text-xl text-cyan-400">üåÄ</div>
                    <div><div class="font-tech font-bold leading-none text-lg">mBATTLE</div><div class="text-[10px] text-cyan-400 font-bold tracking-widest">v1.0.0.8.6</div></div>
                </div>
                <div class="flex gap-3">
                    <div class="currency-badge"><span class="text-yellow-400">ü™ô</span> <span id="top-coins">0</span></div>
                    <div class="currency-badge"><span class="text-purple-400">üíé</span> <span id="top-gems">0</span></div>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto safe-pb p-5 hide-scrollbar relative">
                <div id="tab-play" class="tab-content flex flex-col items-center justify-center min-h-[65vh] gap-6 animate-fadeIn">
                    <div class="w-full max-w-md glass-panel p-5 border-l-4 border-cyan-500 bg-cyan-900/10 relative overflow-hidden">
                        <div class="flex items-center justify-between mb-2 relative z-10">
                            <div><div class="text-[10px] text-gray-400 uppercase font-bold">Rang Actuel</div><div class="text-2xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-cyan-200 to-cyan-500 font-tech" id="menu-rank">BRONZE I</div></div>
                            <div class="text-center"><div class="text-2xl">üèÜ</div><div class="font-bold text-white text-xl" id="menu-trophies">0</div></div>
                        </div>
                        <div class="flex justify-between text-[10px] font-bold text-gray-300 mt-1 relative z-10">
                            <span id="rank-progress-text">Encore 100 üèÜ avant BRONZE II</span><span id="rank-progress-pct">0%</span>
                        </div>
                        <div class="rank-progress-bg relative z-10"><div id="rank-progress-fill" class="rank-progress-fill bg-cyan-500"></div></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 w-full max-w-md">
                        <div onclick="window.ui.showTab('starters')" class="glass-panel p-4 flex flex-col items-center justify-center aspect-square active:scale-95 transition bg-blue-900/10 border-blue-500/30">
                            <div class="text-[10px] text-blue-300 font-bold mb-2 uppercase">H√©ros</div><div class="text-5xl mb-2 drop-shadow-xl" id="play-icon">üéØ</div><div class="font-black text-lg leading-none" id="play-starter">Soldier</div>
                        </div>
                        <div onclick="window.ui.showTab('modes')" class="glass-panel p-4 flex flex-col items-center justify-center aspect-square active:scale-95 transition bg-purple-900/10 border-purple-500/30">
                            <div class="text-[10px] text-purple-300 font-bold mb-2 uppercase">Mission</div><div class="text-5xl mb-2 drop-shadow-xl" id="play-mode-icon">üî•</div><div class="font-black text-lg leading-none" id="play-mode">Survie</div>
                        </div>
                    </div>
                    <div class="w-full max-w-md glass-panel p-4 flex flex-col items-center mt-4">
                        <div class="text-[10px] text-yellow-300 font-bold mb-3 uppercase tracking-widest">DIFFICULT√â</div>
                        <div class="flex gap-3 w-full">
                            <button id="diff-easy" onclick="window.game.setDifficulty('easy')" style="--tw-shadow-color:#22c55e;" class="diff-btn flex-1 glass-btn py-3 rounded-xl font-bold text-sm bg-gradient-to-r from-green-600/30 to-green-900/30 border-green-600/50 text-green-400 active:scale-95 transition">Facile</button>
                            <button id="diff-normal" onclick="window.game.setDifficulty('normal')" style="--tw-shadow-color:#3b82f6;" class="diff-btn flex-1 glass-btn py-3 rounded-xl font-bold text-sm bg-gradient-to-r from-blue-600/30 to-blue-900/30 border-blue-600/50 text-blue-400 active:scale-95 transition">Normal</button>
                            <button id="diff-hard" onclick="window.game.setDifficulty('hard')" style="--tw-shadow-color:#ef4444;" class="diff-btn flex-1 glass-btn py-3 rounded-xl font-bold text-sm bg-gradient-to-r from-red-600/30 to-red-900/30 border-red-600/50 text-red-400 active:scale-95 transition">Difficile</button>
                        </div>
                        <div class="text-[10px] text-purple-300 font-bold mb-2 uppercase tracking-widest mt-4">MODIFICATEURS</div>
                        <div class="grid grid-cols-3 gap-2 w-full">
                            <button onclick="window.game.setModifier('normal')" id="mod-normal" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-gray-300">Classique</button>
                            <button onclick="window.game.setModifier('oneshot')" id="mod-oneshot" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-red-400">‚ò†Ô∏è One Shot</button>
                            <button onclick="window.game.setModifier('poison')" id="mod-poison" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-green-400">üß™ Poison</button>
                            <button onclick="window.game.setModifier('speed')" id="mod-speed" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-yellow-400">‚ö° Speed</button>
                            <button onclick="window.game.setModifier('vampire')" id="mod-vampire" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-pink-500">üßõ Vampire</button>
                            <button onclick="window.game.setModifier('infinite')" id="mod-infinite" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-blue-400">‚ôæÔ∏è Infini</button>
                            <button onclick="window.game.setModifier('explosive')" id="mod-explosive" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-orange-500">üí• Explosif</button>
                            <button onclick="window.game.setModifier('recoil')" id="mod-recoil" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-white">üîô Recul</button>
                            <button onclick="window.game.setModifier('giant')" id="mod-giant" class="mod-btn glass-btn py-2 rounded-lg font-bold text-[10px] text-purple-600">üêò G√©ant</button>
                        </div>
                    </div>
                    <button onclick="window.game.start()" class="w-full max-w-md bg-gradient-to-r from-blue-600 to-indigo-600 h-20 rounded-2xl shadow-[0_0_40px_rgba(37,99,235,0.4)] flex items-center justify-center gap-4 active:scale-95 transition transform hover:-translate-y-1 mt-4 border border-white/20">
                        <span class="text-3xl font-black italic tracking-tighter">JOUER</span><span class="text-2xl animate-pulse">üöÄ</span>
                    </button>
                </div>
                <div id="tab-pass" class="tab-content hidden animate-fadeIn w-full max-w-5xl mx-auto pb-20">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-3xl font-black flex items-center gap-2 font-tech"><span class="text-cyan-400">///</span> mPASS</h2>
                        <!-- TITRE S2 ANIM√â -->
                        <div class="text-right text-xl md:text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400 animate-pulse font-tech tracking-widest drop-shadow-[0_0_10px_rgba(34,211,238,0.5)]">SAISON 2: TEMP√äTE CYBER</div>
                    </div>
                    <div class="glass-panel p-6 mb-6 bg-gradient-to-r from-cyan-900/20 to-transparent border-cyan-500/30">
                        <div class="flex justify-between items-center mb-4">
                             <div><div class="text-2xl font-black text-white">Palier <span id="pass-lvl">1</span></div><div class="text-xs text-gray-400" id="pass-xp-txt">0/100 XP</div></div>
                             <!-- Mise √† jour du prix du Pass Pro -->
                             <div id="pass-pro-status"></div>
                        </div>
                        <div class="h-4 bg-black/50 rounded-full overflow-hidden"><div id="pass-bar" class="h-full bg-gradient-to-r from-cyan-500 to-purple-500 w-0 transition-all duration-300"></div></div>
                    </div>
                    <!-- Le conteneur pass-track-container est d√©filable -->
                    <div class="pass-track-container hide-scrollbar" id="pass-scroll-container">
                        <div class="pass-wrapper">
                             <div class="pass-track-line"></div>
                             <div class="pass-row" id="pass-track-free"><div class="pass-label">GRATUIT</div></div>
                             <div class="pass-row pro" id="pass-track-pro"><div class="pass-label">PRO üëë</div></div>
                        </div>
                    </div>
                </div>
                <div id="tab-starters" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto"><h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-blue-500">///</span> ARMURERIE</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-10" id="list-starters"></div></div>
                <div id="tab-modes" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto"><h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-purple-500">///</span> MISSIONS</h2><div class="grid grid-cols-1 gap-3 mb-8" id="list-modes"></div><h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-gray-400">TERRAINS</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-3" id="list-arenas"></div></div>
                <div id="tab-emotes" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto pb-20"><h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-pink-500">///</span> COLLECTION</h2><div class="glass-panel p-6 mb-4"><div class="text-xs text-gray-400 mb-4 uppercase font-bold">Emotes √âquip√©es (Max 8)</div><div class="flex justify-center gap-4 mb-2 flex-wrap" id="equipped-emotes"></div></div><div class="grid grid-cols-4 md:grid-cols-6 gap-3" id="list-emotes"></div></div>
                <div id="tab-shop" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto pb-20">
                    <h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-yellow-500">///</span> MEGA MALL</h2>
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-xs text-gray-400">Nouveaux items: <span id="shop-timer" class="text-yellow-400 font-mono">--:--</span></div>
                        <button onclick="window.ui.refreshShop(true)" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-1 px-3 rounded-lg text-xs shadow-lg flex items-center gap-1 active:scale-95 transition">üîÑ 10üíé</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="shop-offers"></div>
                </div>
                <div id="tab-infos" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto pb-20">
                    <h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-gray-500">///</span> INFOS</h2>
                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">‚ò†Ô∏è</div><div class="text-[10px] text-gray-500 uppercase font-bold">Kills</div><div class="text-2xl font-bold" id="stat-kills">0</div></div>
                        <div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">üåä</div><div class="text-[10px] text-gray-500 uppercase font-bold">Max Vague</div><div class="text-2xl font-bold" id="stat-wave">0</div></div>
                        <div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">üéÆ</div><div class="text-[10px] text-gray-500 uppercase font-bold">Parties</div><div class="text-2xl font-bold" id="stat-games">0</div></div>
                        <div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">‚öîÔ∏è</div><div class="text-[10px] text-gray-500 uppercase font-bold">Victoires</div><div class="text-2xl font-bold" id="stat-wins">0</div></div>
                        <div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">üíÄ</div><div class="text-[10px] text-gray-500 uppercase font-bold">D√©faites</div><div class="text-2xl font-bold" id="stat-losses">0</div></div>
                        <div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">ü¶∏</div><div class="text-[10px] text-gray-500 uppercase font-bold">H√©ros D√©bloqu√©s</div><div class="text-2xl font-bold" id="stat-unlocked">0/20</div></div>
                        <div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">üí•</div><div class="text-[10px] text-gray-500 uppercase font-bold">D√©g√¢ts Totaux</div><div class="text-2xl font-bold" id="stat-dmg">0</div></div>
                        <div class="glass-panel p-4 flex flex-col items-center justify-center py-6"><div class="text-3xl mb-2">üé´</div><div class="text-[10px] text-gray-500 uppercase font-bold">Palier Pass Max</div><div class="text-2xl font-bold" id="stat-pass-tier">1</div></div>
                    </div>
                    
                    <h3 class="text-xl font-bold mb-4 text-blue-400">COMPARATIF mPASS</h3>
                    <div class="glass-panel p-4 mb-8 overflow-hidden">
                        <table class="w-full text-sm text-left text-gray-300">
                            <tr class="border-b border-gray-700 text-xs text-gray-500 uppercase">
                                <th class="py-2 pl-2">R√©compense</th>
                                <th class="py-2 text-center text-gray-400">Gratuit</th>
                                <th class="py-2 text-center text-yellow-400">PRO (Total)</th>
                            </tr>
                            <tr class="border-b border-gray-700/50">
                                <td class="py-3 pl-2 font-bold">Skins Rares</td>
                                <td class="text-center">0</td>
                                <td class="text-center text-green-400">0</td>
                            </tr>
                            <tr class="border-b border-gray-700/50">
                                <td class="py-3 pl-2 font-bold">Emotes Exclusives</td>
                                <td class="text-center">1</td>
                                <td class="text-center text-green-400">3</td>
                            </tr>
                            <tr class="border-b border-gray-700/50">
                                <td class="py-3 pl-2 font-bold">Gemmes üíé</td>
                                <td class="text-center">42</td>
                                <td class="text-center text-green-400">302</td>
                            </tr>
                            <tr class="border-b border-gray-700/50">
                                <td class="py-3 pl-2 font-bold">Pi√®ces ü™ô</td>
                                <td class="text-center">1190</td>
                                <td class="text-center text-green-400">4490</td>
                            </tr>
                            <tr>
                                <td class="py-3 pl-2 font-bold">Mega Caisses üì¶</td>
                                <td class="text-center">4</td>
                                <td class="text-center text-green-400">8</td>
                            </tr>
                        </table>
                    </div>

                    <h3 class="text-xl font-bold mb-4 text-blue-400">GUIDE DU JEU</h3>
                    
                    <div class="mb-6">
                        <h4 class="text-sm font-bold text-purple-400 mb-2 uppercase tracking-widest border-b border-purple-500/30 pb-1">MISSIONS</h4>
                        <div class="grid gap-2 text-xs text-gray-300">
                            <div class="flex gap-2"><span class="text-xl">üßü</span> <div><b class="text-white">Survie :</b> Vagues infinies d'ennemis. Le classique.</div></div>
                            <div class="flex gap-2"><span class="text-xl">üèÜ</span> <div><b class="text-white">Class√© :</b> Plus dur, plus de points. Pour les pros.</div></div>
                            <div class="flex gap-2"><span class="text-xl">‚öîÔ∏è</span> <div><b class="text-white">Duel 1v1 :</b> Toi contre un Bot √©nerv√©.</div></div>
                            <div class="flex gap-2"><span class="text-xl">üíé</span> <div><b class="text-white">Braquage :</b> D√©truis le coffre au centre en moins de 3 min.</div></div>
                            <div class="flex gap-2"><span class="text-xl">üëπ</span> <div><b class="text-white">Boss Rush :</b> 3 Boss d'affil√©e. Pas de piti√©.</div></div>
                            <div class="flex gap-2"><span class="text-xl">üåã</span> <div><b class="text-white">Raid Titan :</b> 5 Boss en m√™me temps. Suicide ? Peut-√™tre.</div></div>
                            <div class="flex gap-2"><span class="text-xl">üõ°Ô∏è</span> <div><b class="text-white">D√©fense :</b> Prot√®ge le cristal bleu au centre.</div></div>
                            <div class="flex gap-2"><span class="text-xl">üöÇ</span> <div><b class="text-white">Train Express :</b> Le train bouge ! Prot√®ge-le des robots.</div></div>
                            <div class="flex gap-2"><span class="text-xl">üí∞</span> <div><b class="text-white">Voleur :</b> Infiltre et vole 10 sacs d'or sans mourir.</div></div>
                            <div class="flex gap-2"><span class="text-xl">üåÄ</span> <div><b class="text-white">Cyber Hack :</b> Pirate les zones (reste dedans) pour gagner.</div></div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h4 class="text-sm font-bold text-green-400 mb-2 uppercase tracking-widest border-b border-green-500/30 pb-1">TERRAINS</h4>
                        <div class="grid grid-cols-2 gap-2 text-xs text-gray-300">
                            <div><b class="text-white">Neon Tokyo :</b> Ville sombre, n√©ons bleus.</div>
                            <div><b class="text-white">Sandstorm :</b> D√©sert, visibilit√© r√©duite.</div>
                            <div><b class="text-white">Ice Age :</b> Glace et froid polaire.</div>
                            <div><b class="text-white">Jungle :</b> V√©g√©tation dense et verte.</div>
                            <div><b class="text-white">Magma :</b> Volcan actif, sol rouge.</div>
                            <div><b class="text-white">Ruines :</b> Vestiges de pierre grise.</div>
                            <div><b class="text-white">Cyber City :</b> M√©tropole futuriste cyan.</div>
                            <div><b class="text-white">N√©buleuse :</b> Espace, gravit√© flottante.</div>
                            <div><b class="text-white">Mainframe :</b> Matrice num√©rique verte.</div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h4 class="text-sm font-bold text-yellow-400 mb-2 uppercase tracking-widest border-b border-yellow-500/30 pb-1">MODIFICATEURS</h4>
                        <div class="grid gap-2 text-xs text-gray-300">
                            <div><b class="text-white">‚ò†Ô∏è One Shot :</b> Tout le monde a 1 PV. Une balle = mort.</div>
                            <div><b class="text-white">üß™ Poison :</b> D√©g√¢ts sur la dur√©e pour tous les tirs.</div>
                            <div><b class="text-white">‚ö° Speed :</b> Tout le monde (toi + ennemis) est ultra rapide.</div>
                            <div><b class="text-white">üßõ Vampire :</b> Tu voles de la vie en tirant.</div>
                            <div><b class="text-white">‚ôæÔ∏è Infini :</b> Munitions illimit√©es.</div>
                            <div><b class="text-white">üí• Explosif :</b> Les ennemis explosent √† leur mort.</div>
                            <div><b class="text-white">üîô Recul :</b> Tirer te propulse en arri√®re.</div>
                            <div><b class="text-white">üêò G√©ant :</b> Tout le monde est g√©ant (x2 taille).</div>
                        </div>
                    </div>

                    <div class="glass-panel p-6 mb-6 hidden md:block"><h3 class="text-xl font-bold text-blue-400 mb-4">COMMANDES PC</h3><table class="w-full text-sm text-left text-gray-300"><tr class="border-b border-gray-700"><th class="py-2">Action</th><th class="py-2">Touche</th></tr><tr><td class="py-2">D√©placement</td><td class="font-mono text-yellow-400">Z Q S D</td></tr><tr><td class="py-2">Viser</td><td class="font-mono text-yellow-400">Souris</td></tr><tr><td class="py-2">Tirer</td><td class="font-mono text-yellow-400">Clic Gauche</td></tr><tr><td class="py-2">Dash</td><td class="font-mono text-yellow-400">Espace</td></tr><tr><td class="py-2">Gadget</td><td class="font-mono text-yellow-400">E</td></tr><tr><td class="py-2">Emote</td><td class="font-mono text-yellow-400">V</td></tr></table></div>
                    
                    <h3 class="text-xl font-bold mb-4 text-blue-400">PATCH NOTES</h3>
                    <div class="glass-panel p-6 text-sm text-gray-300"><div class="patch-note"><h3>v1.0.0 (Saison 2)</h3><ul><li>2Ô∏è‚É£ Ajout du contenu de saison 2</li><li>üö´ Correction de bugs majeurs principalement.</li><li>üëï Nouveaux Skins : Ajout de skins pour Drone, Harpy, Shaman et Reaper.</li><li> üëï Nouveaux h√©ros : ajout pour 30 au total</li><li>‚è≥ Am√©liorations divers (profil, shop...)</li><li>ü¶æ PV Bots : Augmentation des PV de base des bots (+20 PV) et am√©lioration de l'intelligence des bots.</li></ul></div></div>
                </div>
                <div id="tab-profile" class="tab-content hidden animate-fadeIn w-full max-w-3xl mx-auto pb-20">
                    <h2 class="text-2xl font-black mb-4 flex items-center gap-2 font-tech"><span class="text-white">///</span> COMPTE</h2>
                    <div class="glass-panel p-6 mb-6 flex items-center gap-6 bg-blue-900/10 border-blue-500/30">
                        <div class="relative group cursor-pointer" onclick="window.ui.openAvatarSelector()">
                            <div class="w-20 h-20 rounded-full bg-gray-800 border-2 border-white/20 flex items-center justify-center text-4xl shadow-lg overflow-hidden hover:border-blue-500 transition" id="profile-avatar">üë§</div>
                            <div class="absolute bottom-0 right-0 bg-blue-600 border border-white text-[10px] p-1 rounded-full text-white shadow-sm">‚úèÔ∏è</div>
                        </div>
                        <div class="flex-1">
                            <div class="text-xs text-gray-400 font-bold uppercase mb-1">Pseudonyme</div>
                            <input type="text" id="profile-name" class="bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-white font-bold w-full mb-2 focus:outline-none focus:border-blue-500 transition" onchange="USER.name = this.value; Storage.save();" value="Player">
                            <div class="flex justify-between items-center">
                                <div class="text-xs text-blue-400 font-tech tracking-widest" id="profile-tag">#TAG</div>
                                <div class="bg-black border border-gray-600 text-[9px] px-2 rounded text-yellow-400 font-bold" id="profile-lvl">LVL 1</div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="glass-panel p-6">
                            <div class="font-bold text-lg mb-2 flex items-center gap-2">üíæ Sauvegarde</div>
                            <div class="text-xs text-gray-400 mb-4">Copie ce code pour transf√©rer ton compte.</div>
                            <button onclick="window.ui.exportSave()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition text-sm">COPIER MA SAUVEGARDE üìã</button>
                        </div>
                        <div class="glass-panel p-6">
                            <div class="font-bold text-lg mb-2 flex items-center gap-2">üì• Importer</div>
                            <div class="text-xs text-gray-400 mb-4">Colle un code de sauvegarde ici.</div>
                            <button onclick="window.ui.importSave()" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-xl transition text-sm">IMPORTER SAUVEGARDE üîÑ</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="w-full glass-nav h-[90px] pb-safe flex justify-around items-center px-2 z-40 relative overflow-x-auto hide-scrollbar">
                <button onclick="window.ui.showTab('play')" id="nav-play" class="nav-item flex flex-col items-center p-2 min-w-[60px] active selected"><span class="text-2xl icon mb-1">‚öîÔ∏è</span><span class="text-[9px] font-bold">JOUER</span></button>
                <button onclick="window.ui.showTab('starters')" id="nav-starters" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">ü¶∏</span><span class="text-[9px] font-bold">H√âROS</span></button>
                <button onclick="window.ui.showTab('pass')" id="nav-pass" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">üé´</span><span class="text-[9px] font-bold">PASS</span></button>
                <button onclick="window.ui.showTab('emotes')" id="nav-emotes" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">üòÄ</span><span class="text-[9px] font-bold">EMOTES</span></button>
                <button onclick="window.ui.showTab('shop')" id="nav-shop" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">üõí</span><span class="text-[9px] font-bold">SHOP</span></button>
                <button onclick="window.ui.showTab('infos')" id="nav-infos" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">‚ÑπÔ∏è</span><span class="text-[9px] font-bold">INFOS</span></button>
                <button onclick="window.ui.showTab('profile')" id="nav-profile" class="nav-item flex flex-col items-center p-2 min-w-[60px]"><span class="text-2xl icon mb-1">üë§</span><span class="text-[9px] font-bold">PROFIL</span></button>
            </div>
        </div>

        <!-- SETTINGS MODAL -->
        <div id="settings-modal" class="hidden absolute inset-0 bg-black/95 backdrop-blur-xl flex items-center justify-center z-[60] pointer-events-auto animate-fadeIn" onclick="window.ui.closeSettings()">
             <div class="glass-panel p-6 max-w-sm w-full mx-4 flex flex-col gap-4 max-h-[80vh] overflow-y-auto hide-scrollbar" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center border-b border-white/10 pb-4"><h3 class="text-xl font-black">PARAM√àTRES ‚öôÔ∏è</h3><button onclick="window.ui.closeSettings()" class="text-2xl text-gray-400 hover:text-white">√ó</button></div>
                <div class="settings-grp"><label class="settings-label">Pseudonyme</label><input type="text" id="setting-name" class="profile-input" onchange="USER.name = this.value; Storage.save(); window.ui.renderProfile()"></div>
                <div class="settings-grp"><label class="settings-label">Avatar</label><button onclick="window.ui.openAvatarSelector()" class="w-full bg-white/10 hover:bg-white/20 border border-white/20 py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2">CHANGER D'AVATAR üë§</button></div>
                <div class="settings-grp"><label class="settings-label">Email</label><input type="email" id="setting-email" placeholder="email@exemple.com" class="profile-input" onchange="USER.email = this.value; Storage.save();"></div>
                <div class="settings-grp"><label class="settings-label">T√©l√©phone</label><input type="tel" id="setting-phone" placeholder="+33 6..." class="profile-input" onchange="USER.phone = this.value; Storage.save();"></div>
                <div class="settings-grp"><label class="settings-label">Date de Naissance</label><input type="date" id="setting-dob" class="profile-input" onchange="USER.dob = this.value; Storage.save();"></div>
                <div class="settings-grp"><label class="settings-label">Bio</label><textarea id="setting-bio" placeholder="Ta description..." class="profile-input resize-none h-20" onchange="USER.bio = this.value; Storage.save(); window.ui.renderProfile()"></textarea></div>
                <div class="settings-grp pt-2 border-t border-white/10 mt-2"><div class="flex justify-between items-center mb-2"><label class="settings-label text-yellow-400">Th√®me du Profil <span class="bg-yellow-500 text-black px-1 rounded text-[8px]">PRO</span></label><div id="theme-lock-icon" class="text-[10px] text-gray-500"></div></div><div class="flex gap-2 overflow-x-auto hide-scrollbar p-1" id="profile-theme-selector"></div></div>
                <button onclick="window.ui.closeSettings()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl mt-2">ENREGISTRER</button>
                <div class="mt-4 pt-4 border-t border-white/10 text-center"><p class="text-[10px] text-gray-500 leading-relaxed">mBattle est un jeu vid√©o gratuit con√ßu par Mathias Tusseau. Les bots sont pilot√©s par mAI.<br>Si vous rencontrez un probl√®me, rendez vous sur : <a href="https://forms.gle/1PVVdcSi3mYyq3XeA" target="_blank" class="text-blue-400 hover:underline">Support</a></p><div class="text-[8px] text-gray-600 mt-1">v0.9.9</div></div>
             </div>
        </div>

        <!-- HERO DETAILS MODAL -->
        <div id="hero-details-modal" class="hidden absolute inset-0 bg-black/95 backdrop-blur-xl flex items-center justify-center z-[60] pointer-events-auto animate-fadeIn" onclick="this.classList.add('hidden')">
            <div class="glass-panel p-6 max-w-md w-full mx-4 relative border-2 border-blue-500/30" onclick="event.stopPropagation()" id="hero-card-inner">
                <button onclick="document.getElementById('hero-details-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl z-10">√ó</button>
                <div class="flex flex-col items-center mb-6"><div class="w-24 h-24 rounded-2xl bg-black/50 border-2 border-white/20 flex items-center justify-center text-6xl shadow-[0_0_30px_rgba(59,130,246,0.3)] mb-3" id="hd-icon"></div><h2 class="text-3xl font-black uppercase font-tech tracking-wider" id="hd-name"></h2><div id="hd-rarity" class="mb-1 text-xs font-bold uppercase tracking-widest px-3 py-1 rounded bg-gray-800">COMMUN</div><div class="text-blue-400 font-bold text-sm" id="hd-lvl"></div></div>
                <!-- REMPLAC√â PAR hero-stats-container pour les d√©tails par niveau -->
                <div id="hero-stats-container" class="space-y-4 mb-6"></div>
                <!-- FIN REMPLAC√â -->
                <div class="mb-4" id="hd-skins-container"><div class="text-[10px] text-gray-400 uppercase font-bold mb-2">SKINS</div><div class="flex gap-2 overflow-x-auto hide-scrollbar" id="hd-skins-list"></div></div>
                <div class="bg-white/5 p-4 rounded-xl border border-white/10 mb-4"><div class="flex justify-between"><div><div class="text-[10px] text-gray-400 uppercase font-bold mb-1">GADGET</div><div class="text-sm font-bold text-white flex items-center gap-2"><span id="hd-gadget-icon">‚ö°</span> <span id="hd-gadget-name"></span></div></div><div><div class="text-[10px] text-gray-400 uppercase font-bold mb-1 text-right">PASSIF</div><div class="text-sm font-bold text-yellow-400 text-right" id="hd-passive"></div></div></div></div>
                <p class="text-xs text-gray-400 italic text-center mb-6 leading-relaxed whitespace-pre-line" id="hd-desc"></p>
                <div id="hd-actions" class="grid gap-2"></div>
            </div>
        </div>
        <!-- AVATAR SELECTOR WITH UPLOAD -->
        <div id="avatar-selector" class="hidden absolute inset-0 bg-black/90 backdrop-blur-xl flex items-center justify-center z-[60] pointer-events-auto animate-fadeIn" onclick="this.classList.add('hidden')">
            <div class="glass-panel p-6 max-w-sm w-full mx-4 flex flex-col gap-4" onclick="event.stopPropagation()">
                <h3 class="text-xl font-black text-center">CHOISIS TON AVATAR</h3>
                <div class="grid grid-cols-5 gap-2 mb-2 overflow-y-auto max-h-64 hide-scrollbar" id="avatar-grid"></div>
                <div class="border-t border-white/10 pt-4">
                    <input type="file" id="upload-avatar" hidden accept="image/*" onchange="window.ui.uploadAvatar(this)">
                    <button onclick="document.getElementById('upload-avatar').click()" class="w-full bg-blue-600/50 hover:bg-blue-500 border border-blue-500/50 py-3 rounded-xl font-bold text-sm mb-2">IMPORTER IMAGE üì∏</button>
                    <button onclick="document.getElementById('avatar-selector').classList.add('hidden')" class="w-full bg-gray-700 py-3 rounded-xl font-bold text-sm">ANNULER</button>
                </div>
            </div>
        </div>
        <div id="levelup-screen" class="hidden absolute inset-0 bg-black/90 backdrop-blur-xl flex items-center justify-center z-[60] pointer-events-auto animate-fadeIn">
            <div class="w-full max-w-sm p-6 text-center"><h2 class="text-5xl font-tech text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 font-black mb-4 animate-bounce">LEVEL UP!</h2><div id="perk-container" class="grid gap-3"></div></div>
        </div>
        <div id="gameover-screen" class="hidden absolute inset-0 bg-red-950/95 backdrop-blur-2xl flex items-center justify-center z-[70] pointer-events-auto animate-fadeIn">
            <div class="text-center max-w-sm w-full p-6">
                <h1 id="go-title" class="text-8xl font-black text-white mb-2 drop-shadow-2xl tracking-tighter">KO</h1>
                <p class="text-red-400 font-bold text-xl mb-8 uppercase tracking-widest" id="go-reason">√âlimin√©</p>
                <div class="glass-panel p-6 mb-6 grid grid-cols-2 gap-4 text-left bg-black/40">
                    <div><div class="text-[10px] text-gray-500 uppercase font-bold mb-1">Score</div><div id="go-score" class="text-2xl font-black text-white font-tech">0</div></div>
                    <div><div class="text-[10px] text-gray-500 uppercase font-bold mb-1">Gains</div><div class="text-xl font-bold text-yellow-400" id="go-rewards"></div></div>
                </div>
                <button onclick="game.toMenu()" class="w-full bg-white text-black font-black py-4 rounded-xl active:scale-95 transition shadow-xl text-lg">RETOUR MENU üè†</button>
            </div>
        </div>
    </div>
    <script>
        /* mBATTLE v1.0.0.8.5 - SAISON 2 */
        window.game = {}; 

        const CFG = { w: 0, h: 0, world: 2500 };
        
        // --- FACTEURS DE TUNING V1.0.0.8.3 ---
        const SPEED_FACTOR = 0.64; 
        const RATE_FACTOR = 1.38; 
        const RELOAD_FACTOR = 1.02;
        const PROJ_SPEED_FACTOR = 0.93;
        const ENEMY_HP_BUFF = 20; // +20 PV pour les bots/ennemis

        const RARITY = { common: { name: 'Commun', color: '#94a3b8', bg: 'bg-gray-500' }, rare: { name: 'Rare', color: '#3b82f6', bg: 'bg-blue-500' }, epic: { name: '√âpique', color: '#a855f7', bg: 'bg-purple-500' }, legendary: { name: 'L√©gendaire', color: '#eab308', bg: 'bg-yellow-500' }, mythic: { name: 'Mythique', color: '#ef4444', bg: 'bg-red-600' } };
        
        // PRIX STANDARDIS√âS
        const PRICE_COMMON = 0;
        const PRICE_RARE = 1000;
        const PRICE_EPIC = 1800;
        const PRICE_LEGENDARY = 3200;
        const PRICE_MYTHIC = 5000;

        // D√âFINITION DES PROPRI√âT√âS DES PROJECTILES UNIQUES PAR H√âROS
        const STARTERS = { 
            soldier: { name: "Soldier", rarity: 'common', icon: "üî´", hp: 130, dmg: 22, spd: 5.5 * SPEED_FACTOR, rate: Math.ceil(14 * RATE_FACTOR), ammo:3, reload:Math.ceil(40 * RELOAD_FACTOR), price: PRICE_COMMON, scale:{hp:10, dmg:2}, color: '#3b82f6', desc: "Polyvalent.", gadget: "heal", lore: "V√©t√©ran des guerres galactiques.", passive: "Regen Rapide", 
                       proj: { r: 5, speed: Math.ceil(20 * PROJ_SPEED_FACTOR), life: 60, shape: 'circle', color: '#3b82f6', trailColor: '#1e3a8a' },
                       skins: [ {id:'default', name:'Soldat', c:'#3b82f6'}, {id:'gold', name:'Soldat Or', c:'#fbbf24', price: 2000}, {id:'commando', name:'Commando', c:'#166534', price: 1500}, {id:'pixel', name:'Pixel', c:'#60a5fa', price: 1000} ] }, 
            drone: { name: "Drone", rarity: 'common', icon: "üõ∏", hp: 80, dmg: 15, spd: 7.0 * SPEED_FACTOR, rate: Math.ceil(8 * RATE_FACTOR), ammo:10, reload:Math.ceil(30 * RELOAD_FACTOR), price: PRICE_COMMON, scale:{hp:5, dmg:2}, color: '#94a3b8', type: 'laser', desc: "Rapide et fragile.", gadget: "speed", lore: "Un drone de surveillance devenu fou.", passive: "Esquive", 
                     proj: { r: 4, speed: Math.ceil(30 * PROJ_SPEED_FACTOR), life: 70, shape: 'laser', color: '#94a3b8', trailColor: '#cbd5e1' },
                     skins: [{id:'default', name:'Drone', c:'#94a3b8'}, {id:'stealth', name:'Furtif', c:'#0f172a', price: 1000}, {id:'glow', name:'N√©on Bleu', c:'#0ea5e9', price: 1500}] }, // NOUVEAUX SKINS
            // NOUVEAU H√âROS : COMMUN (Scout)
            scout: { name: "Scout", rarity: 'common', icon: "üèÉ", hp: 110, dmg: 18, spd: 7.5 * SPEED_FACTOR, rate: Math.ceil(12 * RATE_FACTOR), ammo:5, reload:Math.ceil(30 * RELOAD_FACTOR), price: PRICE_COMMON, scale:{hp:8, dmg:2}, color: '#94a3b8', type: 'normal', desc: "√âclaireur ultra-rapide.", gadget: "speed", lore: "Sp√©cialiste de la reconnaissance.", passive: "Course",
                     proj: { r: 4, speed: Math.ceil(28 * PROJ_SPEED_FACTOR), life: 60, shape: 'circle', color: '#f59e0b', trailColor: '#fbbf24' },
                     skins: [{id:'default', name:'Scout', c:'#94a3b8'}, {id:'desert', name:'D√©sert', c:'#d97706', price: 1500}, {id:'solaire', name:'Solaire', c:'#fef08a', price: 2000}] }, // NOUVEAUX SKINS

            tank: { name: "Heavy", rarity: 'rare', icon: "üõ°Ô∏è", hp: 320, dmg: 14, spd: 3.5 * SPEED_FACTOR, rate: Math.ceil(35 * RATE_FACTOR), ammo:3, reload:Math.ceil(55 * RELOAD_FACTOR), price: PRICE_RARE, scale:{hp:30, dmg:1}, color: '#22c55e', type: 'shotgun', desc: "Sac √† PV.", gadget: "shield", lore: "Une forteresse mobile.", passive: "Armure +20%", 
                    proj: { r: 8, speed: Math.ceil(15 * PROJ_SPEED_FACTOR), life: 50, shape: 'circle', color: '#22c55e', trailColor: '#166534' },
                    skins: [ {id:'default', name:'Heavy', c:'#22c55e'}, {id:'toxic', name:'Toxic', c:'#a3e635', price: 1500}, {id:'mecha', name:'Mecha', c:'#f3f4f6', price: 2500}, {id:'rusty', name:'Rouill√©', c:'#78350f', price: 1000} ] }, 
            bomber: { name: "Bomber", rarity: 'rare', icon: "üí£", hp: 150, dmg: 45, spd: 4.5 * SPEED_FACTOR, rate: Math.ceil(40 * RATE_FACTOR), ammo:2, reload:Math.ceil(60 * RELOAD_FACTOR), price: PRICE_RARE, scale:{hp:15, dmg:5}, color: '#f59e0b', type: 'shotgun', desc: "Explosifs.", gadget: "knockback", lore: "Adore les feux d'artifice.", passive: "D√©g√¢ts Zone", 
                      proj: { r: 10, speed: Math.ceil(12 * PROJ_SPEED_FACTOR), life: 40, shape: 'circle', color: '#f59e0b', trailColor: '#fed7aa' },
                      skins: [{id:'default', name:'Bomber', c:'#f59e0b'}] },
            sniper: { name: "Sniper", rarity: 'rare', icon: "ü¶Ö", hp: 80, dmg: 120, spd: 5 * SPEED_FACTOR, rate: Math.ceil(65 * RATE_FACTOR), ammo:3, reload:Math.ceil(80 * RELOAD_FACTOR), price: PRICE_RARE, scale:{hp:5, dmg:15}, color: '#a855f7', type: 'sniper', desc: "Tireur d'√©lite.", gadget: "knockback", lore: "Ne rate jamais sa cible.", passive: "Critique +10%", 
                      proj: { r: 6, speed: Math.ceil(25 * PROJ_SPEED_FACTOR), life: 100, shape: 'sniper', color: '#a855f7', trailColor: '#7c3aed' },
                      skins: [{id:'default', name:'Sniper', c:'#a855f7'}, {id:'elite', name:'Elite', c:'#1e1b4b', price: 3000}, {id:'camo', name:'Camo', c:'#3f6212', price: 1500}, {id:'ghillie', name:'Ghillie', c:'#14532d', price: 2000}] }, 
            harpy: { name: "Harpy", rarity: 'rare', icon: "üïäÔ∏è", hp: 100, dmg: 18, spd: 6.8 * SPEED_FACTOR, rate: Math.ceil(7 * RATE_FACTOR), ammo:8, reload:Math.ceil(35 * RELOAD_FACTOR), price: PRICE_RARE, scale:{hp:7, dmg:3}, color: '#84cc16', type: 'normal', desc: "Rapide et agile.", gadget: "speed", lore: "Chasseur a√©rien.", passive: "Tir Rapide",
                     proj: { r: 4, speed: Math.ceil(25 * PROJ_SPEED_FACTOR), life: 50, shape: 'circle', color: '#84cc16', trailColor: '#a7f3d0' },
                     skins: [{id:'default', name:'Harpy', c:'#84cc16'}, {id:'frost', name:'Givre', c:'#bae6fd', price: 1000}, {id:'fire', name:'Ardente', c:'#dc2626', price: 1500}] }, 
            // NOUVEAU H√âROS : RARE
            engineer: { name: "Engineer", rarity: 'rare', icon: "‚öôÔ∏è", hp: 180, dmg: 15, spd: 4.8 * SPEED_FACTOR, rate: Math.ceil(18 * RATE_FACTOR), ammo:8, reload:Math.ceil(40 * RELOAD_FACTOR), price: PRICE_RARE, scale:{hp:15, dmg:2}, color: '#fbbf24', type: 'normal', desc: "Construit des tourelles de d√©fense.", gadget: "turret", lore: "Le g√©nie du champ de bataille.", passive: "Tourelle",
                     proj: { r: 6, speed: Math.ceil(20 * PROJ_SPEED_FACTOR), life: 60, shape: 'circle', color: '#fbbf24', trailColor: '#eab308' },
                     skins: [{id:'default', name:'Engineer', c:'#fbbf24'}, {id:'robot', name:'Robotique', c:'#94a3b8', price: 1000}, {id:'stealth', name:'Furtif', c:'#1e293b', price: 1500}, {id:'cyber', name:'Cyber', c:'#06b6d4', price: 2000}] }, // NOUVEAUX SKINS

            assassin:{ name: "Assassin", rarity: 'epic', icon: "üó°Ô∏è", hp: 90, dmg: 18, spd: 7.5 * SPEED_FACTOR, rate: Math.ceil(8 * RATE_FACTOR), ammo:4, reload:Math.ceil(30 * RELOAD_FACTOR), price: PRICE_EPIC, scale:{hp:8, dmg:4}, color: '#ef4444', desc: "Ultra rapide.", gadget: "speed", lore: "Une ombre dans la nuit.", passive: "Vitesse Kill", 
                       proj: { r: 5, speed: Math.ceil(22 * PROJ_SPEED_FACTOR), life: 55, shape: 'circle', color: '#ef4444', trailColor: '#991b1b' },
                       skins: [{id:'default', name:'Assassin', c:'#ef4444'}, {id:'ninja', name:'Ninja', c:'#171717', price: 2500}, {id:'void', name:'N√©ant', c:'#4c1d95', price: 3500}] }, 
            pyro: { name: "Pyro", rarity: 'epic', icon: "üî•", hp: 160, dmg: 7, spd: 5 * SPEED_FACTOR, rate: Math.ceil(4 * RATE_FACTOR), ammo:50, reload:Math.ceil(10 * RELOAD_FACTOR), price: PRICE_EPIC, scale:{hp:15, dmg:1}, color: '#f97316', type: 'flame', desc: "Zone de feu.", gadget: "dash", lore: "Adore l'odeur du napalm.", passive: "Br√ªlure", 
                    proj: { r: 15, speed: Math.ceil(10 * PROJ_SPEED_FACTOR), life: 30, shape: 'flame', color: '#f97316', trailColor: '#fef3c7' },
                    skins: [{id:'default', name:'Pyro', c:'#f97316'}, {id:'blueflame', name:'Flamme Bleue', c:'#3b82f6', price: 2000}, {id:'toxic', name:'Toxique', c:'#16a34a', price: 1500}] }, 
            viper: { name: "Viper", rarity: 'epic', icon: "üêç", hp: 110, dmg: 10, spd: 6.2 * SPEED_FACTOR, rate: Math.ceil(5 * RATE_FACTOR), ammo: 25, reload: Math.ceil(40 * RELOAD_FACTOR), price: PRICE_EPIC, scale:{hp:8, dmg:1}, color: '#4d7c0f', type: 'flame', desc: "Tire du poison.", gadget: "speed", lore: "Mortel et silencieux.", passive: "Poison", 
                     proj: { r: 6, speed: Math.ceil(28 * PROJ_SPEED_FACTOR), life: 70, shape: 'snake', color: '#4d7c0f', trailColor: '#10b981' },
                     skins: [{id:'default', name:'Viper', c:'#4d7c0f'}, {id:'cobra', name:'Cobra', c:'#eab308', price: 2000}] }, 
            shaman: { name: "Shaman", rarity: 'epic', icon: "üåø", hp: 140, dmg: 15, spd: 5.2 * SPEED_FACTOR, rate: Math.ceil(18 * RATE_FACTOR), ammo:4, reload:Math.ceil(30 * RELOAD_FACTOR), price: PRICE_EPIC, scale:{hp:12, dmg:2}, color: '#10b981', type: 'normal', desc: "Aura toxique.", gadget: "heal", lore: "Force de la nature.", passive: "Poison Aura",
                      proj: { r: 7, speed: Math.ceil(18 * PROJ_SPEED_FACTOR), life: 65, shape: 'circle', color: '#10b981', trailColor: '#6ee7b7' },
                      skins: [{id:'default', name:'Shaman', c:'#10b981'}, {id:'spirit', name:'Esprit', c:'#e5e7eb', price: 2000}, {id:'void', name:'N√©ant', c:'#374151', price: 3000}] }, 
            reaper: { name: "Reaper", rarity: 'epic', icon: "üíÄ", hp: 200, dmg: 55, spd: 6.0 * SPEED_FACTOR, rate: Math.ceil(20 * RATE_FACTOR), ammo:1, reload:Math.ceil(35 * RELOAD_FACTOR), price: PRICE_EPIC, scale:{hp:15, dmg:7}, color: '#171717', type: 'melee', desc: "Faux de l'ombre.", gadget: "dash", lore: "S√®me la mort.", passive: "Vol de Vie",
                      proj: { r: 50, speed: 0, life: 1, shape: 'melee', color: '#171717', trailColor: '#a8a29e' },
                      skins: [{id:'default', name:'Reaper', c:'#171717'}, {id:'blood', name:'Sanglant', c:'#b91c1c', price: 2500}, {id:'toxic', name:'Toxique', c:'#10b981', price: 3500}] }, 
            volt: { name: "Volt", rarity: 'epic', icon: "‚ö°", hp: 110, dmg: 18, spd: 6.0 * SPEED_FACTOR, rate: Math.ceil(10 * RATE_FACTOR), ammo: 4, reload: Math.ceil(30 * RELOAD_FACTOR), price: PRICE_EPIC, scale:{hp:8, dmg:3}, color: '#facc15', desc: "Tir √©lectrique.", gadget: "speed", lore: "√ânergie statique.", passive: "Etourdissement", 
                    proj: { r: 6, speed: Math.ceil(28 * PROJ_SPEED_FACTOR), life: 60, shape: 'laser', color: '#facc15', trailColor: '#fef08a' },
                    skins: [{id:'default', name:'Volt', c:'#facc15'}, {id:'plasma', name:'Plasma', c:'#8b5cf6', price: 2500}, {id:'dark', name:'Sombre', c:'#1e293b', price: 2000}] }, 
            // NOUVEAU H√âROS : √âPIQUE
            hex: { name: "Hex", rarity: 'epic', icon: "üîÆ", hp: 130, dmg: 10, spd: 5.5 * SPEED_FACTOR, rate: Math.ceil(25 * RATE_FACTOR), ammo:2, reload:Math.ceil(60 * RELOAD_FACTOR), price: PRICE_EPIC, scale:{hp:10, dmg:1}, color: '#a855f7', type: 'normal', desc: "Mal√©diction.", gadget: "knockback", lore: "Jette des sorts de ralentissement.", passive: "D√©g√¢ts DOT",
                   proj: { r: 8, speed: Math.ceil(15 * PROJ_SPEED_FACTOR), life: 90, shape: 'hex', color: '#a855f7', trailColor: '#d8b4fe' },
                   skins: [{id:'default', name:'Hex', c:'#a855f7'}, {id:'crimson', name:'Pourpre', c:'#be185d', price: 2000}, {id:'ombre', name:'Ombre', c:'#0f172a', price: 2500}] }, // NOUVEAUX SKINS

            ronin: { name: "Ronin", rarity: 'legendary', icon: "üëπ", hp: 180, dmg: 60, spd: 6.5 * SPEED_FACTOR, rate: Math.ceil(25 * RATE_FACTOR), ammo:3, reload:Math.ceil(40 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale:{hp:12, dmg:8}, color: '#be185d', type: 'melee', desc: "Katana.", gadget: "heal", lore: "Cherche la r√©demption.", passive: "Vol de Vie", 
                     proj: { r: 50, speed: 0, life: 1, shape: 'melee', color: '#be185d', trailColor: '#f0f' },
                     skins: [{id:'default', name:'Ronin', c:'#be185d'}, {id:'ghost', name:'Fant√¥me', c:'#e5e7eb', price: 3500}, {id:'cyber', name:'Cyber', c:'#06b6d4', price: 3000}] }, 
            samurai: { name: "Samurai", rarity: 'legendary', icon: "‚öîÔ∏è", hp: 250, dmg: 70, spd: 5.5 * SPEED_FACTOR, rate: Math.ceil(30 * RATE_FACTOR), ammo:2, reload:Math.ceil(50 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale:{hp:20, dmg:10}, color: '#1e3a8a', type: 'melee', desc: "Lame lourde.", gadget: "shield", lore: "Le protecteur de l'empereur.", passive: "Parade", 
                       proj: { r: 60, speed: 0, life: 1, shape: 'melee', color: '#1e3a8a', trailColor: '#3b82f6' },
                       skins: [{id:'default', name:'Samurai', c:'#1e3a8a'}, {id:'gold', name:'Samurai Or', c:'#eab308', price: 3500}] }, // NOUVEAUX SKINS
            cyber: { name: "Cyber", rarity: 'legendary', icon: "üíª", hp: 140, dmg: 35, spd: 5 * SPEED_FACTOR, rate: Math.ceil(20 * RATE_FACTOR), ammo:3, reload:Math.ceil(45 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale:{hp:10, dmg:5}, color: '#06b6d4', type: 'laser', desc: "Laser.", gadget: "teleport", lore: "Fusion homme-machine.", passive: "Pr√©cision", 
                     proj: { r: 4, speed: 40, life: 80, shape: 'laser', color: '#06b6d4', trailColor: '#67e8f9' },
                     skins: [{id:'default', name:'Cyber', c:'#06b6d4'}, {id:'neon', name:'N√©on', c:'#d946ef', price: 4000}, {id:'proto', name:'Proto', c:'#64748b', price: 2000}] }, 
            pulse: { name: "Pulse", rarity: 'legendary', icon: "üí†", hp: 100, dmg: 25, spd: 5.8 * SPEED_FACTOR, rate: Math.ceil(12 * RATE_FACTOR), ammo: 4, reload: Math.ceil(25 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale:{hp:8, dmg:3}, color: '#22d3ee', type: 'laser', desc: "Ondes d'√©nergie.", gadget: "stun", lore: "Technicien sonique.", passive: "Aura Dmg", 
                     proj: { r: 8, speed: 35, life: 60, shape: 'laser', color: '#22d3ee', trailColor: '#67e8f9' },
                     skins: [{id:'default', name:'Pulse', c:'#22d3ee'}, {id:'neon', name:'N√©on', c:'#f0abfc', price: 2500}, {id:'darkmatter', name:'Mati√®re Noire', c:'#312e81', price: 3500}] }, 
            // NOUVEAU H√âROS : L√âGENDAIRE
            centurion: { name: "Centurion", rarity: 'legendary', icon: "üõ°Ô∏è", hp: 400, dmg: 25, spd: 3.2 * SPEED_FACTOR, rate: Math.ceil(30 * RATE_FACTOR), ammo:5, reload:Math.ceil(50 * RELOAD_FACTOR), price: PRICE_LEGENDARY, scale:{hp:35, dmg:4}, color: '#78350f', type: 'shotgun', desc: "Lenteur. Bouclier frontal.", gadget: "shield", lore: "Le dernier rempart de l'ancienne garde.", passive: "Blocage",
                       proj: { r: 7, speed: Math.ceil(15 * PROJ_SPEED_FACTOR), life: 60, shape: 'circle', color: '#f59e0b', trailColor: '#78350f' },
                       skins: [{id:'default', name:'Centurion', c:'#78350f'}, {id:'silver', name:'Argent', c:'#e5e7eb', price: 4000}, {id:'gold', name:'Or', c:'#eab308', price: 4500}] }, // NOUVEAUX SKINS

            titan: { name: "Titan", rarity: 'mythic', icon: "ü¶æ", hp: 600, dmg: 40, spd: 3.0 * SPEED_FACTOR, rate: Math.ceil(50 * RATE_FACTOR), ammo:2, reload:Math.ceil(70 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale:{hp:50, dmg:5}, color: '#eab308', type: 'melee', desc: "SAISON 1.", gadget: "shield", lore: "Gardien l√©gendaire.", passive: "R√©sistance", 
                     proj: { r: 60, speed: 0, life: 1, shape: 'melee', color: '#eab308', trailColor: '#fde047' },
                     skins: [{id:'default', name:'Titan', c:'#eab308'}, {id:'prime', name:'Titan Prime', c:'#713f12', price: 9999}, {id:'frozen', name:'Givr√©', c:'#0ea5e9', price: 5000}] }, 
            goliath: { name: "Goliath", rarity: 'mythic', icon: "üóø", hp: 450, dmg: 12, spd: 3.0 * SPEED_FACTOR, rate: Math.ceil(40 * RATE_FACTOR), ammo: 2, reload: Math.ceil(60 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale:{hp:40, dmg:2}, color: '#78716c', type: 'shotgun', desc: "Lance des rochers.", gadget: "shield", lore: "G√©ant de pierre.", passive: "√âcrasement", 
                       proj: { r: 18, speed: 10, life: 120, shape: 'rock', color: '#78716c', trailColor: '#a8a29e' },
                       skins: [{id:'default', name:'Goliath', c:'#78716c'}, {id:'moss', name:'Mousse', c:'#166534', price: 1500}, {id:'obsidian', name:'Obsidienne', c:'#0f172a', price: 3500}] }, 
            magma: { name: "Magma", rarity: 'mythic', icon: "üåã", hp: 380, dmg: 60, spd: 3.2 * SPEED_FACTOR, rate: Math.ceil(45 * RATE_FACTOR), ammo: 2, reload: Math.ceil(55 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale:{hp:25, dmg:4}, color: '#7f1d1d', type: 'flame', desc: "SAISON 1.", gadget: "dash", lore: "N√© dans un volcan.", passive: "Lave", 
                     proj: { r: 12, speed: 14, life: 40, shape: 'flame', color: '#7f1d1d', trailColor: '#f97316' },
                     skins: [{id:'default', name:'Magma', c:'#7f1d1d'}, {id:'blue', name:'Flamme Bleue', c:'#2563eb', price: 3000}, {id:'obsidian', name:'Obsidienne', c:'#171717', price: 4000}] }, 
            chrono: { name: "Chrono", rarity: 'mythic', icon: "‚è≥", hp: 100, dmg: 12, spd: 6.5 * SPEED_FACTOR, rate: Math.ceil(4 * RATE_FACTOR), ammo: 30, reload: 15, price: PRICE_MYTHIC, scale:{hp:8, dmg:1}, color: '#0ea5e9', type: 'laser', desc: "Ma√Ætre du temps.", gadget: "teleport", lore: "Vient du futur pour gagner.", passive: "Recharge Rapide", 
                      proj: { r: 5, speed: 32, life: 90, shape: 'laser', color: '#0ea5e9', trailColor: '#7dd3fc' },
                      skins: [{id:'default', name:'Chrono', c:'#0ea5e9'}, {id:'future', name:'Future', c:'#f472b6', price: 5000}] },
            // NOUVEAU H√âROS : MYTHIQUE
            overlord: { name: "Overlord", rarity: 'mythic', icon: "üëë", hp: 550, dmg: 35, spd: 2.8 * SPEED_FACTOR, rate: Math.ceil(45 * RATE_FACTOR), ammo:5, reload:Math.ceil(80 * RELOAD_FACTOR), price: PRICE_MYTHIC, scale:{hp:45, dmg:4}, color: '#ef4444', type: 'shotgun', desc: "Tir en c√¥ne, tr√®s lent.", gadget: "knockback", lore: "Le chef supr√™me de l'invasion.", passive: "Omni-vision",
                        proj: { r: 15, speed: 15, life: 50, shape: 'circle', color: '#be185d', trailColor: '#fecaca' },
                        skins: [{id:'default', name:'Overlord', c:'#ef4444'}] }, // NOUVEAUX SKINS

            engineer: { name: "Engineer", rarity: 'rare', icon: "‚öôÔ∏è", hp: 180, dmg: 15, spd: 4.8 * SPEED_FACTOR, rate: Math.ceil(18 * RATE_FACTOR), ammo:8, reload:Math.ceil(40 * RELOAD_FACTOR), price: 500, scale:{hp:15, dmg:2}, color: '#fbbf24', type: 'normal', desc: "Construit des tourelles de d√©fense.", gadget: "turret", lore: "Le g√©nie du champ de bataille.", passive: "Tourelle",
                     proj: { r: 6, speed: Math.ceil(20 * PROJ_SPEED_FACTOR), life: 60, shape: 'circle', color: '#fbbf24', trailColor: '#eab308' },
                     skins: [{id:'default', name:'Engineer', c:'#fbbf24'}, {id:'robot', name:'Robotique', c:'#94a3b8', price: 1000}, {id:'stealth', name:'Furtif', c:'#1e293b', price: 1500}] },
        };
        
        // Fonction pour trier les h√©ros par raret√©
        const sortStartersByRarity = () => {
            const order = ['common', 'rare', 'epic', 'legendary', 'mythic'];
            const sortedKeys = Object.keys(STARTERS).sort((a, b) => {
                const rarityA = STARTERS[a].rarity;
                const rarityB = STARTERS[b].rarity;
                return order.indexOf(rarityA) - order.indexOf(rarityB);
            });
            const sortedStarters = {};
            sortedKeys.forEach(key => {
                sortedStarters[key] = STARTERS[key];
            });
            return sortedStarters;
        };

        const MODES = { 
            survival: { name: "Survie", icon: "üßü", desc: "Vagues infinies.", ranked: false }, 
            ranked: { name: "Class√©", icon: "üèÜ", desc: "Comp√©tition.", ranked: true }, 
            duel: { name: "1v1 Duel", icon: "‚öîÔ∏è", desc: "Duel Bot IA.", ranked: false, boss: true }, 
            heist: { name: "Braquage", icon: "üíé", desc: "D√©truis le coffre!", ranked: false, boss: true }, 
            boss_rush: { name: "Boss Rush", icon: "üëπ", desc: "Combat de Boss.", ranked: false, boss: true }, 
            defense: { name: "D√©fense", icon: "üõ°Ô∏è", desc: "Prot√®ge le cristal.", ranked: false, boss: true }, 
            infection: { name: "Infection", icon: "‚ò£Ô∏è", desc: "Survivre √† la horde.", ranked: false }, 
            train_defense: { name: "Train Express", icon: "üöÇ", desc: "Prot√®ge le train !", ranked: false }, 
            thief: { name: "Voleur", icon: "üí∞", desc: "Vole 10 sacs !", ranked: false },
            cyber_hack: { name: "Cyber Hack", icon: "üíª", desc: "Pirate les zones !", ranked: false, special: true }
        };
        const ARENAS = { 
            tokyo: { name: "Neon Tokyo", color: '#050b14', grid: 'rgba(59,130,246,0.15)', wall: '#1e293b' }, 
            sand: { name: "Sandstorm", color: '#271a0c', grid: 'rgba(245,158,11,0.15)', wall: '#451a03' }, 
            ice: { name: "Ice Age", color: '#082f49', grid: 'rgba(255,255,255,0.1)', wall: '#164e63' }, 
            jungle: { name: "Jungle", color: '#064e3b', grid: 'rgba(34,197,94,0.2)', wall: '#052e16' }, 
            magma: { name: "Magma", color: '#450a0a', grid: 'rgba(239,68,68,0.2)', wall: '#280505' }, 
            ruins: { name: "Ruines", color: '#292524', grid: 'rgba(168,162,158,0.1)', wall: '#44403c' }, 
            cyber_city: { name: "Cyber City", color: '#0f172a', grid: 'rgba(6,182,212,0.2)', wall: '#164e63' }, 
            nebula: { name: "N√©buleuse", color: '#1e1b4b', grid: 'rgba(232, 121, 249, 0.2)', wall: '#312e81' },
            mainframe: { name: "Mainframe", color: '#022c22', grid: 'rgba(34, 211, 238, 0.3)', wall: '#134e4a', special: true }
        };
        const PERKS = [{ name: 'Gros Calibre', icon: 'üí™', desc: '+25% D√©g√¢ts', fn: p => p.stats.dmg *= 1.25 }, { name: 'Armure Nano', icon: 'ü¶∫', desc: '+30% PV Max', fn: p => { p.maxHp *= 1.3; p.hp += 50; } }, { name: 'Turbo', icon: 'üëü', desc: '+15% Vitesse', fn: p => p.stats.spd *= 1.15 }];
        const RANKS = [{n:"BRONZE I", t:0, c:"#cd7f32"}, {n:"BRONZE II", t:100, c:"#cd7f32"}, {n:"BRONZE III", t:200, c:"#cd7f32"}, {n:"SILVER I", t:300, c:"#c0c0c0"}, {n:"SILVER II", t:500, c:"#c0c0c0"}, {n:"SILVER III", t:700, c:"#c0c0c0"}, {n:"GOLD I", t:1000, c:"#ffd700"}, {n:"GOLD II", t:1300, c:"#ffd700"}, {n:"GOLD III", t:1600, c:"#ffd700"}, {n:"PLATINUM I", t:2000, c:"#22d3ee"}, {n:"PLATINUM II", t:2500, c:"#22d3ee"}, {n:"DIAMOND", t:3500, c:"#a855f7"}, {n:"mMASTER", t:5000, c:"#ef4444"}];
        
        // NOUVELLE GRANDE LISTE D'IC√îNES POUR PLUS DE CHOIX (160+)
        const ICONS = ["üë§","ü§ñ","üëΩ","ü¶Å","ü¶Ñ","üíÄ","‚öîÔ∏è","üíé","üëë","üéÆ","üöÄ","üî•","‚ùÑÔ∏è","‚ö°","üåü","üê±","üê∂","ü¶ä","üê∏","üêµ","üêº","üê®","üêØ","üêô","ü¶ñ","üëª","üí©","ü§°","üëπ","üë∫","üéÉ","ü¶æ","üß†","üëÄ","üí•","üíØ","ü•∂","ü•µ","ü§†","ü•∏","ü§ë", "ü•∑", "üßô", "üß™", "ü¶†", "üß¨", "üíæ", "‚öôÔ∏è", "üí°", "üì°", "üõ∏", "üëæ", "üêâ", "üê∫", "ü¶â", "ü¶ã", "üçÑ", "üå∑", "üå≤", "üåä", "üåã", "üèñÔ∏è", "üåÉ", "üèôÔ∏è", "üèõÔ∏è", "üß±", "üèÆ", "‚õ©Ô∏è", "üèØ", "üóº", "üóΩ", "üîî", "üé∂", "üé§", "üé∏", "üéß", "üïπÔ∏è", "üéØ", "üé≤", "üé±", "üèÄ", "‚öΩ", "üèà", "‚öæ", "üéæ", "ü•ä", "ü•ã", "ü•á", "ü•à", "ü•â", "üéâ", "üéà", "üéÅ", "üßß", "üéÄ", "üì¶", "‚úâÔ∏è", "üîë", "üóùÔ∏è", "üî®", "üõ†Ô∏è", "ü™ì", "üî´", "üèπ", "üõ°Ô∏è", "‚ö∞Ô∏è", "‚ö±Ô∏è", "üëë", "üîÆ", "ü™Ñ", "üîë", "üõ°Ô∏è", "üî•", "üíß", "üåç", "‚ú®", "üí´", "üåë", "‚òÄÔ∏è", "üåô", "‚≠ê", "üåà", "‚òÑÔ∏è", "üí•", "‚ö°", "üå©Ô∏è", "‚òî", "üå™Ô∏è", "üí®", "üçÇ", "üçÅ", "üçè", "üçé", "üçê", "üçä", "üçã", "üçå", "üçâ", "üçá", "üçì", "üçà", "üçí", "üçë", "üçç", "ü••", "ü•ù", "ü•≠", "üçÖ", "üçÜ", "üå∂Ô∏è", "üåΩ", "ü•ï", "ü•î", "üç†", "ü•ê", "üçû", "ü•ñ", "ü•®", "ü•û", "üßá", "üßÄ", "ü•ö", "üç≥", "ü•ì", "ü•©", "üçó", "üçñ", "üçî", "üçü", "üçï", "üå≠", "ü•™", "üåÆ", "üåØ", "ü•ô", "üßÜ", "ü•ó", "ü•ò", "üç≤", "üçù", "üçú", "üç£", "üç§", "üç•", "üç°", "ü•†", "ü•°", "üçö", "üçõ", "üçó", "üç£", "üç§", "üç•", "üç°", "ü•†", "ü•°", "üçö", "üçõ"];
        
        const EMOTE_LIST = [
            {id:'happy', i:'üòÄ', price: 0}, {id:'angry', i:'üò°', price: 0}, {id:'gg', i:'üëç', price: 0}, {id:'rip', i:'üíÄ', price: 0},
            {id:'love', i:'üòç', price: 15}, {id:'clown', i:'ü§°', price: 15}, {id:'fire', i:'üî•', price: 25}, {id:'crown', i:'üëë', price: 45},
            {id:'ghost', i:'üëª', price: 25}, {id:'robot', i:'ü§ñ', price: 25}, {id:'flex', i:'üí™', price: 15}, {id:'cry', i:'üò≠', price: 15},
            {id:'cool', i:'üòé', price: 15}, {id:'party', i:'ü•≥', price: 15}, {id:'sleeping', i:'üò¥', price: 5}, {id:'devil', i:'üòà', price: 25},
            {id:'money', i:'ü§ë', price: 35}, {id:'sick', i:'ü§¢', price: 5}, {id:'shhh', i:'ü§´', price: 10}, {id:'think', i:'ü§î', price: 10},
            {id:'dab', i:'üôÖ', price: 95}, {id:'rich', i:'üí∏', price: 195}, {id:'hacker', i:'üíª', price: 145}, {id:'cat', i:'üôÄ', price: 115},
            {id:'alien', i:'üëΩ', price: 20}, {id:'nerd', i:'ü§ì', price: 10}, {id:'rage', i:'ü§¨', price: 30}, {id:'mindblown', i:'ü§Ø', price: 25},
            {id:'scream', i:'üò±', price: 15}, {id:'star', i:'ü§©', price: 20}, {id:'cowboy', i:'ü§†', price: 25}, {id:'mask', i:'üò∑', price: 5},
            {id:'ice', i:'ü•∂', price: 25}, {id:'boxe', i:'ü•ä', price: 30}, {id:'zen', i:'üßò', price: 10}, {id:'dice', i:'üé≤', price: 15}
        ];
        // Sort emotes by price
        EMOTE_LIST.sort((a, b) => a.price - b.price);

        const DIFFICULTY = {
            easy: { name: 'Facile', mult: 0.8, color: 'text-green-400' }, // Feature 2: Score Multiplier adjusted
            normal: { name: 'Normal', mult: 1.0, color: 'text-blue-400' },
            hard: { name: 'Difficile', mult: 1.5, color: 'text-red-400' }
        };

        // NEW MODIFIERS
        const MODIFIERS = {
            normal: { name: 'Classique', color: 'text-gray-300' },
            oneshot: { name: 'One Shot', color: 'text-red-500' },
            poison: { name: 'Poison', color: 'text-green-500' },
            speed: { name: 'Speed', color: 'text-yellow-500' },
            vampire: { name: 'Vampire', color: 'text-pink-500' },
            infinite: { name: 'Infini', color: 'text-blue-400' },
            explosive: { name: 'Explosif', color: 'text-orange-500' },
            recoil: { name: 'Recul', color: 'text-white' },
            giant: { name: 'G√©ant', color: 'text-purple-600' }
        };

        const CURRENT_VERSION_KEY = 'mBattle_Data_v1_0';
        const PREVIOUS_KEYS = ['mBattle_Data_v20', 'mBattle_Data_v19', 'mBattle_Data_v18', 'mBattle_Data_v17', 'mBattle_Data_v16'];
        let USER = {
            name: "Joueur", avatar: "üë§", tag: "#" + Math.random().toString(36).substr(2, 6).toUpperCase(),
            coins: 500, gems: 10, trophies: 0, unlocked: ['soldier', 'drone'], levels: { soldier: 1, drone: 1 }, selected: 'soldier',
            stats: { kills: 0, maxWave: 0, games: 0, wins: 0, dmg: 0, losses: 0, maxPassTier: 1 }, // Ajout des nouvelles stats
            lastDaily: 0,
            pass: { tier: 1, xp: 0, claimed: [], claimedPro: [] },
            shop: { lastRefresh: 0, items: [] },
            emotes: ['happy', 'angry', 'gg', 'rip'], equippedEmotes: ['happy', 'angry', 'gg', 'rip'],
            mPassPro: false,
            skins: {}, 
            ownedSkins: [] 
        };

        // MISE √Ä JOUR : Remplacement des skins mPass par des caisses
        const PASS_REWARDS = {
            1: { free: 'coins:100', pro: 'mega_caisse_loot:1' },
            5: { free: 'emote:hacker', pro: 'gems:50' },
            10: { free: 'box:1', pro: 'mega_caisse_loot:1' },
            15: { free: 'coins:200', pro: 'emote:alien' },
            20: { free: 'box:1', pro: 'gems:100' },
            30: { free: 'box:1', pro: 'emote:mindblown' },
            40: { free: 'coins:500', pro: 'mega_caisse_loot:1' },
            50: { free: 'box:1', pro: 'gems:300' } // Feature 7: R√©compense Palier 50
        };

        const getPassReward = (tier, isPro) => {
            if (PASS_REWARDS[tier]) {
                const rewardString = isPro ? PASS_REWARDS[tier].pro : PASS_REWARDS[tier].free;
                if (rewardString && rewardString.includes(':')) return rewardString;
            }
            if (isPro) {
                // Remplacer les r√©compenses par d√©faut des paliers non sp√©cifi√©s par des caisses/gemmes
                return (tier % 5 === 0) ? 'mega_caisse_loot:1' : 'gems:15';
            } else {
                return (tier % 3 === 0) ? 'gems:5' : 'coins:50';
            }
        };

        const Storage = {
            save() { localStorage.setItem(CURRENT_VERSION_KEY, JSON.stringify(USER)); },
            load() {
                // Check migration
                let d = localStorage.getItem(CURRENT_VERSION_KEY);
                let isMigration = false;
                
                if (!d) {
                    // Try to find old data
                    for (let key of PREVIOUS_KEYS) {
                        const oldData = localStorage.getItem(key);
                        if (oldData) {
                            d = oldData;
                            isMigration = true; // Found old data, so it's a migration
                            break;
                        }
                    }
                }

                if (d) {
                    try {
                        const saved = JSON.parse(d);
                        USER = { ...USER, ...saved,
                            // Maintien des anciennes stats et ajout des nouvelles avec valeur par d√©faut si non trouv√©es
                            stats: { ...USER.stats, ...(saved.stats||{}), losses: saved.stats?.losses || 0, maxPassTier: saved.stats?.maxPassTier || 1 },
                            // Reset pass for new season but keep old items if migration
                            pass: isMigration ? { tier: 1, xp: 0, claimed: [], claimedPro: [] } : { ...USER.pass, ...(saved.pass||{}) },
                            shop: { ...USER.shop, ...(saved.shop||{}) },
                            levels: { ...USER.levels, ...(saved.levels||{}) },
                            emotes: saved.emotes || ['happy', 'angry', 'gg', 'rip'],
                            equippedEmotes: saved.equippedEmotes || ['happy', 'angry', 'gg', 'rip'],
                            mPassPro: isMigration ? false : (saved.mPassPro || false), // Reset Pro status for new season
                            skins: saved.skins || {},
                            ownedSkins: saved.ownedSkins || []
                        };
                        
                        // Ensure new free hero is unlocked
                        if(!USER.unlocked.includes('drone')) USER.unlocked.push('drone');
                        
                        if (typeof window.game !== 'undefined') {
                            if(!window.game.conf) window.game.conf = {};
                            if(!saved.conf || !saved.conf.difficulty) window.game.conf.difficulty = 'normal';
                            else window.game.conf.difficulty = saved.conf.difficulty;
                            if(!saved.conf || !saved.conf.modifier) window.game.conf.modifier = 'normal';
                            else window.game.conf.modifier = saved.conf.modifier;
                        }
                        
                        this.save();
                        
                    } catch (e) {
                         console.error("Erreur de chargement des donn√©es:", e);
                    }
                } else {
                    // Brand new user
                    // Initialisation des nouvelles stats pour les nouveaux utilisateurs
                    USER.stats.losses = 0;
                    USER.stats.maxPassTier = 1;
                }
                window.ui.refreshShop();
            }
        };

        const Rnd = (min,max) => Math.random()*(max-min)+min;
        const Dist = (e1,e2) => Math.hypot(e1.x-e2.x, e1.y-e2.y);
        function ColRect(c, r) { return c.x+c.r > r.x && c.x-c.r < r.x+r.w && c.y+c.r > r.y && c.y-c.r < r.y+r.h; }
        
        // Fonction de collision plus subtile, √©vitant de repousser les objets statiques
        function resolveCollision(e1, e2) {
            let dx=e1.x-e2.x, dy=e1.y-e2.y; let dist=Math.hypot(dx,dy); const minDist=e1.r+e2.r;
            if(dist < minDist) {
                if(dist <= 0.01) { dx=1; dy=0; dist=1; }
                const overlap=minDist-dist, nx=dx/dist, ny=dy/dist;
                
                // V√©rifier si l'une des entit√©s est le joueur et l'autre un mur ou un bot
                const isPlayer = e1 === window.game.player || e2 === window.game.player;
                
                // Masse invers√©e: entit√©s statiques (chest/core/train/terminal) ont masse infinie (1 / Infinity = 0)
                const isStatic1 = (e1.type==='chest' || e1.type==='core' || e1.type==='train' || e1.type==='terminal');
                const isStatic2 = (e2.type==='chest' || e2.type==='core' || e2.type==='train' || e2.type==='terminal');
                
                let m1 = isStatic1 ? 0 : (e1 === window.game.player ? 1 : 0.5); // Player mass 1, Bot mass 0.5
                let m2 = isStatic2 ? 0 : (e2 === window.game.player ? 1 : 0.5); 
                
                const totalMass = m1 + m2;
                
                let ratio1 = m2 / totalMass; 
                let ratio2 = m1 / totalMass; 
                
                if (isStatic1 && !isStatic2) { ratio1 = 0; ratio2 = 1; }
                else if (!isStatic1 && isStatic2) { ratio1 = 1; ratio2 = 0; }
                else if (isStatic1 && isStatic2) { return; } 

                // FIX ANTI-PUSH: Si e2 est un joueur et e1 est un bot, on donne la priorit√© au joueur.
                // Si e1 est le joueur, il prend 100% de la correction (si e2 n'est pas statique).
                if (e1 === window.game.player && !isStatic2) { ratio1 = 1; ratio2 = 0; } 
                // Si e2 est le joueur, il prend 100% de la correction (si e1 n'est pas statique).
                else if (e2 === window.game.player && !isStatic1) { ratio1 = 0; ratio2 = 1; }
                // Si la collision est joueur-bot, le joueur ne devrait pas bouger si le bot pousse.
                // Logique pour s'assurer que si le joueur est contre un mur (statique), le bot ne puisse pas le pousser davantage (bug anti-push)
                if (e1 === window.game.player && isStatic2) { ratio1 = 0; } 
                else if (e2 === window.game.player && isStatic1) { ratio2 = 0; }


                e1.x += nx * overlap * ratio1;
                e1.y += ny * overlap * ratio1;
                e2.x -= nx * overlap * ratio2;
                e2.y -= ny * overlap * ratio2;
            }
        }
        const getGadgetName = (g) => { 
            const map = { 'heal': 'Soin (+1000)', 'shield': 'Bouclier (+1000)', 'teleport': 'TP', 'dash': 'Dash Feu', 'speed': 'Turbo', 'knockback': 'Choc', 'stun': '√âtourdissant', 'turret': 'Tourelle' }; // Feature 8
            return map[g] || g.toUpperCase(); 
        }

        const el = (id) => document.getElementById(id);
        const setStyle = (id, prop, val) => { const e=el(id); if(e) e.style[prop]=val; };
        const setText = (id, txt) => { const e=el(id); if(e) e.innerText=txt; };
        
        // NOUVELLE FONCTION : Gestion de l'ouverture de caisse √† gros butin
        function openLootCrate() {
            let rewards = [];
            let totalValue = 0;
            const pulls = 7; // Feature 3: Mega caisse plus g√©n√©reuse (7 pulls au lieu de 5)

            for (let i = 0; i < pulls; i++) {
                const r = Math.random();
                let type, value, color, icon;

                if (r < 0.5) { // 50% chance: Coins
                    value = 150 + Math.floor(Math.random() * 250);
                    USER.coins += value;
                    type = 'Pi√®ces'; icon = 'ü™ô'; color = '#eab308';
                    totalValue += value;
                } else if (r < 0.85) { // 35% chance: Gems
                    value = 7 + Math.floor(Math.random() * 13);
                    USER.gems += value;
                    type = 'Gemmes'; icon = 'üíé'; color = '#a855f7';
                    totalValue += value * 50; // Estimer la valeur
                } else { // 15% chance: XP Boost
                    value = 150;
                    USER.pass.xp += value;
                    type = 'XP Pass'; icon = 'üé´'; color = '#22d3ee';
                    totalValue += value * 2;
                }
                rewards.push({ icon, value, type });
            }

            // Traitement de l'XP
            while(USER.pass.xp >= 100) {
                if(USER.pass.tier < 50) {
                    USER.pass.tier++;
                    USER.pass.xp -= 100;
                    window.ui.notif("PASS LEVEL UP!", "#facc15");
                } else {
                    USER.pass.xp = 100;
                    break;
                }
            }
            
            // Affichage des r√©compenses
            let message = rewards.map(r => `${r.icon} +${r.value} ${r.type}`).join(', ');
            window.ui.notif(`BUTIN DE LA CAISSE : ${message}`, '#facc15');
            Storage.save();
            window.ui.updateMenu();
            window.ui.renderPass();
        }

        function processPassReward(rewardString) {
            const [type, value] = rewardString.split(':');
            const val = parseInt(value) || 1;
            let success = false;

            if (type === 'coins') {
                USER.coins += val;
                window.ui.notif(`+${val} ü™ô`, "#eab308");
                el('top-coins').closest('.currency-badge').classList.add('flash-coins'); // Animation
                setTimeout(() => el('top-coins').closest('.currency-badge').classList.remove('flash-coins'), 300);
                success = true;
            } else if (type === 'gems') {
                USER.gems += val;
                window.ui.notif(`+${val} üíé`, "#a855f7");
                el('top-gems').closest('.currency-badge').classList.add('flash-gems'); // Animation
                setTimeout(() => el('top-gems').closest('.currency-badge').classList.remove('flash-gems'), 300);
                success = true;
            } else if (type === 'box') {
                window.ui.buy('box', 0, 'free');
                success = true;
            } else if (type === 'mega_caisse_loot') { // NOUVEAU TYPE DE BUTIN
                openLootCrate();
                success = true;
            } else if (type.startsWith('emote')) {
                const emoteId = type.split(':')[1];
                if (!USER.emotes.includes(emoteId)) {
                    USER.emotes.push(emoteId);
                    window.ui.notif(`EMOTE D√âBLOQU√âE: ${EMOTE_LIST.find(e => e.id === emoteId)?.i}`, "#22d3ee");
                    window.ui.renderEmotes();
                }
                success = true;
            } else if (type.startsWith('skin')) {
                const [heroId, skinId] = type.split(':')[1].split('_');
                const fullSkinId = `${heroId}_${skinId}`;
                if (!USER.ownedSkins.includes(fullSkinId)) {
                    USER.ownedSkins.push(fullSkinId);
                    const skinName = STARTERS[heroId]?.skins.find(s => s.id === skinId)?.name || 'Skin';
                    window.ui.notif(`SKIN D√âBLOQU√â: ${skinName}!`, "#facc15");
                    window.ui.renderLists(); // Pour mettre √† jour la s√©lection de skin
                }
                success = true;
            }
            return success;
        }

        window.ui = {
            showIntro() {
                /* Video Removed */
            },
            closeIntro() {
                /* Video Removed */
            },
            hud() {
                if(!window.game.player) return; const p = window.game.player;
                // FIX 1: Retrait de la transition CSS pour un update imm√©diat de la barre de vie
                const hpBar = el('hud-hp-bar');
                if (hpBar) {
                    // Supprime les classes de transition pour un effet instantan√©
                    hpBar.classList.remove('transition-all', 'duration-75'); 
                    hpBar.style.width = (p.hp/p.maxHp*100)+'%';
                }

                setText('hud-score', window.game.score); setText('hud-sub', MODES[window.game.conf.mode].name.toUpperCase());
                if(window.game.conf.mode !== 'survival' && window.game.conf.mode !== 'ranked' && window.game.conf.mode !== 'infection' && window.game.conf.mode !== 'duel') {
                    const min = Math.floor(window.game.timeLeft / 3600); const sec = Math.floor((window.game.timeLeft % 3600) / 60);
                    const te = el('hud-timer'); if(te) { te.innerText = (min < 10 ? "0"+min : min) + ":" + (sec < 10 ? "0"+sec : sec); te.classList.remove('hidden'); }
                } else { const te = el('hud-timer'); if(te) te.classList.add('hidden'); }
                if(window.game.conf.mode === 'thief') {
                    el('hud-objective').innerText = `Sacs: ${window.game.lootCollected}/10`;
                    el('hud-objective').classList.remove('hidden');
                } else if(window.game.conf.mode === 'cyber_hack') {
                    el('hud-objective').innerText = `Hack: ${Math.floor(window.game.hackProgress)}%`;
                    el('hud-objective').classList.remove('hidden');
                } else {
                    el('hud-objective').classList.add('hidden');
                }
                for(let i=1; i<=3; i++) setStyle('ammo-'+i, 'opacity', i <= Math.floor(p.ammo) ? 1 : 0.3);
                setStyle('dash-cd', 'height', Math.max(0,p.dashT/60*100)+'%');
                setText('gadget-count', p.gadgetCharges);
                const gb=el('btn-gadget'); if(gb) { gb.disabled = p.gadgetCharges<=0; if(p.gadgetCharges<=0)gb.classList.add('opacity-50');else gb.classList.remove('opacity-50'); }
                
                // Check for terminal in boss UI check
                const boss=window.game.ents.find(e=>e.isBoss||e.isBot||e.type==='core'||e.type==='train'||e.type==='terminal'); const bui=el('boss-ui');
                if(boss && bui){
                    bui.classList.remove('hidden');
                    // Update label logic for terminal
                    let label = boss.isBot ? "RIVAL" : (boss.type==='chest'?"COFFRE":(boss.type==='core'?"CRISTAL":(boss.type==='train'?"TRAIN":(boss.type==='terminal'?"TERMINAL":"BOSS"))));
                    setText('boss-name', label);
                    setStyle('boss-bar', 'width', (boss.hp/boss.maxHp*100)+'%'); setText('boss-pct', Math.ceil(boss.hp/boss.maxHp*100)+'%');
                    const bar = el('boss-bar');
                    // Use blue bar for friendly/neutral objectives (core, train, terminal)
                    if(boss.type==='core' || boss.type==='train' || boss.type==='terminal') { bar.classList.remove('bg-gradient-to-r', 'from-red-600', 'to-red-500'); bar.style.backgroundColor = '#3b82f6'; }
                    else { bar.classList.add('bg-gradient-to-r', 'from-red-600', 'to-red-500'); bar.style.backgroundColor = ''; }
                } else if(bui) bui.classList.add('hidden');
                setStyle('gas-overlay', 'opacity', 0);
            },
            notif(m,c) { const d=document.createElement('div'); d.className='text-2xl font-black italic drop-shadow-2xl animate-bounce text-center px-4 py-1 bg-black/60 rounded-xl border border-white/10 backdrop-blur-sm shadow-xl'; d.style.color=c; d.innerText=m; el('notif-area').appendChild(d); setTimeout(()=>d.remove(),2000); },
            flash() { setStyle('flash-layer', 'opacity', 0.6); setTimeout(()=>setStyle('flash-layer', 'opacity', 0), 100); },
            feed(k,v,g) { const d=document.createElement('div'); d.className=`kill-msg ${g?'':'red'}`; d.innerHTML=`<span class="${g?'text-blue-400':'text-red-400'}">${k}</span> ‚ò†Ô∏è ${v}`; const c=el('kill-feed'); if(c){ c.prepend(d); if(c.children.length>4)c.lastChild.remove(); } setTimeout(()=>d.remove(),4000); },
            levelUp() { const s=el('levelup-screen'), c=el('perk-container'); c.innerHTML=''; s.classList.remove('hidden'); PERKS.sort(()=>0.5-Math.random()).slice(0,3).forEach(p=>{ const b=document.createElement('button'); b.className='glass-panel p-4 text-left flex items-center gap-4 active:scale-95 transition bg-blue-900/40 border border-blue-500/30'; b.innerHTML=`<div class="text-3xl">${p.icon}</div><div><div class="font-bold text-yellow-400 text-lg">${p.name}</div><div class="text-xs text-gray-300">${p.desc}</div></div>`; b.onclick=()=>{p.fn(window.game.player); s.classList.add('hidden'); window.game.state='PLAYING';}; c.appendChild(b); }); },
            drawMinimap() {
                const cvs = document.getElementById('minimap'); if(!cvs) return; const ctx = cvs.getContext('2d'); ctx.clearRect(0, 0, 100, 100); const scale = 100 / window.game.world;
                if (window.game.player) { ctx.fillStyle = '#3b82f6'; ctx.beginPath(); ctx.arc(window.game.player.x * scale, window.game.player.y * scale, 4, 0, Math.PI * 2); ctx.fill(); }
                // Added 'terminal' to the list of objective entities to display correctly on the minimap
                (window.game.ents||[]).forEach(e => { if(e.hidden)return; ctx.fillStyle = (e.isBoss || e.isBot) ? '#ef4444' : (e.type==='core'||e.type==='train'||e.type==='terminal'?'#3b82f6':'#f87171'); const r = (e.isBoss || e.isBot || e.type==='core' || e.type==='train' || e.type==='terminal') ? 4 : 2; ctx.beginPath(); ctx.arc(e.x * scale, e.y * scale, r, 0, Math.PI * 2); ctx.fill(); });
                (window.game.map||[]).forEach(w => { if(w.type === 1) ctx.fillStyle = 'rgba(34, 197, 94, 0.8)'; else if(w.type === 3) ctx.fillStyle = '#d97706'; else ctx.fillStyle = 'rgba(255,255,255,0.4)'; ctx.fillRect(w.x * scale, w.y * scale, w.w * scale, w.h * scale); });
            },
            showTab(id) { 
                document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden')); 
                document.getElementById('tab-' + id).classList.remove('hidden'); 
                document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active', 'selected')); 
                const btn = document.getElementById('nav-' + id); 
                if(btn) btn.classList.add('active', 'selected'); 
                
                if(id === 'starters' || id === 'modes') this.renderLists(); 
                if(id === 'infos') this.updateStats(); 
                if(id === 'pass') this.renderPass(); 
                if(id === 'shop') this.renderShop(); 
                if(id === 'profile') this.renderProfile(); 
                if(id === 'emotes') this.renderEmotes(); 
                if(id === 'play') this.updateDifficultyButtons(); 
                
                this.updateMenu(); // Force menu refresh
            },
            updateDifficultyButtons() {
                if(!window.game || !window.game.conf) return; 
                document.querySelectorAll('.diff-btn').forEach(btn => btn.classList.remove('active'));
                const activeBtn = el(`diff-${window.game.conf.difficulty}`);
                if (activeBtn) activeBtn.classList.add('active');
                
                // Also update modifier buttons
                document.querySelectorAll('.mod-btn').forEach(btn => btn.classList.remove('active'));
                const modBtn = el(`mod-${window.game.conf.modifier}`);
                if(modBtn) modBtn.classList.add('active');
            },
            refreshShop(force = false) {
                if (force) {
                    if (USER.gems >= 10) {
                        USER.gems -= 10;
                        this.notif("-10 üíé REROLL", "#a855f7");
                        USER.shop.lastRefresh = 0; // Force refresh trigger
                    } else {
                        this.notif("PAS ASSEZ DE GEMMES", "#ef4444");
                        return;
                    }
                }
                
                // NOUVEAU : Plus d'items de base garantis
                if(!USER.shop.items || USER.shop.items.length === 0 || Date.now() > USER.shop.lastRefresh + 86400000) {
                    USER.shop.lastRefresh = Date.now();
                    USER.shop.items = [];

                    // OFFRE GRATUITE GARANTIE (1 item)
                    const freeType = ['coins','xp','gems'][Math.floor(Math.random()*3)];
                    if(freeType === 'coins') USER.shop.items.push({ type: 'coins', cost: 0, val: 150, curr: 'free', name: "Pi√®ces Gratuites" });
                    if(freeType === 'xp') USER.shop.items.push({ type: 'xp', cost: 0, val: 75, curr: 'free', name: "XP Pass Gratuit" });
                    if(freeType === 'gems') USER.shop.items.push({ type: 'gems', cost: 0, val: 10, curr: 'free', name: "Gemmes Gratuites" });

                    // ITEMS DE BASE GARANTIS (3 items)
                    USER.shop.items.push({type:'coins',cost:20,val:500,curr:'gems', name: "Mega Pack de Pi√®ces"});
                    USER.shop.items.push({type:'xp',cost:100,val:200,curr:'coins', name: "Super Boost de Pass"});
                    USER.shop.items.push({type:'box',cost:80,val:1,curr:'coins', name: "Mega Caisse"});

                    // ITEMS AL√âATOIRES (3 items)
                    for(let i=0; i<3; i++) {
                        const t = ['coins','gems','box', 'xp', 'skin'][Math.floor(Math.random()*5)];
                        if(t==='coins') USER.shop.items.push({type:'coins',cost:20,val:300,curr:'gems', name: "Pack de Pi√®ces"});
                        if(t==='gems') USER.shop.items.push({type:'gems',cost:500,val:30,curr:'coins', name: "Sac de Gemmes"});
                        if(t==='box') USER.shop.items.push({type:'box',cost:80,val:1,curr:'coins', name: "Mega Caisse"});
                        if(t==='xp') USER.shop.items.push({type:'xp',cost:100,val:100,curr:'coins', name: "Boost de Pass"});
                        if(t==='skin') {
                            const keys = Object.keys(STARTERS);
                            const s = STARTERS[keys[Math.floor(Math.random()*keys.length)]];
                            if(s.skins && s.skins.length > 1) {
                                const skin = s.skins[1]; 
                                USER.shop.items.push({type:'skin',cost:skin.price,val:1,curr:'coins', name: `Skin ${skin.name}`, skinId: skin.id, hero: s.name, discount: Math.random() > 0.5 ? 30 : 0});
                            } else {
                                USER.shop.items.push({type:'coins',cost:20,val:300,curr:'gems', name: "Pack de Pi√®ces"});
                            }
                        }
                    }
                    Storage.save();
                    if(force) this.renderShop();
                }
            },
            renderShop() {
                this.refreshShop();
                const now = Date.now(); 
                const left = (USER.shop.lastRefresh + 86400000) - now; const hrs = Math.floor(left / 3600000); const mins = Math.floor((left % 3600000) / 60000);
                setText('shop-timer', `${hrs}h ${mins}m`);
                const c = el('shop-offers'); 
                if(!c) return;
                c.innerHTML = '';
                c.innerHTML += `<h3 class="col-span-1 md:col-span-2 text-xl font-bold text-yellow-400 flex items-center gap-2">üî• OFFRES FLASH üî•</h3>`;
                USER.shop.items.forEach((item, idx) => {
                    let icon = item.type==='coins'?'ü™ô':(item.type==='gems'?'üíé':(item.type==='xp'?'üé´':(item.type==='skin'?'üëï':'üì¶')));
                    let curIcon = item.curr==='coins'?'ü™ô':(item.curr==='gems'?'üíé':'üéÅ');
                    let color = item.curr==='free' ? 'free-item' : 'bg-white/5';
                    let btnClass = item.curr==='free' ? 'bg-green-600 hover:bg-green-500' : (item.curr==='gems'?'bg-purple-600 hover:bg-purple-500':'bg-yellow-600 hover:bg-yellow-500');
                    let costDisplay = `${item.cost} ${curIcon}`;
                    let discountBadge = '';
                    if(item.discount) {
                        const newCost = Math.floor(item.cost * (1 - item.discount/100));
                        costDisplay = `<span class="line-through text-gray-400 text-xs mr-2">${item.cost}</span> ${newCost} ${curIcon}`;
                        item.realCost = newCost;
                    } else {
                        item.realCost = item.cost;
                    }
                    if(item.curr === 'free') costDisplay = 'GRATUIT';
                    c.innerHTML += `<div class="glass-panel p-6 text-center flex flex-col items-center active:scale-95 transition border border-white/10 ${color} relative overflow-hidden">
                        ${discountBadge}
                        <div class="text-5xl mb-2">${icon}</div>
                        <div class="font-bold text-lg">${item.name}</div>
                        <div class="text-xs text-gray-400 mb-4">${item.type==='skin' ? 'Skin Rare' : `+${item.val} ${icon}`}</div>
                        <button onclick="window.ui.buySpecial(${idx})" class="w-full ${btnClass} py-3 rounded-xl font-bold text-sm">${costDisplay}</button>
                    </div>`;
                });
            },
            renderPass() {
                setText('pass-lvl', USER.pass.tier); setText('pass-xp-txt', `${USER.pass.xp}/100 XP`); setStyle('pass-bar', 'width', `${USER.pass.xp}%`);
                const status = el('pass-pro-status');
                if(status) {
                    if(USER.mPassPro) { status.innerHTML = '<span class="text-yellow-400 font-black text-xl glow">PRO ACTIV√â</span>'; }
                    // PRIX PASS PRO (159)
                    else { status.innerHTML = `<button onclick="window.ui.buyPassPro()" class="bg-gradient-to-r from-purple-600 to-indigo-600 px-4 py-2 rounded-lg font-bold text-xs shadow-lg hover:scale-105 transition">ACHETER PASS PRO (159 üíé)</button>`; }
                }
                const tr = el('pass-track-free');
                const trPro = el('pass-track-pro');
                if (!tr || !trPro) return;
                let freeHtml = '<div class="pass-label">GRATUIT</div>';
                let proHtml = '<div class="pass-label">PRO üëë</div>';
                
                // MISE √Ä JOUR : Correction du bug pStats is not defined
                const getRewardDisplay = (rewardString) => {
                    const [type, value] = rewardString.split(':');
                    const val = parseInt(value) || 1;
                    let icon = 'üéÅ', text = '';
                    if(type === 'coins') { icon = 'ü™ô'; text = `+${val} Pi√®ces`; }
                    else if(type === 'gems') { icon = 'üíé'; text = `+${val} Gemmes`; }
                    else if(type === 'box' || type === 'mega_caisse_loot') { icon = 'üì¶'; text = 'Caisse'; }
                    else if(type.startsWith('emote')) { icon = EMOTE_LIST.find(e => e.id === type.split(':')[1])?.i || 'üòÄ'; text = 'Emote'; }
                    else if(type.startsWith('skin')) { icon = 'üëï'; text = 'Skin Rare'; }
                    return { icon, text };
                };
                // FIN MISE √Ä JOUR
                
                for(let i=1; i<=50; i++) {
                    const freeRwdStr = getPassReward(i, false);
                    const proRwdStr = getPassReward(i, true);
                    
                    const displayF = getRewardDisplay(freeRwdStr);
                    const displayP = getRewardDisplay(proRwdStr);
                    
                    let claimedF = USER.pass.claimed.includes(i);
                    let claimedP = USER.pass.claimedPro.includes(i);
                    let unlocked = USER.pass.tier >= i;
                    let proLocked = !USER.mPassPro;
                    let freeState = claimedF ? 'claimed' : (unlocked ? 'active cursor-pointer' : 'locked');
                    let proState = claimedP ? 'claimed' : ((unlocked && !proLocked) ? 'active cursor-pointer pro' : 'locked pro');
                    let fnF = (unlocked && !claimedF) ? `onclick="window.ui.claimPass(${i}, false, '${freeRwdStr}')"` : '';
                    let fnP = (unlocked && !claimedP && !proLocked) ? `onclick="window.ui.claimPass(${i}, true, '${proRwdStr}')"` : (proLocked ? `onclick="window.ui.notif('ACH√àTE LE PASS PRO !', '#a855f7')"` : '');
                    
                    // Contenu avec coche verte si r√©cup√©r√©
                    let contentF = claimedF ? `<div class="check-mark">‚úÖ</div>` : '';
                    contentF += `<div class="text-4xl mb-2 ${claimedF ? 'opacity-20' : ''}">${displayF.icon}</div>
                                 <div class="text-[10px] font-bold ${claimedF ? 'opacity-50' : ''}">${displayF.text}</div>`;

                    let contentP = claimedP ? `<div class="check-mark">‚úÖ</div>` : '';
                    contentP += `<div class="text-4xl mb-2 ${claimedP ? 'opacity-20' : ''}">${displayP.icon}</div>
                                 <div class="text-[10px] font-bold ${claimedP ? 'opacity-50' : ''}">${displayP.text}</div>`;

                    freeHtml += `
                        <div id="pass-free-tier-${i}" class="pass-step ${freeState} shrink-0 mx-2" ${fnF}>
                            <div class="tier-badge">PALIER ${i}</div>
                            ${contentF}
                        </div>`;
                    proHtml += `
                        <div id="pass-pro-tier-${i}" class="pass-step ${proState} shrink-0 mx-2" ${fnP}>
                            <div class="tier-badge">PALIER ${i}</div>
                            ${contentP}
                        </div>`;
                }
                tr.innerHTML = freeHtml;
                trPro.innerHTML = proHtml;

                // FIX SCROLL: Forcer le d√©filement jusqu'au palier actuel pour une meilleure UX
                const scrollContainer = el('pass-scroll-container');
                const currentTierIndex = USER.pass.tier;

                if (scrollContainer) {
                    const freeRow = el('pass-track-free');
                    // Le premier enfant (index 0) est le label. Le tier N est √† l'index N.
                    if (freeRow && currentTierIndex > 0) {
                        // Cible: le dernier palier atteint (m√™me si c'est le 50)
                        const targetTier = Math.min(50, currentTierIndex);
                        // On trouve le palier actuellement le plus √©lev√© r√©clam√© (ou le dernier d√©bloqu√©)
                        const lastClaimedFree = USER.pass.claimed.length > 0 ? Math.max(...USER.pass.claimed) : 1;
                        const scrollTier = Math.min(50, Math.max(lastClaimedFree, currentTierIndex));

                        const targetElement = freeRow.querySelector(`#pass-free-tier-${scrollTier}`);
                        
                        if (targetElement) {
                             // Calculer la position pour centrer l'√©l√©ment √† l'√©cran
                             // targetElement.offsetLeft est relatif au conteneur pass-row
                            const centerOffset = targetElement.offsetLeft - (scrollContainer.offsetWidth / 2) + (targetElement.offsetWidth / 2);
                            
                            // Mettre √† jour le scroll en utilisant scrollLeft pour le d√©filement horizontal
                            scrollContainer.scrollLeft = centerOffset;
                        }
                    }
                }
                
                // Mise √† jour de la stat de palier max
                USER.stats.maxPassTier = Math.max(USER.stats.maxPassTier || 1, USER.pass.tier);
                Storage.save();
            },
            renderLists() {
                const currentMode = (window.game && window.game.conf) ? window.game.conf.mode : 'survival';
                const currentArena = (window.game && window.game.conf) ? window.game.conf.arena : 'tokyo';
                
                // NOUVEAU: Utiliser la liste tri√©e
                const sortedStarters = sortStartersByRarity();

                const sl = el('list-starters'); sl.innerHTML = '';
                Object.keys(sortedStarters).forEach(k => {
                    const s = sortedStarters[k], unlocked = USER.unlocked.includes(k), lvl = USER.levels[k]||1, active = USER.selected === k ? 'border-blue-500 bg-blue-900/20' : 'bg-white/5 border-white/5';
                    const rarity = RARITY[s.rarity] || RARITY.common;
                    const borderColor = active.includes('border-blue-500') ? '' : `border-color: ${rarity.color}40;`;
                    const bgStyle = active.includes('bg-blue-900') ? '' : `background: linear-gradient(135deg, ${rarity.color}10, rgba(255,255,255,0.02));`;
                    sl.innerHTML += `<div onclick="window.ui.openHeroDetails('${k}')" style="${borderColor} ${bgStyle}" class="glass-panel p-4 cursor-pointer active:scale-95 transition ${active} ${unlocked?'':'locked'} relative group border flex flex-col items-center text-center">
                        <div class="absolute top-2 right-2 px-2 py-0.5 rounded text-[8px] font-bold uppercase tracking-wider text-white shadow-sm" style="background-color:${rarity.color}">${rarity.name}</div>
                        <div class="w-12 h-12 rounded-xl bg-black/40 flex items-center justify-center text-3xl mb-2">${s.icon}</div>
                        <div class="font-black text-sm uppercase tracking-wider" style="color:${rarity.color}">${s.name}</div>
                        <div class="text-[10px] text-gray-400 leading-tight mb-2 h-6 overflow-hidden">${s.desc}</div>
                        <div class="text-[9px] font-bold text-blue-300 mb-1">Niv. ${lvl}</div>
                    </div>`;
                });
                const ml = el('list-modes'); ml.innerHTML = ''; 
                Object.keys(MODES).forEach(k => { 
                    const m = MODES[k]; 
                    const specialClass = m.special ? 'season-gold' : 'bg-white/5 border-white/5'; 
                    const active = currentMode === k ? 'border-purple-500 bg-purple-900/20' : specialClass; 
                    ml.innerHTML += `<div onclick="window.game.setMode('${k}')" class="glass-panel p-4 cursor-pointer flex items-center gap-4 ${active} active:scale-95 transition border"><div class="text-4xl p-2 bg-black/30 rounded-full icon-box">${m.icon}</div><div class="text-left flex-1"><div class="font-black text-lg">${m.name}</div><div class="text-xs text-gray-400">${m.desc}</div></div><div class="text-2xl text-gray-600">‚ûú</div></div>`; 
                }); 
                const al = el('list-arenas'); al.innerHTML = ''; 
                Object.keys(ARENAS).forEach(k => { 
                    const a = ARENAS[k]; 
                    const specialClass = a.special ? 'season-gold text-yellow-100' : 'bg-white/5 border-white/5 text-gray-400'; 
                    const active = currentArena === k ? 'border-green-500 bg-green-900/20 text-white' : specialClass; 
                    al.innerHTML += `<div onclick="window.game.setArena('${k}')" class="glass-panel p-3 cursor-pointer text-center ${active} active:scale-95 transition border font-bold text-xs uppercase tracking-widest">${a.name}</div>`; 
                });
            },
            openHeroDetails(k) {
                const s = STARTERS[k];
                const unlocked = USER.unlocked.includes(k);
                const lvl = USER.levels[k] || 1;
                const rarity = RARITY[s.rarity] || RARITY.common;
                const rBadge = el('hd-rarity');
                if(rBadge) {
                    rBadge.innerText = rarity.name;
                    rBadge.style.backgroundColor = rarity.color;
                    rBadge.style.color = '#000'; 
                    rBadge.style.boxShadow = `0 0 10px ${rarity.color}`;
                }
                setText('hd-icon', s.icon); setText('hd-name', s.name); setText('hd-lvl', "NIVEAU " + lvl); setText('hd-desc', s.lore || s.desc); setText('hd-gadget-name', getGadgetName(s.gadget)); setText('hd-passive', s.passive || "Aucun");
                
                // NOUVEAU : Affichage des stats d√©taill√©es
                const maxHp = 600, maxDmg = 150, maxSpd = 10;
                const statsData = [
                    { label: 'SANT√â', base: s.hp, scale: s.scale.hp, max: maxHp, color: 'bg-green-500' },
                    { label: 'D√âG√ÇTS', base: s.dmg, scale: s.scale.dmg, max: maxDmg, color: 'bg-red-500' },
                    // La vitesse n'augmente pas par niveau, mais on affiche sa valeur
                    { label: 'VITESSE', base: s.spd, scale: 0, max: maxSpd, color: 'bg-yellow-400' } 
                ];

                let statsHTML = '';
                const currentSpd = s.spd; // Vitesse actuelle (d√©j√† mise √† l'√©chelle dans STARTERS)
                
                statsData.forEach(stat => {
                    const rawBase = stat.base;
                    const gainText = stat.scale > 0 ? `<span class="text-green-400">(+${stat.scale}/Niv)</span>` : '';
                    let currentValue = rawBase + stat.scale * (lvl - 1);
                    
                    if (stat.label === 'VITESSE') {
                        currentValue = parseFloat(currentSpd.toFixed(2)); // Afficher la vitesse apr√®s r√©duction
                    } else {
                        currentValue = Math.floor(currentValue);
                    }

                    const barWidth = (currentValue / stat.max) * 100;
                    
                    statsHTML += `
                        <div class="stat-row flex flex-col">
                            <div class="flex justify-between items-end mb-1">
                                <div class="stat-label text-sm text-gray-400 uppercase font-bold">${stat.label}</div>
                                <div class="text-sm font-black text-white">${currentValue} ${gainText}</div>
                            </div>
                            <div class="stat-track h-2 bg-gray-800 rounded-full overflow-hidden">
                                <div class="stat-fill h-full ${stat.color} transition-all duration-300" style="width: ${Math.min(100, barWidth)}%;"></div>
                            </div>
                        </div>
                    `;
                });
                el('hero-stats-container').innerHTML = statsHTML;
                // FIN NOUVEAU

                const skinsContainer = el('hd-skins-list');
                skinsContainer.innerHTML = '';
                if(s.skins) {
                    s.skins.forEach(skin => {
                        const fullSkinId = `${k}_${skin.id}`;
                        const isOwned = skin.id === 'default' || (USER.ownedSkins && USER.ownedSkins.includes(fullSkinId));
                        const isSelected = (USER.skins && USER.skins[k] === skin.id) || (skin.id === 'default' && !USER.skins[k]);
                        const style = isSelected ? 'border-yellow-400 bg-yellow-900/30' : (isOwned ? 'border-white/20 bg-white/5' : 'border-gray-700 bg-black/50 grayscale');
                        const priceDisplay = skin.price ? `${skin.price}ü™ô` : 'Gratuit';
                        const actionText = isOwned ? (isSelected?'√âQUIP√â':'METTRE') : priceDisplay;
                        const clickAction = isOwned ? `window.ui.equipSkin('${k}', '${skin.id}')` : `window.ui.buySkin('${k}', '${skin.id}', ${skin.price})`;
                        skinsContainer.innerHTML += `<div onclick="${clickAction}" class="w-16 h-16 rounded-lg border-2 ${style} flex flex-col items-center justify-center cursor-pointer shrink-0"><div class="text-2xl" style="color:${skin.c}">${s.icon}</div><div class="text-[8px] font-bold mt-1">${actionText}</div></div>`;
                    });
                }
                
                const actions = el('hd-actions');
                if(unlocked) {
                    const upgradeCost = lvl * 150;
                    if(lvl >= 10) { actions.innerHTML = `<button onclick="window.game.setStarter('${k}'); document.getElementById('hero-details-modal').classList.add('hidden')" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl">S√âLECTIONNER</button><button class="w-full max-level font-bold py-3 rounded-xl flex justify-center items-center gap-2 cursor-default border border-yellow-500/50 text-yellow-500 bg-yellow-900/20">NIVEAU MAX</button>`; }
                    else { actions.innerHTML = `<button onclick="window.game.setStarter('${k}'); window.ui.openHeroDetails('${k}')" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl">S√âLECTIONNER</button><button onclick="window.ui.upgrade('${k}'); window.ui.openHeroDetails('${k}')" class="w-full bg-green-600/80 hover:bg-green-500 text-white font-bold py-3 rounded-xl flex justify-center items-center gap-2">AM√âLIORER <span class="bg-black/20 px-2 rounded text-xs">${upgradeCost} ü™ô</span></button>`; }
                } else { 
                    actions.innerHTML = `<button onclick="window.ui.unlock('${k}'); document.getElementById('hero-details-modal').classList.add('hidden')" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 rounded-xl flex justify-center items-center gap-2 text-lg">ACHETER <span class="bg-black/20 px-3 py-1 rounded text-sm">${s.price} ü™ô</span></button>`; 
                }
                el('hero-details-modal').classList.remove('hidden');
            },
            equipSkin(heroId, skinId) { if(!USER.skins) USER.skins = {}; USER.skins[heroId] = skinId; Storage.save(); this.openHeroDetails(heroId); },
            buySkin(heroId, skinId, price) { if(USER.coins >= price) { USER.coins -= price; if(!USER.ownedSkins) USER.ownedSkins = []; USER.ownedSkins.push(`${heroId}_${skinId}`); this.notif("SKIN D√âBLOQU√â !", "#facc15"); this.equipSkin(heroId, skinId); } else { this.notif("PAS ASSEZ DE PI√àCES !", "#ef4444"); } },
            renderProfile() { 
                el('profile-name').value = USER.name; 
                setText('profile-tag', USER.tag); 
                
                // HANDLE CUSTOM IMAGE OR EMOJI
                const avatarContainer = el('profile-avatar');
                avatarContainer.innerHTML = ''; // Clear existing content
                if(USER.avatar.startsWith('data:image')) {
                    avatarContainer.innerHTML = `<img src="${USER.avatar}" class="avatar-img rounded-full">`;
                    avatarContainer.classList.remove('text-4xl');
                } else {
                    avatarContainer.innerHTML = USER.avatar;
                    avatarContainer.classList.add('text-4xl');
                }
                
                let totalLvl = Object.values(USER.levels).reduce((a,b)=>a+b, 0); 
                setText('profile-lvl', "LVL " + totalLvl); 
            },
            openAvatarSelector() { const grid = el('avatar-grid'); grid.innerHTML = ''; ICONS.forEach(icon => { grid.innerHTML += `<button onclick="window.ui.selectAvatar('${icon}')" class="w-14 h-14 text-3xl bg-white/10 hover:bg-blue-600 rounded-xl transition flex items-center justify-center border border-white/10">${icon}</button>`; }); el('avatar-selector').classList.remove('hidden'); },
            selectAvatar(icon) { USER.avatar = icon; Storage.save(); el('avatar-selector').classList.add('hidden'); this.renderProfile(); },
            
            uploadAvatar(input) {
                if (input.files && input.files[0]) {
                    const file = input.files[0];
                    if (file.size > 500000) { // Limit size to 500KB
                        this.notif("IMAGE TROP GRANDE (MAX 500KB)!", "#ef4444");
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        USER.avatar = e.target.result;
                        Storage.save();
                        window.ui.renderProfile();
                        el('avatar-selector').classList.add('hidden');
                    }
                    reader.readAsDataURL(file);
                }
            },

            renderEmotes() { 
                const list = el('list-emotes'); 
                list.innerHTML = ''; 
                const equipped = el('equipped-emotes'); 
                equipped.innerHTML = ''; 
                // FIX: La limite est maintenant √† 8
                const maxEquipped = 8; 

                USER.equippedEmotes.forEach(id => { 
                    const e = EMOTE_LIST.find(em => em.id === id); 
                    equipped.innerHTML += `<div class="w-12 h-12 bg-black/40 rounded-lg flex items-center justify-center text-2xl border border-blue-500/50 relative group cursor-pointer" onclick="window.ui.unequipEmote('${id}')">${e?.i || '‚ùì'}<div class="emote-remove-btn">√ó</div></div>`; 
                }); 
                
                // Slots vides
                for(let i=USER.equippedEmotes.length; i < maxEquipped; i++) {
                     equipped.innerHTML += `<div class="w-12 h-12 bg-gray-900/50 rounded-lg flex items-center justify-center text-xl border border-gray-700/50 text-gray-700">#${i+1}</div>`;
                }

                EMOTE_LIST.forEach(e => { 
                    const unlocked = USER.emotes.includes(e.id); 
                    const selected = USER.equippedEmotes.includes(e.id); 
                    const priceTag = unlocked ? '' : `<div class="absolute bottom-1 right-1 text-[8px] font-bold bg-black/50 px-1 rounded text-purple-400">${e.price}üíé</div>`; 
                    const clickAction = unlocked ? `window.ui.equipEmote('${e.id}')` : `window.ui.buyEmote('${e.id}', ${e.price})`; 
                    list.innerHTML += `<div onclick="${clickAction}" class="emote-grid-item ${unlocked ? 'unlocked' : 'locked'} ${selected ? 'selected' : ''}">${e.i}${priceTag}</div>`; 
                }); 
            },
            unequipEmote(id) { USER.equippedEmotes = USER.equippedEmotes.filter(e => e !== id); Storage.save(); this.renderEmotes(); this.toggleEmoteWheel(); },
            equipEmote(id) { 
                const maxEquipped = 8; // La nouvelle limite
                if(USER.equippedEmotes.includes(id)) { 
                    USER.equippedEmotes = USER.equippedEmotes.filter(e => e !== id); 
                } else { 
                    if(USER.equippedEmotes.length < maxEquipped) {
                        USER.equippedEmotes.push(id); 
                    } else {
                        this.notif("SLOTS PLEINS (Max 8) !", "#ef4444"); 
                    }
                } 
                Storage.save(); this.renderEmotes(); 
            },
            buyEmote(id, price) { if(USER.gems >= price) { USER.gems -= price; USER.emotes.push(id); Storage.save(); this.notif("EMOTE D√âBLOQU√âE!", "#a855f7"); this.renderEmotes(); this.updateMenu(); } else { this.notif("PAS ASSEZ DE GEMMES!", "#ef4444"); } },
            toggleEmoteWheel() { const wheel = el('emote-wheel'); if(wheel.classList.contains('hidden')) { wheel.innerHTML = ''; USER.equippedEmotes.forEach(id => { const e = EMOTE_LIST.find(em => em.id === id); wheel.innerHTML += `<div onclick="window.ui.triggerEmote('${e.i}'); window.ui.toggleEmoteWheel()" class="emote-btn">${e.i}</div>`; }); wheel.classList.remove('hidden'); } else { wheel.classList.add('hidden'); } },
            triggerEmote(emoji) { window.game.player.emote = emoji; window.game.player.emoteTimer = 120; },
            updateMenu() {
                // FIX: Ensure game exists before accessing properties to prevent crash on early load
                const confMode = (typeof window.game !== 'undefined' && window.game.conf) ? window.game.conf.mode : 'survival';
                const m = MODES[confMode];
                
                const s = STARTERS[USER.selected];
                
                // Gestion des animations de gain (non persistantes, elles sont sur set/add)
                
                setText('top-coins', USER.coins); setText('top-gems', USER.gems); setText('menu-trophies', USER.trophies);
                let rIdx = 0; for(let i=0; i<RANKS.length; i++) { if(USER.trophies >= RANKS[i].t) rIdx = i; }
                const currRank = RANKS[rIdx], nextRank = RANKS[rIdx+1];
                const re = el('menu-rank'); if(re) { re.innerText = currRank.n; re.style.backgroundImage = `linear-gradient(to right, #fff, ${currRank.c})`; }
                if(nextRank) { const diff = nextRank.t - USER.trophies, range = nextRank.t - currRank.t, done = USER.trophies - currRank.t, pct = Math.min(100, Math.max(0, (done / range) * 100)); setText('rank-progress-text', `Encore ${diff} üèÜ avant ${nextRank.n}`); setText('rank-progress-pct', Math.floor(pct) + '%'); setStyle('rank-progress-fill', 'width', pct + '%'); } else { setText('rank-progress-text', "RANG MAXIMUM !"); setText('rank-progress-pct', "100%"); setStyle('rank-progress-fill', 'width', '100%'); }
                setText('play-starter', s.name); setText('play-icon', s.icon); setText('play-lvl', "Niveau "+(USER.levels[USER.selected]||1));
                setText('play-mode', m.name); setText('play-mode-icon', m.icon);
                this.updateDifficultyButtons(); 
            },
            updateStats() { 
                setText('stat-kills', USER.stats.kills); 
                setText('stat-wave', USER.stats.maxWave); 
                setText('stat-games', USER.stats.games); 
                setText('stat-wins', USER.stats.wins); 
                setText('stat-dmg', Math.floor(USER.stats.dmg/1000)+"k"); 
                // Nouvelle stats
                setText('stat-losses', USER.stats.games - USER.stats.wins); // D√©faites
                setText('stat-unlocked', `${USER.unlocked.length}/${Object.keys(STARTERS).length}`); // H√©ros d√©bloqu√©s (mis √† jour √† 25)
                setText('stat-pass-tier', USER.stats.maxPassTier || 1); // Palier Pass Max
            },
            unlock(k) { const s = STARTERS[k]; if(USER.coins >= s.price) { USER.coins -= s.price; USER.unlocked.push(k); USER.selected = k; Storage.save(); this.notif(`D√âBLOQU√â!`, "#22c55e"); this.renderLists(); this.updateMenu(); } else this.notif("PAS ASSEZ!", "#ef4444"); },
            upgrade(k) { const cost = (USER.levels[k]||1) * 150; if(USER.coins >= cost) { USER.coins -= cost; USER.levels[k]++; Storage.save(); this.notif(`NIVEAU UP!`, "#3b82f6"); this.renderLists(); this.updateMenu(); } else this.notif("PAS ASSEZ!", "#ef4444"); },
            claimDaily() { 
                USER.coins += 200; 
                USER.lastDaily = Date.now(); 
                Storage.save(); 
                this.notif("+200 ü™ô", "#eab308"); 
                el('top-coins').closest('.currency-badge').classList.add('flash-coins');
                setTimeout(() => el('top-coins').closest('.currency-badge').classList.remove('flash-coins'), 300);
                this.renderLists(); 
                this.updateMenu(); 
                this.renderShop(); 
            },
            buy(t, cost, curr) { let ok = false; if(curr === 'free') ok = true; else if(curr === 'coins' && USER.coins >= cost) { USER.coins -= cost; ok = true; } else if(curr === 'gems' && USER.gems >= cost) { USER.gems -= cost; ok = true; } if(ok) { if(t==='box'){ const r=Math.random(); if(r<0.8){const c=50+Math.floor(Math.random()*100);USER.coins+=c;this.notif(`+${c} ü™ô`,"#eab308");} else{const g=2+Math.floor(Math.random()*5);USER.gems+=g;this.notif(`+${g} üíé`,"#a855f7");} } else if(t==='coins') { USER.coins += 300; this.notif("+300 ü™ô","#eab308"); } else if(t==='gems') { USER.gems += 30; this.notif("+30 üíé","#a855f7"); } 
                
                // Trigger flash on manual purchase/gain
                if (t === 'coins') { el('top-coins').closest('.currency-badge').classList.add('flash-coins'); setTimeout(() => el('top-coins').closest('.currency-badge').classList.remove('flash-coins'), 300); }
                if (t === 'gems') { el('top-gems').closest('.currency-badge').classList.add('flash-gems'); setTimeout(() => el('top-gems').closest('.currency-badge').classList.remove('flash-gems'), 300); }
                
                Storage.save(); this.updateMenu(); this.renderShop(); } else this.notif("PAS ASSEZ!", "#ef4444"); },
            buySpecial(idx) { 
                const item = USER.shop.items[idx]; if(!item) return; 
                let ok = false; 
                const actualCost = item.realCost || item.cost; 
                
                // 1. V√©rification du co√ªt et soustraction
                if(item.curr === 'free') {
                    ok = true;
                } else if(item.curr === 'coins') { 
                    if (USER.coins >= actualCost) { USER.coins -= actualCost; ok = true; }
                } else if(item.curr === 'gems') { 
                    if (USER.gems >= actualCost) { USER.gems -= actualCost; ok = true; } 
                } 

                if(ok) { 
                    // 2. Attribution de la r√©compense
                    // FIX: Les gains ne doivent pas √™tre soustraits
                    if(item.type==='gems') { 
                        USER.gems += item.val; 
                        this.notif(`+${item.val} üíé`, "#a855f7"); 
                        el('top-gems').closest('.currency-badge').classList.add('flash-gems'); setTimeout(() => el('top-gems').closest('.currency-badge').classList.remove('flash-gems'), 300); 
                    } 
                    if(item.type==='coins') { 
                        USER.coins += item.val; 
                        this.notif(`+${item.val} ü™ô`, "#eab308"); 
                        el('top-coins').closest('.currency-badge').classList.add('flash-coins'); setTimeout(() => el('top-coins').closest('.currency-badge').classList.remove('flash-coins'), 300); 
                    } 
                    if(item.type==='xp') { USER.pass.xp += item.val; this.notif(`+${item.val} XP`, "#facc15"); while(USER.pass.xp >= 100) { if(USER.pass.tier < 50) { USER.pass.tier++; USER.pass.xp -= 100; window.ui.notif("PASS LEVEL UP!", "#facc15"); } else { USER.pass.xp = 100; break; } } } 
                    if(item.type==='box') { this.buy('box', 0, 'free'); } 
                    if(item.type==='skin') { 
                        if(!USER.ownedSkins) USER.ownedSkins = []; 
                        const heroKey = Object.keys(STARTERS).find(k => STARTERS[k].name === item.hero); 
                        if(heroKey) { 
                            USER.ownedSkins.push(`${heroKey}_${item.skinId}`); 
                            this.notif(`SKIN ${item.name} OBTENU !`, "#facc15"); 
                        } 
                    } 
                    
                    // 3. Suppression de l'offre
                    USER.shop.items.splice(idx, 1); 
                    
                    Storage.save(); this.updateMenu(); this.renderShop(); this.renderPass(); 
                } else {
                    this.notif("PAS ASSEZ!", "#ef4444");
                }
            },
            buyPassPro() { 
                // NOUVEAU PRIX PASS PRO (159)
                if(USER.gems >= 159) { 
                    USER.gems -= 159; 
                    USER.mPassPro = true; 
                    this.notif("PASS PRO ACTIV√â !", "#facc15"); 
                    el('top-gems').closest('.currency-badge').classList.add('flash-gems'); setTimeout(() => el('top-gems').closest('.currency-badge').classList.remove('flash-gems'), 300);
                    Storage.save(); 
                    this.updateMenu(); 
                    this.renderPass(); 
                } else { 
                    this.notif("PAS ASSEZ DE GEMMES ! (159 üíé)", "#ef4444"); 
                } 
            },
            claimPass(tier, isPro, rewardString) { const hasPass = isPro ? USER.mPassPro : true; const alreadyClaimed = isPro ? USER.pass.claimedPro.includes(tier) : USER.pass.claimed.includes(tier); if(USER.pass.tier >= tier && hasPass && !alreadyClaimed) { if (processPassReward(rewardString)) { if(isPro) USER.pass.claimedPro.push(tier); else USER.pass.claimed.push(tier); Storage.save(); this.renderPass(); this.updateMenu(); } else { this.notif("Erreur R√©compense", "#ff0000"); } } },
            exportSave() { const data = btoa(JSON.stringify(USER)); navigator.clipboard.writeText(data).then(() => this.notif("CODE COPI√â !", "#22c55e")); },
            importSave() { 
                const code = prompt("Colle ton code de sauvegarde ici:"); 
                if(code) { 
                    try { 
                        const data = JSON.parse(atob(code)); 
                        // Simple structure check
                        if(data && data.name && data.coins !== undefined) {
                            USER = data; 
                            Storage.save(); 
                            location.reload(); 
                        } else {
                            this.notif("CODE INVALIDE !", "#ef4444");
                        }
                    } catch(e) { 
                        this.notif("CODE INVALIDE !", "#ef4444"); 
                    } 
                } 
            }
        };

        const Input={k:{},jL:{a:0,x:0,y:0,i:null},jR:{a:0,x:0,y:0,i:null},m:{x:0,y:0,d:0},init(){ 
            window.addEventListener('keydown',e=>{this.k[e.code]=1;if(e.code==='Space')window.game.player?.dash();if(e.code==='KeyE')window.game.player?.useGadget();if(e.code==='KeyV'){window.ui.toggleEmoteWheel();}}); 
            window.addEventListener('keyup',e=>this.k[e.code]=0); 
            window.addEventListener('mousemove',e=>{this.m.x=e.clientX;this.m.y=e.clientY;}); 
            window.addEventListener('mousedown',()=>this.m.d=1); 
            window.addEventListener('mouseup',()=>this.m.d=0); 
            const z=el('mobile-controls'); 
            const leftBase = el('stick-left-base');
            const rightBase = el('stick-right-base');
            
            // Calculate base centers for touch processing
            const getCenter = (el) => {
                const rect = el.getBoundingClientRect();
                return { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 };
            };

            const h=(e, isEnd)=>{ 
                if(e.target.tagName !== 'BUTTON') e.preventDefault(); 
                let lf=false, rf=false; 
                const W=window.innerWidth;
                const L_CENTER = getCenter(leftBase);
                const R_CENTER = getCenter(rightBase);

                for(let i=0;i<e.touches.length;i++){ 
                    const t=e.touches[i],x=t.clientX,y=t.clientY; 
                    
                    // Check if touch is near the left joystick area
                    if(Math.hypot(x - L_CENTER.x, y - L_CENTER.y) < 150) { 
                        lf=true; 
                        const d=Math.min(60, Math.hypot(x-L_CENTER.x, y-L_CENTER.y)); 
                        const a=Math.atan2(y-L_CENTER.y, x-L_CENTER.x); 
                        const k=document.querySelector('#stick-left-base .stick-knob'); 
                        if(k) k.style.transform=`translate(-50%,-50%) translate(${Math.cos(a)*d}px,${Math.sin(a)*d}px)`; 
                        if(d>5){ 
                            this.jL.x=Math.cos(a)*d/60; 
                            this.jL.y=Math.sin(a)*d/60; 
                            this.jL.a=1; 
                        } 
                    }
                    
                    // Check if touch is near the right joystick/action area
                    if(Math.hypot(x - R_CENTER.x, y - R_CENTER.y) < 150) { 
                        rf=true; 
                        const d=Math.min(60, Math.hypot(x-R_CENTER.x, y-R_CENTER.y)); 
                        const a=Math.atan2(y-R_CENTER.y, x-R_CENTER.x); 
                        const k=document.querySelector('#stick-right-base .stick-knob'); 
                        if(k) k.style.transform=`translate(-50%,-50%) translate(${Math.cos(a)*d}px,${Math.sin(a)*d}px)`; 
                        if(d>5){ 
                            this.jR.x=Math.cos(a)*d/60; 
                            this.jR.y=Math.sin(a)*d/60; 
                            this.jR.a=1; 
                        } 
                    }
                } 
                if(!lf){ 
                    this.jL.x=0;this.jL.y=0;this.jL.a=0; 
                    const k=document.querySelector('#stick-left-base .stick-knob'); 
                    if(k) k.style.transform=`translate(-50%,-50%)`; 
                } 
                if(!rf){ 
                    this.jR.x=0;this.jR.y=0;this.jR.a=0; 
                    const k=document.querySelector('#stick-right-base .stick-knob'); 
                    if(k) k.style.transform=`translate(-50%,-50%)`; 
                } 
            }; 
            z.addEventListener('touchstart',e=>h(e,false),{passive:false}); 
            z.addEventListener('touchmove',e=>h(e,false),{passive:false}); 
            z.addEventListener('touchend',e=>h(e,true)); 
        }};
        class Entity{constructor(x,y,r,c){this.x=x;this.y=y;this.r=r;this.c=c;this.dead=false; this.hitTimer = 300;} draw(ctx){ ctx.save(); ctx.translate(this.x, this.y); let isHidden = false; if (window.game.map) { for(let w of window.game.map) { if(w.type === 1 && ColRect(this, w)) { isHidden = true; break; } } } if(isHidden && this === window.game.player) { ctx.fillStyle = 'rgba(255, 255, 255, 0.8)'; ctx.font = "20px Arial"; ctx.fillText("üëÅÔ∏è", -10, -this.r - 10); ctx.beginPath(); ctx.moveTo(-10, -this.r - 5); ctx.lineTo(10, -this.r - 25); ctx.strokeStyle = 'red'; ctx.lineWidth = 2; ctx.stroke(); } if(isHidden) ctx.globalAlpha = 0.5; ctx.shadowColor = 'rgba(0,0,0,0.5)'; ctx.shadowBlur = 15; ctx.beginPath(); ctx.arc(0, 0, this.r, 0, Math.PI*2); ctx.fillStyle = this.c; ctx.fill(); ctx.shadowBlur = 0; ctx.beginPath(); ctx.arc(-5, -5, this.r*0.3, 0, Math.PI*2); ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.fill(); ctx.globalAlpha = 1; if(this.emoteTimer > 0) { ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(0, -this.r - 30, 20, 0, Math.PI*2); ctx.fill(); ctx.font = "24px Arial"; ctx.fillStyle = 'black'; ctx.textAlign = 'center'; ctx.fillText(this.emote, 0, -this.r - 22); this.emoteTimer--; } ctx.restore(); }}
        class Wall{constructor(x,y,w,h,t){this.x=x;this.y=y;this.w=w;this.h=h;this.type=t;} draw(ctx,c){ 
            // Ambiance ombre sous les murs
            ctx.save();
            ctx.fillStyle = '#0f172a'; ctx.fillRect(this.x, this.y + this.h, this.w, 20); // Ombre port√©e
            ctx.fillStyle = c; 
            ctx.shadowColor = 'black'; ctx.shadowBlur = 10; 
            ctx.fillRect(this.x, this.y, this.w, this.h); 
            ctx.shadowBlur = 0; 
            ctx.fillStyle = 'rgba(255,255,255,0.05)'; 
            ctx.fillRect(this.x, this.y, this.w, 5);
            ctx.restore();
            
            if(this.type===1){
                ctx.fillStyle='rgba(34,197,94,0.9)';
                ctx.strokeStyle='#15803d';ctx.lineWidth=4;ctx.strokeRect(this.x,this.y,this.w,this.h);
                // Rendu des buissons plus vifs
                ctx.fillStyle='rgba(34,197,94,0.7)';
                ctx.fillRect(this.x,this.y,this.w,this.h);
                return;
            } 
            const h = 20; 
            ctx.fillStyle = '#0f172a'; 
            ctx.fillRect(this.x, this.y + this.h, this.w, h); 
            ctx.fillStyle = c; 
            ctx.shadowColor = 'black'; 
            ctx.shadowBlur = 10; 
            ctx.fillRect(this.x, this.y, this.w, this.h); 
            ctx.shadowBlur = 0; 
            ctx.fillStyle = 'rgba(255,255,255,0.05)'; 
            ctx.fillRect(this.x, this.y, this.w, 5); 
        } 
        collide(e){return e.x+e.r>this.x&&e.x-e.r<this.x+this.w&&e.y+e.r>this.y&&e.y-e.r<this.y+this.h;}}
        class Player extends Entity{ constructor(k){ 
            const s=STARTERS[k], l=(USER.levels[k]||1)-1; 
            let c = s.color; 
            if(USER.skins && USER.skins[k]) { const skinId = USER.skins[k]; const heroSkinList = STARTERS[k]?.skins; if(skinId !== 'default' && heroSkinList) { const skinObj = heroSkinList.find(sk => sk.id === skinId); if(skinObj) c = skinObj.c; } } 
            super(window.game.world/2,window.game.world/2,20,c); 
            this.stats={...s}; 
            this.stats.hp+=s.scale.hp*l; 
            this.stats.dmg+=s.scale.dmg*l; 
            this.hp=this.stats.hp; 
            this.maxHp=this.stats.hp; 
            this.xp=0;this.xpMax=100;this.lvl=1;this.super=0;this.cd=0;this.dashT=0;this.angle=0;
            // FIX 1: Initialize ammo based on hero stats
            this.ammo=s.ammo;
            this.ammoMax=s.ammo;
            this.reloadT=0;this.gadgetCharges=3;this.cubes=0; 
            this.activeEffects={}; 
            this.isStunned = 0;
            this.passiveTimer = 0; // Timer pour les passifs p√©riodiques (Shaman)
            this.hitTimer = 300; // FIX 2: Timer de r√©g√©n√©ration

            if(window.game.conf.modifier === 'giant') { this.r *= 2; this.maxHp *= 2; this.hp *= 2; }
            if(window.game.conf.modifier === 'oneshot') { this.hp = 1; this.maxHp = 1; } // Force One Shot HP
        } 
        update(){ 
            if (this.isStunned > 0) { this.isStunned--; return; } // Stunned = skip update
            this.hitTimer++; // Incr√©menter le timer de non-hit
            
            let speedMult = 1; 
            if(this.activeEffects.speed > 0) { speedMult = 1.5; this.activeEffects.speed--; } 
            if(window.game.conf.modifier === 'speed') speedMult *= 2; 

            // FIX 2: R√©g√©n√©ration HP apr√®s 5s sans d√©g√¢ts (hitTimer > 300 frames)
            if(this.stats.passive === "Regen Rapide" && window.game.frame % 60 === 0 && this.hitTimer > 300 && window.game.conf.modifier !== 'oneshot') {
                this.hp = Math.min(this.maxHp, this.hp + 50); 
            }
            
            let dx=0,dy=0; 
            if(Input.jL.a){dx=Input.jL.x;dy=Input.jL.y;} else {if(Input.k['KeyW'])dy=-1;if(Input.k['KeyS'])dy=1;if(Input.k['KeyA'])dx=-1;if(Input.k['KeyD'])dx=1;} 
            const l=Math.hypot(dx,dy); 
            // Vitesse de base ajust√©e (base 5.5, ici *1.1 pour un meilleur feeling global)
            const actualSpd = this.stats.spd * speedMult * 1.1; 

            if(l>0.1){if(l>1){dx/=l;dy/=l;} this.move(dx*actualSpd, dy*actualSpd); 
                // Nouvelle fonctionnalit√©: Tra√Æn√©e de mouvement (Particules)
                if (window.game.frame % 2 === 0) {
                    window.game.parts.push({ x: this.x, y: this.y, vx: -dx * 0.5, vy: -dy * 0.5, life: 10, c: this.c, r: 2 });
                }
            } 
            
            if(Input.jR.a){this.angle=Math.atan2(Input.jR.y,Input.jR.x);if(Math.hypot(Input.jR.x,Input.jR.y)>0.5)this.shoot();} 
            else {const wx=Input.m.x+window.game.cam.x, wy=Input.m.y+window.game.cam.y;this.angle=Math.atan2(wy-this.y,wx-this.x);if(Input.m.d)this.shoot();} 
            
            if(this.cd>0)this.cd--; 
            if(this.dashT>0)this.dashT--; 

            // PASSIVE DU SHAMAN : Poison Aura (Feature 2)
            if (this.stats.passive === "Poison Aura") {
                this.passiveTimer++;
                if (this.passiveTimer >= 30) { // Toutes les 0.5 secondes
                    this.passiveTimer = 0;
                    window.game.ents.forEach(e => {
                        if (!e.friend && Dist(this, e) < 150) {
                            e.hp -= 5;
                            e.hitTimer = 0;
                            e.flashColor = '#10b981'; e.flashTimer = 5;
                            window.game.parts.push({x:e.x,y:e.y,vx:Rnd(-2,2),vy:Rnd(-2,2),life:10,c:'#10b981',r:2});
                            if(e.hp<=0 && !e.dead) window.game.kill(e);
                        }
                    });
                }
            }

            if(this.ammo<this.ammoMax){this.reloadT++;if(this.reloadT>this.stats.reload){this.ammo++;this.reloadT=0;}} 
            // FIX 2: R√©g√©n√©ration g√©n√©rale apr√®s 5s sans d√©g√¢ts
            if(window.game.frame%60===0 && this.hp<this.maxHp && this.hitTimer > 300 && window.game.conf.modifier !== 'oneshot') this.hp+=this.maxHp*0.05; 
            
            if(window.game.gasRadius && Dist(this, {x:window.game.world/2, y:window.game.world/2}) > window.game.gasRadius) { this.hp -= 10; this.hitTimer = 0; window.ui.flash(); if(this.hp<=0) window.game.over("Tu√© par le Gaz"); } 
            if(this.activeEffects.poison > 0) { this.hp -= 1; this.activeEffects.poison--; this.hitTimer = 0; if(this.hp<=0) window.game.over("Empoisonn√©"); } 
        } move(dx,dy){const nx=this.x+dx,ny=this.y+dy;let cx=0,cy=0;for(let w of window.game.map){if(w.type===1)continue;if(w.collide({x:nx,y:this.y,r:this.r}))cx=1;if(w.collide({x:this.x,y:ny,r:this.r}))cy=1;}if(!cx)this.x=Math.max(this.r,Math.min(window.game.world-this.r,nx));if(!cy)this.y=Math.max(this.r,Math.min(window.game.world-this.r,ny));} shoot(){ 
            window.game.shake = 2;
            const selectedHero = STARTERS[USER.selected];
            if (selectedHero.name === 'Harpy' && this.cd > 0) {
                 // Harpy a un CD tr√®s court (7), pas besoin de bloquer s'il est bas
            } else if(this.cd>0 || (this.ammo<1 && window.game.conf.modifier !== 'infinite')) {
                return;
            } 

            const pStats = selectedHero.proj;
            
            // Les h√©ros au corps-√†-corps ont une gestion sp√©ciale du CD et des munitions
            if (selectedHero.type === 'melee') {
                this.cd = this.stats.rate; 
                // Le projectile corps-√†-corps a une vie tr√®s courte (1 frame)
                window.game.projs.push({
                    x: this.x + Math.cos(this.angle) * 25, y: this.y + Math.sin(this.angle) * 25,
                    vx: 0, vy: 0, dmg: this.stats.dmg * (1 + this.cubes * 0.1), life: 1,
                    r: pStats.r, c: pStats.color, friend: true, shape: pStats.shape, trailColor: pStats.trailColor, melee: true
                });
                return;
            }

            this.cd = this.stats.rate; 
            if(window.game.conf.modifier !== 'infinite') this.ammo--; 
            this.reloadT = -20; 
            
            const cnt = selectedHero.type === 'shotgun' ? 5 : 1; 
            const spr = selectedHero.type === 'shotgun' ? 0.3 : 0.05; // Spread uniquement pour les shotguns
            
            let dmg = this.stats.dmg * (1 + this.cubes * 0.1);
            let isCrit = this.stats.passive === "Critique +10%" && Math.random() < 0.1;

            if (isCrit) {
                dmg *= 1.5; // D√©g√¢ts critiques +50%
            }
            
            if(window.game.conf.modifier === 'recoil') { this.move(Math.cos(this.angle + Math.PI) * 15, Math.sin(this.angle + Math.PI) * 15); }

            for(let i=0;i<cnt;i++){ 
                const a=this.angle+(Math.random()-0.5)*spr+(i-(cnt-1)/2)*0.1;
                
                window.game.projs.push({
                    x: this.x + Math.cos(this.angle) * 25,
                    y: this.y + Math.sin(this.angle) * 25,
                    vx: Math.cos(a) * pStats.speed,
                    vy: Math.sin(a) * pStats.speed,
                    dmg: dmg,
                    life: pStats.life,
                    r: pStats.r,
                    c: pStats.color,
                    friend: true, 
                    isCrit: isCrit,
                    shape: pStats.shape, // NOUVEAU
                    trailColor: pStats.trailColor // NOUVEAU
                }); 
            } 
        } dash(){ if(this.dashT>0)return; this.dashT=60; window.game.shake=10; const stepSize = 20; const totalDist = 180; const steps = totalDist / stepSize; const dx = Math.cos(this.angle) * stepSize; const dy = Math.sin(this.angle) * stepSize; for(let i=0; i<steps; i++) { this.move(dx, dy); } for(let i=0;i<8;i++)window.game.parts.push({x:this.x,y:this.y,vx:(Math.random()-0.5)*5,vy:(Math.random()-0.5)*5,life:20,c:'#fff',r:4}); } useGadget() { 
            if(this.gadgetCharges <= 0) return; 
            this.gadgetCharges--; 
            window.ui.notif("GADGET!", "#22c55e"); 
            const t=this.stats.gadget; 
            
            if(t==="heal") { this.hp=Math.min(this.maxHp,this.hp+1000); for(let i=0;i<10;i++)window.game.parts.push({x:this.x,y:this.y,vx:Rnd(-2,2),vy:Rnd(-2,2),life:30,c:'#22c55e',r:3}); } 
            if(t==="shield") { this.maxHp+=1000; this.hp+=1000; } 
            if(t==="teleport") { let tx=this.x+Math.cos(this.angle)*300, ty=this.y+Math.sin(this.angle)*300; let cx=false; for(let w of window.game.map){ if(w.type!==1 && w.collide({x:tx,y:ty,r:this.r})) cx=true; } if(!cx) { this.x=tx; this.y=ty; } else window.ui.notif("BLOQU√â !", "#ef4444"); } 
            if(t==="speed") { this.activeEffects.speed = 180; } 
            if(t==="knockback") { for(let e of window.game.ents) { let d = Dist(this, e); if(d < 300) { let a = Math.atan2(e.y-this.y, e.x-this.x); e.x += Math.cos(a)*200; e.y += Math.sin(a)*200; } } } 
            // Feature 8: Nouveau Gadget 'stun'
            if(t==="stun") {
                 for(let e of window.game.ents) { 
                    if(Dist(this, e) < 300) { 
                        e.isStunned = 120; // 2 seconds stun
                        window.game.parts.push({x:e.x,y:e.y,vx:Rnd(-2,2),vy:Rnd(-2,2),life:30,c:'#facc15',r:5}); 
                    } 
                } 
            }
        } draw(ctx){ 
            ctx.save(); 
            ctx.shadowColor = this.c; ctx.shadowBlur = 20; 
            
            // Si le joueur est stun, montrer un effet visuel
            if (this.isStunned > 0) {
                 ctx.shadowColor = '#facc15'; 
                 ctx.shadowBlur = 30;
            }
            
            super.draw(ctx); 
            ctx.translate(this.x,this.y); 
            ctx.rotate(this.angle); 
            ctx.fillStyle='#1e293b'; 
            ctx.fillRect(10,-6,28,12); 
            if(this.reloadT > 0 && window.game.conf.modifier !== 'infinite') { 
                ctx.rotate(-this.angle); 
                ctx.fillStyle = 'white'; 
                ctx.fillRect(-15, 30, 30 * (this.reloadT/this.stats.reload), 3); 
            } 
            ctx.restore(); 
        } }
        class Bot extends Player{ 
            constructor(){ 
                super(USER.selected==='soldier'?'tank':'soldier'); 
                this.c='#ef4444'; 
                this.isBot=true; 
                this.x=100; 
                this.y=100; 
                this.mode='CHASE'; 
                this.target=null; 
                this.isStunned = 0; // Ajout du stun
                this.hitTimer = 300; // FIX 2: Timer de r√©g√©n√©ration
                // Buff PV
                this.hp += ENEMY_HP_BUFF;
                this.maxHp += ENEMY_HP_BUFF;
            } 
            update(){ 
                if (this.isStunned > 0) { this.isStunned--; return; } // Stunned = skip update
                this.hitTimer++; // Incr√©menter le timer de non-hit
                
                if(this.cd>0)this.cd--; 
                const p=window.game.player, d=Dist(this,p); 
                this.angle=Math.atan2(p.y-this.y,p.x-this.x); 
                let playerHidden = false; 
                for(let w of window.game.map) { 
                    if(w.type === 1 && ColRect(window.game.player, w)) { 
                        playerHidden = true; 
                        break; 
                    } 
                } 
                
                // Logique de tir
                if(d < 500 && !playerHidden && this.cd <= 0) {
                    this.shoot();
                } else if(this.mode === 'CHASE' && Math.random()<0.05) {
                    this.shoot();
                }
                
                // Logique de Mouvement (IA Am√©lior√©e)
                let tx,ty; 
                if(this.mode==='CHASE'){ 
                    // Logique d'Esquive/Strafe (IA 2.0)
                    let strafe = Math.sin(window.game.frame * 0.08) * 150; // Strafe plus prononc√©
                    tx = p.x + Math.cos(this.angle + Math.PI/2) * strafe; 
                    ty = p.y + Math.sin(this.angle + Math.PI/2) * strafe; 
                } else if(this.mode==='CHASE_TRAIN') {
                    tx = this.target.x; ty = this.target.y;
                } else { 
                    if(window.game.conf.mode === 'duel') { 
                        if(!this.target || Dist(this,this.target)<50) this.target={x:window.game.world/2 + Rnd(-300,300), y:window.game.world/2 + Rnd(-300,300)};
                    } else {
                        // Feature 5: Ramassage Rapide (le bot aussi ramasse)
                        let item = window.game.items.find(i => Dist(this, i) < 300); 
                        if(item) { this.target = item; } 
                        else if(!this.target || Dist(this,this.target)<50 || Math.random()<0.02) { this.target={x:Rnd(100,window.game.world-100), y:Rnd(100,window.game.world-100)}; }
                    }
                    tx=this.target.x; ty=this.target.y; 
                } 
                const a=Math.atan2(ty-this.y, tx-this.x); 
                let speed = this.stats.spd * 0.96; 
                if(window.game.conf.modifier === 'speed') speed *= 2; 
                
                this.move(Math.cos(a)*speed, Math.sin(a)*speed); 
                if(Math.random()<0.01) this.dash(); 
                // FIX 2: R√©g√©n√©ration HP apr√®s 5s sans d√©g√¢ts (bots aussi)
                if(window.game.frame%60===0 && this.hp<this.maxHp && this.hitTimer > 300 && window.game.conf.modifier !== 'oneshot')this.hp++; 
                if(window.game.gasRadius && Dist(this, {x:window.game.world/2, y:window.game.world/2}) > window.game.gasRadius) this.hp -= 10; 
                if(this.activeEffects.poison > 0) { this.hp -= 1; this.activeEffects.poison--; } 
            } 
            shoot(){ 
                if(this.cd>0)return; 
                this.cd=Math.ceil(20 * RATE_FACTOR); // Appliquer le facteur de tir aux bots
                window.game.projs.push({x:this.x,y:this.y,vx:Math.cos(this.angle)*15*1.08,vy:Math.sin(this.angle)*15*1.08,dmg:10,life:60,r:6,c:this.c,friend:false, shape: 'circle', trailColor: this.c}); // Bot uses simple projectile
            } 
        }
        class Enemy extends Entity{ constructor(t,m=1){ const diffMult = DIFFICULTY[window.game.conf.difficulty].mult; const enemyMult = m * diffMult; super(0,0,20,'#ef4444'); let safe=false; while(!safe){ this.x=Rnd(100,window.game.world-100);this.y=Rnd(100,window.game.world-100); let wallCol = false; for(let w of window.game.map) { if(w.type!==1 && w.collide({x:this.x, y:this.y, r:this.r})) wallCol=true; } if(!wallCol && Dist(this,window.game.player)>600) safe=true; } this.type=t; let hp=60,s=2.0, dmg=1; 
            // Vitesse des ennemis ajust√©e par le facteur global
            s = s * SPEED_FACTOR;
            
            // Feature 1: Mini-Boss stats pour vagues 3 et 6
            if(t==='fast'){hp=40;s=4.0 * SPEED_FACTOR;this.c='#f97316';this.r=15;} 
            if(t==='tank'){hp=200;s=1.2 * SPEED_FACTOR;this.c='#7e22ce';this.r=30;} 
            if(t==='mini_boss'){hp=1000;s=2.5 * SPEED_FACTOR;this.c='#facc15';this.r=40;this.isBoss=true;this.cd=Math.ceil(100*RATE_FACTOR); dmg=2; this.name = "MINI BOSS";}
            if(t==='boss'){hp=5000;s=1.5 * SPEED_FACTOR;this.c='#dc2626';this.r=60;this.isBoss=true;this.cd=Math.ceil(0*RATE_FACTOR); dmg=3;} 
            if(t==='chest'){hp=5000;s=0;this.c='#facc15';this.r=40;this.isBoss=true;} 
            if(t==='train'){hp=10000;s=1.0 * SPEED_FACTOR;this.c='#3b82f6';this.r=30;this.type='train';} 
            if(t==='terminal'){hp=5000;s=0;this.c='#22d3ee';this.r=40;this.type='terminal';}

            if(window.game.conf.modifier === 'giant') { this.r *= 2; hp *= 2; s *= 0.8; }
            if(window.game.conf.modifier === 'oneshot') { hp = 1; }

            // AJOUT: +20PV de base aux ennemis/bots
            hp += ENEMY_HP_BUFF;

            this.hp=hp * enemyMult; this.maxHp=this.hp; this.spd=s*0.85; this.baseDmg = dmg * enemyMult; 
            // Application du facteur de tir sur le CD
            this.cd = Math.ceil((100 + Math.random() * 100) * RATE_FACTOR); 
            
            if(this.isBoss) this.name = t === 'boss' ? 'BOSS' : (t === 'mini_boss' ? 'MINI BOSS' : (t === 'chest' ? 'COFFRE' : t.toUpperCase())); else this.name = `Bot n¬∞${Math.floor(Math.random() * 89999) + 10000}`; this.activeEffects = {}; 
            this.isStunned = 0; // Ajout du stun
            this.flashTimer = 0; // Timer pour le flash de d√©g√¢t
            this.flashColor = null; // Couleur du flash
            this.hitTimer = 300; // FIX 2: Timer de r√©g√©n√©ration
        } 
        update(){ 
            if (this.isStunned > 0) { this.isStunned--; return; } // Stunned = skip update
            this.hitTimer++; // Incr√©menter le timer de non-hit

            if(this.spd === 0) return; const p=window.game.player; 
            let sepX = 0, sepY = 0; 
            for(let other of window.game.ents) { 
                if(other !== this) { 
                    let d = Dist(this, other); 
                    if(d < this.r * 2.5 && d > 0) { 
                        let ang = Math.atan2(this.y - other.y, this.x - other.x); 
                        sepX += Math.cos(ang); sepY += Math.sin(ang); 
                    } 
                } 
            } 
            
            if (this.type === 'basic' || this.type === 'fast' || this.type === 'tank' || this.type === 'mini_boss' ) { 
                if (this.cd > 0) this.cd--; 
                // IA 2.0 : Attaque les ennemis proches s'ils sont √† port√©e
                if (this.cd <= 0 && Dist(this, p) < 400) { 
                    const a = Math.atan2(p.y - this.y, p.x - this.x); 
                    window.game.projs.push({ x: this.x, y: this.y, vx: Math.cos(a) * 3 * 1.08, vy: Math.sin(a) * 3 * 1.08, dmg: 10 * DIFFICULTY[window.game.conf.difficulty].mult, life: 100, r: 6, c: this.c, friend: false, shape: 'circle', trailColor: this.c }); 
                    this.cd = Math.ceil(150 * RATE_FACTOR); 
                } 
            } 

            if(this.type === 'boss' || this.type === 'mini_boss') { 
                const d = Dist(this, p); 
                const a = Math.atan2(p.y - this.y, p.x - this.x); 
                this.x += Math.cos(a) * this.spd; 
                this.y += Math.sin(a) * this.spd; 
                if(this.cd > 0) this.cd--; 
                if(this.cd <= 0 && d < 800) { 
                    this.cd = Math.ceil(60 * RATE_FACTOR); 
                    window.game.projs.push({ x: this.x, y: this.y, vx: Math.cos(a) * 2.5 * 1.08, vy: Math.sin(a) * 2.5 * 1.08, dmg: 40 * DIFFICULTY[window.game.conf.difficulty].mult, life: 200, r: 20, c: '#ef4444', friend: false, shape: 'circle', trailColor: '#dc2626' }); 
                } 
            } else { 
                let playerHidden = false; 
                for(let w of window.game.map) { 
                    if(w.type === 1 && ColRect(window.game.player, w)) { 
                        playerHidden = true; 
                        break; 
                    } 
                } 
                let tx, ty; 
                if(playerHidden && Dist(this, p) > 150) { 
                    if(!this.target || Dist(this,this.target)<50 || Math.random()<0.01) this.target={x:Rnd(100,window.game.world-100), y:Rnd(100,window.game.world-100)}; 
                    tx=this.target.x; ty=this.target.y; 
                } else { 
                    tx=p.x; ty=p.y; 
                } 
                const a=Math.atan2(ty-this.y, tx-this.x); 
                let speed = this.spd; 
                if(window.game.conf.modifier === 'speed') speed *= 2; 
                let mx = Math.cos(a)*speed + sepX*0.5; 
                let my = Math.sin(a)*speed + sepY*0.5; 
                const nx=this.x+mx, ny=this.y+my; 
                let cx=false, cy=false; 
                for(let w of window.game.map){if(w.type===1)continue; if(w.collide({x:nx,y:this.y,r:this.r}))cx=true;if(w.collide({x:this.x,y:ny,r:this.r}))cy=true;} 
                if(!cx)this.x=nx;if(!cy)this.y=ny; 
            } 
            if(Math.hypot(this.x-p.x,this.y-p.y)<this.r+p.r){p.hp-=this.baseDmg; p.hitTimer = 0; window.ui.flash();if(window.game.conf.modifier === 'oneshot') p.hp = 0; if(p.hp<=0)window.game.over("Tu√© par "+this.name);} 
            if(this.activeEffects.poison > 0) { this.hp -= 1; this.activeEffects.poison--; this.hitTimer = 0; } 
            
            // FIX 2: R√©g√©n√©ration HP apr√®s 5s sans d√©g√¢ts
            if(window.game.frame%60===0 && this.hp<this.maxHp && this.hitTimer > 300 && window.game.conf.modifier !== 'oneshot') this.hp++;

            if (this.flashTimer > 0) this.flashTimer--;
        } 
        draw(ctx){ 
            if(this.flashTimer > 0 && this.flashColor) {
                ctx.save();
                ctx.globalAlpha = 0.8;
                ctx.fillStyle = this.flashColor;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.r * 1.2, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }

            if(this.isBoss){
                ctx.beginPath();ctx.arc(this.x,this.y,this.r+5,0,Math.PI*2);
                ctx.strokeStyle=this.type==='chest'?'#facc15':'#ef4444';
                ctx.setLineDash([5,5]);ctx.stroke();ctx.setLineDash([]);
            } 
            super.draw(ctx); 
            const pct=this.hp/this.maxHp; 
            ctx.save(); 
            ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(this.x-20,this.y-this.r-15,40,6); 
            ctx.fillStyle=this.isBoss?'#ef4444':'#22c55e';
            
            // Si le bot est stun, couleur de la barre de vie en jaune
            if (this.isStunned > 0) ctx.fillStyle = '#facc15';

            ctx.fillRect(this.x-19,this.y-this.r-14,38*pct,4); 
            ctx.restore(); 
        } 
        }
        class Train extends Entity {
            constructor() {
                super(100, window.game.world/2, 30, '#3b82f6');
                this.hp = 20000; this.maxHp = 20000; this.type = 'train';
                this.angle = 0;
            }
            update() {
                // Move constantly to the right/across (vitesse du train r√©duite de 13%)
                this.x += 1 * SPEED_FACTOR;
                if(this.x > window.game.world - 100) {
                    this.x = 100; // Loop or just end? Let's loop for defense duration
                }
                // Visual smoke
                if(Math.random()<0.3) {
                    window.game.parts.push({x:this.x-30,y:this.y,vx:-2,vy:(Math.random()-0.5),life:40,c:'#555',r:5});
                }
            }
            draw(ctx) {
                super.draw(ctx);
                // Health bar
                const pct=this.hp/this.maxHp;
                ctx.save();
                ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(this.x-30,this.y-this.r-20,60,8);
                ctx.fillStyle='#3b82f6';ctx.fillRect(this.x-29,this.y-this.r-19,58*pct,6);
                // Train body detail
                ctx.translate(this.x, this.y);
                ctx.fillStyle = '#1e3a8a';
                ctx.fillRect(-20, -15, 40, 30);
                ctx.restore();
            }
        }
        
        window.game = { 
            cvs:document.getElementById('gameCanvas'), 
            ctx:document.getElementById('gameCanvas').getContext('2d'), 
            conf:{mode:'survival', arena:'tokyo', difficulty: 'normal', modifier: 'normal'}, 
            state:'MENU', frame:0, world:2000, cam:{x:0,y:0}, shake:0, gasRadius:0, timeLeft: 0, 
            player:null, ents:[], projs:[], parts:[], bgParts: [], items:[], texts:[], score:0, wave:1, boost:false, train: null, lootCollected: 0, hackProgress: 0,
            init() { 
                this.resize(); 
                window.onresize=()=>this.resize(); 
                Input.init(); 
                Storage.load(); 
                // Initialize conf with loaded/default values
                if(typeof window.game.conf.difficulty === 'undefined') window.game.conf.difficulty = 'normal';
                if(typeof window.game.conf.modifier === 'undefined') window.game.conf.modifier = 'normal';
                window.ui.updateMenu(); 
                if('ontouchstart' in window)el('mobile-controls').classList.remove('hidden'); 
                this.loop(); 
            }, 
            resize(){ 
                this.cvs.width=window.innerWidth; 
                this.cvs.height=window.innerHeight; 
                CFG.w=this.cvs.width; CFG.h=this.cvs.height; 
            }, 
            setStarter(k){USER.selected=k; Storage.save(); window.ui.updateMenu(); window.ui.showTab('play');}, 
            setMode(m){this.conf.mode=m; Storage.save(); window.ui.updateMenu(); window.ui.showTab('play');}, 
            setArena(a){this.conf.arena=a; Storage.save(); window.ui.updateMenu(); window.ui.showTab('play');}, 
            setDifficulty(d) { this.conf.difficulty = d; Storage.save(); window.ui.updateMenu(); window.ui.showTab('play'); }, 
            setModifier(m) { this.conf.modifier = m; Storage.save(); window.ui.updateMenu(); }, 
            start(){ 
                el('menu-screen').classList.add('hidden'); 
                el('hud').classList.remove('hidden'); 
                this.player=new Player(USER.selected); 
                this.ents=[]; this.projs=[]; this.parts=[]; this.bgParts = []; this.items=[]; this.texts=[]; this.score=0; this.wave=1; this.gasRadius=0; this.timeLeft = 3 * 60 * 60; 
                this.map=[]; this.train = null; this.lootCollected = 0; this.hackProgress = 0;
                
                for(let i=0;i<25;i++){const w=Math.random()*150+50,h=Math.random()*150+50,x=Math.random()*(this.world-w),y=Math.random()*(this.world-h);if(Math.hypot(x-this.world/2,y-this.world/2)>400)this.map.push(new Wall(x,y,w,h,0));} 
                // FIX 1: R√©duction du nombre de buissons (40 -> 38)
                for(let i=0;i<38;i++){const w=Math.random()*100+100,h=Math.random()*100+100,x=Math.random()*(this.world-w),y=Math.random()*(this.world-h);this.map.push(new Wall(x,y,w,h,1));} 
                for(let i=0;i<20;i++){const x=Math.random()*(this.world-60),y=Math.random()*(this.world-60);if(Math.hypot(x-this.world/2,y-this.world/2)>400)this.map.push(new Wall(x,y,60,60,3));} 
                const enemyBaseMult = 1+(this.conf.mode==='ranked'?0.2:0.1)*this.wave; 
                if(this.conf.mode==='duel'){ 
                    const bot = new Bot(); bot.x = this.world/2 + 400; bot.y = this.world/2; this.ents.push(bot); window.ui.notif("1 VS 1", "#fff"); 
                } else if(this.conf.mode==='heist') { 
                    const chest = new Enemy('chest', enemyBaseMult); chest.x = this.world/2; chest.y = 100; this.ents.push(chest); this.spawnDefenders(chest.x, chest.y, 3); this.map = this.map.filter(w => Math.hypot(w.x-chest.x, w.y-chest.y) > 300 && Math.hypot(w.x-this.player.x, w.y-this.player.y) > 300); window.ui.notif("D√âTRUIS LE COFFRE !", "#facc15"); 
                } else if(this.conf.mode==='boss_rush') { 
                    this.ents.push(new Enemy('boss', 3)); window.ui.notif("BOSS RUSH !", "#ef4444"); 
                } else if(this.conf.mode==='titan_raid') { 
                    this.ents.push(new Enemy('boss', 5)); window.ui.notif("RAID TITAN !", "#ef4444"); 
                } else if(this.conf.mode === 'train_defense') {
                    this.train = new Train();
                    this.ents.push(this.train);
                    this.map = this.map.filter(w => Math.abs(w.y - this.world/2) > 100); // Clear path for train
                    window.ui.notif("PROT√àGE LE TRAIN !", "#3b82f6");
                } else if(this.conf.mode === 'thief') {
                    // Spawn Loot
                    for(let i=0; i<15; i++) {
                        this.items.push({x:Rnd(100,this.world-100), y:Rnd(100,this.world-100), type:'loot_bag'});
                    }
                    window.ui.notif("VOLE 10 SACS !", "#facc15");
                } else if(this.conf.mode === 'cyber_hack') {
                    // Spawn Hack Terminal
                    const term = new Enemy('chest', enemyBaseMult * 5); // Use chest model as terminal base but stronger
                    term.x = this.world/2; term.y = this.world/2; term.type = 'terminal'; term.c = '#22d3ee';
                    this.ents.push(term);
                    // Clear center
                    this.map = this.map.filter(w => Math.hypot(w.x-term.x, w.y-term.y) > 400);
                    window.ui.notif("PIRATE LE TERMINAL !", "#22d3ee");
                } else { 
                    window.ui.notif(MODES[this.conf.mode].name.toUpperCase(), "#fff"); 
                } 
                setText('hud-icon', STARTERS[USER.selected].icon); 
                this.state='PLAYING'; // Set state to PLAYING
            }, 
            spawnDefenders(cx, cy, count) { for(let i=0; i<count; i++) { const angle = (Math.PI*2/count)*i; const e = new Enemy('basic', 1); e.x = cx + Math.cos(angle)*150; e.y = cy + Math.sin(angle)*150; this.ents.push(e); } }, 
            togglePause(){this.state=this.state==='PLAYING'?'PAUSED':(this.state==='PAUSED'?'PLAYING':this.state);}, 
            toMenu(){el('gameover-screen').classList.add('hidden');el('menu-screen').classList.remove('hidden');el('hud').classList.add('hidden');this.state='MENU';window.ui.updateMenu();game.boost=false;}, 
            over(r){ 
                this.state='GAMEOVER'; 
                el('gameover-screen').classList.remove('hidden'); 
                
                // Stats updates
                if (r !== "VICTOIRE") {
                    USER.stats.losses++;
                }

                const title = el('go-title');
                if (r === "VICTOIRE") {
                    title.innerText = "VICTOIRE";
                    title.className = "text-6xl md:text-8xl font-black text-yellow-400 mb-2 drop-shadow-[0_0_25px_rgba(250,204,21,0.8)] tracking-tighter animate-bounce";
                } else {
                    title.innerText = "KO";
                    title.className = "text-8xl font-black text-white mb-2 drop-shadow-2xl tracking-tighter";
                }
                setText('go-reason', r); 
                // Feature 2: Score Multiplier
                let finalScore = this.score * DIFFICULTY[this.conf.difficulty].mult;
                setText('go-score', Math.floor(finalScore)); 

                let gt = 1 + Math.floor(finalScore / 100) * 2; 
                if(this.boost) gt *= 2; 
                if((this.conf.mode==='duel' || this.conf.mode==='heist' || this.conf.mode==='boss_rush' || this.conf.mode==='titan_raid' || this.conf.mode==='train_defense' || this.conf.mode==='cyber_hack') && r==="VICTOIRE") { gt += 20; USER.stats.wins++; } 
                let gc = Math.floor(finalScore/10); 
                if(r==="VICTOIRE") gc += 50; 
                if(finalScore >= 200 || r==="VICTOIRE") { 
                    USER.pass.xp += 50; 
                    while(USER.pass.xp >= 100) { 
                        if(USER.pass.tier < 50) { 
                            USER.pass.tier++; USER.pass.xp -= 100; window.ui.notif("PASS LEVEL UP!", "#facc15"); 
                        } else { 
                            USER.pass.xp = 100; break; 
                        } 
                    } 
                } 
                USER.trophies+=gt; USER.coins+=gc; 
                USER.stats.maxWave=Math.max(USER.stats.maxWave,this.wave); 
                USER.stats.games++; 
                USER.stats.maxPassTier = Math.max(USER.stats.maxPassTier || 1, USER.pass.tier); // Mise √† jour de la stat de Palier Max
                Storage.save(); setText('go-rewards', `+${gt}üèÜ +${gc}ü™ô`); 
            }, 
            // Am√©lioration de l'effet d'ambiance
            drawTerrainEffects() { 
                if(this.state !== 'PLAYING') return; 
                const arena = this.conf.arena; 
                let spawnRate = 0.3; let color = 'rgba(255,255,255,0.5)'; let vy = 2; 
                
                if(arena === 'ice') { spawnRate = 0.9; color = 'rgba(220,240,255,0.7)'; vy = 3.5; } // Plus de neige visible
                else if(arena === 'magma') { spawnRate = 0.5; color = 'rgba(255,100,50,0.7)'; vy = -2.5; } // Plus de fum√©e rouge
                else if(arena === 'tokyo' || arena === 'cyber_city') { spawnRate = 0.3; color = 'rgba(0,255,200,0.4)'; vy = 5; } 
                else if(arena === 'sand') { spawnRate = 0.6; color = 'rgba(230,200,100,0.5)'; vy = 4; } 
                else if(arena === 'jungle') { spawnRate = 0.4; color = 'rgba(100,200,100,0.5)'; vy = 1; }
                else if(arena === 'nebula') { spawnRate = 0.7; color = 'rgba(216, 180, 254, 0.5)'; vy = 0.5; }
                else if(arena === 'mainframe') { spawnRate = 0.9; color = 'rgba(34, 211, 238, 0.5)'; vy = -4.5; } // Digital rain encore plus dense
                
                if(Math.random() < spawnRate) { 
                    this.bgParts.push({ x: this.cam.x + Math.random() * CFG.w, y: (vy > 0 ? this.cam.y - 10 : this.cam.y + CFG.h + 10), vx: (Math.random() - 0.5) * 2, vy: vy * (0.8 + Math.random() * 0.4), life: 200, c: color, r: Math.random() * 3 + 1 }); 
                } 
                for(let i=this.bgParts.length-1; i>=0; i--) { 
                    const p = this.bgParts[i]; p.x += p.vx; p.y += p.vy; p.life--; 
                    if(p.life <= 0) { this.bgParts.splice(i, 1); continue; } 
                    if(p.x < this.cam.x - 50 || p.x > this.cam.x + CFG.w + 50 || p.y < this.cam.y - 50 || p.y > this.cam.y + CFG.h + 50) { this.bgParts.splice(i, 1); continue; } 
                    this.ctx.fillStyle = p.c; this.ctx.beginPath(); this.ctx.arc(p.x - this.cam.x, p.y - this.cam.y, p.r, 0, Math.PI*2); this.ctx.fill(); 
                } 
            }, 
            loop(){ 
                requestAnimationFrame(()=>this.loop()); 
                this.frame++; 
                const ctx=this.ctx; 
                if(this.state==='PLAYING'){ 
                    if(this.conf.mode === 'heist' || this.conf.mode === 'boss_rush' || this.conf.mode === 'titan_raid' || this.conf.mode === 'train_defense' || this.conf.mode === 'cyber_hack') { 
                        this.timeLeft--; 
                        if(this.timeLeft <= 0) { 
                            this.over(this.conf.mode === 'cyber_hack' && this.hackProgress < 100 ? "ECHEC PIRATAGE" : "VICTOIRE"); return; 
                        } 
                        if(this.conf.mode === 'heist' && this.frame % (20*60) === 0) { 
                            const chest = this.ents.find(e => e.type === 'chest'); 
                            if(chest) { 
                                this.spawnDefenders(chest.x, chest.y, 3); window.ui.notif("RENFORTS !", "#ef4444"); 
                            } 
                        } 
                    } 
                    if(!this.ents) this.ents = []; if(!this.map) this.map = []; 
                    
                    // SPAWN LOGIC
                    if(this.conf.mode === 'survival' || this.conf.mode === 'ranked' || this.conf.mode === 'train_defense' || this.conf.mode === 'thief' || this.conf.mode === 'cyber_hack'){ 
                        if(!this.ents.find(e=>e.isBoss && e.type !== 'train' && e.type !== 'terminal')){ 
                            const max=5+Math.floor(this.wave*1.5); 
                            const enemyWaveMult = 1+(this.conf.mode==='ranked'?0.2:0.1)*this.wave; 
                            
                            // Feature 1: Mini-Boss Spawn (Vague 3 & 6)
                            if(this.frame%1800===0){
                                this.wave++;
                                if(this.wave % 5 === 0 && this.conf.mode !== 'thief' && this.conf.mode !== 'cyber_hack'){
                                    this.ents.push(new Enemy('boss', enemyWaveMult * 2));
                                    window.ui.notif("BOSS !!!","#ef4444");
                                } else if ((this.wave === 3 || this.wave === 6) && this.conf.mode !== 'thief' && this.conf.mode !== 'cyber_hack') {
                                    this.ents.push(new Enemy('mini_boss', enemyWaveMult * 1.5));
                                    window.ui.notif("MINI BOSS !","#facc15");
                                } else {
                                    window.ui.notif("VAGUE "+this.wave,"#fff");
                                }
                            }
                            
                            // Spawn enemies
                            if(this.ents.filter(e => !e.friend && e.type !== 'train' && e.type !== 'terminal').length < max && this.frame%60===0){
                                let t='basic'; if(this.wave>2&&Math.random()>0.7)t='fast'; if(this.wave>4&&Math.random()>0.8)t='tank'; 
                                const en = new Enemy(t, enemyWaveMult);
                                // For Train mode, spawn near train sometimes
                                if(this.conf.mode === 'train_defense' && this.train && Math.random() < 0.5) {
                                    en.x = this.train.x + Rnd(-300, 300);
                                    en.y = this.train.y + Rnd(-300, 300); 
                                }
                                this.ents.push(en);
                            } 
                            
                        } 
                    } else if(this.ents.length===0 && this.conf.mode !== 'train_defense' && this.conf.mode !== 'cyber_hack') this.over("VICTOIRE"); 
                    
                    this.player.update(); 
                    if(this.train) {
                        this.train.update();
                        if(this.train.hp <= 0) this.over("TRAIN D√âTRUIT");
                    }
                    if(this.conf.mode === 'cyber_hack') {
                        const term = this.ents.find(e => e.type === 'terminal');
                        if(term) {
                            if(Dist(this.player, term) < 200) {
                                this.hackProgress += 0.05;
                                if(Math.random() < 0.1) window.game.parts.push({x:term.x+Rnd(-20,20),y:term.y+Rnd(-20,20),vx:0,vy:-2,life:30,c:'#22d3ee',r:2});
                            }
                            if(this.hackProgress >= 100) this.over("VICTOIRE");
                        }
                    }
                    
                    this.ents.forEach(e=>e.update());
                    // Fix: Remove dead entities (e.g. from poison) that didn't go through kill()
                    for(let e of this.ents) {
                        if(e.hp <= 0 && !e.dead) this.kill(e);
                    }
                    
                    this.ents.forEach(e => resolveCollision(this.player, e)); 
                    for(let i=0; i<this.ents.length; i++) for(let j=i+1; j<this.ents.length; j++) resolveCollision(this.ents[i], this.ents[j]); 
                    
                    // CAM FOLLOW
                    let targetX = this.player.x, targetY = this.player.y;
                    const tx=targetX-CFG.w/2, ty=targetY-CFG.h/2; 
                    this.cam.x+=(tx-this.cam.x)*0.1; 
                    this.cam.y+=(ty-this.cam.y)*0.1; 
                    this.cam.x=Math.max(0,Math.min(this.world-CFG.w,this.cam.x)); 
                    this.cam.y=Math.max(0,Math.min(this.world-CFG.h,this.cam.y)); 
                    if(this.shake>0)this.shake*=0.9; 
                    
                    // PROJECTILES
                    for(let i=this.projs.length-1;i>=0;i--){ 
                        const b=this.projs[i]; 
                        
                        // Melee attacks do not move
                        if(b.melee){ 
                            b.x=window.game.player.x+Math.cos(window.game.player.angle)*40; 
                            b.y=window.game.player.y+Math.sin(window.game.player.angle)*40; 
                            b.life--; 
                            
                            // Logique de Siphon de Vie pour Reaper (Feature Reaper)
                            if (USER.selected === 'reaper' && b.life === 0) {
                                // Reaper Melee hit logic moved to kill() or handled after damage application
                                // Let the hit logic handle the lifesteal (in the collision loop)
                            }

                            if(b.life<=0){this.projs.splice(i,1);continue;} 
                            
                            for(let e of this.ents) if(Dist(b,e)<b.r+e.r && !e.hitCD){ 
                                e.hitCD=20; 
                                e.hp-=b.dmg; 
                                e.hitTimer = 0; // Reset hitTimer
                                if(b.friend) USER.stats.dmg+=b.dmg; 
                                if(window.game.conf.modifier === 'poison') e.activeEffects.poison = 120; 
                                // FIX: Lifesteal handled for melee
                                if(b.friend && (USER.selected === 'ronin' || USER.selected === 'reaper')) { // Ronin et Reaper ont le lifesteal
                                    window.game.player.hp = Math.min(window.game.player.maxHp, window.game.player.hp + Math.floor(b.dmg * 0.4));
                                }
                                if(window.game.conf.modifier === 'recoil' && b.friend) { e.x += Math.cos(window.game.player.angle)*20; e.y += Math.sin(window.game.player.angle)*20; } // Knockback enemy
                                
                                e.flashColor = b.c; e.flashTimer = 5; // Flash Feedback
                                for(let k=0;k<3;k++)window.game.parts.push({x:e.x,y:e.y,vx:(Math.random()-0.5)*5,vy:(Math.random()-0.5)*5,life:15,c:'#fff',r:3}); 
                                this.texts.push({x:e.x,y:e.y-40,t:Math.floor(b.dmg),life:40,c:'#fff',vy:-2}); 
                                if(window.game.conf.modifier === 'oneshot') e.hp = 0; 
                                if(e.hp<=0 && !e.dead) this.kill(e); 
                            } 
                            continue; 
                        } 
                        
                        // Ranged attacks move
                        b.x+=b.vx; b.y+=b.vy; b.life--; 
                        if(b.life<=0){this.projs.splice(i,1);continue;} 
                        let wh=false; 
                        for(let k=this.map.length-1; k>=0; k--) { 
                            const w=this.map[k]; 
                            if(w.type!==1 && ColRect(b, w)) { 
                                // FIX: Emp√™cher les projectiles de casser les murs (sauf les caisses de butin type 3)
                                if(w.type===0) wh=true; // Mur normal
                                
                                if(w.type===3 && b.friend) { // Mur destructible par projectile joueur
                                    this.map.splice(k,1); 
                                    this.items.push({x:w.x+30, y:w.y+30, type:'cube'}); 
                                    for(let j=0;j<5;j++) this.parts.push({x:w.x+30, y:w.y+30, vx:Rnd(-5,5), vy:Rnd(-5,5), life:20, c:'#d97706', r:5}); 
                                    wh=true; 
                                } else if (w.type === 3 && !b.friend) {
                                    // Projectiles ennemis ne cassent pas les murs
                                    wh = true; 
                                }
                            } 
                        } 
                        if(wh){for(let j=0;j<3;j++)this.parts.push({x:b.x,y:b.y,vx:(Math.random()-0.5)*3,vy:(Math.random()-0.5)*3,life:10,c:b.c,r:2}); this.projs.splice(i,1);continue;} 
                        
                        if(b.friend){ 
                            for(let e of this.ents){ 
                                if(Dist(b,e)<b.r+e.r){ 
                                    e.hp-=b.dmg; 
                                    e.hitTimer = 0; // Reset hitTimer
                                    USER.stats.dmg+=b.dmg; 
                                    
                                    if(window.game.conf.modifier === 'poison') e.activeEffects.poison = 120; 
                                    // FIX: Lifesteal for ranged
                                    if(window.game.conf.modifier === 'vampire') window.game.player.hp = Math.min(window.game.player.maxHp, window.game.player.hp + 5); // Life Steal (Vampire modifier)
                                    if(window.game.conf.modifier === 'recoil') { e.x += Math.cos(Math.atan2(b.vy, b.vx))*20; e.y += Math.sin(Math.atan2(b.vy, b.vx))*20; }
                                    
                                    // Flash Feedback
                                    e.flashColor = b.c; e.flashTimer = 5; 

                                    // Feature 6: D√©g√¢ts Critiques
                                    this.texts.push({x:e.x,y:e.y-40,t:Math.floor(b.dmg),life:40,c:b.isCrit?'#facc15':'#fff',vy:-2}); 
                                    for(let k=0;k<5;k++)this.parts.push({x:e.x,y:e.y,vx:(Math.random()-0.5)*8,vy:(Math.random()-0.5)*8,life:20,c:e.c,r:4}); 
                                    if(window.game.conf.modifier === 'oneshot') e.hp = 0; 
                                    if(e.hp<=0 && !e.dead) this.kill(e); 
                                    this.projs.splice(i,1); wh=true; break; 
                                } 
                            } 
                        } else { 
                            // Enemy projectiles hit player or TRAIN
                            let hit = false;
                            if(Dist(b,this.player)<b.r+this.player.r){
                                this.player.hp-=b.dmg;
                                this.player.hitTimer = 0; // Reset hitTimer
                                window.ui.flash();
                                if(window.game.conf.modifier === 'poison') this.player.activeEffects.poison = 120;
                                if(window.game.conf.modifier === 'oneshot') this.player.hp = 0; 
                                if(this.player.hp<=0)this.over("Tu√© par Tir Ennemi");
                                hit=true;
                            }
                            if(!hit && this.train && Dist(b, this.train) < b.r + this.train.r) {
                                this.train.hp -= b.dmg;
                                hit=true;
                            }
                            if(hit) this.projs.splice(i,1);
                        } 
                    } 
                    this.ents.forEach(e=>{if(e.hitCD)e.hitCD--}); 
                    for(let i=this.ents.length-1;i>=0;i--)if(this.ents[i].dead)this.ents.splice(i,1); 
                    for(let i=this.items.length-1;i>=0;i--){
                        const l=this.items[i];
                        // Feature 5: Ramassage Rapide (les items suivent le joueur)
                        if (Dist(l, this.player) < 150) {
                            let angleToPlayer = Math.atan2(this.player.y - l.y, this.player.x - l.x);
                            l.x += Math.cos(angleToPlayer) * 5;
                            l.y += Math.sin(angleToPlayer) * 5;
                        }
                        
                        if(Dist(l,this.player)<30){
                            if(l.type==='cube'){this.player.cubes++;this.player.maxHp+=400;this.player.hp+=400;window.ui.notif("POWER UP!","#22c55e");}
                            else if(l.type==='loot_bag'){
                                this.lootCollected++;
                                window.ui.notif(`SAC R√âCUP√âR√â (${this.lootCollected}/10)`, "#facc15");
                                if(this.lootCollected >= 10) this.over("VICTOIRE");
                            }
                            else{
                                if(l.t==='hp'){
                                    this.player.hp=Math.min(this.player.maxHp,this.player.hp+30);
                                    for(let j=0;j<5;j++) this.parts.push({x:l.x,y:l.y,vx:Rnd(-3,3),vy:Rnd(-3,3),life:20,c:'#22c55e',r:3}); // VFX
                                } else {
                                    this.player.xp=Math.min(this.player.xpMax-1, this.player.xp+30); // √âvite l'overflow visuel
                                    for(let j=0;j<5;j++) this.parts.push({x:l.x,y:l.y,vx:Rnd(-3,3),vy:Rnd(-3,3),life:20,c:'#a855f7',r:3}); // VFX
                                }
                            }
                            this.items.splice(i,1);
                        }
                    } 
                    for(let i=this.parts.length-1;i>=0;i--){const p=this.parts[i]; p.x+=p.vx;p.y+=p.vy;p.life--;if(p.life<=0)this.parts.splice(i,1);} 
                    window.ui.hud(); 
                    window.ui.drawMinimap(); 
                } 
                const map=ARENAS[this.conf.arena]; ctx.fillStyle=map.color; ctx.fillRect(0,0,CFG.w,CFG.h); 
                ctx.save(); 
                if(this.state!=='MENU'){ 
                    const sx=(Math.random()-0.5)*this.shake, sy=(Math.random()-0.5)*this.shake; 
                    ctx.translate(-this.cam.x+sx, -this.cam.y+sy); 
                    this.drawTerrainEffects(); 
                    ctx.strokeStyle=map.grid; ctx.lineWidth=2; 
                    const tx=Math.floor(this.cam.x/100)*100, ty=Math.floor(this.cam.y/100)*100; 
                    ctx.beginPath(); 
                    for(let x=tx;x<tx+CFG.w+100;x+=100){ctx.moveTo(x,0);ctx.lineTo(x,this.world);} 
                    for(let y=ty;y<ty+CFG.h+100;y+=100){ctx.moveTo(0,y);ctx.lineTo(this.world,y);} 
                    ctx.stroke(); 
                    if(this.conf.mode === 'heist') { 
                        const chest = this.ents.find(e => e.type === 'chest'); 
                        if(chest) { 
                            const angle = Math.atan2(chest.y - this.player.y, chest.x - this.player.x); 
                            ctx.save(); ctx.translate(this.player.x, this.player.y); ctx.rotate(angle); 
                            ctx.fillStyle = '#facc15'; ctx.beginPath(); ctx.moveTo(60, 0); ctx.lineTo(50, -10); ctx.lineTo(50, 10); ctx.fill(); 
                            ctx.restore(); 
                        } 
                    } else if(this.conf.mode === 'train_defense' && this.train) {
                        const angle = Math.atan2(this.train.y - this.player.y, this.train.x - this.player.x);
                        ctx.save(); ctx.translate(this.player.x, this.player.y); ctx.rotate(angle);
                        ctx.fillStyle = '#3b82f6'; ctx.beginPath(); ctx.moveTo(60, 0); ctx.lineTo(50, -10); ctx.lineTo(50, 10); ctx.fill();
                        ctx.restore();
                    } else if(this.conf.mode === 'cyber_hack') {
                        const term = this.ents.find(e => e.type === 'terminal');
                        if(term) {
                            ctx.save(); ctx.translate(term.x, term.y); 
                            ctx.fillStyle = `rgba(34, 211, 238, 0.3)`;
                            ctx.beginPath(); ctx.arc(0, 0, 200, 0, Math.PI*2); ctx.fill(); // Zone
                            ctx.fillStyle = '#22d3ee'; ctx.fillRect(-20, -20, 40, 40); // Terminal
                            ctx.fillStyle = 'white'; ctx.font = "bold 20px Orbitron"; ctx.textAlign = 'center';
                            ctx.fillText(Math.floor(this.hackProgress)+"%", 0, -40);
                            ctx.restore();
                        }
                    }
                    ctx.strokeStyle='#ef4444'; ctx.lineWidth=5; ctx.strokeRect(0,0,this.world,this.world); 
                    this.items.forEach(l=>{
                        if(l.type==='cube'){ctx.fillStyle='#22c55e';ctx.fillRect(l.x-10,l.y-10,20,20);ctx.shadowColor='#22c55e';ctx.shadowBlur=10;ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.strokeRect(l.x-10,l.y-10,20,20);ctx.shadowBlur=0;}
                        else if(l.type==='loot_bag'){ctx.fillStyle='#facc15';ctx.font='30px Arial';ctx.fillText('üí∞',l.x-15,l.y+10);}
                        else{ctx.fillStyle=l.t==='hp'?'#22c55e':'#a855f7';ctx.beginPath();ctx.arc(l.x,l.y,8,0,Math.PI*2);ctx.fill();}
                    }); 
                    const renderList = [...this.map, ...this.ents, this.player, ...this.projs, ...this.parts]; 
                    renderList.sort((a,b) => a.y - b.y); 
                    renderList.forEach(o => { 
                        if(o instanceof Wall) o.draw(ctx, map.wall); 
                        else if(o.draw) o.draw(ctx); 
                        else { 
                            ctx.fillStyle=o.c;ctx.beginPath();ctx.arc(o.x,o.y,o.r,0,Math.PI*2);ctx.fill(); 
                        } 
                    }); 
                    
                    // RENDU DES PROJECTILES UNIQUES
                    this.projs.forEach(p => { 
                        // Tra√Æn√©e
                        if (p.trailColor && this.frame % 3 === 0 && !p.melee) {
                            this.parts.push({ x: p.x, y: p.y, vx: -p.vx * 0.1, vy: -p.vy * 0.1, life: 10, c: p.trailColor, r: p.r / 3 });
                        }

                        ctx.shadowColor=p.c; ctx.shadowBlur=10; 
                        ctx.fillStyle=p.c; 

                        // Dessin par forme
                        if (p.shape === 'rock') {
                            ctx.font = `${p.r * 1.5}px Arial`;
                            ctx.fillText("üóø", p.x - p.r, p.y + p.r / 2);
                        } else if (p.shape === 'snake') {
                            ctx.font = `${p.r * 2}px Arial`;
                            ctx.fillText("üêç", p.x - p.r, p.y + p.r / 2);
                        } else if (p.shape === 'flame') {
                            ctx.font = `${p.r * 1.5}px Arial`;
                            ctx.fillText("üî•", p.x - p.r, p.y + p.r / 2);
                        } else if (p.shape === 'melee') {
                            // Melee est un simple arc tr√®s rapide pour simuler un coup
                            ctx.save();
                            ctx.translate(p.x, p.y);
                            ctx.rotate(this.player.angle);
                            ctx.fillStyle = p.c;
                            ctx.globalAlpha = 0.8 * (p.life / 1); // Dispara√Æt imm√©diatement
                            ctx.beginPath();
                            ctx.arc(0, 0, p.r, -0.5, 0.5); // Arc devant le joueur
                            ctx.lineTo(0, 0);
                            ctx.fill();
                            ctx.restore();
                        } else {
                            // Projectile standard (cercle/laser)
                            ctx.beginPath();
                            ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); 
                            ctx.fill(); 
                        }
                        
                        ctx.shadowBlur=0; 
                    }); 
                    this.texts.forEach((t,i)=>{t.y+=t.vy;t.life--;ctx.globalAlpha=t.life/40;ctx.fillStyle=t.c;ctx.font="bold 20px Orbitron";ctx.fillText(t.t,t.x,t.y);ctx.globalAlpha=1;if(t.life<=0)this.texts.splice(i,1);}); 
                } 
                ctx.restore(); 
            }, 
            kill(e){ 
                e.dead=true; 
                this.score+=(e.isBoss||e.isBot?500:100); 
                this.player.xp=Math.min(this.player.xpMax-1, this.player.xp+(e.isBoss?300:20)); 
                this.player.super=Math.min(100,this.player.super+(e.isBoss?30:10)); 
                // Fix: Lifesteal passive for non-melee heroes
                if(this.player.stats.passive === "Vol de Vie" && this.player.stats.type !== 'melee') {
                     this.player.hp=Math.min(this.player.maxHp,this.player.hp+(e.isBoss?50:10)); // Heal on kill for ranged lifesteal
                }

                // Feature: Bot Emote on Kill (5% chance)
                if (e.isBot && Math.random() < 0.05) {
                    const randomEmote = EMOTE_LIST[Math.floor(Math.random() * EMOTE_LIST.length)].i;
                    window.ui.triggerEmote(randomEmote);
                }

                // EXPLOSIVE MOD
                if (window.game.conf.modifier === 'explosif') {
                    for(let i=0; i<8; i++) {
                        window.game.parts.push({x:e.x, y:e.y, vx:Rnd(-5,5), vy:Rnd(-5,5), life:30, c:'#f97316', r:6});
                    }
                    if (Dist(e, this.player) < 100) {
                        this.player.hp -= 50;
                        window.ui.flash();
                        if (this.player.hp <= 0) this.over("Tu√© par Explosion");
                    }
                }

                if(Math.random()<0.3)this.items.push({x:e.x,y:e.y,t:Math.random()>0.5?'hp':'xp'}); 
                USER.stats.kills++; 
                window.ui.feed("Toi",e.isBot?"Rival":(e.type==='chest'?"COFFRE":e.name),true); 
                if(this.player.xp>=this.player.xpMax){this.player.xp=0;this.player.xpMax*=1.2;this.player.lvl++;this.player.hp=this.player.maxHp;this.state='LEVELUP';window.ui.levelUp();} 
            } 
        };
        
        window.onload=function(){ if(window.game) window.game.init(); };
    </script>
</body></html>
